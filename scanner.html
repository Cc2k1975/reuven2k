<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>住专拽 住 Pro</title>
    <script src="https://docs.opencv.org/4.7.0/opencv.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --primary: #2ecc71; --bg: #000; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: white; margin: 0; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        
        /* 专 爪 */
        .viewport { position: relative; flex-grow: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        video, canvas { max-width: 100%; max-height: 100%; object-fit: contain; }
        #outputCanvas { display: none; border: 2px solid var(--primary); }

        /* 驻转专 */
        .bottom-bar { padding: 30px; background: rgba(20,20,20,0.9); display: flex; flex-direction: column; align-items: center; gap: 15px; border-top: 1px solid #333; }
        .shutter-btn { width: 70px; height: 70px; background: white; border-radius: 50%; border: 5px solid #444; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .shutter-btn:active { transform: scale(0.9); background: #ddd; }
        .shutter-inner { width: 55px; height: 55px; border-radius: 50%; border: 2px solid black; }

        .btn-group { display: none; gap: 15px; width: 100%; }
        button.action-btn { flex: 1; padding: 15px; border-radius: 12px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; }
        .send-btn { background: var(--primary); color: white; }
        .reset-btn { background: #444; color: white; }

        /* 注转 注专转 */
        #status { font-size: 13px; color: #aaa; text-align: center; margin-bottom: 5px; }
        .loader-overlay { position: fixed; inset: 0; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader" class="loader-overlay">
        <div class="spinner"></div>
        <p> 转 注专转 专 砖转...</p>
    </div>

    <div class="viewport">
        <video id="video" autoplay playsinline></video>
        <canvas id="outputCanvas"></canvas>
    </div>

    <div class="bottom-bar">
        <div id="status"> 拽...</div>
        
        <div id="scanUI">
            <div class="shutter-btn" onclick="captureAndProcess()">
                <div class="shutter-inner"></div>
            </div>
        </div>

        <div id="resultUI" class="btn-group">
            <button class="reset-btn" onclick="resetScanner()"> 住专拽 专转</button>
            <button class="send-btn" onclick="shareAsPDF()"> 砖 PDF 住驻</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('outputCanvas');
        const status = document.getElementById('status');
        const loader = document.getElementById('loader');

        // 注转 OpenCV
        cv['onRuntimeInitialized'] = () => {
            loader.style.display = 'none';
            status.innerText = "爪  - 拽 转 祝 爪";
            startCamera();
        };

        async function startCamera() {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: 1280, height: 720 } 
            });
            video.srcObject = stream;
        }

        function captureAndProcess() {
            status.innerText = "注 转...";
            
            let src = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
            let cap = new cv.VideoCapture(video);
            cap.read(src);

            let processed = straightenImage(src);
            cv.imshow('outputCanvas', processed);

            // 注 UI
            video.style.display = 'none';
            canvas.style.display = 'block';
            document.getElementById('scanUI').style.display = 'none';
            document.getElementById('resultUI').style.display = 'flex';
            status.innerText = "住专拽 !";

            src.delete(); processed.delete();
        }

        function straightenImage(src) {
            let dst = new cv.Mat();
            let gray = new cv.Mat();
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
            cv.GaussianBlur(gray, gray, new cv.Size(5, 5), 0);
            cv.Canny(gray, gray, 75, 200);

            let contours = new cv.MatVector();
            let hierarchy = new cv.Mat();
            cv.findContours(gray, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

            let maxArea = 0;
            let bestCnt = null;

            for (let i = 0; i < contours.size(); ++i) {
                let cnt = contours.get(i);
                let peri = cv.arcLength(cnt, true);
                let approx = new cv.Mat();
                cv.approxPolyDP(cnt, approx, 0.02 * peri, true);
                if (approx.rows == 4 && cv.contourArea(approx) > maxArea) {
                    maxArea = cv.contourArea(approx);
                    bestCnt = approx;
                }
            }

            if (bestCnt) {
                // 专转 砖专 驻专住驻拽 (Warp Perspective)
                let width = 800, height = 1100; // 住 砖 祝 A4
                let finalDest = cv.matFromArray(4, 1, cv.CV_32FC2, [0, 0, width, 0, width, height, 0, height]);
                
                // 住专 拽转 驻
                let coords = Array.from(bestCnt.data32S);
                let pts = [];
                for(let i=0; i<8; i+=2) pts.push({x: coords[i], y: coords[i+1]});
                pts.sort((a,b) => a.y - b.y);
                let top = pts.slice(0,2).sort((a,b) => a.x - b.x);
                let bottom = pts.slice(2,4).sort((a,b) => a.x - b.x);
                
                let srcPts = cv.matFromArray(4, 1, cv.CV_32FC2, [top[0].x, top[0].y, top[1].x, top[1].y, bottom[1].x, bottom[1].y, bottom[0].x, bottom[0].y]);
                
                let M = cv.getPerspectiveTransform(srcPts, finalDest);
                let result = new cv.Mat();
                cv.warpPerspective(src, result, M, new cv.Size(width, height));
                
                // 驻专 砖驻专 转 (专  住专拽)
                cv.cvtColor(result, result, cv.COLOR_RGBA2GRAY);
                cv.adaptiveThreshold(result, result, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 11, 10);

                return result;
            }

            return src; //   爪 祝, 专 转 拽专转
        }

        async function shareAsPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            const imgData = canvas.toDataURL('image/jpeg', 0.8);
            pdf.addImage(imgData, 'JPEG', 0, 0, 210, 297);
            
            const pdfBlob = pdf.output('blob');
            const file = new File([pdfBlob], "scan.pdf", { type: "application/pdf" });

            if (navigator.share) {
                await navigator.share({ files: [file], title: '住专拽 拽爪注转' });
            } else {
                pdf.save("scan.pdf");
            }
        }

        function resetScanner() {
            location.reload();
        }
    </script>
</body>
</html>
