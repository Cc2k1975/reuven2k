<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>מועדפים</title>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-top:#e9f6eb;
      --bg-bottom:#ffffff;
      --card-bg:#ffffff;
      --card-border:#dbe5d9;
      --card-shadow:0 8px 20px rgba(0,0,0,0.08);
      --card-radius:16px;
      --text-main:#0f1a12;
      --text-muted:#4d5a4b;
      --danger:#ff3b30;

      --panel-bg:#ffffff;
      --panel-border:#dcdcdc;
      --panel-radius:16px;
      --panel-shadow:0 12px 30px rgba(0,0,0,0.1);

      --input-bg:#ffffff;
      --input-border:#cfd3ce;
      --input-radius:10px;

      --btn-bg:#0f1a12;
      --btn-color:#ffffff;
      --btn-radius:10px;
      --btn-shadow:0 10px 20px rgba(0,0,0,0.15);

      --btn-sec-bg:#ffffff;
      --btn-sec-color:#0f1a12;
      --btn-sec-border:#0f1a12;

      --accent-green:#34c759; /* העיגול הירוק */
    }

    *{
      box-sizing:border-box;
      -webkit-tap-highlight-color:transparent;
    }
    html,body{height:100%;}
    body{
      margin:0;
      font-family:"Heebo",system-ui,sans-serif;
      color:var(--text-main);
      background:linear-gradient(to bottom,var(--bg-top) 0%,var(--bg-bottom) 60%);
      min-height:100vh;
      display:flex;
      flex-direction:column;
      padding-bottom:140px;
    }

    .wrap{
      width:100%;
      max-width:1000px;
      margin:0 auto;
      padding:16px 16px 24px;
    }

    header{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:20px;
    }

    .header-icon{
      width:36px;
      height:36px;
      background:var(--accent-green);
      color:#fff;
      border-radius:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 8px 16px rgba(52,199,89,0.4);
    }
    .header-icon svg{
      width:20px;
      height:20px;
      stroke:#fff;
      stroke-width:2;
      fill:none;
    }

    h1{
      font-size:24px;
      line-height:1.2;
      font-weight:800;
      color:var(--text-main);
      margin:0;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(min(180px,30%),1fr));
      gap:16px;
    }

    .card{
      background:var(--card-bg);
      border:1px solid var(--card-border);
      border-radius:var(--card-radius);
      box-shadow:var(--card-shadow);
      padding:16px 12px 12px;
      text-align:center;
      position:relative;
      display:flex;
      flex-direction:column;
      align-items:center;
      cursor:pointer;
      text-decoration:none;
      color:var(--text-main);
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .card:hover{
      transform:translateY(-2px);
      box-shadow:0 10px 24px rgba(0,0,0,0.12);
    }

    /* כפתורי עריכה/מחיקה - מוסתרים כברירת מחדל */
    .actions{
      position:absolute;
      top:8px;
      inset-inline-start:8px;
      display:flex;
      gap:6px;
      opacity:0;
      pointer-events:none;
      transition:opacity .12s;
    }
    .actions.show{
      opacity:1;
      pointer-events:auto;
    }

    .iconbtn{
      width:22px;
      height:22px;
      border-radius:6px;
      border:1px solid #cfd3ce;
      background:#fff;
      box-shadow:0 4px 8px rgba(0,0,0,0.08);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      padding:0;
    }
    .iconbtn svg{
      width:14px;
      height:14px;
      stroke:#0f1a12;
      stroke-width:1.6;
      fill:none;
    }

    /* העיגול הירוק */
    .fav{
      width:64px;
      height:64px;
      border-radius:50%;
      background:var(--accent-green);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      margin-bottom:12px;
      flex-shrink:0;
      box-shadow:0 8px 16px rgba(52,199,89,0.4);
    }

    /* שם הקישור בלבד */
    .card-title{
      font-size:16px;
      font-weight:600;
      line-height:1.3;
      color:var(--text-main);
      max-width:100%;
      word-break:break-word;
    }

    .empty{
      margin:24px 0;
      text-align:center;
      color:var(--text-muted);
      font-size:14px;
    }

    .bar{
      position:fixed;
      left:0;
      right:0;
      bottom:0;
      padding:16px;
      background:transparent;
      display:flex;
      justify-content:center;
      pointer-events:none;
    }

    .bar-inner{
      width:100%;
      max-width:1000px;
      background:var(--panel-bg);
      border:1px solid var(--panel-border);
      border-radius:var(--panel-radius);
      box-shadow:var(--panel-shadow);
      padding:16px;
      display:grid;
      grid-template-columns:1fr 1fr auto auto;
      gap:12px 16px;
      align-items:end;
      pointer-events:auto;
    }

    label{
      font-size:12px;
      font-weight:600;
      color:var(--text-main);
      margin-bottom:6px;
      display:block;
    }

    input{
      width:100%;
      padding:10px 12px;
      background:var(--input-bg);
      border:1px solid var(--input-border);
      border-radius:var(--input-radius);
      font-size:14px;
      line-height:1.3;
      color:var(--text-main);
      outline:none;
      direction:rtl;
    }
    input:focus{
      border-color:var(--accent-green);
      box-shadow:0 0 0 3px rgba(52,199,89,0.3);
    }

    .btn{
      appearance:none;
      border:none;
      border-radius:var(--btn-radius);
      font-size:14px;
      font-weight:600;
      line-height:1.3;
      padding:10px 14px;
      cursor:pointer;
      white-space:nowrap;
      box-shadow:var(--btn-shadow);
    }
    .btn-main{
      background:var(--btn-bg);
      color:var(--btn-color);
    }
    .btn-sec{
      background:var(--btn-sec-bg);
      color:var(--btn-sec-color);
      border:1px solid var(--btn-sec-border);
      box-shadow:0 6px 12px rgba(0,0,0,0.08);
    }

    .err{
      color:var(--danger);
      font-size:12px;
      font-weight:600;
      margin-top:4px;
    }

    @media(max-width:600px){
      .bar-inner{
        grid-template-columns:1fr 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="header-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M3 7a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7Z"
                fill="none" stroke="#fff" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M15 10.5 21 7v10l-6-3.5v-3Z"
                fill="none" stroke="#fff" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <h1>מועדפים</h1>
    </header>

    <section id="cards" class="grid" aria-live="polite"></section>
    <div id="empty" class="empty" hidden>אין עדיין קישורים בקובץ.</div>
  </div>

  <div class="bar">
    <div class="bar-inner">
      <div>
        <label for="name">שם הקישור</label>
        <input id="name" type="text" autocomplete="off">
      </div>
      <div>
        <label for="url">הכנס קישור</label>
        <input id="url" type="text" autocomplete="off" inputmode="url">
        <div id="err" class="err" hidden></div>
      </div>
      <button id="saveAll" class="btn btn-main" type="button">שמור לכולם</button>
      <button id="refreshBtn" class="btn btn-sec" type="button">רענן נתונים</button>
    </div>
  </div>

  <script>
    // הנתונים שלך
    const initialData = [
      {"name":"ארוחה משותפת","url":"https://reuven2k.com/food_manager.html","ts":1761567352943},
      {"name":"jsonbin","url":"https://jsonbin.io/app/dashboard","ts":1761542095209},
      {"name":"נתוני סקר מוא","url":"https://reuven2k.com/moadata.html","ts":1761541861062},
      {"name":"סקר מוא","url":"https://reuven2k.com/seker.html","ts":1761541928378},
      {"name":"עבודות פן אקספרס","url":"https://reuven2k.com/images/index.html","ts":1760936995544},
      {"name":"אפליקצית פן אקספרס","url":"https://drive.google.com/file/d/1k9360_FiG8UCoJr6E94d8PGaiE2g8gSf/view?usp=drivesdk","ts":1760711504571},
      {"name":"ניהול תורים - פן אקספרס","url":"https://reuven2k.com/odelyafen.html","ts":1760617722400},
      {"name":"הזמנת תור לפן","url":"https://reuven2k.com/mayfen.html","ts":1760617644345},
      {"name":"יוצר קישור לתזכורת ביומן","url":"https://reuven2k.com/creat-calender-link.html","ts":1760614992144},
      {"name":"PORKBUN","url":"https://porkbun.com/account/domainsSpeedy","ts":1760614547753},
      {"name":"GITHUB","url":"https://github.com/Cc2k1975/reuven2k","ts":1760614357292},
      {"name":"תכנון טיול לתאילנד","url":"https://reuven2k.com/travel.html","ts":1760613978916},
      {"name":"REEM YOUTUBE LIVE","url":"https://www.youtube.com/@ReemShein16/live","ts":1760614134990}
    ];

    const $ = s => document.querySelector(s);
    const cards = $("#cards"),
          empty = $("#empty"),
          inpName = $("#name"),
          inpUrl = $("#url"),
          btnSave = $("#saveAll"),
          err = $("#err"),
          refreshBtn = $("#refreshBtn");

    const JSON_PATH = "data/links.json";
    let list = [];
    const GH_EDIT_URL = "https://github.com/Cc2k1975/reuven2k/edit/main/data/links.json";

    // מצב כפתורי עריכה/מחיקה פר כרטיס
    const editVisibleState = new Map();

    async function loadJson(){
      let usedFallback=false;
      try{
        const r = await fetch(\`\${JSON_PATH}?v=\${Date.now()}\`, {cache:"no-store"});
        if(!r.ok) throw 0;
        const data = await r.json();
        if(Array.isArray(data)){
          list = data;
        }else{
          list = initialData.slice();
          usedFallback = true;
        }
      }catch(e){
        list = initialData.slice();
        usedFallback = true;
      }
      render();
      console.log("נטען:", usedFallback ? "fallback" : "links.json");
    }

    function normalizeUrl(raw){
      let s = (raw||"").trim();
      if(!s) throw new Error("נא למלא קישור");
      if(!/^https?:\\/\\//i.test(s)) s = "https://" + s;
      try{
        return new URL(s).toString();
      }catch{
        throw new Error("כתובת לא תקינה");
      }
    }

    // בונה SVG באופן בטוח (בלי innerHTML)
    function buildAvatarSvg(){
      const svgNS = "http://www.w3.org/2000/svg";

      const svg = document.createElementNS(svgNS,"svg");
      svg.setAttribute("viewBox","0 0 24 24");
      svg.setAttribute("width","28");
      svg.setAttribute("height","28");
      svg.setAttribute("aria-hidden","true");
      svg.style.pointerEvents = "none";

      const head = document.createElementNS(svgNS,"circle");
      head.setAttribute("cx","12");
      head.setAttribute("cy","8");
      head.setAttribute("r","4");
      head.setAttribute("fill","none");
      head.setAttribute("stroke","#ffffff");
      head.setAttribute("stroke-width","2");
      head.setAttribute("stroke-linecap","round");
      head.setAttribute("stroke-linejoin","round");

      const body = document.createElementNS(svgNS,"path");
      body.setAttribute("d","M4 20c0-4 3-6 8-6s8 2 8 6");
      body.setAttribute("fill","none");
      body.setAttribute("stroke","#ffffff");
      body.setAttribute("stroke-width","2");
      body.setAttribute("stroke-linecap","round");
      body.setAttribute("stroke-linejoin","round");

      svg.appendChild(head);
      svg.appendChild(body);

      return svg;
    }

    function render(){
      cards.innerHTML = "";
      if(!list.length){
        empty.hidden = false;
        return;
      }
      empty.hidden = true;

      list.forEach((item, i)=>{
        // כרטיס = לינק
        const card = document.createElement("a");
        card.className = "card";
        card.href = item.url;
        card.target = "_blank";
        card.rel = "noopener";

        // פעולות עריכה/מחיקה
        const actions = document.createElement("div");
        actions.className = "actions";
        if (editVisibleState.get(i) === true){
          actions.classList.add("show");
        }

        const btnEdit = document.createElement("button");
        btnEdit.className = "iconbtn";
        btnEdit.title = "ערוך";
        btnEdit.setAttribute("data-action","edit");
        btnEdit.setAttribute("data-index",i);

        // אייקון עיפרון
        const editSvg = document.createElementNS("http://www.w3.org/2000/svg","svg");
        editSvg.setAttribute("viewBox","0 0 24 24");
        editSvg.setAttribute("width","14");
        editSvg.setAttribute("height","14");
        const editPath = document.createElementNS("http://www.w3.org/2000/svg","path");
        editPath.setAttribute("d","M4 16.5V20h3.3L19 8.3l-3.3-3.3L4 16.5z");
        editPath.setAttribute("fill","none");
        editPath.setAttribute("stroke","#0f1a12");
        editPath.setAttribute("stroke-width","1.6");
        editPath.setAttribute("stroke-linecap","round");
        editPath.setAttribute("stroke-linejoin","round");
        editSvg.appendChild(editPath);
        btnEdit.appendChild(editSvg);

        const btnDel = document.createElement("button");
        btnDel.className = "iconbtn";
        btnDel.title = "מחק";
        btnDel.setAttribute("data-action","delete");
        btnDel.setAttribute("data-index",i);

        // אייקון פח
        const delSvg = document.createElementNS("http://www.w3.org/2000/svg","svg");
        delSvg.setAttribute("viewBox","0 0 24 24");
        delSvg.setAttribute("width","14");
        delSvg.setAttribute("height","14");
        const delPath = document.createElementNS("http://www.w3.org/2000/svg","path");
        delPath.setAttribute("d","M6 7h12M9 7V5h6v2m-8 3 1 9h8l1-9");
        delPath.setAttribute("fill","none");
        delPath.setAttribute("stroke","#0f1a12");
        delPath.setAttribute("stroke-width","1.6");
        delPath.setAttribute("stroke-linecap","round");
        delPath.setAttribute("stroke-linejoin","round");
        delSvg.appendChild(delPath);
        btnDel.appendChild(delSvg);

        actions.appendChild(btnEdit);
        actions.appendChild(btnDel);

        // האייקון העגול הירוק
        const fav = document.createElement("div");
        fav.className = "fav";
        const avatarSvg = buildAvatarSvg();
        fav.appendChild(avatarSvg);

        // לחיצה על העיגול הירוק -> הצג/הסתר כפתורי עריכה/מחיקה
        fav.addEventListener("click",(ev)=>{
          ev.preventDefault();
          ev.stopPropagation();
          const now = editVisibleState.get(i) === true;
          editVisibleState.set(i, !now);
          render();
        });

        // שם הקישור
        const titleEl = document.createElement("div");
        titleEl.className = "card-title";
        titleEl.textContent = item.name || "";

        // מרכיבים למסך
        card.appendChild(actions);
        card.appendChild(fav);
        card.appendChild(titleEl);
        cards.appendChild(card);
      });

      // מאזינים לכפתורי עריכה/מחיקה
      cards.querySelectorAll(".iconbtn").forEach(btn=>{
        btn.addEventListener("click", onActionClick);
      });
    }

    function addAndSave(){
      err.hidden = true;
      err.textContent = "";

      const name = (inpName.value||"").trim();
      const raw  = (inpUrl.value||"").trim();
      if(!name || !raw){
        err.textContent = "נא למלא את שני השדות";
        err.hidden = false;
        return;
      }

      let url;
      try{
        url = normalizeUrl(raw);
      }catch(e){
        err.textContent = e.message;
        err.hidden = false;
        return;
      }

      // אם כבר יש אותו URL -> מסירים הישן ושמים חדש למעלה
      const i = list.findIndex(x => x.url?.toLowerCase() === url.toLowerCase());
      if(i>-1) list.splice(i,1);

      list.unshift({name, url, ts: Date.now()});
      inpName.value = "";
      inpUrl.value = "";
      render();

      copyAndOpen();
    }

    function copyAndOpen(){
      const txt = JSON.stringify(list, null, 2);
      const openEdit = () => window.open(GH_EDIT_URL,"_blank");

      if(navigator.clipboard?.writeText){
        navigator.clipboard.writeText(txt).then(openEdit, openEdit);
      }else{
        const ta=document.createElement("textarea");
        ta.value=txt;
        document.body.appendChild(ta);
        ta.select();
        try{ document.execCommand("copy"); }catch{}
        ta.remove();
        openEdit();
      }
    }

    function onActionClick(e){
      e.stopPropagation();
      e.preventDefault();

      const btn = e.currentTarget;
      const idx = Number(btn.getAttribute("data-index"));
      const action = btn.getAttribute("data-action");
      if(Number.isNaN(idx) || !list[idx]) return;

      if(action==="delete"){
        if(confirm(`למחוק את "${list[idx].name}"?`)){
          list.splice(idx,1);
          render();
          copyAndOpen();
        }
      }else if(action==="edit"){
        const curr = list[idx];
        const newName = prompt("שם חדש לקישור:", curr.name ?? "");
        if(newName===null) return;
        const newUrlRaw = prompt("קישור חדש (URL):", curr.url ?? "");
        if(newUrlRaw===null) return;
        try{
          const newUrl = normalizeUrl(newUrlRaw);
          list[idx] = {
            ...curr,
            name:(newName||"").trim() || curr.name,
            url:newUrl,
            ts:Date.now()
          };
          render();
          copyAndOpen();
        }catch(errMsg){
          alert(errMsg.message || "כתובת לא תקינה");
        }
      }
    }

    function refreshData(){
      const url = new URL(window.location.href);
      url.searchParams.set('v', Date.now().toString());
      window.location.replace(url.toString());
    }

    btnSave.addEventListener("click", addAndSave);
    [inpName, inpUrl].forEach(el=>{
      el.addEventListener("keydown", e=>{
        if(e.key==="Enter") addAndSave();
      });
    });
    refreshBtn.addEventListener("click", refreshData);

    loadJson();
  </script>
</body>
</html>
