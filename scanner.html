<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>×¡×•×¨×§ Pro - ×¨×‘ ×¢××•×“×™× ×¢× ×—×™×ª×•×š ×™×“× ×™</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://docs.opencv.org/4.7.0/opencv.js"></script>

  <style>
    * { box-sizing: border-box; }
    body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; color: #fff; font-family: system-ui, sans-serif; }
    .app { display: flex; flex-direction: column; height: 100dvh; }

    #debug { background: #1a1a1a; color: #0f0; font-size: 12px; padding: 8px; text-align: center; border-bottom: 1px solid #333; }

    .viewer { flex: 1; min-height: 0; position: relative; display: flex; align-items: center; justify-content: center; background: #000; }
    video, canvas { max-width: 100%; max-height: 100%; object-fit: contain; }
    #canvasOutput { display: none; }

    .footer {
      flex: 0 0 auto;
      background: #111;
      border-top: 1px solid #222;
      padding: 10px 12px calc(12px + env(safe-area-inset-bottom));
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
      justify-content: center;
    }

    #msg { text-align: center; font-size: 16px; }

    .snap-btn {
      width: 78px; height: 78px;
      background: #fff;
      border-radius: 50%;
      border: 6px solid #333;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: 0.15s;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .snap-btn:active { transform: scale(0.92); background: #ddd; }
    .snap-inner { width: 56px; height: 56px; border-radius: 50%; border: 2px solid #000; }

    .row { width: min(720px, 96%); display: flex; gap: 10px; align-items: center; justify-content: center; flex-wrap: wrap; }
    .pill { font-size: 13px; padding: 6px 10px; border: 1px solid #444; border-radius: 999px; background: #0d0d0d; color: #ddd; }

    .btn { padding: 12px 14px; border-radius: 12px; border: none; font-weight: 800; font-size: 15px; cursor: pointer; background: #333; color: #fff; }
    .btn:active { transform: scale(0.98); }
    .btn-green { background: #25d366; color: #fff; }
    .btn-blue { background: #0b5ed7; color: #fff; }
    .btn-red { background: #b02a37; color: #fff; }

    #thumbs {
      width: min(720px, 96%);
      display: none;
      gap: 8px;
      overflow-x: auto;
      padding: 6px 2px;
      justify-content: flex-start;
      align-items: center;
    }
    .thumb {
      height: 56px;
      border-radius: 10px;
      border: 1px solid #333;
      background: #000;
      flex: 0 0 auto;
      cursor: pointer;
    }

    #loader { position: fixed; inset: 0; background: #000; z-index: 99; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .spinner { width: 40px; height: 40px; border: 4px solid #222; border-top: 4px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Preview & Crop Modals */
    #previewModal, #cropModal {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.96);
      z-index: 999;
      display: none;
      flex-direction: column;
      padding: 14px 12px calc(14px + env(safe-area-inset-bottom));
    }
    #previewWrap, #cropWrap {
      width: min(980px, 100%);
      height: 100%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .modal-top { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    
    /* Crop Interface */
    #cropContainer {
      position: relative;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      touch-action: none;
    }
    #cropImg { max-width: 100%; max-height: 100%; user-select: none; pointer-events: none; }
    .crop-handle {
      position: absolute;
      width: 34px; height: 34px;
      background: rgba(11, 94, 215, 0.7);
      border: 3px solid #fff;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      z-index: 1001;
      touch-action: none;
    }
    #cropOverlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      z-index: 1000;
    }
    #previewImg { width: 100%; height: 100%; object-fit: contain; border-radius: 12px; background: #000; }
  </style>
</head>

<body>
  <div id="loader">
    <div class="spinner"></div>
    <p>×˜×•×¢×Ÿ ××ª ×”××¢×¨×›×ª...</p>
  </div>

  <div class="app">
    <div id="debug">Log: ×××ª×™×Ÿ ×œ-OpenCV</div>

    <div class="viewer">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="canvasOutput"></canvas>
    </div>

    <div class="footer">
      <div id="msg">×›×•×•×Ÿ ××œ ×”×“×£ ×•×œ×—×¥ ×¦×™×œ×•×</div>

      <div class="row" id="rowCapture">
        <div class="pill" id="pagesInfo">×¢××•×“×™×: 0</div>
        <button class="btn" id="modeBtn">ğŸ©¶ ××¤×•×¨</button>
        <div class="snap-btn" id="snapBtn"><div class="snap-inner"></div></div>
        <button class="btn btn-red" id="resetBtn">××™×¤×•×¡</button>
      </div>

      <div id="thumbs"></div>

      <div class="row" id="rowActions" style="display:none">
        <button class="btn btn-blue" id="addPageBtn">â• ×”×•×¡×£ ×¢××•×“</button>
        <button class="btn btn-green" id="makePdfBtn">ğŸ“© ×©×œ×— PDF</button>
      </div>
    </div>
  </div>

  <div id="cropModal">
    <div id="cropWrap">
      <div class="modal-top">
        <div style="font-weight: 800;">×™×™×©×•×¨ ×•×—×™×ª×•×š</div>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-red" id="cancelCropBtn">×‘×™×˜×•×œ</button>
            <button class="btn btn-blue" id="saveCropBtn">×©××•×¨ ×“×£ âœ…</button>
        </div>
      </div>
      <div id="cropContainer">
        <img id="cropImg" alt="to crop" />
        <canvas id="cropOverlay"></canvas>
        <div id="h0" class="crop-handle" data-id="0"></div>
        <div id="h1" class="crop-handle" data-id="1"></div>
        <div id="h2" class="crop-handle" data-id="2"></div>
        <div id="h3" class="crop-handle" data-id="3"></div>
      </div>
    </div>
  </div>

  <div id="previewModal">
    <div id="previewWrap">
      <div class="modal-top">
        <div id="previewTitle">×ª×¦×•×’×” ××§×“×™××”</div>
        <div style="display:flex; gap:10px;">
          <button class="btn btn-red" id="deletePageBtn">ğŸ—‘ï¸ ××—×§</button>
          <button class="btn" id="closePreviewBtn">×¡×’×•×¨ âœ–ï¸</button>
        </div>
      </div>
      <img id="previewImg" alt="preview" />
    </div>
  </div>

<script>
  const log = (m) => document.getElementById('debug').innerText = "Log: " + m;

  const video = document.getElementById('video');
  const canvas = document.getElementById('canvasOutput');
  const loader = document.getElementById('loader');
  const msg = document.getElementById('msg');
  const snapBtn = document.getElementById('snapBtn');
  const resetBtn = document.getElementById('resetBtn');
  const pagesInfo = document.getElementById('pagesInfo');
  const thumbs = document.getElementById('thumbs');
  const rowActions = document.getElementById('rowActions');
  const addPageBtn = document.getElementById('addPageBtn');
  const makePdfBtn = document.getElementById('makePdfBtn');

  // Crop Elements
  const cropModal = document.getElementById('cropModal');
  const cropImg = document.getElementById('cropImg');
  const cropOverlay = document.getElementById('cropOverlay');
  const saveCropBtn = document.getElementById('saveCropBtn');
  const cancelCropBtn = document.getElementById('cancelCropBtn');
  const handles = [document.getElementById('h0'), document.getElementById('h1'), document.getElementById('h2'), document.getElementById('h3')];

  // Preview Elements
  const previewModal = document.getElementById('previewModal');
  const previewImg = document.getElementById('previewImg');
  const previewTitle = document.getElementById('previewTitle');
  const closePreviewBtn = document.getElementById('closePreviewBtn');
  const deletePageBtn = document.getElementById('deletePageBtn');

  const modeBtn = document.getElementById('modeBtn');
  let scanMode = "bw"; 

  let cvReady = false;
  let cameraReady = false;
  let currentRawMat = null;
  const pages = [];
  let previewIndex = -1;

  // Corner points state (relative to image display size)
  let corners = [{x:0, y:0}, {x:0, y:0}, {x:0, y:0}, {x:0, y:0}];

  modeBtn.addEventListener('click', () => {
    scanMode = (scanMode === "bw") ? "gray" : "bw";
    modeBtn.innerText = (scanMode === "bw") ? "ğŸ©¶ ××¤×•×¨" : "â¬› ×©×—×•×¨-×œ×‘×Ÿ";
  });

  snapBtn.addEventListener('click', captureForCrop);
  resetBtn.addEventListener('click', () => location.reload());
  addPageBtn.addEventListener('click', backToCamera);
  makePdfBtn.addEventListener('click', sendMultiPagePdf);
  saveCropBtn.addEventListener('click', applyCropAndStore);
  cancelCropBtn.addEventListener('click', () => { cropModal.style.display='none'; if(currentRawMat) currentRawMat.delete(); });
  closePreviewBtn.addEventListener('click', () => previewModal.style.display = 'none');
  deletePageBtn.addEventListener('click', deleteCurrentPreviewPage);

  cv.onRuntimeInitialized = async () => {
    cvReady = true;
    await initCamera();
  };

  async function initCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: "environment" }, width: { ideal: 1920 }, height: { ideal: 1080 } },
        audio: false
      });
      video.srcObject = stream;
      video.onloadedmetadata = () => {
        cameraReady = true;
        loader.style.display = "none";
        log("××¢×¨×›×ª ××•×›× ×” âœ…");
      };
    } catch (e) { log("×©×’×™××” ×‘××¦×œ××”"); }
  }

  function captureForCrop() {
    if (!cvReady || !cameraReady) return;
    log("××¢×‘×“ ×—×™×ª×•×š...");
    const w = video.videoWidth;
    const h = video.videoHeight;
    const tmp = document.createElement('canvas');
    tmp.width = w; tmp.height = h;
    const ctx = tmp.getContext('2d');
    ctx.drawImage(video, 0, 0, w, h);
    
    if (currentRawMat) currentRawMat.delete();
    currentRawMat = cv.imread(tmp);
    
    cropImg.src = tmp.toDataURL('image/jpeg', 0.9);
    cropModal.style.display = 'flex';
    
    // Set default corners after image loads
    cropImg.onload = () => {
        const rect = cropImg.getBoundingClientRect();
        cropOverlay.width = rect.width;
        cropOverlay.height = rect.height;
        
        // Default: 10% margin
        const padW = rect.width * 0.1;
        const padH = rect.height * 0.1;
        corners = [
            {x: padW, y: padH}, 
            {x: rect.width - padW, y: padH}, 
            {x: rect.width - padW, y: rect.height - padH}, 
            {x: padW, y: rect.height - padH}
        ];
        updateHandles();
    };
  }

  function updateHandles() {
    corners.forEach((p, i) => {
        handles[i].style.left = `${p.x}px`;
        handles[i].style.top = `${p.y}px`;
    });
    drawOverlay();
  }

  function drawOverlay() {
    const ctx = cropOverlay.getContext('2d');
    ctx.clearRect(0, 0, cropOverlay.width, cropOverlay.height);
    ctx.strokeStyle = "#0b5ed7";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(corners[0].x, corners[0].y);
    corners.forEach(p => ctx.lineTo(p.x, p.y));
    ctx.closePath();
    ctx.stroke();
    // Fill mask
    ctx.fillStyle = "rgba(11, 94, 215, 0.1)";
    ctx.fill();
  }

  // Handle Dragging
  let activeHandle = null;
  const startDrag = (e) => {
    if (e.target.classList.contains('crop-handle')) {
        activeHandle = parseInt(e.target.dataset.id);
        e.preventDefault();
    }
  };
  const moveDrag = (e) => {
    if (activeHandle === null) return;
    const rect = cropImg.getBoundingClientRect();
    const touch = e.touches ? e.touches[0] : e;
    const x = Math.max(0, Math.min(touch.clientX - rect.left, rect.width));
    const y = Math.max(0, Math.min(touch.clientY - rect.top, rect.height));
    corners[activeHandle] = {x, y};
    updateHandles();
  };
  const stopDrag = () => activeHandle = null;

  document.getElementById('cropContainer').addEventListener('mousedown', startDrag);
  window.addEventListener('mousemove', moveDrag);
  window.addEventListener('mouseup', stopDrag);
  document.getElementById('cropContainer').addEventListener('touchstart', startDrag, {passive: false});
  window.addEventListener('touchmove', moveDrag, {passive: false});
  window.addEventListener('touchend', stopDrag);

  function applyCropAndStore() {
    log("××™×™×©×¨ ×•×©×•××¨...");
    const rect = cropImg.getBoundingClientRect();
    const scaleX = currentRawMat.cols / rect.width;
    const scaleY = currentRawMat.rows / rect.height;

    const srcCoords = corners.flatMap(p => [p.x * scaleX, p.y * scaleY]);
    const srcPts = cv.matFromArray(4, 1, cv.CV_32FC2, srcCoords);

    // Calc target size (A4 ratio approx)
    const w1 = Math.hypot(srcCoords[2]-srcCoords[0], srcCoords[3]-srcCoords[1]);
    const h1 = Math.hypot(srcCoords[6]-srcCoords[0], srcCoords[7]-srcCoords[1]);
    const destW = Math.max(w1, 500);
    const destH = Math.max(h1, 700);

    const dstPts = cv.matFromArray(4, 1, cv.CV_32FC2, [0, 0, destW, 0, destW, destH, 0, destH]);
    const M = cv.getPerspectiveTransform(srcPts, dstPts);
    let warped = new cv.Mat();
    cv.warpPerspective(currentRawMat, warped, M, new cv.Size(destW, destH));

    let final = new cv.Mat();
    cv.cvtColor(warped, final, cv.COLOR_RGBA2GRAY);
    if (scanMode === "bw") {
        cv.adaptiveThreshold(final, final, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 21, 12);
    }

    canvas.width = final.cols; canvas.height = final.rows;
    cv.imshow(canvas, final);
    
    pages.push(canvas.toDataURL('image/jpeg', 0.92));
    updatePagesUI();
    
    // Cleanup
    cropModal.style.display = 'none';
    srcPts.delete(); dstPts.delete(); M.delete(); warped.delete(); final.delete();
    if(currentRawMat) { currentRawMat.delete(); currentRawMat = null; }
    
    video.style.display = 'none';
    canvas.style.display = 'block';
    msg.innerText = `× ×¡×¨×§ ×¢××•×“ ${pages.length}`;
    log("× ×©××¨ âœ…");
  }

  function updatePagesUI() {
    pagesInfo.innerText = `×¢××•×“×™×: ${pages.length}`;
    rowActions.style.display = pages.length > 0 ? 'flex' : 'none';
    thumbs.style.display = pages.length > 0 ? 'flex' : 'none';
    thumbs.innerHTML = "";
    pages.forEach((data, i) => {
      const img = document.createElement('img');
      img.src = data; img.className = "thumb";
      img.onclick = () => { previewIndex = i; previewImg.src = data; previewTitle.innerText = `×¢××•×“ ${i+1}`; previewModal.style.display='flex'; };
      thumbs.appendChild(img);
    });
  }

  function backToCamera() {
    canvas.style.display = 'none'; video.style.display = 'block';
    msg.innerText = "×›×•×•×Ÿ ××œ ×”×“×£ ×•×œ×—×¥ ×¦×™×œ×•×";
  }

  function deleteCurrentPreviewPage() {
    pages.splice(previewIndex, 1);
    previewModal.style.display = 'none';
    updatePagesUI();
    if (pages.length === 0) backToCamera();
  }

  async function sendMultiPagePdf() {
    log("××›×™×Ÿ PDF...");
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    for (let i = 0; i < pages.length; i++) {
        if (i > 0) pdf.addPage();
        pdf.addImage(pages[i], 'JPEG', 10, 10, 190, 277);
    }
    const blob = pdf.output('blob');
    const file = new File([blob], "Srika.pdf", { type: "application/pdf" });
    if (navigator.share) await navigator.share({ files: [file], title: '×”×¡×¨×™×§×” ×©×œ×™' });
    else pdf.save("Srika.pdf");
  }
</script>
</body>
</html>
