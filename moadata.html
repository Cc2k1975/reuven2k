<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MOA ניהול – סקר טופס</title>
<style>
:root{
  --bg:#000;
  --panel:#111;
  --table-bg:#1a1a1a;
  --border:#333;
  --text-main:#ffd700;
  --text-body:#ddd;
  --ok-bg:#063;
  --err-bg:#500;
  --btn-bg:#d2b11c;
  --btn-text:#000;
  --radius:8px;
  --font:Arial,Helvetica,sans-serif;
}
body{
  margin:0;background:var(--bg);
  font-family:var(--font);color:var(--text-body);
  display:flex;justify-content:center;padding:16px;
}
.wrap{
  width:100%;max-width:900px;background:var(--panel);
  border-radius:var(--radius);box-shadow:0 0 20px #000;
  padding:20px 16px 32px;border:1px solid #222;
}
h1{margin:0;color:var(--text-main);font-size:24px;font-weight:700;}
.status{width:100%;border-radius:var(--radius);padding:10px 14px;
  font-size:16px;font-weight:600;line-height:1.4;color:#fff;display:none;}
.status.ok{background:var(--ok-bg);}
.status.err{background:var(--err-bg);}
.controlsBar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:12px;}
button.actionBtn{
  background:var(--btn-bg);color:var(--btn-text);
  border:0;border-radius:var(--radius);
  font-size:16px;font-weight:700;padding:10px 14px;cursor:pointer;
}
button.actionBtn:active{filter:brightness(0.9);}
.searchBoxWrap{flex:1 1 180px;display:flex;align-items:center;gap:8px;}
.searchBoxWrap input{
  flex:1 1 auto;min-width:0;background:#222;color:var(--text-body);
  border:2px solid var(--text-main);border-radius:var(--radius);
  padding:10px 12px;font-size:16px;
}
.tableWrap{overflow-x:auto;background:var(--table-bg);
  border:1px solid var(--border);border-radius:var(--radius);
  box-shadow:0 0 10px #000 inset;margin-top:16px;}
table{border-collapse:collapse;min-width:900px;width:100%;color:var(--text-body);font-size:14px;}
thead{background:#000;color:var(--text-main);font-weight:700;}
th,td{border-bottom:1px solid var(--border);text-align:center;padding:10px 6px;white-space:nowrap;}
tbody tr:nth-child(even){background:#222;}
tbody tr:nth-child(odd){background:#1a1a1a;}
td.actionsCell button{
  background:var(--btn-bg);color:var(--btn-text);
  border:0;border-radius:var(--radius);
  font-size:14px;font-weight:700;padding:6px 10px;margin:0 2px;cursor:pointer;
}
.footerInfo{text-align:center;font-size:12px;color:#888;margin-top:12px;}
#formToggle{
  font-size:16px;font-weight:700;padding:10px 16px;border-radius:var(--radius);
  border:0;cursor:pointer;color:#fff;
}
#formToggle.online{background:#046f04;}
#formToggle.offline{background:#b30000;}
</style>
</head>
<body>
<div class="wrap">
  <h1>ניהול טופס סקר</h1>
  <div id="statusBox" class="status"></div>

  <div class="controlsBar">
    <button id="formToggle" class="online">ONLINE</button>
    <button id="refreshBtn" class="actionBtn">רענן</button>
    <div class="searchBoxWrap">
      <input id="searchInput" type="text" placeholder="חפש… מחלקה / שם / טלפון / הערות">
    </div>
    <button id="csvBtn" class="actionBtn">ייצוא CSV</button>
  </div>

  <div class="tableWrap">
    <table id="answersTable">
      <thead>
        <tr>
          <th>מחלקה</th><th>שם העובד</th><th>טלפון</th><th>מבנה</th><th>קומה</th><th>חדר</th>
          <th>כמות</th><th>חדר יעד</th><th>הערות</th><th>תאריך/שעה</th><th>פעולות</th>
        </tr>
      </thead>
      <tbody id="tableBody"><tr><td colspan="11" style="text-align:center;color:#777;">טוען…</td></tr></tbody>
    </table>
  </div>

  <div class="footerInfo">גרסה 1.2.0 · moadata.html</div>
</div>

<script>
const BIN_ID="68fefa3dd0ea881f40beb941";
const ACCESS_KEY="$2a$10$cSsqpLyw9Jl/8q0El4JzqOuwLRUINEoMNeyxeUQ726QdlvNMD0iTe";
const API="https://api.jsonbin.io/v3/b";

const statusBox=document.getElementById("statusBox");
const tableBody=document.getElementById("tableBody");
const searchInput=document.getElementById("searchInput");
const refreshBtn=document.getElementById("refreshBtn");
const csvBtn=document.getElementById("csvBtn");
const toggleBtn=document.getElementById("formToggle");

let allAnswers=[],filtered=[],formOpen=true;

function showStatus(msg,ok){statusBox.style.display="block";statusBox.className="status "+(ok?"ok":"err");statusBox.textContent=msg;}
function prettyTS(s){let d=new Date(s);if(isNaN(d))return"";return`${d.getDate().toString().padStart(2,"0")}.${(d.getMonth()+1).toString().padStart(2,"0")}.${d.getFullYear()} ${d.getHours().toString().padStart(2,"0")}:${d.getMinutes().toString().padStart(2,"0")}`;}

async function fetchAll(){
  const res=await fetch(`${API}/${BIN_ID}`,{headers:{"X-Access-Key":ACCESS_KEY}});
  const j=await res.json();
  formOpen=j.record?.formOpen!==false;
  allAnswers=Array.isArray(j.record?.answers)?j.record.answers:[];
  filtered=[...allAnswers];
  render();
  updateToggle();
  showStatus(`נטענו ${allAnswers.length} רשומות`,true);
}

function updateToggle(){
  toggleBtn.className=formOpen?"online":"offline";
  toggleBtn.textContent=formOpen?"ONLINE":"OFFLINE";
}

async function toggleForm(){
  formOpen=!formOpen;
  updateToggle();
  showStatus("שומר מצב...",true);
  const body={answers:allAnswers,formOpen};
  await fetch(`${API}/${BIN_ID}`,{
    method:"PUT",
    headers:{"Content-Type":"application/json","X-Access-Key":ACCESS_KEY},
    body:JSON.stringify(body)
  });
  showStatus(`הטופס ${formOpen?"פתוח":"סגור"}`,true);
}

function render(){
  if(!filtered.length){tableBody.innerHTML='<tr><td colspan="11" style="text-align:center;color:#777;">אין נתונים</td></tr>';return;}
  tableBody.innerHTML=filtered.map((a,i)=>`
    <tr><td>${a.dept||""}</td><td>${a.workerName||""}</td><td>${a.phone||""}</td>
    <td>${a.building||""}</td><td>${a.floor||""}</td><td>${a.room||""}</td><td>${a.packs||""}</td>
    <td>${a.targetRoom||""}</td><td style="white-space:normal">${a.notes||""}</td><td>${prettyTS(a.ts)}</td>
    <td class="actionsCell"><button data-i="${i}">מחק</button></td></tr>`).join("");
}
function applySearch(){
  let q=searchInput.value.trim().toLowerCase();
  filtered=!q?[...allAnswers]:allAnswers.filter(a=>(JSON.stringify(a).toLowerCase().includes(q)));
  render();
}
tableBody.addEventListener("click",async e=>{
  if(e.target.tagName==="BUTTON"){
    let i=e.target.dataset.i;
    allAnswers.splice(i,1);
    const body={answers:allAnswers,formOpen};
    await fetch(`${API}/${BIN_ID}`,{
      method:"PUT",
      headers:{"Content-Type":"application/json","X-Access-Key":ACCESS_KEY},
      body:JSON.stringify(body)
    });
    fetchAll();
  }
});
csvBtn.addEventListener("click",()=>{
  if(!filtered.length)return;
  const BOM="\uFEFF";
  const rows=[["מחלקה","שם","טלפון","מבנה","קומה","חדר","כמות","חדר יעד","הערות","תאריך"]];
  filtered.forEach(a=>rows.push([a.dept,a.workerName,a.phone,a.building,a.floor,a.room,a.packs,a.targetRoom,a.notes,prettyTS(a.ts)]));
  const blob=new Blob([BOM+rows.map(r=>r.join(",")).join("\n")],{type:"text/csv;charset=utf-8;"});
  const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download="moadata.csv";a.click();URL.revokeObjectURL(url);
});
refreshBtn.onclick=fetchAll;
toggleBtn.onclick=toggleForm;
searchInput.oninput=applySearch;
fetchAll();
</script>
</body>
</html>
