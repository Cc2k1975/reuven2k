<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes">
    <title>××ª×›× ×Ÿ ×—×“×¨ - ×¤× ×™×§×¡×¤×¨×¡ ××•×“×œ×™×”</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --bg: #f0f2f5; --panel: #ffffff; --primary: #2c3e50; --accent: #3498db; --success: #27ae60; }
        body { font-family: system-ui, sans-serif; margin: 0; background: var(--bg); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .toolbar { background: var(--panel); padding: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 100; border-bottom: 1px solid #ddd; }
        .row { display: flex; gap: 8px; align-items: center; justify-content: center; flex-wrap: wrap; margin-bottom: 5px; }
        input, select, button { padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; }
        input[type="number"] { width: 65px; }
        button { background: var(--accent); color: white; border: none; font-weight: bold; cursor: pointer; }
        #viewport { flex: 1; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; background: #ccc; touch-action: none; }
        #zoom-wrapper { transform-origin: center; transition: transform 0.1s ease-out; }
        #room-export-area { position: relative; padding: 40px; background: #ccc; }
        #room-canvas { 
            background: #ffffff; position: relative; border: 3px solid #000;
            background-image: radial-gradient(#d1d1d1 1px, transparent 1px); background-size: 20px 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: none;
            overflow: visible; 
        }
        .furniture, .wall { position: absolute; touch-action: none; cursor: move; display: flex; align-items: center; justify-content: center; z-index: 10; }
        .furniture svg { width: 100%; height: 100%; overflow: visible; }
        .wall { background: #333; border: 1px solid #000; z-index: 5; }
        .label { position: absolute; bottom: -20px; font-size: 11px; font-weight: bold; color: #000; background: rgba(255,255,255,0.8); padding: 1px 4px; border-radius: 3px; white-space: nowrap; pointer-events: none; }
        .custom-name { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 12px; font-weight: bold; color: #2c3e50; text-align: center; width: 85%; pointer-events: none; }
        .selected { outline: 3px solid var(--accent); z-index: 500 !important; }
        #ruler-line { position: absolute; height: 2px; background: red; transform-origin: top left; z-index: 1000; display: none; pointer-events: none; }
        #ruler-text { position: absolute; color: red; font-weight: bold; font-size: 14px; background: white; padding: 2px; border: 1px solid red; display: none; z-index: 1001; }
        #fab { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #2c3e50; padding: 10px 20px; border-radius: 50px; display: none; align-items: center; gap: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); z-index: 1000; }
        .fab-btn { color: white; font-size: 20px; cursor: pointer; user-select: none; }
        .size-tool { display: flex; flex-direction: column; align-items: center; border-right: 1px solid #555; padding-right: 10px; color: white; font-size: 10px; }
    </style>
</head>
<body>

<div class="toolbar">
    <div class="row">
        <input type="number" id="roomW" placeholder="×¨×•×—×‘" value="400">
        <input type="number" id="roomH" placeholder="××•×¨×š" value="500">
        <button onclick="initRoom()">×—×“×¨ ×—×“×©</button>
        <button onclick="saveToLocal()" style="background:#8e44ad">×©××•×¨</button>
        <button onclick="exportToPNG()" style="background:#2c3e50">ğŸ“¸ ×ª××•× ×”</button>
        <button id="rulerBtn" onclick="toggleRuler()" style="background:#e67e22">ğŸ“ ××“×•×“</button>
    </div>
    <div id="item-controls" class="row" style="display:none;">
        <select id="itemType">
            <option value="bed">××™×˜×”</option>
            <option value="chair">×›×™×¡×</option>
            <option value="table">×©×•×œ×—×Ÿ/××¨×•×Ÿ</option>
            <option value="door">×“×œ×ª</option>
            <option value="wall">ğŸ§± ×§×™×¨ ×¤× ×™××™/× ×™×©×”</option>
        </select>
        <input type="text" id="itemName" placeholder="×©×" style="width: 80px;">
        <input type="number" id="itemW" placeholder="W" value="100">
        <input type="number" id="itemH" placeholder="H" value="100">
        <button onclick="addFurniture()" style="background:var(--success)">+ ×”×•×¡×£</button>
    </div>
</div>

<div id="viewport">
    <div id="zoom-wrapper">
        <div id="room-export-area">
            <div id="room-canvas">
                <div id="ruler-line"></div>
                <div id="ruler-text"></div>
            </div>
        </div>
    </div>
</div>

<div id="fab">
    <div class="size-tool">W <div style="display:flex;gap:5px"><span onclick="resizeItem('w', -5)">-</span><span onclick="resizeItem('w', 5)">+</span></div></div>
    <div class="size-tool">H <div style="display:flex;gap:5px"><span onclick="resizeItem('h', -5)">-</span><span onclick="resizeItem('h', 5)">+</span></div></div>
    <div class="fab-btn" onclick="rotateItem()">ğŸ”„</div>
    <div class="fab-btn" onclick="deleteItem()" style="color:#ff6b6b">ğŸ—‘ï¸</div>
    <div class="fab-btn" onclick="deselect()">âœ”ï¸</div>
</div>

<script>
    let scale = 1, currentZoom = 1, selected = null, zIdx = 10, rulerMode = false;
    const SNAP = 15; // ×¨×’×™×©×•×ª ×”××’× ×˜

    // ×–×•×
    let evCache = [], prevDiff = -1;
    const viewport = document.getElementById('viewport');
    viewport.onpointerdown = e => { evCache.push(e); };
    viewport.onpointermove = e => {
        const index = evCache.findIndex(ev => ev.pointerId === e.pointerId);
        evCache[index] = e;
        if (evCache.length === 2) {
            const curDiff = Math.hypot(evCache[0].clientX - evCache[1].clientX, evCache[0].clientY - evCache[1].clientY);
            if (prevDiff > 0) {
                if (curDiff > prevDiff) currentZoom += 0.04;
                else if (curDiff < prevDiff) currentZoom -= 0.04;
                currentZoom = Math.max(0.4, Math.min(4, currentZoom));
                document.getElementById('zoom-wrapper').style.transform = `scale(${currentZoom})`;
            }
            prevDiff = curDiff;
        }
    };
    viewport.onpointerup = e => { evCache = evCache.filter(ev => ev.pointerId !== e.pointerId); if (evCache.length < 2) prevDiff = -1; };

    function initRoom() {
        const w = document.getElementById('roomW').value, h = document.getElementById('roomH').value;
        const canvas = document.getElementById('room-canvas');
        scale = (window.innerWidth * 0.8) / w;
        canvas.style.display = 'block';
        canvas.style.width = (w * scale) + 'px';
        canvas.style.height = (h * scale) + 'px';
        canvas.style.backgroundSize = (scale * 20) + 'px ' + (scale * 20) + 'px';
        canvas.innerHTML = '<div id="ruler-line"></div><div id="ruler-text"></div>';
        document.getElementById('item-controls').style.display = 'flex';
    }

    function addFurniture(data = null) {
        const type = data ? data.type : document.getElementById('itemType').value;
        const name = data ? data.name : document.getElementById('itemName').value;
        const w = data ? data.w : document.getElementById('itemW').value;
        const h = data ? data.h : document.getElementById('itemH').value;
        const canvas = document.getElementById('room-canvas');
        const el = document.createElement('div');
        el.className = type === 'wall' ? 'wall' : 'furniture';
        el.dataset.w = w; el.dataset.h = h; el.dataset.rot = data ? data.rot : 0;
        updateElStyle(el);
        el.innerHTML = (type !== 'wall' ? 'ğŸ›‹ï¸' : "") + `<div class="custom-name">${name}</div><div class="label">${w}x${h}</div>`;
        el.style.left = data ? data.x : "50px"; el.style.top = data ? data.y : "50px";
        el.onpointerdown = dragHandler;
        canvas.appendChild(el);
    }

    function updateElStyle(el) {
        el.style.width = (el.dataset.w * scale) + 'px';
        el.style.height = (el.dataset.h * scale) + 'px';
        el.style.transform = `rotate(${el.dataset.rot}deg)`;
    }

    function dragHandler(e) {
        if(rulerMode) return;
        e.stopPropagation();
        const el = this, canvas = document.getElementById('room-canvas');
        if(selected) selected.classList.remove('selected');
        selected = el; el.classList.add('selected'); el.style.zIndex = zIdx++;
        document.getElementById('fab').style.display = 'flex';
        
        let startX = e.clientX / currentZoom - el.offsetLeft;
        let startY = e.clientY / currentZoom - el.offsetTop;

        function onMove(me) {
            let L = me.clientX / currentZoom - startX;
            let T = me.clientY / currentZoom - startY;

            // ××’× ×˜ ×œ×§×™×¨×•×ª ×—×™×¦×•× ×™×™×
            if (Math.abs(L) < SNAP) L = 0;
            if (Math.abs(L + el.offsetWidth - canvas.offsetWidth) < SNAP) L = canvas.offsetWidth - el.offsetWidth;
            if (Math.abs(T) < SNAP) T = 0;
            if (Math.abs(T + el.offsetHeight - canvas.offsetHeight) < SNAP) T = canvas.offsetHeight - el.offsetHeight;

            // ××’× ×˜ ×œ××•×‘×™×™×§×˜×™× ××—×¨×™×
            document.querySelectorAll('.furniture, .wall').forEach(other => {
                if (other === el) return;
                let oL = other.offsetLeft, oT = other.offsetTop;
                let oW = other.offsetWidth, oH = other.offsetHeight;

                if (Math.abs(L - (oL + oW)) < SNAP) L = oL + oW; // × ×“×‘×§ ×œ×™××™×Ÿ ×©×œ ××•×‘×™×™×§×˜
                if (Math.abs((L + el.offsetWidth) - oL) < SNAP) L = oL - el.offsetWidth; // × ×“×‘×§ ×œ×©×××œ
                if (Math.abs(T - (oT + oH)) < SNAP) T = oT + oH; // × ×“×‘×§ ×œ×ª×—×ª×™×ª
                if (Math.abs((T + el.offsetHeight) - oT) < SNAP) T = oT - el.offsetHeight; // × ×“×‘×§ ×œ×œ××¢×œ×”
            });

            el.style.left = L + 'px';
            el.style.top = T + 'px';
        }
        document.addEventListener('pointermove', onMove);
        document.addEventListener('pointerup', () => document.removeEventListener('pointermove', onMove), {once:true});
    }

    function resizeItem(dim, val) {
        if(!selected) return;
        if(dim === 'w') selected.dataset.w = Math.max(5, parseInt(selected.dataset.w) + val);
        if(dim === 'h') selected.dataset.h = Math.max(5, parseInt(selected.dataset.h) + val);
        updateElStyle(selected);
    }
    function rotateItem() { if(selected) { selected.dataset.rot = (parseInt(selected.dataset.rot) + 45) % 360; updateElStyle(selected); } }
    function deleteItem() { if(selected) { selected.remove(); deselect(); } }
    function deselect() { if(selected) selected.classList.remove('selected'); selected = null; document.getElementById('fab').style.display = 'none'; }
    function exportToPNG() { deselect(); html2canvas(document.getElementById('room-export-area')).then(c => { const a = document.createElement('a'); a.download = 'plan.png'; a.href = c.toDataURL(); a.click(); }); }
    function saveToLocal() { /* ×œ×•×’×™×§×ª ×©××™×¨×” */ alert("× ×©××¨!"); }
    function toggleRuler() { rulerMode = !rulerMode; document.getElementById('rulerBtn').style.background = rulerMode ? "red" : "#e67e22"; }
</script>
</body>
</html>
