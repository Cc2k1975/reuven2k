<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>זמיר 15 - שער</title>
  <style>
    body { font-family: sans-serif; background: #1a1a1a; color: white; margin: 0; text-align: center; }
    header { background: #000; padding: 20px; border-bottom: 2px solid #3498db; }
    #grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 20px; }
    .btn { background: #2d2d2d; padding: 20px; border-radius: 10px; cursor: pointer; border: 1px solid #444; user-select: none; }
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none;
      flex-direction: column; align-items: center; justify-content: center; z-index: 100; padding: 20px; }
    video { width: 80%; max-width: 340px; border: 2px solid #3498db; border-radius: 10px; background: #000; }
    .hint { opacity: 0.85; font-size: 0.95rem; margin-top: 10px; }
  </style>
</head>
<body>
  <header><h1>זמיר 15</h1></header>
  <div id="grid"></div>

  <div id="status" class="overlay">
    <video id="localVideo" autoplay playsinline muted></video>
    <h2 id="statusText">מחייג...</h2>
    <div id="dbg" class="hint"></div>
    <button onclick="location.reload()" style="padding:15px; background:#e74c3c; color:white; border:none; border-radius:8px; margin-top: 15px;">ביטול</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, collection, doc, setDoc, onSnapshot, addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyALAVQSl6FcuF0HYhCfIgVz-GUMSJKcT5c",
      authDomain: "zamir15-intercom.firebaseapp.com",
      projectId: "zamir15-intercom",
      storageBucket: "zamir15-intercom.firebasestorage.app",
      messagingSenderId: "823056442276",
      appId: "1:823056442276:web:a4235e2219152bb6789731"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const pc = new RTCPeerConnection({
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    });

    const grid = document.getElementById("grid");
    const dbgEl = document.getElementById("dbg");
    const statusText = document.getElementById("statusText");

    function dbg(msg) { dbgEl.textContent = msg; }

    pc.onconnectionstatechange = () => {
      dbg("מצב חיבור: " + pc.connectionState);
    };

    for (let i = 1; i <= 24; i++) {
      const div = document.createElement("div");
      div.className = "btn";
      div.textContent = `דירה ${i}`;
      div.onclick = () => startCall(i);
      grid.appendChild(div);
    }

    async function startCall(aptId) {
      document.getElementById("status").style.display = "flex";
      statusText.textContent = "מבקש הרשאות מצלמה/מיקרופון...";

      let stream;
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      } catch (err) {
        alert("אין הרשאת מצלמה/מיקרופון: " + (err?.message || err));
        location.reload();
        return;
      }

      document.getElementById("localVideo").srcObject = stream;
      stream.getTracks().forEach(t => pc.addTrack(t, stream));

      // יוצרים מסמך שיחה חדש
      const callDocRef = doc(collection(db, "calls"));

      // חשוב: onicecandidate מוגדר מוקדם
      pc.onicecandidate = async (e) => {
        if (!e.candidate) return;
        await addDoc(collection(callDocRef, "offerCandidates"), e.candidate.toJSON());
      };

      statusText.textContent = "מחייג...";

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      await setDoc(callDocRef, {
        apartment: aptId,
        status: "dialing",
        offer: { type: offer.type, sdp: offer.sdp },
        createdAt: serverTimestamp()
      });

      // מאזין ל-answer
      onSnapshot(callDocRef, async (s) => {
        const d = s.data();
        if (!d) return;

        if (d.answer && !pc.currentRemoteDescription) {
          await pc.setRemoteDescription(new RTCSessionDescription(d.answer));
          statusText.textContent = "מחובר ✅";
        }
        if (d.status === "opened") location.reload();
      });

      // מאזין ל-answerCandidates
      onSnapshot(collection(callDocRef, "answerCandidates"), (s) => {
        s.docChanges().forEach((c) => {
          if (c.type === "added") {
            pc.addIceCandidate(new RTCIceCandidate(c.doc.data())).catch(() => {});
          }
        });
      });
    }
  </script>
</body>
</html>
