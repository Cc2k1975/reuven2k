<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>×“×•×‘××™ ××˜×¨×• - PRO 2025</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root { --brand: #2563eb; --bg: #f8fafc; --red: #ef4444; --yellow: #fff9c4; --green: #16a34a; }
    body { margin: 0; font-family: system-ui, sans-serif; background: var(--bg); padding: 10px; color: #1e293b; }
    .card { background: white; border-radius: 20px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); max-width: 500px; margin: auto; }
    
    .converter { background: #e2e8f0; padding: 15px; border-radius: 12px; margin-bottom: 15px; text-align: center; border: 1px solid #cbd5e1; }
    .converter input { width: 85%; padding: 15px; border-radius: 10px; border: 2px solid var(--brand); font-weight: bold; font-size: 24px; text-align: center; margin-bottom: 12px; }
    .calc-btns { display: flex; gap: 8px; justify-content: center; }
    .calc-btn { flex: 1; padding: 12px 5px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; font-size: 13px; }
    .btn-ils { background: #1e293b; } 
    .btn-aed { background: #16a34a; }

    .save-loc-btn { width: 100%; margin-top: 10px; padding: 10px; background: #fff; border: 2px dashed var(--brand); color: var(--brand); border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 14px; }

    .selectors { display: grid; grid-template-columns: 1fr 45px 1fr; align-items: end; gap: 5px; margin-bottom: 20px; margin-top: 15px; }
    label { display: block; font-size: 13px; font-weight: bold; margin-bottom: 6px; color: #475569; }
    select { width: 100%; padding: 12px; border-radius: 12px; border: 2px solid #cbd5e1; background: #fff; font-size: 14px; }
    optgroup { font-size: 15px; font-weight: bold; background: #f1f5f9; }

    .swap-btn { background: #f1f5f9; border: 2px solid #cbd5e1; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; margin-bottom: 5px; }
    .btn { width: 100%; padding: 18px; background: var(--brand); color: white; border: none; border-radius: 14px; font-size: 20px; font-weight: 800; cursor: pointer; }

    .route-container { margin-top: 20px; border-top: 3px solid #e2e8f0; padding-top: 15px; }
    .v-step { display: flex; gap: 12px; position: relative; padding-bottom: 20px; }
    .v-step:not(:last-child)::after { content: ''; position: absolute; right: 10px; top: 24px; width: 4px; height: 100%; background: var(--red); z-index: 1; }
    .v-dot { width: 22px; height: 22px; border-radius: 50%; background: #fff; border: 4px solid var(--red); z-index: 2; flex-shrink: 0; }
    .v-text { font-size: 15px; flex-grow: 1; }
    
    .walk-box { background: var(--yellow); padding: 12px; border-radius: 10px; margin-top: 10px; border: 2px solid #fbc02d; font-size: 14px; }
    .exit-info { color: var(--green); font-weight: 800; display: block; margin-top: 5px; border-top: 1px dashed #16a34a; padding-top: 5px; }

    #map { height: 300px; width: 100%; border-radius: 15px; margin-top: 15px; display: none; border: 2px solid #cbd5e1; z-index: 100; }
    .map-btn { width: 100%; padding: 12px; background: #475569; color: white; border: none; border-radius: 10px; font-weight: bold; margin-top: 10px; cursor: pointer; display: none; }
  </style>
</head>
<body>

<div class="card">
  <div class="converter">
    <input type="number" id="main_input" placeholder="×”×›× ×¡ ×¡×›×•×">
    <div class="calc-btns">
      <button class="calc-btn btn-aed" onclick="toAed()">ğŸ’° ×”×¤×•×š ×œ×“×™×¨×”×</button>
      <button class="calc-btn btn-ils" onclick="toIls()">ğŸ‡®ğŸ‡± ×”×¤×•×š ×œ×©×§×œ×™×</button>
    </div>
    <button class="save-loc-btn" onclick="saveCurrentLocation()">ğŸ“ ×©××•×¨ ××™×§×•× × ×•×›×—×™ ×›××Ÿ</button>
  </div>

  <div class="selectors">
    <div><label>××•×¦×</label><select id="from"></select></div>
    <div class="swap-btn" onclick="swap()">â‡„</div>
    <div><label>×™×¢×“</label><select id="to"></select></div>
  </div>

  <button class="btn" onclick="buildRoute()">ğŸš‡ ×ª×›× ×Ÿ ××¡×œ×•×œ</button>

  <div id="output" style="display:none;" class="route-container">
    <div id="vMap"></div>
    <button id="showMapBtn" class="map-btn" onclick="toggleLiveMap()">ğŸ—ºï¸ ×¤×ª×— ××¤×” ×—×™×” (×“×•×¨×© ××™× ×˜×¨× ×˜)</button>
    <div id="map"></div>
  </div>
</div>

<script>
const METRO_COORDS = {
  "DMCC": [25.0671, 55.1402], "Sobha Realty": [25.0784, 55.1481], "Al Khail": [25.0933, 55.1614],
  "Onpassive": [25.1278, 55.2017], "Business Bay": [25.1903, 55.2694], "Burj Khalifa / Dubai Mall": [25.1994, 55.2773],
  "Financial Centre": [25.2104, 55.2761], "Emirates Towers": [25.2185, 55.2811], "World Trade Centre": [25.2268, 55.2882],
  "Max": [25.2364, 55.3021], "ADCB": [25.2428, 55.3049], "BurJuman": [25.2530, 55.3033], "Union": [25.2662, 55.3125],
  "Deira City Centre": [25.2510, 55.3341], "Al Rigga": [25.2628, 55.3235], "GGICO": [25.2517, 55.3444],
  "Airport T1": [25.2482, 55.3510], "Airport T3": [25.2447, 55.3639], "Mall of the Emirates": [25.1181, 55.2014],
  "Equiti": [25.1051, 55.1878], "Mashreq": [25.1118, 55.1951], "Dubai Internet City": [25.1011, 55.1706]
};

const RED_LINE = ["DMCC", "Sobha Realty", "Al Khail", "Onpassive", "Business Bay", "Burj Khalifa / Dubai Mall", "Financial Centre", "Emirates Towers", "World Trade Centre", "Max", "ADCB", "BurJuman", "Union", "Deira City Centre", "Al Rigga", "GGICO", "Airport T1", "Airport T3", "Mall of the Emirates", "Equiti", "Mashreq", "Dubai Internet City"];

let DATA = {
  "ğŸ¨ ×‘×ª×™ ××œ×•×Ÿ": [
    { id: "lux", name: "ğŸ¨ ××œ×•×Ÿ LUXE JBR", station: "DMCC", exit: "Exit 1", walk: "12 ×“×§'", lat: 25.0769, lng: 55.1311 },
    { id: "para", name: "ğŸ¨ ××œ×•×Ÿ Paramount", station: "Business Bay", exit: "Exit 1", walk: "10 ×“×§'", lat: 25.1855, lng: 55.2858 }
  ],
  "ğŸ›ï¸ ×—× ×•×™×•×ª ×•×–×•×œ": [
    { id: "d2d_k", name: "ğŸ›’ Day to Day ×›×¨××” (1-20 ×©×—)", station: "ADCB", exit: "Exit 1", walk: "5 ×“×§'", lat: 25.2424, lng: 55.3023 },
    { id: "d2d_d", name: "ğŸ›’ Day to Day ×“×™×™×¨×” (×–×•×œ)", station: "Deira City Centre", exit: "Exit 1", walk: "2 ×“×§'", lat: 25.2505, lng: 55.3330 },
    { id: "gift_v", name: "ğŸ Gift Village (×”×›×œ ×‘×–×•×œ)", station: "Max", exit: "Exit 1", walk: "8 ×“×§'", lat: 25.2366, lng: 55.3041 },
    { id: "ansari", name: "ğŸ’± Al Ansari (×”××¨×ª ×›×¡×£)", station: "Al Rigga", exit: "Exit 2", walk: "3 ×“×§'", lat: 25.2625, lng: 55.3228 }
  ],
  "ğŸ´ ××¡×¢×“×•×ª ×•××•×›×œ": [
    { id: "safadi", name: "ğŸ´ Al Safadi (×¢×“ 50 ×©×—)", station: "Financial Centre", exit: "Exit 1", walk: "5 ×“×§'", lat: 25.2075, lng: 55.2714 },
    { id: "fantastico", name: "ğŸ• ×§×¤×” ×¤× ×˜×¡×˜×™×§×• (×›×©×¨ ×—×œ×‘×™)", station: "Business Bay", exit: "Exit 1 (Mazaya)", walk: "10 ×“×§'", lat: 25.1919, lng: 55.2678 },
    { id: "tlv", name: "ğŸ¥© ××¡×¢×“×ª TLV (×›×©×¨ ×‘×©×¨×™)", station: "Max", exit: "Exit 1 (Hotel H)", walk: "6 ×“×§'", lat: 25.2272, lng: 55.2835 },
    { id: "fish", name: "ğŸŸ Fish Hut (×–×•×œ ×•×˜×¢×™×)", station: "Mall of the Emirates", exit: "Exit 1", walk: "12 ×“×§'", lat: 25.1181, lng: 55.2014 }
  ],
  "âœ¨ ××˜×¨×§×¦×™×•×ª": [
    { id: "frame", name: "ğŸ–¼ï¸ ×”××¡×’×¨×ª (Dubai Frame)", station: "Max", exit: "Exit 1", walk: "10 ×“×§'", lat: 25.2355, lng: 55.3003 },
    { id: "museum", name: "ğŸš€ ××•×–×™××•×Ÿ ×”×¢×ª×™×“", station: "Emirates Towers", exit: "Direct Link", walk: "2 ×“×§'", lat: 25.2191, lng: 55.2819 },
    { id: "burj", name: "ğŸ™ï¸ ×‘×•×¨×’' ×—×œ×™×¤×” ×•××–×¨×§×•×ª", station: "Burj Khalifa / Dubai Mall", exit: "Mall Bridge", walk: "15 ×“×§'", lat: 25.1972, lng: 55.2744 }
  ],
  "âœˆï¸ ×ª×—×‘×•×¨×”": [
    { id: "air3", name: "âœˆï¸ ×©×“×” ×ª×¢×•×¤×” T3", station: "Airport T3", exit: "××¤×œ×¡ ×”×’×¢×”", walk: "2 ×“×§'", lat: 25.2447, lng: 55.3639 },
    { id: "air1", name: "âœˆï¸ ×©×“×” ×ª×¢×•×¤×” T1", station: "Airport T1", exit: "××¤×œ×¡ ×”×’×¢×”", walk: "2 ×“×§'", lat: 25.2482, lng: 55.3510 }
  ],
  "â­ ××§×•××•×ª ×©×©××¨×ª×™": []
};

const saved = localStorage.getItem('myDubaiPlaces');
if(saved) DATA["â­ ××§×•××•×ª ×©×©××¨×ª×™"] = JSON.parse(saved);

const RATE = 1.18;
let liveMap = null;
let userMarker = null;

function toAed() {
  const input = document.getElementById('main_input');
  const val = parseFloat(input.value);
  if (!isNaN(val)) input.value = (val * RATE).toFixed(2);
}

function toIls() {
  const input = document.getElementById('main_input');
  const val = parseFloat(input.value);
  if (!isNaN(val)) input.value = (val / RATE).toFixed(2);
}

function swap() {
  const f = document.getElementById('from'), t = document.getElementById('to');
  const temp = f.value; f.value = t.value; t.value = temp;
  buildRoute();
}

function fillSelects() {
  let h = '';
  for (let c in DATA) {
    if (DATA[c].length === 0 && c === "â­ ××§×•××•×ª ×©×©××¨×ª×™") continue;
    h += `<optgroup label="${c}">`;
    DATA[c].forEach(p => h += `<option value="${p.id}">${p.name}</option>`);
    h += `</optgroup>`;
  }
  document.getElementById('from').innerHTML = h;
  document.getElementById('to').innerHTML = h;
  document.getElementById('from').value = "lux";
}

function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2-lat1) * Math.PI / 180;
    const dLon = (lon2-lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
    return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}

function saveCurrentLocation() {
  if (!navigator.geolocation) { alert("GPS ×œ× × ×ª××š"); return; }
  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    let closestStation = "";
    let minDistance = Infinity;
    for (let station in METRO_COORDS) {
      let d = getDistance(lat, lng, METRO_COORDS[station][0], METRO_COORDS[station][1]);
      if (d < minDistance) { minDistance = d; closestStation = station; }
    }
    if (minDistance > 2) {
      alert("×”××§×•× ×¨×—×•×§ ××“×™ (××¢×œ 2 ×§\"×). ×”××™×§×•× ×œ× × ×©××¨.");
      return;
    }
    const placeName = prompt("×©× ×”××§×•×:");
    if (!placeName) return;
    const newPlace = { id: "custom_" + Date.now(), name: "ğŸ“ " + placeName, station: closestStation, exit: "×‘×“×•×§ ×©×™×œ×•×˜", walk: (minDistance * 1000).toFixed(0) + " ×'", lat: lat, lng: lng };
    DATA["â­ ××§×•××•×ª ×©×©××¨×ª×™"].push(newPlace);
    localStorage.setItem('myDubaiPlaces', JSON.stringify(DATA["â­ ××§×•××•×ª ×©×©××¨×ª×™"]));
    fillSelects();
    alert("× ×©××¨ ×‘×”×¦×œ×—×”!");
  }, () => alert("×©×’×™××ª ××™×§×•×"), {enableHighAccuracy: true});
}

function buildRoute() {
  let p1, p2;
  const fromVal = document.getElementById('from').value;
  const toVal = document.getElementById('to').value;
  for (let c in DATA) {
    let f1 = DATA[c].find(p => p.id === fromVal); if(f1) p1 = f1;
    let f2 = DATA[c].find(p => p.id === toVal); if(f2) p2 = f2;
  }
  const idx1 = RED_LINE.indexOf(p1.station), idx2 = RED_LINE.indexOf(p2.station);
  if (idx1 === -1 || idx2 === -1) return;
  document.getElementById('output').style.display = 'block';
  document.getElementById('showMapBtn').style.display = 'block';
  document.getElementById('map').style.display = 'none';
  let st = RED_LINE.slice(Math.min(idx1, idx2), Math.max(idx1, idx2) + 1);
  if (idx1 > idx2) st.reverse();
  let html = `<div class="v-step"><div class="v-dot" style="background:var(--red)"></div><div class="v-text"><b>×¢×œ×” ×‘: ${p1.station}</b><br><small>${p1.name}</small></div></div>`;
  for (let i = 1; i < st.length - 1; i++) {
    html += `<div class="v-step"><div class="v-dot" style="width:10px;height:10px;margin-right:6px;border:2px solid var(--red)"></div><div class="v-text" style="color:#64748b;font-size:12px">${st[i]}</div></div>`;
  }
  html += `
    <div class="v-step">
      <div class="v-dot" style="background:var(--green); border-color:var(--green)"></div>
      <div class="v-text"><b>×¨×“ ×‘: ${p2.station}</b><div class="walk-box">ğŸ“ ×™×¢×“: ${p2.name}<br>ğŸ”¢ ${st.length - 1} ×ª×—× ×•×ª<br>ğŸš¶â€â™‚ï¸ ×”×œ×™×›×”: ${p2.walk}<br><span class="exit-info">ğŸ ×™×¦×™××”: ${p2.exit}</span></div></div>
    </div>`;
  document.getElementById('vMap').innerHTML = html;
}

function toggleLiveMap() {
  if (!navigator.onLine) { alert("××™×Ÿ ××™× ×˜×¨× ×˜"); return; }
  const mapDiv = document.getElementById('map');
  if (mapDiv.style.display === 'block') { mapDiv.style.display = 'none'; return; }
  mapDiv.style.display = 'block';
  let p2;
  const toVal = document.getElementById('to').value;
  for (let c in DATA) { let f2 = DATA[c].find(p => p.id === toVal); if(f2) p2 = f2; }
  if (!liveMap) {
    liveMap = L.map('map').setView([p2.lat, p2.lng], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(liveMap);
  } else { liveMap.setView([p2.lat, p2.lng], 15); }
  liveMap.eachLayer((layer) => { if (layer instanceof L.Marker || layer instanceof L.CircleMarker) liveMap.removeLayer(layer); });
  L.marker([p2.lat, p2.lng]).addTo(liveMap).bindPopup(`<b>×™×¢×“:</b> ${p2.name}`).openPopup();
  if (navigator.geolocation) {
    navigator.geolocation.watchPosition((pos) => {
      const { latitude, longitude } = pos.coords;
      if (userMarker) liveMap.removeLayer(userMarker);
      userMarker = L.circleMarker([latitude, longitude], { color: 'blue', radius: 8, fillOpacity: 0.8 }).addTo(liveMap);
    }, null, { enableHighAccuracy: true });
  }
  setTimeout(() => { liveMap.invalidateSize(); }, 200);
}

fillSelects();
</script>
</body>
</html>
