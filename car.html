<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>שליפת נתוני רכב לפי מספר רישוי</title>

  <style>
    :root{
      --bg1:#0b1224; --bg2:#071024;
      --stroke:rgba(255,255,255,.10);
      --txt:#eaf0ff;
      --muted:rgba(234,240,255,.72);
      --accent:#22c55e;
      --radius:18px;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--txt);
      background: radial-gradient(1200px 700px at 80% -10%, rgba(34,197,94,.18), transparent 60%),
                  radial-gradient(900px 600px at 10% 10%, rgba(59,130,246,.15), transparent 55%),
                  linear-gradient(180deg,var(--bg1),var(--bg2));
      min-height:100vh;
      padding:16px;
    }
    .wrap{max-width:920px;margin:0 auto}
    .top{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--stroke);
      border-radius:24px;
      padding:16px;
      box-shadow: var(--shadow);
    }
    .title{font-weight:900;font-size:22px;margin:0 0 6px}
    .subtitle{color:var(--muted);margin:0 0 14px;font-weight:700}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--txt);
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .btn:active{transform:scale(.99)}
    .btn.accent{
      background: linear-gradient(180deg, rgba(34,197,94,.95), rgba(22,163,74,.95));
      border-color: rgba(34,197,94,.45);
      color:#052012;
    }
    .btn.ghost{ background: rgba(255,255,255,.04); }
    .input{
      flex:1;
      min-width:220px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      color:var(--txt);
      font-weight:900;
      outline:none;
    }

    .panel{
      margin-top:12px;
      background: rgba(255,255,255,.05);
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:12px;
    }

    .scanner{ margin-top:12px; display:none; }
    .scanner.on{ display:block; }

    /* הוידאו קיים רק כמקור, לא מוצג */
    video#video{
      position:absolute;
      left:-99999px;
      top:-99999px;
      width:2px;
      height:2px;
      opacity:0;
      pointer-events:none;
    }

    .scanCard{
      border:1px solid var(--stroke);
      border-radius:18px;
      background: rgba(0,0,0,.20);
      overflow:hidden;
    }

    .hudBar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      padding:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.22);
    }
    .hudBox{
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.14);
      border-radius:16px;
      padding:10px 12px;
      display:flex;
      align-items:center;
      gap:10px;
      min-width:240px;
    }
    .hudTitle{font-weight:900}
    .hudSub{color:rgba(255,255,255,.75);font-weight:800;font-size:12px}

    .zoomWrap{
      display:flex;
      align-items:center;
      gap:10px;
      width:100%;
    }
    .range{ width:100%; accent-color: var(--accent); }

    .previewWrap{
      position:relative;
      padding:12px;
      background: rgba(0,0,0,.18);
    }

    /* חלון סריקה קצת יותר גבוה */
    .previewBox{
      width:100%;
      aspect-ratio: 4.2 / 1;
      border:3px solid rgba(34,197,94,.95);
      border-radius:18px;
      overflow:hidden;
      background:#000;
      box-shadow: 0 0 0 1px rgba(34,197,94,.15) inset;
      position:relative;
    }
    canvas#preview{
      width:100%;
      height:100%;
      display:block;
      background:#000;
    }

    .status{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      color:var(--muted);
      font-weight:800;
      white-space:pre-wrap;
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      overflow:hidden;
      border-radius:16px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
    }
    th,td{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      font-weight:800;
      vertical-align:top;
    }
    th{color:rgba(255,255,255,.75);width:38%}
    td{color:var(--txt)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  </style>
</head>

<body>
<div class="wrap">

  <div class="top">
    <div class="title">סריקה בלייב – תעמיד את הלוחית בתוך המסגרת</div>
    <div class="subtitle">זיהוי 7/8 ספרות → מכניס לשדה → שולף נתונים אוטומטית</div>

    <div class="row">
      <button class="btn ghost" id="btnClose" style="display:none;">סגור</button>

      <input class="input" id="plateInput" inputmode="numeric" autocomplete="off"
             placeholder="מספר רכב (ללא מקפים)" />

      <button class="btn" id="btnScan">סרוק</button>
      <button class="btn accent" id="btnFetch">שלוף נתונים</button>
      <button class="btn" id="btnWhatsApp" style="display:none;">ווצאפ</button>
    </div>

    <div class="scanner" id="scanner">
      <div class="scanCard">
        <div class="hudBar">
          <div class="hudBox">
            <div>
              <div class="hudTitle" id="hudTitle">מכין OCR…</div>
              <div class="hudSub" id="hudSub">טיפ: תתקרב עד שהספרות חדות ותישאר יציב לשנייה</div>
            </div>
          </div>

          <div class="hudBox" style="flex:1;min-width:260px;">
            <div style="font-weight:900;">זום</div>
            <div class="zoomWrap">
              <span class="mono" id="zoomVal">×1.0</span>
              <input class="range" id="zoomRange" type="range" min="1" max="3" step="0.1" value="1" />
            </div>
          </div>
        </div>

        <div class="previewWrap">
          <div class="previewBox">
            <canvas id="preview"></canvas>
          </div>
        </div>
      </div>

      <video id="video" playsinline muted></video>
    </div>

    <div class="status" id="status">מוכן.</div>

    <div class="panel" id="resultPanel" style="display:none;">
      <div style="font-weight:900;margin-bottom:6px;">נתוני רכב</div>
      <div id="resultMeta" style="color:var(--muted);font-weight:800"></div>
      <table id="resultTable"></table>
    </div>
  </div>

</div>

<script>
(() => {
  const RESOURCE_ID = "053cea08-09bc-40ec-8f7a-156f0677aff3";

  const HIDE_FIELDS = new Set([
    "zmig_kidmi","zmig_ahori","misgeret","mispar_horaa","tozeret_cd","degem_cd",
    "degem_manoa","tzeva_cd","sug_degem","_id","rank"
  ]);

  const LABELS = {
    "mispar_rechev":"מספר רכב",
    "tozeret_nm":"יצרן / שם תוצר",
    "degem_nm":"דגם",
    "kinuy_mishari":"כינוי מסחרי",
    "ramat_gimur":"רמת גימור",
    "shnat_yitzur":"שנת ייצור",
    "baalut":"בעלות",
    "tokef_dt":"תוקף הרישוי",
    "test_dt":"טסט אחרון",
    "sug_delek_nm":"סוג דלק",
    "kvutzat_zihum":"קבוצת זיהום",
    "ramat_eivzur_betihuti":"רמת אבזור בטיחותי",
    "tzeva_rechev":"צבע"
  };

  const LOCAL_TESS_BASE = "/tess";
  const $ = (id) => document.getElementById(id);

  const plateInput = $("plateInput");
  const btnScan = $("btnScan");
  const btnFetch = $("btnFetch");
  const btnClose = $("btnClose");
  const btnWhatsApp = $("btnWhatsApp");
  const scanner = $("scanner");
  const video = $("video");
  const status = $("status");
  const hudTitle = $("hudTitle");
  const hudSub = $("hudSub");
  const zoomRange = $("zoomRange");
  const zoomVal = $("zoomVal");
  const resultPanel = $("resultPanel");
  const resultTable = $("resultTable");
  const resultMeta = $("resultMeta");

  const preview = $("preview");
  const pctx = preview.getContext("2d", { willReadFrequently:true });

  let stream = null;
  let track = null;
  let worker = null;
  let scanning = false;
  let busyOCR = false;
  let lastRecord = null;

  let zoomFactor = 1.0;
  let hwZoomCaps = null;

  // ======= כיוונונים אופטימליים למהירות 2 שניות =======
  const FAST_SCALE = 1.25;           // מוקטן מעט לטובת מהירות עיבוד
  const CONF_IMMEDIATE = 82;         // בטחון גבוה => נעילה מיידית
  const CONF_MIN_SCORE = 45;         // סף כניסה נמוך יותר כדי להתחיל לצבור מוקדם
  const DECAY = 0.82;                // דעיכה מהירה יותר כדי לנקות רעשים
  const LOCK_SCORE = 4.2;            // ירד מ-7.0 ל-4.2 לנעילה סופר מהירה
  const LOCK_GAP = 1.0;              // פער מינימלי
  const STICKY_SHOW_MS = 800;        
  const MAX_KEYS = 15;               
  // =========================

  function setStatus(msg){ status.textContent = msg; }
  function onlyDigits(s){ return (s || "").replace(/[^\d]/g,""); }
  function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

  function extractPlate(text){
    const digits = onlyDigits(text);
    if (digits.length === 7 || digits.length === 8) return digits;

    const m = text.match(/\d{7,8}/g);
    if (m && m.length){
      const cand = m[0];
      if (cand.length === 7 || cand.length === 8) return cand;
    }
    return "";
  }

  function hamming(a,b){
    if (!a || !b || a.length !== b.length) return 999;
    let d=0;
    for (let i=0;i<a.length;i++) if (a[i]!==b[i]) d++;
    return d;
  }

  async function loadScript(src){
    return new Promise((resolve, reject)=>{
      const s = document.createElement("script");
      s.src = src;
      s.async = true;
      s.onload = ()=>resolve(src);
      s.onerror = ()=>reject(new Error("נכשל טעינת סקריפט: " + src));
      document.head.appendChild(s);
    });
  }

  async function ensureTesseractLoaded(){
    if (window.Tesseract) return;
    await loadScript(`${LOCAL_TESS_BASE}/tesseract.min.js`);
  }

  async function ensureWorker(){
    if (worker) return worker;
    await ensureTesseractLoaded();
    hudTitle.textContent = "מכין OCR…";
    worker = await Tesseract.createWorker("eng", 1, {
      workerPath: `${LOCAL_TESS_BASE}/worker.min.js`,
      corePath:   `${LOCAL_TESS_BASE}/tesseract-core.wasm.js`,
      logger: ()=>{}
    });
    await worker.setParameters({
      tessedit_char_whitelist: "0123456789",
      tessedit_pageseg_mode: "7",
      tessedit_ocr_engine_mode: "1"
    });
    return worker;
  }

  function resizePreviewCanvas(){
    const rect = preview.getBoundingClientRect();
    preview.width = Math.round(rect.width);
    preview.height = Math.round(rect.height);
  }

  async function openCamera(){
    if (stream) return;
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } },
      audio:false
    });
    video.srcObject = stream;
    await video.play();
    track = stream.getVideoTracks()[0];
    resizePreviewCanvas();
  }

  function closeCamera(){
    scanning = false;
    busyOCR = false;
    resetVoting();
    if (stream){
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
    }
    scanner.classList.remove("on");
    btnClose.style.display = "none";
  }

  function getFrameCropBox(videoW, videoH){
    // מיקוד אופטימלי ללוחית
    const w = videoW * 0.7;
    const h = videoH * 0.2;
    const x = (videoW - w) / 2;
    const y = videoH * 0.65; 
    const z = clamp(zoomFactor, 1, 3);
    return { x, y, w: w/z, h: h/z };
  }

  function drawPreviewROI(){
    const vw = video.videoWidth, vh = video.videoHeight;
    if (!vw || !vh) return;
    resizePreviewCanvas();
    const box = getFrameCropBox(vw, vh);
    pctx.drawImage(video, box.x, box.y, box.w, box.h, 0, 0, preview.width, preview.height);
  }

  async function recognize(roi){
    const r = await worker.recognize(roi);
    const plate = extractPlate(r?.data?.text || "");
    return { plate, conf: Number(r?.data?.confidence ?? 0) };
  }

  let scores = new Map();
  let lastStablePlate = "";
  let lastStableAt = 0;

  function resetVoting(){ scores.clear(); lastStablePlate = ""; }

  function decayScores(){
    for (const [k,v] of scores.entries()){
      v.score *= DECAY;
      if (v.score < 0.2) scores.delete(k);
    }
  }

  function addVote(plate, conf){
    if (!plate || conf < CONF_MIN_SCORE) return;
    const p = [...scores.keys()].find(k => k.length === plate.length && hamming(k, plate) <= 1) || plate;
    const prev = scores.get(p) || { score:0 };
    prev.score += (conf / 20);
    scores.set(p, prev);
  }

  async function scanLoop(){
    if (!scanning) return;
    drawPreviewROI();
    if (!busyOCR && worker) {
      const vw = video.videoWidth, vh = video.videoHeight;
      const box = getFrameCropBox(vw, vh);
      const roi = document.createElement("canvas");
      roi.width = box.w * FAST_SCALE; roi.height = box.h * FAST_SCALE;
      roi.getContext("2d").drawImage(video, box.x, box.y, box.w, box.h, 0, 0, roi.width, roi.height);
      
      busyOCR = true;
      const { plate, conf } = await recognize(roi);
      
      decayScores();
      if (plate && conf >= CONF_IMMEDIATE) {
          finalize(plate); return;
      }
      addVote(plate, conf);
      const sorted = [...scores.entries()].sort((a,b)=>b[1].score - a[1].score);
      if (sorted[0] && sorted[0][1].score >= LOCK_SCORE) {
          finalize(sorted[0][0]); return;
      }
      hudSub.textContent = sorted[0] ? "מוביל: " + sorted[0][0] : "מחפש לוחית...";
      busyOCR = false;
    }
    requestAnimationFrame(scanLoop);
  }

  function finalize(p) {
    plateInput.value = p;
    closeCamera();
    fetchVehicle();
  }

  async function openLiveScanner(){
    scanner.classList.add("on");
    btnClose.style.display = "inline-block";
    await openCamera();
    await ensureWorker();
    scanning = true;
    scanLoop();
  }

  async function fetchVehicle(){
    const plate = onlyDigits(plateInput.value);
    if (plate.length < 7) return;
    setStatus("שולף נתונים…");
    const filters = encodeURIComponent(JSON.stringify({ mispar_rechev: Number(plate) }));
    const url = `https://data.gov.il/api/3/action/datastore_search?resource_id=${RESOURCE_ID}&filters=${filters}&limit=1`;
    try{
      const res = await fetch(url);
      const json = await res.json();
      const rec = json?.result?.records?.[0];
      if (!rec) { setStatus("לא נמצא."); return; }
      lastRecord = rec;
      renderRecord(rec);
    } catch(e){ setStatus("שגיאה."); }
  }

  function renderRecord(rec){
    const rows = Object.keys(rec)
      .filter(k => !HIDE_FIELDS.has(k) && rec[k])
      .sort()
      .map(k => `<tr><th>${LABELS[k] || k}</th><td>${rec[k]}</td></tr>`);
    resultTable.innerHTML = rows.join("");
    resultPanel.style.display = "block";
    btnWhatsApp.style.display = "inline-block";
    resultMeta.textContent = `מספר: ${rec.mispar_rechev}`;
    setStatus("בוצע.");
  }

  btnScan.onclick = openLiveScanner;
  btnClose.onclick = closeCamera;
  btnFetch.onclick = fetchVehicle;
  zoomRange.oninput = () => { 
    zoomFactor = zoomRange.value; 
    zoomVal.textContent = "×" + parseFloat(zoomFactor).toFixed(1); 
  };
  btnWhatsApp.onclick = () => {
    const text = Object.keys(lastRecord).filter(k=>!HIDE_FIELDS.has(k)).map(k=>`${LABELS[k]||k}: ${lastRecord[k]}`).join("\n");
    window.open("https://wa.me/?text=" + encodeURIComponent(text));
  };
})();
</script>
</body>
</html>
