<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>××™×§×•× ×”×¨×›×‘ ×”×ª×¤×¢×•×œ×™</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    /* ×¤×•× ×§×¦×™×™×ª ×”××¨×” ×’×¡×”: 1cm ~= 37.8px */
    :root {
        --btn-width:  226.8px; /* 6cm * 37.8 */
        --btn-height: 245.7px; /* 6.5cm * 37.8 */
    }

    *{box-sizing:border-box;margin:0;padding:0;}
    html,body{
      height:100%;
      font-family:system-ui,"Heebo","Arial",sans-serif;
      background:#e8eef4;
      color:#000;
    }
    body{
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:16px;
    }
    .app{
      width:100%;
      max-width:500px;
      background:#ffffff;
      border-radius:18px;
      box-shadow:0 14px 35px rgba(0,0,0,0.18);
      padding:18px 16px 20px;
      color:#000;
      position:relative;
      overflow:hidden;
    }
    h1{
      font-size:1.6rem;
      margin-bottom:10px;
      text-align:center;
      font-weight:800;
      color:#000;
    }
    .subtitle{
      font-size:0.9rem;
      opacity:0.75;
      text-align:center;
      margin-bottom:14px;
      color:#333;
    }

    .status{
      min-height:26px;
      font-size:0.9rem;
      margin-bottom:8px;
    }
    .error{color:#d63031;}
    .ok{color:#27ae60;}

    /* ××¡×š ×¨××©×™ â€“ ×©× ×™ ×œ×—×¦× ×™× ×’×“×•×œ×™× */
    #screenHome{
      animation: fadeInUp 0.6s ease;
    }
    .main-actions{
      display:flex;
      flex-direction:column;
      gap:14px;
      margin-top:10px;
    }
    
    /* **×”×©×™× ×•×™×™× ×œ×’×•×“×œ ×”×œ×—×¦× ×™×:** */
    .btn-hero{
      width:100%; /* ×¨×•×—×‘ ××œ× ×‘×ª×•×š ×”××¤×œ×™×§×¦×™×” */
      /* ×’×•×“×œ ×§×‘×•×¢ ×œ×¨×•×—×‘ ×•×œ×’×•×‘×” - ×¨×§ ×× ×¨×•×¦×™× ×’×•×“×œ ×§×‘×•×¢ ×‘×¤×™×§×¡×œ×™×/×¡"× */
      /* ×›×“×™ ×©×™×”×™×” ×¨×¡×¤×•× ×¡×™×‘×™, × ×’×‘×™×œ ××ª ×”××™× ×™××•×/××§×¡×™××•× */
      min-width: var(--btn-width);
      max-width: var(--btn-width);
      min-height: var(--btn-height);
      max-height: var(--btn-height);
      
      /* ××¨×›×•×– ×‘×ª×•×š ×”Ö¾.main-actions (×›×©×”×•× flex-direction: column) */
      align-self: center;
      
      padding:0; /* ××•×¨×™×“ ××ª ×”×¤×“×™× ×’ ×”×§×•×“× */
      border-radius:18px; /* ×©×™× ×™×ª×™ ×œ×¨×™×‘×•×¢ ××¢×•×’×œ ×‘××§×•× ×¢×’×•×œ */
      border:none;
      font-size:1.4rem; /* ×”×’×“×œ×ª×™ ××¢×˜ ××ª ×”×¤×•× ×˜ */
      font-weight:800;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      box-shadow:0 8px 20px rgba(0,0,0,0.16);
      transition:transform 0.15s ease, box-shadow 0.15s ease;
      text-align:center;
      line-height:1.3;
    }

    /* ×”×ª×××” ×œ××¡×›×™× ×§×˜× ×™× ×××•×“: ×× ×¨×•×—×‘ ×”××¡×š ×§×˜×Ÿ ×-var(--btn-width), × ×—×–×•×¨ ×œ×’×•×“×œ ××œ× */
    @media (max-width: 400px) {
        .btn-hero {
            min-width: 100%;
            max-width: 100%;
            height: 100px; /* ×’×•×‘×” ×§×˜×Ÿ ×™×•×ª×¨ ×›×“×™ ×œ× ×œ×ª×¤×•×¡ ××ª ×›×œ ×”××¡×š */
            min-height: 100px;
            max-height: 100px;
            font-size: 1.2rem;
            padding: 10px;
        }
    }
    /* ×¡×•×£ ×©×™× ×•×™×™ ×”×œ×—×¦× ×™× */

    .btn-hero:active{
      transform:scale(0.97);
      box-shadow:0 4px 10px rgba(0,0,0,0.18);
    }
    .btn-hero-primary{
      background:linear-gradient(135deg,#00b7ff,#00ffae);
      color:#00242f;
    }
    .btn-hero-secondary{
      background:#0f172a;
      color:#f9fafb;
    }

    /* ××¡×š ××™×¡×•×£ ×¨×›×‘ */
    #screenPickup{
      display:none;
      animation: fadeIn 0.4s ease;
    }

    .places-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-top:8px;
      margin-bottom:6px;
      color:#000;
      gap:8px;
    }
    .places-header span{
      font-size:0.95rem;
      font-weight:600;
    }
    .header-buttons{
      display:flex;
      gap:6px;
      align-items:center;
    }
    .btn-wa-all{
      background:transparent;
      border-radius:999px;
      border:1px solid rgba(37,211,102,0.8);
      padding:4px 10px;
      font-size:0.78rem;
      color:#128C7E;
      display:flex;
      align-items:center;
      gap:4px;
      cursor:pointer;
    }

    .list{
      max-height:45vh;
      overflow-y:auto;
      padding-right:2px;
    }

    .place{
      border-radius:14px;
      background:#f2f4f7;
      padding:10px 10px 9px;
      margin-bottom:8px;
      border:1px solid rgba(0,0,0,0.08);
      color:#000;
      animation: fadeInUp 0.4s ease;
    }

    .badge{
      display:inline-block;
      font-size:0.75rem;
      padding:2px 8px;
      border-radius:999px;
      background:#e0ecff;
      color:#0b3c91;
      margin-bottom:4px;
    }

    .place-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:4px;
    }
    .place-name{
      font-weight:700;
      font-size:1.05rem;
      color:#000;
      word-break:break-word;
    }
    .place-time{
      font-size:0.8rem;
      opacity:0.7;
      white-space:nowrap;
      color:#444;
    }

    .place-bottom{
      display:flex;
      justify-content:flex-end;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      margin-top:4px;
      color:#000;
    }

    .btn-group{
      display:flex;
      gap:4px;
      flex-wrap:nowrap;
    }
    .btn-mini{
      padding:5px 9px;
      font-size:0.8rem;
      border-radius:999px;
      border:none;
      white-space:nowrap;
      font-weight:600;
      cursor:pointer;
    }

    .btn-waze{background:#0f99ff;color:#fff;}
    .btn-gmaps{background:#1abc9c;color:#000;}

    /* ××¤×” ×‘×¡×•×£ */
    #map{
      width:100%;
      height:230px;
      border-radius:14px;
      overflow:hidden;
      margin:10px 0 10px;
      border:1px solid rgba(0,0,0,0.1);
    }

    /* ××•×“×œ (×—×œ×•×Ÿ ×§×•×¤×¥) */
    .modal-overlay{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,0.32);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .modal{
      width:92%;
      max-width:360px;
      background:#ffffff;
      border-radius:16px;
      box-shadow:0 14px 40px rgba(0,0,0,0.45);
      padding:16px 14px 12px;
      animation: popIn 0.35s ease;
    }
    .modal-title{
      font-size:1.05rem;
      font-weight:700;
      margin-bottom:6px;
    }
    .modal-text{
      font-size:0.9rem;
      opacity:0.85;
      margin-bottom:10px;
    }
    .modal input[type="tel"]{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,0.2);
      background:#f7f7f7;
      color:#000;
      font-size:0.95rem;
      margin-bottom:6px;
      direction:ltr;
      text-align:left;
    }
    
    /* ×”×•×¡×¤×ª×™ ×›×¤×ª×•×¨ ×œ×©×™× ×•×™ ×”×˜×œ×¤×•×Ÿ */
    .phone-input-group {
        display: flex;
        gap: 8px;
    }
    .phone-input-group input[type="tel"] {
        flex-grow: 1;
        margin-bottom: 0; /* ×”×¤×“×™× ×’ ×›×‘×¨ ×‘Ö¾group */
    }
    .btn-change-phone {
        padding: 8px 12px;
        border-radius: 10px;
        border: 1px solid rgba(0,0,0,0.2);
        background: #f1f1f1;
        color: #333;
        font-size: 0.95rem;
        cursor: pointer;
        white-space: nowrap;
    }
    
    .modal-buttons{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:4px;
    }
    .btn-modal{
      border:none;
      border-radius:999px;
      padding:7px 14px;
      font-size:0.9rem;
      cursor:pointer;
    }
    .btn-modal-secondary{
      background:#f1f1f1;
      color:#333;
    }
    .btn-modal-primary{
      background:#00b894;
      color:#000;
      font-weight:600;
    }

    .modal-gps-status{
      font-size:0.85rem;
      min-height:18px;
      color:#e67e22;
      margin-bottom:4px;
    }

    .hidden{display:none;}

    /* ×× ×™××¦×™×•×ª */
    @keyframes fadeIn{
      from{opacity:0;}
      to{opacity:1;}
    }
    @keyframes fadeInUp{
      from{opacity:0; transform:translateY(12px);}
      to{opacity:1; transform:translateY(0);}
    }
    @keyframes popIn{
      from{opacity:0; transform:translateY(18px) scale(0.96);}
      to{opacity:1; transform:translateY(0) scale(1);}
    }
  </style>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
<div class="app">
  <h1>××™×§×•× ×”×¨×›×‘ ×”×ª×¤×¢×•×œ×™</h1>
  <div class="subtitle">×©××™×¨×ª ××™×§×•× ×—× ×™×™×” ×œ× ×•×¡×¢ ×”×‘×.</div>

  <div id="status" class="status"></div>

  <div id="screenHome">
    <div class="main-actions">
      <button id="btnNewPlace" class="btn-hero btn-hero-primary">
        ğŸš— ×—× ×™×™×ª ×¨×›×‘
      </button>
      <button id="btnShowLast" class="btn-hero btn-hero-secondary">
        ğŸ“Œ ××™×¡×•×£ ×¨×›×‘
      </button>
    </div>
  </div>

  <div id="screenPickup">
    <div class="places-header">
      <span>××™×§×•× × ×•×›×—×™ + ××™×§×•× ×§×•×“×</span>
      <div class="header-buttons">
        <button id="btnShareWhatsApp" class="btn-wa-all" type="button">
          ğŸ“² ×•×•××˜×¡××¤ ×œ× ×”×’ ×”××—×¨×•×Ÿ
        </button>
      </div>
    </div>

    <div id="lastPlaceBox" class="list"></div>

    <div id="map"></div>
  </div>

  <div id="modalOverlay" class="modal-overlay">
    <div id="modalPhone" class="modal">
      <div class="modal-title" id="modalTitle">×”×›× ×¡ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ×©××™×¨×ª ××™×§×•× ×”×¨×›×‘</div>
      <div class="modal-text" id="modalText">
        ×”×›× ×¡ ××ª ××¡×¤×¨ ×”×˜×œ×¤×•×Ÿ ×©×œ ×”× ×”×’ ×©××—× ×” ××ª ×”×¨×›×‘.
      </div>
      
      <div class="phone-input-group">
          <input
            id="modalPhoneInput"
            type="tel"
            inputmode="numeric"
            autocomplete="tel"
            maxlength="10"
            placeholder="05XXXXXXXX"
          >
          <button id="btnChangePhone" class="btn-change-phone hidden">×©× ×”</button>
      </div>
      
      <div id="modalGpsStatus" class="modal-gps-status"></div>
      <div class="modal-buttons">
        <button id="btnPhoneCancel" class="btn-modal btn-modal-secondary">×‘×™×˜×•×œ</button>
        <button id="btnPhoneOk" class="btn-modal btn-modal-primary">×©××•×¨ ××™×§×•×</button>
      </div>
    </div>
  </div>
</div>

<script>
  // ----- Firebase config â€“ ×¤×¨×•×™×§×˜ mycar -----
  const firebaseConfig = {
    apiKey: "AIzaSyCMntnZD__xfuQHzAhAaM-lSgzsjAKHBug",
    authDomain: "mycar-8b46d.firebaseapp.com",
    databaseURL: "https://mycar-8b46d-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "mycar-8b46d",
    storageBucket: "mycar-8b46d.firebasestorage.app",
    messagingSenderId: "247369154890",
    appId: "1:247369154890:web:1ecd68d830b8e52bca01b3"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const LAST_NODE = "carLastLocation"; // current + previous
  const LOCAL_PHONE_KEY = "carAppLastPhone"; // ××¤×ª×— ×œ-localStorage
  

  (function(){
    const statusEl         = document.getElementById('status');

    const screenHome       = document.getElementById('screenHome');
    const screenPickup     = document.getElementById('screenPickup');

    const btnNewPlace      = document.getElementById('btnNewPlace');
    const btnShowLast      = document.getElementById('btnShowLast');

    const lastPlaceBox     = document.getElementById('lastPlaceBox');
    const btnShareWhatsApp = document.getElementById('btnShareWhatsApp');

    const modalOverlay     = document.getElementById('modalOverlay');
    const modalPhoneInput  = document.getElementById('modalPhoneInput');
    const modalGpsStatus   = document.getElementById('modalGpsStatus');
    const btnPhoneCancel   = document.getElementById('btnPhoneCancel');
    const btnPhoneOk       = document.getElementById('btnPhoneOk');
    const btnChangePhone   = document.getElementById('btnChangePhone'); // ×›×¤×ª×•×¨ ×—×“×©
    const modalTitle       = document.getElementById('modalTitle');
    const modalText        = document.getElementById('modalText');
    
    // ××¦×‘ ××—×¨×•×Ÿ ×‘×–×™×›×¨×•×Ÿ: × ×•×›×—×™ + ×§×•×“×
    let lastPlaceCurrent = null;
    let lastPlacePrevious = null;
    let storedPhone = localStorage.getItem(LOCAL_PHONE_KEY) || '05'; // ×˜×•×¢×Ÿ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×©××•×¨

    // ××¤×”
    let map = null;
    let markerLayer = null;
    let mapInited = false;

    function ensureMap(){
      if (mapInited) return;
      const mapEl = document.getElementById('map');
      if (!mapEl || typeof L === 'undefined') return;

      map = L.map('map').setView([32.0853, 34.7818], 8);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: ''
      }).addTo(map);

      markerLayer = L.layerGroup().addTo(map);
      mapInited = true;
    }

    // ×˜×¢×™× ×ª ×”××™×§×•× ×”××—×¨×•×Ÿ ××¤×™×™×¨×‘×™×™×¡ ×‘×–××Ÿ ×××ª
    db.ref(LAST_NODE).on('value', snapshot => {
      const val = snapshot.val() || null;

      // backward compatible â€“ ×× ×¤×¢× × ×©××¨ ×›××•×‘×™×™×§×˜ ×‘×•×“×“
      if (val && val.current) {
        lastPlaceCurrent = (typeof val.current.lat === "number") ? val.current : null;
        lastPlacePrevious = (val.previous && typeof val.previous.lat === "number") ? val.previous : null;
      } else if (val && typeof val.lat === "number") {
        lastPlaceCurrent = val;
        lastPlacePrevious = null;
      } else {
        lastPlaceCurrent = null;
        lastPlacePrevious = null;
      }

      renderLastPlace();
      updateMap();
    });

    // ×›×¤×ª×•×¨ "×—× ×™×™×ª ×¨×›×‘"
    btnNewPlace.addEventListener('click', ()=>{
      openPhoneModal();
    });

    // ×›×¤×ª×•×¨ "××™×¡×•×£ ×¨×›×‘" â€“ ××¡×š × ×¤×¨×“
    btnShowLast.addEventListener('click', ()=>{
      screenHome.style.display  = 'none';
      screenPickup.style.display = 'block';
      ensureMap();
      setTimeout(()=>{
        if (map) {
          map.invalidateSize();
          updateMap();
        }
      }, 60);
    });

    // ---- ××•×“×œ ×˜×œ×¤×•×Ÿ: ×˜×™×¤×•×œ ×‘×–×›×™×¨×ª ×”×˜×œ×¤×•×Ÿ ----
    
    function setPhoneMode(isPreFilled) {
        if (isPreFilled && storedPhone && /^05\d{8}$/.test(storedPhone)) {
            // ××¦×‘: ×˜×œ×¤×•×Ÿ ×©××•×¨ ×•××•×›×Ÿ ×œ×©××™×¨×”
            modalTitle.textContent = '×©××™×¨×ª ××™×§×•× ×—×“×©';
            modalText.innerHTML = `×”×× ×‘×¨×¦×•× ×š ×œ×©××•×¨ ××™×§×•× ×¢× ×”××¡×¤×¨ ×”×©××•×¨: <b>${storedPhone}</b>?`;
            modalPhoneInput.value = storedPhone;
            modalPhoneInput.readOnly = true;
            btnChangePhone.classList.remove('hidden');
            btnPhoneOk.textContent = '×©××•×¨ ××™×§×•×';
            btnPhoneOk.disabled = false;
        } else {
            // ××¦×‘: ×‘×§×©×ª ×˜×œ×¤×•×Ÿ ×—×“×©
            modalTitle.textContent = '×”×›× ×¡ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ×©××™×¨×ª ××™×§×•× ×”×¨×›×‘';
            modalText.textContent = '×”×›× ×¡ ××ª ××¡×¤×¨ ×”×˜×œ×¤×•×Ÿ ×©×œ ×”× ×”×’ ×©××—× ×” ××ª ×”×¨×›×‘.';
            modalPhoneInput.value = storedPhone === '05' ? '05' : storedPhone;
            modalPhoneInput.readOnly = false;
            btnChangePhone.classList.add('hidden');
            btnPhoneOk.textContent = '×©××•×¨ ××™×§×•×';
            btnPhoneOk.disabled = !/^05\d{8}$/.test(normalizePhone(modalPhoneInput.value));
        }
        modalGpsStatus.textContent = '';
    }

    function openPhoneModal(){
      // ×˜×•×¢×Ÿ ××ª ×”××¦×‘ ×”××—×¨×•×Ÿ ×©×œ ×”×˜×œ×¤×•×Ÿ
      storedPhone = localStorage.getItem(LOCAL_PHONE_KEY) || '05';
      setPhoneMode(true); 

      modalOverlay.style.display = 'flex';
      
      // ××™×§×•×“ ×œ×©×“×” ×¨×§ ×× ×”×•× ×œ× ×œ×§×¨×™××” ×‘×œ×‘×“
      if (!modalPhoneInput.readOnly) {
          setTimeout(()=>{
            modalPhoneInput.focus();
            const len = modalPhoneInput.value.length;
            modalPhoneInput.setSelectionRange(len, len);
          }, 50);
      }
    }

    function closePhoneModal(){
      modalOverlay.style.display = 'none';
      modalGpsStatus.textContent = '';
    }

    btnPhoneCancel.addEventListener('click', ()=>{
      closePhoneModal();
    });
    
    // ×›×¤×ª×•×¨ "×©× ×”" ×‘××¡×š ×”×˜×œ×¤×•×Ÿ ×”×©××•×¨
    btnChangePhone.addEventListener('click', ()=>{
        setPhoneMode(false); // ××¢×‘×™×¨ ×œ××¦×‘ ×©×œ ×§×œ×˜ ×—×•×¤×©×™
        modalPhoneInput.focus();
    });

    // ×× ×§×” ×›×œ ×ª×• ×©××™× ×• ×¡×¤×¨×” + ×“×•××’ ×œ×ª×—×™×œ×™×ª 05
    function normalizePhone(value){
      let digits = (value || '').replace(/\D/g, '');
      if (!digits.startsWith('05')) {
        if (digits.startsWith('5')) {
          digits = '0' + digits;
        } else if (digits.length > 0) {
          // ×× ×¡×” ×œ×”×›× ×™×¡ 05 ×× ×”×•× ×œ× ×§×™×™×
          digits = '05' + digits.replace(/^0+/, '');
        } else {
          digits = '05';
        }
      }
      if (digits.length > 10) {
        digits = digits.slice(0,10);
      }
      return digits;
    }

    modalPhoneInput.addEventListener('input', ()=>{
      const cur = modalPhoneInput.value;
      const norm = normalizePhone(cur);
      
      if (cur !== norm) {
        const pos = norm.length;
        modalPhoneInput.value = norm;
        // ×× ×¡×” ×œ×©××•×¨ ×¢×œ ××™×§×•× ×”×¡××Ÿ
        modalPhoneInput.setSelectionRange(pos, pos);
      }
      
      // ××¤×¢×™×œ/××›×‘×” ××ª ×›×¤×ª×•×¨ ×”×©××™×¨×”
      btnPhoneOk.disabled = !/^05\d{8}$/.test(modalPhoneInput.value);
    });
    
    // ×›×¤×ª×•×¨ "×©××•×¨ ××™×§×•×" (×©×•××¨ ×˜×œ×¤×•×Ÿ ×•××ª×—×™×œ ×ª×”×œ×™×š GPS)
    btnPhoneOk.addEventListener('click', ()=>{
      let phone = normalizePhone(modalPhoneInput.value);
      modalPhoneInput.value = phone;

      // ×‘×“×™×§×”: ×‘×“×™×•×§ 10 ×¡×¤×¨×•×ª ×•××ª×—×™×œ ×‘-05
      if (!/^05\d{8}$/.test(phone)) {
        alert('×”××¡×¤×¨ ×©×”×•×–×Ÿ ×œ× ×ª×§×™×Ÿ');
        modalGpsStatus.textContent = '×”××¡×¤×¨ ×©×”×•×–×Ÿ ×œ× ×ª×§×™×Ÿ';
        return;
      }
      
      // **×©××™×¨×ª ×”×˜×œ×¤×•×Ÿ ×‘-localStorage:**
      storedPhone = phone;
      localStorage.setItem(LOCAL_PHONE_KEY, phone);
      // ×¢×“×›×•×Ÿ ×”××¦×‘ ×œ"×§×¨×™××” ×‘×œ×‘×“" ×¢× ×”×›×¤×ª×•×¨ "×©× ×”"
      setPhoneMode(true); 

      if (!navigator.geolocation) {
        statusText('×”××›×©×™×¨ ×œ× ×ª×•××š ×‘-GPS ×“×¨×š ×”×“×¤×“×¤×Ÿ.', true);
        modalGpsStatus.textContent = '×”××›×©×™×¨ ×œ× ×ª×•××š ×‘-GPS.';
        return;
      }

      // ×× ×˜×¨×œ ××ª ×›×¤×ª×•×¨ ×”×©××™×¨×” ×‘×–××Ÿ ×©×× ×—× ×• ××—×›×™× ×œ-GPS
      btnPhoneOk.disabled = true; 
      statusText('×˜×•×¢×Ÿ ××™×§×•×â€¦ ×× × ××©×¨ ×’×™×©×” ×œ-GPS.', false);
      modalGpsStatus.textContent = '×××ª×™×Ÿ ×œ××•×ª GPSâ€¦ ×× × ×”×™×©××¨ ×‘××¡×š ×”×–×”.';

      navigator.geolocation.getCurrentPosition(
        pos => {
          const lat = Number(pos.coords.latitude.toFixed(6));
          const lng = Number(pos.coords.longitude.toFixed(6));
          const now = new Date();

          const payload = {
            phone: phone,
            lat: lat,
            lng: lng,
            time: now.toISOString()
          };

          // ×§×•×“× ×©×•×œ×¤×™× ×¢×¨×š ×™×©×Ÿ ×›×“×™ ×œ×©××•×¨ ××•×ª×• ×›"previous"
          db.ref(LAST_NODE).once('value')
            .then(snap=>{
              const old = snap.val();
              let prev = null;
              if (old) {
                if (old.current) {
                  prev = old.current;
                } else if (typeof old.lat === "number") {
                  prev = old;
                }
              }
              const updateObj = {
                current: payload,
                previous: prev || null
              };
              return db.ref(LAST_NODE).set(updateObj).then(()=>{
                lastPlaceCurrent  = payload;
                lastPlacePrevious = prev || null;
              });
            })
            .then(()=>{
              renderLastPlace();
              updateMap();
              statusText('×”××™×§×•× × ×©××¨ !', false);
              modalGpsStatus.textContent = '×”××™×§×•× × ×©××¨ !';
              closePhoneModal();   // ×©×•××¨ ×•×œ× ×¤×•×ª×— ××¤×”
            })
            .catch(err=>{
              statusText('×©×’×™××” ×‘×©××™×¨×” ×‘×¤×™×™×¨×‘×™×™×¡: ' + err.message, true);
              modalGpsStatus.textContent = '×©×’×™××” ×‘×©××™×¨×” ×‘×¤×™×™×¨×‘×™×™×¡.';
            })
            .finally(()=>{
               btnPhoneOk.disabled = false; // ××—×–×™×¨ ××ª ×”×›×¤×ª×•×¨ ×œ×¤×¢×•×œ×”
            });
        },
        err => {
          statusText('×œ× ×”×¦×œ×—×ª×™ ×œ×§×‘×œ ××™×§×•×: ' + err.message, true);
          modalGpsStatus.textContent = '×©×’×™××” ×‘×§×‘×œ×ª GPS: ' + err.message;
          btnPhoneOk.disabled = false; // ××—×–×™×¨ ××ª ×”×›×¤×ª×•×¨ ×œ×¤×¢×•×œ×”
        },
        {
          enableHighAccuracy:true,
          timeout:15000,
          maximumAge:0
        }
      );
    });

    // ---- ×¡×˜×˜×•×¡ ×¢×œ×™×•×Ÿ ----
    function statusText(msg, isError){
      statusEl.textContent = msg || '';
      statusEl.className = 'status ' + (isError ? 'error' : 'ok');
    }

    // ---- ×¨×™× ×“×•×¨ ×”××™×§×•× ×”× ×•×›×—×™ + ×”×§×•×“× ----
    function renderLastPlace(){
      lastPlaceBox.innerHTML = '';

      if (!lastPlaceCurrent && !lastPlacePrevious){
        const div = document.createElement('div');
        div.style.fontSize = '0.9rem';
        div.style.opacity = '0.7';
        div.textContent = '×¢×“×™×™×Ÿ ×œ× × ×©××¨ ××™×§×•× ×œ×¨×›×‘.';
        lastPlaceBox.appendChild(div);
        return;
      }

      if (lastPlaceCurrent){
        lastPlaceBox.appendChild(createPlaceCard(lastPlaceCurrent,'××™×§×•× × ×•×›×—×™'));
      }
      if (lastPlacePrevious){
        lastPlaceBox.appendChild(createPlaceCard(lastPlacePrevious,'××™×§×•× ×§×•×“×'));
      }
    }

    function createPlaceCard(p, label){
      const card = document.createElement('div');
      card.className = 'place';

      const badge = document.createElement('div');
      badge.className = 'badge';
      badge.textContent = label;
      card.appendChild(badge);

      const top = document.createElement('div');
      top.className = 'place-top';

      const nameEl = document.createElement('div');
      nameEl.className = 'place-name';
      nameEl.textContent = ' ×˜×œ×¤×•×Ÿ × ×”×’ : ' + (p.phone || '×œ× ×™×“×•×¢');

      const timeEl = document.createElement('div');
      timeEl.className = 'place-time';

      const dt = new Date(p.time);
      if (!isNaN(dt.getTime())){
        const d  = String(dt.getDate()).padStart(2,'0');
        const m  = String(dt.getMonth()+1).padStart(2,'0');
        const y  = dt.getFullYear();
        const hh = String(dt.getHours()).padStart(2,'0');
        const mm = String(dt.getMinutes()).padStart(2,'0');
        timeEl.textContent = `${d}.${m}.${y}  ${hh}:${mm}`;
      } else {
        timeEl.textContent = '';
      }

      top.appendChild(nameEl);
      top.appendChild(timeEl);

      const bottom = document.createElement('div');
      bottom.className = 'place-bottom';

      const btnGroup = document.createElement('div');
      btnGroup.className = 'btn-group';

      const btnWaze = document.createElement('button');
      btnWaze.className = 'btn-mini btn-waze';
      btnWaze.textContent = 'Waze';
      btnWaze.addEventListener('click', ()=>{
        window.open(`https://waze.com/ul?ll=${p.lat},${p.lng}&navigate=yes`, '_blank');
      });

      const btnGMaps = document.createElement('button');
      btnGMaps.className = 'btn-mini btn-gmaps';
      btnGMaps.textContent = 'Maps';
      btnGMaps.addEventListener('click', ()=>{
        window.open(`http://maps.google.com/?q=${p.lat},${p.lng}`, '_blank');
      });

      btnGroup.appendChild(btnWaze);
      btnGroup.appendChild(btnGMaps);

      bottom.appendChild(btnGroup);

      card.appendChild(top);
      card.appendChild(bottom);

      return card;
    }

    // ---- ××¤×” ----
    function updateMap(){
      ensureMap();
      if (!map || !markerLayer) return;

      markerLayer.clearLayers();
      const points = [];

      if (lastPlaceCurrent){
        const llc = [lastPlaceCurrent.lat, lastPlaceCurrent.lng];
        points.push(llc);
        L.marker(llc).addTo(markerLayer).bindPopup('×”×¨×›×‘ â€“ ××™×§×•× × ×•×›×—×™');
      }
      if (lastPlacePrevious){
        const llp = [lastPlacePrevious.lat, lastPlacePrevious.lng];
        points.push(llp);
        L.marker(llp).addTo(markerLayer).bindPopup('××™×§×•× ×§×•×“×');
      }

      if (points.length === 0){
        map.setView([32.0853, 34.7818], 8);
      } else if (points.length === 1){
        map.setView(points[0], 16);
      } else {
        map.fitBounds(points, {padding:[20,20]});
      }
    }

    // ---- ×•×•××˜×¡××¤ ×œ× ×”×’ ×”××—×¨×•×Ÿ (××™×§×•× × ×•×›×—×™ ×‘×œ×‘×“) ----
    btnShareWhatsApp.addEventListener('click', function(){
      if (!lastPlaceCurrent || !lastPlaceCurrent.phone){
        statusText('××™×Ÿ ×˜×œ×¤×•×Ÿ × ×”×’ ××—×¨×•×Ÿ ×œ×©×™×ª×•×£ ×‘×•×•××˜×¡××¤.', true);
        return;
      }

      const digits = String(lastPlaceCurrent.phone).replace(/\D/g,'');
      if (!/^05\d{8}$/.test(digits)){
        statusText('××¡×¤×¨ ×”×˜×œ×¤×•×Ÿ ×”××—×¨×•×Ÿ ×©× ×©××¨ ××™× ×• ×ª×§×™×Ÿ.', true);
        return;
      }

      // ×œ×”××™×¨ ×œÖ¾972xxxxxxx (×‘×œ×™ ×”××¤×¡)
      const intl = '972' + digits.substring(1); // ××•×¨×™×“ 0 ×•××©××™×¨ 9 ×¡×¤×¨×•×ª
      const url  = 'https://wa.me/' + intl; // ×”×•×“×¢×” ×¨×™×§×” ×œ×—×œ×•×˜×™×Ÿ

      window.open(url, '_blank');
    });

  })();
</script>
</body>
</html>
