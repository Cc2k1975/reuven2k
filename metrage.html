<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<title>×©×¨×˜×•×˜ ×—×›× - ×¦×™×œ×•× â†’ ×–×™×”×•×™ ×¦×œ×¢×•×ª â†’ ×©×¨×˜×•×˜ ××“×•×™×§</title>

<script async src="https://docs.opencv.org/4.7.0/opencv.js" onload="__onCvScriptLoaded()"></script>

<style>
  :root{--bg:#f4f6f9;--card:#fff;--text:#111827;--muted:#6b7280;--primary:#2563eb;--danger:#dc2626;--line:#e5e7eb;}
  *{box-sizing:border-box}
  body{margin:0;padding:16px;font-family:system-ui,Arial;background:var(--bg);color:var(--text)}
  .wrap{max-width:980px;margin:0 auto}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:14px;box-shadow:0 10px 25px rgba(0,0,0,.08)}
  h2{margin:0 0 10px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .btn{width:100%;padding:14px 16px;border:0;border-radius:12px;background:var(--primary);color:#fff;font-size:18px;cursor:pointer}
  .btn:disabled{opacity:.55;cursor:not-allowed}
  .btn.secondary{background:#111827}
  .note{color:var(--muted);font-size:14px;margin-top:8px;line-height:1.45}
  video,canvas{width:100%;border-radius:12px;border:1px solid var(--line);background:#fff}
  .hidden{display:none}
  input{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;font-size:16px;margin-bottom:10px}
  .status{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;font-size:14px}
  .status.good{border-color:rgba(34,197,94,.35)}
  .status.bad{border-color:rgba(220,38,38,.35)}
</style>
</head>

<body>
<div class="wrap">

<div class="card">
<h2>1ï¸âƒ£ ×¦×™×œ×•× ×©×¨×˜×•×˜ (××¦×œ××” ××—×•×¨×™×ª)</h2>
<div id="statusBox" class="status">×˜×•×¢×Ÿâ€¦</div>
<div class="note">×”×›×¤×ª×•×¨ â€œ×¦×œ×â€ ×™×•×¤×¢×œ ×¨×§ ××—×¨×™ ×©×”××¦×œ××” ×•Ö¾OpenCV ××•×›× ×™×.</div>

<video id="video" autoplay playsinline></video>
<canvas id="photo" class="hidden"></canvas>

<div class="row" style="margin-top:12px">
<button id="btnShot" class="btn" disabled>ğŸ“¸ ×¦×œ×</button>
<button id="btnRestart" class="btn secondary">ğŸ”„ ××ª×—×œ ××¦×œ××”</button>
</div>
</div>

<div class="card hidden" id="previewCard">
<h2>2ï¸âƒ£ ×§×•×•×™× ××–×•×”×™× + ××¡×¤×•×¨ ×¦×œ×¢×•×ª</h2>
<canvas id="overlay"></canvas>
<div id="overlayInfo" class="note"></div>
</div>

<div class="card hidden" id="inputsCard">
<h2>3ï¸âƒ£ ×”×–×Ÿ ××™×“×•×ª (×‘×¡×´×)</h2>
<div id="inputs"></div>
<button id="btnBuild" class="btn">ğŸ“ ×‘× ×” ×©×¨×˜×•×˜ ×œ×¤×™ ×”××™×“×•×ª</button>
</div>

<div class="card hidden" id="resultCard">
<h2>4ï¸âƒ£ ×©×¨×˜×•×˜ ×¡×•×¤×™</h2>
<canvas id="result"></canvas>
<div id="report" class="note"></div>
</div>

</div>

<script>
const video=document.getElementById("video");
const photo=document.getElementById("photo");
const overlay=document.getElementById("overlay");
const resultCanvas=document.getElementById("result");
const statusBox=document.getElementById("statusBox");
const btnShot=document.getElementById("btnShot");
const btnRestart=document.getElementById("btnRestart");
const btnBuild=document.getElementById("btnBuild");

let stream=null, videoReady=false, cvReady=false;
let polyPts=[], edgeDirs=[], edgeCount=0;

function setStatus(m,t){statusBox.textContent=m;statusBox.className="status"+(t?" "+t:"")}
function updateBtn(){btnShot.disabled=!(videoReady&&cvReady)}

function __onCvScriptLoaded(){
  const i=setInterval(()=>{
    if(window.cv&&cv.Mat){cvReady=true;setStatus("OpenCV ××•×›×Ÿ","good");updateBtn();clearInterval(i)}
  },100)
}

async function startCamera(){
  if(stream)stream.getTracks().forEach(t=>t.stop());
  stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{exact:"environment"}}});
  video.srcObject=stream;
  await video.play();
  videoReady=true;
  setStatus("××¦×œ××” ××•×›× ×”","good");
  updateBtn();
}

function capture(){
  photo.width=video.videoWidth;
  photo.height=video.videoHeight;
  photo.getContext("2d").drawImage(video,0,0);
}

function buildFinal(){
  const vals=[...document.querySelectorAll("#inputs input")].map(i=>+i.value);
  let pts=[{x:0,y:0}],x=0,y=0;
  for(let i=0;i<vals.length;i++){
    x+=edgeDirs[i].dx*vals[i];
    y+=edgeDirs[i].dy*vals[i];
    pts.push({x,y});
  }

  const ctx=resultCanvas.getContext("2d");
  resultCanvas.width=900;resultCanvas.height=520;
  ctx.clearRect(0,0,900,520);

  const xs=pts.map(p=>p.x),ys=pts.map(p=>p.y);
  const minX=Math.min(...xs),maxX=Math.max(...xs);
  const minY=Math.min(...ys),maxY=Math.max(...ys);
  const s=Math.min((800)/(maxX-minX),(400)/(maxY-minY));
  const tx=p=>50+(p.x-minX)*s;
  const ty=p=>50+(p.y-minY)*s;

  ctx.strokeStyle="#2563eb";ctx.lineWidth=3;
  ctx.beginPath();
  ctx.moveTo(tx(pts[0]),ty(pts[0]));
  pts.slice(1).forEach(p=>ctx.lineTo(tx(p),ty(p)));
  ctx.closePath();ctx.stroke();

  ctx.fillStyle="#111";
  for(let i=0;i<vals.length;i++){
    const m={x:(pts[i].x+pts[i+1].x)/2,y:(pts[i].y+pts[i+1].y)/2};
    ctx.fillText(vals[i]+" ×¡\"×",tx(m),ty(m)-5);
  }

  let area=0;
  for(let i=0;i<pts.length-1;i++)
    area+=pts[i].x*pts[i+1].y-pts[i+1].x*pts[i].y;
  area=Math.abs(area)/2/10000;

  const per=vals.reduce((a,b)=>a+b,0);
  document.getElementById("report").textContent=
    `×”×™×§×£: ${per} ×¡×´× | ×©×˜×—: ${area.toFixed(2)} ××´×¨`;

  document.getElementById("resultCard").classList.remove("hidden");
}

btnShot.onclick=()=>{capture();document.getElementById("previewCard").classList.remove("hidden")};
btnRestart.onclick=startCamera;
btnBuild.onclick=buildFinal;

startCamera();
</script>
</body>
</html>