<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>תפריט משפחתי</title>
<style>
:root {
  --cream: #fffaf0;
  --gold: #c59d2f;
  --green: #3c7a4c;
  --text: #333;
  --radius: 14px;
  --shadow: 0 4px 14px rgba(0,0,0,0.15);
}
body {
  background: var(--cream);
  font-family: "Heebo", Arial, sans-serif;
  margin: 0; padding: 0;
  color: var(--text);
  text-align: center;
}
.container {
  max-width: 600px;
  margin: 30px auto;
  background: white;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 24px;
}
h1 {
  color: var(--green);
  font-size: 38px;
  margin-bottom: 10px;
}
.section-title {
  font-size: 22px;
  color: var(--gold);
  border-bottom: 2px solid var(--gold);
  display: inline-block;
  margin: 30px 0 10px;
}
select {
  width: 100%;
  padding: 14px;
  margin-top: 8px;
  border-radius: var(--radius);
  border: 2px solid #ddd;
  font-size: 18px;
}
button {
  background: var(--green);
  color: white;
  border: none;
  border-radius: var(--radius);
  padding: 14px 30px;
  font-size: 20px;
  margin-top: 20px;
  cursor: pointer;
  box-shadow: var(--shadow);
}
button:hover { background: #2e5f3b; }
.footer {
  margin-top: 40px;
  font-size: 14px;
  color: #777;
}

/* פופאפ */
.popup-bg {
  position: fixed;
  top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,0.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
.popup {
  background: var(--cream);
  padding: 30px;
  border-radius: var(--radius);
  text-align: center;
  max-width: 420px;
  box-shadow: var(--shadow);
  animation: pop 0.3s ease-out;
}
@keyframes pop {
  from {transform: scale(0.8); opacity:0;}
  to {transform: scale(1); opacity:1;}
}
.popup h2 {
  color: var(--green);
  margin-bottom: 12px;
}
.popup p {
  margin: 6px 0;
  font-size: 18px;
}
.popup span.emoji {
  margin-left: 6px;
  font-size: 22px;
}
</style>
</head>
<body>
<div class="container">
  <h1 id="welcome">טעינה...</h1>
  <form id="foodForm">
    <div class="section">
      <div class="section-title">מנה בשרית</div>
      <select id="meat" required>
        <option disabled selected value>בחר מנה</option>
        <option>שניצלים</option>
        <option>עוף בתנור</option>
        <option>קציצות בקר</option>
        <option>כנפיים בצ’ילי</option>
      </select>

      <div class="section-title">פחמימה</div>
      <select id="carb" required>
        <option disabled selected value>בחר פחמימה</option>
        <option>אורז לבן</option>
        <option>פירה</option>
        <option>תפוחי אדמה בתנור</option>
        <option>קוסקוס</option>
      </select>

      <div class="section-title">סלט 1</div>
      <select id="salad1" required>
        <option disabled selected value>בחר סלט</option>
        <option>חומוס</option>
        <option>טחינה</option>
        <option>כרוב</option>
        <option>סלט חי</option>
      </select>

      <div class="section-title">סלט 2</div>
      <select id="salad2" required>
        <option disabled selected value>בחר סלט נוסף</option>
        <option>כרובית בטחינה</option>
        <option>חציל במיונז</option>
        <option>פלפל מתוק</option>
        <option>אבוקדו</option>
      </select>

      <div class="section-title">שתייה</div>
      <select id="drink" required>
        <option disabled selected value>בחר שתייה</option>
        <option>קולה</option>
        <option>יין</option>
        <option>סודה</option>
        <option>בירה</option>
      </select>

      <div class="section-title">קינוח</div>
      <select id="dessert" required>
        <option disabled selected value>בחר קינוח</option>
        <option>עוגה</option>
        <option>גלידה</option>
      </select>
    </div>

    <button type="submit">שלח תפריט</button>
  </form>
  <div class="footer">גרסה: v1.0 · food.html</div>
</div>

<!-- פופאפ -->
<div class="popup-bg" id="popup-bg">
  <div class="popup" id="popup">
    <h2 id="popupTitle"></h2>
    <div id="popupContent"></div>
    <button onclick="closePopup()">סגור</button>
  </div>
</div>

<script>
const BIN_ID = "68ff447a43b1c97be9844c29";
const API_KEY = "$2a$10$4rynniEMuvwqg2nDb5KSEe/lAVYp8a7L3xWzp9GsO6n49OfXc3FCO";
const API_URL = "https://api.jsonbin.io/v3/b";

// --- זיהוי משתמש ---
const urlParams = new URLSearchParams(window.location.search);
const user = urlParams.get("user") || "אורח";
const welcome = document.getElementById("welcome");
welcome.textContent = (user === "אדמו" ? "ברוך הבא " : "ברוכה הבאה ") + user;

// --- טעינת פריטים שכבר נבחרו ---
let usedItems = [];

async function loadUsedItems(){
  try{
    const res = await fetch(`${API_URL}/${BIN_ID}/latest`, {
      headers: {"X-Access-Key": API_KEY}
    });
    const data = await res.json();
    const records = data.record?.בחירות || [];
    usedItems = records.map(r => Object.values(r)).flat();
    updateSelects();
  }catch(e){console.error(e);}
}

function updateSelects(){
  document.querySelectorAll("select").forEach(sel=>{
    for(let opt of sel.options){
      if(usedItems.includes(opt.textContent)){
        opt.disabled = true;
        opt.style.color = "#aaa";
      }
    }
  });
}

// --- שליחה ---
document.getElementById("foodForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const choice = {
    שם: user,
    מנה: meat.value,
    פחמימה: carb.value,
    סלט1: salad1.value,
    סלט2: salad2.value,
    שתייה: drink.value,
    קינוח: dessert.value
  };

  // שליפה מהשרת, עדכון ושליחה חזרה
  const res = await fetch(`${API_URL}/${BIN_ID}/latest`, {
    headers: {"X-Access-Key": API_KEY}
  });
  const data = await res.json();
  const records = data.record?.בחירות || [];
  records.push(choice);
  await fetch(`${API_URL}/${BIN_ID}`, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      "X-Access-Key": API_KEY
    },
    body: JSON.stringify({ "בחירות": records })
  });

  showPopup(choice);
});

function showPopup(choice){
  const popupBG = document.getElementById("popup-bg");
  const popupTitle = document.getElementById("popupTitle");
  const popupContent = document.getElementById("popupContent");

  popupTitle.textContent = user + " בחר:";
  popupContent.innerHTML = `
    <p><span class='emoji'>🍗</span>מנה: ${choice.מנה}</p>
    <p><span class='emoji'>🍚</span>פחמימה: ${choice.פחמימה}</p>
    <p><span class='emoji'>🥗</span>סלט 1: ${choice.סלט1}</p>
    <p><span class='emoji'>🥗</span>סלט 2: ${choice.סלט2}</p>
    <p><span class='emoji'>🥤</span>שתייה: ${choice.שתייה}</p>
    <p><span class='emoji'>🍰</span>קינוח: ${choice.קינוח}</p>
  `;
  popupBG.style.display = "flex";
}

function closePopup(){
  document.getElementById("popup-bg").style.display = "none";
}

loadUsedItems();
</script>
</body>
</html>

