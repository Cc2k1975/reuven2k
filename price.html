<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>×¡×•×¨×§ ××—×™×¨×™×</title>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      width: 100%;
      height: 100%;
      background: #101827;
      color: #f9fafb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Heebo", Arial, sans-serif;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 12px;
    }

    .wrapper {
      width: 100%;
      max-width: 480px;
      margin-top: 8px;
    }

    h1 {
      font-size: 20px;
      text-align: center;
      margin-bottom: 10px;
    }

    /* ğŸ”¹ ×—×œ×•×Ÿ ××¦×œ××” ×§×˜×Ÿ ×”×¨×‘×” ×™×•×ª×¨ */
    .camera-box {
      position: relative;
      width: 70%;           /* ×§×˜×Ÿ ×™×•×ª×¨ */
      max-width: 220px;     /* ×’×•×“×œ ××§×¡×™××œ×™ */
      aspect-ratio: 1 / 1;
      background: #020617;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.4);
      margin: 0 auto;       /* ××¨×›×– */
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      /* âŒ ×‘×™×˜×œ×ª×™ ××ª ×”××¨××” â€“ ××™×Ÿ scaleX(-1) */
    }

    .overlay-frame {
      position: absolute;
      inset: 15%;
      border-radius: 12px;
      border: 2px solid rgba(248, 250, 252, 0.85);
      box-shadow: 0 0 0 9999px rgba(15, 23, 42, 0.45);
      pointer-events: none;
    }

    .info {
      font-size: 13px;
      color: #cbd5f5;
      margin-top: 6px;
      text-align: center;
    }

    #status {
      margin-top: 6px;
      font-size: 13px;
      text-align: center;
      min-height: 18px;
      color: #e5e7eb;
    }

    .btn-row {
      margin-top: 10px;
      display: flex;
      justify-content: center;
    }

    button {
      padding: 10px 18px;
      font-size: 16px;
      border-radius: 999px;
      border: none;
      background: #22c55e;
      color: #022c22;
      font-weight: 600;
      box-shadow: 0 8px 18px rgba(34, 197, 94, 0.35);
      cursor: pointer;
      min-width: 180px;
    }

    button:active {
      transform: translateY(1px);
      box-shadow: 0 4px 10px rgba(34, 197, 94, 0.4);
    }

    .list-box {
      margin-top: 14px;
      background: #020617;
      border-radius: 14px;
      padding: 10px;
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .list-header {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      margin-bottom: 6px;
      color: #e5e7eb;
    }

    ul {
      list-style: none;
      max-height: 220px;
      overflow-y: auto;
    }

    li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      padding: 4px 0;
      border-bottom: 1px solid rgba(51, 65, 85, 0.6);
      font-size: 14px;
    }

    li:last-child {
      border-bottom: none;
    }

    .item-label {
      flex: 1;
    }

    .item-price {
      min-width: 70px;
      text-align: left;
    }

    /* ğŸ”´ ×›×¤×ª×•×¨ ××—×™×§×” ×§×˜×Ÿ ×•××“×•× */
    .delete-btn {
      border: none;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      background: #ef4444;
      color: #fef2f2;
      cursor: pointer;
      flex-shrink: 0;
    }

    .delete-btn:active {
      transform: translateY(1px);
    }

    .total-row {
      margin-top: 8px;
      padding-top: 6px;
      border-top: 1px solid rgba(148, 163, 184, 0.7);
      display: flex;
      justify-content: space-between;
      font-weight: 700;
      font-size: 16px;
    }

    .total-label {
      color: #e5e7eb;
    }

    .total-value {
      color: #22c55e;
    }

    /* ×§× ×‘×¡ × ×¡×ª×¨ ×œ×œ×›×™×“×ª ×”×ª××•× ×” */
    #captureCanvas {
      display: none;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <h1>×¡×•×¨×§ ××—×™×¨×™× ×¤×©×•×˜</h1>

    <div class="camera-box">
      <video id="video" autoplay playsinline></video>
      <div class="overlay-frame"></div>
    </div>

    <div class="info">
      ×›×•×•×Ÿ ××ª ××“×‘×§×ª ×”××—×™×¨ ×œ××¨×›×– ×”×¨×™×‘×•×¢ ×•×œ×—×¥ ×¢×œ "×”×•×¡×£ ××•×¦×¨".
    </div>
    <div id="status"></div>

    <div class="btn-row">
      <button id="addBtn">×”×•×¡×£ ××•×¦×¨</button>
    </div>

    <div class="list-box">
      <div class="list-header">
        <span>××•×¦×¨</span>
        <span>××—×™×¨ (â‚ª)</span>
      </div>
      <ul id="itemsList"></ul>
      <div class="total-row">
        <span class="total-label">×¡×”×´×›:</span>
        <span class="total-value" id="totalPrice">0.00</span>
      </div>
    </div>
  </div>

  <!-- ×§× ×‘×¡ × ×¡×ª×¨ ×œ×œ×›×™×“×ª ×ª××•× ×” ××”×¨×™×‘×•×¢ -->
  <canvas id="captureCanvas"></canvas>

  <!-- Tesseract.js ×œ×–×™×”×•×™ ×˜×§×¡×˜ ××”×ª××•× ×” -->
  <script src="https://unpkg.com/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
  <script>
    const video = document.getElementById('video');
    const addBtn = document.getElementById('addBtn');
    const statusEl = document.getElementById('status');
    const itemsList = document.getElementById('itemsList');
    const totalPriceEl = document.getElementById('totalPrice');
    const captureCanvas = document.getElementById('captureCanvas');

    const prices = [];

    // ×”×¤×¢×œ×ª ×”××¦×œ××” (××¦×œ××” ××—×•×¨×™×ª ×× ××¤×©×¨)
    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: 'environment' } },
          audio: false
        });
        video.srcObject = stream;
        statusEl.textContent = '×”××¦×œ××” ×¤×•×¢×œ×ª. ×›×•×•×Ÿ ××ª ××“×‘×§×ª ×”××—×™×¨ ×œ×¨×™×‘×•×¢.';
      } catch (err) {
        statusEl.textContent = '×œ× ×”×¦×œ×—×ª×™ ×œ×”×¤×¢×™×œ ××¦×œ××”: ' + err.message;
      }
    }

    // ×¤×•× ×§×¦×™×” ×œ×—×™×œ×•×¥ ×”××—×™×¨ ××”×˜×§×¡×˜
    function extractPriceFromText(text) {
      if (!text) return null;

      text = text.replace(/\s+/g, ' ');

      const matches = text.match(/(\d{1,3}(?:[.,]\d{1,2})?)/g);
      if (!matches) return null;

      const nums = matches
        .map(str => parseFloat(str.replace(',', '.')))
        .filter(n => !isNaN(n) && n > 0 && n < 500);

      if (!nums.length) return null;

      const price = Math.max(...nums);
      return price;
    }

    // ×¨×¢× ×•×Ÿ ×¨×©×™××ª ×”××•×¦×¨×™× ×•×”×¡×›×•×
    function renderList() {
      itemsList.innerHTML = '';
      let total = 0;

      prices.forEach((price, index) => {
        total += price;

        const li = document.createElement('li');

        const labelSpan = document.createElement('span');
        labelSpan.className = 'item-label';
        labelSpan.textContent = '××•×¦×¨ ' + (index + 1);

        const priceSpan = document.createElement('span');
        priceSpan.className = 'item-price';
        priceSpan.textContent = price.toFixed(2);

        const delBtn = document.createElement('button');
        delBtn.className = 'delete-btn';
        delBtn.textContent = '××—×§';
        delBtn.dataset.index = index.toString();

        li.appendChild(labelSpan);
        li.appendChild(priceSpan);
        li.appendChild(delBtn);

        itemsList.appendChild(li);
      });

      totalPriceEl.textContent = total.toFixed(2);
    }

    // ×¢×™×‘×•×“ ×œ×ª××•× ×” ×©×—×•×¨-×œ×‘×Ÿ + ×§×•× ×˜×¨×¡×˜
    function applyGrayscaleAndContrast(ctx, width, height) {
      const imageData = ctx.getImageData(0, 0, width, height);
      const data = imageData.data;
      const contrast = 1.3; // 1.0 ×‘×œ×™ ×©×™× ×•×™, 1.3 = ×§×¦×ª ×™×•×ª×¨ ×—×“

      for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];

        // Grayscale
        let gray = 0.299 * r + 0.587 * g + 0.114 * b;

        // Contrast ×¡×‘×™×‘ 128
        gray = (gray - 128) * contrast + 128;
        if (gray < 0) gray = 0;
        if (gray > 255) gray = 255;

        data[i] = data[i + 1] = data[i + 2] = gray;
      }

      ctx.putImageData(imageData, 0, 0);
    }

    // ×¦×™×œ×•× ××”×¨×™×‘×•×¢, OCR, ×”×•×¡×¤×ª ××—×™×¨
    async function handleAddProduct() {
      if (!video.videoWidth || !video.videoHeight) {
        statusEl.textContent = '××—×›×” ×©×”××¦×œ××” ×ª×¢×œ×”... × ×¡×” ×©×•×‘ ×¢×•×“ ×¨×’×¢.';
        return;
      }

      statusEl.textContent = '××–×”×” ××—×™×¨... ×–×” ×¢×©×•×™ ×œ×§×—×ª ×›××” ×©× ×™×•×ª.';

      const size = Math.min(video.videoWidth, video.videoHeight);
      const sx = (video.videoWidth - size) / 2;
      const sy = (video.videoHeight - size) / 2;

      captureCanvas.width = size;
      captureCanvas.height = size;
      const ctx = captureCanvas.getContext('2d');

      ctx.drawImage(video, sx, sy, size, size, 0, 0, size, size);

      // ğŸ”¹ ×”××¨×” ×œ×©×—×•×¨-×œ×‘×Ÿ + ×§×•× ×˜×¨×¡×˜ ×œ×¤× ×™ ×”-OCR
      applyGrayscaleAndContrast(ctx, size, size);

      try {
        const result = await Tesseract.recognize(captureCanvas, 'eng', {
          logger: () => {}
        });

        const rawText = result.data.text;
        const price = extractPriceFromText(rawText);

        if (price == null) {
          statusEl.textContent =
            '×œ× ×”×¦×œ×—×ª×™ ×œ××¦×•× ××—×™×¨ ×‘×¨×•×¨ ×‘×ª××•× ×”. × ×¡×” ×œ×”×ª×§×¨×‘ ×œ××“×‘×§×” ××• ×œ×©×¤×¨ ×ª××•×¨×”.';
          return;
        }

        prices.push(price);
        renderList();
        statusEl.textContent = '× ×•×¡×£ ××•×¦×¨: ' + price.toFixed(2) + ' â‚ª';
      } catch (err) {
        statusEl.textContent = '×©×’×™××” ×‘×–×™×”×•×™ ××—×™×¨: ' + err.message;
      }
    }

    // ××—×™×§×ª ××•×¦×¨ ×‘×•×“×“ â€“ ×”××–× ×” ×‘×¨××ª ×”×¨×©×™××”
    itemsList.addEventListener('click', (event) => {
      const target = event.target;
      if (target.classList.contains('delete-btn')) {
        const index = parseInt(target.dataset.index, 10);
        if (!isNaN(index)) {
          prices.splice(index, 1);
          renderList();
        }
      }
    });

    // ××™×¨×•×¢×™×
    window.addEventListener('load', startCamera);
    addBtn.addEventListener('click', handleAddProduct);
  </script>
</body>
</html>
