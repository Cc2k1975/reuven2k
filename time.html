<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Global Timer</title>

  <style>
    *{margin:0;padding:0;box-sizing:border-box;}

    html, body {
      width:100%;
      height:100%;
      overflow:hidden;
      background:#000;
      color:#fff;
      font-family:"Courier New", monospace;
    }

    body {
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
    }

    .wrapper {
      width:100%;
      max-width:800px;
      padding:20px;
    }

    #eventTitle {
      font-size:clamp(1.8rem,5vw,2.8rem);
      font-weight:900;
      margin-bottom:1rem;
      color:#ffffff;
      word-break:break-word;
    }

    #countdown {
      font-size:clamp(3rem,15vw,5rem);
      font-weight:900;
      letter-spacing:0.07em;
      direction:ltr;
      color:#00ff55;
      text-shadow:0 0 12px #00ff55,0 0 22px #009933;
    }

    .labels {
      margin-top:10px;
      font-size:clamp(1rem,4vw,1.4rem);
      font-weight:800;
      letter-spacing:0.3em;
    }

    /* כפתור סודי */
    #secretBtn {
      position:fixed;
      bottom:10px;
      right:10px;
      width:45px;
      height:45px;
      opacity:0;       /* לגרסה סופית 0. לבדיקות אפשר 0.2 */
      z-index:50;
    }

    /* חלון הגדרות */
    .overlay {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.65);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:100;
    }
    .overlay.active {display:flex;}

    .dialog {
      background:#111;
      padding:20px;
      border-radius:12px;
      width:90%;
      max-width:420px;
      color:#fff;
      text-align:right;
      box-shadow:0 20px 40px rgba(0,0,0,0.7);
      font-family:Arial,"Heebo",sans-serif;
    }

    .dialog h2 {margin-bottom:15px;font-size:1.2rem;}

    .field {margin-bottom:15px;}
    .field label {display:block;margin-bottom:5px;font-size:0.95rem;}
    .field input {
      width:100%;
      padding:10px;
      border:1px solid #555;
      border-radius:8px;
      background:#000;
      color:#fff;
      font-size:1rem;
    }

    .buttons {display:flex;justify-content:flex-end;gap:12px;margin-top:10px;}
    .btn {
      padding:9px 16px;
      border-radius:20px;
      cursor:pointer;
      border:1px solid #fff;
      font-size:0.9rem;
      font-weight:600;
    }
    .btn.secondary {background:#000;color:#fff;}
    .btn.primary {background:#00ff55;color:#000;}

    /* טקסט מצב קטן למטה */
    #statusLine {
      position:fixed;
      left:4px;
      bottom:4px;
      font-size:10px;
      color:#666;
      font-family:Arial, sans-serif;
      opacity:0.9;
    }
  </style>
</head>
<body>

<div class="wrapper">
  <div id="eventTitle">אין אירוע מוגדר</div>
  <div id="countdown">000:00:00:00:00</div>
  <div class="labels">D&nbsp;&nbsp;H&nbsp;&nbsp;M&nbsp;&nbsp;S</div>
</div>

<button id="secretBtn"></button>

<div class="overlay" id="overlay">
  <div class="dialog">
    <h2>הגדרת אירוע חדש</h2>

    <div class="field">
      <label>שם האירוע</label>
      <input id="eventNameInput" type="text">
    </div>

    <div class="field">
      <label>תאריך ושעה</label>
      <input id="eventTimeInput" type="datetime-local">
    </div>

    <div class="buttons">
      <button class="btn secondary" id="cancelBtn">ביטול</button>
      <button class="btn primary" id="saveBtn">שמור</button>
    </div>
  </div>
</div>

<div id="statusLine">global-timer v1.2.0</div>

<script type="module">
  /* --------- Firebase --------- */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import {
    getFirestore,
    doc,
    onSnapshot,
    setDoc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

  // קונפיגורציה של הפרויקט global-timer-b8bbd
  const firebaseConfig = {
    apiKey: "AIzaSyAuEBBZDPZnDtCAvlwuzUbNtbS3xjmTqls",
    authDomain: "global-timer-b8bbd.firebaseapp.com",
    projectId: "global-timer-b8bbd",
    storageBucket: "global-timer-b8bbd.appspot.com",
    messagingSenderId: "603463071136",
    appId: "1:603463071136:web:0269c3a8847a1fb3d81585",
    measurementId: "G-WWBL8XHPG8"
  };

  console.log("Global Timer v1.2.0 – starting…");

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  // אוסף + דוקומנט גלובליים
  const ref = doc(db, "globalTimer", "event");

  /* --------- אלמנטים --------- */
  const eventTitleEl   = document.getElementById("eventTitle");
  const countdownEl    = document.getElementById("countdown");
  const secretBtn      = document.getElementById("secretBtn");
  const overlay        = document.getElementById("overlay");
  const eventNameInput = document.getElementById("eventNameInput");
  const eventTimeInput = document.getElementById("eventTimeInput");
  const cancelBtn      = document.getElementById("cancelBtn");
  const saveBtn        = document.getElementById("saveBtn");
  const statusLine     = document.getElementById("statusLine");

  let targetTime = null;
  let timerId    = null;

  function setStatus(text, isError = false) {
    statusLine.textContent = `global-timer v1.2.0 – ${text}`;
    statusLine.style.color = isError ? "#ff5555" : "#666666";
  }

  /* --------- פונקציות --------- */
  function pad(n, size){
    let s = String(n);
    while (s.length < size) s = "0" + s;
    return s;
  }

  function updateTimer(){
    if (!targetTime){
      countdownEl.textContent = "000:00:00:00:00";
      return;
    }

    const now = Date.now();
    let diff = targetTime - now;
    if (diff < 0) diff = 0;

    const days    = Math.floor(diff / 86400000);
    const hours   = Math.floor((diff / 3600000) % 24);
    const minutes = Math.floor((diff / 60000) % 60);
    const seconds = Math.floor((diff / 1000) % 60);
    const millis  = Math.floor((diff % 1000) / 10); // שתי ספרות

    countdownEl.textContent =
      pad(days,3) + ":" +
      pad(hours,2) + ":" +
      pad(minutes,2) + ":" +
      pad(seconds,2) + ":" +
      pad(millis,2);
  }

  function startInterval(){
    if (timerId) clearInterval(timerId);
    timerId = setInterval(updateTimer, 10);
  }

  /* --------- מאזין ל-Firestore --------- */
  onSnapshot(ref, snap => {
    console.log("onSnapshot fired");
    const data = snap.data();
    console.log("Snapshot data:", data);

    if (!data || !data.timestamp){
      targetTime = null;
      eventTitleEl.textContent = "אין אירוע מוגדר";
      setStatus("אין נתונים בשרת");
      updateTimer();
      return;
    }

    targetTime = data.timestamp;
    eventTitleEl.textContent = data.name || "אירוע ללא שם";
    setStatus("נטען מהשרת בהצלחה");
    startInterval();
  }, err => {
    console.error("onSnapshot error:", err);
    setStatus("שגיאה בחיבור ל־Firestore", true);
  });

  /* --------- כפתור סודי + שמירה --------- */
  secretBtn.onclick = () => {
    overlay.classList.add("active");
    setStatus("מצב: עריכת אירוע");
    eventNameInput.focus();
  };

  cancelBtn.onclick = () => {
    overlay.classList.remove("active");
    setStatus("בוטל על ידי המשתמש");
  };

  saveBtn.onclick = async () => {
    const name = eventNameInput.value.trim();
    const d    = eventTimeInput.value;

    if (!d){
      alert("בחר תאריך ושעה");
      return;
    }

    const t = new Date(d);
    if (isNaN(t.getTime())){
      alert("תאריך לא תקין");
      return;
    }

    const payload = {
      name: name || "אירוע ללא שם",
      timestamp: t.getTime()
    };

    console.log("Trying to save to Firestore:", payload);
    setStatus("שומר לשרת…");
    saveBtn.disabled = true;
    saveBtn.textContent = "שומר…";

    try {
      // כתיבה לשרת
      await setDoc(ref, payload, { merge:true });

      // בדיקת נתונים אחרי כתיבה
      const checkSnap = await getDoc(ref);
      if (!checkSnap.exists()) {
        console.error("Verify after save – document missing");
        setStatus("שגיאה: המסמך לא נמצא אחרי שמירה", true);
        alert("שמירה נכשלה (מסמך לא נמצא אחרי שמירה).");
      } else {
        const saved = checkSnap.data();
        console.log("Verify after save – got:", saved);
        setStatus("נשמר לשרת בהצלחה");
        overlay.classList.remove("active");
      }
    } catch (err) {
      console.error("Error while saving to Firestore:", err);
      setStatus("שגיאה בשמירה לשרת", true);
      alert("שגיאה בשמירה לשרת: " + err.message);
    } finally {
      saveBtn.disabled = false;
      saveBtn.textContent = "שמור";
    }
  };

  // סגירת החלון בלחיצה מחוץ לדיאלוג
  overlay.onclick = e => {
    if (e.target === overlay) overlay.classList.remove("active");
  };
</script>

</body>
</html>
