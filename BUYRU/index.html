<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>POC – סורק מוצר ותמונה</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f7f7f7; --card:#fff; --text:#222; --muted:#666; --pri:#1f7aeb;
    --shadow:0 6px 24px rgba(0,0,0,.12); --radius:12px;
  }
  body{font-family:Heebo,system-ui,Arial;background:var(--bg);margin:0;padding:16px;color:var(--text)}
  .wrap{max-width:900px;margin:0 auto}
  h1{font-size:22px;margin:0 0 12px}
  video{width:100%;border-radius:var(--radius);box-shadow:var(--shadow);background:#000}
  .row{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;align-items:center}
  input[type="text"], select{flex:1;min-width:160px;padding:10px;border:1px solid #ccc;border-radius:8px;font-size:16px}
  button{padding:10px 14px;border:0;border-radius:10px;cursor:pointer;font-weight:600}
  .primary{background:var(--pri);color:#fff}
  .ghost{background:#eee}
  .card{margin-top:14px;background:var(--card);border-radius:var(--radius);box-shadow:0 4px 16px rgba(0,0,0,.08);padding:14px}
  .imgbox img{max-width:100%;border-radius:10px}
  .meta{font-size:14px;color:#555;margin-top:8px}
  .links a{display:inline-block;margin:6px 8px 0 0;color:var(--pri);text-decoration:none}
  .small{font-size:12px;color:#777;margin-top:6px}
  .banner{background:#fff3cd;border:1px solid #ffe08a;color:#6b5800;border-radius:10px;padding:10px;margin:10px 0}
  .foot{margin-top:20px;text-align:center;color:#888;font-size:12px}
  .ctrl{display:flex;gap:8px;align-items:center}
  .ctrl label{font-size:12px;color:#555}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;color:#555;word-break:break-all}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #eee;padding:8px 6px;font-size:14px}
  th{background:#fafafa;text-align:right;color:#444}
  td a{color:#1f7aeb;text-decoration:none}
  .actions button{padding:6px 10px;border-radius:8px}
</style>
</head>
<body>
<div class="wrap">
  <h1>POC – סורק מוצר ותמונה</h1>

  <div id="httpsWarn" class="banner" style="display:none">
    האתר נטען ללא HTTPS. גישת מצלמה בדפדפן דורשת <b>https://</b>.
    פתח דרך: <a id="httpsLink" href="#">קישור מאובטח</a>
  </div>

  <video id="preview" playsinline muted autoplay></video>

  <div class="row">
    <select id="cameraSel" title="בחר מצלמה"></select>
    <div class="ctrl">
      <button class="ghost" id="btnTorch" disabled>פנס כבוי</button>
      <label for="zoomRange">זום</label>
      <input type="range" id="zoomRange" min="1" max="5" step="0.1" value="1" disabled style="width:140px">
    </div>
  </div>

  <div class="row">
    <button class="primary" id="btnStart">הפעל סריקה</button>
    <button class="ghost" id="btnStop" disabled>עצור</button>
    <input id="manual" type="text" placeholder="או הזן ידנית ברקוד (GTIN/UPC/EAN)..." />
    <button class="ghost" id="btnLookup">חפש תמונה</button>
  </div>

  <div class="card" id="status">מוכן לסריקה.</div>

  <div class="card imgbox" id="imgBox" style="display:none">
    <div class="meta" id="codeMeta"></div>
    <img id="imgProduct" alt="תמונת מוצר" />
    <div class="links" id="links"></div>
    <div class="small">
      מקורות: Open Food/Beauty/Products Facts (ציבוריים) ורמי-לוי (לבדיקת התכנות). ייתכנו חסימות/שינויי URL.
    </div>
  </div>

  <!-- היסטוריה ללא כפילויות + ייצוא -->
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="meta">היסטוריית סריקות (נשמר מקומית, ללא כפילויות)</div>
      <div class="actions">
        <button class="ghost" id="btnExportCSV">ייצוא CSV (UTF-8+BOM)</button>
        <button class="ghost" id="btnExportTSV">ייצוא TSV</button>
        <button class="ghost" id="btnClear">נקה הכל</button>
      </div>
    </div>
    <div style="overflow:auto">
      <table id="historyTbl">
        <thead>
          <tr><th>ברקוד</th><th>תמונה (URL)</th><th>נוצר</th><th>עודכן</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="mono" id="diag"></div>
  </div>

  <div class="foot">v1.4.0 – BUYRU</div>
</div>

<!-- ZXing UMD הגלובלי: האובייקט הוא ZXingBrowser -->
<script src="https://unpkg.com/@zxing/browser@0.1.1"></script>
<script>
  const statusEl = document.getElementById('status');
  const diagEl   = document.getElementById('diag');
  const imgBox = document.getElementById('imgBox');
  const imgEl = document.getElementById('imgProduct');
  const codeMeta = document.getElementById('codeMeta');
  const linksEl = document.getElementById('links');
  const preview = document.getElementById('preview');
  const btnStart = document.getElementById('btnStart');
  const btnStop  = document.getElementById('btnStop');
  const btnLookup= document.getElementById('btnLookup');
  const manual   = document.getElementById('manual');
  const cameraSel= document.getElementById('cameraSel');
  const btnTorch = document.getElementById('btnTorch');
  const zoomRange= document.getElementById('zoomRange');

  const btnExportCSV = document.getElementById('btnExportCSV');
  const btnExportTSV = document.getElementById('btnExportTSV');
  const btnClear     = document.getElementById('btnClear');
  const tblBody      = document.querySelector('#historyTbl tbody');

  const httpsWarn = document.getElementById('httpsWarn');
  const httpsLink = document.getElementById('httpsLink');

  let reader = null;
  let currentStream = null;
  let currentTrack = null;
  let lastCode = '';
  let torchOn = false;

  // --- אחסון מקומי ללא כפילויות ---
  const LS_KEY = 'buyru_history_v1';
  function loadHistory(){
    try{ return JSON.parse(localStorage.getItem(LS_KEY) || '{}'); }catch{ return {}; }
  }
  function saveHistory(mapObj){
    localStorage.setItem(LS_KEY, JSON.stringify(mapObj));
  }
  function upsertHistory(code, imgUrl){
    const m = loadHistory();
    const now = new Date().toISOString();
    if(m[code]){
      m[code].img = imgUrl || m[code].img || '';
      m[code].updated = now;
    }else{
      m[code] = { code, img: imgUrl || '', created: now, updated: now };
    }
    saveHistory(m);
    renderHistory();
  }
  function clearHistory(){ localStorage.removeItem(LS_KEY); renderHistory(); }
  function renderHistory(){
    const m = loadHistory();
    const rows = Object.values(m).sort((a,b)=> (b.updated||'').localeCompare(a.updated||''));
    tblBody.innerHTML = rows.map(r => `
      <tr>
        <td>${escapeHTML(r.code||'')}</td>
        <td>${r.img? `<a href="${r.img}" target="_blank" rel="noopener">${shorten(r.img)}</a>`:''}</td>
        <td>${fmtDate(r.created)}</td>
        <td>${fmtDate(r.updated)}</td>
      </tr>
    `).join('');
  }
  function fmtDate(s){ if(!s) return ''; try{ const d=new Date(s); return d.toLocaleString(); }catch{ return s; } }
  function escapeHTML(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]); }
  function shorten(u){ return (u||'').length>60 ? u.slice(0,30)+'…'+u.slice(-20) : u; }

  // --- HTTPS banner ---
  (function ensureHttpsBanner(){
    const isLocalhost = /^(localhost|127\.0\.0\.1)$/.test(location.hostname);
    if (location.protocol !== 'https:' && !isLocalhost){
      httpsWarn.style.display = 'block';
      httpsLink.href = 'https://' + location.host + location.pathname;
    }
  })();

  function setStatus(msg){ statusEl.textContent = msg; }
  function log(msg){ diagEl.textContent += (diagEl.textContent ? '\n' : '') + msg; }

  // נתיב Open*Facts (בלוקים של 3 ספרות)
  function gtinToPath(code){
    const clean = (code || '').replace(/\D/g,'');
    const parts = [];
    for(let i=0;i<clean.length;i+=3) parts.push(clean.slice(i,i+3));
    return parts.join('/');
  }

  function openFactsCandidates(code){
    const base = [
      'https://images.openfoodfacts.org/images/products/',
      'https://images.openbeautyfacts.org/images/products/',
      'https://images.openproductsfacts.org/images/products/'
    ];
    const path = gtinToPath(code);
    return [
      `${base[0]}${path}/front.400.jpg`,
      `${base[0]}${path}/front.jpg`,
      `${base[1]}${path}/front.400.jpg`,
      `${base[1]}${path}/front.jpg`,
      `${base[2]}${path}/front.400.jpg`,
      `${base[2]}${path}/front.jpg`,
    ];
  }
  function ramiLevyCandidates(code){
    const base = `https://img.rami-levy.co.il/product/${code}`;
    return [
      `${base}/small.jpg`,
      `${base}/large.jpg`,
      `https://www.rami-levy.co.il/_ipx/w_500,f_webp/${base}/small.jpg`,
      `https://www.rami-levy.co.il/_ipx/w_800,f_webp/${base}/large.jpg`,
    ];
  }
  function firstWorkingImage(urls){
    return new Promise((resolve) => {
      let i = 0;
      function next(){
        if(i >= urls.length) return resolve(null);
        const url = urls[i++];
        const img = new Image();
        img.onload = ()=> resolve(url);
        img.onerror= ()=> next();
        img.src = url + `?t=${Date.now()}`;
      }
      next();
    });
  }
  async function tryLoadImageFor(code){
    const candidates = [
      ...openFactsCandidates(code),
      ...ramiLevyCandidates(code),
    ];
    return await firstWorkingImage(candidates);
  }

  async function showByCode(code){
    if(!code){ setStatus('לא הוזן ברקוד.'); return; }
    lastCode = code.replace(/\s/g,'');
    setStatus(`מחפש תמונה לברקוד: ${lastCode} ...`);
    imgBox.style.display='none';
    imgEl.src=''; linksEl.innerHTML='';

    const url = await tryLoadImageFor(lastCode);

    if(url){
      codeMeta.textContent = `ברקוד: ${lastCode}`;
      imgEl.src = url;
      imgBox.style.display='block';
      setStatus('נמצאה תמונה.');
    }else{
      codeMeta.textContent = `ברקוד: ${lastCode}`;
      imgEl.removeAttribute('src');
      imgBox.style.display='block';
      setStatus('לא נמצאה תמונה במקורות הנ״ל.');
    }

    // עדכון היסטוריה ללא כפילויות
    upsertHistory(lastCode, url || '');

    // קישורי עזרה/חנויות
    linksEl.innerHTML = [
      link('חיפוש בגוגל תמונות', `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(lastCode)}`),
      link('שופרסל – חיפוש', `https://www.shufersal.co.il/online/he/search?text=${encodeURIComponent(lastCode)}`),
      link('רמי לוי – חיפוש', `https://www.rami-levy.co.il/he/Search?search=${encodeURIComponent(lastCode)}`)
    ].join(' ');
  }
  function link(txt, href){ return `<a target="_blank" rel="noopener" href="${href}">${txt}</a>`; }

  // --- מצלמות זמינות + מילוי select ---
  async function listVideoInputsSafe(){
    let devices = [];
    try {
      if (window.ZXingBrowser?.BrowserCodeReader?.listVideoInputDevices) {
        devices = await window.ZXingBrowser.BrowserCodeReader.listVideoInputDevices();
      } else if (window.ZXingBrowser?.BrowserMultiFormatReader?.listVideoInputDevices) {
        devices = await window.ZXingBrowser.BrowserMultiFormatReader.listVideoInputDevices();
      }
    } catch (e) {
      log('ZXingBrowser listVideoInputDevices failed, fallback to enumerateDevices');
    }
    if (!devices.length && navigator.mediaDevices?.enumerateDevices) {
      const all = await navigator.mediaDevices.enumerateDevices();
      devices = all.filter(d => d.kind === 'videoinput');
    }
    return devices;
  }
  function preferBackCamera(devices){
    const backs = devices.filter(d => /back|rear|environment/i.test(d.label || ''));
    return backs.length ? backs[backs.length - 1] : devices[0];
  }
  async function populateCameraSelect(){
    const devices = await listVideoInputsSafe();
    cameraSel.innerHTML = '';
    devices.forEach((d, idx) => {
      const opt = document.createElement('option');
      opt.value = d.deviceId || d.id || String(idx);
      opt.textContent = (d.label || `camera ${idx}`) + (/(back|rear|environment)/i.test(d.label || '')?' (אחורית)':'');
      cameraSel.appendChild(opt);
    });
    const pref = preferBackCamera(devices);
    if(pref){
      cameraSel.value = pref.deviceId || pref.id || cameraSel.options[0]?.value;
    }
    log(`Video Inputs (${devices.length}):\n  ${devices.map((d,i)=>`[${i}] ${d.label || 'camera '+i} id=${d.deviceId||d.id||'n/a'}`).join('\n  ')}`);
  }

  async function applyZoom(value){
    if(!currentTrack) return;
    try{
      const caps = currentTrack.getCapabilities?.();
      if(caps?.zoom){
        await currentTrack.applyConstraints({ advanced:[{ zoom: Number(value) }] });
      }
    }catch(e){ /* ignore */ }
  }
  async function toggleTorch(){
    if(!currentTrack) return;
    try{
      const caps = currentTrack.getCapabilities?.();
      if(!caps?.torch){ return; }
      torchOn = !torchOn;
      await currentTrack.applyConstraints({ advanced:[{ torch: torchOn }] });
      btnTorch.textContent = torchOn ? 'פנס דלוק' : 'פנס כבוי';
    }catch(e){ /* ignore */ }
  }

  async function startScan(){
    try{
      await stopScan();

      const deviceId = cameraSel.value || undefined;
      const constraints = deviceId
        ? { video: { deviceId: { exact: deviceId }, width:{ideal:1280}, height:{ideal:720}, focusMode:{ideal:'continuous'} }, audio: false }
        : { video: { facingMode: { ideal: 'environment' }, width:{ideal:1280}, height:{ideal:720}, focusMode:{ideal:'continuous'} }, audio: false };

      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      currentStream = stream;
      preview.srcObject = stream;

      currentTrack = stream.getVideoTracks()[0] || null;

      btnTorch.disabled = true; zoomRange.disabled = true; torchOn = false;
      try{
        const caps = currentTrack?.getCapabilities?.();
        if(caps?.torch){ btnTorch.disabled = false; btnTorch.textContent = 'פנס כבוי'; }
        if(caps?.zoom){
          zoomRange.min = caps.zoom.min || 1;
          zoomRange.max = caps.zoom.max || 5;
          zoomRange.step= caps.zoom.step || 0.1;
          zoomRange.value = caps.zoom.min || 1;
          zoomRange.disabled = false;
        }
      }catch(e){}

      const Reader = window.ZXingBrowser.BrowserMultiFormatReader;
      reader = new Reader();
      setStatus('סורק... כוון את הברקוד אל המצלמה.');
      btnStart.disabled = true; btnStop.disabled = false;

      reader.decodeFromVideoDevice(deviceId || null, preview, (result) => {
        if(result){
          const code = (result.text || '').trim();
          if(code && code !== lastCode) showByCode(code);
        }
      });

    }catch(e){
      setStatus('כשל בהפעלת הסריקה: ' + e.message);
      btnStart.disabled = false; btnStop.disabled = true;
    }
  }
  async function stopScan(){
    try{
      if(reader){ reader.reset(); reader = null; }
      if(currentStream){ currentStream.getTracks().forEach(t => t.stop()); currentStream = null; }
      currentTrack = null; torchOn = false;
    }finally{
      btnStart.disabled = false; btnStop.disabled = true;
      btnTorch.disabled = true; zoomRange.disabled = true;
      setStatus('הסריקה נעצרה.');
    }
  }

  // --- ייצוא CSV/TSV ---
  function exportCSV(){
    const m = loadHistory();
    const rows = Object.values(m);
    const header = ['barcode','image_url','created','updated'];
    const data = [header].concat(rows.map(r => [
      r.code || '',
      r.img  || '',
      r.created || '',
      r.updated || ''
    ]));
    // יצירת CSV ב-UTF-8 עם BOM כדי למנוע ג׳יבריש
    const csv = data.map(cols => cols.map(csvEscape).join(',')).join('\r\n');
    const blob = new Blob(['\ufeff' + csv], {type:'text/csv;charset=utf-8;'});
    downloadBlob(blob, 'buyru_export.csv');
  }
  function exportTSV(){
    const m = loadHistory();
    const rows = Object.values(m);
    const header = ['barcode','image_url','created','updated'];
    const data = [header].concat(rows.map(r => [
      r.code || '',
      r.img  || '',
      r.created || '',
      r.updated || ''
    ]));
    const tsv = data.map(cols => cols.map(tsvEscape).join('\t')).join('\r\n');
    const blob = new Blob(['\ufeff' + tsv], {type:'text/tab-separated-values;charset=utf-8;'});
    downloadBlob(blob, 'buyru_export.tsv');
  }
  function csvEscape(s){
    s = String(s ?? '');
    return /[",\r\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  }
  function tsvEscape(s){
    s = String(s ?? '');
    return s.replace(/\t/g,' ').replace(/\r?\n/g,' ');
  }
  function downloadBlob(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  // אירועים
  btnStart.addEventListener('click', startScan);
  btnStop .addEventListener('click', stopScan);
  btnLookup.addEventListener('click', ()=> showByCode(manual.value));
  manual.addEventListener('keydown', (e)=>{ if(e.key==='Enter') showByCode(manual.value); });
  btnTorch.addEventListener('click', toggleTorch);
  zoomRange.addEventListener('input', (e)=> applyZoom(e.target.value));
  cameraSel.addEventListener('change', startScan);
  btnExportCSV.addEventListener('click', exportCSV);
  btnExportTSV.addEventListener('click', exportTSV);
  btnClear.addEventListener('click', ()=>{ if(confirm('למחוק את כל ההיסטוריה?')) clearHistory(); });

  // init
  (async ()=> {
    renderHistory();
    try{
      const isLocalhost = /^(localhost|127\.0\.0\.1)$/.test(location.hostname);
      if (location.protocol === 'https:' || isLocalhost){
        await navigator.mediaDevices.getUserMedia({video:true});
        await populateCameraSelect();
        setStatus('מוכן – בחר מצלמה ולחץ "הפעל סריקה".');
      } else {
        setStatus('פתח את הדף ב-HTTPS כדי להפעיל מצלמה.');
      }
    }catch{
      await populateCameraSelect();
      setStatus('אשר גישה למצלמה ואז לחץ "הפעל סריקה".');
    }
  })();
</script>
</body>
</html>
