<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>מקובע למקום</title>
  <style>
    body {
      margin: 0; padding: 0;
      height: 100vh; display: flex; flex-direction: column;
      overflow: hidden; font-family: Arial, sans-serif;
      background: #fff; /* רקע לבן */
    }

    /* הגובה של החלון שרואים */
    :root { --boxH: 320px; }

    #view-container {
      position: relative;
      width: 100%;
      height: var(--boxH);
      background: #fff;
      overflow: hidden;
      border-bottom: 2px solid #333;
      flex-shrink: 0;
      z-index: 1;
    }

    iframe {
      position: absolute;
      width: 1200px;
      height: 1500px;
      border: none;
      transform-origin: 0 0;
      /* ברירת מחדל כדי שלא יקפוץ */
      top: -200px; 
      left: -200px;
      transform: scale(0.6);
      will-change: transform, top, left;
    }

    /* פס טעינה ירוק */
    #loader {
      position: absolute;
      bottom: 0; left: 0;
      height: 5px;
      background: #28a745;
      width: 0%;
      transition: width 1s linear;
      z-index: 10;
    }

    /* כפתור שמירה ירוק צף */
    #saveTopBtn {
      position: fixed;
      top: 15px; left: 15px; /* הזזתי לצד שמאל שיהיה נוח */
      z-index: 9999;
      background: #28a745;
      color: #fff;
      border: none;
      border-radius: 50px;
      padding: 10px 20px;
      font-size: 18px;
      font-weight: bold;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      cursor: pointer;
    }

    /* כפתור עריכה (גלגל שיניים) */
    #gearBtn {
      position: fixed;
      bottom: 20px; left: 20px;
      z-index: 9999;
      width: 50px; height: 50px;
      border-radius: 50%;
      background: rgba(200, 200, 200, 0.3);
      border: 1px solid #ccc;
      display: none; /* מוסתר בהתחלה */
      align-items: center; justify-content: center;
      font-size: 24px;
      cursor: pointer;
    }

    /* אזור הכפתורים למטה */
    #controls {
      flex: 1;
      background: #f8f9fa;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 10px;
      border-top: 1px solid #ddd;
    }

    .row { display: flex; gap: 20px; }

    button.ctrl {
      width: 60px; height: 60px;
      background: #fff; color: #333;
      border: 1px solid #ccc;
      border-radius: 12px;
      font-size: 24px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      cursor: pointer;
    }
    button.ctrl:active { background: #e9ecef; }

    button.small {
      width: auto; padding: 0 20px; height: 50px;
      font-size: 16px; font-weight: bold;
      border-radius: 12px; border: 1px solid #ccc;
      background: #fff; color: #333;
    }

    /* חלונית מספר משחק */
    #gameBar {
      width: 90%;
      background: #e9ecef;
      border-radius: 10px;
      padding: 8px;
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    #gameIdInput {
      flex: 1; height: 40px; border-radius: 8px; border: 1px solid #ccc;
      padding: 0 10px; font-size: 16px; text-align: center;
    }
    #gameSaveBtn {
      background: #007bff; color: white; border: none;
      border-radius: 8px; padding: 0 15px; font-weight: bold;
    }

    /* מצב נעול - מסתיר הכל משאיר נקי */
    body.locked-view #controls { display: none !important; }
    body.locked-view #saveTopBtn { display: none !important; }
    body.locked-view #gearBtn { display: flex !important; }
    body.locked-view { background: #fff !important; }
    
  </style>
</head>
<body>

  <button id="saveTopBtn">✅ שמור וקבע מיקום</button>
  
  <div id="gearBtn">⚙️</div>

  <div id="view-container">
    <iframe id="gameFrame" scrolling="no"></iframe>
    <div id="loader"></div>
  </div>

  <div id="controls">
    
    <div id="gameBar">
      <input id="gameIdInput" type="tel" placeholder="מספר משחק">
      <button id="gameSaveBtn">עדכן משחק</button>
    </div>

    <div style="color:#555; font-weight:bold; margin-bottom:5px;">כיוון תצוגה:</div>

    <button class="ctrl" onclick="move(0, 20)">⬆️</button>
    <div class="row">
      <button class="ctrl" onclick="move(-20, 0)">⬅️</button>
      <button class="ctrl" onclick="move(20, 0)">➡️</button>
    </div>
    <button class="ctrl" onclick="move(0, -20)">⬇️</button>

    <div class="row" style="margin-top: 10px;">
      <button class="small" onclick="zoom(-0.05)">זום -</button>
      <button class="small" onclick="zoom(0.05)">זום +</button>
    </div>

    <button class="small" onclick="resetSettings()" style="margin-top:10px; background:#ffebee; color:red; border-color:red;">איפוס מלא</button>
  </div>

<script>
  // --- הגדרות ---
  const DEFAULT_ID = "1066561";
  const BASE_URL = "https://www.football.org.il/leagues/games/game/?game_id=";
  
  // משתנים
  let posY = -200;
  let posX = -200;
  let scale = 0.6;
  
  // אלמנטים
  const iframe = document.getElementById('gameFrame');
  const loader = document.getElementById('loader');
  const saveBtn = document.getElementById('saveTopBtn');
  const gearBtn = document.getElementById('gearBtn');
  const controls = document.getElementById('controls');
  const gameInput = document.getElementById('gameIdInput');
  const gameBtn = document.getElementById('gameSaveBtn');

  // טעינת הגדרות מיידית - לפני שהכל עולה
  loadInitialSettings();

  function buildUrl() {
    let gid = localStorage.getItem('soccer_game_id') || DEFAULT_ID;
    gameInput.value = gid;
    return BASE_URL + gid;
  }

  // --- הפונקציה הכי חשובה: עדכון מיקום ---
  function updateView() {
    // אנחנו מפעילים את זה ישירות על ה-iframe
    const frame = document.getElementById('gameFrame');
    if(frame) {
      frame.style.top = posY + 'px';
      frame.style.left = posX + 'px';
      frame.style.transform = `scale(${scale})`;
    }
  }

  // תזוזה
  function move(x, y) {
    posX += x;
    posY += y;
    updateView();
  }
  
  function zoom(s) {
    scale += s;
    if (scale < 0.2) scale = 0.2;
    if (scale > 2.0) scale = 2.0;
    updateView();
  }

  // --- שמירה ונעילה ---
  function saveAndLock() {
    localStorage.setItem('soccer_y', posY);
    localStorage.setItem('soccer_x', posX);
    localStorage.setItem('soccer_scale', scale);
    localStorage.setItem('soccer_setup', 'true');
    
    document.body.classList.add('locked-view');
    // רענון כפוי כדי לוודא שהכל יושב טוב
    refreshIframe();
  }

  // חזרה לעריכה
  gearBtn.onclick = function() {
    document.body.classList.remove('locked-view');
  };

  // שמירת מספר משחק
  gameBtn.onclick = function() {
    let newId = gameInput.value.replace(/\D/g,''); // רק מספרים
    if(newId) {
      localStorage.setItem('soccer_game_id', newId);
      refreshIframe(); // טוען מחדש עם המשחק החדש
    }
  };

  function resetSettings() {
    localStorage.clear();
    location.reload();
  }

  // --- מנגנון רענון חכם ---
  function refreshIframe() {
    const oldFrame = document.getElementById('gameFrame');
    const newFrame = document.createElement('iframe');
    
    newFrame.id = 'gameFrame';
    newFrame.scrolling = 'no';
    
    // *** התיקון הגדול: הגדרת המיקום לפני שהדף נכנס למסך ***
    newFrame.style.top = posY + 'px';
    newFrame.style.left = posX + 'px';
    newFrame.style.transform = `scale(${scale})`;
    
    // טעינת הכתובת
    newFrame.src = buildUrl();
    
    // החלפה
    oldFrame.replaceWith(newFrame);
  }

  // --- טיימר רענון (רק כשנעול) ---
  let seconds = 0;
  setInterval(function() {
    // הפס מתקדם רק אם אנחנו במצב נעול
    if (document.body.classList.contains('locked-view')) {
      seconds++;
      loader.style.width = (seconds / 15 * 100) + "%";
      
      if (seconds >= 15) {
        refreshIframe();
        seconds = 0;
        loader.style.width = "0%";
      }
    } else {
      seconds = 0;
      loader.style.width = "0%";
    }
  }, 1000);

  // --- טעינה ראשונית מהזיכרון ---
  function loadInitialSettings() {
    const savedY = localStorage.getItem('soccer_y');
    const savedX = localStorage.getItem('soccer_x');
    const savedS = localStorage.getItem('soccer_scale');
    const isSetup = localStorage.getItem('soccer_setup');

    if (isSetup === 'true' && savedY) {
      posY = parseFloat(savedY);
      posX = parseFloat(savedX);
      scale = parseFloat(savedS);
      
      // נכנס ישר למצב נעול
      document.body.classList.add('locked-view');
    }
    
    // מפעיל את התצוגה הראשונית
    updateView();
    // טוען את ה-src הראשוני
    document.getElementById('gameFrame').src = buildUrl();
  }

</script>
</body>
</html>
