<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>×¦'××˜ ×¤×Ÿ ××§×¡×¤×¨×¡</title>
<style>
:root {
  --bg: #f0f2f5; --chat-bg: #ffffff; --bot-bubble: #e4e6eb; --bot-text: #050505;
  --user-bubble: #d4af37; --user-text: #000000; --accent: #d4af37; --border: #dddfe2; --radius: 20px;
}
body { margin: 0; background: var(--bg); font-family: 'Segoe UI', Tahoma, sans-serif; display: flex; justify-content: center; height: 100dvh; overflow: hidden; }
.chat-container { width: 100%; max-width: 500px; display: flex; flex-direction: column; background: var(--chat-bg); box-shadow: 0 2px 10px rgba(0,0,0,0.1); height: 100%; }

#startOverlay {
  position: fixed; inset: 0; background: #000; z-index: 100;
  display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--accent);
}
#startOverlay img { width: 150px; margin-bottom: 30px; }
.start-btn { 
  background: var(--accent); color: #000; border: 0; padding: 15px 40px; 
  border-radius: 50px; font-size: 22px; font-weight: bold; cursor: pointer;
}

.header { padding: 12px; padding-top: calc(10px + env(safe-area-inset-top)); background: #000; text-align: center; border-bottom: 2px solid var(--accent); z-index: 10; }
.header img { width: 70px; }
#chatBox { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; background-color: #f9f9f9; }
.msg { max-width: 85%; padding: 14px 18px; border-radius: var(--radius); line-height: 1.6; font-size: 20px; animation: popIn 0.3s ease forwards; word-wrap: break-word; }
.bot { align-self: flex-start; background: var(--bot-bubble); color: var(--bot-text); border-top-right-radius: 4px; font-weight: bold; }
.user { align-self: flex-end; background: var(--user-bubble); color: var(--user-text); border-top-left-radius: 4px; font-weight: 600; }
@keyframes popIn { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
.chat-buttons { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px; margin-bottom: 10px; }
.chat-btn { background: #fff; border: 2px solid var(--accent); color: #000; padding: 12px 20px; border-radius: 12px; font-size: 19px; font-weight: bold; cursor: pointer; }
.input-area { padding: 15px; padding-bottom: calc(60px + env(safe-area-inset-bottom)); background: #ffffff; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 12px; }
input { width: 100%; background: #f0f2f5; color: #1c1e21; border: 2px solid transparent; border-radius: 12px; padding: 16px; font-size: 20px; box-sizing: border-box; outline: none; }
button.main-send-btn { background: #000; color: var(--accent); border: 2px solid var(--accent); padding: 16px; border-radius: 12px; font-size: 20px; font-weight: bold; cursor: pointer; }
.typing { font-size: 14px; color: #65676b; padding: 5px 20px; font-style: italic; }
.hidden { display: none !important; }
</style>
</head>
<body>

<div id="startOverlay">
  <img src="https://reuven2k.com/exe.gif" alt="×¤×Ÿ ××§×¡×¤×¨×¡">
  <h1>×”×™×™, ×‘×•××™ × ×§×‘×¢ ×ª×•×¨!</h1>
  <button class="start-btn" onclick="initChat()">×‘×•××™ × ×ª×—×™×œ âœ¨</button>
</div>

<div class="chat-container">
  <div class="header"><img src="https://reuven2k.com/exe.gif" alt="×¤×Ÿ ××§×¡×¤×¨×¡"></div>
  <div id="chatBox"></div>
  <div id="typingIndicator" class="typing hidden">×¤×Ÿ ××§×¡×¤×¨×¡ ××§×œ×™×“×”...</div>
  <div class="input-area" id="inputZone">
    <div id="controlGroup"></div>
    <button id="mainBtn" class="main-send-btn">×”××©×š</button>
  </div>
</div>

<script>
const BIN_ID = '68f0e7bed0ea881f40a63b29';
const MASTER_KEY = '$2a$10$4rynniEMuvwqg2nDb5KSEe/lAVYp8a7L3xWzp9GsO6n49OfXc3FCO';
const BIN_URL = 'https://api.jsonbin.io/v3/b/' + BIN_ID;
const WAZE_URL = 'https://waze.com/ul?ll=33.003292%2C35.108864&navigate=yes';

const engToHeb = {'q':'/','w':'\'','e':'×§','r':'×¨','t':'×','y':'×˜','u':'×•','i':'×Ÿ','o':'×','p':'×¤','a':'×©','s':'×“','d':'×’','f':'×›','g':'×¢','h':'×™','j':'×—','k':'×œ','l':'×š',';':'×£','\'':'"','z':'×–','x':'×¡','c':'×‘','v':'×”','b':'× ','n':'×','m':'×¦',',':'×ª','.':'×¥','/':'.'};

const chatBox = document.getElementById("chatBox");
const controlGroup = document.getElementById("controlGroup");
const mainBtn = document.getElementById("mainBtn");
const inputZone = document.getElementById("inputZone");

let currentStep = 0, userData = {}, selectedDayLabel = "";

function speak(text) {
  if (!('speechSynthesis' in window)) return;
  let cleanText = text.replace(/[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu, '');
  
  // ×ª×™×§×•×Ÿ ×¤×•× ×˜×™ ××©×•×¤×¨
  let phoneticText = cleanText
    .replace(/×¤×Ÿ/g, "×¤Ö¶×Ÿ")
    .replace(/×œ×š/g, "×œÖ¸×šÖ°")
    .replace(/×¢×‘×•×¨×š/g, "×¢Ö²×‘×•Ö¼×¨Öµ×šÖ°")
    .replace(/×©×œ×š/g, "×©Ö¶××œÖ¸Ö¼×šÖ°")
    .replace(/×¨×•×¦×”/g, "×¨×•Ö¹×¦Ö¸×”");
  
  const utterance = new SpeechSynthesisUtterance(phoneticText);
  const voices = window.speechSynthesis.getVoices();
  const femaleVoice = voices.find(v => v.lang.includes('he') && (v.name.includes('Female') || v.name.includes('Carmit') || v.name.includes('Google')));
  if (femaleVoice) utterance.voice = femaleVoice;
  utterance.lang = 'he-IL'; utterance.rate = 0.95;
  window.speechSynthesis.speak(utterance);
}

window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();

const getFormattedDate = (daysToAdd) => {
  const d = new Date(); d.setDate(d.getDate() + daysToAdd);
  return d.toISOString().split('T')[0];
};

const steps = [
  { msg: "×”×™×™ , ×©× ×–××™×Ÿ ×ª×•×¨ ×œ×¤×Ÿ?\n×ª×‘×—×¨×™ ×œ××˜×” ××ª×™ ×”×›×™ × ×•×— ×œ×š", field: "date", type: "chat-buttons", options: ["×”×™×•×", "××—×¨", "××—×¨×ª×™×™×"] },
  { msg: "××¢×•×œ×”, ××™×–×” ×©×¢×” ×‘× ×œ×š ×œ×”×ª×¤× ×§ ×‘×¤×Ÿ? ×‘×•×§×¨, ×¦×”×¨×™×™× ××• ×¢×¨×‘?", field: "period", type: "chat-buttons", options: ["×‘×•×§×¨ (8:00-12:00)", "×¦×”×¨×™×™× (12:00-17:00)", "×¢×¨×‘ (17:00-20:00)"] },
  { msg: "××– ×™××œ×œ×” ×ª×‘×—×¨×™ ×œ×š ××ª ×”×©×¢×” ×”×›×™ ××ª××™××” ×œ×š ×›××Ÿ ×œ××˜×”", field: "time", type: "chat-buttons-dynamic" },
  { msg: "×¨×©××ª×™ ×œ×™, ×ª×–×›×™×¨×™ ×œ×™ ××ª ×”×©× ×©×œ×š ×‘×‘×§×©×”", field: "name", type: "text", placeholder: "××” ×”×©× ×”××œ× ×©×œ×š", fixLanguage: true },
  { msg: "×•×“×‘×¨ ××—×¨×•×Ÿ, ××ª ×”××¡×¤×¨ ×˜×œ×¤×•×Ÿ × ×™×™×“ ×©×œ×š ×× ×™×”×™×” ×œ×™ ××™×–×” ×¢×“×›×•×Ÿ", field: "phone", type: "tel", placeholder: "××” ×”×˜×œ×¤×•×Ÿ ×”× ×™×™×“ ×©×œ×š" }
];

function addMessage(text, side) {
  const div = document.createElement("div"); div.className = `msg ${side}`; div.innerText = text;
  chatBox.appendChild(div); chatBox.scrollTop = chatBox.scrollHeight;
}

function showBotMsg(text, callback) {
  document.getElementById("typingIndicator").classList.remove("hidden");
  chatBox.scrollTop = chatBox.scrollHeight;
  setTimeout(() => {
    document.getElementById("typingIndicator").classList.add("hidden");
    addMessage(text, "bot"); speak(text);
    if(callback) callback();
  }, 1000);
}

async function fetchRecords() {
  const r = await fetch(BIN_URL + '?ts=' + Date.now(), { headers: { 'X-Master-Key': MASTER_KEY } });
  const j = await r.json(); return j.record.bookings || [];
}

function setupInput() {
  const step = steps[currentStep]; controlGroup.innerHTML = "";
  if (step.type === "chat-buttons" || step.type === "chat-buttons-dynamic") { inputZone.classList.add("hidden"); return; }
  inputZone.classList.remove("hidden");
  let input = document.createElement("input"); input.type = step.type; input.placeholder = step.placeholder || "";
  if (step.field === "name" && localStorage.getItem('fen_name')) input.value = localStorage.getItem('fen_name');
  if (step.field === "phone" && localStorage.getItem('fen_phone')) input.value = localStorage.getItem('fen_phone');
  if (step.fixLanguage) {
    input.addEventListener('input', (e) => {
      let v = e.target.value, nv = '';
      for (let c of v) { let lc = c.toLowerCase(); nv += engToHeb[lc] ? engToHeb[lc] : c; }
      if (v !== nv) e.target.value = nv;
    });
  }
  input.addEventListener('focus', () => setTimeout(() => input.scrollIntoView({behavior: "smooth", block: "center"}), 400));
  input.addEventListener('keypress', (e) => { if (e.key === 'Enter') mainBtn.click(); });
  input.id = "currentInput"; controlGroup.appendChild(input); input.focus();
}

function renderChatButtons(options, callback) {
  const container = document.createElement("div"); container.className = "chat-buttons";
  options.forEach(opt => {
    const btn = document.createElement("button"); btn.className = "chat-btn"; btn.innerText = opt;
    btn.onclick = () => { container.remove(); callback(opt); };
    container.appendChild(btn);
  });
  chatBox.appendChild(container); chatBox.scrollTop = chatBox.scrollHeight;
}

async function renderTimeButtons() {
  const period = userData.period;
  const bookings = await fetchRecords();
  const taken = new Set(bookings.filter(b => b.date === userData.date).map(b => b.time));
  const slots = [];
  for(let h=8; h<=20; h++) {
    for(let m of [0,20,40]) {
      if(h===20 && m>0) continue;
      const t = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
      if (period.includes("×‘×•×§×¨") && h < 12) slots.push(t);
      else if (period.includes("×¦×”×¨×™×™×") && h >= 12 && h < 17) slots.push(t);
      else if (period.includes("×¢×¨×‘") && h >= 17) slots.push(t);
    }
  }
  const available = slots.filter(s => !taken.has(s));
  if (available.length === 0) {
    showBotMsg("××•×™, ×›×œ ×”×©×¢×•×ª ×‘×˜×•×•×— ×”×–×” ×ª×¤×•×¡×•×ª. × ×¡×™ ×˜×•×•×— ××—×¨?", () => {
        currentStep = 1; setupInput();
        renderChatButtons(steps[1].options, (val) => handleInput(val));
    });
  } else { renderChatButtons(available, (val) => handleInput(val)); }
}

function handleInput(val) {
  const step = steps[currentStep];
  if (step.field === "date") {
    selectedDayLabel = val;
    userData.date = getFormattedDate(val === "×”×™×•×" ? 0 : (val === "××—×¨" ? 1 : 2));
    speak("×™×•×¤×™ ×§×‘×¢× ×• ×œ" + val);
  } else if (step.field === "time") {
    // ×¤×™×¨×•×§ ×”×©×¢×” ×•×”×“×§×•×ª ×œ×”×§×¨××” ××œ××”
    const [h, m] = val.split(':').map(Number);
    let minuteText = (m === 20) ? "×•×¢×©×¨×™×" : (m === 40 ? "×•××¨×‘×¢×™×" : "");
    let periodName = h < 12 ? "×‘×‘×•×§×¨" : (h < 17 ? "×‘×¦×”×¨×™×™×" : "×‘×¢×¨×‘");
    speak(`×™×•×¤×™ ×§×‘×¢× ×• ×œ ×©××•× ×” ${minuteText} ${periodName}`); 
  } else if (step.field === "phone") {
    if (!/^05\d{8}$/.test(val)) { showBotMsg("×›× ×¨××” ×©××ª ×§×¦×ª ××‘×•×œ×‘×œ×ª ğŸ˜Š ×”××¡×¤×¨ ×©×”×–× ×ª ×œ× ×ª×§×™×Ÿ", () => setupInput()); return; }
  }

  addMessage(val, "user"); userData[step.field] = val; currentStep++;
  if (currentStep < steps.length) {
    const next = steps[currentStep];
    showBotMsg(typeof next.msg === "function" ? next.msg(userData.name) : next.msg, () => {
        setupInput();
        if (next.type === "chat-buttons") renderChatButtons(next.options, (v) => handleInput(v));
        else if (next.type === "chat-buttons-dynamic") renderTimeButtons();
    });
  } else { save(); }
}

mainBtn.onclick = () => {
  const val = document.getElementById("currentInput")?.value.trim();
  if (!val) return; handleInput(val);
};

async function save() {
  inputZone.classList.add("hidden");
  showBotMsg("×©×•××¨×ª ×œ×š ××ª ×”×ª×•×¨, ×›×‘×¨ ××¡×™×™××ª...", async () => {
      try {
        localStorage.setItem('fen_name', userData.name); localStorage.setItem('fen_phone', userData.phone);
        const bookings = await fetchRecords();
        bookings.push({ ...userData, ts: Date.now() });
        await fetch(BIN_URL, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'X-Master-Key': MASTER_KEY }, body: JSON.stringify({ bookings }) });
        
        showBotMsg(`×§×‘×¢×ª×™ ×œ× ×• , ××ª×¨××•×ª ${selectedDayLabel} ×‘ ${userData.time}\n× × ×œ× ×œ××—×¨ ×•×œ×”×’×™×¢ ×—×¤×•×¤×” ğŸ™`, () => {
            showBotMsg("×¨×•×¦×” ×©××©×œ×— ×œ×š ×¡×™×›×•× ×©×œ ×”×ª×•×¨ ×•×§×™×©×•×¨ ×œ×›×ª×•×‘×ª ×œ×•×•×¦××¤ ×©×œ×š?", () => {
                renderChatButtons(["×›×Ÿ", "×œ×"], (choice) => {
                    if (choice === "×›×Ÿ") { sendSummaryToWhatsApp(); showBotMsg("×©×œ×—×ª×™ ×œ×š ×”×•×“×¢×” ×œ×•×•×¦××¤ ×¢× ×›×œ ×”×¤×¨×˜×™× ×•×”× ×™×•×•×˜. × ×ª×¨××”! ğŸ˜Š"); }
                    else { showBotMsg("××™×Ÿ ×‘×¢×™×”, × ×ª×¨××” ×‘×§×¨×•×‘! ğŸ‘‹"); }
                });
            });
        });
      } catch (e) { showBotMsg("×©×’×™××ª ×ª×§×©×•×¨×ª. × ×¡×™ ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨."); }
  });
}

function sendSummaryToWhatsApp() {
  const phone = userData.phone; const cleanPhone = "972" + phone.substring(1);
  const message = encodeURIComponent(`âœ¨ *×¡×™×›×•× ×ª×•×¨ - ×¤×Ÿ ××§×¡×¤×¨×¡* âœ¨\n\n×”×™×™ ${userData.name},\n×§×‘×¢× ×• ×œ× ×• ×ª×•×¨ ×œ××¤×’×© ×©×œ ×¤×™× ×•×§!\n\nğŸ“… *××ª×™:* ${selectedDayLabel} (${userData.date.split('-').reverse().join('.')})\nâ° *×©×¢×”:* ${userData.time}\n\nğŸ“ *× ×™×•×•×˜ ×‘-Waze:* ${WAZE_URL}\n\n× × ×œ×”×’×™×¢ ×—×¤×•×¤×” ×•×‘×–××Ÿ. × ×ª×¨××”! ğŸ™`);
  window.location.href = `https://wa.me/${cleanPhone}?text=${message}`;
}

function initChat() {
  document.getElementById("startOverlay").style.display = "none";
  showBotMsg(steps[0].msg, () => {
      setupInput();
      renderChatButtons(steps[0].options, (val) => handleInput(val));
  });
}
</script>
</body>
</html>
