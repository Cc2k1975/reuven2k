<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Global Timer</title>

  <!-- למראה כמו אפליקציה במובייל -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#000000">

  <style>
    * {margin:0;padding:0;box-sizing:border-box;}

    html, body {
      width:100%;
      height:100%;
      background:#000;
      color:#fff;
      font-family:"Courier New", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      overflow:hidden;
    }

    body {
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
    }

    .wrapper {
      width:100%;
      height:100vh;
      max-width:900px;
      padding:10px 12px 24px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap:18px;
    }

    #eventTitle {
      font-size:clamp(1.8rem,5vw,2.8rem);
      font-weight:900;
      color:#ffffff;
      word-break:break-word;
    }

    /* שורת הספרות */
    #countdownRow {
      display:flex;
      flex-direction:row;
      align-items:flex-end;
      justify-content:center;
      gap:0.4em;
      direction:ltr; /* חשוב – ספרות משמאל לימין */
    }

    .segment {
      display:flex;
      flex-direction:column;
      align-items:center;
      min-width:0;
    }

    .num {
      font-size:clamp(2.5rem, 11vw, 4.7rem);
      font-weight:900;
      letter-spacing:0.08em;
      color:#00ff55;
      text-shadow:0 0 12px #00ff55,0 0 22px #009933;
      line-height:1.05;
    }

    .colon {
      font-size:clamp(2.5rem, 11vw, 4.7rem);
      font-weight:900;
      color:#00ff55;
      text-shadow:0 0 12px #00ff55,0 0 22px #009933;
      line-height:1.05;
      padding:0 0.05em;
    }

    .label {
      margin-top:6px;
      font-size:clamp(0.7rem,2.7vw,1rem);
      font-weight:800;
      letter-spacing:0.25em;
    }

    /* כפתור סודי */
    #secretBtn {
      position:fixed;
      bottom:10px;
      right:10px;
      width:45px;
      height:45px;
      opacity:0;   /* נסתר */
      z-index:50;
    }

    /* חלון הגדרות */
    .overlay {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.65);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:100;
    }
    .overlay.active {display:flex;}

    .dialog {
      background:#111;
      padding:20px;
      border-radius:12px;
      width:90%;
      max-width:420px;
      color:#fff;
      text-align:right;
      box-shadow:0 20px 40px rgba(0,0,0,0.7);
      font-family:Arial,"Heebo",sans-serif;
    }

    .dialog h2 {margin-bottom:15px;font-size:1.2rem;}

    .field {margin-bottom:15px;}
    .field label {display:block;margin-bottom:5px;font-size:0.95rem;}
    .field input {
      width:100%;
      padding:10px;
      border:1px solid #555;
      border-radius:8px;
      background:#000;
      color:#fff;
      font-size:1rem;
    }

    .buttons {
      display:flex;
      justify-content:flex-end;
      gap:12px;
      margin-top:10px;
    }
    .btn {
      padding:9px 16px;
      border-radius:20px;
      cursor:pointer;
      border:1px solid #fff;
      font-size:0.9rem;
      font-weight:600;
    }
    .btn.secondary {background:#000;color:#fff;}
    .btn.primary {background:#00ff55;color:#000;}

    /* טקסט גרסה */
    .version {
      position:fixed;
      left:8px;
      bottom:8px;
      font-size:0.7rem;
      color:#888;
      font-family:monospace;
      pointer-events:none;
      user-select:none;
    }
  </style>
</head>
<body>

<div class="wrapper">
  <div id="eventTitle">אין אירוע מוגדר</div>

  <!-- שורת הספירה -->
  <div id="countdownRow">
    <div class="segment">
      <span class="num" id="daysVal">000</span>
      <span class="label">D</span>
    </div>
    <span class="colon">:</span>
    <div class="segment">
      <span class="num" id="hoursVal">00</span>
      <span class="label">H</span>
    </div>
    <span class="colon">:</span>
    <div class="segment">
      <span class="num" id="minsVal">00</span>
      <span class="label">M</span>
    </div>
    <span class="colon">:</span>
    <div class="segment">
      <span class="num" id="secsVal">00</span>
      <span class="label">S</span>
    </div>
    <span class="colon">:</span>
    <div class="segment">
      <span class="num" id="msVal">00</span>
      <!-- בלי אות מתחת למילי־שניות -->
      <span class="label">&nbsp;</span>
    </div>
  </div>
</div>

<button id="secretBtn"></button>

<div class="overlay" id="overlay">
  <div class="dialog">
    <h2>הגדרת אירוע חדש</h2>

    <div class="field">
      <label>שם האירוע</label>
      <input id="eventNameInput" type="text">
    </div>

    <div class="field">
      <label>תאריך ושעה</label>
      <input id="eventTimeInput" type="datetime-local">
    </div>

    <div class="buttons">
      <button class="btn secondary" id="cancelBtn">ביטול</button>
      <button class="btn primary" id="saveBtn">שמור</button>
    </div>
  </div>
</div>

<div class="version">v2025-11-23-FS3</div>

<script type="module">
  // -------- Firebase imports --------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

  // -------- Firebase config – global-timer-8ebbd --------
  const firebaseConfig = {
    apiKey: "AIzaSyAeUBBZDPZnDIcAvluwzubNtbs3xjmTqls",
    authDomain: "global-timer-8ebbd.firebaseapp.com",
    projectId: "global-timer-8ebbd",
    storageBucket: "global-timer-8ebbd.firebasestorage.app",
    messagingSenderId: "603403671136",
    appId: "1:603403671136:web:0269c03a847a1fb3d81505",
    measurementId: "G-WW8L0XHPGB"
  };

  const app  = initializeApp(firebaseConfig);
  const db   = getFirestore(app);
  const ref  = doc(db, "globalTimer", "event");

  // -------- אלמנטים --------
  const titleEl   = document.getElementById("eventTitle");
  const daysEl    = document.getElementById("daysVal");
  const hoursEl   = document.getElementById("hoursVal");
  const minsEl    = document.getElementById("minsVal");
  const secsEl    = document.getElementById("secsVal");
  const msEl      = document.getElementById("msVal");

  const secretBtn      = document.getElementById("secretBtn");
  const overlay        = document.getElementById("overlay");
  const eventNameInput = document.getElementById("eventNameInput");
  const eventTimeInput = document.getElementById("eventTimeInput");
  const cancelBtn      = document.getElementById("cancelBtn");
  const saveBtn        = document.getElementById("saveBtn");

  let targetTime = null;
  let timerId    = null;

  function pad(n, size){
    let s = String(n);
    while (s.length < size) s = "0" + s;
    return s;
  }

  function renderZero() {
    daysEl.textContent  = "000";
    hoursEl.textContent = "00";
    minsEl.textContent  = "00";
    secsEl.textContent  = "00";
    msEl.textContent    = "00";
  }

  function updateTimer(){
    if (!targetTime){
      renderZero();
      return;
    }

    const now = Date.now();
    let diff = targetTime - now;
    if (diff < 0) diff = 0;

    const days    = Math.floor(diff / 86400000);
    const hours   = Math.floor((diff / 3600000) % 24);
    const minutes = Math.floor((diff / 60000) % 60);
    const seconds = Math.floor((diff / 1000) % 60);
    const millis  = Math.floor((diff % 1000) / 10); // שתי ספרות

    daysEl.textContent  = pad(days,3);
    hoursEl.textContent = pad(hours,2);
    minsEl.textContent  = pad(minutes,2);
    secsEl.textContent  = pad(seconds,2);
    msEl.textContent    = pad(millis,2);
  }

  function startInterval(){
    if (timerId) clearInterval(timerId);
    timerId = setInterval(updateTimer, 10);
  }

  // -------- האזנה לפיירסטור --------
  console.log("Global Timer v1.1.0 – starting…");

  onSnapshot(ref, snap => {
    const data = snap.data();
    console.log("onSnapshot fired", data);

    if (!data || !data.timestamp){
      targetTime = null;
      titleEl.textContent = "אין אירוע מוגדר";
      updateTimer();
      return;
    }

    targetTime = data.timestamp;
    titleEl.textContent = data.name || "אירוע ללא שם";
    startInterval();
  });

  // -------- חלון סודי --------
  secretBtn.onclick = () => {
    overlay.classList.add("active");
    setTimeout(() => eventNameInput.focus(), 50);
  };

  cancelBtn.onclick = () => {
    overlay.classList.remove("active");
  };

  saveBtn.onclick = async () => {
    const name = eventNameInput.value.trim();
    const d    = eventTimeInput.value;

    if (!d){
      alert("בחר תאריך ושעה");
      return;
    }

    const t = new Date(d);
    if (isNaN(t.getTime())){
      alert("תאריך לא תקין");
      return;
    }

    const payload = {
      name: name || "אירוע ללא שם",
      timestamp: t.getTime()
    };

    console.log("Trying to save to Firestore:", payload);

    try{
      await setDoc(ref, payload, { merge:true });
      console.log("Saved to Firestore OK");
      overlay.classList.remove("active");
    }catch(err){
      console.error("Error saving to Firestore", err);
      alert("שגיאה בשמירה לשרת");
    }
  };

  // סגירה בלחיצה מחוץ לדיאלוג
  overlay.onclick = e => {
    if (e.target === overlay) overlay.classList.remove("active");
  };

  // -------- פול־סקין לאחר לחיצה ראשונה --------
  function requestFullScreenOnce() {
    if (!document.fullscreenElement && document.documentElement.requestFullscreen) {
      document.documentElement.requestFullscreen().catch(() => {});
    }
  }
  document.addEventListener("click", requestFullScreenOnce, { once:true });

  // אפס תצוגה בהתחלה
  renderZero();
</script>

</body>
</html>
