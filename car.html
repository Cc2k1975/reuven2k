<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>סריקת לוחית + שליפת נתונים</title>

  <!-- Tesseract (local) -->
  <script src="./tess/tesseract.min.js"></script>

  <style>
    :root{
      --bg1:#0b1220; --bg2:#08101d;
      --stroke:rgba(255,255,255,.10);
      --txt:#eaf0ff; --muted:rgba(234,240,255,.7);
      --green:#22c55e;
      --radius:22px;
      --shadow:0 20px 60px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; color:var(--txt);
      font-family: system-ui, -apple-system, Segoe UI, Arial;
      background: radial-gradient(1200px 900px at 70% 0%, #102a55 0%, transparent 55%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
    }
    .wrap{max-width:820px;margin:0 auto;padding:22px 14px 44px;}
    .header{
      padding:18px 18px;
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .title{font-size:22px;font-weight:800;letter-spacing:.2px}
    .sub{margin-top:6px;color:var(--muted);font-weight:600}
    .card{
      margin-top:16px;
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    input[type="text"]{
      flex:1; min-width:210px; height:54px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.20);
      color:var(--txt);
      padding:0 14px;
      font-size:18px;
      outline:none;
    }
    .btn{
      height:54px; padding:0 16px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--txt);
      font-weight:800;
      cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
      user-select:none;
    }
    .btn:active{transform:translateY(1px)}
    .btn.green{
      background:linear-gradient(180deg, rgba(34,197,94,.95), rgba(16,185,129,.78));
      border-color:rgba(34,197,94,.55);
      color:#06120b;
    }

    /* Scanner modal */
    .modal{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modal.show{display:flex;}
    .scanBox{
      width:min(520px, 94vw);
      border-radius:26px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow:0 30px 90px rgba(0,0,0,.60);
      overflow:hidden;
    }
    .scanTop{
      padding:14px 14px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .scanTop .h{font-weight:900; line-height:1.15;}
    .scanTop .small{
      display:block; margin-top:4px;
      color:var(--muted); font-weight:700; font-size:13px;
    }
    .scanBody{padding:0 14px 14px;}
    .frameWrap{
      width:100%;
      border-radius:22px;
      overflow:hidden;
      border:2px solid rgba(34,197,94,.85);
      box-shadow:0 0 0 4px rgba(34,197,94,.12) inset;
      background:#020617;
      touch-action: none; /* מאפשר גרירה חלקה */
    }
    canvas#preview{
      display:block;
      width:100%;
      height:auto;
      /* חלון רחב ללוחית, קצת יותר גבוה כדי לעזור */
      aspect-ratio: 16 / 8;
    }

    .scanControls{
      margin-top:10px;
      display:flex; align-items:center; gap:10px;
      justify-content:space-between; flex-wrap:wrap;
    }
    .zoomWrap{
      flex:1; display:flex; align-items:center; gap:10px;
      min-width:240px;
    }
    input[type="range"]{width:100%; accent-color: var(--green);}
    .pill{
      height:40px; padding:0 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      display:inline-flex; align-items:center; gap:8px;
      font-weight:800;
      white-space:nowrap;
    }

    .detected{
      margin-top:10px;
      padding:12px 12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .detected .num{
      font-size:26px;  /* הגדלתי קצת כמו שביקשת */
      font-weight:900;
      letter-spacing:1px;
    }
    .detected .st{color:var(--muted); font-weight:800; white-space:nowrap;}

    .debug{
      margin-top:8px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.16);
      color:rgba(234,240,255,.85);
      font-weight:700;
      font-size:12.5px;
      line-height:1.35;
      direction:ltr;
      text-align:left;
      max-height:84px;
      overflow:auto;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:22px;
      transform:translateX(-50%);
      background:rgba(0,0,0,.72);
      color:#fff;
      border:1px solid rgba(255,255,255,.16);
      padding:10px 12px;
      border-radius:14px;
      max-width:min(92vw, 520px);
      font-weight:800;
      display:none;
      z-index:10000;
    }
    .toast.show{display:block;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="title">סריקת לוחית + שליפת נתונים</div>
      <div class="sub">לחץ “סרוק”, גרור את המסגרת למעלה/למטה עד שהלוחית באמצע. זה ננעל אוטומטית.</div>
    </div>

    <div class="card">
      <div class="row">
        <input id="plateInput" type="text" inputmode="numeric" placeholder="מספר רכב (ללא מקפים)" />
        <button class="btn" id="scanBtn">סרוק</button>
        <button class="btn green" id="fetchBtn">שלוף נתונים</button>
      </div>

      <div style="margin-top:14px;color:var(--muted);font-weight:700" id="resultArea">
        מוכן.
      </div>
    </div>
  </div>

  <!-- Scanner Modal -->
  <div class="modal" id="scanModal" aria-hidden="true">
    <div class="scanBox">
      <div class="scanTop">
        <div class="h">
          סריקה בלייב – יציב ומהיר
          <span class="small">טיפ: גרור את המסגרת על הלוחית. אפשר להדליק פנס. כשזה יציב – זה ננעל.</span>
        </div>
        <button class="btn" id="closeScan">סגור</button>
      </div>

      <div class="scanBody">
        <div class="frameWrap" id="frameWrap">
          <canvas id="preview" width="960" height="480"></canvas>
        </div>

        <div class="scanControls">
          <div class="zoomWrap">
            <div class="pill">זום: <span id="zoomLabel">1.0×</span></div>
            <input id="zoomRange" type="range" min="1" max="3" step="0.1" value="1" />
          </div>

          <button class="btn" id="torchBtn" style="height:40px;border-radius:999px;padding:0 12px;">פנס</button>
          <div class="pill" id="perfPill">מוכן</div>
        </div>

        <div class="detected">
          <div class="num" id="liveNum">—</div>
          <div class="st" id="liveStatus">ממתין…</div>
        </div>

        <div class="debug" id="debugBox">debug: (ממתין ל-OCR)</div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const $ = (id)=>document.getElementById(id);
    const toast = (msg, ms=2200)=>{
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=>t.classList.remove("show"), ms);
    };

    // ====== שים פה את ה-API שלך (השארתי דמו בלי לשבור כלום) ======
    $("fetchBtn").addEventListener("click", async ()=>{
      const digits = $("plateInput").value.trim().replace(/\D/g,'');
      if(!(digits.length===7 || digits.length===8)){
        toast("תכתוב מספר רכב 7 או 8 ספרות");
        return;
      }
      $("resultArea").textContent = "מחפש נתונים…";
      try{
        // TODO: חבר כאן את fetch שעובד אצלך היום
        $("resultArea").textContent = "דמו: מספר לחיפוש = " + digits;
      }catch(e){
        $("resultArea").textContent = "שגיאת שליפה: " + (e?.message || e);
      }
    });

    // ====== Live OCR Scanner ======
    const modal = $("scanModal");
    const preview = $("preview");
    const pctx = preview.getContext("2d", { willReadFrequently:true });
    const video = document.createElement("video");
    video.setAttribute("playsinline","true");
    video.muted = true;
    video.autoplay = true;

    let stream = null;
    let worker = null;
    let scanning = false;
    let rafId = 0;

    // Speed / stability
    const OCR_FPS = 6;           // קצת יותר מהיר
    const WINDOW = 8;            // חלון תוצאות
    const LOCK_NEED = 4;         // צריך 4 הופעות כדי לנעול
    const MIN_CONF = 58;         // סף ביטחון

    let zoomFactor = 1.0;
    let lastOCR = 0;
    let locked = false;
    const seen = [];

    // ROI position (draggable)
    let roiCenterY = 0.72; // יחסי לגובה הוידאו (אפשר לגרור)
    let dragging = false;
    let dragStartY = 0;
    let roiStart = 0;

    // Torch
    let torchOn = false;

    $("scanBtn").addEventListener("click", openScanner);
    $("closeScan").addEventListener("click", closeScanner);

    $("zoomRange").addEventListener("input", async (e)=>{
      zoomFactor = parseFloat(e.target.value || "1");
      $("zoomLabel").textContent = zoomFactor.toFixed(1) + "×";
      try{ await tryApplyCameraZoom(zoomFactor); }catch(_){}
    });

    $("torchBtn").addEventListener("click", async ()=>{
      try{
        const ok = await setTorch(!torchOn);
        if(!ok){
          toast("הטלפון לא תומך בפנס דרך הדפדפן");
          return;
        }
        torchOn = !torchOn;
        $("torchBtn").textContent = torchOn ? "פנס: ON" : "פנס";
      }catch(e){
        toast("פנס לא זמין: " + (e?.message || e));
      }
    });

    // Drag to move ROI vertically (only inside frame area)
    const frameWrap = $("frameWrap");
    frameWrap.addEventListener("pointerdown", (e)=>{
      dragging = true;
      frameWrap.setPointerCapture(e.pointerId);
      dragStartY = e.clientY;
      roiStart = roiCenterY;
    });
    frameWrap.addEventListener("pointermove", (e)=>{
      if(!dragging) return;
      const dy = (e.clientY - dragStartY);
      // dy pixels -> dy ratio mapping (tuned for phone)
      const ratio = dy / 900; // גדול = פחות רגיש
      roiCenterY = clamp(roiStart + ratio, 0.45, 0.88);
      $("liveStatus").textContent = "מכוון מסגרת…";
    });
    frameWrap.addEventListener("pointerup", (e)=>{
      dragging = false;
      $("liveStatus").textContent = "ממתין לזיהוי…";
    });
    frameWrap.addEventListener("pointercancel", ()=> dragging=false);

    function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }

    async function openScanner(){
      modal.classList.add("show");
      modal.setAttribute("aria-hidden","false");
      $("perfPill").textContent = "פותח מצלמה…";
      $("liveNum").textContent = "—";
      $("liveStatus").textContent = "מאתחל…";
      $("debugBox").textContent = "debug: init…";
      locked = false;
      seen.length = 0;

      try{
        if(!stream){
          stream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: { ideal: "environment" },
              width: { ideal: 1920 },
              height:{ ideal: 1080 }
            },
            audio:false
          });
          video.srcObject = stream;
          await video.play();

          // Attempt continuous focus if supported
          try{
            const track = stream.getVideoTracks()[0];
            const caps = track.getCapabilities?.();
            if(caps?.focusMode?.includes?.("continuous")){
              await track.applyConstraints({ advanced: [{ focusMode: "continuous" }] });
            }
          }catch(_){}
        }

        if(!worker){
          $("perfPill").textContent = "טוען OCR…";
          worker = await Tesseract.createWorker({
            workerPath: "./tess/worker.min.js",
            corePath: "./tess/tesseract-core.wasm.js"
          });
          await worker.loadLanguage("eng");
          await worker.initialize("eng");
          await worker.setParameters({
            tessedit_char_whitelist: "0123456789",
            tessedit_pageseg_mode: "8" // single word (digits) לרוב טוב ללוחית
          });
        }

        scanning = true;
        $("perfPill").textContent = "רץ";
        toast("תכוון לוחית. אפשר לגרור את המסגרת למעלה/למטה.");
        loop();
      }catch(err){
        $("perfPill").textContent = "תקלה";
        $("liveStatus").textContent = "שגיאה";
        toast("שגיאה בפתיחת מצלמה/OCR: " + (err?.message || err));
        closeScanner();
      }
    }

    function closeScanner(){
      scanning = false;
      cancelAnimationFrame(rafId);
      rafId = 0;
      modal.classList.remove("show");
      modal.setAttribute("aria-hidden","true");
    }

    async function tryApplyCameraZoom(z){
      if(!stream) return;
      const track = stream.getVideoTracks()[0];
      const caps = track.getCapabilities?.();
      if(!caps || !caps.zoom) return;
      const min = caps.zoom.min ?? 1;
      const max = caps.zoom.max ?? 1;
      const target = Math.min(max, Math.max(min, z));
      await track.applyConstraints({ advanced: [{ zoom: target }] });
    }

    async function setTorch(on){
      if(!stream) return false;
      const track = stream.getVideoTracks()[0];
      const caps = track.getCapabilities?.();
      if(!caps?.torch) return false;
      await track.applyConstraints({ advanced: [{ torch: on }] });
      return true;
    }

    function loop(){
      if(!scanning) return;
      rafId = requestAnimationFrame(loop);
      if(video.readyState < 2) return;

      drawROIToPreview();

      const now = performance.now();
      if(now - lastOCR < (1000 / OCR_FPS)) return;
      lastOCR = now;

      ocrFromPreview().catch(()=>{});
    }

    function drawROIToPreview(){
      const vw = video.videoWidth;
      const vh = video.videoHeight;
      if(!vw || !vh) return;

      // בסיס: אזור רחב
      const baseW = vw * 0.82;
      const baseH = vh * 0.26;

      // זום דיגיטלי (תמיד עובד)
      const w = baseW / zoomFactor;
      const h = baseH / zoomFactor;

      const cx = vw / 2;
      const cy = vh * roiCenterY;

      const sx = clamp(cx - w/2, 0, vw - w);
      const sy = clamp(cy - h/2, 0, vh - h);

      pctx.imageSmoothingEnabled = true;
      pctx.drawImage(video, sx, sy, w, h, 0, 0, preview.width, preview.height);

      // קו עזר דק במרכז (לא מפריע, עוזר לכוון)
      pctx.save();
      pctx.globalAlpha = 0.25;
      pctx.strokeStyle = "#22c55e";
      pctx.lineWidth = 2;
      pctx.beginPath();
      pctx.moveTo(preview.width*0.05, preview.height/2);
      pctx.lineTo(preview.width*0.95, preview.height/2);
      pctx.stroke();
      pctx.restore();
    }

    // OCR worker input
    const workCanvas = document.createElement("canvas");
    const wctx = workCanvas.getContext("2d", { willReadFrequently:true });

    async function ocrFromPreview(){
      if(!worker || locked) return;

      // קטן ומהיר
      workCanvas.width = 560;
      workCanvas.height = 280;
      wctx.drawImage(preview, 0, 0, workCanvas.width, workCanvas.height);

      // preprocessing בשני כיוונים: רגיל + הפוך (למקרי תאורה מוזרים)
      const img1 = preprocessClone(workCanvas, false);
      const img2 = preprocessClone(workCanvas, true);

      const t0 = performance.now();
      const r1 = await worker.recognize(img1);
      const r2 = await worker.recognize(img2);
      const dt = performance.now() - t0;

      const best = pickBetterResult(r1, r2);
      $("perfPill").textContent = `פריים: ${dt.toFixed(0)}ms`;

      const raw = (best?.data?.text || "").trim();
      const conf = typeof best?.data?.confidence === "number" ? best.data.confidence : 0;

      $("debugBox").textContent = `raw: ${raw.replace(/\s+/g,' ')} | conf: ${conf.toFixed(0)} | roiY: ${roiCenterY.toFixed(2)} | zoom: ${zoomFactor.toFixed(1)}x`;

      const num = extractPlate(raw);
      if(!num){
        $("liveStatus").textContent = "עדיין לא זוהה";
        return;
      }

      seen.push({ num, conf, t: Date.now() });
      while(seen.length > WINDOW) seen.shift();

      const pick = pickStable(seen);
      $("liveNum").textContent = pick?.num || num;

      if(pick){
        $("liveStatus").textContent = `ננעל… (${pick.hits}/${WINDOW})`;
      }else{
        $("liveStatus").textContent = "זוהה (לא יציב)";
      }

      if(pick && pick.hits >= LOCK_NEED && pick.conf >= MIN_CONF){
        locked = true;
        $("liveStatus").textContent = "ננעל ✔";
        $("plateInput").value = pick.num;
        toast("זוהה מספר: " + pick.num);
        try{ navigator.vibrate?.(70); }catch(_){}
        setTimeout(()=>closeScanner(), 250);
      }
    }

    function pickBetterResult(a,b){
      const ta = (a?.data?.text || "").replace(/\D/g,'');
      const tb = (b?.data?.text || "").replace(/\D/g,'');
      const ca = a?.data?.confidence ?? 0;
      const cb = b?.data?.confidence ?? 0;

      // עדיפות לתוצאה שמכילה 7/8 ספרות
      const goodA = (ta.includesMatch7or8 && false);
      const goodB = (tb.includesMatch7or8 && false);

      // בפועל: נבדוק אם יש 7/8 רציף
      const hasA = /\d{7,8}/.test(ta);
      const hasB = /\d{7,8}/.test(tb);

      if(hasA && !hasB) return a;
      if(hasB && !hasA) return b;
      return (cb > ca) ? b : a;
    }

    function preprocessClone(srcCanvas, invert){
      const c = document.createElement("canvas");
      c.width = srcCanvas.width;
      c.height = srcCanvas.height;
      const ctx = c.getContext("2d", { willReadFrequently:true });
      ctx.drawImage(srcCanvas, 0, 0);

      const img = ctx.getImageData(0,0,c.width,c.height);
      const d = img.data;

      // grayscale + simple contrast
      let min=255, max=0;
      for(let i=0;i<d.length;i+=4){
        let y = (0.2126*d[i] + 0.7152*d[i+1] + 0.0722*d[i+2])|0;
        if(y<min) min=y;
        if(y>max) max=y;
      }
      const range = Math.max(1, (max-min));

      // dynamic threshold (mean-based)
      let sum=0;
      const n = c.width*c.height;
      for(let i=0;i<d.length;i+=4){
        const y = (0.2126*d[i] + 0.7152*d[i+1] + 0.0722*d[i+2]);
        sum += y;
      }
      const mean = sum/n;
      const thr = Math.min(230, Math.max(50, mean + 8));

      for(let i=0;i<d.length;i+=4){
        let y = (0.2126*d[i] + 0.7152*d[i+1] + 0.0722*d[i+2]);
        y = ((y - min) * 255 / range);

        let v = (y > thr) ? 255 : 0; // רקע לבן, ספרות שחור
        if(invert) v = 255 - v;

        d[i]=d[i+1]=d[i+2]=v;
        d[i+3]=255;
      }
      ctx.putImageData(img,0,0);
      return c;
    }

    function extractPlate(text){
      const digits = (text || "").replace(/\D/g,"");
      if(digits.length === 7 || digits.length === 8) return digits;

      // נסה למצוא רצף 8 או 7 בתוך מחרוזת ארוכה
      const m8 = digits.match(/\d{8}/);
      if(m8) return m8[0];
      const m7 = digits.match(/\d{7}/);
      if(m7) return m7[0];
      return "";
    }

    function pickStable(arr){
      if(!arr.length) return null;
      const map = new Map();
      for(const x of arr){
        const k = x.num;
        if(!k) continue;
        const v = map.get(k) || { num:k, hits:0, confSum:0, confMax:0 };
        v.hits++;
        v.confSum += (x.conf || 0);
        v.confMax = Math.max(v.confMax, x.conf || 0);
        map.set(k, v);
      }
      if(map.size === 0) return null;

      const all = [...map.values()].sort((a,b)=>{
        if(b.hits !== a.hits) return b.hits - a.hits;
        return (b.confMax - a.confMax);
      });
      const best = all[0];
      const avgConf = best.hits ? (best.confSum / best.hits) : 0;
      return { num: best.num, hits: best.hits, conf: Math.max(avgConf, best.confMax) };
    }
  </script>
</body>
</html>
