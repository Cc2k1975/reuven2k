<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>×¡×•×¨×§ ××—×™×¨×™×</title>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      width: 100%;
      height: 100%;
      background: #101827;
      color: #f9fafb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Heebo", Arial, sans-serif;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 12px;
    }

    .wrapper {
      width: 100%;
      max-width: 480px;
      margin-top: 8px;
    }

    h1 {
      font-size: 20px;
      text-align: center;
      margin-bottom: 10px;
    }

    /* ğŸ”¹ ×—×œ×•×Ÿ ××¦×œ××” ××œ×‘× ×™ â€“ ×¨×—×‘ ×•× ××•×š (×™×—×¡ 4:1 ×‘×¢×¨×š) */
    .camera-box {
      position: relative;
      width: 100%;
      max-width: 420px;
      aspect-ratio: 4 / 2;   /* ×¨×—×‘ ×××•×“, × ××•×š */
      background: #020617;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.4);
      margin: 0 auto;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: cover;      /* ×××œ× ××ª ×”××œ×‘×Ÿ */
      /* ××™×Ÿ ××¨××” */
    }

    /* ğŸ”¹ ××¡×’×¨×ª ×¤× ×™××™×ª â€“ ××œ×‘×Ÿ ×“×§ ×›××• ×ª×•×•×™×ª (×‘×¢×¨×š 1:4) */
    .overlay-frame {
      position: absolute;
      top: 25%;
      bottom: 25%;
      left: 5%;
      right: 5%;
      border-radius: 8px;
      border: 2px solid rgba(248, 250, 252, 0.9);
      box-shadow: 0 0 0 9999px rgba(15, 23, 42, 0.45);
      pointer-events: none;
    }

    .info {
      font-size: 13px;
      color: #cbd5f5;
      margin-top: 6px;
      text-align: center;
    }

    #status {
      margin-top: 6px;
      font-size: 13px;
      text-align: center;
      min-height: 18px;
      color: #e5e7eb;
    }

    .btn-row {
      margin-top: 10px;
      display: flex;
      justify-content: center;
    }

    button {
      padding: 10px 18px;
      font-size: 16px;
      border-radius: 999px;
      border: none;
      background: #22c55e;
      color: #022c22;
      font-weight: 600;
      box-shadow: 0 8px 18px rgba(34, 197, 94, 0.35);
      cursor: pointer;
      min-width: 180px;
    }

    button:active {
      transform: translateY(1px);
      box-shadow: 0 4px 10px rgba(34, 197, 94, 0.4);
    }

    .list-box {
      margin-top: 14px;
      background: #020617;
      border-radius: 14px;
      padding: 10px;
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .list-header {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      margin-bottom: 6px;
      color: #e5e7eb;
    }

    ul {
      list-style: none;
      max-height: 220px;
      overflow-y: auto;
    }

    li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      padding: 4px 0;
      border-bottom: 1px solid rgba(51, 65, 85, 0.6);
      font-size: 14px;
    }

    li:last-child {
      border-bottom: none;
    }

    .item-label {
      flex: 1;
    }

    .item-price {
      min-width: 70px;
      text-align: left;
    }

    /* ğŸ”´ ×›×¤×ª×•×¨ ××—×™×§×” ×××© ×§×˜×Ÿ */
    .delete-btn {
      border: none;
      border-radius: 999px;
      padding: 1px 5px;
      font-size: 9px;
      background: #ef4444;
      color: #fef2f2;
      cursor: pointer;
      flex-shrink: 0;
      line-height: 1.1;
    }

    .delete-btn:active {
      transform: translateY(1px);
    }

    .total-row {
      margin-top: 8px;
      padding-top: 6px;
      border-top: 1px solid rgba(148, 163, 184, 0.7);
      display: flex;
      justify-content: space-between;
      font-weight: 700;
      font-size: 16px;
    }

    .total-label {
      color: #e5e7eb;
    }

    .total-value {
      color: #22c55e;
    }

    #captureCanvas {
      display: none;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <h1>×¡×•×¨×§ ××—×™×¨×™× ×¤×©×•×˜</h1>

    <div class="camera-box">
      <video id="video" autoplay playsinline></video>
      <div class="overlay-frame"></div>
    </div>

    <div class="info">
      ×›×•×•×Ÿ ××ª ××“×‘×§×ª ×”××—×™×¨ ×œ××œ×‘×Ÿ ×”×œ×‘×Ÿ ×•×œ×—×¥ ×¢×œ "×”×•×¡×£ ××•×¦×¨".
    </div>
    <div id="status"></div>

    <div class="btn-row">
      <button id="addBtn">×”×•×¡×£ ××•×¦×¨</button>
    </div>

    <div class="list-box">
      <div class="list-header">
        <span>××•×¦×¨</span>
        <span>××—×™×¨ (â‚ª)</span>
      </div>
      <ul id="itemsList"></ul>
      <div class="total-row">
        <span class="total-label">×¡×”×´×›:</span>
        <span class="total-value" id="totalPrice">0.00</span>
      </div>
    </div>
  </div>

  <canvas id="captureCanvas"></canvas>

  <script src="https://unpkg.com/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
  <script>
    const video = document.getElementById('video');
    const addBtn = document.getElementById('addBtn');
    const statusEl = document.getElementById('status');
    const itemsList = document.getElementById('itemsList');
    const totalPriceEl = document.getElementById('totalPrice');
    const captureCanvas = document.getElementById('captureCanvas');

    const prices = [];

    // ğŸ”¹ ×”×¤×¢×œ×ª ×”××¦×œ××” â€“ ××‘×§×© ×™×—×¡ 4:1 ×•×’×•×‘×” ×§×˜×Ÿ ×™×—×¡×™×ª
    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: { ideal: 'environment' },
            width: { ideal: 1280 },
            height: { ideal: 320 },      // × ××•×š â€“ ×›××• ×¤×¡
            aspectRatio: { ideal: 4.0 }  // ×™×—×¡ 4:1
          },
          audio: false
        });
        video.srcObject = stream;
        statusEl.textContent = '×”××¦×œ××” ×¤×•×¢×œ×ª. ×›×•×•×Ÿ ××ª ××“×‘×§×ª ×”××—×™×¨ ×œ××œ×‘×Ÿ.';
      } catch (err) {
        statusEl.textContent = '×œ× ×”×¦×œ×—×ª×™ ×œ×”×¤×¢×™×œ ××¦×œ××”: ' + err.message;
      }
    }

    // ××•×ª×• ××œ×’×•×¨×™×ª× ××—×™×¨×™× ×›××• ×‘×’×¨×¡×” ×”××—×¨×•× ×” â€“ ×‘×œ×™ ×¡×™× ×•×Ÿ ×˜×•×•×— ×§×©×™×—
    function extractPriceFromText(text) {
      if (!text) return null;

      let cleaned = text.replace(/[^0-9.,]/g, ' ');
      const matches = cleaned.match(/\d{1,5}(?:[.,]\d{1,2})?/g);
      if (!matches) return null;

      const candidates = [];

      for (const raw of matches) {
        if (!raw) continue;

        let norm = raw.replace(/,/g, '.');
        const partsDot = norm.split('.');
        if (partsDot.length > 2) {
          norm = partsDot[0] + '.' + partsDot[1];
        }

        const value = parseFloat(norm);
        if (isNaN(value)) continue;
        if (value <= 0) continue;

        candidates.push({ raw: norm, value });
      }

      if (!candidates.length) return null;

      function scoreCandidate(c) {
        const raw = c.raw;
        const value = c.value;

        const parts = raw.split('.');
        const intPart = parts[0] || '';
        const fracPart = parts[1] || '';

        let score = 0;

        score += intPart.length * 2;

        if (fracPart.length === 2) score += 4;
        else if (fracPart.length === 1) score += 2;

        const cents = Math.round((value - Math.floor(value)) * 100);
        const typicalCents = [0, 5, 9, 10, 20, 50, 90, 95, 99];
        if (typicalCents.includes(cents)) score += 3;

        if (value >= 0.5 && value <= 500) score += 3;
        else if (value > 500 && value <= 5000) score += 1;

        if (intPart.length >= 2 && intPart.length <= 4) score += 2;

        return score;
      }

      let best = candidates[0];
      let bestScore = scoreCandidate(best);

      for (let i = 1; i < candidates.length; i++) {
        const s = scoreCandidate(candidates[i]);
        if (s > bestScore) {
          bestScore = s;
          best = candidates[i];
        }
      }

      return best.value;
    }

    function renderList() {
      itemsList.innerHTML = '';
      let total = 0;

      prices.forEach((price, index) => {
        total += price;

        const li = document.createElement('li');

        const labelSpan = document.createElement('span');
        labelSpan.className = 'item-label';
        labelSpan.textContent = '××•×¦×¨ ' + (index + 1);

        const priceSpan = document.createElement('span');
        priceSpan.className = 'item-price';
        priceSpan.textContent = price.toFixed(2);

        const delBtn = document.createElement('button');
        delBtn.className = 'delete-btn';
        delBtn.textContent = '××—×§';
        delBtn.dataset.index = index.toString();

        li.appendChild(labelSpan);
        li.appendChild(priceSpan);
        li.appendChild(delBtn);

        itemsList.appendChild(li);
      });

      totalPriceEl.textContent = total.toFixed(2);
    }

    function applyGrayscaleAndContrast(ctx, width, height) {
      const imageData = ctx.getImageData(0, 0, width, height);
      const data = imageData.data;
      const contrast = 1.4;

      for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];

        let gray = 0.299 * r + 0.587 * g + 0.114 * b;

        gray = (gray - 128) * contrast + 128;
        if (gray < 0) gray = 0;
        if (gray > 255) gray = 255;

        data[i] = data[i + 1] = data[i + 2] = gray;
      }

      ctx.putImageData(imageData, 0, 0);
    }

    // ğŸ”¹ ×¦×™×œ×•× ×©×œ ××œ×‘×Ÿ 4:1 ××”×•×™×“××• (××ª××™× ×œ××¡×’×¨×ª)
    async function handleAddProduct() {
      if (!video.videoWidth || !video.videoHeight) {
        statusEl.textContent = '××—×›×” ×©×”××¦×œ××” ×ª×¢×œ×”... × ×¡×” ×©×•×‘ ×¢×•×“ ×¨×’×¢.';
        return;
      }

      statusEl.textContent = '××–×”×” ××—×™×¨...';

      const fullW = video.videoWidth;
      const fullH = video.videoHeight;

      // × × ×¡×” ×œ×§×—×ª 80% ××”×¨×•×—×‘, ×•×œ×”×ª××™× ×’×•×‘×” ×œ×™×—×¡ 4:1
      let roiW = fullW * 0.8;
      let roiH = roiW / 4;

      // ×× ×”×’×•×‘×” ×™×•×¦× ×’×“×•×œ ××“×™ ×‘×™×—×¡ ×œ×ª××•× ×” â€“ × ×ª××™× ×”×¤×•×š
      if (roiH > fullH * 0.8) {
        roiH = fullH * 0.8;
        roiW = roiH * 4;
      }

      const sx = (fullW - roiW) / 2;
      const sy = (fullH - roiH) / 2;

      const targetW = Math.floor(roiW * 2); // ×”×’×“×œ×” ×¤×™ 2
      const targetH = Math.floor(roiH * 2);

      captureCanvas.width = targetW;
      captureCanvas.height = targetH;
      const ctx = captureCanvas.getContext('2d');

      ctx.drawImage(video, sx, sy, roiW, roiH, 0, 0, targetW, targetH);

      applyGrayscaleAndContrast(ctx, targetW, targetH);

      try {
        const result = await Tesseract.recognize(
          captureCanvas,
          'eng',
          {
            logger: () => {},
            tessedit_char_whitelist: '0123456789.,',
            user_defined_dpi: '300'
          }
        );

        const rawText = result.data.text;
        const price = extractPriceFromText(rawText);

        if (price == null) {
          statusEl.textContent =
            '×œ× ×”×¦×œ×—×ª×™ ×œ××¦×•× ××—×™×¨ ×‘×¨×•×¨. × ×¡×” ×œ×”×ª×§×¨×‘, ×œ×™×™×©×¨ ××ª ×”×ª×•×•×™×ª ××• ×œ×©×¤×¨ ×ª××•×¨×”.';
          return;
        }

        const rounded = Math.round(price * 100) / 100;
        prices.push(rounded);
        renderList();
        statusEl.textContent = '× ×•×¡×£ ××•×¦×¨: ' + rounded.toFixed(2) + ' â‚ª';
      } catch (err) {
        statusEl.textContent = '×©×’×™××” ×‘×–×™×”×•×™ ××—×™×¨: ' + err.message;
      }
    }

    itemsList.addEventListener('click', (event) => {
      const target = event.target;
      if (target.classList.contains('delete-btn')) {
        const index = parseInt(target.dataset.index, 10);
        if (!isNaN(index)) {
          prices.splice(index, 1);
          renderList();
        }
      }
    });

    window.addEventListener('load', startCamera);
    addBtn.addEventListener('click', handleAddProduct);
  </script>
</body>
</html>
