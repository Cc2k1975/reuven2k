<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>שלח מיקום</title>
  <style>
    *{box-sizing:border-box}
    body{
      margin:0;
      height:100vh;
      background:#0b1220;
      display:flex;
      align-items:center;
      justify-content:center;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    }
    button{
      width:95vw;
      height:80vh;
      border:none;
      border-radius:30px;
      font-size:clamp(48px,8vw,96px);
      font-weight:900;
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#04120a;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
    }
    button:active{transform:scale(.98)}
    button:disabled{opacity:.75; cursor:not-allowed; transform:none;}
  </style>
</head>
<body>

<button id="btn">שלח מיקום</button>

<script>
(() => {
  const btn = document.getElementById("btn");
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

  const hebMap = [
    [/אפס|0/gi,"0"],[/אחת|אחד|1/gi,"1"],[/שתיים|שניים|שתים|2/gi,"2"],
    [/שלוש|שלושה|3/gi,"3"],[/ארבע|ארבעה|4/gi,"4"],
    [/חמש|חמישה|5/gi,"5"],[/שש|שישה|6/gi,"6"],
    [/שבע|שבעה|7/gi,"7"],[/שמונה|8/gi,"8"],[/תשע|תשעה|9/gi,"9"]
  ];

  function extractDigits(t){
    let s=t||"";
    hebMap.forEach(([r,d])=>s=s.replace(r," "+d+" "));
    return s.replace(/[^\d]/g,"");
  }

  function normalize(d){
    d=(d||"").replace(/\D/g,"");
    if(d.length===10) return d;
    if(d.length===9) return "0"+d;
    if(d.startsWith("972")){
      d=d.slice(3);
      if(d.startsWith("0")) d=d.slice(1);
      if(d.length===9) return "0"+d;
    }
    if(d.length>10){
      const t=d.slice(-10);
      if(t.startsWith("0")) return t;
    }
    return null;
  }

  function getLocationSnapshot(){
    return new Promise((res,rej)=>{
      navigator.geolocation.getCurrentPosition(
        p=>res({lat:p.coords.latitude,lon:p.coords.longitude}),
        e=>rej(e),
        {enableHighAccuracy:true,timeout:15000,maximumAge:0}
      );
    });
  }

  function tryOpenWhatsAppDirect(phoneIntl, msg){
    const deep = `whatsapp://send?phone=${phoneIntl}&text=${encodeURIComponent(msg)}`;
    const web  = `https://wa.me/${phoneIntl}?text=${encodeURIComponent(msg)}`;

    // ניסיון לפתוח אפליקציה
    location.href = deep;

    // fallback רק אם לא עברנו באמת לאפליקציה
    setTimeout(() => {
      if (document.visibilityState === "visible") {
        location.href = web;
      }
    }, 350);
  }

  function openWA(phone10,lat,lon){
    const local = phone10.startsWith("0") ? phone10.slice(1) : phone10;
    const phoneIntl = "972" + local;

    const waze = `https://waze.com/ul?ll=${lat},${lon}&navigate=yes`;
    const maps = `https://www.google.com/maps?q=${lat},${lon}`;

    const msg =
      `*זה המיקום שלי*\n\n` +
      `קישור לווייז:\n${waze}\n\n` +
      `קישור לגוגל מפות:\n${maps}`;

    tryOpenWhatsAppDirect(phoneIntl, msg);
  }

  btn.onclick = () => {
    if(!SpeechRecognition){
      alert("הדפדפן לא תומך בזיהוי דיבור במכשיר הזה. נסה Chrome.");
      return;
    }
    if(!navigator.geolocation){
      alert("אין תמיכה ב-GPS בדפדפן הזה.");
      return;
    }

    btn.textContent = "נא להקריא את המספר טלפון";
    btn.disabled = true;

    const locPromise = getLocationSnapshot();
    let loc = null;
    locPromise.then(l => loc = l).catch(()=>{});

    const rec = new SpeechRecognition();
    rec.lang = "he-IL";
    rec.continuous = true;
    rec.interimResults = true;

    let locked = false;
    let transcriptAll = "";

    rec.onresult = async e => {
      if(locked) return;

      // מצטבר טקסט (לא ספרות!) כדי לא להכפיל digits בגלל interim
      let chunk = "";
      for(let i=e.resultIndex;i<e.results.length;i++){
        chunk += " " + (e.results[i][0].transcript || "");
      }
      transcriptAll += chunk;

      const digits = extractDigits(transcriptAll);
      const phone = normalize(digits);

      if(phone){
        locked = true;

        try { rec.stop(); } catch(_) {}

        try{
          const L = loc || await locPromise;
          if (L && typeof L.lat === "number" && typeof L.lon === "number") {
            openWA(phone, L.lat, L.lon);
          } else {
            throw new Error("no location");
          }
        }catch{
          alert("לא הצלחתי לקבל מיקום. אשר הרשאת מיקום ונסה שוב.");
        }

        btn.disabled = false;
        btn.textContent = "שלח מיקום";
      }
    };

    rec.onerror = () => {
      btn.disabled = false;
      btn.textContent = "שלח מיקום";
    };

    rec.onend = () => {
      if(!locked){
        btn.disabled = false;
        btn.textContent = "שלח מיקום";
      }
    };

    try { rec.start(); } catch(_) {
      btn.disabled = false;
      btn.textContent = "שלח מיקום";
    }
  };
})();
</script>

</body>
</html>
