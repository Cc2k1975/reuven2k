<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MOA ניהול סקר</title>
<style>
  :root{
    --bg:#000;
    --panel:#0f0f0f;
    --panel-inner:#121212;
    --accent:#d4af37;
    --txt-main:#f8e9a8;
    --border-col:rgba(212,175,55,0.18);
    --row-sep:rgba(255,255,255,0.04);
    --good:#145a2b;
    --bad:#6b1b1b;
  }
  html,body{
    margin:0;
    background:var(--bg);
    color:var(--accent);
    font-family:Arial, Helvetica, sans-serif;
  }
  .wrap{
    max-width:1100px;
    margin:24px auto 80px;
    background:var(--panel);
    border-radius:20px;
    box-shadow:0 20px 60px rgba(0,0,0,0.8);
    border:2px solid rgba(212,175,55,0.08);
    padding:20px clamp(16px,2vw,28px) 24px;
  }
  header h1{
    margin:0 0 16px;
    color:var(--accent);
    font-size:26px;
    font-weight:700;
    text-align:center;
  }
  .top-bar{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    align-items:center;
    justify-content:center;
    margin-bottom:16px;
  }
  .statusBox{
    background:var(--good);
    color:#fff;
    font-size:14px;
    font-weight:700;
    border-radius:10px;
    padding:10px 12px;
    min-width:180px;
    text-align:center;
    display:none;
  }
  .statusBox.err{
    background:var(--bad);
  }
  .btn{
    background:var(--accent);
    color:#000;
    font-weight:700;
    border:none;
    border-radius:10px;
    padding:10px 14px;
    font-size:14px;
  }
  .btn.ghost{
    background:transparent;
    color:var(--accent);
    border:1px solid var(--border-col);
  }
  .searchWrap{
    display:flex;
    align-items:center;
    background:var(--panel-inner);
    border-radius:10px;
    border:2px solid var(--border-col);
    overflow:hidden;
  }
  .searchWrap input{
    background:transparent;
    border:none;
    outline:none;
    color:var(--accent);
    padding:10px 12px;
    min-width:180px;
    font-size:14px;
  }
  .table-shell{
    background:var(--panel-inner);
    border-radius:16px;
    border:1px solid var(--border-col);
    padding:0;
    overflow-x:auto;
    box-shadow:0 10px 40px rgba(0,0,0,0.6);
  }
  table{
    border-collapse:collapse;
    min-width:900px;
    width:100%;
    color:var(--txt-main);
    font-size:14px;
  }
  thead th{
    position:sticky;
    top:0;
    background:#0b0b0b;
    color:var(--accent);
    font-weight:700;
    text-align:right;
    white-space:nowrap;
    border-bottom:1px solid var(--border-col);
    padding:12px 10px;
    font-size:13px;
  }
  tbody tr{
    background:var(--panel-inner);
  }
  tbody tr:nth-child(even){
    background:#1a1a1a;
  }
  td{
    border-bottom:1px solid var(--row-sep);
    padding:10px 10px;
    vertical-align:middle;
    color:var(--txt-main);
    white-space:nowrap;
  }
  td .actions{
    display:flex;
    gap:6px;
    flex-wrap:wrap;
  }
  .miniBtn{
    font-size:12px;
    line-height:1.2;
    border-radius:8px;
    cursor:pointer;
    padding:8px 10px;
    font-weight:700;
  }
  .miniBtn.edit{
    background:transparent;
    border:1px solid var(--accent);
    color:var(--accent);
  }
  .miniBtn.del{
    background:var(--accent);
    color:#000;
    border:none;
  }
  .smallNote{
    font-size:12px;
    color:#c8bb8a;
    margin-top:16px;
    text-align:center;
    line-height:1.4;
  }
  footer{
    margin-top:24px;
    text-align:center;
    font-size:12px;
    color:#9a8e61;
  }
  #debugArea{
    font-size:11px;
    line-height:1.5;
    color:#bbb;
    background:#000;
    border-top:1px solid rgba(255,255,255,0.07);
    margin-top:40px;
    padding:12px 16px 60px;
    white-space:pre-wrap;
    direction:ltr;
    text-align:left;
    overflow-x:auto;
  }
  @media(max-width:600px){
    header h1{ font-size:22px; }
    thead th{ font-size:12px; padding:10px; }
    td{ font-size:12px; padding:8px; }
  }

  /* modal עריכה */
  #modalEdit{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background:rgba(0,0,0,0.6);
    z-index:2000;
  }
  .modalBox{
    background:#0f0f0f;
    border-radius:14px;
    border:2px solid rgba(212,175,55,0.15);
    max-width:360px;
    width:calc(100% - 32px);
    padding:16px 16px 20px;
    box-shadow:0 20px 60px rgba(0,0,0,0.9);
  }
  .modalBox h2{
    margin:0 0 12px;
    color:var(--accent);
    font-size:18px;
    font-weight:700;
    text-align:right;
  }
  .field{
    display:flex;
    flex-direction:column;
    margin-bottom:10px;
  }
  .field label{
    color:var(--accent);
    font-size:13px;
    font-weight:700;
    margin-bottom:4px;
  }
  .field input,
  .field select{
    background:#1a1a1a;
    color:var(--accent);
    border-radius:10px;
    border:1px solid var(--border-col);
    padding:10px;
    font-size:14px;
  }
  .modalActions{
    display:flex;
    justify-content:flex-end;
    gap:8px;
    margin-top:14px;
  }
</style>
</head>
<body>

<div class="wrap">

  <header>
    <h1>טופס סקר — ניהול MOA</h1>
  </header>

  <div class="top-bar">
    <div id="statusTop" class="statusBox"></div>

    <button id="refreshBtn" class="btn">רענן</button>

    <div class="searchWrap">
      <input id="filter" type="text" placeholder="חפש – שם / טלפון / מבנה…" />
    </div>

    <button id="exportCsv" class="btn ghost">CSV ייצוא</button>
  </div>

  <div class="table-shell">
    <table>
      <thead>
        <tr>
          <th>מחלקה</th>
          <th>שם העובד</th>
          <th>טלפון</th>
          <th>מבנה</th>
          <th>קומה</th>
          <th>חדר</th>
          <th>כמות אריזות</th>
          <th>חדר יעד</th>
          <th>נוצר בתאריך</th>
          <th>פעולות</th>
        </tr>
      </thead>
      <tbody id="listBody">
        <tr><td colspan="10" style="text-align:center;color:#888;padding:20px">טוען…</td></tr>
      </tbody>
    </table>
  </div>

  <div class="smallNote">
    גרסה <span id="ver">1.2.0</span> · קובץ: moadata.html  
    מקור נתונים: answers[] באותו BIN
  </div>

  <footer>
    אם אתה רואה נתונים – זה אומר שהקריאה ל-BIN עבדה.  
    אם ריק / שגיאה – תבדוק BIN_ID או ACCESS_KEY.
  </footer>

  <div id="debugArea"></div>

</div>

<!-- מודאל עריכה -->
<div id="modalEdit">
  <div class="modalBox" role="dialog" aria-modal="true">
    <h2>עריכת רשומה</h2>

    <div class="field">
      <label>מחלקה</label>
      <select id="m_dept">
        <option>אווירודינמיקה</option>
        <option>מחמ</option>
        <option>מטה</option>
        <option>ניווט</option>
        <option>בקמ</option>
        <option>טילאות</option>
        <option>סימולציות</option>
      </select>
    </div>

    <div class="field">
      <label>שם העובד</label>
      <input id="m_name" />
    </div>

    <div class="field">
      <label>מספר נייד</label>
      <input id="m_phone" />
    </div>

    <div class="field">
      <label>מבנה</label>
      <input id="m_building" />
    </div>

    <div class="field">
      <label>קומה</label>
      <input id="m_floor" />
    </div>

    <div class="field">
      <label>מספר חדר</label>
      <input id="m_room" />
    </div>

    <div class="field">
      <label>כמות אריזות</label>
      <select id="m_packs">
        <option>1</option>
        <option>2</option>
        <option>3</option>
        <option>4</option>
        <option>5</option>
      </select>
    </div>

    <div class="field">
      <label>חדר יעד</label>
      <input id="m_target" />
    </div>

    <div class="modalActions">
      <button id="saveEdit" class="btn">שמור</button>
      <button id="closeModal" class="btn ghost">ביטול</button>
    </div>
  </div>
</div>

<script>
/*
  גרסה: 1.2.0
  קובץ: moadata.html
  מציג/עורך/מוחק מה-BIN את answers[] (בדיוק כמו bookings בפן אקספרס).
*/

const BIN_ID = "68fefa3dd0ea881f40beb941";
const ACCESS_KEY = "$2a$10$cSsqpLyw9Jl/8q0El4JzqOuwLRUINEoMNeyxeUQ726QdlvNMD0iTe";
const API_BASE = "https://api.jsonbin.io/v3/b";

const statusTop   = document.getElementById("statusTop");
const debugArea   = document.getElementById("debugArea");
const listBody    = document.getElementById("listBody");
const filterInput = document.getElementById("filter");
const refreshBtn  = document.getElementById("refreshBtn");
const exportBtn   = document.getElementById("exportCsv");

const modal       = document.getElementById("modalEdit");
const closeModalB = document.getElementById("closeModal");
const saveEditB   = document.getElementById("saveEdit");

const F_dept      = document.getElementById("m_dept");
const F_name      = document.getElementById("m_name");
const F_phone     = document.getElementById("m_phone");
const F_building  = document.getElementById("m_building");
const F_floor     = document.getElementById("m_floor");
const F_room      = document.getElementById("m_room");
const F_packs     = document.getElementById("m_packs");
const F_target    = document.getElementById("m_target");

let currentRecords = [];
let editingIndex   = null;

/* עזרי UI */
function logDebug(...args){
  const t = new Date().toLocaleTimeString();
  const line = `[${t}] ` + args.map(x =>
    (typeof x === "object" ? JSON.stringify(x) : x)
  ).join(" | ");
  debugArea.textContent = line + "\n" + debugArea.textContent;
}

function setStatus(msg, ok=true){
  statusTop.style.display = "block";
  statusTop.className = "statusBox" + (ok ? "" : " err");
  statusTop.textContent = msg;
}
function clearStatus(){
  statusTop.style.display = "none";
}

/* GET מהבין */
async function loadFromBin(){
  clearStatus();
  listBody.innerHTML =
    `<tr><td colspan="10" style="text-align:center;color:#888;padding:20px">טוען…</td></tr>`;

  const url = `${API_BASE}/${BIN_ID}/latest`;
  try{
    const res = await fetch(url,{
      method:"GET",
      headers:{
        "Content-Type":"application/json",
        "X-Access-Key":ACCESS_KEY
      }
    });
    const raw = await res.text();
    logDebug("GET", url, "status="+res.status, "body=", raw);

    if(!res.ok){
      setStatus("שגיאה בטעינה: "+res.status,false);
      listBody.innerHTML =
        `<tr><td colspan="10" style="text-align:center;color:#ffb8b8;padding:20px">שגיאה בטעינה</td></tr>`;
      return;
    }

    const data   = JSON.parse(raw);
    const record = data.record || data.data || data || {};
    // מחפשים answers
    let arr = [];
    if(Array.isArray(record.answers)){
      arr = record.answers;
    }else if(record && Object.keys(record).length>0){
      // תאימות אחורה: בין שהיה רק אובייקט בודד בלי answers
      arr = [record];
    }
    currentRecords = arr;
    drawTable(currentRecords);
    setStatus(`נטענו ${arr.length} רשומות ✅`, true);
  }catch(e){
    logDebug("ERR load:", e);
    setStatus("שגיאת רשת בטעינה",false);
    listBody.innerHTML =
      `<tr><td colspan="10" style="text-align:center;color:#ffb8b8;padding:20px">שגיאת רשת</td></tr>`;
  }
}

/* רינדור הטבלה */
function drawTable(rows){
  if(!rows || rows.length===0){
    listBody.innerHTML =
      `<tr><td colspan="10" style="text-align:center;color:#888;padding:20px">אין רשומות להצגה</td></tr>`;
    return;
  }

  listBody.innerHTML = "";
  rows.forEach((r, idx)=>{
    const dept       = r.dept        || "";
    const name       = r.workerName  || "";
    const phone      = r.phone       || "";
    const building   = r.building    || "";
    const floor      = r.floor       || "";
    const room       = r.room        || "";
    const packs      = r.packs       || "";
    const targetRoom = r.targetRoom  || "";
    const tsRaw      = r.ts          || "";
    const tsNice     = formatTs(tsRaw);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(dept)}</td>
      <td>${escapeHtml(name)}</td>
      <td>${escapeHtml(phone)}</td>
      <td>${escapeHtml(building)}</td>
      <td>${escapeHtml(floor)}</td>
      <td>${escapeHtml(room)}</td>
      <td>${escapeHtml(packs)}</td>
      <td>${escapeHtml(targetRoom)}</td>
      <td style="white-space:normal">${escapeHtml(tsNice)}</td>
      <td>
        <div class="actions">
          <button class="miniBtn edit" data-idx="${idx}" data-act="edit">ערוך</button>
          <button class="miniBtn del"  data-idx="${idx}" data-act="del">מחק</button>
        </div>
      </td>
    `;
    listBody.appendChild(tr);
  });

  // חיבור הכפתורים
  listBody.querySelectorAll("button").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const idx = parseInt(btn.dataset.idx,10);
      const act = btn.dataset.act;
      if(act==="edit"){
        openEdit(idx);
      }else if(act==="del"){
        if(confirm("בטוח למחוק את הרשומה?")){
          await deleteRow(idx);
        }
      }
    });
  });
}

/* אסקייפ ל-HTML */
function escapeHtml(s){
  if(s===undefined || s===null) return "";
  return String(s).replace(/[&<>"']/g, ch=>{
    return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;'}[ch]);
  });
}

/* פורמט זמן */
function formatTs(ts){
  if(!ts) return "";
  const d = new Date(ts);
  if(isNaN(d)) return ts;
  return d.toLocaleString("he-IL",{hour12:false});
}

/* סינון */
filterInput.addEventListener("input", ()=>{
  const q = filterInput.value.trim().toLowerCase();
  if(!q){
    drawTable(currentRecords);
    return;
  }
  const filtered = currentRecords.filter(r=>{
    const blob = JSON.stringify(r).toLowerCase();
    return blob.includes(q);
  });
  drawTable(filtered);
});

/* שמירה חזרה (PUT) של כל answers */
async function saveAllToBin(){
  const url = `${API_BASE}/${BIN_ID}`;
  const bodyObj = { answers: currentRecords.map(x=>({...x})) };
  try{
    const res = await fetch(url,{
      method:"PUT",
      headers:{
        "Content-Type":"application/json",
        "X-Access-Key":ACCESS_KEY
      },
      body:JSON.stringify(bodyObj)
    });
    const raw = await res.text();
    logDebug("PUT", url, "status="+res.status, "body=", raw);

    if(!res.ok){
      setStatus("שגיאה בשמירה "+res.status,false);
      return false;
    }
    setStatus("נשמר בהצלחה בענן ✅",true);
    return true;
  }catch(e){
    logDebug("ERR PUT:", e);
    setStatus("שגיאת רשת בשמירה",false);
    return false;
  }
}

/* מחיקה */
async function deleteRow(idx){
  currentRecords.splice(idx,1);
  const ok = await saveAllToBin();
  if(ok){
    loadFromBin();
  }
}

/* פתיחת חלון עריכה */
function openEdit(idx){
  editingIndex = idx;
  const r = currentRecords[idx] || {};

  F_dept.value     = r.dept        || F_dept.value;
  F_name.value     = r.workerName  || "";
  F_phone.value    = r.phone       || "";
  F_building.value = r.building    || "";
  F_floor.value    = r.floor       || "";
  F_room.value     = r.room        || "";
  F_packs.value    = r.packs       || "1";
  F_target.value   = r.targetRoom  || "";

  modal.style.display = "flex";
}

/* שמירת העריכה */
saveEditB.addEventListener("click", async ()=>{
  if(editingIndex===null) return;
  const r = currentRecords[editingIndex] || {};

  r.dept        = F_dept.value.trim();
  r.workerName  = F_name.value.trim();
  r.phone       = F_phone.value.trim();
  r.building    = F_building.value.trim();
  r.floor       = F_floor.value.trim();
  r.room        = F_room.value.trim();
  r.packs       = F_packs.value.trim();
  r.targetRoom  = F_target.value.trim();
  r.ts          = new Date().toISOString(); // עדכון חותמת זמן

  currentRecords[editingIndex] = r;

  const ok = await saveAllToBin();
  if(ok){
    modal.style.display="none";
    editingIndex=null;
    loadFromBin();
  }
});

/* סגירת מודאל */
closeModalB.addEventListener("click", ()=>{
  editingIndex=null;
  modal.style.display="none";
});

/* ייצוא CSV */
exportBtn.addEventListener("click", ()=>{
  if(!currentRecords.length){
    alert("אין נתונים לייצוא");
    return;
  }
  const headers = [
    "dept","workerName","phone","building","floor",
    "room","packs","targetRoom","ts"
  ];
  const lines = [headers.join(",")];

  currentRecords.forEach(r=>{
    const row = headers.map(h=>{
      const v = r[h] || "";
      return `"${String(v).replace(/"/g,'""')}"`;
    }).join(",");
    lines.push(row);
  });

  const csv = lines.join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement("a");
  a.href = url;
  a.download = "moa_data.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

/* רענון ידני */
refreshBtn.addEventListener("click", loadFromBin);

/* התחלה */
(function init(){
  logDebug("start moadata.html v1.2.0 BIN "+BIN_ID);
  loadFromBin();
})();
</script>
</body>
</html>
