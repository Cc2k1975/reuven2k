<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>×¦×™×œ×•× ×©×¨×˜×•×˜ â†’ ×–×™×”×•×™ ×¦×œ×¢×•×ª â†’ ×©×¨×˜×•×˜ ××“×•×™×§</title>

<script src="https://docs.opencv.org/4.7.0/opencv.js"></script>

<style>
body{
  font-family:system-ui, Arial;
  background:#f4f6f9;
  margin:0;
  padding:16px;
}
.card{
  background:#fff;
  border-radius:14px;
  padding:16px;
  margin-bottom:14px;
  box-shadow:0 10px 25px rgba(0,0,0,.1);
}
h2{margin-top:0}
button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:10px;
  background:#2563eb;
  color:#fff;
  font-size:18px;
  cursor:pointer;
}
input{
  width:100%;
  padding:12px;
  font-size:16px;
  margin-bottom:10px;
}
video,canvas{
  width:100%;
  border-radius:10px;
  border:1px solid #ddd;
}
.hidden{display:none}
.note{
  font-size:14px;
  color:#555;
}
</style>
</head>

<body>

<div class="card">
  <h2>1ï¸âƒ£ ×¦×™×œ×•× ×©×¨×˜×•×˜ (××¦×œ××” ××—×•×¨×™×ª)</h2>
  <video id="video" autoplay playsinline></video>
  <canvas id="photo" class="hidden"></canvas>
  <br><br>
  <button onclick="takePhoto()">ğŸ“¸ ×¦×œ× ×©×¨×˜×•×˜</button>
  <p class="note">×”××¦×œ××” ×”××—×•×¨×™×ª × × ×¢×œ×ª ××•×˜×•××˜×™×ª</p>
</div>

<div class="card hidden" id="edgesCard">
  <h2>2ï¸âƒ£ ×–×™×”×•×™ ×¦×œ×¢×•×ª</h2>
  <canvas id="edges"></canvas>
  <p id="edgesInfo"></p>
</div>

<div class="card hidden" id="inputsCard">
  <h2>3ï¸âƒ£ ×”×–×Ÿ ××™×“×•×ª ×‘×¡×´×</h2>
  <div id="inputs"></div>
  <button onclick="buildShape()">ğŸ“ ×‘× ×” ×©×¨×˜×•×˜</button>
</div>

<div class="card hidden" id="resultCard">
  <h2>4ï¸âƒ£ ×©×¨×˜×•×˜ ×¡×•×¤×™</h2>
  <canvas id="result"></canvas>
</div>

<script>
let video = document.getElementById("video");
let photo = document.getElementById("photo");
let edgesCanvas = document.getElementById("edges");
let resultCanvas = document.getElementById("result");

let detectedCorners = [];

/* =========================
   CAMERA â€“ REAR ONLY
   ========================= */
navigator.mediaDevices.getUserMedia({
  video: {
    facingMode: { exact: "environment" },
    width: { ideal: 1920 },
    height: { ideal: 1080 }
  }
})
.then(stream => {
  video.srcObject = stream;
})
.catch(err => {
  alert("×œ× × ×™×ª×Ÿ ×œ×¤×ª×•×— ××¦×œ××” ××—×•×¨×™×ª. ×•×“× ×©×”×“×£ × ×˜×¢×Ÿ ×-HTTPS (GitHub Pages).");
});

/* =========================
   TAKE PHOTO
   ========================= */
function takePhoto(){
  photo.width = video.videoWidth;
  photo.height = video.videoHeight;
  photo.getContext("2d").drawImage(video, 0, 0);
  detectShape();
}

/* =========================
   DETECT EDGES & CORNERS
   ========================= */
function detectShape(){
  let src = cv.imread(photo);
  let gray = new cv.Mat();
  let blur = new cv.Mat();
  let edges = new cv.Mat();

  cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
  cv.GaussianBlur(gray, blur, new cv.Size(5,5), 0);
  cv.Canny(blur, edges, 50, 150);

  let contours = new cv.MatVector();
  let hierarchy = new cv.Mat();
  cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

  let biggest = null;
  let maxArea = 0;

  for(let i=0;i<contours.size();i++){
    let cnt = contours.get(i);
    let area = cv.contourArea(cnt);
    if(area > maxArea){
      maxArea = area;
      biggest = cnt;
    }
  }

  if(!biggest){
    alert("×œ× ×–×•×”×ª×” ×¦×•×¨×” ×¡×’×•×¨×”");
    return;
  }

  let approx = new cv.Mat();
  cv.approxPolyDP(biggest, approx, 12, true);

  detectedCorners = [];
  for(let i=0;i<approx.rows;i++){
    detectedCorners.push({
      x: approx.intPtr(i,0)[0],
      y: approx.intPtr(i,0)[1]
    });
  }

  cv.imshow(edgesCanvas, edges);
  document.getElementById("edgesCard").classList.remove("hidden");
  document.getElementById("edgesInfo").innerText =
    `×–×•×”×• ${detectedCorners.length} ×¦×œ×¢×•×ª`;

  buildInputs(detectedCorners.length);

  src.delete(); gray.delete(); blur.delete(); edges.delete();
  contours.delete(); hierarchy.delete(); approx.delete();
}

/* =========================
   BUILD INPUTS
   ========================= */
function buildInputs(n){
  let box = document.getElementById("inputs");
  box.innerHTML = "";
  for(let i=0;i<n;i++){
    let input = document.createElement("input");
    input.type = "number";
    input.placeholder = `××•×¨×š ×¦×œ×¢ ${i+1} ×‘×¡×´×`;
    box.appendChild(input);
  }
  document.getElementById("inputsCard").classList.remove("hidden");
}

/* =========================
   DRAW FINAL SHAPE
   ========================= */
function buildShape(){
  let values = [...document.querySelectorAll("#inputs input")]
    .map(i => Number(i.value));

  if(values.some(v => !v || v <= 0)){
    alert("×× × ×”×–×Ÿ ××™×“×•×ª ×ª×§×™× ×•×ª ×‘×¡×´×");
    return;
  }

  let ctx = resultCanvas.getContext("2d");
  resultCanvas.width = 600;
  resultCanvas.height = 400;
  ctx.clearRect(0,0,600,400);

  let scale = 480 / Math.max(...values);
  let x = 60, y = 60;
  let angle = 0;

  ctx.beginPath();
  ctx.moveTo(x,y);

  for(let len of values){
    let L = len * scale;
    x += Math.cos(angle) * L;
    y += Math.sin(angle) * L;
    ctx.lineTo(x,y);
    angle += Math.PI/2; // ×¤× ×™×•×ª 90Â°
  }

  ctx.closePath();
  ctx.strokeStyle = "#2563eb";
  ctx.lineWidth = 2;
  ctx.stroke();

  document.getElementById("resultCard").classList.remove("hidden");
}
</script>

</body>
</html>
