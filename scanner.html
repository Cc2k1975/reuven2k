<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>住专拽 住 Pro - 转拽 </title>
    <script src="https://docs.opencv.org/4.7.0/opencv.js" async></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; }
        body { font-family: system-ui, -apple-system, sans-serif; background: #000; color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        #debug-log { position: fixed; top: 0; left: 0; right: 0; background: rgba(0,0,0,0.8); color: #0f0; font-size: 10px; z-index: 1000; pointer-events: none; padding: 5px; max-height: 50px; overflow: hidden; }
        
        .viewport { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; background: #111; }
        video, canvas { max-width: 100%; max-height: 100%; display: block; }
        #outputCanvas { display: none; }

        .controls { padding: 25px; background: #1a1a1a; display: flex; flex-direction: column; align-items: center; gap: 15px; border-top: 1px solid #333; }
        
        .main-btn { width: 80px; height: 80px; background: white; border-radius: 50%; border: 6px solid #444; cursor: pointer; display: flex; align-items: center; justify-content: center; outline: none; }
        .main-btn:active { transform: scale(0.9); }
        .main-btn-inner { width: 60px; height: 60px; border-radius: 50%; border: 2px solid #000; background: white; }

        .btn-row { display: none; gap: 10px; width: 100%; }
        .action-btn { flex: 1; padding: 15px; border-radius: 12px; border: none; font-weight: bold; font-size: 16px; cursor: pointer; color: white; }
        .btn-send { background: var(--success); }
        .btn-reset { background: #444; }

        .status-msg { font-size: 14px; color: #bbb; margin-bottom: 10px; }
        
        /* 住 注 */
        #loader { position: fixed; inset: 0; background: #000; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #222; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="debug-log">Log:  -OpenCV...</div>

<div id="loader">
    <div class="spinner"></div>
    <p>注 注专转 住专拽 ...</p>
    <small id="loader-status">注 住驻专转 (OpenCV)...</small>
</div>

<div class="viewport">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="outputCanvas"></canvas>
</div>

<div class="controls">
    <div id="status" class="status-msg"> 转 注...</div>
    
    <div id="scan-ui">
        <button class="main-btn" onclick="takeSnapshot()">
            <div class="main-btn-inner"></div>
        </button>
    </div>

    <div id="result-ui" class="btn-row">
        <button class="action-btn btn-reset" onclick="location.reload()"> </button>
        <button class="action-btn btn-send" onclick="sharePDF()"> 砖 PDF</button>
    </div>
</div>

<script>
    const log = (msg) => { 
        console.log(msg); 
        document.getElementById('debug-log').innerText = "Log: " + msg; 
    };

    const video = document.getElementById('video');
    const canvas = document.getElementById('outputCanvas');
    const status = document.getElementById('status');

    // 拽 转 OpenCV 
    var cvReady = false;
    window.onload = () => {
        let checkCV = setInterval(() => {
            if (typeof cv !== 'undefined' && cv.Mat) {
                clearInterval(checkCV);
                cvReady = true;
                log("OpenCV !");
                document.getElementById('loader').style.display = 'none';
                status.innerText = "爪 转 住 抓 注 爪";
                startCamera();
            }
        }, 500);
    };

    async function startCamera() {
        try {
            log("住 驻转 爪...");
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: {ideal: 1280}, height: {ideal: 720} } 
            });
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                video.play();
                log(" 驻注: " + video.videoWidth + "x" + video.videoHeight);
            };
        } catch (err) {
            log("砖转 爪: " + err.message);
            alert(" 转 砖转 爪.  砖转 -HTTPS");
        }
    }

    function takeSnapshot() {
        if (!cvReady) {
            alert("住专拽 注 注, 转  砖转...");
            return;
        }

        try {
            log("转 注...");
            const width = video.videoWidth;
            const height = video.videoHeight;
            
            if (width === 0 || height === 0) {
                throw new Error(" 注   ( 0)");
            }

            // 爪专转 专爪 
            let src = new cv.Mat(height, width, cv.CV_8UC4);
            let cap = new cv.VideoCapture(video);
            cap.read(src);

            // 注 住住
            let dst = processScanner(src);
            
            cv.imshow('outputCanvas', dst);

            // 驻转 转爪
            video.style.display = 'none';
            canvas.style.display = 'block';
            document.getElementById('scan-ui').style.display = 'none';
            document.getElementById('result-ui').style.display = 'flex';
            status.innerText = "住专拽 砖!";
            
            src.delete(); dst.delete();
        } catch (err) {
            log("砖转 注: " + err.message);
            alert("砖 注 转: " + err.message);
        }
    }

    function processScanner(src) {
        let dst = new cv.Mat();
        let gray = new cv.Mat();
        
        // 专 砖专   拽爪转
        cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
        cv.GaussianBlur(gray, gray, new cv.Size(5, 5), 0);
        cv.Canny(gray, gray, 75, 200);

        let contours = new cv.MatVector();
        let hierarchy = new cv.Mat();
        cv.findContours(gray, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

        let maxArea = 0;
        let bestCnt = null;

        for (let i = 0; i < contours.size(); ++i) {
            let cnt = contours.get(i);
            let area = cv.contourArea(cnt);
            if (area > 5000) {
                let peri = cv.arcLength(cnt, true);
                let approx = new cv.Mat();
                cv.approxPolyDP(cnt, approx, 0.02 * peri, true);
                if (approx.rows == 4 && area > maxArea) {
                    maxArea = area;
                    bestCnt = approx;
                }
            }
        }

        if (bestCnt) {
            log("祝 ! 爪注 砖专...");
            // 砖专 驻专住驻拽 (专住 拽爪专转 爪专 爪转)
            let result = new cv.Mat();
            cv.cvtColor(src, result, cv.COLOR_RGBA2GRAY);
            cv.adaptiveThreshold(result, result, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 11, 10);
            return result;
        } else {
            log("  祝 专专, 专 爪 专");
            return src;
        }
    }

    async function sharePDF() {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        const imgData = canvas.toDataURL('image/jpeg', 0.8);
        
        // 转转 转 -PDF
        pdf.addImage(imgData, 'JPEG', 0, 0, 210, 297);
        const pdfBlob = pdf.output('blob');
        const file = new File([pdfBlob], "scan.pdf", { type: "application/pdf" });

        if (navigator.share) {
            try {
                await navigator.share({
                    files: [file],
                    title: '住专拽 砖',
                });
            } catch (err) { log("砖转祝 "); }
        } else {
            pdf.save("scan.pdf");
        }
    }
</script>

</body>
</html>
