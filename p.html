<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>×›×¡×¤×ª ×¡×™×¡×××•×ª</title>

  <style>
    body{
      margin:0;
      font-family:system-ui,"Heebo","Arial",sans-serif;
      background:#e9eef5;
      padding:20px;
    }
    .card{
      max-width:460px;
      margin:0 auto;
      background:#fff;
      padding:22px;
      border-radius:16px;
      box-shadow:0 10px 22px rgba(0,0,0,0.15);
    }
    h2{
      margin:0 0 10px;
      text-align:center;
      color:#111827;
      font-size:22px;
    }
    input,textarea,button{
      width:100%;
      padding:11px;
      margin-top:10px;
      border-radius:10px;
      border:1px solid #cbd5e1;
      font-size:15px;
      box-sizing:border-box;
    }
    textarea{
      resize:vertical;
      min-height:70px;
    }
    button{
      background:#2563eb;
      color:#fff;
      border:none;
      cursor:pointer;
      font-weight:600;
    }
    button:hover{
      background:#1d4ed8;
    }
    .btn-secondary{
      background:#e5e7eb;
      color:#111827;
      border:1px solid #cbd5e1;
    }
    .btn-secondary:hover{
      background:#d1d5db;
    }
    #addSection,#searchSection,#mainMenu{
      display:none;
    }
    .result{
      background:#f3f4ff;
      padding:10px;
      border-radius:10px;
      margin-top:10px;
      font-size:14px;
    }
    .label{
      font-weight:600;
      color:#111827;
    }
    .status{
      margin-top:8px;
      font-size:13px;
      text-align:right;
      min-height:16px;
    }
    .status.ok{color:#166534;}
    .status.err{color:#b91c1c;}
    .btn-small{
      width:auto;
      display:inline-block;
      margin-top:8px;
      padding:5px 10px;
      font-size:12px;
      border-radius:999px;
    }
  </style>
</head>

<body>

  <!-- ××¡×š ×›× ×™×¡×” -->
  <div class="card" id="loginSection">
    <h2>×›× ×™×¡×” ×œ×›×¡×¤×ª</h2>
    <input type="password" id="masterPass" placeholder="×¡×™×¡××ª ×××¡×˜×¨">
    <button id="btnLogin">×”×›× ×¡</button>
    <div id="loginStatus" class="status"></div>
  </div>

  <!-- ×ª×¤×¨×™×˜ ×¨××©×™ -->
  <div class="card" id="mainMenu">
    <h2>×›×¡×¤×ª ×¡×™×¡×××•×ª</h2>
    <button id="btnShowAdd">â• ×”×•×¡×£ ×¡×™×¡××”</button>
    <button id="btnShowSearch">ğŸ” ×—×™×¤×•×©</button>
    <div class="status" id="menuStatus"></div>
  </div>

  <!-- ×”×•×¡×¤×” / ×¢×¨×™×›×” -->
  <div class="card" id="addSection">
    <h2 id="addTitle">×”×•×¡×£ ×¡×™×¡××”</h2>
    <input id="service" placeholder="×©× ×”×©×™×¨×•×ª">
    <input id="url" placeholder="×›×ª×•×‘×ª ××ª×¨">
    <input id="user" placeholder="×©× ××©×ª××©">
    <input id="pass" placeholder="×¡×™×¡××”">
    <input id="email" placeholder="××™××™×™×œ ×©×—×–×•×¨">
    <input id="phone" placeholder="×˜×œ×¤×•×Ÿ ×©×—×–×•×¨">
    <textarea id="notes" placeholder="×”×¢×¨×•×ª"></textarea>

    <button id="btnSave">×©××•×¨</button>
    <button class="btn-secondary" id="btnBackFromAdd">×—×–×•×¨</button>
    <div id="addStatus" class="status"></div>
  </div>

  <!-- ×—×™×¤×•×© -->
  <div class="card" id="searchSection">
    <h2>×—×™×¤×•×©</h2>
    <input id="searchInput" placeholder="×”×§×œ×“ ×œ×—×™×¤×•×© (×©× ×©×™×¨×•×ª / ××©×ª××© / ××ª×¨ / ×”×¢×¨×•×ª)...">
    <div id="results"></div>
    <button class="btn-secondary" id="btnBackFromSearch">×—×–×•×¨</button>
    <div id="searchStatus" class="status"></div>
  </div>

  <!-- crypto-js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

  <!-- Firebase + ×œ×•×’×™×§×” -->
  <script type="module">
    // ×§×•× ×¤×™×’×•×¨×¦×™×™×ª Firebase ×©×œ×š
    const firebaseConfig = {
      apiKey: "AIzaSyBYdxUWldY4AptA9g826alHQ__vRcKA3Vc",
      authDomain: "pass-b0ac7.firebaseapp.com",
      projectId: "pass-b0ac7",
      storageBucket: "pass-b0ac7.firebasestorage.app",
      messagingSenderId: "322974091258",
      appId: "1:322974091258:web:0e07c2f7807aaf1f18c643",
      measurementId: "G-Y7L66NW54W"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDocs,
      collection
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const app   = initializeApp(firebaseConfig);
    const db    = getFirestore(app);

    let MASTER = "";
    let DATA   = [];      // {id, service, ...}
    let EDIT_ID = null;   // null = ×”×•×¡×¤×”, ××—×¨×ª ×¢×¨×™×›×”

    const loginSection   = document.getElementById("loginSection");
    const mainMenu       = document.getElementById("mainMenu");
    const addSection     = document.getElementById("addSection");
    const searchSection  = document.getElementById("searchSection");

    const masterPass     = document.getElementById("masterPass");
    const loginStatus    = document.getElementById("loginStatus");
    const menuStatus     = document.getElementById("menuStatus");
    const addStatus      = document.getElementById("addStatus");
    const searchStatus   = document.getElementById("searchStatus");

    const addTitle       = document.getElementById("addTitle");

    const serviceInput   = document.getElementById("service");
    const urlInput       = document.getElementById("url");
    const userInput      = document.getElementById("user");
    const passInput      = document.getElementById("pass");
    const emailInput     = document.getElementById("email");
    const phoneInput     = document.getElementById("phone");
    const notesInput     = document.getElementById("notes");

    const searchInput    = document.getElementById("searchInput");
    const resultsDiv     = document.getElementById("results");

    function setStatus(elem, msg, ok=true){
      elem.textContent = msg || "";
      elem.className = "status " + (ok ? "ok" : "err");
    }

    function showOnly(id){
      loginSection.style.display  = (id==="login") ? "block" : "none";
      mainMenu.style.display      = (id==="menu")  ? "block" : "none";
      addSection.style.display    = (id==="add")   ? "block" : "none";
      searchSection.style.display = (id==="search")? "block" : "none";
    }

    // ×›× ×™×¡×”
    document.getElementById("btnLogin").onclick = async () => {
      const pwd = masterPass.value.trim();
      if(!pwd){
        setStatus(loginStatus,"×—×•×‘×” ×œ×”×›× ×™×¡ ×¡×™×¡××ª ×××¡×˜×¨.",false);
        return;
      }
      MASTER = pwd;
      setStatus(loginStatus,"×˜×•×¢×Ÿ × ×ª×•× ×™× ××”×©×¨×ª...",true);

      try{
        const snap = await getDocs(collection(db,"vault"));
        DATA = [];
        snap.forEach(d => {
          const id = d.id;
          const data = d.data();
          if(!data.blob) return; // ×œ×“×œ×’ ×¢×œ init ×•×›×“×•××”

          try{
            const bytes = CryptoJS.AES.decrypt(data.blob, MASTER);
            const text  = bytes.toString(CryptoJS.enc.Utf8);
            if(!text) return;

            const obj = JSON.parse(text);
            obj.id = id;
            DATA.push(obj);
          }catch(e){
            // ×× ×œ× ××¤×•×¢× ×— â€“ ××ª×¢×œ××™×
          }
        });

        setStatus(loginStatus,"",true);
        masterPass.value = "";
        setStatus(menuStatus,"×˜×¢×™× ×” ×”×¡×ª×™×™××”. × ××¦××• " + DATA.length + " ×¤×¨×™×˜×™×.",true);
        showOnly("menu");
      }catch(err){
        console.error(err);
        setStatus(loginStatus,"×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™× ××”×©×¨×ª.",false);
      }
    };

    // ××¢×‘×¨ ×œ×”×•×¡×¤×”
    document.getElementById("btnShowAdd").onclick = () => {
      EDIT_ID = null;
      addTitle.textContent = "×”×•×¡×£ ×¡×™×¡××”";
      clearAddForm();
      setStatus(addStatus,"",true);
      showOnly("add");
    };

    // ××¢×‘×¨ ×œ×—×™×¤×•×©
    document.getElementById("btnShowSearch").onclick = () => {
      searchInput.value = "";
      resultsDiv.innerHTML = "";
      setStatus(searchStatus,"",true);
      showOnly("search");
    };

    // ×—×–×¨×” ×œ×ª×¤×¨×™×˜
    document.getElementById("btnBackFromAdd").onclick = () => {
      showOnly("menu");
    };
    document.getElementById("btnBackFromSearch").onclick = () => {
      showOnly("menu");
    };

    function clearAddForm(){
      serviceInput.value = "";
      urlInput.value     = "";
      userInput.value    = "";
      passInput.value    = "";
      emailInput.value   = "";
      phoneInput.value   = "";
      notesInput.value   = "";
    }

    // ×©××™×¨×” (×—×“×© ××• ×¢×¨×™×›×”)
    document.getElementById("btnSave").onclick = async () => {
      if(!MASTER){
        setStatus(addStatus,"××™×Ÿ ×¡×™×¡××ª ×××¡×˜×¨ ×¤×¢×™×œ×”. ×”×ª×—×‘×¨ ××—×“×©.",false);
        return;
      }

      const obj = {
        service: serviceInput.value.trim(),
        url:     urlInput.value.trim(),
        user:    userInput.value.trim(),
        pass:    passInput.value.trim(),
        email:   emailInput.value.trim(),
        phone:   phoneInput.value.trim(),
        notes:   notesInput.value.trim()
      };

      if(!obj.service && !obj.user && !obj.pass){
        setStatus(addStatus,"××œ× ×œ×¤×—×•×ª ×©× ×©×™×¨×•×ª / ×©× ××©×ª××© / ×¡×™×¡××”.",false);
        return;
      }

      try{
        const json = JSON.stringify(obj);
        const enc  = CryptoJS.AES.encrypt(json, MASTER).toString();

        const id = EDIT_ID ? EDIT_ID : ("rec_" + Date.now());
        await setDoc(doc(db,"vault",id), { blob: enc });

        if(EDIT_ID){
          const idx = DATA.findIndex(x => x.id === EDIT_ID);
          if(idx !== -1){
            obj.id = EDIT_ID;
            DATA[idx] = obj;
          }
        }else{
          obj.id = id;
          DATA.push(obj);
        }

        setStatus(addStatus,"× ×©××¨ ×‘×©×¨×ª ×‘×”×¦×œ×—×”.",true);
        EDIT_ID = null;
        setTimeout(() => {
          showOnly("menu");
          setStatus(menuStatus,"×”×¤×¨×™×˜ × ×©××¨ ×‘×©×¨×ª.",true);
        }, 800);

      }catch(err){
        console.error(err);
        setStatus(addStatus,"×©×’×™××” ×‘×©××™×¨×” ×œ×©×¨×ª.",false);
      }
    };

    // ×—×™×¤×•×©
    searchInput.oninput = () => {
      const q = searchInput.value.trim().toLowerCase();
      resultsDiv.innerHTML = "";
      if(!q){
        setStatus(searchStatus,"",true);
        return;
      }

      let count = 0;
      DATA.forEach(item => {
        const text = (item.service||"") + " " +
                     (item.user||"")    + " " +
                     (item.url||"")     + " " +
                     (item.notes||"");
        if(text.toLowerCase().includes(q)){
          count++;
          const div = document.createElement("div");
          div.className = "result";
          div.innerHTML = `
            <div><span class="label">×©×™×¨×•×ª:</span> ${item.service||""}</div>
            <div><span class="label">××©×ª××©:</span> ${item.user||""}</div>
            <div><span class="label">×¡×™×¡××”:</span> ${item.pass||""}</div>
            <div><span class="label">××™××™×™×œ:</span> ${item.email||""}</div>
            <div><span class="label">×˜×œ×¤×•×Ÿ:</span> ${item.phone||""}</div>
            <div><span class="label">×›×ª×•×‘×ª:</span> ${item.url||""}</div>
            <div><span class="label">×”×¢×¨×•×ª:</span> ${item.notes||""}</div>
            <button class="btn-small" data-id="${item.id}">×¢×¨×•×š ×¤×¨×™×˜ ×–×”</button>
          `;
          resultsDiv.appendChild(div);
        }
      });

      if(count === 0){
        setStatus(searchStatus,"×œ× × ××¦××• ×ª×•×¦××•×ª.",false);
      }else{
        setStatus(searchStatus,"× ××¦××• " + count + " ×ª×•×¦××•×ª.",true);
      }

      const buttons = resultsDiv.querySelectorAll("button[data-id]");
      buttons.forEach(btn => {
        btn.onclick = () => {
          const id = btn.getAttribute("data-id");
          editItem(id);
        };
      });
    };

    // ×¢×¨×™×›×” ××ª×•×š ×”×—×™×¤×•×©
    function editItem(id){
      const item = DATA.find(x => x.id === id);
      if(!item) return;

      EDIT_ID = id;
      addTitle.textContent = "×¢×¨×™×›×ª ×¡×™×¡××”";

      serviceInput.value = item.service || "";
      urlInput.value     = item.url     || "";
      userInput.value    = item.user    || "";
      passInput.value    = item.pass    || "";
      emailInput.value   = item.email   || "";
      phoneInput.value   = item.phone   || "";
      notesInput.value   = item.notes   || "";

      setStatus(addStatus,"××¦×‘ ×¢×¨×™×›×”. ×œ××—×¨ ×©××™×¨×” ×”×¤×¨×™×˜ ×™×¢×•×“×›×Ÿ ×‘×©×¨×ª.",true);
      showOnly("add");
    }

    showOnly("login");
  </script>
</body>
</html>
