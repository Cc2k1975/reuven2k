<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>×¤×Ÿ ××§×¡×¤×¨×¡ â€“ ×§×‘×™×¢×ª ×ª×•×¨</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#d4af37">
<link rel="apple-touch-icon" href="/Icon app.png" />

<style>
Â  body {
Â  Â  font-family: Arial, Helvetica, sans-serif;
Â  Â  background: #000;
Â  Â  margin: 0;
Â  Â  padding: 0;
Â  Â  color: #d4af37;
Â  }

Â  .hero-logo {
Â  Â  width: 92px;
Â  Â  display: block;
Â  Â  margin: -6px auto -12px auto;
Â  }

Â  .wrap {
Â  Â  max-width: 520px;
Â  Â  margin: 4px auto;
Â  Â  padding: 20px 24px 24px;
Â  Â  background: #111;
Â  Â  border-radius: 16px;
Â  Â  box-shadow: 0 6px 18px rgba(255, 215, 0, 0.25);
Â  }

Â  h1 {
Â  Â  margin: 0 0 4px;
Â  Â  font-size: 33px;
Â  Â  color: #ffd700;
Â  Â  text-align: center;
Â  }

Â  h2 {
Â  Â  margin: 0 0 16px;
Â  Â  font-size: 20.7px;
Â  Â  color: #d4af37;
Â  Â  text-align: center;
Â  }

Â  label {
Â  Â  display: block;
Â  Â  margin: 12px 4px 5px;
Â  Â  font-weight: 600;
Â  Â  color: #ffd700;
Â  Â  font-size: 16.6px;
Â  }

Â  input, select, button {
Â  Â  width: 100%;
Â  Â  padding: 12px 14px;
Â  Â  border: 1px solid #d4af37;
Â  Â  border-radius: 10px;
Â  Â  font-size: 16.6px;
Â  Â  box-sizing: border-box;
Â  Â  background: #222;
Â  Â  color: #ffd700;
Â  }

Â  input[type="tel"] { text-align: right; }

Â  .btn {
Â  Â  background: #d4af37;
Â  Â  color: #000;
Â  Â  border: 0;
Â  Â  cursor: pointer;
Â  Â  margin-top: 16px;
Â  Â  font-weight: 700;
Â  Â  font-size: 16.6px;
Â  }

Â  .btn[disabled] { opacity: .6; cursor: not-allowed; }

Â  .btn-secondary {
Â  Â  background: #000;
Â  Â  color: #ffd700;
Â  Â  border: 1px solid #d4af37;
Â  Â  margin-top: 9px;
Â  Â  font-size: 14.5px;
Â  Â  padding: 10px;
Â  }

Â  .btn-secondary img.icon {
Â  Â  width: 26.4px;
Â  Â  height: 26.4px;
Â  Â  vertical-align: middle;
Â  Â  margin: 0 6px;
Â  }

Â  .error {
Â  Â  background: #330000;
Â  Â  color: #ff6666;
Â  Â  border: 1px solid #ff9999;
Â  Â  padding: 9px;
Â  Â  border-radius: 10px;
Â  Â  margin-top: 9px;
Â  Â  display: none;
Â  Â  font-size: 15px;
Â  }

Â  .success {
Â  Â  background: #003300;
Â  Â  color: #66ff99;
Â  Â  border: 1px solid #99ffcc;
Â  Â  padding: 9px;
Â  Â  border-radius: 10px;
Â  Â  margin-top: 9px;
Â  Â  display: none;
Â  Â  font-size: 15px;
Â  }

Â  option.taken { color: #888; background: #333; }

Â  .ver {
Â  Â  margin-top: 14px;
Â  Â  font-size: 12.4px;
Â  Â  color: #bfa76f;
Â  Â  text-align: center;
Â  }

Â  .modal-backdrop {
Â  Â  position: fixed;
Â  Â  inset: 0;
Â  Â  background: rgba(0,0,0,.85);
Â  Â  display: none;
Â  Â  align-items: center;
Â  Â  justify-content: center;
Â  Â  z-index: 50;
Â  }

Â  .modal {
Â  Â  background: #111;
Â  Â  border-radius: 14px;
Â  Â  max-width: 420px;
Â  Â  width: 92%;
Â  Â  padding: 18px 18px 12px;
Â  Â  box-shadow: 0 0 25px rgba(255,215,0,.3);
Â  Â  color: #ffd700;
Â  }

Â  .modal h3 {
Â  Â  margin: 0 0 8px;
Â  Â  font-size: 20.7px;
Â  Â  color: #ffd700;
Â  }

Â  .modal p {
Â  Â  margin: 0 0 14px;
Â  Â  color: #ffd700;
Â  Â  white-space: pre-line;
Â  Â  font-size: 15px;
Â  }

Â  .modal .row {
Â  Â  display: flex;
Â  Â  gap: 10px;
Â  Â  justify-content: space-between;
Â  }

Â  .modal .row button {
Â  Â  flex: 1;
Â  Â  padding: 10px;
Â  Â  border-radius: 10px;
Â  Â  border: 0;
Â  Â  font-weight: 700;
Â  Â  font-size: 15px;
Â  }

Â  .modal .cancel {
Â  Â  background: #222;
Â  Â  color: #ffd700;
Â  Â  border: 1px solid #ffd700;
Â  }

Â  .modal .ok {
Â  Â  background: #ffd700;
Â  Â  color: #000;
Â  }

Â  /* ******* CSS ×—×“×© ×¢×‘×•×¨ ×›×¤×ª×•×¨ ×”×”×ª×§× ×” ******* */
Â  #pwaInstallBtn {
Â  Â  position: fixed;
Â  Â  inset: 50% auto auto 50%;
Â  Â  transform: translate(-50%, -50%);
Â  Â  width: 150px;
Â  Â  height: 150px;
Â  Â  border-radius: 9999px;
Â  Â  background: #e53935; /* ×¢×™×’×•×œ ××“×•× */
Â  Â  color: #fff;
Â  Â  font-weight: 800;
Â  Â  font-size: 16px;
Â  Â  line-height: 1.2;
Â  Â  text-align: center;
Â  Â  padding: 16px;
Â  Â  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.45);
Â  Â  z-index: 99999;
Â  Â  border: 0;
Â  Â  cursor: pointer;
Â  Â  display: none; /* × ×¡×ª×¨ ×¢×“ ×©×”-JS ××¦×™×’ ××•×ª×• */
Â  }

Â  #pwaInstallHint {
Â  Â  position: fixed;
Â  Â  left: 50%;
Â  Â  top: calc(50% + 110px);
Â  Â  transform: translateX(-50%);
Â  Â  color: #ffd700;
Â  Â  font-size: 14px;
Â  Â  font-family: Arial, Helvetica, sans-serif;
Â  Â  z-index: 99999;
Â  Â  text-align: center;
Â  Â  pointer-events: none;
Â  Â  display: none; /* × ×¡×ª×¨ ×¢×“ ×©×”-JS ××¦×™×’ ××•×ª×• */
Â  }
Â  /* ******************************************* */
</style>
</head>
<body>

Â  <img src="https://reuven2k.com/exe.gif" alt="×¤×Ÿ ××§×¡×¤×¨×¡" class="hero-logo" />

Â  <div class="wrap">
Â  Â  <h1>×¤×Ÿ ××§×¡×¤×¨×¡</h1>
Â  Â  <h2>××¢×¨×›×ª ×œ×–×™××•×Ÿ ×ª×•×¨×™×</h2>

Â  Â  <div id="msgError" class="error"></div>
Â  Â  <div id="msgOk" class="success"></div>

Â  Â  <label for="date">×‘×—×¨×™ ×ª××¨×™×š:</label>
Â  Â  <input type="date" id="date" required />

Â  Â  <label for="time">×‘×—×¨×™ ×©×¢×” ×¤× ×•×™×”:</label>
Â  Â  <select id="time" required>
Â  Â  Â  <option value="">×˜×•×¢×Ÿ ×©×¢×•×ªâ€¦</option>
Â  Â  </select>

Â  Â  <label for="name">×©× ×”×œ×§×•×—×”:</label>
Â  Â  <input type="text" id="name" placeholder="×”×›× ×¡ ×©×" required />

Â  Â  <label for="phone">××¡×¤×¨ ×˜×œ×¤×•×Ÿ:</label>
Â  Â  <input type="tel" id="phone" placeholder="×”×›× ×¡ ×˜×œ×¤×•×Ÿ" required />

Â  Â  <button id="save" class="btn">×©××•×¨</button>

Â  Â  <button id="galleryBtn" type="button" class="btn-secondary">
Â  Â  Â  <b>×’×œ×¨×™×™×ª ×¢×‘×•×“×•×ª</b>
Â  Â  </button>

Â  Â  <button id="navWaze" type="button" class="btn-secondary">
Â  Â  Â  <b>× ×•×•×˜ ×œ ×¤×Ÿ-××§×¡×¤×¨×¡</b>
Â  Â  Â  <img class="icon" src="https://reuven2k.com/map.png" alt="" />
Â  Â  </button>

Â  Â  <div class="ver">Version: 1.6.2</div>
Â  </div>

Â  <div id="icsModal" class="modal-backdrop" role="dialog" aria-modal="true">
Â  Â  <div class="modal">
Â  Â  Â  <h3>×œ×”×•×¡×™×£ ×ª×–×›×•×¨×ª ×œ×™×•××Ÿ?</h3>
Â  Â  Â  <p id="icsText">× ×™×¦×•×¨ ××™×¨×•×¢ ×œ×™×•××Ÿ ×‘×ª××¨×™×š ___ ×‘×©×¢×” ___ ×›×•×œ×œ ×ª×–×›×•×¨×ª ×©×¢×” ×œ×¤× ×™.
×œ×§×•×—×” ×™×§×¨×”, ××–×›×™×¨×” ×œ×š ×œ×”×’×™×¢ ×—×¤×•×¤×” ×•×‘×–××Ÿ ğŸ’‡â€â™€ï¸
×ª×•×“×” - ×¤×Ÿ ××§×¡×¤×¨×¡</p>
Â  Â  Â  <div class="row">
Â  Â  Â  Â  <button type="button" class="cancel" id="btnCancel">×‘×™×˜×•×œ</button>
Â  Â  Â  Â  <button type="button" class="ok" id="btnOk">××™×©×•×¨</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

<script>
const BIN_ID = '68f0e7bed0ea881f40a63b29';
const MASTER_KEY = '$2a$10$4rynniEMuvwqg2nDb5KSEe/lAVYp8a7L3xWzp9GsO6n49OfXc3FCO';
const BIN_URL = 'https://api.jsonbin.io/v3/b/' + BIN_ID;
const MAP_URL = 'https://maps.google.com/?q=33.003292,35.108864';
const WAZE_DEEP = 'waze://?ll=33.003292,35.108864&navigate=yes';
const WAZE_WEBÂ  = 'https://waze.com/ul?ll=33.003292%2C35.108864&navigate=yes';
const GALLERY_URL = 'https://reuven2k.com/images/index.html';
const TIMEZONE = 'Asia/Jerusalem';
const EVENT_TITLE = '×ª×•×¨ ×œ ×¤×Ÿ ××§×¡×¤×¨×¡';
const ALARM_MINUTES = 60;
const SLOT_MINUTES = 20;

const pad2 = n => (n<10?('0'+n):''+n);
function genTimeSlots(){
Â  const slots=[]; for(let h=8; h<=20; h++){ for(let m of [0,20,40]){ if(h===20 && m>0) continue; slots.push(`${pad2(h)}:${pad2(m)}`);} }
Â  return slots;
}
const SLOTS = genTimeSlots();

function todayStr(){ return new Date().toISOString().slice(0,10); }
function addDaysStr(days){ const d=new Date(); d.setDate(d.getDate()+days); return d.toISOString().slice(0,10); }
function setDateLimits(){ elDate.min=todayStr(); elDate.max=addDaysStr(3); if(!elDate.value) elDate.value=todayStr(); }
function fmtDateHeb(s){ const [y,m,d]=s.split('-'); return `${d}.${m}.${y}`; }

const elDate=document.getElementById('date');
const elTime=document.getElementById('time');
const elName=document.getElementById('name');
const elPhone=document.getElementById('phone');
const elSave=document.getElementById('save');
const msgErr=document.getElementById('msgError');
const msgOk=document.getElementById('msgOk');
const icsModal=document.getElementById('icsModal');
const btnOk=document.getElementById('btnOk');
const btnCancel=document.getElementById('btnCancel');
const icsText=document.getElementById('icsText');
const btnWaze=document.getElementById('navWaze');
const btnGallery=document.getElementById('galleryBtn');

btnGallery.addEventListener('click', ()=> window.location.href = GALLERY_URL);

function showErr(t){ msgErr.textContent=t; msgErr.style.display='block'; setTimeout(()=>msgErr.style.display='none',4000); }
function showOk(t){ msgOk.textContent=t; msgOk.style.display='block'; setTimeout(()=>msgOk.style.display='none',4000); }

setDateLimits();

/* === ×¡×˜×˜×•×¡ ×¤×ª×™×—×”/×¡×’×™×¨×” (×× ×§×™×™×) â€” ×œ×œ× ×©×™× ×•×™ ×œ×•×’×™×§×” ××—×¨×ª === */
let BOOKING_OPEN = true;
function setBookingEnabledState(isEnabled){
Â  elSave.disabled = !isEnabled;
}

async function fetchRecord(){
Â  const r=await fetch(BIN_URL+'?ts='+Date.now(),{headers:{'X-Master-Key':MASTER_KEY},cache:'no-store'});
Â  if(!r.ok) throw new Error('fetch failed');
Â  const j=await r.json();
Â  const rec = (j.record && Array.isArray(j.record.bookings))? j.record : {bookings:[]};
Â  BOOKING_OPEN = (typeof rec.bookingOpen === 'boolean') ? rec.bookingOpen : true;
Â  setBookingEnabledState(BOOKING_OPEN);
Â  return rec;
}
async function putRecord(rec){
Â  const r=await fetch(BIN_URL+'?ts='+Date.now(),{method:'PUT',headers:{'Content-Type':'application/json','X-Master-Key':'$2a$10$4rynniEMuvwqg2nDb5KSEe/lAVYp8a7L3xWzp9GsO6n49OfXc3FCO'},body:JSON.stringify(rec),cache:'no-store'});
Â  if(!r.ok) throw new Error('put failed');
Â  return r.json().catch(()=> ({}));
}

async function refreshTimes(){
Â  elTime.innerHTML = `<option value="">×˜×•×¢×Ÿâ€¦</option>`;
Â  try{
Â  Â  const {bookings}=await fetchRecord();
Â  Â  const date=elDate.value;

Â  Â  if(!BOOKING_OPEN){
Â  Â  Â  elTime.innerHTML = `<option value="">×‘×—×¨×™ ×©×¢×”â€¦</option>` + SLOTS.map(t=>`<option value="${t}" disabled class="taken">${t} â€“ ×ª×¤×•×¡</option>`).join('');
Â  Â  Â  return;
Â  Â  }

Â  Â  const taken=new Set(bookings.filter(b=>b.date===date).map(b=>b.time));
Â  Â  elTime.innerHTML = `<option value="">×‘×—×¨ ×©×¢×”â€¦</option>` + SLOTS.map(t=>{
Â  Â  Â  const isTaken=taken.has(t);
Â  Â  Â  return `<option value="${t}" ${isTaken?'disabled class="taken"':''}>${t}${isTaken?' â€“ ×ª×¤×•×¡':''}</option>`;
Â  Â  }).join('');
Â  }catch(e){ showErr('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×'); }
}
elDate.addEventListener('change',refreshTimes);
refreshTimes();

function validPhone(p){ return (p||'').replace(/\D/g,'').length>=8; }
function normalizePhone(p){ return (p||'').replace(/\D/g,''); }

/* ===== ×‘× ×™×™×ª ICS (×›×•×œ×œ VALARM ×©×œ 60 ×“×§×•×ª) ===== */
function toICSLocal(dateStr,timeStr){
Â  const [y,m,d]=dateStr.split('-').map(Number);
Â  const [hh,mm]=timeStr.split(':').map(Number);
Â  const dt=new Date(y,m-1,d,hh,mm,0);
Â  return `${dt.getFullYear()}${pad2(dt.getMonth()+1)}${pad2(dt.getDate())}T${pad2(dt.getHours())}${pad2(dt.getMinutes())}00`;
}
function buildICS({title,location,startLocal,endLocal,tzid}){
Â  const uid=`${Date.now()}-${Math.random().toString(36).slice(2)}@fenexpress`;
Â  const dtstamp=new Date().toISOString().replace(/[-:]/g,'').replace(/\.\d{3}Z$/,'Z');
Â  const details=`×§×™×©×•×¨ ×™×©×™×¨ ×œ×”×’×¢×” ×œ×¤×Ÿ ××§×¡×¤×¨×¡:\n${MAP_URL}`;
Â  return [
Â  Â  'BEGIN:VCALENDAR',
Â  Â  'VERSION:2.0',
Â  Â  'PRODID:-//FenExpress//Booking//HE',
Â  Â  'CALSCALE:GREGORIAN',
Â  Â  'METHOD:PUBLISH',
Â  Â  'BEGIN:VEVENT',
Â  Â  `UID:${uid}`,
Â  Â  `DTSTAMP:${dtstamp}`,
Â  Â  `DTSTART;TZID=${tzid}:${startLocal}`,
Â  Â  `DTEND;TZID=${tzid}:${endLocal}`,
Â  Â  `SUMMARY:${title}`,
Â  Â  `DESCRIPTION:${details.replace(/\n/g,'\\n')}`,
Â  Â  `LOCATION:${location}`,
Â  Â  'BEGIN:VALARM',
Â  Â  'ACTION:DISPLAY',
Â  Â  'DESCRIPTION:Reminder',
Â  Â  `TRIGGER:-PT${ALARM_MINUTES}M`,
Â  Â  'END:VALARM',
Â  Â  'END:VEVENT',
Â  Â  'END:VCALENDAR'
Â  ].join('\r\n');
}

/* ===== ×¤×ª×™×—×” ×™×©×™×¨×” ×©×œ ×”×™×•××Ÿ (Android=iCal Google, iOS=Calendar ×“×¨×š Blob) ===== */
function openCalendarDirect(dateStr,timeStr){
Â  const ua = navigator.userAgent || '';
Â  const isAndroid = /Android/i.test(ua);
Â  const isIOS = /iPhone|iPad|iPod/i.test(ua);

Â  const [y,m,d]=dateStr.split('-').map(Number);
Â  const [hh,mm]=timeStr.split(':').map(Number);
Â  const start=new Date(y,m-1,d,hh,mm,0);
Â  const end=new Date(start.getTime()+SLOT_MINUTES*60000);

Â  if(isAndroid){
Â  Â  const fmt = (dt)=>`${dt.getFullYear()}${pad2(dt.getMonth()+1)}${pad2(dt.getDate())}T${dt.getHours().toString().padStart(2,'0')}${dt.getMinutes().toString().padStart(2,'0')}00`;
Â  Â  const dates = `${fmt(start)}/${fmt(end)}`;
Â  Â  const text = encodeURIComponent(EVENT_TITLE);
Â  Â  const details = encodeURIComponent(`×§×™×©×•×¨ ×™×©×™×¨ ×œ×”×’×¢×” ×œ×¤×Ÿ ××§×¡×¤×¨×¡:\n${MAP_URL}\n(×ª×–×›×•×¨×ª 60 ×“×§×³ ×œ×¤× ×™)`);
Â  Â  const loc = encodeURIComponent(MAP_URL);
Â  Â  const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${dates}&details=${details}&location=${loc}`;
Â  Â  window.location.href = url;
Â  Â  return;
Â  }

Â  if(isIOS){
Â  Â  const startLocal=toICSLocal(dateStr,timeStr);
Â  Â  const endLocal=`${end.getFullYear()}${pad2(end.getMonth()+1)}${pad2(end.getDate())}T${pad2(end.getHours())}${pad2(end.getMinutes())}00`;
Â  Â  const ics = buildICS({title:EVENT_TITLE,location:MAP_URL,startLocal,endLocal,tzid:TIMEZONE});
Â  Â  const blob=new Blob([ics],{type:'text/calendar;charset=utf-8'});
Â  Â  const url=URL.createObjectURL(blob);
Â  Â  window.location.href = url;
Â  Â  setTimeout(()=>URL.revokeObjectURL(url), 4000);
Â  Â  return;
Â  }

Â  const fmt = (dt)=>`${dt.getFullYear()}${pad2(dt.getMonth()+1)}${pad2(dt.getDate())}T${dt.getHours().toString().padStart(2,'0')}${dt.getMinutes().toString().padStart(2,'0')}00`;
Â  const dates = `${fmt(start)}/${fmt(end)}`;
Â  const text = encodeURIComponent(EVENT_TITLE);
Â  const details = encodeURIComponent(`×§×™×©×•×¨ ×™×©×™×¨ ×œ×”×’×¢×” ×œ×¤×Ÿ ××§×¡×¤×¨×¡:\n${MAP_URL}\n(×ª×–×›×•×¨×ª 60 ×“×§×³ ×œ×¤× ×™)`);
Â  const loc = encodeURIComponent(MAP_URL);
Â  const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${dates}&details=${details}&location=${loc}`;
Â  window.location.href = url;
}

document.getElementById('navWaze').addEventListener('click', ()=>{
Â  const start = Date.now();
Â  window.location.href = WAZE_DEEP;
Â  setTimeout(()=>{
Â  Â  if (Date.now() - start < 1200) {
Â  Â  Â  window.location.href = WAZE_WEB;
Â  Â  }
Â  }, 900);
});

let lastSavedPayload=null;
elSave.addEventListener('click',async ()=>{
Â  const payload={date:elDate.value,time:elTime.value,name:elName.value.trim(),phone:elPhone.value.trim()};
Â  if(!payload.date||!payload.time||!payload.name||!payload.phone){showErr('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª');return;}
Â  if(!validPhone(payload.phone)){showErr('××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×ª×§×™×Ÿ');return;}

Â  elSave.disabled=true;
Â  try{
Â  Â  let rec=await fetchRecord();
Â  Â  const normPhone=normalizePhone(payload.phone);
Â  Â  const existsSameDayPhone=rec.bookings.some(b=>b.date===payload.date && normalizePhone(b.phone)===normPhone);
Â  Â  if(existsSameDayPhone){showErr('×§×™×™× ×›×‘×¨ ×ª×•×¨ ×¢×œ ×©××š ×œ××•×ª×• ×™×•×. × × ×œ×‘×—×•×¨ ×ª××¨×™×š ××—×¨.'); elSave.disabled=false; await refreshTimes(); return;}
Â  Â  if(rec.bookings.some(b=>b.date===payload.date && b.time===payload.time)){showErr('×”×©×¢×” × ×ª×¤×¡×” ×”×¨×’×¢. ×‘×—×¨ ×©×¢×” ××—×¨×ª.'); elSave.disabled=false; await refreshTimes(); return;}

Â  Â  rec.bookings.push({date:payload.date,time:payload.time,name:payload.name,phone:payload.phone,ts:Date.now()});
Â  Â  await putRecord(rec);

Â  Â  lastSavedPayload=payload;
Â  Â  showOk('×”×ª×•×¨ × ×©××¨ ×‘×”×¦×œ×—×”!');
Â  Â  icsText.textContent=`× ×™×¦×•×¨ ××™×¨×•×¢ ×œ×™×•××Ÿ ×‘×ª××¨×™×š ${fmtDateHeb(payload.date)} ×‘×©×¢×” ${payload.time} ×›×•×œ×œ ×ª×–×›×•×¨×ª ×©×¢×” ×œ×¤× ×™.
×œ×§×•×—×” ×™×§×¨×”, ××–×›×™×¨×” ×œ×š ×œ×”×’×™×¢ ×—×¤×•×¤×” ×•×‘×–××Ÿ ğŸ’‡â€â™€ï¸
×ª×•×“×” - ×¤×Ÿ ××§×¡×¤×¨×¡`;

Â  Â  // ××¦×™×’×™× ××ª ×”××•×“××œ ×›××• ××¦×œ×š
Â  Â  icsModal.style.display='flex';

Â  Â  await new Promise(r=>setTimeout(r,300));
Â  Â  await refreshTimes();
Â  Â  elTime.value=""; elName.value=""; elPhone.value="";
Â  }catch(e){ showErr('×©×’×™××ª ×¨×©×ª'); }
Â  finally{ elSave.disabled=false; }
});

btnCancel.addEventListener('click',()=>{ icsModal.style.display='none'; });
btnOk.addEventListener('click',()=>{
Â  icsModal.style.display='none';
Â  if(!lastSavedPayload) return;
Â  // ×¤×ª×™×—×” ×™×©×™×¨×” ×©×œ ×”×™×•××Ÿ:
Â  openCalendarDirect(lastSavedPayload.date,lastSavedPayload.time);
});

/* PWA: ×¨×™×©×•× Service Worker (×œ×œ× ×©×™× ×•×™ ×œ×•×’×™×§×” ××—×¨×ª) */
if ('serviceWorker' in navigator) {
Â  navigator.serviceWorker.register('/sw.js').catch(()=>{});
}

/* ******* JS ×—×“×© ×¢×‘×•×¨ ×›×¤×ª×•×¨ ×”×”×ª×§× ×” (PWA Install Prompt) ******* */
let deferredPrompt = null;
const ua = navigator.userAgent || "";
const isIOS = /iPhone|iPad|iPod/i.test(ua);

// ×œ× ×œ×”×¦×™×§ ×©×•×‘ ×‘××•×ª×• ×‘×™×§×•×¨
if (!sessionStorage.getItem("pwaPromptShown")) {
Â  // × ×™×¦×•×¨ ××ª ×”××œ×× ×˜×™× ×©×¢×™×¦×‘× ×• ×‘-CSS
Â  const btn = document.createElement("button");
Â  btn.id = "pwaInstallBtn";
Â  btn.type = "button";
Â  btn.textContent = "×”×•×¡×£ ×œ××¡×š ×”×‘×™×ª";
Â  btn.style.display = "block"; // × ×¦×™×’ ××ª ×”×›×¤×ª×•×¨
Â  
Â  const hint = document.createElement("div");
Â  hint.id = "pwaInstallHint";
Â  hint.textContent = "×œ×—×™×¦×” ×ª×ª×§×™×Ÿ (××• ×ª×¦×™×’ ×”×•×¨××•×ª)";
Â  hint.style.display = "block"; // × ×¦×™×’ ××ª ×”×˜×™×¤
Â  
Â  document.body.appendChild(btn);
Â  document.body.appendChild(hint);

Â  // × ×©××•×¨ ×©×¡×™×× ×• â€“ ×©×œ× ×™×¦×•×¥ ×©×•×‘ ×¢×“ ×¨×¢× ×•×Ÿ
Â  sessionStorage.setItem("pwaPromptShown", "1");

Â  // × ×ª×¤×•×¡ ××ª beforeinstallprompt (×‘×× ×“×¨×•××™×“/×›×¨×•×)
Â  window.addEventListener("beforeinstallprompt", (e) => {
Â  Â  e.preventDefault();
Â  Â  deferredPrompt = e;
Â  });

Â  // ×”×ª× ×”×’×•×ª ×‘×¢×ª ×œ×—×™×¦×”
Â  btn.addEventListener("click", async () => {
Â  Â  // ×× ×™×© event ×××™×ª×™ â€“ × ×¦×™×’ ××ª ×—×œ×•×Ÿ ×”×”×ª×§× ×”
Â  Â  if (deferredPrompt) {
Â  Â  Â  try {
Â  Â  Â  Â  await deferredPrompt.prompt();
Â  Â  Â  Â  // ××—×¨×™ ×”×“×™××œ×•×’ â€“ ×œ× × ×©××•×¨ ×™×•×ª×¨ ××ª ×”-event
Â  Â  Â  Â  deferredPrompt = null;
Â  Â  Â  } catch (_) {}
Â  Â  } else if (isIOS) {
Â  Â  Â  // ××™×Ÿ ×ª××™×›×” ××•×‘× ×™×ª (iOS): × ×¦×™×’ ×”×¡×‘×¨ ×§×¦×¨
Â  Â  Â  alert(
Â  Â  Â  Â  "×‘-iPhone: ×œ×—×¦×• ×¢×œ ×›×¤×ª×•×¨ ×”×©×™×ª×•×£ (×”×¨×™×‘×•×¢ ×¢× ×”×—×¥) ×•××– '×”×•×¡×¤×” ×œ××¡×š ×”×‘×™×ª'."
Â  Â  Â  );
Â  Â  }
Â  Â  
Â  Â  // × ×¡×™×¨ ××ª ×”×›×¤×ª×•×¨ ××—×¨×™ ×œ×—×™×¦×”
Â  Â  try { btn.remove(); hint.remove(); } catch(_) {}
Â  });

Â  // ×”×•×ª×§×Ÿ ×‘×¤×•×¢×œ â€“ × ×¡×™×¨ ××ª ×”×›×¤×ª×•×¨ ×× ×¢×“×™×™×Ÿ ×§×™×™×
Â  window.addEventListener("appinstalled", () => {
Â  Â  try { btn.remove(); hint.remove(); } catch(_) {}
Â  });

Â  // ×œ×™×ª×¨ ×‘×™×˜×—×•×Ÿ â€“ ×× ×”×›×¤×ª×•×¨ ××¤×¨×™×¢, × ××¤×©×¨ ×œ×”×¢×œ×™× ××•×ª×• ×‘×œ×—×™×¦×” ××¨×•×›×” (3 ×©× ×™×•×ª)
Â  let holdTimer = null;
Â  btn.addEventListener("mousedown", () => {
Â  Â  holdTimer = setTimeout(() => {
Â  Â  Â  try { btn.remove(); hint.remove(); } catch(_) {}
Â  Â  }, 3000);
Â  });
Â  ["mouseup", "mouseleave", "touchend", "touchcancel"].forEach(ev =>
Â  Â  btn.addEventListener(ev, () => clearTimeout(holdTimer))
Â  );
}
/* ******************************************************* */
</script>
</body>
</html>
