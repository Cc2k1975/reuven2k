<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>שליפת נתוני רכב לפי מספר רישוי</title>

  <style>
    :root{
      --bg1:#0b1224; --bg2:#071024;
      --stroke:rgba(255,255,255,.10);
      --txt:#eaf0ff;
      --muted:rgba(234,240,255,.72);
      --accent:#22c55e;
      --radius:18px;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--txt);
      background: radial-gradient(1200px 700px at 80% -10%, rgba(34,197,94,.18), transparent 60%),
                  radial-gradient(900px 600px at 10% 10%, rgba(59,130,246,.15), transparent 55%),
                  linear-gradient(180deg,var(--bg1),var(--bg2));
      min-height:100vh;
      padding:16px;
    }
    .wrap{max-width:920px;margin:0 auto}
    .top{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--stroke);
      border-radius:24px;
      padding:16px;
      box-shadow: var(--shadow);
    }
    .title{font-weight:900;font-size:22px;margin:0 0 6px}
    .subtitle{color:var(--muted);margin:0 0 14px;font-weight:700}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--txt);
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .btn:active{transform:scale(.99)}
    .btn.accent{
      background: linear-gradient(180deg, rgba(34,197,94,.95), rgba(22,163,74,.95));
      border-color: rgba(34,197,94,.45);
      color:#052012;
    }
    .btn.ghost{ background: rgba(255,255,255,.04); }
    .input{
      flex:1;
      min-width:220px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      color:var(--txt);
      font-weight:900;
      outline:none;
    }

    .panel{
      margin-top:12px;
      background: rgba(255,255,255,.05);
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:12px;
    }

    /* === Scanner (רק חלון הלוחית) === */
    .scanner{ margin-top:12px; display:none; }
    .scanner.on{ display:block; }

    /* הווידאו נשאר פעיל אבל מוסתר (לא מציגים אותו) */
    video#video{
      position:absolute;
      left:-99999px;
      top:-99999px;
      width:2px;
      height:2px;
      opacity:0;
      pointer-events:none;
    }

    .scanCard{
      border:1px solid var(--stroke);
      border-radius:18px;
      background: rgba(0,0,0,.20);
      overflow:hidden;
    }

    .hudBar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      padding:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.22);
    }
    .hudBox{
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.14);
      border-radius:16px;
      padding:10px 12px;
      display:flex;
      align-items:center;
      gap:10px;
      min-width:240px;
    }
    .hudTitle{font-weight:900}
    .hudSub{color:rgba(255,255,255,.75);font-weight:800;font-size:12px}

    .zoomWrap{
      display:flex;
      align-items:center;
      gap:10px;
      width:100%;
    }
    .range{ width:100%; accent-color: var(--accent); }

    /* חלון תצוגה של ROI */
    .previewWrap{
      position:relative;
      padding:12px;
      background: rgba(0,0,0,.18);
    }
    .previewBox{
      width:100%;
      aspect-ratio: 4.8 / 1; /* חלון רחב ללוחית */
      border:3px solid rgba(34,197,94,.95);
      border-radius:18px;
      overflow:hidden;
      background:#000;
      box-shadow: 0 0 0 1px rgba(34,197,94,.15) inset;
      position:relative;
    }
    canvas#preview{
      width:100%;
      height:100%;
      display:block;
      background:#000;
    }

    .status{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      color:var(--muted);
      font-weight:800;
      white-space:pre-wrap;
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      overflow:hidden;
      border-radius:16px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
    }
    th,td{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      font-weight:800;
      vertical-align:top;
    }
    th{color:rgba(255,255,255,.75);width:38%}
    td{color:var(--txt)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  </style>
</head>

<body>
<div class="wrap">

  <div class="top">
    <div class="title">סריקה בלייב – תעמיד את הלוחית בתוך המסגרת</div>
    <div class="subtitle">זיהוי 7/8 ספרות → מכניס לשדה → שולף נתונים אוטומטית</div>

    <div class="row">
      <button class="btn ghost" id="btnClose" style="display:none;">סגור</button>

      <input class="input" id="plateInput" inputmode="numeric" autocomplete="off"
             placeholder="מספר רכב (ללא מקפים)" />

      <button class="btn" id="btnScan">סרוק</button>
      <button class="btn accent" id="btnFetch">שלוף נתונים</button>
      <button class="btn" id="btnWhatsApp" style="display:none;">ווצאפ</button>
    </div>

    <div class="scanner" id="scanner">
      <div class="scanCard">
        <div class="hudBar">
          <div class="hudBox">
            <div>
              <div class="hudTitle" id="hudTitle">מכין OCR…</div>
              <div class="hudSub" id="hudSub">תקרב ותיישר עד שהספרות חדות בחלון</div>
            </div>
          </div>

          <div class="hudBox" style="flex:1;min-width:260px;">
            <div style="font-weight:900;">זום</div>
            <div class="zoomWrap">
              <span class="mono" id="zoomVal">×1.0</span>
              <input class="range" id="zoomRange" type="range" min="1" max="3" step="0.1" value="1" />
            </div>
          </div>
        </div>

        <div class="previewWrap">
          <div class="previewBox">
            <canvas id="preview"></canvas>
          </div>
        </div>
      </div>

      <!-- הווידאו מוסתר בכוונה (משמש רק ל-capture/ocr) -->
      <video id="video" playsinline muted></video>
    </div>

    <div class="status" id="status">מוכן.</div>

    <div class="panel" id="resultPanel" style="display:none;">
      <div style="font-weight:900;margin-bottom:6px;">נתוני רכב</div>
      <div id="resultMeta" style="color:var(--muted);font-weight:800"></div>
      <table id="resultTable"></table>
    </div>
  </div>

</div>

<script>
(() => {
  const RESOURCE_ID = "053cea08-09bc-40ec-8f7a-156f0677aff3";

  const HIDE_FIELDS = new Set([
    "zmig_kidmi","zmig_ahori","misgeret","mispar_horaa","tozeret_cd","degem_cd",
    "degem_manoa","tzeva_cd","sug_degem","_id","rank"
  ]);

  const LABELS = {
    "mispar_rechev":"מספר רכב",
    "tozeret_nm":"יצרן / שם תוצר",
    "degem_nm":"דגם",
    "kinuy_mishari":"כינוי מסחרי",
    "ramat_gimur":"רמת גימור",
    "shnat_yitzur":"שנת ייצור",
    "baalut":"בעלות",
    "tokef_dt":"תוקף הרישוי",
    "test_dt":"טסט אחרון",
    "sug_delek_nm":"סוג דלק",
    "kvutzat_zihum":"קבוצת זיהום",
    "ramat_eivzur_betihuti":"רמת אבזור בטיחותי",
    "tzeva_rechev":"צבע"
  };

  const LOCAL_TESS_BASE = "/tess";
  const $ = (id) => document.getElementById(id);

  const plateInput = $("plateInput");
  const btnScan = $("btnScan");
  const btnFetch = $("btnFetch");
  const btnClose = $("btnClose");
  const btnWhatsApp = $("btnWhatsApp");
  const scanner = $("scanner");
  const video = $("video");
  const status = $("status");
  const hudTitle = $("hudTitle");
  const hudSub = $("hudSub");
  const zoomRange = $("zoomRange");
  const zoomVal = $("zoomVal");
  const resultPanel = $("resultPanel");
  const resultTable = $("resultTable");
  const resultMeta = $("resultMeta");

  const preview = $("preview");
  const pctx = preview.getContext("2d", { willReadFrequently:true });

  let stream = null;
  let track = null;
  let worker = null;
  let scanning = false;
  let busyOCR = false;
  let lastRecord = null;

  // Zoom וירטואלי תמיד עובד
  let zoomFactor = 1.0;

  // אם יש זום אמיתי במצלמה – נשתמש גם בו (ממופה מהסליידר)
  let hwZoomCaps = null;

  // === טיונינג מהירות ===
  const FAST_SCALE = 2.2;
  const LOOP_DELAY_MS = 110;
  const HEAVY_EVERY_MS = 1100;
  const CONF_FAST_ACCEPT = 82;

  const votes = [];
  const VOTE_WINDOW = 3;
  const VOTE_NEED = 2;

  let lastHeavyTryAt = 0;

  function setStatus(msg){ status.textContent = msg; }
  function onlyDigits(s){ return (s || "").replace(/[^\d]/g,""); }

  function extractPlate(text){
    const digits = onlyDigits(text);
    if (digits.length === 7 || digits.length === 8) return digits;

    const m = text.match(/\d{7,8}/g);
    if (m && m.length){
      const cand = m[0];
      if (cand.length === 7 || cand.length === 8) return cand;
    }
    if (digits.length > 8){
      const mm = digits.match(/\d{8}/);
      if (mm) return mm[0];
    }
    return "";
  }

  function pushVote(plate){
    votes.push(plate);
    while (votes.length > VOTE_WINDOW) votes.shift();

    const counts = {};
    for (const p of votes) counts[p] = (counts[p] || 0) + 1;

    let best = "";
    let bestCount = 0;
    for (const [k,v] of Object.entries(counts)){
      if (v > bestCount){
        best = k; bestCount = v;
      }
    }
    return { best, bestCount, window: votes.slice() };
  }

  async function loadScript(src){
    return new Promise((resolve, reject)=>{
      const s = document.createElement("script");
      s.src = src;
      s.async = true;
      s.onload = ()=>resolve(src);
      s.onerror = ()=>reject(new Error("נכשל טעינת סקריפט: " + src));
      document.head.appendChild(s);
    });
  }

  async function ensureTesseractLoaded(){
    if (window.Tesseract) return;
    await loadScript(`${LOCAL_TESS_BASE}/tesseract.min.js`);
    if (!window.Tesseract) throw new Error("Tesseract לא נטען");
  }

  async function ensureWorker(){
    if (worker) return worker;

    await ensureTesseractLoaded();
    hudTitle.textContent = "מכין OCR…";
    setStatus("טוען OCR מקומי…\n" + LOCAL_TESS_BASE);

    worker = await Tesseract.createWorker("eng", 1, {
      workerPath: `${LOCAL_TESS_BASE}/worker.min.js`,
      corePath:   `${LOCAL_TESS_BASE}/tesseract-core.wasm.js`,
      langPath:   "https://tessdata.projectnaptha.com/4.0.0",
      logger: ()=>{}
    });

    await worker.setParameters({
      tessedit_char_whitelist: "0123456789",
      tessedit_pageseg_mode: "7",
      classify_bln_numeric_mode: "1"
    });

    // Warm-up
    const warm = document.createElement("canvas");
    warm.width = 80; warm.height = 30;
    const wctx = warm.getContext("2d");
    wctx.fillStyle = "#fff"; wctx.fillRect(0,0,80,30);
    wctx.fillStyle = "#000"; wctx.font = "24px Arial";
    wctx.fillText("1234567", 2, 24);
    try{ await worker.recognize(warm); }catch(e){}

    hudTitle.textContent = "Worker OK";
    setStatus("Worker OK.\nמוכן לסריקה בלייב.");
    return worker;
  }

  function resizePreviewCanvas(){
    // קובע רזולוציה פנימית ל-canvas לפי הגודל בפועל
    const rect = preview.getBoundingClientRect();
    const w = Math.max(2, Math.round(rect.width));
    const h = Math.max(2, Math.round(rect.height));
    if (preview.width !== w || preview.height !== h){
      preview.width = w;
      preview.height = h;
    }
  }

  async function openCamera(){
    if (stream) return;

    hudTitle.textContent = "פותח מצלמה…";
    setStatus("פותח מצלמה…");

    stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { ideal:"environment" },
        width: { ideal: 1920 },
        height:{ ideal: 1080 }
      },
      audio:false
    });

    video.srcObject = stream;
    await video.play();

    track = stream.getVideoTracks()[0];

    // Zoom HW (אם קיים)
    const caps = track.getCapabilities ? track.getCapabilities() : null;
    hwZoomCaps = (caps && caps.zoom) ? caps.zoom : null;

    // זום תמיד פעיל (דיגיטלי), 1..3
    zoomRange.min = 1;
    zoomRange.max = 3;
    zoomRange.step = 0.1;
    zoomRange.value = 1;
    zoomFactor = 1.0;
    zoomVal.textContent = "×1.0";

    zoomRange.oninput = async () => {
      const z = Number(zoomRange.value);
      zoomFactor = z;
      zoomVal.textContent = "×" + z.toFixed(1);

      // אם יש זום אמיתי – ניישם גם אותו (ממופה ל-min..max)
      if (track && track.applyConstraints && hwZoomCaps){
        const min = hwZoomCaps.min;
        const max = hwZoomCaps.max;
        const t = (z - 1) / (3 - 1); // 0..1
        const hw = min + t * (max - min);
        try{ await track.applyConstraints({ advanced: [{ zoom: hw }] }); }catch(e){}
      }
    };

    // Canvas size
    resizePreviewCanvas();
    window.addEventListener("resize", resizePreviewCanvas, { passive:true });
  }

  function closeCamera(){
    scanning = false;
    busyOCR = false;
    votes.length = 0;
    lastHeavyTryAt = 0;

    if (stream){
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
      track = null;
    }
    scanner.classList.remove("on");
    btnClose.style.display = "none";
    hudTitle.textContent = "מוכן.";
    setStatus("מוכן.");
  }

  function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

  function getFrameCropBox(videoW, videoH){
    // בסיס – אזור הלוחית (כמו קודם)
    const left = 0.06 * videoW;
    const width = 0.88 * videoW;
    const height = 0.22 * videoH;
    const top = videoH - (0.10 * videoH) - height;

    let x = left + width * 0.03;
    let y = top + height * 0.10;
    let w = width - 2*(width * 0.03);
    let h = height - 2*(height * 0.10);

    // חיתוך פס IL
    const cutLeft = w * 0.14;
    x += cutLeft;
    w -= cutLeft;

    // קצת ימין
    const cutRight = w * 0.03;
    w -= cutRight;

    // עוד קצת למעלה/למטה (רק ספרות)
    y += h * 0.06;
    h -= h * 0.12;

    // === זום דיגיטלי (תמיד עובד) ===
    const z = clamp(zoomFactor, 1, 3);
    const cx = x + w/2;
    const cy = y + h/2;
    w = w / z;
    h = h / z;
    x = cx - w/2;
    y = cy - h/2;

    // גבולות
    x = clamp(x, 0, videoW - w);
    y = clamp(y, 0, videoH - h);

    return { x, y, w: Math.max(1,w), h: Math.max(1,h) };
  }

  function drawPreviewROI(){
    const vw = video.videoWidth;
    const vh = video.videoHeight;
    if (!vw || !vh) return;

    resizePreviewCanvas();

    const box = getFrameCropBox(vw, vh);

    // מצייר "בדיוק מה שנסרק" בחלון
    pctx.imageSmoothingEnabled = true;
    pctx.imageSmoothingQuality = "high";
    pctx.clearRect(0,0,preview.width, preview.height);
    pctx.drawImage(video, box.x, box.y, box.w, box.h, 0,0,preview.width, preview.height);
  }

  function preprocessFastBinary(c){
    const ctx = c.getContext("2d", { willReadFrequently:true });
    const img = ctx.getImageData(0,0,c.width,c.height);
    const d = img.data;

    let sum = 0;
    for (let i=0;i<d.length;i+=4){
      const r=d[i], g=d[i+1], b=d[i+2];
      const y = (0.299*r + 0.587*g + 0.114*b);
      sum += y;
    }
    const mean = sum / (d.length/4);

    const contrast = 1.35;
    const bias = -18;
    const th = mean - 10;

    for (let i=0;i<d.length;i+=4){
      const r=d[i], g=d[i+1], b=d[i+2];
      let y = (0.299*r + 0.587*g + 0.114*b);
      y = (y - mean) * contrast + mean + bias;
      y = clamp(y,0,255);
      const v = (y < th) ? 0 : 255;
      d[i]=d[i+1]=d[i+2]=v;
      d[i+3]=255;
    }
    ctx.putImageData(img,0,0);
    return c;
  }

  function preprocessHeavyInvert(c){
    const ctx = c.getContext("2d", { willReadFrequently:true });
    const img = ctx.getImageData(0,0,c.width,c.height);
    const d = img.data;

    let sum = 0;
    for (let i=0;i<d.length;i+=4){
      const r=d[i], g=d[i+1], b=d[i+2];
      const y = (0.299*r + 0.587*g + 0.114*b);
      sum += y;
    }
    const mean = sum / (d.length/4);
    const th = mean - 10;

    for (let i=0;i<d.length;i+=4){
      const r=d[i], g=d[i+1], b=d[i+2];
      let y = (0.299*r + 0.587*g + 0.114*b);
      const v = (y < th) ? 255 : 0; // invert
      d[i]=d[i+1]=d[i+2]=v;
      d[i+3]=255;
    }
    ctx.putImageData(img,0,0);
    return c;
  }

  function makeROIFromVideo(){
    const vw = video.videoWidth;
    const vh = video.videoHeight;
    if (!vw || !vh) return null;

    const box = getFrameCropBox(vw, vh);

    const scale = FAST_SCALE;
    const outW = Math.round(box.w * scale);
    const outH = Math.round(box.h * scale);

    const c = document.createElement("canvas");
    c.width = outW;
    c.height = outH;

    const ctx = c.getContext("2d", { willReadFrequently:true });
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = "high";
    ctx.drawImage(video, box.x, box.y, box.w, box.h, 0, 0, outW, outH);

    return c;
  }

  async function recognizeFast(roi){
    preprocessFastBinary(roi);
    const r = await worker.recognize(roi);
    const plate = extractPlate(r?.data?.text || "");
    const conf = Number(r?.data?.confidence ?? 0);
    return { plate, conf };
  }

  async function recognizeHeavy(roi){
    preprocessHeavyInvert(roi);
    await worker.setParameters({ tessedit_pageseg_mode: "8" });
    const r = await worker.recognize(roi);
    await worker.setParameters({ tessedit_pageseg_mode: "7" });
    const plate = extractPlate(r?.data?.text || "");
    const conf = Number(r?.data?.confidence ?? 0);
    return { plate, conf };
  }

  async function scanLoop(){
    if (!scanning) return;

    // כל לולאה: מעדכן חלון תצוגה (רק הלוחית)
    try{ drawPreviewROI(); }catch(e){}

    if (busyOCR){
      setTimeout(scanLoop, 20);
      return;
    }

    const t0 = performance.now();
    try{
      const roi = makeROIFromVideo();
      if (!roi){
        setTimeout(scanLoop, 20);
        return;
      }

      busyOCR = true;

      let { plate, conf } = await recognizeFast(roi);

      const now = Date.now();
      let usedHeavy = false;

      if (!plate && (now - lastHeavyTryAt) > HEAVY_EVERY_MS){
        lastHeavyTryAt = now;
        const roi2 = makeROIFromVideo();
        if (roi2){
          const heavy = await recognizeHeavy(roi2);
          plate = heavy.plate || plate;
          conf = Math.max(conf, heavy.conf || 0);
          usedHeavy = true;
        }
      }

      const dt = performance.now() - t0;

      if (plate){
        if (conf >= CONF_FAST_ACCEPT){
          hudTitle.textContent = "זוהה: " + plate;
          hudSub.textContent = `אושר מיד (conf ${conf.toFixed(0)})`;
          setStatus(`זוהה: ${plate}\nconf: ${conf.toFixed(0)}\n${dt.toFixed(0)}ms`);
          try{ navigator.vibrate && navigator.vibrate(90); }catch(e){}
          plateInput.value = plate;
          closeCamera();
          await fetchVehicle();
          return;
        }

        const v = pushVote(plate);
        hudTitle.textContent = `סורק… (${dt.toFixed(0)}ms)`;
        hudSub.textContent = `מועמד: ${plate} • הצבעה: ${v.bestCount}/${VOTE_WINDOW} • conf ${conf.toFixed(0)}${usedHeavy ? " • heavy" : ""}`;
        setStatus(
          `סורק…\nמועמד: ${plate}\nconf: ${conf.toFixed(0)}\nחלון הצבעה: ${v.window.join(" , ")}\nזמן: ${dt.toFixed(0)}ms`
        );

        if (v.bestCount >= VOTE_NEED){
          const finalPlate = v.best;
          hudTitle.textContent = "זוהה: " + finalPlate;
          hudSub.textContent = "מכניס לשדה ושולף נתונים…";
          setStatus(`זוהה (יציב): ${finalPlate}\n${dt.toFixed(0)}ms`);
          try{ navigator.vibrate && navigator.vibrate(90); }catch(e){}
          plateInput.value = finalPlate;
          closeCamera();
          await fetchVehicle();
          return;
        }

      } else {
        hudTitle.textContent = "סורק…";
        hudSub.textContent = usedHeavy ? "ניסיון heavy בוצע — תיישר ותקרב עוד קצת" : "תקרב עוד קצת עד שהספרות חדות בחלון";
        setStatus(`סורק…\n${dt.toFixed(0)}ms • עדיין לא זוהה${usedHeavy ? " (heavy)" : ""}`);
      }

    } catch(e){
      setStatus("שגיאה בסריקה:\n" + (e?.message || e));
    } finally {
      busyOCR = false;
      setTimeout(scanLoop, LOOP_DELAY_MS);
    }
  }

  async function openLiveScanner(){
    try{
      scanner.classList.add("on");
      btnClose.style.display = "inline-block";
      await openCamera();
      await ensureWorker();
      scanning = true;
      scanLoop();
    } catch(e){
      setStatus("openLiveScanner FAILED:\n" + (e?.message || e));
      closeCamera();
    }
  }

  async function fetchVehicle(){
    const plate = onlyDigits(plateInput.value);
    if (!(plate.length === 7 || plate.length === 8)){
      setStatus("מספר רכב חייב להיות 7 או 8 ספרות (ללא מקפים).");
      return;
    }

    setStatus("שולף נתונים…");

    const filters = encodeURIComponent(JSON.stringify({ mispar_rechev: Number(plate) }));
    const url =
      `https://data.gov.il/api/3/action/datastore_search?resource_id=${encodeURIComponent(RESOURCE_ID)}&filters=${filters}&limit=1`;

    try{
      const res = await fetch(url, { method:"GET", cache:"no-store" });
      if (!res.ok) throw new Error("HTTP " + res.status);

      const json = await res.json();
      const rec = json?.result?.records?.[0];

      if (!rec){
        lastRecord = null;
        resultPanel.style.display = "none";
        btnWhatsApp.style.display = "none";
        setStatus("לא נמצאו תוצאות למספר: " + plate);
        return;
      }

      lastRecord = rec;
      renderRecord(rec);
      setStatus("נמצא רכב – הנתונים מוצגים למטה.");
    } catch(e){
      setStatus("שגיאת שליפה:\n" + (e?.message || e));
    }
  }

  function prettyLabel(k){ return LABELS[k] || k; }

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, (c)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }

  function renderRecord(rec){
    const rows = [];
    const keys = Object.keys(rec);
    keys.sort((a,b)=>{
      if (a === "mispar_rechev") return -1;
      if (b === "mispar_rechev") return 1;
      return a.localeCompare(b);
    });

    for (const k of keys){
      if (HIDE_FIELDS.has(k)) continue;
      const v = rec[k];
      if (v === null || v === undefined || v === "") continue;

      rows.push(`
        <tr>
          <th>${escapeHtml(prettyLabel(k))}</th>
          <td>${escapeHtml(String(v))}</td>
        </tr>
      `);
    }

    resultTable.innerHTML = rows.join("");
    resultMeta.textContent = `מספר: ${rec.mispar_rechev} • מקור: data.gov.il`;
    resultPanel.style.display = "block";
    btnWhatsApp.style.display = "inline-block";
  }

  function buildWhatsAppText(rec){
    const lines = [];
    const plate = rec?.mispar_rechev ? String(rec.mispar_rechev) : "";
    lines.push("נתוני רכב לפי מספר רישוי");
    if (plate) lines.push("מספר רכב: " + plate);

    for (const k of Object.keys(rec)){
      if (HIDE_FIELDS.has(k)) continue;
      const v = rec[k];
      if (v === null || v === undefined || v === "") continue;
      lines.push(`${prettyLabel(k)}: ${String(v)}`);
    }
    return lines.join("\n");
  }

  function openWhatsApp(){
    if (!lastRecord){
      setStatus("אין נתונים לשליחה בווצאפ.");
      return;
    }
    const text = buildWhatsAppText(lastRecord);
    const url = "https://wa.me/?text=" + encodeURIComponent(text);
    window.open(url, "_blank");
  }

  // UI
  btnScan.addEventListener("click", openLiveScanner);
  btnClose.addEventListener("click", closeCamera);
  btnFetch.addEventListener("click", fetchVehicle);
  btnWhatsApp.addEventListener("click", openWhatsApp);

  plateInput.addEventListener("input", ()=>{
    const d = onlyDigits(plateInput.value);
    if (plateInput.value !== d) plateInput.value = d;
  });

})();
</script>

</body>
</html>
