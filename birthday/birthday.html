<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>××©×—×§ ××ª× ×•×ª ×™×•× ×”×•×œ×“×ª</title>

  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    :root{
      --bg:#ffeef7; --card:#ffffff; --accent:#ff4081; --accent-dark:#e91e63;
      --text:#222; --muted:#666; --radius:18px; --shadow:0 10px 25px rgba(0,0,0,0.12);
    }
    *{box-sizing:border-box}
    html,body{ margin:0; padding:0; font-family:system-ui,"Heebo","Arial",sans-serif; background:linear-gradient(180deg,#ffeef7,#fff); color:var(--text); }
    body{ min-height:100vh; display:flex; justify-content:center; align-items:center; padding:12px; }
    .app{ width:100%; max-width:500px; background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px 16px 22px; position:relative; overflow:hidden; }
    h1,h2,h3{ margin:0 0 12px; text-align:center; }
    h1{ font-size:1.6rem; color:var(--accent-dark); }
    h2{ font-size:1.3rem; }
    p{ margin:0 0 10px; line-height:1.4; }
    .center{text-align:center}
    .btn{ display:inline-block; padding:10px 18px; border-radius:999px; border:none; font-size:1rem; font-weight:600; cursor:pointer; background:var(--accent); color:#fff; box-shadow:0 6px 14px rgba(233,30,99,0.35); margin:8px 0; }
    .btn:active{ transform:translateY(1px); box-shadow:0 3px 8px rgba(233,30,99,0.4); }
    .btn-secondary{ background:#f1f1f1; color:#333; box-shadow:none; }
    .btn-small{ padding:6px 10px; font-size:0.85rem; }
    .hidden{display:none !important;}
    .tagline{ font-size:0.95rem; color:var(--muted); text-align:center; margin-bottom:10px; }
    .progress{ text-align:center; font-size:0.9rem; color:var(--muted); margin-top:6px; }
    .bubble{ background:#fff3f8; border-radius:14px; padding:10px 12px; margin:10px 0; border:1px dashed #ff8bb3; font-size:0.95rem; }
    .screen{ display:none; }
    .screen.active{ display:block; }
    #qr-reader{ width:100%; max-width:360px; margin:0 auto; }
    #scan-status{ text-align:center; font-size:0.9rem; color:var(--muted); margin-top:8px; min-height:18px; }
    .station-box{ background:#fff7fb; border-radius:16px; padding:14px; border:1px solid #ffd0e6; }
    .station-label{ font-size:0.9rem; color:var(--muted); margin-bottom:6px; }
    .admin-open{ position:absolute; top:8px; left:10px; background:transparent; border:none; color:#bbb; cursor:pointer; font-size:1.2rem; z-index: 100; }
    .field-group{ margin-bottom:10px; }
    label{ display:block; font-size:0.9rem; margin-bottom:3px; color:var(--muted); }
    input[type="text"], textarea, input[type="number"]{ width:100%; padding:7px 8px; border-radius:10px; border:1px solid #dadada; font-size:0.9rem; font-family:inherit; }
    textarea{ min-height:50px; resize:vertical; }
    .stations-grid{ max-height:320px; overflow-y:auto; border-radius:14px; border:1px solid #eee; padding:8px; background:#fafafa; }
    .station-edit{ margin-bottom:10px; padding:6px 8px; border-radius:10px; background:#ffffff; border:1px solid #e5e5e5; }
    .station-edit h4{ margin:0 0 6px; font-size:0.9rem; color:var(--accent-dark); }
    .footer-note{ margin-top:8px; font-size:0.8rem; color:#999; text-align:center; }
    .loading{ text-align:center; font-size:0.95rem; color:var(--muted); }
  </style>
</head>
<body>
  <div class="app">
    <button class="admin-open" id="adminOpenBtn" title="× ×™×”×•×œ">âš™</button>

    <section id="screen-loading" class="screen active">
      <h2>×˜×•×¢×Ÿ ××©×—×§â€¦</h2>
      <p class="loading">××ª×—×‘×¨ ×œÖ¾Firebase, ×¨×’×¢â€¦</p>
      <p id="error-msg" style="color:red; font-size:0.8rem; text-align:center; display:none;"></p>
    </section>

    <section id="screen-welcome" class="screen">
      <h1>××–×œ ×˜×•×‘ <span id="player-name-display">×œ×“× ×”</span>! ğŸ‰</h1>
      <p class="tagline">×”×™×•× ×× ×—× ×• ×™×•×¦××™× ×œ××¡×œ×•×œ ××¤×ª×™×¢ ×¢× ××ª× ×•×ª × ×¡×ª×¨×•×ªâ€¦</p>
      <div class="bubble">
        <p class="center">
          ×‘×›×œ ×ª×—× ×” ×ª××¦××™ ×‘×¨×§×•×“,<br>
          ×ª×¡×¨×§×™ ××•×ª×• ×•×ª×§×‘×œ×™ ×—×™×“×” ×©×ª×•×‘×™×œ ×œ××ª× ×” ×”×‘××” ğŸ
        </p>
      </div>
      <div class="center">
        <button class="btn" id="startGameBtn">×™××œ×œ×”, ××ª×—×™×œ×™×!</button>
      </div>
      <p class="progress" id="stations-count-label"></p>
    </section>

    <section id="screen-scan" class="screen">
      <h2>×¡×¨×§×™ ××ª ×”×‘×¨×§×•×“ ×”×‘× ğŸ“·</h2>
      <p class="tagline">×›×•×•× ×™ ××ª ×”××¦×œ××” ××œ ×”×‘×¨×§×•×“ ×”××¦×•×¨×£</p>
      <div id="qr-reader"></div>
      <div id="scan-status"></div>
      <div class="center" style="margin-top:12px;">
        <button class="btn-secondary btn-small" id="backToWelcomeBtn">×—×–×¨×” ×œ××¡×š ×”×¨××©×™</button>
      </div>
    </section>

    <section id="screen-station" class="screen">
      <h2 id="station-title">×›×œ ×”×›×‘×•×“! ğŸ</h2>
      <div class="station-box">
        <div class="station-label" id="station-index-label"></div>
        <p id="station-riddle"></p>
        <hr style="margin:10px 0;border:none;border-top:1px dashed #ffc0dd;">
        <p id="station-reward" style="font-weight:600;"></p>
      </div>
      <div class="center" style="margin-top:14px;">
        <button class="btn" id="continueScanBtn">×”××©×š ×œ×¡×¨×™×§×” ×”×‘××”</button>
        <button class="btn-secondary btn-small" id="backToScanBtn">×—×–×¨×” ×œ×¡×•×¨×§</button>
      </div>
    </section>

    <section id="screen-admin" class="screen">
      <h2>××¡×š × ×™×”×•×œ (×¡×•×“×™)</h2>
      <div class="field-group">
        <label for="player-name-input">×©× ××§×‘×œ/×ª ×”××ª× ×•×ª:</label>
        <input type="text" id="player-name-input" placeholder="×œ××©×œ: ×“× ×”">
      </div>
      <div class="field-group">
        <label for="stations-number-input">××¡×¤×¨ ×ª×—× ×•×ª:</label>
        <input type="number" id="stations-number-input" min="1" max="30" value="5">
      </div>
      <div class="field-group">
        <p style="font-size:0.9rem;margin-bottom:4px;">×”×’×“×¨×ª ×”×ª×—× ×•×ª:</p>
        <div class="stations-grid" id="stations-edit-container"></div>
      </div>
      <div class="center" style="margin-top:10px;">
        <button class="btn" id="saveAdminBtn">×©××™×¨×” ×œÖ¾Firebase</button>
        <button class="btn-secondary btn-small" id="exitAdminBtn">×™×¦×™××”</button>
      </div>
      <p class="footer-note">×¢×¨×™×›×” × ×©××¨×ª ×‘×–××Ÿ ×××ª ×‘Ö¾Firebase.</p>
    </section>
  </div>

  <script type="module">
    // -------- Firebase SDK --------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // ×”×§×•× ×¤×™×’×•×¨×¦×™×” ×©×œ×š (×•×•×“× ×©×”×™× × ×›×•× ×” ×•×©×‘-Console ×”××¡×“ ×¤×ª×•×—)
    const firebaseConfig = {
      apiKey: "AIzaSyBxh37gdksnvKyGZhKzcMEliRuRZaqFyRs",
      authDomain: "birthday-6673d.firebaseapp.com",
      projectId: "birthday-6673d",
      storageBucket: "birthday-6673d.firebasestorage.app",
      messagingSenderId: "815278978626",
      appId: "1:815278978626:web:2f5821014c768ee32d5fdb",
      measurementId: "G-295LG2HNQ8",
     // ×‘×ª×•×š firebaseConfig:
databaseURL: "https://birthday-6673d-default-rtdb.europe-west1.firebasedatabase.app"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // -------- ×‘×¨×™×¨×ª ××—×“×œ --------
    const DEFAULT_CONFIG = {
      playerName: "×“× ×”",
      stations: [
        { code: "DANA-1", riddle: "×”××ª× ×” ×”×¨××©×•× ×” ×‘××§×•× ×”×›×™ ××ª×•×§ ×‘×‘×™×ª...", reward: "×©×•×§×•×œ×“ ×•×‘×¨×›×”" },
        { code: "DANA-2", riddle: "×”×™×›×Ÿ ×©×™×© ××™× ×—××™× ×‘×‘×•×§×¨...", reward: "×¡×‘×•×Ÿ ××¤× ×§" }
      ]
    };

    let gameConfig = null;
    let scannerInstance = null;

    // -------- ×¤×•× ×§×¦×™×•×ª ××¡×š --------
    function showScreen(name){
      document.querySelectorAll(".screen").forEach(sec => sec.classList.remove("active"));
      document.getElementById("screen-" + name).classList.add("active");
      
      if (name === "scan") startScanner();
      else stopScanner();
    }

    function updateWelcomeScreen(){
      if (!gameConfig) return;
      document.getElementById("player-name-display").textContent = gameConfig.playerName || "×“× ×”";
      document.getElementById("stations-count-label").textContent =
        "×‘××©×—×§ ××—×›×•×ª ×œ×š " + (gameConfig.stations ? gameConfig.stations.length : 0) + " ×ª×—× ×•×ª ğŸ";
    }

    // -------- Firebase Logic --------
    async function loadConfigFromFirebase(){
      const configRef = ref(db, "config");
      try {
        const snapshot = await get(configRef);
        if (snapshot.exists()){
          const data = snapshot.val();
          gameConfig = data;
        } else {
          gameConfig = DEFAULT_CONFIG;
          await set(configRef, gameConfig); // × ×™×¡×™×•×Ÿ ×©××™×¨×” ×¨××©×•× ×™
        }
      } catch(err) {
        console.error("Firebase Error:", err);
        // ×× × ×›×©×œ, × ×©×ª××© ×‘×‘×¨×™×¨×ª ××—×“×œ ×›×“×™ ×©×”××©×—×§ ×™×¢×‘×•×“ ×‘×›×œ ×–××ª
        gameConfig = DEFAULT_CONFIG;
        document.getElementById("error-msg").textContent = "×©×’×™××ª ×—×™×‘×•×¨ (×‘×“×•×§ ×”×¨×©××•×ª Rules). ×”××©×—×§ ×‘××¦×‘ ××•×¤×œ×™×™×Ÿ.";
        document.getElementById("error-msg").style.display = "block";
      }
    }

    async function saveConfigToFirebase(){
      const configRef = ref(db, "config");
      await set(configRef, gameConfig);
    }

    // -------- ×¡×•×¨×§ --------
    function startScanner(){
      // ×•×™×“×•× ×©×”×¡×¤×¨×™×™×” × ×˜×¢× ×”
      if (!window.Html5QrcodeScanner) {
        alert("×©×’×™××”: ×¡×¤×¨×™×™×ª ×”×¡×•×¨×§ ×œ× × ×˜×¢× ×”.");
        return;
      }
      stopScanner();
      scannerInstance = new Html5QrcodeScanner("qr-reader", { fps: 10, qrbox: 250 }, false);
      scannerInstance.render(onScanSuccess, (err)=>{});
    }

    function onScanSuccess(decodedText){
      // ×¢×¦×™×¨×ª ×¡×¨×™×§×” ×›×“×™ ×œ×× ×•×¢ ×›×¤×™×œ×•×™×•×ª
      stopScanner(); 
      handleScannedCode(decodedText.trim());
    }

    function stopScanner(){
      if (scannerInstance){
        scannerInstance.clear().catch(console.error);
        scannerInstance = null;
      }
    }

    function handleScannedCode(codeText){
      const station = gameConfig.stations.find(s => (s.code || "").trim() === codeText);
      if (!station){
        alert("×‘×¨×§×•×“ ×œ× ××•×›×¨: " + codeText);
        showScreen("scan"); // ×—×–×¨×” ×œ×¡×¨×™×§×”
        return;
      }
      showStationScreen(station);
    }

    function showStationScreen(station){
      const idx = gameConfig.stations.indexOf(station);
      document.getElementById("station-title").textContent = "×ª×—× ×” " + (idx + 1) + " ğŸ‰";
      document.getElementById("station-index-label").textContent = "××ª×•×š " + gameConfig.stations.length;
      document.getElementById("station-riddle").textContent = station.riddle;
      document.getElementById("station-reward").textContent = station.reward;
      showScreen("station");
    }

    // -------- × ×™×”×•×œ --------
    function openAdmin(){
      const p = prompt("×¡×™×¡××” (2580):");
      if(p==="2580"){
        populateAdmin();
        showScreen("admin");
      }
    }

    function populateAdmin(){
      document.getElementById("player-name-input").value = gameConfig.playerName;
      document.getElementById("stations-number-input").value = gameConfig.stations.length;
      renderStationsEdit();
    }

    function renderStationsEdit(){
      const container = document.getElementById("stations-edit-container");
      container.innerHTML = "";
      gameConfig.stations.forEach((st, i) => {
        const div = document.createElement("div");
        div.className = "station-edit";
        div.innerHTML = `
          <h4>×ª×—× ×” ${i+1}</h4>
          <input type="text" class="inp-code" placeholder="×§×•×“ ×‘×¨×§×•×“" value="${st.code||''}" style="margin-bottom:5px;">
          <textarea class="inp-riddle" placeholder="×—×™×“×”">${st.riddle||''}</textarea>
          <textarea class="inp-reward" placeholder="×¤×¨×¡">${st.reward||''}</textarea>
        `;
        container.appendChild(div);
      });
    }

    async function saveAdmin(){
      const newName = document.getElementById("player-name-input").value;
      const container = document.getElementById("stations-edit-container");
      const blocks = container.querySelectorAll(".station-edit");
      const newStations = [];
      
      blocks.forEach(blk => {
        newStations.push({
          code: blk.querySelector(".inp-code").value,
          riddle: blk.querySelector(".inp-riddle").value,
          reward: blk.querySelector(".inp-reward").value
        });
      });

      gameConfig.playerName = newName;
      gameConfig.stations = newStations;
      
      try {
        await saveConfigToFirebase();
        alert("× ×©××¨ ×‘×”×¦×œ×—×”!");
        updateWelcomeScreen();
        showScreen("welcome");
      } catch(e) {
        alert("×©×’×™××” ×‘×©××™×¨×”: " + e.message);
      }
    }

    // -------- ××ª×—×•×œ (Main) --------
    // ×›××Ÿ ×”×ª×™×§×•×Ÿ ×”×’×“×•×œ: ×¤×•× ×§×¦×™×™×ª init ×©×¨×¦×” ×™×©×™×¨×•×ª
    async function initGame(){
      // ×—×™×‘×•×¨ ×›×¤×ª×•×¨×™×
      document.getElementById("startGameBtn").onclick = () => showScreen("scan");
      document.getElementById("backToWelcomeBtn").onclick = () => showScreen("welcome");
      document.getElementById("continueScanBtn").onclick = () => showScreen("scan");
      document.getElementById("backToScanBtn").onclick = () => showScreen("scan");
      document.getElementById("adminOpenBtn").onclick = openAdmin;
      document.getElementById("saveAdminBtn").onclick = saveAdmin;
      document.getElementById("exitAdminBtn").onclick = () => showScreen("welcome");
      
      document.getElementById("stations-number-input").onchange = (e) => {
        const num = parseInt(e.target.value) || 1;
        // ×”×ª×××ª ×’×•×“×œ ×”××¢×¨×š
        while(gameConfig.stations.length < num) gameConfig.stations.push({code:"",riddle:"",reward:""});
        while(gameConfig.stations.length > num) gameConfig.stations.pop();
        renderStationsEdit();
      };

      // ×˜×¢×™× ×”
      await loadConfigFromFirebase();
      updateWelcomeScreen();
      showScreen("welcome");
    }

    // ×”×¤×¢×œ×”
    initGame();

  </script>
</body>
</html>
