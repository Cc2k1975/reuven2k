<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>××¤×§×“ ×¦×™×•×“</title>
  <style>
    :root{
      --bg:#e5f4ff;
      --card:#ffffff;
      --accent:#ff6a00;
      --accent-soft:#e0f7f4;
      --danger:#e53935;
      --ink:#06263a;
      --muted:#58738a;
      --border:1px solid rgba(0,0,0,.06);
      --radius:18px;
      --shadow:0 14px 28px rgba(0,0,0,.14);
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:system-ui,"Heebo",Arial;background:var(--bg);color:var(--ink)}
    body{padding:12px}
    h1{margin:8px 0 16px;text-align:center;font-size:26px}
    .subtitle{text-align:center;color:var(--muted);margin-bottom:14px;font-size:14px}

    .card{
      background:var(--card);
      border-radius:var(--radius);
      border:var(--border);
      padding:12px;
      margin-bottom:12px;
      box-shadow:0 4px 10px rgba(0,0,0,.04);
    }

    .section-title{
      font-size:15px;
      font-weight:700;
      margin-bottom:6px;
      color:var(--muted);
    }

    .row{
      display:flex;
      gap:8px;
      margin-bottom:8px;
    }
    .row.wrap{flex-wrap:wrap}
    .row > *{flex:1}

    input[type="text"], input[type="number"], input[type="search"]{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:var(--border);
      font-size:16px;
      outline:none;
      background:#40eb34;
    }
    input:focus{border-color:var(--accent);box-shadow:0 0 0 1px rgba(0,150,136,.4)}

    button{
      border:none;
      border-radius:14px;
      padding:10px 14px;
      font-size:15px;
      font-weight:600;
      cursor:pointer;
      white-space:nowrap;
    }
    .btn-main{background:var(--accent);color:#fff;}
    .btn-ghost{background:#f1f5f9;color:var(--ink);}
    .btn-danger{background:var(--danger);color:#fff;}
    .btn-small{font-size:13px;padding:6px 10px;border-radius:999px;}

    .active-employee{
      margin-top:6px;
      padding:10px;
      border-radius:var(--radius);
      background:#ffebee;
      text-align:center;
    }
    .active-employee span.label{display:block;font-size:13px;color:#b71c1c;margin-bottom:4px}
    .active-employee span.value{
      display:block;
      font-size:26px;
      font-weight:800;
      color:#d32f2f;
    }

    .active-inv{
      margin-top:6px;
      padding:10px;
      border-radius:var(--radius);
      background:#e8f5e9;
      text-align:center;
    }
    .active-inv span.label{display:block;font-size:13px;color:#1b5e20;margin-bottom:4px}
    .active-inv span.value{
      display:block;
      font-size:24px;
      font-weight:800;
      color:#2e7d32;
      word-break:break-all;
    }

    .status-pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:72px;
      padding:4px 10px;
      border-radius:999px;
      background:var(--accent-soft);
      color:var(--accent);
      font-size:13px;
      margin-top:6px;
    }

    .groups-list{margin-top:6px}
    .group-card{
      border-radius:16px;
      border:var(--border);
      padding:10px;
      margin-bottom:10px;
      background:#f8fafc;
    }
    .group-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:6px;
    }
    .group-id{
      font-weight:800;
      color:#00796b;
      font-size:16px;
    }
    .group-id .label{
      font-weight:600;
      color:var(--muted);
      margin-left:4px;
      font-size:13px;
    }
    .group-meta{
      font-size:13px;
      color:var(--muted);
    }
    .items-list{margin-top:6px}
    .item-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:6px 8px;
      border-radius:12px;
      background:#ffffff;
      margin-bottom:4px;
      font-size:14px;
    }
    .item-main{font-weight:600}
    .item-meta{font-size:12px;color:var(--muted)}

    .footer-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-top:10px;
    }

    .search-area{
      margin-top:10px;
    }
    #searchResults{
      margin-top:6px;
      font-size:14px;
      color:var(--muted);
    }

    /* ×¡×•×¨×§ ××¦×œ××” â€“ ×©×›×‘×ª ×•×™×“××• */
    #scannerOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.86);
      display:none;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      z-index:9999;
      color:#fff;
    }
    #scannerOverlay video{
      width:90%;
      max-width:420px;
      border-radius:16px;
      border:2px solid #fff;
    }
    #scannerOverlay .hint{margin-top:8px;font-size:14px;text-align:center}
  </style>
</head>
<body>

  <h1>××¤×§×“ ×¦×™×•×“</h1>
  <div class="subtitle">×¡×¨×™×§×ª ××™×§×•×, ×ª×’ ×¢×•×‘×“ ×•×¤×¨×™×˜×™ ×¦×™×•×“, ×©××™×¨×” ×™×©×™×¨×•×ª ×œ×©×¨×ª</div>

  <!-- 1. ××–×•×¨ ×—×“×¨ / ××™×§×•× (×§×•×“×) -->
  <div class="card">
    <div class="section-title">×¡×¨×™×§×ª ×—×“×¨ / ××™×§×•× ×¢×•×‘×“</div>
    <div class="row">
      <input id="roomLocationInput" type="text"
             placeholder="×¡×¨×•×§ ×‘×¨×§×•×“ ×—×“×¨ (×œ×“×•×’××”: L 291 6)" />
    </div>
    <div class="row wrap">
      <button class="btn-main" onclick="setRoomLocation()">×©××•×¨ ××™×§×•×</button>
    </div>
  </div>

  <!-- 2. ××–×•×¨ ×¢×•×‘×“ -->
  <div class="card">
    <div class="section-title">×¡×¨×™×§×ª ×ª×’ ×¢×•×‘×“ / ×”×§×œ×“×ª ××¡×¤×¨ ×–×”×•×ª</div>
    <div class="row">
      <input id="employeeIdInput" type="text" inputmode="numeric"
             placeholder="×¡×¨×•×§ ×ª×’ ×¢×•×‘×“ ××• ×”×§×œ×“ ×ª.×– ×¢×•×‘×“" />
    </div>
    <div class="row wrap">
      <button class="btn-main" onclick="setActiveEmployee()">×”×•×¡×£ ×ª×’ ×¢×•×‘×“</button>
    </div>

    <div class="row">
      <input id="employeeNameInput" type="text" placeholder="(××•×¤×¦×™×•× ×œ×™) ×©× ×¢×•×‘×“" />
      <button class="btn-ghost" onclick="saveEmployeeName()">×©××•×¨ ×©×</button>
    </div>

    <div id="activeEmployeeBox" class="active-employee" style="display:none">
      <span class="label">××¡×¤×¨ ×–×”×•×ª ×”×¢×•×‘×“</span>
      <span class="value" id="activeEmployeeValue"></span>
    </div>

    <div class="active-inv" id="activeLocationBox" style="display:none">
      <span class="label">××™×§×•× × ×•×›×—×™ ×©×œ ×”×¢×•×‘×“ (××ª×¨ Â· ××‘× ×” Â· ×—×“×¨)</span>
      <span class="value" id="activeLocationValue"></span>
    </div>

    <div class="status-pill" id="onlineStatus">××¦×‘ ×©××™×¨×”: ×××ª×™×Ÿâ€¦</div>
  </div>

  <!-- 3. ××–×•×¨ ××™× ×•×•× ×˜×¨ -->
  <div class="card">
    <div class="section-title">×¡×¨×™×§×ª ××¡×¤×¨ ×”×§×œ×“ ×§×•×“ / ××¡×¤×¨ ××™× ×•×•× ×˜×¨</div>
    <div class="row">
      <input id="inventoryInput" type="text" inputmode="numeric"
             placeholder="×¡×¨×•×§ ×‘×¨×§×•×“ ××• ×”×§×œ×“ ××¡×¤×¨ ××™× ×•×•× ×˜×¨" />
    </div>
    <div class="row wrap">
      <button class="btn-main" onclick="addInventory()">×”×•×¡×£ ××™× ×•×•× ×˜×¨</button>
      <button class="btn-ghost" onclick="startCameraScan()">×¡×¨×™×§×ª ××¦×œ××”</button>
    </div>

    <div id="lastInvBox" class="active-inv" style="display:none">
      <span class="label">××™× ×•×•× ×˜×¨ ××—×¨×•×Ÿ ×©× ×¡×¨×§</span>
      <span class="value" id="lastInvValue"></span>
    </div>
  </div>

  <!-- 4. ×¨×©×™××ª ×¢×•×‘×“×™× ×•×¤×¨×™×˜×™× -->
  <div class="card">
    <div class="section-title">××™× ×•×•× ×˜×¨ ×œ×¢×•×‘×“</div>
    <div id="groupsList" class="groups-list"></div>

    <div class="footer-row">
      <button class="btn-ghost btn-small" onclick="exportToExcel()">×™×™×¦×•×</button>
      <button class="btn-danger btn-small" onclick="hardClearAll()">××—×§ ××ª ×›×œ ×”× ×ª×•× ×™×</button>
    </div>
  </div>

  <!-- 5. ×—×™×¤×•×© -->
  <div class="card search-area">
    <div class="section-title">×—×™×¤×•×© ×¢×•×‘×“ / ××™× ×•×•× ×˜×¨</div>
    <div class="row">
      <input id="searchInput" type="search"
             placeholder="×”×§×œ×“ ×ª.×– ×¢×•×‘×“ ××• ××¡×¤×¨ ××™× ×•×•× ×˜×¨" oninput="runSearch()" />
    </div>
    <div id="searchResults">××™×Ÿ ×ª×•×¦××•×ª ×—×™×¤×•×© ×¢×“×™×™×Ÿ.</div>
  </div>

  <!-- ×©×›×‘×ª ×¡×•×¨×§ ××¦×œ××” -->
  <div id="scannerOverlay">
    <video id="scannerVideo" autoplay playsinline></video>
    <div class="hint">×××§× ××ª ×”×‘×¨×§×•×“ ×‘××¨×›×– ×”×ª××•× ×”â€¦</div>
    <div style="margin-top:10px">
      <button class="btn-ghost" onclick="stopCameraScan()">×‘×˜×œ</button>
    </div>
  </div>

  <!-- Toast ×§×˜×Ÿ ×œ×”×•×“×¢×•×ª -->
  <div id="toast" style="
      position:fixed;bottom:16px;left:50%;transform:translateX(-50%);
      background:#4caf50;color:#fff;padding:8px 14px;border-radius:999px;
      font-size:14px;display:none;z-index:99999;box-shadow:0 8px 18px rgba(0,0,0,.25);">
    × ×©××¨ ×‘×”×¦×œ×—×” ×œ×©×¨×ª
  </div>

  <!-- Firebase + ×œ×•×’×™×§×” -->
  <script type="module">
    import { initializeApp } 
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
      getFirestore, doc, getDoc, setDoc 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBpiYodClBXcReDSyfToFiDJp-xksOzuzyX",
      authDomain: "mifkad-online.firebaseapp.com",
      projectId: "mifkad-online",
      storageBucket: "mifkad-online.firebasestorage.app",
      messagingSenderId: "602973543807",
      appId: "1:602973543807:web:222e052e99af7edd3b4e6",
      measurementId: "G-L5HRJR1PC5"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const STATE_DOC = doc(db, "mifkad", "state");

    // ----- ××¦×‘ ××¤×œ×™×§×¦×™×” -----
    let state = {
      currentEmployee: null,      // ×ª.×– × ×•×›×—×™×ª
      employees: {},              // id -> { id, name, items: [{inv, ts}], location?: {site,building,room} }
      lastInv: null
    };

    let allInvSet = new Set();    // ×œ×‘×“×™×§×ª ×›×¤×™×œ×•×™×•×ª
    let saving = false;

    // ××™×§×•× ×©× ×¡×¨×§ ×œ×¤× ×™ ×©× ×‘×—×¨ ×¢×•×‘×“
    let pendingLocation = null;

    // ----- ×¢×–×¨×™ DOM -----
    const employeeIdInput   = document.getElementById("employeeIdInput");
    const employeeNameInput = document.getElementById("employeeNameInput");
    const inventoryInput    = document.getElementById("inventoryInput");
    const activeEmployeeBox = document.getElementById("activeEmployeeBox");
    const activeEmployeeVal = document.getElementById("activeEmployeeValue");
    const lastInvBox        = document.getElementById("lastInvBox");
    const lastInvVal        = document.getElementById("lastInvValue");
    const groupsList        = document.getElementById("groupsList");
    const onlineStatus      = document.getElementById("onlineStatus");
    const searchInput       = document.getElementById("searchInput");
    const searchResults     = document.getElementById("searchResults");
    const toast             = document.getElementById("toast");

    const roomLocationInput = document.getElementById("roomLocationInput");
    const activeLocationBox = document.getElementById("activeLocationBox");
    const activeLocationVal = document.getElementById("activeLocationValue");

    // ----- ×¦×œ×™×œ×™× -----
    const audioCtx = (window.AudioContext || window.webkitAudioContext) 
      ? new (window.AudioContext || window.webkitAudioContext)() 
      : null;

    function playBeep(type="ok"){
      if(!audioCtx) return;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.connect(g); g.connect(audioCtx.destination);
      if(type === "ok")   o.frequency.value = 880;
      if(type === "err")  o.frequency.value = 220;
      if(type === "scan") o.frequency.value = 660;
      g.gain.value = 0.1;
      o.start();
      setTimeout(()=>{o.stop();}, 120);
    }

    // ----- Firestore: ×˜×¢×™× ×” ×•×©××™×¨×” -----
    async function loadState(){
      try{
        const snap = await getDoc(STATE_DOC);
        if(snap.exists()){
          const data = snap.data();
          state = {
            currentEmployee: data.currentEmployee || null,
            employees: data.employees || {},
            lastInv: data.lastInv || null
          };
        }
        rebuildInvSet();
        renderAll();
        onlineStatus.textContent = "××¦×‘ ×©××™×¨×”: ××—×•×‘×¨ ×œ×©×¨×ª";
      }catch(e){
        console.error(e);
        onlineStatus.textContent = "×©×’×™××” ×‘×˜×¢×™× ×” ××”×©×¨×ª";
      }
    }

    async function saveState(){
      try{
        saving = true;
        onlineStatus.textContent = "×©×•××¨ ×œ×©×¨×ªâ€¦";
        await setDoc(STATE_DOC, state);
        saving = false;
        onlineStatus.textContent = "× ×©××¨ ×œ×©×¨×ª ×‘×”×¦×œ×—×”";
        showToast("× ×©××¨ ×‘×”×¦×œ×—×” ×œ×©×¨×ª");
      }catch(e){
        console.error(e);
        saving = false;
        onlineStatus.textContent = "×©×’×™××” ×‘×©××™×¨×” ×œ×©×¨×ª";
        alert("×©×’×™××” ×‘×©××™×¨×ª × ×ª×•× ×™× ×œ×©×¨×ª.");
      }
    }

    // ----- ×œ×•×’×™×§×” ×¢×¡×§×™×ª -----

    // 1. ×¡×¨×™×§×ª ×—×“×¨ / ××™×§×•×
    function setRoomLocation(){
      const raw = roomLocationInput.value.trim();
      if(!raw){ return; }

      // ×× ×§×™× ××¤×¨×™×“×™× (- ,) ×•×¨×•×•×—×™× ×›×¤×•×œ×™×
      const cleaned = raw.replace(/[-,]/g," ");
      const parts = cleaned.trim().split(/\s+/);
      if(parts.length < 3){
        alert("×¤×•×¨××˜ ××™×§×•× ×œ× ×ª×§×™×Ÿ. ×¦×¤×” ×œ: ××ª×¨ ××‘× ×” ×—×“×¨ (×œ×“×•×’××”: L 291 6)");
        playBeep("err");
        return;
      }

      const site     = parts[0].toUpperCase();
      const building = parts[1].replace(/\D/g,"");
      const room     = parts[2].replace(/\D/g,"");

      if(!site || !building || !room){
        alert("×œ× ×–×•×”×• ××ª×¨ / ××‘× ×” / ×—×“×¨ ××”××—×¨×•×–×ª.");
        playBeep("err");
        return;
      }

      const loc = {site, building, room};

      if(state.currentEmployee && state.employees[state.currentEmployee]){
        // ×™×© ×¢×•×‘×“ ×¤×¢×™×œ â€“ ××©×™×™×›×™× ××œ×™×•
        state.employees[state.currentEmployee].location = loc;
        pendingLocation = null;
      }else{
        // ×¢×“×™×™×Ÿ ××™×Ÿ ×¢×•×‘×“ â€“ × ×©××•×¨ ×–×× ×™×ª ×¢×“ ×¡×¨×™×§×ª ×¢×•×‘×“
        pendingLocation = loc;
      }

      roomLocationInput.value = "";
      renderAll();
      saveState();
      playBeep("ok");
    }

    // 2. ×¢×•×‘×“ ×¤×¢×™×œ
    function setActiveEmployee(){
      const id = employeeIdInput.value.trim();
      if(!id){return;}
      if(!state.employees[id]){
        state.employees[id] = { id, name:"", items:[] };
      }
      state.currentEmployee = id;

      // ×× ×™×© ××™×§×•× ×©× ×©××¨ ×œ×¤× ×™ ×‘×—×™×¨×ª ×”×¢×•×‘×“ â€“ ××©×™×™×›×™× ××•×ª×• ×¢×›×©×™×•
      if(pendingLocation){
        state.employees[id].location = pendingLocation;
        pendingLocation = null;
      }

      employeeIdInput.value = "";
      renderAll();
      saveState();
      playBeep("scan");
    }

    function saveEmployeeName(){
      const id = state.currentEmployee;
      if(!id){
        alert("×‘×—×¨ ×§×•×“× ×¢×•×‘×“ ×¤×¢×™×œ.");
        return;
      }
      const name = employeeNameInput.value.trim();
      state.employees[id].name = name;
      renderAll();
      saveState();
    }

    function rebuildInvSet(){
      allInvSet = new Set();
      Object.values(state.employees).forEach(emp=>{
        emp.items.forEach(it=> allInvSet.add(it.inv));
      });
    }

    function addInventory(){
      const empId = state.currentEmployee;
      if(!empId){
        alert("×§×•×“× ×¡×¨×•×§/×‘×•×—×¨ ×ª×’ ×¢×•×‘×“.");
        playBeep("err");
        return;
      }
      const inv = inventoryInput.value.trim();
      if(!inv){
        return;
      }
      if(allInvSet.has(inv)){
        alert("××–×”×¨×”: ××™× ×•×•× ×˜×¨ ×–×” ×›×‘×¨ ×§×™×™× ×‘××¢×¨×›×ª.");
        playBeep("err");
        inventoryInput.value = "";
        return;
      }
      const item = {
        inv,
        ts: new Date().toISOString()
      };
      state.employees[empId].items.push(item);
      state.lastInv = inv;
      inventoryInput.value = "";
      rebuildInvSet();
      renderAll();
      saveState();
      playBeep("ok");
    }

    function deleteItem(empId, index){
      if (!confirm("×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×¤×¨×™×˜?")) {
        return;
      }

      const emp = state.employees[empId];
      if(!emp) return;
      emp.items.splice(index,1);
      rebuildInvSet();
      renderAll();
      saveState();
    }

    function removeEmployee(empId){
      if(!confirm("×œ××—×•×§ ××ª ×›×œ ×”×¤×¨×™×˜×™× ×•×”×¢×•×‘×“?")) return;
      delete state.employees[empId];
      if(state.currentEmployee === empId) state.currentEmployee = null;
      rebuildInvSet();
      renderAll();
      saveState();
    }

    function clearAllData(){
      if(!confirm("×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ× ×§×•×ª ××ª ×›×œ ×”× ×ª×•× ×™× ××”××¡×š?")) return;
      state.currentEmployee = null;
      state.employees = {};
      state.lastInv = null;
      pendingLocation = null;
      rebuildInvSet();
      renderAll();
      saveState();
    }

    function hardClearAll(){
      if(!confirm("××–×”×¨×”: ×¤×¢×•×œ×” ×–×• ×ª××—×§ ××ª ×›×œ ×”× ×ª×•× ×™× ××”×©×¨×ª. ×œ×”××©×™×š?")) return;
      if(!confirm("×•×•×™×“×•× × ×•×¡×£: ××ª×” ×‘×˜×•×— ×©××ª×” ×¨×•×¦×” ×œ××—×•×§ ×œ×¦××™×ª×•×ª?")) return;
      state.currentEmployee = null;
      state.employees = {};
      state.lastInv = null;
      pendingLocation = null;
      rebuildInvSet();
      renderAll();
      saveState();
    }

    // ----- ×™×™×¦×•× ×œ××§×¡×œ (CSV) â€“ ×œ×¤×™ ×”×§×•×“ ×”×™×©×Ÿ ×©×œ×š, ×¢× ×”×¢××•×“×•×ª ×”×—×“×©×•×ª -----
    function exportToExcel(){
      const rows = [["Employee Name","Inventory Number","Employee ID","Date Time","Site","Building","Room"]];
      Object.values(state.employees).forEach(emp=>{
        emp.items.forEach(it=>{
          const dateStr = new Date(it.ts).toLocaleString("he-IL");
          const loc = emp.location || {};
          rows.push([
            emp.name || "",
            it.inv,
            emp.id,
            dateStr,
            loc.site || "",
            loc.building || "",
            loc.room || ""
          ]);
        });
      });

      let csv = "";
      rows.forEach(r=>{
        csv += r
          .map(v => `"${String(v).replace(/"/g,'""')}"`)
          .join(",") + "\r\n";
      });

      // ×‘×“×™×•×§ ×›××• ×‘×§×•×“ ×”××§×•×¨×™ â€“ CSV + BOM + UTF-8
      const blob = new Blob(["\uFEFF" + csv],{
        type:"text/csv;charset=utf-8;"
      });

      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "mifkad_export.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ----- ×—×™×¤×•×© -----
    function runSearch(){
      const q = searchInput.value.trim();
      if(!q){
        searchResults.textContent = "××™×Ÿ ×ª×•×¦××•×ª ×—×™×¤×•×© ×¢×“×™×™×Ÿ.";
        return;
      }
      let found = [];
      Object.values(state.employees).forEach(emp=>{
        if(emp.id.includes(q) || (emp.name && emp.name.includes(q))){
          found.push({
            type:"employee",
            emp,
            info:`×¢×•×‘×“ ×ª.×– ${emp.id}${emp.name ? " ("+emp.name+")":""}`
          });
        }
        emp.items.forEach(it=>{
          if(it.inv.includes(q)){
            found.push({
              type:"inv",
              emp,
              item:it,
              info:`××™× ×•×•× ×˜×¨ ${it.inv} ××¦×œ ×¢×•×‘×“ ${emp.id}${emp.name ? " ("+emp.name+")":""}`
            });
          }
        });
      });

      if(found.length === 0){
        searchResults.textContent = "×œ× × ××¦××• ×ª×•×¦××•×ª ×œ×—×™×¤×•×©.";
        return;
      }
      let html = "";
      found.forEach(f=>{
        if(f.type==="employee"){
          html += `<div>ğŸ‘¤ ${f.info}</div>`;
        }else{
          const dt = new Date(f.item.ts).toLocaleString("he-IL");
          html += `<div>ğŸ“¦ ${f.info} â€” × ×¡×¨×§ ×‘Ö¾${dt}</div>`;
        }
      });
      searchResults.innerHTML = html;
    }

    // ----- ×¨×™× ×“×•×¨ -----
    function renderAll(){
      // ×¢×•×‘×“ ×¤×¢×™×œ
      if(state.currentEmployee && state.employees[state.currentEmployee]){
        const emp = state.employees[state.currentEmployee];
        activeEmployeeBox.style.display = "block";
        activeEmployeeVal.textContent = state.currentEmployee;
        employeeNameInput.value = emp.name || "";

        if(emp.location){
          activeLocationBox.style.display = "block";
          activeLocationVal.textContent = `${emp.location.site} ${emp.location.building} ${emp.location.room}`;
        }else{
          activeLocationBox.style.display = "none";
          activeLocationVal.textContent = "";
        }
      }else{
        activeEmployeeBox.style.display = "none";
        activeLocationBox.style.display = "none";
        activeLocationVal.textContent = "";
      }

      if(state.lastInv){
        lastInvBox.style.display = "block";
        lastInvVal.textContent = state.lastInv;
      }else{
        lastInvBox.style.display = "none";
      }

      groupsList.innerHTML = "";
      Object.values(state.employees).forEach(emp=>{
        const card = document.createElement("div");
        card.className = "group-card";

        const header = document.createElement("div");
        header.className = "group-header";

        const locText = emp.location
          ? ` Â· ${emp.location.site} ${emp.location.building} ${emp.location.room}`
          : "";

        const idDiv = document.createElement("div");
        idDiv.innerHTML = `
          <span class="group-id"><span class="label">×ª.×–</span> ${emp.id}</span>
          <div class="group-meta">${emp.name ? emp.name+" Â· " : ""}${emp.items.length} ×¤×¨×™×˜×™×${locText}</div>
        `;
        header.appendChild(idDiv);

        const actions = document.createElement("div");
        actions.innerHTML = `
          <button class="btn-ghost btn-small" onclick="selectEmployee('${emp.id}')">×‘×—×¨ ×¢×•×‘×“</button>
          <button class="btn-danger btn-small" onclick="removeEmployee('${emp.id}')">×”×¡×¨ ×¢×•×‘×“</button>
        `;
        header.appendChild(actions);
        card.appendChild(header);

        const list = document.createElement("div");
        list.className = "items-list";
        emp.items.forEach((it,idx)=>{
          const row = document.createElement("div");
          row.className = "item-row";
          const dt  = new Date(it.ts).toLocaleString("he-IL");
          row.innerHTML = `
            <div>
              <div class="item-main">${it.inv}</div>
              <div class="item-meta">${dt}</div>
            </div>
            <button class="btn-danger btn-small" onclick="deleteItem('${emp.id}',${idx})">××—×§ ×¤×¨×™×˜</button>
          `;
          list.appendChild(row);
        });
        card.appendChild(list);
        groupsList.appendChild(card);
      });

      runSearch();
    }

    function selectEmployee(empId){
      if(!state.employees[empId]) return;
      state.currentEmployee = empId;

      // ×× ×”×™×” ××™×§×•× ×××ª×™×Ÿ â€“ ××©×™×™×›×™× ××•×ª×• ×¢×›×©×™×•
      if(pendingLocation){
        state.employees[empId].location = pendingLocation;
        pendingLocation = null;
      }

      renderAll();
      saveState();
    }

    // ----- ×¡×•×¨×§ ××¦×œ××” -----
    const overlay = document.getElementById("scannerOverlay");
    const videoEl = document.getElementById("scannerVideo");
    let cameraStream = null;
    let scanLoopRunning = false;
    let barcodeDetector = null;

    // ğŸ”’ ×“×’×œ ×œ×¤×ª×™×—×” ×—×“-×¤×¢××™×ª ×©×œ ×”××¦×œ××” ×œ×›×œ ×˜×¢×™× ×ª ×“×£
    let cameraUnlocked = false;

    // â± ×¡×¨×™×§×” ×›×œ 3 ×©× ×™×•×ª + ×–×™×›×¨×•×Ÿ ×©×œ ×”×‘×¨×§×•×“ ×”××—×¨×•×Ÿ ×›×“×™ ×œ× ×œ×©×’×¢
    let scanIntervalId = null;
    let lastScannedValue = null;

    async function startCameraScan(){
      if (!cameraUnlocked) {
        const code = prompt("×”×›× ×¡ ×§×•×“ ×œ×¤×ª×™×—×ª ×”××¦×œ××”");
        if (code !== "39800") {
          alert("×§×•×“ ×©×’×•×™");
          return;
        }
        cameraUnlocked = true;
      }

      try{
        if(!("BarcodeDetector" in window)){
          alert("×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘×¡×¨×™×§×ª ×‘×¨×§×•×“ ×“×¨×š ××¦×œ××”. ××¤×©×¨ ×œ×”×©×ª××© ×‘×¡×•×¨×§ USB.");
          return;
        }
        barcodeDetector = new BarcodeDetector({formats:["code_128","ean_13","ean_8","code_39","qr_code","upc_a","upc_e"]});
        overlay.style.display = "flex";

        cameraStream = await navigator.mediaDevices.getUserMedia({
          video:{facingMode:"environment"}
        });
        videoEl.srcObject = cameraStream;
        scanLoopRunning = true;
        lastScannedValue = null;
        if (scanIntervalId) {
          clearInterval(scanIntervalId);
          scanIntervalId = null;
        }
        // ×¡×¨×™×§×” ×›×œ 3 ×©× ×™×•×ª ×‘×œ×™ ×œ×¡×’×•×¨ ××ª ×”××¦×œ××”
        scanIntervalId = setInterval(scanLoop, 3000);
        playBeep("scan");
      }catch(e){
        console.error(e);
        alert("×œ× × ×™×ª×Ÿ ×œ×¤×ª×•×— ××¦×œ××”. ×‘×“×•×§ ×”×¨×©××•×ª.");
      }
    }

    async function scanLoop(){
      if(!scanLoopRunning || !barcodeDetector || !videoEl.srcObject) return;
      try{
        const barcodes = await barcodeDetector.detect(videoEl);
        if(barcodes.length > 0){
          const value = barcodes[0].rawValue.trim();
          if(value && value !== lastScannedValue){
            lastScannedValue = value;
            inventoryInput.value = value;
            addInventory();  // ×œ× ×¡×•×’×¨ ××¦×œ××” â€“ ×××©×™×š ×¡×¨×™×§×” ×¢×“ ×©×œ×•×—×¦×™× '×‘×˜×œ'
          }
        }
      }catch(e){
        console.error(e);
      }
    }

    function stopCameraScan(){
      scanLoopRunning = false;
      if (scanIntervalId) {
        clearInterval(scanIntervalId);
        scanIntervalId = null;
      }
      overlay.style.display = "none";
      if(cameraStream){
        cameraStream.getTracks().forEach(t=>t.stop());
        cameraStream = null;
      }
    }

    // ----- Toast -----
    function showToast(msg){
      toast.textContent = msg;
      toast.style.display = "block";
      setTimeout(()=>{toast.style.display="none";},1000);
    }

    // ×ª××™×›×” ×‘Ö¾Enter ×‘×¡×•×¨×§ ×‘×¨×§×•×“ ×œ×©×“×” ×”××™× ×•×•× ×˜×¨
    inventoryInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        addInventory();
      }
    });

    // ----- ×—×©×™×¤×” ×œ×¤×•× ×§×¦×™×•×ª ×’×œ×•×‘×œ×™×•×ª -----
    window.setActiveEmployee  = setActiveEmployee;
    window.saveEmployeeName   = saveEmployeeName;
    window.addInventory       = addInventory;
    window.deleteItem         = deleteItem;
    window.removeEmployee     = removeEmployee;
    window.clearAllData       = clearAllData;
    window.hardClearAll       = hardClearAll;
    window.exportToExcel      = exportToExcel;
    window.runSearch          = runSearch;
    window.selectEmployee     = selectEmployee;
    window.startCameraScan    = startCameraScan;
    window.stopCameraScan     = stopCameraScan;
    window.setRoomLocation    = setRoomLocation;

    // ×˜×¢×™× ×” ×¨××©×•× ×™×ª
    loadState();
  </script>
</body>
</html>
