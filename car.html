<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>שליפת נתוני רכב לפי מספר רישוי</title>

  <style>
    :root{
      --bg1:#0b1224; --bg2:#071024;
      --stroke:rgba(255,255,255,.10);
      --txt:#eaf0ff;
      --muted:rgba(234,240,255,.72);
      --accent:#22c55e;
      --radius:18px;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--txt);
      background: radial-gradient(1200px 700px at 80% -10%, rgba(34,197,94,.18), transparent 60%),
                  radial-gradient(900px 600px at 10% 10%, rgba(59,130,246,.15), transparent 55%),
                  linear-gradient(180deg,var(--bg1),var(--bg2));
      min-height:100vh;
      padding:16px;
    }
    .wrap{max-width:920px;margin:0 auto}
    .top{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--stroke);
      border-radius:24px;
      padding:16px;
      box-shadow: var(--shadow);
    }
    .title{font-weight:900;font-size:22px;margin:0 0 6px}
    .subtitle{color:var(--muted);margin:0 0 14px;font-weight:700}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--txt);
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .btn:active{transform:scale(.99)}
    .btn.accent{
      background: linear-gradient(180deg, rgba(34,197,94,.95), rgba(22,163,74,.95));
      border-color: rgba(34,197,94,.45);
      color:#052012;
    }
    .btn.ghost{ background: rgba(255,255,255,.04); }
    .input{
      flex:1;
      min-width:220px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      color:var(--txt);
      font-weight:900;
      outline:none;
    }

    .panel{
      margin-top:12px;
      background: rgba(255,255,255,.05);
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:12px;
    }

    .scanner{ margin-top:12px; display:none; }
    .scanner.on{ display:block; }

    video#video{
      position:absolute;
      left:-99999px;
      top:-99999px;
      width:2px;
      height:2px;
      opacity:0;
      pointer-events:none;
    }

    .scanCard{
      border:1px solid var(--stroke);
      border-radius:18px;
      background: rgba(0,0,0,.20);
      overflow:hidden;
    }

    .hudBar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      padding:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.22);
    }
    .hudBox{
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.14);
      border-radius:16px;
      padding:10px 12px;
      display:flex;
      align-items:center;
      gap:10px;
      min-width:240px;
    }
    .hudTitle{font-weight:900}
    .hudSub{color:rgba(255,255,255,.75);font-weight:800;font-size:12px}

    .zoomWrap{
      display:flex;
      align-items:center;
      gap:10px;
      width:100%;
    }
    .range{ width:100%; accent-color: var(--accent); }

    .previewWrap{
      position:relative;
      padding:12px;
      background: rgba(0,0,0,.18);
    }

    /* ✅ הגדלה קלה בגובה (חלון גבוה יותר) */
    .previewBox{
      width:100%;
      aspect-ratio: 4.3 / 1; /* היה 4.8/1 - עכשיו קצת יותר גבוה */
      border:3px solid rgba(34,197,94,.95);
      border-radius:18px;
      overflow:hidden;
      background:#000;
      box-shadow: 0 0 0 1px rgba(34,197,94,.15) inset;
      position:relative;
    }
    canvas#preview{
      width:100%;
      height:100%;
      display:block;
      background:#000;
    }

    .status{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      color:var(--muted);
      font-weight:800;
      white-space:pre-wrap;
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      overflow:hidden;
      border-radius:16px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
    }
    th,td{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      font-weight:800;
      vertical-align:top;
    }
    th{color:rgba(255,255,255,.75);width:38%}
    td{color:var(--txt)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  </style>
</head>

<body>
<div class="wrap">

  <div class="top">
    <div class="title">סריקה בלייב – תעמיד את הלוחית בתוך המסגרת</div>
    <div class="subtitle">זיהוי 7/8 ספרות → מכניס לשדה → שולף נתונים אוטומטית</div>

    <div class="row">
      <button class="btn ghost" id="btnClose" style="display:none;">סגור</button>

      <input class="input" id="plateInput" inputmode="numeric" autocomplete="off"
             placeholder="מספר רכב (ללא מקפים)" />

      <button class="btn" id="btnScan">סרוק</button>
      <button class="btn accent" id="btnFetch">שלוף נתונים</button>
      <button class="btn" id="btnWhatsApp" style="display:none;">ווצאפ</button>
    </div>

    <div class="scanner" id="scanner">
      <div class="scanCard">
        <div class="hudBar">
          <div class="hudBox">
            <div>
              <div class="hudTitle" id="hudTitle">מכין OCR…</div>
              <div class="hudSub" id="hudSub">תקרב ותיישר עד שהספרות חדות בחלון</div>
            </div>
          </div>

          <div class="hudBox" style="flex:1;min-width:260px;">
            <div style="font-weight:900;">זום</div>
            <div class="zoomWrap">
              <span class="mono" id="zoomVal">×1.0</span>
              <input class="range" id="zoomRange" type="range" min="1" max="3" step="0.1" value="1" />
            </div>
          </div>
        </div>

        <div class="previewWrap">
          <div class="previewBox">
            <canvas id="preview"></canvas>
          </div>
        </div>
      </div>

      <video id="video" playsinline muted></video>
    </div>

    <div class="status" id="status">מוכן.</div>

    <div class="panel" id="resultPanel" style="display:none;">
      <div style="font-weight:900;margin-bottom:6px;">נתוני רכב</div>
      <div id="resultMeta" style="color:var(--muted);font-weight:800"></div>
      <table id="resultTable"></table>
    </div>
  </div>

</div>

<script>
(() => {
  const RESOURCE_ID = "053cea08-09bc-40ec-8f7a-156f0677aff3";

  const HIDE_FIELDS = new Set([
    "zmig_kidmi","zmig_ahori","misgeret","mispar_horaa","tozeret_cd","degem_cd",
    "degem_manoa","tzeva_cd","sug_degem","_id","rank"
  ]);

  const LABELS = {
    "mispar_rechev":"מספר רכב",
    "tozeret_nm":"יצרן / שם תוצר",
    "degem_nm":"דגם",
    "kinuy_mishari":"כינוי מסחרי",
    "ramat_gimur":"רמת גימור",
    "shnat_yitzur":"שנת ייצור",
    "baalut":"בעלות",
    "tokef_dt":"תוקף הרישוי",
    "test_dt":"טסט אחרון",
    "sug_delek_nm":"סוג דלק",
    "kvutzat_zihum":"קבוצת זיהום",
    "ramat_eivzur_betihuti":"רמת אבזור בטיחותי",
    "tzeva_rechev":"צבע"
  };

  const LOCAL_TESS_BASE = "/tess";
  const $ = (id) => document.getElementById(id);

  const plateInput = $("plateInput");
  const btnScan = $("btnScan");
  const btnFetch = $("btnFetch");
  const btnClose = $("btnClose");
  const btnWhatsApp = $("btnWhatsApp");
  const scanner = $("scanner");
  const video = $("video");
  const status = $("status");
  const hudTitle = $("hudTitle");
  const hudSub = $("hudSub");
  const zoomRange = $("zoomRange");
  const zoomVal = $("zoomVal");
  const resultPanel = $("resultPanel");
  const resultTable = $("resultTable");
  const resultMeta = $("resultMeta");

  const preview = $("preview");
  const pctx = preview.getContext("2d", { willReadFrequently:true });

  let stream = null;
  let track = null;
  let worker = null;
  let scanning = false;
  let busyOCR = false;
  let lastRecord = null;

  let zoomFactor = 1.0;
  let hwZoomCaps = null;

  // ✅ שיפורי מהירות + יציבות
  const FAST_SCALE = 1.7;           // היה 2.2 (מהיר יותר)
  const OCR_INTERVAL_MS = 260;      // כמה פעמים בשנייה מנסים OCR (מונע עומס/קפיצות)
  const HEAVY_EVERY_MS = 1600;      // כבד פחות תכוף
  const CONF_IMMEDIATE = 78;        // אם מעל → ננעל מיד
  const CONF_OK = 58;               // מינימום סביר לספירה
  const LOCK_NEED_HITS = 2;         // כמה פעמים אותו מספר כדי לנעול
  const HOLD_MS = 1300;             // “לא מאבד” מועמד למשך זמן זה

  let lastOcrAt = 0;
  let lastHeavyTryAt = 0;

  let holdPlate = "";               // מספר שמחזיקים (לא נזרק)
  let holdAt = 0;

  let candidate = "";               // מועמד לנעילה
  let candidateHits = 0;
  let candidateFirstAt = 0;

  function setStatus(msg){ status.textContent = msg; }
  function onlyDigits(s){ return (s || "").replace(/[^\d]/g,""); }

  function extractPlate(text){
    const digits = onlyDigits(text);
    if (digits.length === 7 || digits.length === 8) return digits;

    const m = text.match(/\d{7,8}/g);
    if (m && m.length){
      const cand = m[0];
      if (cand.length === 7 || cand.length === 8) return cand;
    }
    if (digits.length > 8){
      const mm = digits.match(/\d{8}/);
      if (mm) return mm[0];
    }
    return "";
  }

  function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

  async function loadScript(src){
    return new Promise((resolve, reject)=>{
      const s = document.createElement("script");
      s.src = src;
      s.async = true;
      s.onload = ()=>resolve(src);
      s.onerror = ()=>reject(new Error("נכשל טעינת סקריפט: " + src));
      document.head.appendChild(s);
    });
  }

  async function ensureTesseractLoaded(){
    if (window.Tesseract) return;
    await loadScript(`${LOCAL_TESS_BASE}/tesseract.min.js`);
    if (!window.Tesseract) throw new Error("Tesseract לא נטען");
  }

  async function ensureWorker(){
    if (worker) return worker;

    await ensureTesseractLoaded();
    hudTitle.textContent = "מכין OCR…";
    setStatus("טוען OCR מקומי…\n" + LOCAL_TESS_BASE);

    worker = await Tesseract.createWorker("eng", 1, {
      workerPath: `${LOCAL_TESS_BASE}/worker.min.js`,
      corePath:   `${LOCAL_TESS_BASE}/tesseract-core.wasm.js`,
      langPath:   "https://tessdata.projectnaptha.com/4.0.0",
      logger: ()=>{}
    });

    await worker.setParameters({
      tessedit_char_whitelist: "0123456789",
      tessedit_pageseg_mode: "7",
      classify_bln_numeric_mode: "1"
    });

    // Warm-up
    const warm = document.createElement("canvas");
    warm.width = 80; warm.height = 30;
    const wctx = warm.getContext("2d");
    wctx.fillStyle = "#fff"; wctx.fillRect(0,0,80,30);
    wctx.fillStyle = "#000"; wctx.font = "24px Arial";
    wctx.fillText("1234567", 2, 24);
    try{ await worker.recognize(warm); }catch(e){}

    hudTitle.textContent = "Worker OK";
    setStatus("Worker OK.\nמוכן לסריקה בלייב.");
    return worker;
  }

  function resizePreviewCanvas(){
    const rect = preview.getBoundingClientRect();
    const w = Math.max(2, Math.round(rect.width));
    const h = Math.max(2, Math.round(rect.height));
    if (preview.width !== w || preview.height !== h){
      preview.width = w;
      preview.height = h;
    }
  }

  async function openCamera(){
    if (stream) return;

    hudTitle.textContent = "פותח מצלמה…";
    setStatus("פותח מצלמה…");

    stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { ideal:"environment" },
        width: { ideal: 1920 },
        height:{ ideal: 1080 }
      },
      audio:false
    });

    video.srcObject = stream;
    await video.play();

    track = stream.getVideoTracks()[0];
    const caps = track.getCapabilities ? track.getCapabilities() : null;
    hwZoomCaps = (caps && caps.zoom) ? caps.zoom : null;

    zoomRange.value = 1;
    zoomFactor = 1.0;
    zoomVal.textContent = "×1.0";

    zoomRange.oninput = async () => {
      const z = Number(zoomRange.value);
      zoomFactor = z;
      zoomVal.textContent = "×" + z.toFixed(1);

      if (track && track.applyConstraints && hwZoomCaps){
        const min = hwZoomCaps.min;
        const max = hwZoomCaps.max;
        const t = (z - 1) / (3 - 1);
        const hw = min + t * (max - min);
        try{ await track.applyConstraints({ advanced: [{ zoom: hw }] }); }catch(e){}
      }
    };

    resizePreviewCanvas();
    window.addEventListener("resize", resizePreviewCanvas, { passive:true });
  }

  function resetStability(){
    holdPlate = "";
    holdAt = 0;
    candidate = "";
    candidateHits = 0;
    candidateFirstAt = 0;
    lastOcrAt = 0;
    lastHeavyTryAt = 0;
  }

  function closeCamera(){
    scanning = false;
    busyOCR = false;
    resetStability();

    if (stream){
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
      track = null;
    }
    scanner.classList.remove("on");
    btnClose.style.display = "none";
    hudTitle.textContent = "מוכן.";
    setStatus("מוכן.");
  }

  function getFrameCropBox(videoW, videoH){
    const left = 0.06 * videoW;
    const width = 0.88 * videoW;
    const height = 0.22 * videoH;
    const top = videoH - (0.10 * videoH) - height;

    let x = left + width * 0.03;
    let y = top + height * 0.10;
    let w = width - 2*(width * 0.03);
    let h = height - 2*(height * 0.10);

    const cutLeft = w * 0.14;
    x += cutLeft;
    w -= cutLeft;

    const cutRight = w * 0.03;
    w -= cutRight;

    y += h * 0.06;
    h -= h * 0.12;

    const z = clamp(zoomFactor, 1, 3);
    const cx = x + w/2;
    const cy = y + h/2;
    w = w / z;
    h = h / z;
    x = cx - w/2;
    y = cy - h/2;

    x = clamp(x, 0, videoW - w);
    y = clamp(y, 0, videoH - h);

    return { x, y, w: Math.max(1,w), h: Math.max(1,h) };
  }

  function drawPreviewROI(){
    const vw = video.videoWidth;
    const vh = video.videoHeight;
    if (!vw || !vh) return;

    resizePreviewCanvas();

    const box = getFrameCropBox(vw, vh);

    pctx.imageSmoothingEnabled = true;
    pctx.imageSmoothingQuality = "high";
    pctx.clearRect(0,0,preview.width, preview.height);
    pctx.drawImage(video, box.x, box.y, box.w, box.h, 0,0,preview.width, preview.height);
  }

  function preprocessFastBinary(c){
    const ctx = c.getContext("2d", { willReadFrequently:true });
    const img = ctx.getImageData(0,0,c.width,c.height);
    const d = img.data;

    // ✅ ממוצע מהיר עם דגימה (חוסך זמן)
    let sum = 0;
    let cnt = 0;
    for (let i=0;i<d.length;i+=16){ // דגימה במקום כל פיקסל
      const r=d[i], g=d[i+1], b=d[i+2];
      sum += (0.299*r + 0.587*g + 0.114*b);
      cnt++;
    }
    const mean = sum / Math.max(1,cnt);

    const contrast = 1.30;
    const bias = -16;
    const th = mean - 10;

    for (let i=0;i<d.length;i+=4){
      const r=d[i], g=d[i+1], b=d[i+2];
      let y = (0.299*r + 0.587*g + 0.114*b);
      y = (y - mean) * contrast + mean + bias;
      y = clamp(y,0,255);
      const v = (y < th) ? 0 : 255;
      d[i]=d[i+1]=d[i+2]=v;
      d[i+3]=255;
    }
    ctx.putImageData(img,0,0);
    return c;
  }

  function preprocessHeavyInvert(c){
    const ctx = c.getContext("2d", { willReadFrequently:true });
    const img = ctx.getImageData(0,0,c.width,c.height);
    const d = img.data;

    let sum = 0, cnt = 0;
    for (let i=0;i<d.length;i+=16){
      const r=d[i], g=d[i+1], b=d[i+2];
      sum += (0.299*r + 0.587*g + 0.114*b);
      cnt++;
    }
    const mean = sum / Math.max(1,cnt);
    const th = mean - 10;

    for (let i=0;i<d.length;i+=4){
      const r=d[i], g=d[i+1], b=d[i+2];
      const y = (0.299*r + 0.587*g + 0.114*b);
      const v = (y < th) ? 255 : 0;
      d[i]=d[i+1]=d[i+2]=v;
      d[i+3]=255;
    }
    ctx.putImageData(img,0,0);
    return c;
  }

  function makeROIFromVideo(){
    const vw = video.videoWidth;
    const vh = video.videoHeight;
    if (!vw || !vh) return null;

    const box = getFrameCropBox(vw, vh);

    const outW = Math.round(box.w * FAST_SCALE);
    const outH = Math.round(box.h * FAST_SCALE);

    const c = document.createElement("canvas");
    c.width = outW;
    c.height = outH;

    const ctx = c.getContext("2d", { willReadFrequently:true });
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = "high";
    ctx.drawImage(video, box.x, box.y, box.w, box.h, 0, 0, outW, outH);

    return c;
  }

  async function recognizeFast(roi){
    preprocessFastBinary(roi);
    const r = await worker.recognize(roi);
    const plate = extractPlate(r?.data?.text || "");
    const conf = Number(r?.data?.confidence ?? 0);
    return { plate, conf };
  }

  async function recognizeHeavy(roi){
    preprocessHeavyInvert(roi);
    await worker.setParameters({ tessedit_pageseg_mode: "8" });
    const r = await worker.recognize(roi);
    await worker.setParameters({ tessedit_pageseg_mode: "7" });
    const plate = extractPlate(r?.data?.text || "");
    const conf = Number(r?.data?.confidence ?? 0);
    return { plate, conf };
  }

  function considerLock(plate, conf){
    const now = Date.now();

    // “מחזיקים” מספר שנראה לאחרונה כדי לא לאבד
    if (plate){
      holdPlate = plate;
      holdAt = now;
    }

    // אם יש ביטחון גבוה → נעילה מיידית
    if (plate && conf >= CONF_IMMEDIATE){
      return { locked:true, finalPlate: plate, reason:`conf ${conf.toFixed(0)} (מיידי)` };
    }

    // אם אין plate כרגע – אבל יש hold טרי, לא מאבדים
    if (!plate){
      if (holdPlate && (now - holdAt) <= HOLD_MS){
        return { locked:false, keep: holdPlate, msg:`מחפש… שומר על ${holdPlate}` };
      }
      // אין מה לשמור
      candidate = "";
      candidateHits = 0;
      candidateFirstAt = 0;
      holdPlate = "";
      return { locked:false, keep:"", msg:"מחפש… תקרב/תיישר" };
    }

    // plate קיים אבל עם conf נמוך מדי → עדיין אפשר “להחזיק” אך לא לספור לנעילה
    if (conf < CONF_OK){
      return { locked:false, keep: plate, msg:`זוהה חלש (${conf.toFixed(0)})… תקרב קצת` };
    }

    // מנגנון נעילה: 2 פגיעות של אותו מספר בפרק זמן קצר
    if (plate !== candidate){
      candidate = plate;
      candidateHits = 1;
      candidateFirstAt = now;
      return { locked:false, keep: plate, msg:`מועמד: ${plate} (1/${LOCK_NEED_HITS})` };
    } else {
      candidateHits++;
      const age = now - candidateFirstAt;
      if (candidateHits >= LOCK_NEED_HITS && age >= 160){
        return { locked:true, finalPlate: plate, reason:`יציב (${candidateHits} פגיעות)` };
      }
      return { locked:false, keep: plate, msg:`מועמד: ${plate} (${candidateHits}/${LOCK_NEED_HITS})` };
    }
  }

  async function scanLoop(){
    if (!scanning) return;

    // תצוגה זורמת (בלי קשר ל-OCR)
    try{ drawPreviewROI(); }catch(e){}

    const now = Date.now();
    if (busyOCR || (now - lastOcrAt) < OCR_INTERVAL_MS){
      requestAnimationFrame(scanLoop);
      return;
    }

    lastOcrAt = now;
    const t0 = performance.now();

    try{
      const roi = makeROIFromVideo();
      if (!roi){
        requestAnimationFrame(scanLoop);
        return;
      }

      busyOCR = true;

      let { plate, conf } = await recognizeFast(roi);

      // Heavy רק מדי פעם ורק כשלא הצליח/חלש
      if ((!plate || conf < CONF_OK) && (now - lastHeavyTryAt) > HEAVY_EVERY_MS){
        lastHeavyTryAt = now;
        const roi2 = makeROIFromVideo();
        if (roi2){
          const heavy = await recognizeHeavy(roi2);
          if (heavy.plate) plate = heavy.plate;
          conf = Math.max(conf, heavy.conf || 0);
        }
      }

      const dt = performance.now() - t0;

      const lock = considerLock(plate, conf);

      if (lock.locked){
        const finalPlate = lock.finalPlate;
        hudTitle.textContent = "זוהה: " + finalPlate;
        hudSub.textContent = "נעול → מכניס לשדה ושולף נתונים… (" + lock.reason + ")";
        setStatus(`זוהה: ${finalPlate}\n${lock.reason}\n${dt.toFixed(0)}ms`);
        try{ navigator.vibrate && navigator.vibrate(90); }catch(e){}
        plateInput.value = finalPlate;
        closeCamera();
        await fetchVehicle();
        return;
      }

      // לא נעול עדיין — מציג סטטוס בלי “לקפוץ” ולשדר כאילו איבד
      hudTitle.textContent = "סורק…";
      hudSub.textContent = lock.msg || "סורק…";
      if (lock.keep){
        setStatus(`סורק…\nמועמד: ${lock.keep}\nconf: ${conf.toFixed(0)}\n${dt.toFixed(0)}ms`);
      } else {
        setStatus(`סורק…\nconf: ${conf.toFixed(0)}\n${dt.toFixed(0)}ms`);
      }

    } catch(e){
      setStatus("שגיאה בסריקה:\n" + (e?.message || e));
    } finally {
      busyOCR = false;
      requestAnimationFrame(scanLoop);
    }
  }

  async function openLiveScanner(){
    try{
      scanner.classList.add("on");
      btnClose.style.display = "inline-block";
      await openCamera();
      await ensureWorker();
      resetStability();
      scanning = true;
      scanLoop();
    } catch(e){
      setStatus("openLiveScanner FAILED:\n" + (e?.message || e));
      closeCamera();
    }
  }

  async function fetchVehicle(){
    const plate = onlyDigits(plateInput.value);
    if (!(plate.length === 7 || plate.length === 8)){
      setStatus("מספר רכב חייב להיות 7 או 8 ספרות (ללא מקפים).");
      return;
    }

    setStatus("שולף נתונים…");

    const filters = encodeURIComponent(JSON.stringify({ mispar_rechev: Number(plate) }));
    const url =
      `https://data.gov.il/api/3/action/datastore_search?resource_id=${encodeURIComponent(RESOURCE_ID)}&filters=${filters}&limit=1`;

    try{
      const res = await fetch(url, { method:"GET", cache:"no-store" });
      if (!res.ok) throw new Error("HTTP " + res.status);

      const json = await res.json();
      const rec = json?.result?.records?.[0];

      if (!rec){
        lastRecord = null;
        resultPanel.style.display = "none";
        btnWhatsApp.style.display = "none";
        setStatus("לא נמצאו תוצאות למספר: " + plate);
        return;
      }

      lastRecord = rec;
      renderRecord(rec);
      setStatus("נמצא רכב – הנתונים מוצגים למטה.");
    } catch(e){
      setStatus("שגיאת שליפה:\n" + (e?.message || e));
    }
  }

  function prettyLabel(k){ return LABELS[k] || k; }

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, (c)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }

  function renderRecord(rec){
    const rows = [];
    const keys = Object.keys(rec);
    keys.sort((a,b)=>{
      if (a === "mispar_rechev") return -1;
      if (b === "mispar_rechev") return 1;
      return a.localeCompare(b);
    });

    for (const k of keys){
      if (HIDE_FIELDS.has(k)) continue;
      const v = rec[k];
      if (v === null || v === undefined || v === "") continue;

      rows.push(`
        <tr>
          <th>${escapeHtml(prettyLabel(k))}</th>
          <td>${escapeHtml(String(v))}</td>
        </tr>
      `);
    }

    resultTable.innerHTML = rows.join("");
    resultMeta.textContent = `מספר: ${rec.mispar_rechev} • מקור: data.gov.il`;
    resultPanel.style.display = "block";
    btnWhatsApp.style.display = "inline-block";
  }

  function buildWhatsAppText(rec){
    const lines = [];
    const plate = rec?.mispar_rechev ? String(rec.mispar_rechev) : "";
    lines.push("נתוני רכב לפי מספר רישוי");
    if (plate) lines.push("מספר רכב: " + plate);

    for (const k of Object.keys(rec)){
      if (HIDE_FIELDS.has(k)) continue;
      const v = rec[k];
      if (v === null || v === undefined || v === "") continue;
      lines.push(`${prettyLabel(k)}: ${String(v)}`);
    }
    return lines.join("\n");
  }

  function openWhatsApp(){
    if (!lastRecord){
      setStatus("אין נתונים לשליחה בווצאפ.");
      return;
    }
    const text = buildWhatsAppText(lastRecord);
    const url = "https://wa.me/?text=" + encodeURIComponent(text);
    window.open(url, "_blank");
  }

  btnScan.addEventListener("click", openLiveScanner);
  btnClose.addEventListener("click", closeCamera);
  btnFetch.addEventListener("click", fetchVehicle);
  btnWhatsApp.addEventListener("click", openWhatsApp);

  plateInput.addEventListener("input", ()=>{
    const d = onlyDigits(plateInput.value);
    if (plateInput.value !== d) plateInput.value = d;
  });

})();
</script>

</body>
</html>
