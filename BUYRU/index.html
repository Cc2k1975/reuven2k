<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>BUYRU – סריקה רציפה + CSV + מניעת כפילויות</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f172a; --ink:#f8fafc; --muted:#9aa8c7;
    --card:#0b1224; --border:1px solid rgba(255,255,255,.08);
    --accent:#22c55e; --radius:16px; --shadow:0 16px 36px rgba(0,0,0,.35);
    --pill:#0c1a31;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:Heebo,system-ui,Arial;background:var(--bg);color:var(--ink)}
  .wrap{max-width:820px;margin:0 auto;padding:18px}
  header{display:flex;align-items:center;gap:10px;margin-bottom:12px}
  h1{margin:0;font-size:20px;font-weight:800}
  .panel{background:#0b1630;border:var(--border);border-radius:var(--radius);padding:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{padding:10px 14px;border:0;border-radius:12px;font-weight:800;cursor:pointer}
  .primary{background:linear-gradient(135deg,var(--accent),#38bdf8);color:#062;box-shadow:var(--shadow)}
  .ghost{background:transparent;border:var(--border);color:#dbeafe}
  .danger{background:#ef4444;color:#fff}
  select{padding:10px 12px;border-radius:12px;border:var(--border);background:#0b1630;color:#e5e7eb}
  .camDock{position:relative;width:360px;max-width:100%;aspect-ratio:16/10;border-radius:14px;overflow:hidden;border:var(--border);background:#000}
  .camDock video{width:100%;height:100%;object-fit:cover}
  .scanLine{position:absolute;left:8%;right:8%;top:50%;height:2px;background:rgba(255,255,255,.65);transform:translateY(-50%);box-shadow:0 0 12px rgba(255,255,255,.55)}
  .grid{display:grid;gap:14px;margin-top:14px}
  @media(min-width:780px){ .grid{grid-template-columns:1fr 1fr} }
  .shot{background:var(--card);border:var(--border);border-radius:16px;padding:14px}
  .list{display:flex;flex-direction:column;gap:10px;max-height:70vh;overflow:auto}
  .item{display:grid;grid-template-columns:88px 1fr;gap:10px;align-items:center;background:#0b1630;border:var(--border);border-radius:14px;padding:8px}
  .thumb{width:88px;height:88px;border-radius:10px;object-fit:contain;background:#000}
  .code{font-weight:900;font-size:18px;letter-spacing:.5px}
  .src{font-size:12px;color:var(--muted)}
  .pill{background:var(--pill);border:var(--border);border-radius:999px;padding:4px 10px;font-size:12px;color:#cbd5e1;display:inline-block}
  .note{font-size:12px;color:var(--muted)}
  .foot{margin-top:12px;text-align:center;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <header><h1>BUYRU – סריקה רציפה + CSV + מניעת כפילויות</h1></header>

  <div class="panel">
    <button id="btnStart" class="btn primary">הפעל סריקה</button>
    <button id="btnStop" class="btn ghost" disabled>עצור</button>
    <select id="cameraSel" title="מצלמה"></select>
    <button id="btnTorch" class="btn ghost" disabled>פנס כבוי</button>
    <button id="btnReset" class="btn danger">איפוס סל</button>
    <button id="btnExport" class="btn ghost">ייצוא CSV</button>
    <span id="httpsWarn" class="note hide">מצלמה דורשת <b>https://</b></span>
  </div>

  <div class="grid">
    <div class="shot">
      <div class="camDock">
        <video id="preview" playsinline muted autoplay></video>
        <div class="scanLine"></div>
      </div>
      <div class="note">סריקה רציפה עם חיווי קול – כל מוצר נוסף לסל באופן אוטומטי.</div>
    </div>

    <div class="shot">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <div class="pill">פריטים בסל: <span id="count">0</span></div>
        <div class="note">מניעת כפילויות • שמירה מקומית • ייצוא CSV</div>
      </div>
      <div id="list" class="list"></div>
    </div>
  </div>

  <footer class="foot">v3.2.0 • חיווי קול • מניעת כפילויות • ייצוא CSV</footer>
</div>

<script src="https://unpkg.com/@zxing/browser@0.1.1"></script>
<script>
const btnStart=document.getElementById('btnStart'),btnStop=document.getElementById('btnStop'),btnTorch=document.getElementById('btnTorch'),btnReset=document.getElementById('btnReset'),btnExport=document.getElementById('btnExport'),cameraSel=document.getElementById('cameraSel'),preview=document.getElementById('preview'),listEl=document.getElementById('list'),countEl=document.getElementById('count'),httpsWarn=document.getElementById('httpsWarn');

let stream=null,track=null,rafId=null,reader=null,lastCode='',lastTime=0;
const DEBOUNCE_MS=1200;
let items=[];

/* ==== SOUND ==== */
function beep(){
  try{
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const osc=ctx.createOscillator(); const gain=ctx.createGain();
    osc.type='sine'; osc.frequency.value=880;
    osc.connect(gain); gain.connect(ctx.destination);
    gain.gain.setValueAtTime(0.2,ctx.currentTime);
    osc.start(); osc.stop(ctx.currentTime+0.15);
  }catch{}
}

/* ==== CAMERA ==== */
async function listVideoInputs(){const all=await navigator.mediaDevices.enumerateDevices();return all.filter(d=>d.kind==='videoinput');}
function preferBack(devs){const backs=devs.filter(d=>/back|rear|environment/i.test(d.label||''));return backs.length?backs[backs.length-1]:devs[0];}
async function fillCameras(){
 try{await navigator.mediaDevices.getUserMedia({video:true});}catch{}
 const devs=await listVideoInputs();cameraSel.innerHTML='';
 devs.forEach((d,i)=>{const o=document.createElement('option');o.value=d.deviceId;o.textContent=(d.label||`camera ${i}`)+(/(back|rear|environment)/i.test(d.label||'')?' (אחורית)':'');cameraSel.appendChild(o);});
 const pref=preferBack(devs);if(pref)cameraSel.value=pref.deviceId;
}

/* ==== PRODUCT IMAGE SOURCES ==== */
function gtinToPath(code){const c=(code||'').replace(/\D/g,'');const p=[];for(let i=0;i<c.length;i+=3)p.push(c.slice(i,i+3));return p.join('/');}
function openFactsCandidates(code){const b='https://images.openfoodfacts.org/images/products/';const p=gtinToPath(code);return [`${b}${p}/front.400.jpg`,`${b}${p}/front.jpg`];}
function ramiLevyCandidates(code){const b=`https://img.rami-levy.co.il/product/${code}`;return [`${b}/small.jpg`,`${b}/large.jpg`];}
function race(url){return new Promise((res,rej)=>{const im=new Image();im.onload=()=>res(url);im.onerror=()=>rej();im.src=url+`?t=${Date.now()}`;});}
async function findImageFast(code){
 const cands=[...openFactsCandidates(code),...ramiLevyCandidates(code)];
 for(let i=0;i<cands.length;i++){try{const ok=await race(cands[i]);if(ok)return ok;}catch{}}
 return null;
}

/* ==== DETECT ==== */
async function bandBitmap(v,band=0.22){const w=v.videoWidth||1280,h=v.videoHeight||720,bh=Math.max(40,Math.round(h*band)),y=Math.round((h-bh)/2);const c=document.createElement('canvas');c.width=w;c.height=bh;const ctx=c.getContext('2d',{willReadFrequently:true});ctx.drawImage(v,0,y,w,bh,0,0,w,bh);return await createImageBitmap(c);}
async function liveDetectContinuous(){
 const det=new window.BarcodeDetector({formats:['ean_13','ean_8','upc_a','upc_e']});
 const loop=async()=>{try{const now=Date.now();const bmp=await bandBitmap(preview,0.22);const res=await det.detect(bmp);
  if(res&&res.length){const code=(res[0].rawValue||'').trim();
    if(code&&!items.find(x=>x.code===code)&&(code!==lastCode||(now-lastTime)>DEBOUNCE_MS)){
      lastCode=code;lastTime=now;beep();onNewCode(code);
    }}}catch{}rafId=requestAnimationFrame(loop);};
 rafId=requestAnimationFrame(loop);
}

/* ==== CAMERA START ==== */
async function startScan(){
 await stopScan();
 const dev=cameraSel.value||undefined;
 stream=await navigator.mediaDevices.getUserMedia({video:{deviceId:dev?{exact:dev}:{},facingMode:'environment'}});
 preview.srcObject=stream;await preview.play();
 track=stream.getVideoTracks()[0];
 btnStart.disabled=true;btnStop.disabled=false;
 await liveDetectContinuous();
}
async function stopScan(){
 if(rafId)cancelAnimationFrame(rafId);
 if(reader)reader.reset();
 if(stream)stream.getTracks().forEach(t=>t.stop());
 track=null;stream=null;
 btnStart.disabled=false;btnStop.disabled=true;
}

/* ==== ITEMS ==== */
function addItem(code,img=''){
 items.unshift({code,img});
 if(items.length>200)items.length=200;
 renderList();saveItems();
}
function renderList(){
 listEl.innerHTML=items.map(it=>`<div class="item"><img class="thumb" src="${it.img||''}" alt=""><div><div class="code">${it.code}</div></div></div>`).join('');
 countEl.textContent=items.length;
}
function resetList(){items=[];renderList();saveItems();}
async function onNewCode(code){
 addItem(code);
 const img=await findImageFast(code);
 if(img){const it=items.find(i=>i.code===code);if(it)it.img=img;renderList();saveItems();}
}

/* ==== STORAGE ==== */
function saveItems(){localStorage.setItem('buyru_cart',JSON.stringify(items));}
function loadItems(){try{items=JSON.parse(localStorage.getItem('buyru_cart')||'[]');}catch{items=[];}}

/* ==== EXPORT ==== */
function exportCSV(){
 if(!items.length){alert('אין נתונים לייצוא');return;}
 const rows=[['מקט','קישור תמונה'],...items.map(i=>[i.code,i.img||''])];
 const csv=rows.map(r=>r.map(x=>`"${(x||'').replace(/"/g,'""')}"`).join(',')).join('\n');
 const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
 const a=document.createElement('a');
 a.href=URL.createObjectURL(blob);
 a.download='buyru_scan_'+new Date().toISOString().slice(0,19).replace(/[:T]/g,'_')+'.csv';
 a.click();
}

/* ==== EVENTS ==== */
btnStart.onclick=startScan;
btnStop.onclick=stopScan;
btnReset.onclick=resetList;
btnExport.onclick=exportCSV;

/* ==== INIT ==== */
loadItems();renderList();fillCameras();

/* ==== SCAN LINE ==== */
(function anim(){const line=document.querySelector('.scanLine');let t=0;const s=()=>{t+=0.02;line.style.top=`calc(50% + ${Math.sin(t)*6}px)`;requestAnimationFrame(s)};s();})();
</script>
</body>
</html>
