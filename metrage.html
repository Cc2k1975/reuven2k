<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<title>×©×¨×˜×•×˜ ×—×›× - ×¡×“×¨ ×©×¢×•×Ÿ ××œ××¢×œ×”</title>

<script async src="https://docs.opencv.org/4.7.0/opencv.js" onload="__onCvScriptLoaded()"></script>

<style>
  :root{--bg:#f4f6f9;--card:#fff;--text:#111827;--muted:#6b7280;--primary:#2563eb;--danger:#dc2626;--line:#e5e7eb;}
  *{box-sizing:border-box}
  body{margin:0;padding:16px;font-family:system-ui,Arial;background:var(--bg);color:var(--text); overflow-y: auto;}
  .wrap{max-width:980px;margin:0 auto}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:14px;box-shadow:0 10px 25px rgba(0,0,0,.08)}
  h2{margin:0 0 10px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .btn{
    width:100%; padding:14px 16px; border:0; border-radius:12px;
    background:var(--primary); color:#fff; font-size:18px; cursor:pointer;
  }
  .btn:disabled{opacity:.55; cursor:not-allowed}
  .btn.secondary{background:#111827}
  .note{color:var(--muted);font-size:14px;margin-top:8px;line-height:1.45}
  video,canvas{width:100%;border-radius:12px;border:1px solid var(--line);background:#fff}
  .hidden{display:none}
  
  .input-group { 
    margin-bottom: 15px; 
    padding: 12px; 
    border-radius: 12px; 
    background: #fff;
    border-width: 5px;
    border-style: solid;
    transition: all 0.2s;
  }
  .input-group label { display: block; font-size: 16px; font-weight: bold; margin-bottom: 8px; }
  input {
    width:100%; padding:14px; border:1px solid #ddd; border-radius:8px;
    font-size:20px; outline:none; font-weight: bold;
  }

  .status{ padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:#fff; font-size:14px; }
  .status.good{border-color:#22c55e; color:#15803d; font-weight:bold;}
  
  .result-container-single {
    width: 100%; background: #fff; border: 1px solid var(--line); border-radius: 12px;
    overflow: hidden; touch-action: pan-y; margin-bottom: 20px; position: relative;
  }
  .result-canvas { width: 100%; height: auto; display: block; transform-origin: center center; }
  .tile-label { padding: 12px; background: #f8fafc; border-top: 1px solid var(--line); font-weight: bold; color: var(--primary); text-align: center; }
  .tile-inputs-top { display: flex; gap: 10px; background: #f0f7ff; padding: 12px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #c0d8ff; }
</style>
</head>

<body>
<div class="wrap">

  <div class="card">
    <h2>1ï¸âƒ£ ×¦×™×œ×•× ×”×©×¨×˜×•×˜</h2>
    <div id="statusBox" class="status">×˜×•×¢×Ÿ OpenCVâ€¦</div>
    <div style="margin-top:12px">
      <video id="video" autoplay playsinline></video>
      <canvas id="photo" class="hidden"></canvas>
    </div>
    <div class="row" style="margin-top:12px">
      <button id="btnShot" class="btn" type="button" disabled>ğŸ“¸ ×¦×œ× ×•×–×”×” ×¦×œ×¢×•×ª</button>
      <button id="btnRestart" class="btn secondary" type="button">ğŸ”„ ×”×ª×—×œ ××—×“×©</button>
    </div>
  </div>

  <div class="card hidden" id="previewCard">
    <h2>2ï¸âƒ£ ×¦×œ×¢×•×ª ×©×–×•×”×• (×¡×“×¨ ×©×¢×•×Ÿ ××œ××¢×œ×”)</h2>
    <canvas id="overlay"></canvas>
    <div class="note" style="background:#fff7ed; padding:10px; border-radius:8px; border:1px solid #ffedd5;">
        <b>×”× ×—×™×•×ª:</b> ××¡×¤×¨ 1 ×”×•× ×ª××™×“ ×”×¦×œ×¢ ×”×¢×œ×™×•× ×” ×‘×™×•×ª×¨. ×”×¡×“×¨ ×××©×™×š ×¢× ×›×™×•×•×Ÿ ×”×©×¢×•×Ÿ.
    </div>
  </div>

  <div class="card hidden" id="inputsCard">
    <h2>3ï¸âƒ£ ×”×–×Ÿ ××™×“×•×ª (×œ×¤×™ ×”×¦×‘×¢ ×‘×©×¨×˜×•×˜)</h2>
    <div class="tile-inputs-top">
      <div style="flex:1"><label>×¨×•×—×‘ ××¨×™×—</label><input id="tileW" type="number" value="60"></div>
      <div style="flex:1"><label>××•×¨×š ××¨×™×—</label><input id="tileH" type="number" value="120"></div>
    </div>
    <div id="inputs"></div>
    <button id="btnBuild" class="btn" type="button">ğŸ“ ×‘× ×” ×©×¨×˜×•×˜ ×¡×•×¤×™</button>
  </div>

  <div class="card hidden" id="resultCard">
    <h2>4ï¸âƒ£ ×¤×¨×™×¡×ª ×¨×™×¦×•×£ ×•×”×©×•×•××”</h2>
    <div id="results-wrapper">
      <div class="result-container-single" id="containerA">
        <div class="tile-label" style="background: #f1f5f9;">××•×¤×¦×™×” ×' (×›×™×•×•×Ÿ ××§×•×¨×™)</div>
        <canvas id="resultA" class="result-canvas"></canvas>
        <div id="reportA" class="tile-label"></div>
      </div>
      <div class="result-container-single" id="containerB">
        <div class="tile-label" style="background: #f1f5f9;">××•×¤×¦×™×” ×‘' (×¡×™×‘×•×‘ 90Â°)</div>
        <canvas id="resultB" class="result-canvas"></canvas>
        <div id="reportB" class="tile-label"></div>
      </div>
    </div>
    <div id="generalReport" class="note" style="text-align:center; font-size:18px; font-weight:bold; color:#111827; background:#e0f2fe; padding:15px; border-radius:12px;"></div>
  </div>

</div>

<script>
  const edgeColors = ['#FF0000', '#059669', '#2563eb', '#7c3aed', '#ea580c', '#db2777', '#0891b2', '#ca8a04'];

  let video = document.getElementById("video"), photo = document.getElementById("photo"), overlay = document.getElementById("overlay");
  let statusBox = document.getElementById("statusBox"), btnShot = document.getElementById("btnShot");
  let cvReady = false, videoReady = false, polyPts = [], edgeDirs = [], currentScale = 1, initialDist = 0;

  function setStatus(m, t){ statusBox.textContent = m; statusBox.className = "status " + (t||""); }
  
  function __onCvScriptLoaded(){
    const wait = setInterval(() => {
      if (window.cv && cv.Mat) { cvReady = true; setStatus("××¢×¨×›×ª ××•×›× ×”! âœ…", "good"); btnShot.disabled = !videoReady; clearInterval(wait); }
    }, 100);
  }

  async function startCamera(){
    try {
      let s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: 1280, height: 720 } });
      video.srcObject = s; videoReady = true; if(cvReady) btnShot.disabled = false;
    } catch(e) { setStatus("×©×’×™××ª ××¦×œ××”", "bad"); }
  }

  function snapDir(dx, dy){ return Math.abs(dx) >= Math.abs(dy) ? {dx: Math.sign(dx)||1, dy:0} : {dx:0, dy:Math.sign(dy)||1}; }

  btnShot.onclick = () => {
    photo.width = video.videoWidth; photo.height = video.videoHeight;
    photo.getContext("2d").drawImage(video, 0, 0);
    let src = cv.imread(photo), gray = new cv.Mat(), edges = new cv.Mat();
    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
    cv.GaussianBlur(gray, gray, new cv.Size(5,5), 0);
    cv.Canny(gray, edges, 40, 120);
    let kernel = cv.getStructuringElement(cv.MORPH_RECT, new cv.Size(3,3));
    cv.dilate(edges, edges, kernel);
    let cnts = new cv.MatVector(), hi = new cv.Mat();
    cv.findContours(edges, cnts, hi, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
    let big = null, maxA = 0;
    for(let i=0; i<cnts.size(); i++){
      let area = cv.contourArea(cnts.get(i)); if(area > maxA){ maxA = area; big = cnts.get(i); }
    }
    if(!big) return alert("×œ× ××¦××ª×™ ××ª ×”×¦×•×¨×”. × ×¡×” ×œ×¦×œ× ×©×•×‘.");
    let approx = new cv.Mat();
    cv.approxPolyDP(big, approx, 0.015 * cv.arcLength(big, true), true);
    
    polyPts = [];
    for(let i=0; i<approx.rows; i++) polyPts.push({x: approx.intPtr(i,0)[0], y: approx.intPtr(i,0)[1]});

    // --- ×œ×•×’×™×§×ª ×¡×“×¨ ×©×¢×•×Ÿ ××œ××¢×œ×” ---
    // 1. ×‘×“×™×§×ª ×›×™×•×•×Ÿ (Clockwise vs Counter-Clockwise) ×‘××¢×¨×›×ª ×¦×™×¨×™× ×©×œ ×§× ×‘×¡ (Y ×œ××˜×”)
    let area = 0;
    for (let i = 0; i < polyPts.length; i++) {
        let p1 = polyPts[i], p2 = polyPts[(i + 1) % polyPts.length];
        area += (p2.x - p1.x) * (p2.y + p1.y);
    }
    if (area < 0) polyPts.reverse(); // ××•×•×“× ×›×™×•×•×Ÿ ×©×¢×•×Ÿ

    // 2. ××¦×™××ª ×”× ×§×•×“×” ×”×’×‘×•×”×” ×‘×™×•×ª×¨ (Y ××™× ×™××œ×™)
    let topIdx = 0;
    let minY = polyPts[0].y;
    for (let i = 1; i < polyPts.length; i++) {
        if (polyPts[i].y < minY) {
            minY = polyPts[i].y;
            topIdx = i;
        } else if (polyPts[i].y === minY) {
            if (polyPts[i].x < polyPts[topIdx].x) topIdx = i; // ×‘××§×¨×” ×©×œ ×©×•×•×™×•×Ÿ, ×”×©×××œ×™×ª ×‘×™×•×ª×¨
        }
    }

    // 3. ×¡×™×“×•×¨ ××—×“×© ×©×œ ×”××¢×¨×š ×©×™×ª×—×™×œ ××”× ×§×•×“×” ×”×¢×œ×™×•× ×”
    polyPts = polyPts.slice(topIdx).concat(polyPts.slice(0, topIdx));

    overlay.width = photo.width; overlay.height = photo.height;
    let octx = overlay.getContext("2d");
    octx.drawImage(photo, 0, 0);
    octx.lineWidth = 12;
    let inpBox = document.getElementById("inputs"); inpBox.innerHTML = "";
    
    for(let i=0; i<polyPts.length; i++){
      let p1 = polyPts[i], p2 = polyPts[(i+1)%polyPts.length];
      let color = edgeColors[i % edgeColors.length];
      octx.strokeStyle = color;
      octx.beginPath(); octx.moveTo(p1.x, p1.y); octx.lineTo(p2.x, p2.y); octx.stroke();
      let mx = (p1.x+p2.x)/2, my = (p1.y+p2.y)/2;
      octx.fillStyle = "white"; octx.beginPath(); octx.arc(mx, my, 40, 0, 7); octx.fill();
      octx.fillStyle = color; octx.font = "bold 60px Arial"; octx.textAlign="center"; octx.textBaseline="middle";
      octx.fillText(i+1, mx, my);
      inpBox.innerHTML += `
        <div class="input-group" style="border-color: ${color}">
          <label style="color: ${color}">×¦×œ×¢ ××¡' ${i+1}</label>
          <input type="number" class="side-val" placeholder="×”×›× ×¡ ××•×¨×š ×‘×¡×´×">
        </div>`;
    }
    document.getElementById("previewCard").classList.remove("hidden");
    document.getElementById("inputsCard").classList.remove("hidden");
    src.delete(); gray.delete(); edges.delete(); cnts.delete(); hi.delete(); approx.delete(); kernel.delete();
  };

  function isInside(p, poly) {
    let inside = false;
    for (let i = 0, j = poly.length - 1; i < poly.length; j = i++) {
      if (((poly[i].y > p.y) !== (poly[j].y > p.y)) && (p.x < (poly[j].x - poly[i].x) * (p.y - poly[i].y) / (poly[j].y - poly[i].y) + poly[i].x)) inside = !inside;
    }
    return inside;
  }

  function draw(can, rep, pts, sVals, tW, tH) {
    let xs = pts.map(p=>p.x), ys = pts.map(p=>p.y);
    let minX = Math.min(...xs), maxX = Math.max(...xs), minY = Math.min(...ys), maxY = Math.max(...ys);
    let spanX = maxX - minX || 1, spanY = maxY - minY || 1;
    can.width = 1000; can.height = 1000 * (spanY/spanX);
    let ctx = can.getContext("2d"), scale = (can.width - 120) / spanX, tx = (x)=>60+(x-minX)*scale, ty = (y)=>60+(y-minY)*scale;
    ctx.save(); ctx.beginPath(); ctx.moveTo(tx(pts[0].x), ty(pts[0].y));
    pts.forEach(p => ctx.lineTo(tx(p.x), ty(p.y))); ctx.closePath(); ctx.clip();
    let count = 0; ctx.strokeStyle = "#cbd5e1";
    for(let x=minX; x<maxX; x+=tW) for(let y=minY; y<maxY; y+=tH) {
      ctx.strokeRect(tx(x), ty(y), tW*scale, tH*scale);
      if([{x:x,y:y},{x:x+tW,y:y},{x:x,y:y+tH},{x:x+tW,y:y+tH},{x:x+tW/2,y:y+tH/2}].some(p=>isInside(p, pts))) count++;
    }
    ctx.restore();
    ctx.strokeStyle = "#2563eb"; ctx.lineWidth = 8; ctx.beginPath(); ctx.moveTo(tx(pts[0].x), ty(pts[0].y));
    pts.forEach(p => ctx.lineTo(tx(p.x), ty(p.y))); ctx.closePath(); ctx.stroke();
    ctx.fillStyle = "#000"; ctx.font = "bold 24px Arial"; ctx.textAlign = "center";
    for(let i=0; i<sVals.length; i++) ctx.fillText(sVals[i], tx((pts[i].x+pts[i+1].x)/2), ty((pts[i].y+pts[i+1].y)/2) - 15);
    rep.innerHTML = "×›××•×ª ×“×¨×•×©×”: " + count + " ×™×—×™×“×•×ª";
  }

  document.getElementById("btnBuild").onclick = () => {
    let sVals = [...document.getElementsByClassName("side-val")].map(i=>Number(i.value));
    let tW = Number(document.getElementById("tileW").value), tH = Number(document.getElementById("tileH").value);
    if(sVals.some(v=>v<=0)) return alert("×× × ×”×›× ×¡ ××™×“×•×ª ×œ×›×œ ×”×¦×œ×¢×•×ª!");
    let pts = [{x:0,y:0}], curX = 0, curY = 0;
    // ×—×™×©×•×‘ ×›×™×•×•× ×™× ××—×“×© ×œ×¤×™ ×”×¡×“×¨ ×”×—×“×© ×©× ×§×‘×¢ (×©×¢×•×Ÿ ××œ××¢×œ×”)
    for(let i=0; i<polyPts.length; i++){
        let a = polyPts[i], b = polyPts[(i+1)%polyPts.length];
        let snap = snapDir(b.x-a.x, b.y-a.y);
        curX += snap.dx * sVals[i]; curY += snap.dy * sVals[i];
        pts.push({x: curX, y: curY});
    }
    draw(document.getElementById("resultA"), document.getElementById("reportA"), pts, sVals, tW, tH);
    draw(document.getElementById("resultB"), document.getElementById("reportB"), pts, sVals, tH, tW);
    let area = 0; for(let i=0; i<pts.length-1; i++) area += (pts[i].x*pts[i+1].y)-(pts[i+1].x*pts[i].y);
    let perimeter = sVals.reduce((a,b)=>a+b, 0);
    document.getElementById("generalReport").innerHTML = `
        ğŸ“ ×©×˜×— ×›×•×œ×œ: ${(Math.abs(area)/20000).toFixed(2)} ×"×¨ <br>
        ğŸ“ ×”×™×§×£ (×¤× ×œ×™×): ${perimeter} ×¡×´× (${(perimeter/100).toFixed(2)} ××˜×¨)
    `;
    document.getElementById("resultCard").classList.remove("hidden");
    document.getElementById("resultCard").scrollIntoView({behavior:"smooth"});
  };

  startCamera();
  document.getElementById("btnRestart").onclick = () => location.reload();

  // Pinch Zoom (×¨×§ ×¢× ×©×ª×™ ××¦×‘×¢×•×ª ×¢×œ ×”×§× ×‘×¡)
  [document.getElementById("containerA"), document.getElementById("containerB")].forEach(c => {
    c.ontouchstart = (e) => { if(e.touches.length==2) initialDist = Math.hypot(e.touches[0].pageX-e.touches[1].pageX, e.touches[0].pageY-e.touches[1].pageY); };
    c.ontouchmove = (e) => { if(e.touches.length==2) {
      e.preventDefault(); let d = Math.hypot(e.touches[0].pageX-e.touches[1].pageX, e.touches[0].pageY-e.touches[1].pageY);
      currentScale = Math.min(Math.max(0.5, currentScale * (d/initialDist)), 4);
      c.querySelector('canvas').style.transform = `scale(${currentScale})`; initialDist = d;
    }};
  });
</script>

</body>
</html>
6