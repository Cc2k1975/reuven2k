<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MOA Data â€” ×“×£ ×¦×¤×™×™×” ×•× ×™×”×•×œ</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#000;color:#d4af37;margin:0;padding:0}
  .wrap{max-width:980px;margin:18px auto;padding:18px}
  h1{color:#ffd700;text-align:center;margin:0 0 12px;font-size:24px}
  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
  .toolbar input[type=text]{padding:8px;border-radius:8px;border:1px solid #d4af37;background:#111;color:#d4af37}
  button{padding:8px 12px;border-radius:8px;border:0;background:#d4af37;color:#000;cursor:pointer;font-weight:700}
  table{width:100%;border-collapse:collapse;background:#111;border-radius:8px;overflow:hidden;box-shadow:0 6px 18px rgba(255,215,0,0.08)}
  th,td{padding:10px;border-bottom:1px solid #222;text-align:right;color:#d4af37}
  th{background:#222;color:#ffd700;font-weight:700}
  td.actions{width:150px;text-align:center}
  .btn-edit{background:#0288d1;color:#fff;padding:6px 8px;border-radius:6px;border:0;margin-left:6px;cursor:pointer}
  .btn-del{background:#ef5350;color:#fff;padding:6px 8px;border-radius:6px;border:0;cursor:pointer}
  .modal{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6)}
  .modal .box{background:#111;border-radius:10px;padding:16px;max-width:720px;width:94%;color:#ffd700}
  .modal label{display:block;margin-top:8px;font-weight:700}
  .modal input, .modal select {width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid #d4af37;background:#222;color:#ffd700}
  .row{display:flex;gap:8px}
  .small{width:120px}
  .ver{margin-top:12px;text-align:center;color:#bfa76f;font-size:13px}
  .note{font-size:13px;color:#bfa76f}
</style>
</head>
<body>
  <div class="wrap">
    <h1>MOA â€” × ×™×”×•×œ × ×ª×•× ×™ ×¡×§×¨ / ×¦×¤×™×™×”</h1>

    <div class="toolbar">
      <span class="note">×’×¨×¡×” 1.0.0 â€” ×ª×•××š ×‘Ö¾bookings ×•Ö¾answers</span>
      <button id="refresh">×¨×¢× ×Ÿ</button>
      <input id="filterText" type="text" placeholder="×—×¤×© (×©×/×˜×œ×¤×•×Ÿ/××‘× ×”)..." />
      <button id="export">×™×™×¦× CSV</button>
    </div>

    <table id="tbl">
      <thead>
        <tr>
          <th>××—×œ×§×” / ×¡×•×’</th>
          <th>×©×</th>
          <th>×˜×œ×¤×•×Ÿ</th>
          <th>××‘× ×”</th>
          <th>×§×•××”</th>
          <th>×—×“×¨</th>
          <th>×›××•×ª</th>
          <th>×–××Ÿ ×™×¦×™×¨×”</th>
          <th class="actions">×¤×¢×•×œ×•×ª</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="ver" id="status">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
  </div>

  <!-- modal ×¢×¨×™×›×” -->
  <div id="modal" class="modal" role="dialog" aria-modal="true">
    <div class="box">
      <h3>×¢×¨×™×›×ª ×¨×©×•××”</h3>

      <label>××—×œ×§×”</label>
      <input id="m_dept" type="text" />

      <label>×©× ×”×¢×•×‘×“</label>
      <input id="m_name" type="text" />

      <label>××¡×¤×¨ × ×™×™×“</label>
      <input id="m_phone" type="text" />

      <div class="row">
        <div style="flex:1">
          <label>××‘× ×”</label>
          <input id="m_building" type="text" />
        </div>
        <div style="width:120px">
          <label>×§×•××”</label>
          <input id="m_floor" type="text" />
        </div>
        <div style="width:120px">
          <label>×—×“×¨</label>
          <input id="m_room" type="text" />
        </div>
      </div>

      <label>×›××•×ª ××¨×™×–×•×ª</label>
      <input id="m_packs" type="text" />

      <label>×—×“×¨ ×™×¢×“</label>
      <input id="m_target" type="text" />

      <div style="margin-top:12px;text-align:left">
        <button id="saveEdit" class="btn-edit">×©××•×¨</button>
        <button id="cancelEdit" class="btn-del">×‘×™×˜×•×œ</button>
      </div>
    </div>
  </div>

<script>
/*
  MOADATA v1.0.0
  ×ª×•×× ××ª ×”××•×“×œ ×©×œ ×”×§×•×‘×¥ ×©×©×œ×—×ª (×¤×Ÿ-××§×¡×¤×¨×¡). ×¨××• ×’× ××ª ×”×§×•×‘×¥ ×”××§×•×¨×™ ×©×œ×š ×›-reference. î¨1î¨‚

  ×—×©×•×‘: ×× ×‘×¨×¦×•× ×š ×œ×©× ×•×ª BIN / KEY â€” ×¢×¨×•×š ××ª ×”×¢×¨×›×™× ×œ××˜×”.
*/
const BIN_ID    = '68f0e7bed0ea881f40a63b29'; // ×‘×¨×™×¨×ª ××—×“×œ ××”×§×•×‘×¥ ×©×©×œ×—×ª
const MASTER_KEY= '$2a$10$4rynniEMuvwqg2nDb5KSEe/lAVYp8a7L3xWzp9GsO6n49OfXc3FCO'; // ×‘×¨×™×¨×ª ××—×“×œ ××”×§×•×‘×¥ ×©×œ×š
const BIN_URL   = 'https://api.jsonbin.io/v3/b/' + BIN_ID + '?ts=' + Date.now();

// ××œ×× ×˜×™×
const tbody = document.querySelector('#tbl tbody');
const statusEl = document.getElementById('status');
const refreshBtn = document.getElementById('refresh');
const filterInput = document.getElementById('filterText');
const exportBtn = document.getElementById('export');

// modal elements
const modal = document.getElementById('modal');
const m_dept = document.getElementById('m_dept');
const m_name = document.getElementById('m_name');
const m_phone = document.getElementById('m_phone');
const m_building = document.getElementById('m_building');
const m_floor = document.getElementById('m_floor');
const m_room = document.getElementById('m_room');
const m_packs = document.getElementById('m_packs');
const m_target = document.getElementById('m_target');
const saveEditBtn = document.getElementById('saveEdit');
const cancelEditBtn = document.getElementById('cancelEdit');

let currentRecord = null; // ×›×œ ×”××™×“×¢ ××”-BIN
let entries = []; // ××¢×¨×š ×”×¨×©×•××•×ª (bookings ××• answers)
let entriesType = null; // 'bookings' ××• 'answers'
let editingIndex = -1;

/* ----------------- ×¤×•× ×§×¦×™×•×ª ×¨×©×ª ----------------- */
async function fetchMaster(){
  statusEl.textContent = '×˜×•×¢×Ÿ × ×ª×•× ×™× ××”×¢× ×Ÿ...';
  const res = await fetch('https://api.jsonbin.io/v3/b/' + BIN_ID + '?ts=' + Date.now(), {
    headers: { 'X-Master-Key': MASTER_KEY },
    cache: 'no-store'
  });
  if(!res.ok){
    const txt = await res.text().catch(()=>res.statusText);
    throw new Error('fetch failed: ' + res.status + ' ' + txt);
  }
  const j = await res.json();
  return j.record || {};
}

async function putMaster(payload){
  const res = await fetch('https://api.jsonbin.io/v3/b/' + BIN_ID + '?ts=' + Date.now(), {
    method: 'PUT',
    headers: {
      'Content-Type':'application/json',
      'X-Master-Key': MASTER_KEY
    },
    body: JSON.stringify(payload),
    cache: 'no-store'
  });
  if(!res.ok){
    const txt = await res.text().catch(()=>res.statusText);
    throw new Error('put failed: ' + res.status + ' ' + txt);
  }
  return res.json();
}

/* ----------------- ×¢×™×‘×•×“ × ×ª×•× ×™× ----------------- */
function normalizeRecord(rec){
  // ×× ×–×” ×¤×Ÿ-××§×¡×¤×¨×¡ (bookings) ××• ×”×¡×§×¨ (answers).
  if(Array.isArray(rec.bookings)){
    entriesType = 'bookings';
    entries = rec.bookings.slice(); // clone
  } else if(Array.isArray(rec.answers)){
    entriesType = 'answers';
    entries = rec.answers.slice();
  } else {
    // ×× ××£ ××—×“ ×œ× ×§×™×™× â€” × ×™×™×¦×¨ answers ×¨×™×§
    entriesType = 'answers';
    entries = [];
  }
}

function fmtTs(ts){
  try{
    if(!ts) return '';
    const d = new Date(Number(ts));
    if(isNaN(d)) return ts;
    return d.toLocaleString('he-IL');
  }catch(e){ return ts; }
}

function renderTable(filterText=''){
  const f = (filterText||'').trim().toLowerCase();
  const rows = entries
    .map((e, idx) => ({e, idx}))
    .filter(({e}) => {
      if(!f) return true;
      // ×—×¤×© ×œ×¤×™ ×›××” ×©×“×•×ª ××¨×›×–×™×™×
      const hay = [
        e.dept, e.workerName, e.name,
        e.phone, e.building, e.room
      ].filter(Boolean).join(' ').toLowerCase();
      return hay.includes(f);
    });

  if(rows.length===0){
    tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;color:#d4af37;padding:12px">××™×Ÿ ×¨×©×•××•×ª</td></tr>`;
    statusEl.textContent = `×¡×”"×› 0`;
    return;
  }

  tbody.innerHTML = rows.map(({e, idx})=>{
    // ××™×¤×•×™ ×©×“×•×ª ××•×¤×¦×™×•× ×œ×™ (bookings ××• answers)
    const dept = e.dept || e.type || '';
    const name = e.workerName || e.name || e.customer || '';
    const phone = e.phone || '';
    const building = e.building || e.location || '';
    const floor = e.floor || '';
    const room = e.room || e.slot || '';
    const packs = e.packs || e.quantity || '';
    const ts = e.ts || e.createdAt || '';
    return `
      <tr data-idx="${idx}">
        <td>${escapeHtml(dept)}</td>
        <td>${escapeHtml(name)}</td>
        <td>${escapeHtml(phone)}</td>
        <td>${escapeHtml(building)}</td>
        <td>${escapeHtml(floor)}</td>
        <td>${escapeHtml(room)}</td>
        <td>${escapeHtml(packs)}</td>
        <td>${fmtTs(ts)}</td>
        <td class="actions">
          <button class="btn-edit" data-idx="${idx}">âœï¸ ×¢×¨×•×š</button>
          <button class="btn-del" data-idx="${idx}">ğŸ—‘ï¸ ××—×§</button>
        </td>
      </tr>`;
  }).join('');

  statusEl.textContent = `×¡×”"×› ${rows.length} ×¨×©×•××•×ª (type: ${entriesType})`;
  attachRowHandlers();
}

function escapeHtml(s){
  if(s===null || s===undefined) return '';
  return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
}

/* ----------------- ×¤×¢×•×œ×•×ª ×¢×œ ×©×•×¨×” ----------------- */
function attachRowHandlers(){
  Array.from(document.querySelectorAll('.btn-edit')).forEach(b=>{
    b.onclick = ()=> openEdit( Number(b.getAttribute('data-idx')) );
  });
  Array.from(document.querySelectorAll('.btn-del')).forEach(b=>{
    b.onclick = ()=> doDelete( Number(b.getAttribute('data-idx')) );
  });
}

function openEdit(idx){
  editingIndex = idx;
  const rec = entries[idx];
  // ××œ× ××ª ×”×©×“×•×ª ×‘××•×“×œ ×”×¢×¨×™×›×” ×œ×¤×™ ××™×¤×•×™
  m_dept.value = rec.dept || rec.type || '';
  m_name.value = rec.workerName || rec.name || '';
  m_phone.value = rec.phone || '';
  m_building.value = rec.building || '';
  m_floor.value = rec.floor || '';
  m_room.value = rec.room || '';
  m_packs.value = rec.packs || rec.quantity || '';
  m_target.value = rec.targetRoom || rec.target || '';
  modal.style.display = 'flex';
}

function closeModal(){ modal.style.display = 'none'; editingIndex = -1; }

async function saveEdit(){
  if(editingIndex<0) return;
  const rec = entries[editingIndex];
  // ×¢×“×›×Ÿ ×©×“×•×ª ×‘××§×•×¨ ×‘×”×ª×× ×œ××™×¤×•×™
  rec.dept = m_dept.value.trim();
  // ×× ×”××§×•×¨ ×”×™×” bookings ×©× ×•×¦×¨×• ×¢×œ ×™×“×™ ×¤×Ÿ-××§×¡×¤×¨×¡, ×™×™×ª×›×Ÿ ×©×©× ×”×©×“×” ×”×•× name
  if(rec.hasOwnProperty('workerName') || entriesType==='answers') rec.workerName = m_name.value.trim();
  else rec.name = m_name.value.trim();

  rec.phone = m_phone.value.trim();
  rec.building = m_building.value.trim();
  rec.floor = m_floor.value.trim();
  rec.room = m_room.value.trim();
  rec.packs = m_packs.value.trim();
  // ×©××•×¨ ×’× targetRoom ×× ×§×™×™×
  rec.targetRoom = m_target.value.trim();
  rec.ts = Date.now();

  // ×©××™×¨×ª master
  try{
    // ×§×— ×¢×•×ª×§ ×¢×“×›× ×™ ×œ×¤× ×™ ×©××™×¨×”
    currentRecord = await fetchMaster();
    // ×”×—×œ×£ ××ª ×”××¢×¨×š ×”××ª××™× ×‘×¢×•×ª×§ ×¢×“×›× ×™
    if(entriesType==='bookings') currentRecord.bookings = entries;
    else currentRecord.answers = entries;
    await putMaster(currentRecord);
    closeModal();
    renderAll();
  }catch(err){
    alert('×©×’×™××” ×‘×©××™×¨×”: ' + err.message);
    console.error(err);
  }
}

async function doDelete(idx){
  if(!confirm('×œ××—×•×§ ×¨×©×•××” ×–×•?')) return;
  try{
    currentRecord = await fetchMaster();
    // ×”×¡×¨ ××ª ×”×¨×©×•××” ××”××¢×¨×š ×”××§×•××™ ×•×’× ××”×¢×•×ª×§
    entries.splice(idx, 1);
    if(entriesType==='bookings') currentRecord.bookings = entries;
    else currentRecord.answers = entries;
    await putMaster(currentRecord);
    renderAll();
  }catch(err){
    alert('×©×’×™××” ×‘××—×™×§×”: ' + err.message);
    console.error(err);
  }
}

/* ----------------- ×™×™×¦×•× CSV ----------------- */
function toCSV(arr){
  const hdr = ['dept','name','phone','building','floor','room','packs','ts'];
  const rows = arr.map(e => {
    const name = e.workerName || e.name || '';
    return [
      csvSafe(e.dept||''), csvSafe(name), csvSafe(e.phone||''), csvSafe(e.building||''),
      csvSafe(e.floor||''), csvSafe(e.room||''), csvSafe(e.packs||''), csvSafe(e.ts||'')
    ].join(',');
  });
  return hdr.join(',') + '\n' + rows.join('\n');
}
function csvSafe(v){ return '"'+String(v||'').replace(/"/g,'""')+'"'; }

/* ----------------- ×–×¨×™××ª ×¢×‘×•×“×” ×¨××©×™×ª ----------------- */
async function renderAll(){
  try{
    const rec = await fetchMaster();
    currentRecord = rec;
    normalizeRecord(rec);
    renderTable(filterInput.value);
  }catch(err){
    statusEl.textContent = '×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×: ' + err.message;
    tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;color:#d4af37;padding:12px">×©×’×™××” ×‘×˜×¢×™× ×”</td></tr>`;
    console.error(err);
  }
}

/* ××™×¨×•×¢×™× */
refreshBtn.addEventListener('click', renderAll);
filterInput.addEventListener('input', ()=> renderTable(filterInput.value));
exportBtn.addEventListener('click', ()=>{
  const csv = toCSV(entries);
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'moadata_export.csv';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

cancelEditBtn.addEventListener('click', closeModal);
saveEditBtn.addEventListener('click', saveEdit);

// close modal on click outside
modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });

// ×”×¤×¢×œ×ª ×”×“×£
renderAll();
</script>
</body>
</html>
