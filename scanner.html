<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>×¡×•×¨×§ Pro - ××ª×•×§×Ÿ</title>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- OpenCV: ×¢×“×™×£ ×‘×œ×™ async ×›×“×™ ×œ×× ×•×¢ race-conditions -->
  <script src="https://docs.opencv.org/4.7.0/opencv.js"></script>

  <style>
    * { box-sizing: border-box; }
    body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; color: #fff; font-family: sans-serif; }
    .app { display: flex; flex-direction: column; height: 100dvh; }

    #debug { background: #1a1a1a; color: #0f0; font-size: 11px; padding: 6px; text-align: center; border-bottom: 1px solid #333; }

    .viewer { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; background: #000; }
    video, canvas { max-width: 100%; max-height: 100%; object-fit: contain; }

    /* ×‘×ª×—×™×œ×” canvas ××•×¡×ª×¨ */
    #canvasOutput { display: none; }

    .footer { height: 160px; background: #111; display: flex; flex-direction: column; align-items: center; justify-content: space-evenly; border-top: 1px solid #222; }

    .snap-btn { width: 75px; height: 75px; background: #fff; border-radius: 50%; border: 6px solid #333; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
    .snap-btn:active { transform: scale(0.9); background: #ccc; }
    .snap-inner { width: 55px; height: 55px; border-radius: 50%; border: 2px solid #000; }

    .btn-group { display: none; gap: 15px; width: 90%; }
    .btn { flex: 1; padding: 16px; border-radius: 12px; border: none; font-weight: bold; font-size: 16px; cursor: pointer; }
    .btn-send { background: #25d366; color: #fff; }
    .btn-cancel { background: #333; color: #fff; }

    #loader { position: fixed; inset: 0; background: #000; z-index: 99; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .spinner { width: 40px; height: 40px; border: 4px solid #222; border-top: 4px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>

<body>
  <div id="loader">
    <div class="spinner"></div>
    <p>×˜×•×¢×Ÿ ××ª ×”××¢×¨×›×ª...</p>
  </div>

  <div class="app">
    <div id="debug">Log: ×××ª×™×Ÿ ×œ-OpenCV</div>

    <div class="viewer">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="canvasOutput"></canvas>
    </div>

    <div class="footer">
      <div id="msg">×›×•×•×Ÿ ××œ ×”×“×£ ×•×œ×—×¥ ×¦×™×œ×•×</div>

      <div id="ui-capture">
        <div class="snap-btn" id="snapBtn">
          <div class="snap-inner"></div>
        </div>
      </div>

      <div id="ui-result" class="btn-group">
        <button class="btn btn-cancel" id="cancelBtn">ğŸ”„ ×‘×™×˜×•×œ</button>
        <button class="btn btn-send" id="sendBtn">ğŸ“© ×©×œ×— PDF</button>
      </div>
    </div>
  </div>

<script>
  const log = (m) => document.getElementById('debug').innerText = "Log: " + m;

  const video = document.getElementById('video');
  const canvas = document.getElementById('canvasOutput');

  const loader = document.getElementById('loader');
  const msg = document.getElementById('msg');
  const uiCapture = document.getElementById('ui-capture');
  const uiResult = document.getElementById('ui-result');

  const snapBtn = document.getElementById('snapBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const sendBtn = document.getElementById('sendBtn');

  let streamRef = null;
  let cvReady = false;
  let cameraReady = false;

  // 1) OpenCV ××•×›×Ÿ ×‘×¦×•×¨×” ×™×¦×™×‘×”
  if (typeof cv === 'undefined') {
    log("×©×’×™××”: OpenCV ×œ× × ×˜×¢×Ÿ");
  } else {
    cv.onRuntimeInitialized = async () => {
      cvReady = true;
      log("OpenCV ××•×›×Ÿ, ×¤×•×ª×— ××¦×œ××”...");
      await initCamera();
    };
  }

  // 2) ×¤×ª×™×—×ª ××¦×œ××” + ×•×™×“×•× ×©×”×•×™×“××• ×‘×××ª ××•×›×Ÿ
  async function initCamera() {
    try {
      streamRef = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: "environment" },
          width: { ideal: 1920 },
          height: { ideal: 1080 }
        },
        audio: false
      });

      video.srcObject = streamRef;

      // ××—×›×™× ×©×”×•×™×“××• ×™×ª×—×™×œ ×œ×ª×ª ×¤×¨×™×™××™× ×××™×ª×™×™×
      await new Promise((resolve) => {
        const onReady = () => {
          if (video.videoWidth > 0 && video.videoHeight > 0) {
            video.removeEventListener('loadedmetadata', onReady);
            video.removeEventListener('canplay', onReady);
            resolve();
          }
        };
        video.addEventListener('loadedmetadata', onReady);
        video.addEventListener('canplay', onReady);
      });

      cameraReady = true;
      loader.style.display = "none";
      log(`××¢×¨×›×ª ××•×›× ×” âœ… (${video.videoWidth}x${video.videoHeight})`);
    } catch (e) {
      loader.style.display = "none";
      log("×©×’×™××” ×‘×¤×ª×™×—×ª ××¦×œ××”");
      alert("×œ× ×”×¦×œ×—×ª×™ ×œ×¤×ª×•×— ××¦×œ××”. ×•×“× ×©×™×© ×”×¨×©××”, ×•×©××ª×” ×‘-HTTPS (××• localhost).");
      console.error(e);
    }
  }

  snapBtn.addEventListener('click', processDoc);
  cancelBtn.addEventListener('click', () => location.reload());
  sendBtn.addEventListener('click', sendToWhatsApp);

  function ensureCanvasSize(w, h) {
    // ×—×©×•×‘: ×œ×§×‘×•×¢ ×’×•×“×œ ×××™×ª×™ ×œ-canvas, ××—×¨×ª ×”×ª××•× ×”/×”-PDF ×™×•×¦××™× ×œ× × ×›×•×Ÿ
    if (canvas.width !== w) canvas.width = w;
    if (canvas.height !== h) canvas.height = h;
  }

  function processDoc() {
    if (!cvReady) { log("OpenCV ×¢×“×™×™×Ÿ ×œ× ××•×›×Ÿ"); return; }
    if (!cameraReady) { log("×”××¦×œ××” ×¢×“×™×™×Ÿ ×œ× ××•×›× ×”"); return; }
    if (video.videoWidth === 0 || video.videoHeight === 0) { log("×•×™×“××• ×œ× ××•×›×Ÿ (0x0)"); return; }

    try {
      log("××¢×‘×“... × × ×œ× ×œ×”×–×™×–");

      const rows = video.videoHeight;
      const cols = video.videoWidth;

      ensureCanvasSize(cols, rows);

      // ×§×•×¨××™× ×¤×¨×™×™× ×œ-Mat
      const cap = new cv.VideoCapture(video);
      let src = new cv.Mat(rows, cols, cv.CV_8UC4);
      cap.read(src);

      // ×× ×”×¤×¨×™×™× ×™×¦× ×¨×™×§/×©×—×•×¨, ×‘×“×¨×š ×›×œ×œ ×–×” ×›×™ ×”×•×™×“××• ×œ× ×‘×××ª ××•×›×Ÿ
      // ××‘×œ ×× ×—× ×• ×›×‘×¨ ×”×’× ×• ×¢×œ ×–×” ×œ××¢×œ×”
      let gray = new cv.Mat();
      cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

      // × ×™×§×•×™ ×¨×¢×© ×§×˜×Ÿ ×œ×©×™×¤×•×¨ ×ª×•×¦××”
      let blur = new cv.Mat();
      cv.GaussianBlur(gray, blur, new cv.Size(3, 3), 0);

      // ×¡×£ ××“×¤×˜×™×‘×™ ×œ××¡××š
      let bw = new cv.Mat();
      cv.adaptiveThreshold(
        blur, bw, 255,
        cv.ADAPTIVE_THRESH_GAUSSIAN_C,
        cv.THRESH_BINARY,
        21, 15
      );

      cv.imshow(canvas, bw);

      // UI
      video.style.display = 'none';
      canvas.style.display = 'block';
      uiCapture.style.display = 'none';
      uiResult.style.display = 'flex';
      msg.innerText = "×¡×¨×™×§×” ×”×•×©×œ××” ×‘×”×¦×œ×—×”!";

      // × ×™×§×•×™ ×–×™×›×¨×•×Ÿ
      src.delete(); gray.delete(); blur.delete(); bw.delete();

      log("×”×¡×¨×™×§×” ××•×›× ×” ×œ×©×™×ª×•×£");
    } catch (err) {
      log("×©×’×™××”: " + (err?.message || err));
      console.error(err);
    }
  }

  async function sendToWhatsApp() {
    try {
      log("××›×™×Ÿ ×§×•×‘×¥ PDF...");

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'p' });

      // ×ª××•× ×” ××”-canvas
      const imgData = canvas.toDataURL('image/jpeg', 0.9);

      // ×”×ª×××ª ×™×—×¡ ×œ×ª×•×š A4 ×‘×œ×™ ×¢×™×•×•×ª
      const pageW = 210;  // mm
      const pageH = 297;  // mm

      // ×™×—×¡ ×ª××•× ×”
      const imgWpx = canvas.width;
      const imgHpx = canvas.height;
      const imgRatio = imgWpx / imgHpx;

      let drawW = pageW;
      let drawH = drawW / imgRatio;

      if (drawH > pageH) {
        drawH = pageH;
        drawW = drawH * imgRatio;
      }

      const x = (pageW - drawW) / 2;
      const y = (pageH - drawH) / 2;

      pdf.addImage(imgData, 'JPEG', x, y, drawW, drawH, undefined, 'FAST');

      const blob = pdf.output('blob');
      const file = new File([blob], "document_scan.pdf", { type: "application/pdf" });

      if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share({
          files: [file],
          title: '×”×¡×¨×™×§×” ×©×œ×™',
          text: '××¦×•×¨×£ ×”××¡××š ×©×¡×¨×§×ª×™'
        });
        log("×©×™×ª×•×£ × ×¤×ª×—");
      } else if (navigator.share) {
        // ×™×© ××›×©×™×¨×™× ×©×ª×•××›×™× share ××‘×œ ×œ× files
        const url = URL.createObjectURL(blob);
        await navigator.share({ title: '×”×¡×¨×™×§×” ×©×œ×™', text: '×”××¡××š ××•×›×Ÿ. ×× ×œ× ××¦×•×¨×£ ×§×•×‘×¥, ×”×•×¨×“ ××•×ª×• ×™×“× ×™×ª.', url });
        log("×©×™×ª×•×£ (×œ×œ× ×§×•×‘×¥) × ×¤×ª×—");
      } else {
        pdf.save("document_scan.pdf");
        log("×”×•×¨×“×” ×‘×•×¦×¢×” (××™×Ÿ Share API)");
      }
    } catch (e) {
      log("×©×™×ª×•×£ ×‘×•×˜×œ/× ×›×©×œ");
      console.error(e);
    }
  }
</script>
</body>
</html>
