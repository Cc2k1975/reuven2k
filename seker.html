<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>סקר</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<style>
:root{
  --bg:#000;
  --panel:#111;
  --text-main:#ffd700;
  --text-body:#ddd;
  --border:#ccaa22;
  --error-bg:#500;
  --ok-bg:#063;
  --btn-bg:#d2b11c;
  --btn-text:#000;
  --radius:8px;
  --font:Arial,Helvetica,sans-serif;
}
body{
  margin:0;
  background:var(--bg);
  font-family:var(--font);
  color:var(--text-body);
  display:flex;
  justify-content:center;
  padding:16px;
}
.wrap{
  width:100%;
  max-width:520px;
  background:var(--panel);
  border-radius:var(--radius);
  box-shadow:0 0 20px #000;
  padding:20px 16px 32px;
  border:1px solid #222;
}
h1{
  margin:0 0 16px;
  text-align:center;
  color:var(--text-main);
  font-size:28px;
  font-weight:700;
}

/* הסטטוס הישן נשאר בדום אבל לא מוצג יותר */
.status{
  min-height:44px;
  border-radius:var(--radius);
  padding:12px 16px;
  font-size:16px;
  line-height:1.4;
  font-weight:600;
  text-align:center;
  margin-bottom:16px;
  display:none;
  white-space:pre-line;
  color:#fff;
}
.status.ok{background:var(--ok-bg);}
.status.err{background:var(--error-bg);}

label{
  display:block;
  color:var(--text-main);
  font-size:20px;
  font-weight:600;
  margin:20px 4px 8px;
}
input,select,textarea{
  width:100%;
  box-sizing:border-box;
  background:#222;
  color:var(--text-body);
  border:2px solid var(--border);
  border-radius:var(--radius);
  font-size:20px;
  padding:14px 12px;
  font-family:inherit;
}
input::placeholder,
textarea::placeholder{
  color:#777;
}
select{
  appearance:none;
  background-image:linear-gradient(#222,#222),linear-gradient(to top,#222,#222);
}

.actions{
  margin-top:28px;
  display:flex;
  flex-direction:column;
  gap:12px;
}
button.sendBtn{
  width:100%;
  background:var(--btn-bg);
  color:var(--btn-text);
  font-size:24px;
  font-weight:700;
  border:0;
  border-radius:var(--radius);
  padding:12px;
  cursor:pointer;
}
button.sendBtn:active{
  filter:brightness(0.9);
}

.ver{
  text-align:center;
  font-size:13px;
  color:#888;
  margin-top:16px;
  line-height:1.4;
}

/* =========== פופאפ מרכזי =========== */
#modalOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
  display:none;            /* נפתח ב-JS */
  align-items:center;
  justify-content:center;
  z-index:9999;
}
#modalBox{
  width:90%;
  max-width:320px;
  background:#111;
  border-radius:var(--radius);
  border:2px solid var(--border);
  box-shadow:0 20px 60px rgba(0,0,0,0.9);
  padding:20px 16px 16px;
  text-align:center;
  color:#fff;
  font-family:var(--font);
}
#modalMessage{
  white-space:pre-line;
  color:#fff;
  font-size:18px;
  font-weight:600;
  line-height:1.4;
  margin-bottom:16px;
  padding:12px;
  border-radius:var(--radius);
}
#modalOkBtn{
  width:100%;
  background:var(--btn-bg);
  color:var(--btn-text);
  font-size:18px;
  font-weight:700;
  border:0;
  border-radius:var(--radius);
  padding:12px;
  cursor:pointer;
}
#modalOkBtn:active{
  filter:brightness(0.9);
}
</style>
</head>
<body>
<div class="wrap">

  <h1>עוברים לחדרה</h1>

  <div id="statusBox" class="status"></div>

  <form id="surveyForm">

    <label for="dept">מחלקה:</label>
    <select id="dept" required>
      <option value="">בחר מחלקה…</option>
      <option>אווירודינמיקה</option>
      <option>מחמ</option>
      <option>מטה</option>
      <option>ניווט</option>
      <option>בקמ</option>
      <option>טילאות</option>
      <option>סימולציות</option>
    </select>

    <label for="workerName">שם העובד:</label>
    <input id="workerName" type="text" placeholder="שם מלא" required>

    <label for="phone">מספר נייד:</label>
    <input id="phone" type="tel" placeholder="05X-XXXXXXX" required>

    <label for="building"> מבנה איסוף:</label>
    <input id="building" type="text" placeholder="לדוגמה: 666" required>

    <label for="floor">קומה איסוף:</label>
    <input id="floor" type="text" placeholder="לדוגמה: 3" required>

    <label for="room"> חדר איסוף :</label>
    <input id="room" type="text" placeholder="לדוגמה: 305" required>

    <label for="packs">כמות אריזות:</label>
    <select id="packs" required>
      <option value="">בחר כמות…</option>
      <option>1</option>
      <option>2</option>
      <option>3</option>
      <option>4</option>
      <option>5</option>
    </select>

    <label for="targetRoom">חדר יעד:</label>
    <input id="targetRoom" type="text" placeholder="חדר קולט בחדרה" required>

    <div class="actions">
      <button type="submit" class="sendBtn">שלח</button>
    </div>

  </form>

  <div class="ver">
    גרסה 1.0.3<br>
    charles
  </div>

</div>

<!-- פופאפ -->
<div id="modalOverlay">
  <div id="modalBox">
    <div id="modalMessage"></div>
    <button id="modalOkBtn">אישור</button>
  </div>
</div>

<script>
const BIN_ID     = "68fefa3dd0ea881f40beb941";
const ACCESS_KEY = "$2a$10$cSsqpLyw9Jl/8q0El4JzqOuwLRUINEoMNeyxeUQ726QdlvNMD0iTe";
const API_BASE   = "https://api.jsonbin.io/v3/b";

const statusBox   = document.getElementById('statusBox'); // נשאר קיים אבל לא משמש יותר להצגה
const form        = document.getElementById('surveyForm');

const modalOverlay  = document.getElementById('modalOverlay');
const modalMessage  = document.getElementById('modalMessage');
const modalOkBtn    = document.getElementById('modalOkBtn');

// מציג פופאפ באמצע עם צבע הנכון
function showPopup(msg,isOk){
  // קובע את צבע הרקע של ההודעה בפופאפ לפי הצלחה/שגיאה
  modalMessage.style.backgroundColor = isOk ? "var(--ok-bg)" : "var(--error-bg)";
  modalMessage.textContent = msg;

  modalOverlay.style.display = "flex";
}

// סוגר את הפופאפ
function closePopup(){
  modalOverlay.style.display = "none";
}

// השארנו את הפונקציה המקורית showStatus רק כדי לא לשבור כלום,
// אבל עכשיו היא פשוט עוטפת ל-showPopup.
function showStatus(msg,isOk){
  showPopup(msg,isOk);
}

// טעינת כל התוכן הקיים (answers) מהשרת
async function fetchAllAnswers(){
  const url = API_BASE + "/" + BIN_ID;
  const res = await fetch(url,{
    method:"GET",
    headers:{
      "Content-Type":"application/json",
      "X-Access-Key": ACCESS_KEY
    }
  });
  if(!res.ok){
    throw new Error("שגיאת רשת בקריאה BIN. status="+res.status);
  }
  const data = await res.json();
  if(!data.record || !Array.isArray(data.record.answers)){
    return [];
  }
  return data.record.answers;
}

// שמירת answers חדש חזרה לשרת (PUT)
async function saveAllAnswers(updatedArray){
  const url = API_BASE + "/" + BIN_ID;
  const bodyObj = { answers: updatedArray };
  const res = await fetch(url,{
    method:"PUT",
    headers:{
      "Content-Type":"application/json",
      "X-Access-Key": ACCESS_KEY
    },
    body: JSON.stringify(bodyObj)
  });
  if(!res.ok){
    throw new Error("שגיאה בשמירה ל-BIN. status="+res.status);
  }
  return res.json();
}

// שליחת הטופס
form.addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  showStatus("בודק נתונים...", true);

  const answer = {
    dept:        document.getElementById('dept').value.trim(),
    workerName:  document.getElementById('workerName').value.trim(),
    phone:       document.getElementById('phone').value.trim(),
    building:    document.getElementById('building').value.trim(),
    floor:       document.getElementById('floor').value.trim(),
    room:        document.getElementById('room').value.trim(),
    packs:       document.getElementById('packs').value.trim(),
    targetRoom:  document.getElementById('targetRoom').value.trim(),
    ts:          new Date().toISOString()
  };

  // ולידציה בסיסית
  if(!answer.dept||!answer.workerName||!answer.phone||!answer.building||
     !answer.floor||!answer.room||!answer.packs||!answer.targetRoom){
    showStatus("נא למלא את כל השדות.",false);
    return;
  }

  try{
    const arr = await fetchAllAnswers();

    // בדיקה אם המספר כבר קיים
    const exists = arr.some(x => x.phone === answer.phone);
    if(exists){
      showStatus("נרשמת כבר, אנא פנה לצ׳רלס שיין 0523719856", false);
      return;
    }

    arr.push(answer); // מוסיף חדש
    await saveAllAnswers(arr);
    showStatus("נשמר בהצלחה ✔", true);
    form.reset();

  }catch(err){
    showStatus("שגיאה בשמירה: "+err.message,false);
  }
});

// כפתור אישור בפופאפ סוגר אותו
modalOkBtn.addEventListener('click', closePopup);
</script>
</body>
</html>
