<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>×¤×Ÿ ××§×¡×¤×¨×¡ â€“ ×¦'××˜ ×œ×–×™××•×Ÿ ×ª×•×¨</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#d4af37">
<link rel="apple-touch-icon" href="/Icon app.png" />

<style>
  body {
    font-family: Arial, Helvetica, sans-serif;
    background: #000;
    margin: 0;
    padding: 0;
    color: #d4af37;
  }

  .hero-logo {
    width: 92px;
    display: block;
    margin: -6px auto -10px auto;
  }

  .wrap {
    max-width: 520px;
    margin: 4px auto;
    padding: 16px 14px 14px;
    background: #111;
    border-radius: 16px;
    box-shadow: 0 6px 18px rgba(255, 215, 0, 0.25);
  }

  h1 {
    margin: 0 0 2px;
    font-size: 30px;
    color: #ffd700;
    text-align: center;
  }

  h2 {
    margin: 0 0 10px;
    font-size: 18.5px;
    color: #d4af37;
    text-align: center;
  }

  .chat {
    height: min(62vh, 520px);
    overflow: auto;
    padding: 10px;
    border: 1px solid rgba(212,175,55,.55);
    border-radius: 14px;
    background: #0b0b0b;
  }

  .row {
    display: flex;
    margin: 10px 0;
    gap: 10px;
  }

  .bubble {
    max-width: 86%;
    padding: 10px 12px;
    border-radius: 14px;
    line-height: 1.35;
    font-size: 16px;
    white-space: pre-line;
  }

  .bot {
    justify-content: flex-end;
  }
  .bot .bubble{
    background: #151515;
    border: 1px solid rgba(212,175,55,.55);
    color: #ffd700;
    border-bottom-right-radius: 6px;
  }

  .me {
    justify-content: flex-start;
  }
  .me .bubble{
    background: #d4af37;
    color: #000;
    border: 0;
    border-bottom-left-radius: 6px;
    font-weight: 700;
  }

  .typing {
    opacity: .85;
    font-size: 14px;
    padding: 6px 10px;
  }

  .composer {
    display: flex;
    gap: 10px;
    margin-top: 10px;
    align-items: center;
  }

  input, button {
    border-radius: 12px;
    font-size: 16px;
    box-sizing: border-box;
  }

  #input {
    flex: 1;
    padding: 12px 14px;
    border: 1px solid #d4af37;
    background: #222;
    color: #ffd700;
    outline: none;
  }

  #send {
    width: 92px;
    padding: 12px 10px;
    background: #d4af37;
    color: #000;
    border: 0;
    cursor: pointer;
    font-weight: 900;
  }
  #send[disabled] { opacity: .6; cursor: not-allowed; }

  .quick {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
  }

  .chip {
    padding: 10px 12px;
    border-radius: 999px;
    border: 1px solid rgba(212,175,55,.7);
    background: #111;
    color: #ffd700;
    cursor: pointer;
    font-weight: 800;
    font-size: 14.5px;
    user-select: none;
  }
  .chip:active { transform: scale(0.99); }
  .chip[disabled] { opacity: .5; cursor: not-allowed; }

  .error {
    background: #330000;
    color: #ff6666;
    border: 1px solid #ff9999;
    padding: 9px 10px;
    border-radius: 12px;
    margin-top: 10px;
    display: none;
    font-size: 15px;
  }

  .success {
    background: #003300;
    color: #66ff99;
    border: 1px solid #99ffcc;
    padding: 9px 10px;
    border-radius: 12px;
    margin-top: 10px;
    display: none;
    font-size: 15px;
  }

  .toolbar {
    display: flex;
    gap: 10px;
    margin-top: 10px;
  }

  .btn-secondary {
    flex: 1;
    background: #000;
    color: #ffd700;
    border: 1px solid #d4af37;
    padding: 10px 10px;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 900;
    font-size: 14.5px;
  }

  .btn-secondary img.icon {
    width: 24px;
    height: 24px;
    vertical-align: middle;
    margin: 0 6px;
  }

  .ver {
    margin-top: 12px;
    font-size: 12.4px;
    color: #bfa76f;
    text-align: center;
  }

  /* Modal (×›××• ××¦×œ×š) */
  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 50;
  }

  .modal {
    background: #111;
    border-radius: 14px;
    max-width: 420px;
    width: 92%;
    padding: 18px 18px 12px;
    box-shadow: 0 0 25px rgba(255,215,0,.3);
    color: #ffd700;
  }

  .modal h3 {
    margin: 0 0 8px;
    font-size: 20.7px;
    color: #ffd700;
  }

  .modal p {
    margin: 0 0 14px;
    color: #ffd700;
    white-space: pre-line;
    font-size: 15px;
  }

  .modal .row2 {
    display: flex;
    gap: 10px;
    justify-content: space-between;
  }

  .modal .row2 button {
    flex: 1;
    padding: 10px;
    border-radius: 10px;
    border: 0;
    font-weight: 900;
    font-size: 15px;
    cursor: pointer;
  }

  .modal .cancel {
    background: #222;
    color: #ffd700;
    border: 1px solid #ffd700;
  }

  .modal .ok {
    background: #ffd700;
    color: #000;
  }
</style>
</head>
<body>

<img src="https://reuven2k.com/exe.gif" alt="×¤×Ÿ ××§×¡×¤×¨×¡" class="hero-logo" />

<div class="wrap">
  <h1>×¤×Ÿ ××§×¡×¤×¨×¡</h1>
  <h2>×¦'××˜ ×œ×–×™××•×Ÿ ×ª×•×¨×™×</h2>

  <div id="msgError" class="error"></div>
  <div id="msgOk" class="success"></div>

  <div id="chat" class="chat" aria-live="polite"></div>
  <div id="quick" class="quick"></div>

  <div class="composer">
    <input id="input" type="text" placeholder="×›×ª×•×‘ ×›××Ÿ..." autocomplete="off" />
    <button id="send">×©×œ×—</button>
  </div>

  <div class="toolbar">
    <button id="galleryBtn" type="button" class="btn-secondary"><b>×’×œ×¨×™×™×ª ×¢×‘×•×“×•×ª</b></button>
    <button id="navWaze" type="button" class="btn-secondary">
      <b>× ×•×•×˜ ×œ ×¤×Ÿ-××§×¡×¤×¨×¡</b>
      <img class="icon" src="https://reuven2k.com/map.png" alt="" />
    </button>
  </div>

  <div class="ver">Version: 1.6.2-chat</div>
</div>

<div id="icsModal" class="modal-backdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <h3>×œ×”×•×¡×™×£ ×ª×–×›×•×¨×ª ×œ×™×•××Ÿ?</h3>
    <p id="icsText">× ×™×¦×•×¨ ××™×¨×•×¢ ×œ×™×•××Ÿ ×‘×ª××¨×™×š ___ ×‘×©×¢×” ___ ×›×•×œ×œ ×ª×–×›×•×¨×ª ×©×¢×” ×œ×¤× ×™.
×œ×§×•×—×” ×™×§×¨×”, ××–×›×™×¨×” ×œ×š ×œ×”×’×™×¢ ×—×¤×•×¤×” ×•×‘×–××Ÿ ğŸ’‡â€â™€ï¸
×ª×•×“×” - ×¤×Ÿ ××§×¡×¤×¨×¡</p>
    <div class="row2">
      <button type="button" class="cancel" id="btnCancel">×‘×™×˜×•×œ</button>
      <button type="button" class="ok" id="btnOk">××™×©×•×¨</button>
    </div>
  </div>
</div>

<script>
/* ===== ××•×ª×• Backend ×‘×“×™×•×§ ×›××• ××¦×œ×š ===== */
const BIN_ID = '68f0e7bed0ea881f40a63b29';
const MASTER_KEY = '$2a$10$4rynniEMuvwqg2nDb5KSEe/lAVYp8a7L3xWzp9GsO6n49OfXc3FCO';
const BIN_URL = 'https://api.jsonbin.io/v3/b/' + BIN_ID;

const MAP_URL = 'https://maps.google.com/?q=33.003292,35.108864';
const WAZE_DEEP = 'waze://?ll=33.003292,35.108864&navigate=yes';
const WAZE_WEB  = 'https://waze.com/ul?ll=33.003292%2C35.108864&navigate=yes';
const GALLERY_URL = 'https://reuven2k.com/images/index.html';

const TIMEZONE = 'Asia/Jerusalem';
const EVENT_TITLE = '×ª×•×¨ ×œ ×¤×Ÿ ××§×¡×¤×¨×¡';
const ALARM_MINUTES = 60;
const SLOT_MINUTES = 20;

/* ===== Utils ===== */
const pad2 = n => (n<10?('0'+n):''+n);

function genTimeSlots(){
  const slots=[];
  for(let h=8; h<=20; h++){
    for(let m of [0,20,40]){
      if(h===20 && m>0) continue;
      slots.push(`${pad2(h)}:${pad2(m)}`);
    }
  }
  return slots;
}
const SLOTS = genTimeSlots();

function todayStr(){ return new Date().toISOString().slice(0,10); }
function addDaysStr(days){ const d=new Date(); d.setDate(d.getDate()+days); return d.toISOString().slice(0,10); }
function fmtDateHeb(s){ const [y,m,d]=s.split('-'); return `${d}.${m}.${y}`; }

function validPhone(p){ return (p||'').replace(/\D/g,'').length>=8; }
function normalizePhone(p){ return (p||'').replace(/\D/g,''); }

function parseTimeLike(t){
  const s=(t||'').trim();
  // ×ª×•××š "17:20" / "1720" / "17.20"
  let m=s.match(/^(\d{1,2})\s*[:.]\s*(\d{2})$/);
  if(m){
    let hh=+m[1], mm=+m[2];
    if(hh>=0 && hh<=23 && (mm===0||mm===20||mm===40)) return `${pad2(hh)}:${pad2(mm)}`;
    return null;
  }
  m=s.match(/^(\d{1,2})(\d{2})$/);
  if(m){
    let hh=+m[1], mm=+m[2];
    if(hh>=0 && hh<=23 && (mm===0||mm===20||mm===40)) return `${pad2(hh)}:${pad2(mm)}`;
  }
  return null;
}

/* ===== Fetch/Put Record (×›××• ××¦×œ×š) ===== */
let BOOKING_OPEN = true;

async function fetchRecord(){
  const r = await fetch(BIN_URL+'?ts='+Date.now(), {
    headers: {'X-Master-Key': MASTER_KEY},
    cache: 'no-store'
  });
  if(!r.ok) throw new Error('fetch failed');
  const j = await r.json();
  const rec = (j.record && Array.isArray(j.record.bookings)) ? j.record : {bookings:[]};
  BOOKING_OPEN = (typeof rec.bookingOpen === 'boolean') ? rec.bookingOpen : true;
  return rec;
}

async function putRecord(rec){
  const r = await fetch(BIN_URL+'?ts='+Date.now(), {
    method: 'PUT',
    headers: {'Content-Type':'application/json','X-Master-Key': MASTER_KEY},
    body: JSON.stringify(rec),
    cache: 'no-store'
  });
  if(!r.ok) throw new Error('put failed');
  return r.json().catch(()=> ({}));
}

/* ===== ICS (×›××• ××¦×œ×š) ===== */
function toICSLocal(dateStr,timeStr){
  const [y,m,d]=dateStr.split('-').map(Number);
  const [hh,mm]=timeStr.split(':').map(Number);
  const dt=new Date(y,m-1,d,hh,mm,0);
  return `${dt.getFullYear()}${pad2(dt.getMonth()+1)}${pad2(dt.getDate())}T${pad2(dt.getHours())}${pad2(dt.getMinutes())}00`;
}
function buildICS({title,location,startLocal,endLocal,tzid}){
  const uid=`${Date.now()}-${Math.random().toString(36).slice(2)}@fenexpress`;
  const dtstamp=new Date().toISOString().replace(/[-:]/g,'').replace(/\.\d{3}Z$/,'Z');
  const details=`×§×™×©×•×¨ ×™×©×™×¨ ×œ×”×’×¢×” ×œ×¤×Ÿ ××§×¡×¤×¨×¡:\n${MAP_URL}`;
  return [
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//FenExpress//Booking//HE',
    'CALSCALE:GREGORIAN',
    'METHOD:PUBLISH',
    'BEGIN:VEVENT',
    `UID:${uid}`,
    `DTSTAMP:${dtstamp}`,
    `DTSTART;TZID=${tzid}:${startLocal}`,
    `DTEND;TZID=${tzid}:${endLocal}`,
    `SUMMARY:${title}`,
    `DESCRIPTION:${details.replace(/\n/g,'\\n')}`,
    `LOCATION:${location}`,
    'BEGIN:VALARM',
    'ACTION:DISPLAY',
    'DESCRIPTION:Reminder',
    `TRIGGER:-PT${ALARM_MINUTES}M`,
    'END:VALARM',
    'END:VEVENT',
    'END:VCALENDAR'
  ].join('\r\n');
}

function openCalendarDirect(dateStr,timeStr){
  const ua = navigator.userAgent || '';
  const isAndroid = /Android/i.test(ua);
  const isIOS = /iPhone|iPad|iPod/i.test(ua);

  const [y,m,d]=dateStr.split('-').map(Number);
  const [hh,mm]=timeStr.split(':').map(Number);
  const start=new Date(y,m-1,d,hh,mm,0);
  const end=new Date(start.getTime()+SLOT_MINUTES*60000);

  if(isAndroid){
    const fmt = (dt)=>`${dt.getFullYear()}${pad2(dt.getMonth()+1)}${pad2(dt.getDate())}T${dt.getHours().toString().padStart(2,'0')}${dt.getMinutes().toString().padStart(2,'0')}00`;
    const dates = `${fmt(start)}/${fmt(end)}`;
    const text = encodeURIComponent(EVENT_TITLE);
    const details = encodeURIComponent(`×§×™×©×•×¨ ×™×©×™×¨ ×œ×”×’×¢×” ×œ×¤×Ÿ ××§×¡×¤×¨×¡:\n${MAP_URL}\n(×ª×–×›×•×¨×ª 60 ×“×§×³ ×œ×¤× ×™)`);
    const loc = encodeURIComponent(MAP_URL);
    const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${dates}&details=${details}&location=${loc}`;
    window.location.href = url;
    return;
  }

  if(isIOS){
    const startLocal=toICSLocal(dateStr,timeStr);
    const endLocal=`${end.getFullYear()}${pad2(end.getMonth()+1)}${pad2(end.getDate())}T${pad2(end.getHours())}${pad2(end.getMinutes())}00`;
    const ics = buildICS({title:EVENT_TITLE,location:MAP_URL,startLocal,endLocal,tzid:TIMEZONE});
    const blob=new Blob([ics],{type:'text/calendar;charset=utf-8'});
    const url=URL.createObjectURL(blob);
    window.location.href = url;
    setTimeout(()=>URL.revokeObjectURL(url), 4000);
    return;
  }

  const fmt = (dt)=>`${dt.getFullYear()}${pad2(dt.getMonth()+1)}${pad2(dt.getDate())}T${dt.getHours().toString().padStart(2,'0')}${dt.getMinutes().toString().padStart(2,'0')}00`;
  const dates = `${fmt(start)}/${fmt(end)}`;
  const text = encodeURIComponent(EVENT_TITLE);
  const details = encodeURIComponent(`×§×™×©×•×¨ ×™×©×™×¨ ×œ×”×’×¢×” ×œ×¤×Ÿ ××§×¡×¤×¨×¡:\n${MAP_URL}\n(×ª×–×›×•×¨×ª 60 ×“×§×³ ×œ×¤× ×™)`);
  const loc = encodeURIComponent(MAP_URL);
  const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${dates}&details=${details}&location=${loc}`;
  window.location.href = url;
}

/* ===== UI helpers ===== */
const elChat = document.getElementById('chat');
const elQuick = document.getElementById('quick');
const elInput = document.getElementById('input');
const elSend = document.getElementById('send');
const msgErr = document.getElementById('msgError');
const msgOk = document.getElementById('msgOk');

const icsModal = document.getElementById('icsModal');
const btnOk = document.getElementById('btnOk');
const btnCancel = document.getElementById('btnCancel');
const icsText = document.getElementById('icsText');

function showErr(t){ msgErr.textContent=t; msgErr.style.display='block'; setTimeout(()=>msgErr.style.display='none',4500); }
function showOk(t){ msgOk.textContent=t; msgOk.style.display='block'; setTimeout(()=>msgOk.style.display='none',4500); }

function scrollDown(){ elChat.scrollTop = elChat.scrollHeight; }

function addBubble(text, who){
  const row = document.createElement('div');
  row.className = 'row ' + (who==='me'?'me':'bot');
  const b = document.createElement('div');
  b.className = 'bubble';
  b.textContent = text;
  row.appendChild(b);
  elChat.appendChild(row);
  scrollDown();
}

function setQuickChips(items){
  // items: [{label, value, disabled}]
  elQuick.innerHTML = '';
  if(!items || !items.length) return;
  items.forEach(it=>{
    const btn = document.createElement('button');
    btn.className = 'chip';
    btn.type = 'button';
    btn.textContent = it.label;
    if(it.disabled) btn.disabled = true;
    btn.addEventListener('click', ()=> {
      if(btn.disabled) return;
      handleUserText(it.value, true);
    });
    elQuick.appendChild(btn);
  });
}

function setComposerEnabled(enabled){
  elInput.disabled = !enabled;
  elSend.disabled = !enabled;
}

/* ===== Conversation state ===== */
const State = {
  ASK_NAME: 'ASK_NAME',
  ASK_DATE: 'ASK_DATE',
  ASK_TIME: 'ASK_TIME',
  ASK_PHONE: 'ASK_PHONE',
  CONFIRM_SAVED: 'CONFIRM_SAVED'
};

let state = State.ASK_NAME;

const model = {
  name: '',
  phone: '',
  date: '',
  time: '',
  bookings: [],
  rec: null
};

function allowedDates(){
  return [todayStr(), addDaysStr(1), addDaysStr(2), addDaysStr(3)];
}

function dateLabel(d){
  const t=todayStr();
  const m=addDaysStr(1);
  if(d===t) return '×”×™×•×';
  if(d===m) return '××—×¨';
  return fmtDateHeb(d);
}

async function loadBookings(){
  try{
    const rec = await fetchRecord();
    model.rec = rec;
    model.bookings = Array.isArray(rec.bookings) ? rec.bookings : [];
    return true;
  }catch(e){
    showErr('×©×’×™××ª ×¨×©×ª ×‘×˜×¢×™× ×ª ×ª×•×¨×™×');
    return false;
  }
}

function takenSetForDate(dateStr){
  return new Set(model.bookings.filter(b=>b.date===dateStr).map(b=>b.time));
}

function freeSlotsForDate(dateStr){
  const taken = takenSetForDate(dateStr);
  return SLOTS.filter(t=>!taken.has(t));
}

function nearestAlternatives(dateStr, desiredTime){
  const free = freeSlotsForDate(dateStr);
  if(!free.length) return [];
  const toMin = (t)=> {
    const [h,m]=t.split(':').map(Number);
    return h*60+m;
  };
  const target = toMin(desiredTime);

  let before=null, after=null;
  for(const t of free){
    const m = toMin(t);
    if(m <= target){
      if(before===null || (target-m) < (target-toMin(before))) before=t;
    }
    if(m >= target){
      if(after===null || (m-target) < (toMin(after)-target)) after=t;
    }
  }

  // ×× ×–×” ×‘×“×™×•×§ ×¤× ×•×™ â€” × ×—×–×™×¨ ××•×ª×• ×¨××©×•×Ÿ
  const out = [];
  if(free.includes(desiredTime)) out.push(desiredTime);
  if(before && !out.includes(before)) out.push(before);
  if(after && !out.includes(after)) out.push(after);

  // ×× ×¢×“×™×™×Ÿ ×—×¡×¨, × ×•×¡×™×£ ×”×›×™ ×§×¨×•×‘×™× × ×•×¡×¤×™×
  out.sort((a,b)=>Math.abs(toMin(a)-target)-Math.abs(toMin(b)-target));
  return out.slice(0,3);
}

function askName(){
  state = State.ASK_NAME;
  setQuickChips([]);
  addBubble('×”×™×™ ××” ×§×•×¨×”? ×ª×–×›×™×¨ ×œ×™ ××™×š ×§×•×¨××™× ×œ×š', 'bot');
  elInput.placeholder = '×œ×“×•×’××”: ×©×•×©× ×”';
}

function askDate(){
  state = State.ASK_DATE;
  addBubble(`×”×™×™ ${model.name} ×©××—×ª×™ ×©×‘×—×¨×ª ×‘×¤×Ÿ ××§×¡×¤×¨×¡ âœ¨\n×œ××™×–×” ×ª××¨×™×š ×ª×¨×¦×™ ×œ×§×‘×•×¢ ×ª×•×¨?`, 'bot');

  const dates = allowedDates();
  setQuickChips(dates.map(d=>({label: dateLabel(d), value: d})).concat([
    {label:'×ª××¨×™×š ××—×¨', value:'OTHER_DATE'}
  ]));
  elInput.placeholder = '××¤×©×¨ ×’× ×œ×”×§×œ×™×“ ×ª××¨×™×š (YYYY-MM-DD)';
}

function askTime(){
  state = State.ASK_TIME;

  if(!BOOKING_OPEN){
    addBubble('×›×¨×’×¢ ×§×‘×™×¢×ª ×ª×•×¨×™× ×¡×’×•×¨×”. ××¤×©×¨ ×œ× ×¡×•×ª ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨ ğŸ™', 'bot');
    setQuickChips([]);
    setComposerEnabled(false);
    return;
  }

  addBubble(`×¡×‘×‘×”.\n×‘××™×–×• ×©×¢×” × ×•×— ×œ×š ×‘×ª××¨×™×š ${fmtDateHeb(model.date)}?`, 'bot');

  const free = freeSlotsForDate(model.date);
  if(!free.length){
    addBubble('××™×Ÿ ×©×¢×•×ª ×¤× ×•×™×•×ª ×‘×ª××¨×™×š ×”×–×” ğŸ˜• ×‘×—×¨×™ ×ª××¨×™×š ××—×¨.', 'bot');
    askDate();
    return;
  }

  // ××¦×™×’ ×›×¤×ª×•×¨×™× ×©×œ ×©×¢×•×ª ×¤× ×•×™×•×ª (12 ×”×¨××©×•× ×•×ª ×›×“×™ ×œ× ×œ×”×¦×™×£)
  const chips = free.slice(0,12).map(t=>({label:t, value:t}));
  chips.push({label:'×¢×•×“ ×©×¢×•×ªâ€¦', value:'MORE_TIMES'});
  setQuickChips(chips);

  elInput.placeholder = '××¤×©×¨ ×’× ×œ×›×ª×•×‘ ×©×¢×” ×›××• 16:20';
}

function askPhone(){
  state = State.ASK_PHONE;
  setQuickChips([]);
  addBubble('××¢×•×œ×”.\n××” ××¡×¤×¨ ×”×˜×œ×¤×•×Ÿ ×©×œ×š?', 'bot');
  elInput.placeholder = '×œ×“×•×’××”: 0521234567';
}

async function trySave(){
  // ×©××™×¨×” ×‘×“×™×•×§ ×›××• ××¦×œ×š: date,time,name,phone,ts
  const payload = {
    date: model.date,
    time: model.time,
    name: model.name.trim(),
    phone: model.phone.trim()
  };

  if(!payload.date || !payload.time || !payload.name || !payload.phone){
    showErr('×—×¡×¨ ×¤×¨×˜×™× ×œ×©××™×¨×”');
    return;
  }
  if(!validPhone(payload.phone)){
    addBubble('×”××¡×¤×¨ ×œ× × ×¨××” ×ª×§×™×Ÿ. ××¤×©×¨ ×œ×›×ª×•×‘ ×©×•×‘ ××ª ×”×˜×œ×¤×•×Ÿ?', 'bot');
    state = State.ASK_PHONE;
    return;
  }

  setComposerEnabled(false);
  try{
    let rec = await fetchRecord();

    const normPhone = normalizePhone(payload.phone);
    const existsSameDayPhone = rec.bookings.some(b=>b.date===payload.date && normalizePhone(b.phone)===normPhone);
    if(existsSameDayPhone){
      addBubble('×§×™×™× ×›×‘×¨ ×ª×•×¨ ×¢×œ ×©××š ×œ××•×ª×• ×™×•×.\n×‘×•××™ × ×‘×—×¨ ×ª××¨×™×š ××—×¨ ğŸ™', 'bot');
      model.date = '';
      model.time = '';
      await loadBookings();
      askDate();
      return;
    }

    if(rec.bookings.some(b=>b.date===payload.date && b.time===payload.time)){
      // × ×ª×¤×¡ ×‘×¨×’×¢ ×”××—×¨×•×Ÿ
      addBubble(`×”×©×¢×” ${payload.time} × ×ª×¤×¡×” ×”×¨×’×¢ ğŸ˜•`, 'bot');
      await loadBookings();
      const alts = nearestAlternatives(payload.date, payload.time);
      if(alts.length){
        addBubble('×¨×•×¦×” ×œ×‘×—×•×¨ ××—×ª ××”××¤×©×¨×•×™×•×ª ×”×§×¨×•×‘×•×ª?', 'bot');
        setQuickChips(alts.map(t=>({label:t, value:t})).concat([{label:'×œ×‘×—×•×¨ ×©×¢×” ××—×¨×ª', value:'PICK_OTHER_TIME'}]));
        state = State.ASK_TIME;
      }else{
        addBubble('×‘×•××™ × ×‘×—×¨ ×©×¢×” ××—×¨×ª.', 'bot');
        askTime();
      }
      return;
    }

    rec.bookings.push({date: payload.date, time: payload.time, name: payload.name, phone: payload.phone, ts: Date.now()});
    await putRecord(rec);

    showOk('×”×ª×•×¨ × ×©××¨ ×‘×”×¦×œ×—×”!');
    addBubble(`×§×‘×¢× ×• âœ…\n×ª××¨×™×š: ${fmtDateHeb(payload.date)}\n×©×¢×”: ${payload.time}`, 'bot');

    icsText.textContent =
`× ×™×¦×•×¨ ××™×¨×•×¢ ×œ×™×•××Ÿ ×‘×ª××¨×™×š ${fmtDateHeb(payload.date)} ×‘×©×¢×” ${payload.time} ×›×•×œ×œ ×ª×–×›×•×¨×ª ×©×¢×” ×œ×¤× ×™.
×œ×§×•×—×” ×™×§×¨×”, ××–×›×™×¨×” ×œ×š ×œ×”×’×™×¢ ×—×¤×•×¤×” ×•×‘×–××Ÿ ğŸ’‡â€â™€ï¸
×ª×•×“×” - ×¤×Ÿ ××§×¡×¤×¨×¡`;

    // ××•×“××œ ×›××• ××¦×œ×š
    lastSavedPayload = payload;
    icsModal.style.display='flex';

    // ×˜×•×¢×Ÿ ××—×“×© ×œ×ª×™××•× ×–××™× ×•×ª
    await loadBookings();

    state = State.CONFIRM_SAVED;

  }catch(e){
    showErr('×©×’×™××ª ×¨×©×ª ×‘×©××™×¨×”');
    addBubble('×”×™×™×ª×” ×©×’×™××ª ×¨×©×ª. ××¤×©×¨ ×œ× ×¡×•×ª ×©×•×‘ ×¢×•×“ ×¨×’×¢ ğŸ™', 'bot');
  }finally{
    setComposerEnabled(true);
  }
}

/* ===== Main input handler ===== */
function normalizeDateInput(s){
  const t=(s||'').trim();
  // ××§×‘×œ YYYY-MM-DD
  if(/^\d{4}-\d{2}-\d{2}$/.test(t)) return t;
  // ××§×‘×œ DD.MM.YYYY
  const m=t.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
  if(m){
    const dd=pad2(+m[1]), mm=pad2(+m[2]), yy=m[3];
    return `${yy}-${mm}-${dd}`;
  }
  return null;
}

async function handleUserText(text, fromChip=false){
  const raw = (text ?? '').toString().trim();
  if(!raw) return;

  // UI: ×œ×”×¦×™×’ ×”×•×“×¢×ª ××©×ª××©
  if(!fromChip) addBubble(raw, 'me');

  if(state === State.ASK_NAME){
    model.name = raw.replace(/\s+/g,' ').trim();
    if(model.name.length < 2){
      addBubble('×¨×§ ×œ×•×•×“×â€¦ ××¤×©×¨ ×©× ××œ×/×©× ×¤×¨×˜×™ ×‘×¨×•×¨?', 'bot');
      return;
    }
    await loadBookings();
    askDate();
    return;
  }

  if(state === State.ASK_DATE){
    if(raw === 'OTHER_DATE'){
      // ×¤×•×ª×— input date "××•×‘× ×”" ×“×¨×š prompt ×§×˜×Ÿ
      setQuickChips([]);
      addBubble('×ª×¨×©××™ ×œ×™ ×ª××¨×™×š ×‘×¤×•×¨××˜ YYYY-MM-DD ××• DD.MM.YYYY\n(××¤×©×¨ ×¢×“ 3 ×™××™× ×§×“×™××”)', 'bot');
      return;
    }

    const d = normalizeDateInput(raw) || raw; // chips ××—×–×™×¨×™× YYYY-MM-DD
    const allowed = new Set(allowedDates());
    if(!allowed.has(d)){
      addBubble('××¤×©×¨ ×œ×§×‘×•×¢ ×¨×§ ××”×™×•× ×•×¢×“ 3 ×™××™× ×§×“×™××”.\n×‘×•××™ × ×‘×—×¨ ××—×“ ××”×›×¤×ª×•×¨×™× ğŸ‘‡', 'bot');
      const dates = allowedDates();
      setQuickChips(dates.map(x=>({label: dateLabel(x), value: x})).concat([{label:'×ª××¨×™×š ××—×¨', value:'OTHER_DATE'}]));
      return;
    }
    model.date = d;
    setQuickChips([]);
    askTime();
    return;
  }

  if(state === State.ASK_TIME){
    if(raw === 'MORE_TIMES'){
      const free = freeSlotsForDate(model.date);
      setQuickChips(free.map(t=>({label:t, value:t})));
      addBubble('×‘×—×¨×™ ×©×¢×” ××”×¨×©×™××” ğŸ‘‡', 'bot');
      return;
    }
    if(raw === 'PICK_OTHER_TIME'){
      askTime();
      return;
    }

    const t = parseTimeLike(raw) || raw;
    if(!/^\d{2}:\d{2}$/.test(t)){
      addBubble('×ª×›×ª×‘×™ ×©×¢×” ×‘×¤×•×¨××˜ 16:20 ××• ×ª×œ×—×¦×™ ×¢×œ ×›×¤×ª×•×¨ ×©×œ ×©×¢×” ×¤× ×•×™×” ğŸ‘‡', 'bot');
      return;
    }

    const taken = takenSetForDate(model.date);
    if(taken.has(t)){
      // ×ª×¤×•×¡: ×”×¦×¢×•×ª ×—×›××•×ª
      const alts = nearestAlternatives(model.date, t);
      addBubble(`×”×©×¢×” ${t} ×ª×¤×•×¡×” ğŸ˜•\n×¨×•×¦×” ××—×ª ××”××¤×©×¨×•×™×•×ª ×”×§×¨×•×‘×•×ª?`, 'bot');
      if(alts.length){
        setQuickChips(alts.map(x=>({label:x, value:x})).concat([{label:'×œ×‘×—×•×¨ ×©×¢×” ××—×¨×ª', value:'MORE_TIMES'}]));
      }else{
        setQuickChips([{label:'×œ×”×¦×™×’ ×©×¢×•×ª ×¤× ×•×™×•×ª', value:'MORE_TIMES'}]);
      }
      return;
    }

    // ×¤× ×•×™
    model.time = t;
    setQuickChips([]);
    addBubble(`××¢×•×œ×”.\n×¨×©××ª×™ ${t} âœ…`, 'bot');
    askPhone();
    return;
  }

  if(state === State.ASK_PHONE){
    model.phone = raw;
    if(!validPhone(model.phone)){
      addBubble('×”×˜×œ×¤×•×Ÿ ×§×¦×¨ ××“×™/×œ× ×ª×§×™×Ÿ. ×ª×¨×©××™ ×©×•×‘ ×‘×‘×§×©×”.', 'bot');
      return;
    }
    // ×œ×¤× ×™ ×©××™×¨×”: ×¡×™×›×•× ×§×¦×¨
    addBubble(`×¨×§ ×¡×™×›×•× ×§×¦×¨:\n×©×: ${model.name}\n×ª××¨×™×š: ${fmtDateHeb(model.date)}\n×©×¢×”: ${model.time}\n×˜×œ×¤×•×Ÿ: ${model.phone}\n×©×•××¨×ªâ€¦`, 'bot');
    await trySave();
    return;
  }
}

/* ===== Send bindings ===== */
elSend.addEventListener('click', ()=>{
  const t = elInput.value;
  elInput.value = '';
  handleUserText(t, false);
});

elInput.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){
    e.preventDefault();
    elSend.click();
  }
});

/* ===== Waze / Gallery ===== */
document.getElementById('galleryBtn').addEventListener('click', ()=> window.location.href = GALLERY_URL);

document.getElementById('navWaze').addEventListener('click', ()=>{
  const start = Date.now();
  window.location.href = WAZE_DEEP;
  setTimeout(()=>{
    if (Date.now() - start < 1200) window.location.href = WAZE_WEB;
  }, 900);
});

/* ===== Modal actions ===== */
let lastSavedPayload = null;

btnCancel.addEventListener('click', ()=>{ icsModal.style.display='none'; });

btnOk.addEventListener('click', ()=>{
  icsModal.style.display='none';
  if(!lastSavedPayload) return;
  openCalendarDirect(lastSavedPayload.date, lastSavedPayload.time);
});

/* ===== Init ===== */
(async ()=>{
  await loadBookings();
  askName();
})();

/* PWA: ×¨×™×©×•× Service Worker (×›××• ××¦×œ×š) */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(()=>{});
}
</script>
</body>
</html>
