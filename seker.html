<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>טופס סקר</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#000;margin:0;padding:0;color:#d4af37}
  .wrap{max-width:600px;margin:18px auto;padding:22px;background:#111;border-radius:12px;box-shadow:0 6px 28px rgba(255,215,0,0.08)}
  h1{margin:0 0 12px;font-size:22px;color:#ffd700;text-align:center}
  label{display:block;margin:10px 4px 6px;font-weight:700;color:#ffd700;font-size:15px}
  input,select,button{width:100%;padding:10px 12px;border:1px solid #d4af37;border-radius:10px;font-size:15px;box-sizing:border-box;background:#222;color:#ffd700}
  input[type="tel"]{text-align:right}
  select{appearance:none;-webkit-appearance:none}
  .btn{background:#d4af37;color:#000;border:0;cursor:pointer;margin-top:14px;font-weight:800;font-size:15px;padding:11px;border-radius:10px}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .msg{margin-top:12px;padding:10px;border-radius:10px;display:none}
  .msg.ok{background:#052e17;color:#9ff0b3;border:1px solid #1f7a44}
  .msg.err{background:#3a0a0a;color:#ffc7c7;border:1px solid #7a1b1b}
  .ver{margin-top:14px;text-align:center;color:#bfa76f;font-size:13px}
  footer{margin-top:10px;text-align:center;color:#a88e32;font-size:12px}
</style>
</head>
<body>
  <div class="wrap" role="main" aria-labelledby="title">
    <h1 id="title">טופס סקר</h1>

    <div id="msgOk" class="msg ok" role="status" aria-live="polite"></div>
    <div id="msgErr" class="msg err" role="alert" aria-live="assertive"></div>

    <label for="dept">מחלקה</label>
    <select id="dept" required>
      <option value="">בחר מחלקה…</option>
      <option>אווירודינמיקה</option>
      <option>מחמ</option>
      <option>מטה</option>
      <option>ניווט</option>
      <option>בקמ</option>
      <option>טילאות</option>
      <option>סימולציות</option>
    </select>

    <label for="workerName">שם העובד</label>
    <input id="workerName" type="text" placeholder="שם מלא" autocomplete="name" required />

    <label for="phone">מספר נייד</label>
    <input id="phone" type="tel" inputmode="tel" placeholder="05X-XXXXXXX" autocomplete="tel" required />

    <label for="building">מבנה</label>
    <input id="building" type="text" placeholder="מבנה" required />

    <label for="floor">קומה</label>
    <input id="floor" type="text" placeholder="קומה" required />

    <label for="room">מספר חדר</label>
    <input id="room" type="text" placeholder="מספר / אות חדר" required />

    <label for="packs">כמות אריזות</label>
    <select id="packs" required>
      <option value="">בחר כמות…</option>
      <option>1</option>
      <option>2</option>
      <option>3</option>
      <option>4</option>
      <option>5</option>
    </select>

    <label for="targetRoom">חדר יעד</label>
    <input id="targetRoom" type="text" placeholder="חדר יעד" required />

    <button id="sendBtn" class="btn" type="button">שלח</button>

    <div class="ver">גרסה נקייה — שמירה ישירה ל-JSONBin</div>
    <footer>המידע ישמר בענן ב-BIN ייעודי. אין שינוי בבין/מפתחות של מערכות קיימות.</footer>
  </div>

<script>
/* ============================
   קובץ מוכן להפעלה
   BIN & ACCESS KEY מוטמעים כאן כפי שביקשת
   ============================ */

/* שימוש ב-Access Key ייעודי (הרשאת CREATE בלבד) וב-BIN ייעודי לסקר */
const BIN_ID = '68fe72b9d0ea881f40bdb95e';
const ACCESS_KEY = '$2a$10$3i/rJHyUA3s9SphXik.7huVmcOEGCHl6kPOy8VvEPGoTxl2R5larK';
const BIN_URL = 'https://api.jsonbin.io/v3/b/' + BIN_ID;

/* אלמנטים */
const elDept = document.getElementById('dept');
const elWorkerName = document.getElementById('workerName');
const elPhone = document.getElementById('phone');
const elBuilding = document.getElementById('building');
const elFloor = document.getElementById('floor');
const elRoom = document.getElementById('room');
const elPacks = document.getElementById('packs');
const elTargetRoom = document.getElementById('targetRoom');
const btnSend = document.getElementById('sendBtn');
const msgOk = document.getElementById('msgOk');
const msgErr = document.getElementById('msgErr');

/* UI helpers */
function showOk(text){ msgOk.textContent = text; msgOk.style.display = 'block'; setTimeout(()=> msgOk.style.display='none',4000); }
function showErr(text){ msgErr.textContent = text; msgErr.style.display = 'block'; setTimeout(()=> msgErr.style.display='none',6000); }
function setSending(state){ btnSend.disabled = state; }

/* בסיס ולידציה */
function normalizePhone(p){ return (p||'').replace(/\D/g,''); }
function validPhone(p){ return normalizePhone(p).length >= 8; }

/* קבלת רשומה נוכחית מה-BIN.
   משתמשים בכותרת X-Master-Key גם ל-Access Key (JSONBin תקבל את המפתח המוגבל).
*/
async function fetchRecord(){
  const r = await fetch(BIN_URL + '?ts=' + Date.now(), {
    headers: { 'X-Master-Key': ACCESS_KEY },
    cache: 'no-store'
  });
  if(!r.ok){
    const txt = await r.text().catch(()=> '');
    throw new Error('fetch failed ' + r.status + ' ' + txt);
  }
  const j = await r.json();
  return (j.record && Array.isArray(j.record.answers)) ? j.record : { answers: [] };
}

/* שמירה ל-BIN (PUT) */
async function putRecord(rec){
  const r = await fetch(BIN_URL + '?ts=' + Date.now(), {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
      'X-Master-Key': ACCESS_KEY
    },
    body: JSON.stringify(rec),
    cache: 'no-store'
  });
  if(!r.ok){
    const txt = await r.text().catch(()=> '');
    throw new Error('put failed ' + r.status + ' ' + txt);
  }
  return r.json().catch(()=> ({}));
}

/* שליחה בעת לחיצה על הכפתור */
btnSend.addEventListener('click', async ()=>{
  const answer = {
    dept: elDept.value.trim(),
    workerName: elWorkerName.value.trim(),
    phone: elPhone.value.trim(),
    building: elBuilding.value.trim(),
    floor: elFloor.value.trim(),
    room: elRoom.value.trim(),
    packs: elPacks.value.trim(),
    targetRoom: elTargetRoom.value.trim(),
    ts: Date.now()
  };

  if(!answer.dept || !answer.workerName || !answer.phone || !answer.building
     || !answer.floor || !answer.room || !answer.packs || !answer.targetRoom){
    showErr('נא למלא את כל השדות');
    return;
  }
  if(!validPhone(answer.phone)){
    showErr('מספר נייד לא תקין');
    return;
  }

  setSending(true);
  try{
    const rec = await fetchRecord();
    rec.answers = Array.isArray(rec.answers) ? rec.answers : [];
    rec.answers.push(answer);
    await putRecord(rec);
    showOk('הנתונים נשמרו בענן בהצלחה.');
    // איפוס טופס
    elDept.value = '';
    elWorkerName.value = '';
    elPhone.value = '';
    elBuilding.value = '';
    elFloor.value = '';
    elRoom.value = '';
    elPacks.value = '';
    elTargetRoom.value = '';
  }catch(err){
    console.error(err);
    if(err.message && (err.message.indexOf('401')>=0 || err.message.indexOf('403')>=0)){
      showErr('שגיאת הרשאה — המפתח או ה-BIN לא תקינים.');
    } else {
      showErr('שגיאת רשת או שרת. נסה שוב מאוחר יותר.');
    }
  }finally{
    setSending(false);
  }
});
</script>
</body>
</html>
