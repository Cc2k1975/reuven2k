<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>צ'אט אישי</title>

<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

<style>
    /* --- שינוי #1: התאמה אגרסיבית למסך מלא (מניעת גלילה אופקית) --- */
    html, body {
        margin: 0;
        padding: 0;
        overflow-x: hidden !important; /* דורס כל גלילה אופקית */
        font-family: Heebo, Arial;
        background: #f2f2f2;
        display: flex;
        flex-direction: column;
        height: 100vh;
        width: 100%; /* מוודא שהגוף לא רחב מדי */
    }

    /* --- מסך סיסמה --- (ללא שינוי) */
    #passwordScreen {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: #f2f2f2;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 200;
    }
    #passwordBox {
        background: #ffffff;
        padding: 24px;
        border-radius: 18px;
        width: 80%;
        max-width: 360px;
        text-align: center;
        box-shadow: 0 10px 25px rgba(0,0,0,0.25);
    }
    #passwordBox h2 {
        margin-top: 0;
        margin-bottom: 12px;
        font-size: 20px;
    }
    #passInput {
        width: 100%;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid #aaa;
        font-size: 16px;
        text-align: center;
    }
    #passBtn {
        margin-top: 14px;
        width: 100%;
        padding: 10px;
        border: none;
        border-radius: 10px;
        background: #009688;
        color: #fff;
        font-size: 16px;
        cursor: pointer;
    }
    #passError {
        margin-top: 8px;
        color: #e53935;
        font-size: 14px;
        min-height: 18px;
    }

    /* --- מסך בחירת תפקיד --- (ללא שינוי) */
    #roleSelect {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 150;
    }
    #roleBox {
        background: white;
        padding: 25px;
        border-radius: 20px;
        text-align: center;
        width: 80%;
        max-width: 400px;
    }
    .role-row {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        margin-top: 15px;
    }
    .role-btn {
        flex: 1;
        background: white;
        border: 2px solid #ccc;
        border-radius: 15px;
        padding: 12px 5px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }
    .circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
    }
    .circle.male { background:#4fc3f7; }
    .circle.female { background:#ff80ab; }

    /* --- שורת נוכחות למעלה --- (ללא שינוי) */
    #presenceBar {
        display:flex;
        justify-content:center;
        gap:16px;
        padding:6px 10px;
        font-size:12px;
        color:#555;
        background:#e0e0e0;
        border-bottom:1px solid #ccc;
    }
    .presence-side {
        display:flex;
        align-items:center;
        gap:6px;
    }
    .presence-dot {
        width:10px;
        height:10px;
        border-radius:50%;
        background:#9e9e9e; /* אפור ברירת מחדל */
    }
    .presence-dot.online {
        background:#4caf50; /* ירוק כשמחובר */
    }
    .presence-text {
        display:flex;
        flex-direction:column;
        line-height:1.2;
    }
    .presence-label {
        font-weight:600;
        font-size:12px;
    }
    .presence-time {
        font-size:11px;
        color:#333;
    }

    /* --- צ'אט --- (ללא שינוי) */
    #chatBox {
        flex: 1;
        overflow-y: auto;
        padding: 12px;
    }
    .msg {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
        max-width: 80%;
    }
    .icon {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        flex-shrink: 0;
    }
    .icon.male {
        background:#4fc3f7;
        margin-left: 6px;
        margin-right: -6px;
    }
    .icon.female {
        background:#ff80ab;
        margin-right: 6px;
        margin-left: -6px;
    }
    .bubble {
        padding: 9px 12px;
        background: white;
        border-radius: 12px;
        font-size: 15px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.12);
        word-wrap: break-word;
    }
    .me {
        margin-left: auto;
        flex-direction: row-reverse;
    }
    .me .bubble { background:#d1f5e0; }
    .friend {
        margin-right: auto;
    }
    .friend .bubble { background:#ffe0f0; }

    /* גודל תמונה 5x5 ס"מ */
    .chat-image {
        width: 5cm; 
        height: 5cm; 
        object-fit: cover; 
        border-radius: 8px;
        display: block;
    }

    /* שעה קטנה בבועה */
    .msg-text {
        white-space: pre-wrap;
    }
    .msg-time {
        margin-top:4px;
        font-size:11px;
        color:#777;
        text-align:right;
    }
    .me .msg-time {
        text-align:left;
    }

    /* חיווי מקליד/ה */
    #typingIndicator {
        min-height: 20px;
        padding: 0 12px 4px;
        font-size: 13px;
        color: #777;
        font-style: italic;
        visibility: hidden;
    }

    /* --- סרגל קלט מותאם למובייל (דחיסה מחודשת) --- */
    #inputArea {
        display: flex;
        align-items: center; 
        padding: 6px; /* ריפוד מינימלי */
        background: white;
        border-top: 1px solid #ccc;
        gap: 3px; /* ריווח מינימלי בין אלמנטים */
    }
    #msgInput {
        flex: 1;
        padding: 6px; /* ריפוד מינימלי */
        border: 1px solid #aaa;
        border-radius: 6px; /* עיגול קטן יותר */
        font-size: 13px; /* פונט קטן יותר */
        min-width: 30%; /* ודא שיש מקום מינימלי לקלט */
    }
    #sendBtn, #liveBtn {
        padding: 6px 8px; /* דחיסה מקסימלית של כפתורים */
        background: #009688;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 12px; /* פונט קטן מאוד */
        cursor: pointer;
        white-space: nowrap;
    }
    #liveBtn {
        background: #e91e63;
    }
    #attachmentContainer {
        display: flex;
        align-items: center;
        flex-shrink: 0; /* מונע התכווצות יתר */
    }
    #attachBtn {
        padding: 6px 8px;
        background: #e0e0e0;
        color: #333;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1; 
    }
    #clearBtn {
        width: 100%;
        padding: 12px;
        background: #d9534f;
        color: white;
        border: none;
        font-size: 16px;
        cursor: pointer;
    }
    
    /* --- LIVE וידאו --- */
    #liveOverlay {
        position: fixed;
        top:0; left:0;
        width:100%; height:100%;
        background:#000;
        color:#fff;
        display:none;
        flex-direction:column;
        z-index:180;
    }
    #liveVideos {
        flex:1;
        display:flex;
        flex-direction:column;
    }
    #remoteContainer, #localContainer {
        height:50%;
        display:flex;
        align-items:center;
        justify-content:center;
        border-bottom:1px solid #333;
    }
    #localContainer {
        border-bottom:none;
        border-top:1px solid #333;
    }
    video {
        width:100%;
        height:100%;
        object-fit:cover;
        background:#000;
    }
    #liveControls {
        padding:8px;
        text-align:center;
    }
    #endLiveBtn {
        padding:10px 18px;
        background:#f44336;
        border:none;
        border-radius:8px;
        color:#fff;
        font-size:16px;
        cursor:pointer;
    }

    /* פופאפ שיחת LIVE נכנסת */
    #incomingCall {
        position: fixed;
        top:0; left:0;
        width:100%; height:100%;
        background:rgba(0,0,0,0.6);
        display:none;
        align-items:center;
        justify-content:center;
        z-index:185;
    }
    #incomingBox {
        background:white;
        padding:20px;
        border-radius:14px;
        width:80%;
        max-width:320px;
        text-align:center;
    }
    #incomingBox h3 {
        margin-top:0;
        margin-bottom:10px;
    }
    .incoming-btn {
        padding:8px 14px;
        margin:0 6px;
        border:none;
        border-radius:8px;
        cursor:pointer;
        font-size:14px;
    }
    #acceptBtn { background:#4caf50; color:#fff; }
    #rejectBtn { background:#f44336; color:#fff; }
</style>
</head>

<body>

<div id="passwordScreen">
    <div id="passwordBox">
        <h2>הכנס סיסמה לצ'אט</h2>
        <input type="password" id="passInput" placeholder="סיסמה" autocomplete="off" autocapitalize="off">
        <button id="passBtn" onclick="checkPassword()">כניסה</button>
        <div id="passError"></div>
    </div>
</div>

<div id="roleSelect">
    <div id="roleBox">
        <h2>בחר צד בצ'אט</h2>
        <div class="role-row">
            <div class="role-btn" onclick="chooseRole('male')">
                <div class="circle male"></div>
                <div>C</div>
            </div>
            <div class="role-btn" onclick="chooseRole('female')">
                <div class="circle female"></div>
                <div>K</div>
            </div>
        </div>
    </div>
</div>

<div id="chatBox"></div>

<div id="typingIndicator"></div>

<div id="inputArea">
    <button onclick="onLiveClick()" id="liveBtn">LIVE</button>

    <div id="attachmentContainer">
        <input type="file" id="imageInput" accept="image/jpeg, image/png" style="display: none;">
        <button id="attachBtn" onclick="document.getElementById('imageInput').click()">
            &#128206; </button>
    </div>
    
    <input type="text" id="msgInput" placeholder="הקלד הודעה...">
    <button onclick="sendMsg()" id="sendBtn">שלח</button>
</div>

<div id="presenceBar">
    <div class="presence-side">
        <span class="presence-dot" id="presenceMale"></span>
        <div class="presence-text">
            <div class="presence-label">C</div>
            <div class="presence-time" id="presenceMaleTime">--:--</div>
        </div>
    </div>
    <div class="presence-side">
        <span class="presence-dot" id="presenceFemale"></span>
        <div class="presence-text">
            <div class="presence-label">K</div>
            <div class="presence-time" id="presenceFemaleTime">--:--</div>
        </div>
    </div>
</div>

<button id="clearBtn" onclick="clearChat()">מחק צ'אט</button>

<div id="liveOverlay">
    <div id="liveVideos">
        <div id="remoteContainer">
            <video id="remoteVideo" autoplay playsinline></video>
        </div>
        <div id="localContainer">
            <video id="localVideo" autoplay playsinline muted></video>
        </div>
    </div>
    <div id="liveControls">
        <button id="endLiveBtn" onclick="endCall()">סיים LIVE</button>
    </div>
</div>

<div id="incomingCall">
    <div id="incomingBox">
        <h3>שיחת וידאו נכנסת</h3>
        <p>לאשר LIVE?</p>
        <button class="incoming-btn" id="acceptBtn" onclick="acceptCall()">אישור</button>
        <button class="incoming-btn" id="rejectBtn" onclick="rejectCall()">דחייה</button>
    </div>
</div>

<script>
/* --- Firebase config שלך --- */
const firebaseConfig = {
  apiKey: "AIzaSyBPD1nZQVAdqSP4uS05TYXBeGtJKsjapA",
  authDomain: "private-chat-b3a36.firebaseapp.com",
  databaseURL: "https://private-chat-b3a36-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "private-chat-b3a36",
  storageBucket: "private-chat-b3a36.firebasestorage.app",
  messagingSenderId: "88424262632",
  appId: "1:88424262632:web:a38edf362b59703011525d",
  measurementId: "G-M9SGLXN3TV"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* מצב צ'אט */
let myRole = localStorage.getItem("role") || null;
let authed = false; 
let typingListenerStarted = false;
let typingTimeout = null;
let longPressTimeout = null; // לשימוש בלחיצה ארוכה למחיקה


/* נוכחות (presence) */
let presenceRef = null;
const presenceMaleDot = document.getElementById("presenceMale");
const presenceFemaleDot = document.getElementById("presenceFemale");
const presenceMaleTime = document.getElementById("presenceMaleTime");
const presenceFemaleTime = document.getElementById("presenceFemaleTime");

/* WebRTC LIVE */
let pc = null;
let localStream = null;
let inCall = false;
let isCaller = false;
const servers = {
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
};

/* אחרי עליית הדף */
window.addEventListener("load", () => {
    document.getElementById("passwordScreen").style.display = "flex";
    document.getElementById("roleSelect").style.display = "none";

    document.getElementById("msgInput").addEventListener("input", handleTyping);
    
    // מאזין לבחירת קובץ
    document.getElementById("imageInput").addEventListener("change", handleImageSelection);

    document.addEventListener("visibilitychange", () => {
        if (!document.hidden && authed) {
            forceReauth();
        }
    });

    listenForCall();
    listenPresence();
});

/* --- טיפול בהוספת תמונה (Base64) --- */
function handleImageSelection(event) {
    if (!authed) return alert("קודם הזן סיסמה.");
    if (!myRole) return alert("בחר גבר או אישה קודם.");

    const file = event.target.files[0];
    if (!file) return;

    // בדיקת סוג הקובץ
    const allowedTypes = ["image/jpeg", "image/png"];
    if (!allowedTypes.includes(file.type)) {
        alert("נא לבחור קובץ בפורמט JPG או PNG בלבד.");
        event.target.value = null; 
        return;
    }

    const reader = new FileReader();
    
    reader.onloadend = function() {
        const base64Data = reader.result;
        
        // שליחת ה-Base64 כהודעה לצ'אט
        db.ref("chat/messages").push({
            text: base64Data, 
            role: myRole,
            time: Date.now()
        });

        stopTyping();
        event.target.value = null; // איפוס הקלט
    };

    reader.onerror = function(error) {
        console.error("שגיאה בקריאת קובץ:", error);
        alert("אירעה שגיאה בטעינת הקובץ.");
        event.target.value = null;
    };

    reader.readAsDataURL(file);
}

/* --- נוכחות --- */
function listenPresence() {
    db.ref("presence/male").on("value", snap => {
        const data = snap.val() || {};
        updatePresenceUI("male", data);
    });
    db.ref("presence/female").on("value", snap => {
        const data = snap.val() || {};
        updatePresenceUI("female", data);
    });
}

function updatePresenceUI(role, data) {
    const dot = role === "male" ? presenceMaleDot : presenceFemaleDot;
    const timeEl = role === "male" ? presenceMaleTime : presenceFemaleTime;
    if (!dot || !timeEl) return;

    const online = data.status === "online";
    if (online) dot.classList.add("online");
    else dot.classList.remove("online");

    if (data.lastSeen) {
        const d = new Date(data.lastSeen);
        let h = d.getHours();
        let m = d.getMinutes();
        const hh = (h < 10 ? "0" + h : "" + h);
        const mm = (m < 10 ? "0" + m : "" + m);
        timeEl.textContent = online ? "עכשיו" : hh + ":" + mm;
    } else {
        timeEl.textContent = "--:--";
    }
}

function updatePresenceOnline() {
    if (!myRole) return;
    presenceRef = db.ref("presence/" + myRole);
    presenceRef.set({
        status: "online",
        lastSeen: firebase.database.ServerValue.TIMESTAMP
    });
    presenceRef.onDisconnect().set({
        status: "offline",
        lastSeen: firebase.database.ServerValue.TIMESTAMP
    });
}

function updatePresenceOffline() {
    if (presenceRef) {
        presenceRef.set({
            status: "offline",
            lastSeen: firebase.database.ServerValue.TIMESTAMP
        });
    }
}

/* --- סיסמה --- */
function checkPassword() {
    const input = document.getElementById("passInput").value.trim();
    const err = document.getElementById("passError");

    if (input === "2009") {
        authed = true;
        document.getElementById("passwordScreen").style.display = "none";
        err.textContent = "";

        if (myRole) {
            document.getElementById("roleSelect").style.display = "none";
            startTypingListener();
            updatePresenceOnline();
        } else {
            document.getElementById("roleSelect").style.display = "flex";
        }
    } else {
        err.textContent = "סיסמה שגויה";
    }
}

/* כפיית הזנת סיסמה מחדש */
function forceReauth() {
    if (!authed) return;
    authed = false;
    stopTyping();
    endCall(true); 
    updatePresenceOffline();
    document.getElementById("passInput").value = "";
    document.getElementById("passError").textContent = "";
    document.getElementById("passwordScreen").style.display = "flex";
    document.getElementById("roleSelect").style.display = "none";
}

/* בחירת תפקיד */
function chooseRole(role) {
    myRole = role;
    localStorage.setItem("role", role);
    document.getElementById("roleSelect").style.display = "none";
    startTypingListener();
    if (authed) {
        updatePresenceOnline();
    }
}

/* שליחת הודעה */
function sendMsg() {
    if (!authed) return alert("קודם הזן סיסמה.");
    if (!myRole) return alert("בחר גבר או אישה קודם.");

    let txt = document.getElementById("msgInput").value.trim();
    if (!txt) return;

    db.ref("chat/messages").push({
        text: txt,
        role: myRole,
        time: Date.now()
    });

    stopTyping();
    document.getElementById("msgInput").value = "";
}

/* קבלת הודעות בזמן אמת */
db.ref("chat/messages").on("child_added", snap => {
    const data = snap.val();
    if (!data) return;
    addMessage(snap.key, data.text, data.role, data.time);
});

/* עדכון: מחיקת הודעה (כאשר מפתח הודעה נמחק) */
db.ref("chat/messages").on("child_removed", snap => {
    const key = snap.key;
    const element = document.getElementById("msg-" + key);
    if (element) {
        element.remove();
    }
});


/* מחיקת הודעה ספציפית */
function deleteMessage(key) {
    if (!authed) return alert("קודם הזן סיסמה.");
    if (!key) return;

    if (confirm("האם אתה בטוח שברצונך למחוק הודעה זו?")) {
        // מוחק את ההודעה מהבסיס נתונים
        db.ref("chat/messages/" + key).remove()
            .then(() => {
                console.log("הודעה נמחקה בהצלחה:", key);
            })
            .catch(error => {
                console.error("שגיאה במחיקת הודעה:", error);
                alert("אירעה שגיאה במחיקת ההודעה.");
            });
    }
}

/* הצגת הודעה (עודכן לטיפול בתמונה ואירוע לחיצה ארוכה) */
function addMessage(key, text, role, time) {
    const chat = document.getElementById("chatBox");

    const msgDiv = document.createElement("div");
    msgDiv.className = "msg " + (role === "male" ? "me" : "friend");
    msgDiv.id = "msg-" + key; // נותנים ID ייחודי לכל הודעה

    // --- לחיצה ארוכה למחיקה (3 שניות) ---
    // שימוש ב-pointerdown/pointerup כדי לתפוס גם עכבר וגם מגע בצורה עקבית
    msgDiv.onpointerdown = (e) => {
        // מנע הפעלה חוזרת אם הלחיצה לא שוחררה כראוי
        if (longPressTimeout) return; 

        if (authed) {
            // התחלת ספירה לאחור של 3 שניות
            longPressTimeout = setTimeout(() => {
                deleteMessage(key);
                longPressTimeout = null; // איפוס לאחר הפעלה
            }, 3000);
        }
    };

    // עצירת הספירה לאחור אם הלחיצה משוחררת מוקדם מדי או עוזבת את האלמנט
    msgDiv.onpointerup = msgDiv.onpointercancel = msgDiv.onmouseleave = () => {
        if (longPressTimeout) {
            clearTimeout(longPressTimeout);
            longPressTimeout = null;
        }
    };
    // ----------------------------------------------------


    const icon = document.createElement("div");
    icon.className = "icon " + (role === "male" ? "male" : "female");

    const bubble = document.createElement("div");
    bubble.className = "bubble";

    const isImage = typeof text === 'string' && text.startsWith('data:image/');

    if (isImage) {
        const img = document.createElement("img");
        img.className = "chat-image"; // יחיל את הסגנון 5x5 ס"מ
        img.src = text; 
        bubble.appendChild(img);
    } else {
        const textDiv = document.createElement("div");
        textDiv.className = "msg-text";
        textDiv.textContent = text;
        bubble.appendChild(textDiv);
    }

    const timeDiv = document.createElement("div");
    timeDiv.className = "msg-time";
    timeDiv.textContent = formatTime(time);

    if (timeDiv.textContent) {
        bubble.appendChild(timeDiv);
    }

    msgDiv.appendChild(icon);
    msgDiv.appendChild(bubble);

    chat.appendChild(msgDiv);
    chat.scrollTop = chat.scrollHeight;
}

function formatTime(time) {
    if (!time) return "";
    const d = new Date(time);
    let h = d.getHours();
    let m = d.getMinutes();
    const hh = (h < 10 ? "0" + h : "" + h);
    const mm = (m < 10 ? "0" + m : "" + m);
    return hh + ":" + mm;
}

/* מחיקת צ'אט */
function clearChat() {
    if (!confirm("למחוק את כל הצ'אט לכולם?")) return;
    db.ref("chat").remove();
    document.getElementById("chatBox").innerHTML = "";
    db.ref("chat/typing").set(null);
}

/* --- חיווי "מקליד/ה" --- */
function handleTyping() {
    if (!myRole || !authed) return;

    db.ref("chat/typing/" + myRole).set(true);

    if (typingTimeout) clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
        stopTyping();
    }, 1200);
}
function stopTyping() {
    if (!myRole) return;
    db.ref("chat/typing/" + myRole).set(false);
}
function startTypingListener() {
    if (typingListenerStarted || !myRole) return;
    typingListenerStarted = true;

    db.ref("chat/typing").on("value", snap => {
        const data = snap.val() || {};
        const ti = document.getElementById("typingIndicator");
        const otherRole = (myRole === "male") ? "female" : "male";

        if (data[otherRole]) {
            ti.textContent = (otherRole === "male") ? "מקליד..." : "מקלידה...";
            ti.style.visibility = "visible";
        } else {
            ti.style.visibility = "hidden";
        }
    });
}

/* לפני סגירת הדף – לא להשאיר "מקליד" / נוכחות / LIVE */
window.addEventListener("beforeunload", () => {
    stopTyping();
    endCall(true);
    updatePresenceOffline();
});

/* --- LIVE – לוגיקה קיימת + אישור --- */

function onLiveClick() {
    if (!authed) return alert("קודם הזן סיסמה.");
    if (!myRole) return alert("בחר גבר או אישה קודם.");
    if (inCall) {
        endCall();
        return;
    }
    
    // אישור לפני התחלת שיחה
    if (confirm("האם אתה בטוח שברצונך להתחיל שיחת LIVE?")) {
        startCall();
    }
}

/* התחלת שיחה כקורא */
async function startCall() {
    isCaller = true;
    await setupPeerConnection();

    await db.ref("call").set({
        state: "calling",
        from: myRole
    });

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    await db.ref("call/offer").set(offer);

    showLiveOverlay();
}

/* הקמת PeerConnection + מצלמה */
async function setupPeerConnection() {
    pc = new RTCPeerConnection(servers);

    pc.onicecandidate = event => {
        if (event.candidate) {
            db.ref("call/candidates/" + myRole).push(event.candidate.toJSON());
        }
    };

    pc.ontrack = event => {
        const remoteVideo = document.getElementById("remoteVideo");
        if (remoteVideo.srcObject !== event.streams[0]) {
            remoteVideo.srcObject = event.streams[0];
        }
    };

    try {
        localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
    } catch (err) {
        alert("שגיאה בגישה למצלמה/מיקרופון: " + err.message);
        return;
    }

    const localVideo = document.getElementById("localVideo");
    localVideo.srcObject = localStream;

    localStream.getTracks().forEach(track => {
        pc.addTrack(track, localStream);
    });

    inCall = true;
}

/* האזנה לשיחות נכנסות */
function listenForCall() {
    db.ref("call").on("value", async snap => {
        const data = snap.val();

        if (!data) {
            hideIncoming();
            hideLiveOverlay();
            return;
        }

        const state = data.state;
        const from = data.from;

        if (!myRole) return;

        const otherRole = (myRole === "male") ? "female" : "male";

        if (state === "calling" && from === otherRole && !inCall && authed) {
            showIncoming();
        }

        if (state === "ended") {
            endCall(true);
        }
    });

    db.ref("call/answer").on("value", async snap => {
        const answer = snap.val();
        if (!answer || !pc || !isCaller) return;

        if (!pc.currentRemoteDescription) {
            await pc.setRemoteDescription(new RTCSessionDescription(answer));
        }
    });

    const otherRoleForCand = (myRole === "male") ? "female" : "male";
    db.ref("call/candidates/" + otherRoleForCand).on("child_added", async snap => {
        const cand = snap.val();
        if (pc && cand) {
            try {
                await pc.addIceCandidate(new RTCIceCandidate(cand));
            } catch (e) {}
        }
    });
}

/* מענה לשיחה נכנסת */
async function acceptCall() {
    hideIncoming();
    isCaller = false;

    const callSnap = await db.ref("call").once("value");
    const callData = callSnap.val();
    if (!callData || callData.state !== "calling") {
        return;
    }

    await setupPeerConnection();

    const offerSnap = await db.ref("call/offer").once("value");
    const offer = offerSnap.val();
    if (!offer) return;

    await pc.setRemoteDescription(new RTCSessionDescription(offer));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    await db.ref("call/answer").set(answer);
    await db.ref("call/state").set("accepted");

    showLiveOverlay();
}

/* דחיית שיחה נכנסת */
async function rejectCall() {
    hideIncoming();
    await db.ref("call/state").set("ended");
}

/* סיום שיחה */
async function endCall(forceOnlyLocal=false) {
    if (localStream) {
        localStream.getTracks().forEach(t => t.stop());
        localStream = null;
    }
    if (pc) {
        pc.close();
        pc = null;
    }
    inCall = false;
    isCaller = false;
    hideLiveOverlay();

    if (!forceOnlyLocal) {
        await db.ref("call").set(null);
    }
}

/* הצגת/הסתרת תצוגות LIVE */
function showIncoming() {
    document.getElementById("incomingCall").style.display = "flex";
}
function hideIncoming() {
    document.getElementById("incomingCall").style.display = "none";
}
function showLiveOverlay() {
    document.getElementById("liveOverlay").style.display = "flex";
}
function hideLiveOverlay() {
    document.getElementById("liveOverlay").style.display = "none";
}
</script>

</body>
</html>
