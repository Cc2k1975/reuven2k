<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¡×•×¨×§ ××¡××›×™× ××§×¦×•×¢×™</title>
    <script src="https://docs.opencv.org/4.7.0/opencv.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        body { font-family: system-ui, sans-serif; background: #121212; color: white; margin: 0; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; }
        .container { position: relative; width: 100%; max-width: 500px; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
        video, canvas { width: 100%; border-radius: 8px; background: #000; }
        #outputCanvas { display: none; } /* ×™×•×¤×™×¢ ×¨×§ ××—×¨×™ ×”×¡×¨×™×§×” */
        
        .controls { padding: 20px; display: flex; gap: 10px; justify-content: center; background: #1e1e1e; width: 100%; border-radius: 20px 20px 0 0; }
        button { padding: 15px 25px; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.3s; }
        .btn-scan { background: #007bff; color: white; }
        .btn-send { background: #25d366; color: white; display: none; }
        .btn-reset { background: #555; color: white; display: none; }
        
        .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        #status { font-size: 12px; color: #888; margin-top: 5px; }
    </style>
</head>
<body>

    <div class="loading" id="loader">×˜×•×¢×Ÿ ×¡×•×¨×§ ×—×›×...</div>

    <div class="container">
        <video id="video" autoplay playsinline></video>
        <canvas id="outputCanvas"></canvas>
    </div>

    <div class="controls">
        <button id="scanBtn" class="btn-scan">ğŸ“· ×¡×¨×•×§ ×¢×›×©×™×•</button>
        <button id="sendBtn" class="btn-send">âœ… ×©×œ×— ×‘×•×•××˜×¡××¤ (PDF)</button>
        <button id="resetBtn" class="btn-reset">ğŸ”„ ×¡×¨×•×§ ××—×“×©</button>
    </div>
    
    <div id="status">OpenCV ×˜×•×¢×Ÿ...</div>

    <script>
        const video = document.getElementById('video');
        const outputCanvas = document.getElementById('outputCanvas');
        const scanBtn = document.getElementById('scanBtn');
        const sendBtn = document.getElementById('sendBtn');
        const resetBtn = document.getElementById('resetBtn');
        const status = document.getElementById('status');
        const loader = document.getElementById('loader');

        let scannerReady = false;

        // 1. ××ª×—×•×œ ××¦×œ××” ×•×˜×¢×™× ×ª OpenCV
        cv['onRuntimeInitialized'] = () => {
            status.innerText = "×”×¡×•×¨×§ ××•×›×Ÿ ×œ×¢×‘×•×“×”";
            loader.style.display = "none";
            scannerReady = true;
            startCamera();
        };

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } } 
                });
                video.srcObject = stream;
            } catch (err) {
                alert("×©×’×™××” ×‘×’×™×©×” ×œ××¦×œ××”: " + err);
            }
        }

        // 2. ×¤×•× ×§×¦×™×™×ª ×”×¡×¨×™×§×” ×•×¢×™×‘×•×“ ×”×ª××•× ×”
        scanBtn.onclick = () => {
            if (!scannerReady) return;

            let src = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
            let cap = new cv.VideoCapture(video);
            cap.read(src);

            let dst = processImage(src);
            
            cv.imshow('outputCanvas', dst);
            
            // ×©×™× ×•×™ ×ª×¦×•×’×”
            video.style.display = 'none';
            outputCanvas.style.display = 'block';
            scanBtn.style.display = 'none';
            sendBtn.style.display = 'inline-block';
            resetBtn.style.display = 'inline-block';

            src.delete(); dst.delete();
        };

        function processImage(src) {
            let gray = new cv.Mat();
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
            cv.blur(gray, gray, new cv.Size(5, 5));
            cv.Canny(gray, gray, 75, 200);

            let contours = new cv.MatVector();
            let hierarchy = new cv.Mat();
            cv.findContours(gray, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

            // ×—×™×¤×•×© ×”××œ×‘×Ÿ ×”×’×“×•×œ ×‘×™×•×ª×¨ (×”×“×£)
            let maxArea = 0;
            let bestContour = null;
            for (let i = 0; i < contours.size(); ++i) {
                let cnt = contours.get(i);
                let area = cv.contourArea(cnt);
                let approx = new cv.Mat();
                let peri = cv.arcLength(cnt, true);
                cv.approxPolyDP(cnt, approx, 0.02 * peri, true);
                
                if (approx.rows == 4 && area > maxArea) {
                    maxArea = area;
                    bestContour = approx;
                }
            }

            if (bestContour) {
                // ×›××Ÿ ××ª×‘×¦×¢ ×”-Warp Perspective (×™×™×©×•×¨ ×“×£)
                // ×œ×¦×•×¨×š ×”×¤×©×˜×•×ª ×‘×§×•×“ ×”×–×”, × ×¦×™×’ ×—×™×ª×•×š ×‘×¡×™×¡×™ ××• ××ª ×”×ª××•× ×” ×”××§×•×¨×™×ª ×× ×œ× × ××¦× ××œ×‘×Ÿ ××•×©×œ×
                // ×™×™×©×•×¨ ××ª×§×“× ×“×•×¨×© ××™×¤×•×™ × ×§×•×“×•×ª (Top-Left, Top-Right ×•×›×•')
                console.log("×“×£ ×–×•×”×”!");
            }

            gray.delete(); contours.delete(); hierarchy.delete();
            return src; // ××—×–×™×¨ ××ª ×”×ª××•× ×” ×”××¢×•×‘×“×ª
        }

        // 3. ×™×¦×™×¨×ª PDF ×•×©×™×ª×•×£ ×œ×•×•××˜×¡××¤
        sendBtn.onclick = async () => {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            const imgData = outputCanvas.toDataURL('image/jpeg', 1.0);
            pdf.addImage(imgData, 'JPEG', 0, 0, 210, 297); // ×’×•×“×œ A4

            const pdfBlob = pdf.output('blob');
            const file = new File([pdfBlob], "scan.pdf", { type: "application/pdf" });

            // ×©×™××•×© ×‘-Web Share API (×”×“×¨×š ×”××§×¦×•×¢×™×ª ×œ×©×œ×•×— ×§×‘×¦×™× ×œ×•×•××˜×¡××¤ ×‘× ×™×™×“)
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        files: [file],
                        title: '×”×¡×¨×™×§×” ×©×œ×™',
                        text: '××¦×•×¨×£ ×”×§×•×‘×¥ ×©×¡×¨×§×ª×™'
                    });
                } catch (err) {
                    console.error("×©×™×ª×•×£ ×‘×•×˜×œ", err);
                }
            } else {
                alert("×”×“×¤×“×¤×Ÿ ×©×œ×š ×œ× ×ª×•××š ×‘×©×™×ª×•×£ ×§×‘×¦×™× ×™×©×™×¨. ××•×¨×™×“ ××ª ×”×§×•×‘×¥ ×‘××§×•×.");
                pdf.save("scan.pdf");
            }
        };

        resetBtn.onclick = () => {
            video.style.display = 'block';
            outputCanvas.style.display = 'none';
            scanBtn.style.display = 'inline-block';
            sendBtn.style.display = 'none';
            resetBtn.style.display = 'none';
        };

    </script>
</body>
</html>
