<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <title>××—×•×œ×œ ×—×ª×•× ×” - ×’×¨×¡×” ×¡×•×¤×™×ª (Final)</title>

  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Rubik:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <style>
    :root { --text-color: #1a1a1a; --gold-color: #c5a059; }

    /* ××¡×š ××œ× + ×œ×œ× ×’×œ×™×œ×” */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #222;
      font-family: 'Rubik', sans-serif;
      touch-action: none;             /* ××¡×™×™×¢ ×œ×—×¡×™××ª ××—×•×•×ª ×–×•× ×‘××›×©×™×¨×™× ××¡×•×™××™× */
      -webkit-user-select: none;
      user-select: none;
    }

    /* Safe area (notch) */
    body {
      padding-top: env(safe-area-inset-top);
      padding-right: env(safe-area-inset-right);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      display: flex;
      flex-direction: column;
      align-items: center;
      color: white;
    }

    /* --- ×¤×× ×œ ×©×œ×™×˜×” --- */
    .controls {
      display: flex;
      gap: 12px;
      align-items: flex-end;
      z-index: 1000;
      background: #333;
      border: 1px solid #555;
      border-radius: 12px;
      flex-wrap: wrap;
      justify-content: center;
      box-sizing: border-box;
      color: #fff;

      /* ×‘××—×©×‘ */
      width: min(980px, calc(100vw - 24px));
      padding: 14px;
      margin: 12px 0;
    }

    .input-group { display: flex; flex-direction: column; gap: 5px; }
    label { font-size: 0.85rem; color: #ccc; }

    input[type="text"], input[type="date"], input[type="time"] {
      padding: 10px;
      border-radius: 8px;
      border: none;
      font-family: 'Rubik', sans-serif;
      width: 150px;
      font-size: 0.95rem;
      outline: none;
    }

    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 28px;
      border-radius: 10px;
      font-weight: 800;
      cursor: pointer;
      transition: 0.2s;
      height: 42px;
      font-size: 1rem;
      white-space: nowrap;
    }
    button:hover { background: #45a049; }

    /* --- ××–×•×¨ ×”×ª×¦×•×’×” / ×§× ×‘×¡ ×¡×§×™×™×œ --- */
    .stage {
      width: 100vw;
      flex: 1;                 /* ×œ×•×§×— ××ª ×›×œ ×”×©×˜×— ×©× ×•×ª×¨ */
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      box-sizing: border-box;
      padding: 8px;
    }

    .preview-area {
      position: relative;
      background: white;
      box-shadow: 0 0 50px rgba(0,0,0,0.5);
      overflow: hidden;
      user-select: none;
      transform-origin: center center; /* ×—×©×•×‘ ×œ×¡×§×™×™×œ */
      will-change: transform;
    }

    /* ×”×ª××•× ×” â€œ×”××§×•×¨×™×ªâ€ â€” × ×©××•×¨ ×¢×œ×™×” ×‘××™×“×•×ª ×˜×‘×¢×™×•×ª ×›×“×™ ×©×”××—×•×–×™× ×©×œ left/top ×™×™×©××¨×• × ×›×•×Ÿ */
    #bgImage {
      display: block;
      width: auto;
      height: auto;
      max-width: none;
      max-height: none;
      pointer-events: none;
    }

    /* --- ××œ×× ×˜×™× ××§×•×‘×¢×™× --- */
    .final-element {
      position: absolute;
      transform-origin: center center;
      text-align: center;
      color: var(--text-color);
      white-space: nowrap;
      filter: blur(0.4px);
      transform: translate(-50%, -50%);
    }

    /* --- ×¢×™×¦×•×‘ ×˜×§×¡×˜ --- */
    .bsd-txt { font-size: 14px; font-weight: 500; }
    .names-txt { font-family: 'Playfair Display', serif; font-size: 40px; display: flex; gap: 30px; direction: ltr; align-items: center; }
    .intro-txt { font-size: 14px; line-height: 1.3; }
    .greg-txt { font-size: 32px; font-weight: 900; letter-spacing: 2px; }
    .left-date-txt { font-family: 'Rubik'; font-weight: 900; font-size: 16px; letter-spacing: 1px; }
    .loc-title-txt { font-weight: 700; font-size: 16px; }
    .address-txt { font-weight: 500; font-size: 14px; }

    .time-box { display: flex; flex-direction: column; align-items: center; }
    .icon { font-size: 24px; margin-bottom: 2px; }
    .flower-icon { color: var(--gold-color); font-size: 24px; }

    .parents-txt { font-size: 12px; text-align: center; line-height: 1.3; }

    .initial-txt { font-family: 'Playfair Display', serif; font-size: 80px; font-weight: 400; line-height: 1; }

    /* --- ×”×ª×××•×ª ××•×‘×™×™×œ: ×¤×× ×œ ×‘×ª×—×ª×™×ª ×›×“×™ ×œ×”×©××™×¨ ××§×•× ×œ×ª×¦×•×’×” --- */
    @media (max-width: 700px) {
      body { padding: 0; }
      .controls {
        order: 2;
        width: calc(100vw - 16px);
        margin: 8px 0 10px;
        padding: 10px;
        gap: 10px;
        border-radius: 14px;
      }
      input[type="text"], input[type="date"], input[type="time"] { width: 140px; }
      button { width: 100%; }
      .stage {
        order: 1;
        padding: 6px;
      }
    }
  </style>
</head>

<body>

  <div class="stage">
    <div class="preview-area" id="captureTarget" aria-label="Wedding Invite Preview">
      <img id="bgImage" src="wed2.jpg" alt="×¨×§×¢" onerror="alert('×—×¡×¨×” ×ª××•× ×” wed2.jpg')">

      <div class="final-element" style="left: 88.0%; top: 34.0%; transform: translate(-50%, -50%) rotate(4.5deg) scale(1.00);">
        <div class="bsd-txt">×‘×¡"×“</div>
      </div>

      <div class="final-element" style="left: 72.2%; top: 45.6%; transform: translate(-50%, -50%) rotate(5.0deg) scale(0.80);">
        <div class="names-txt" id="namesText"><span>Dor</span><span class="flower-icon">â€</span><span>Shani</span></div>
      </div>

      <div class="final-element" style="left: 72.0%; top: 52.0%; transform: translate(-50%, -50%) rotate(5.0deg) scale(1.00);">
        <div class="intro-txt">
          ×× ×• × ×¨×’×©×™× ×œ×”×–××™× ×›× ×œ×—×’×•×’ ××™×ª× ×• ××ª ×—×ª×•× ×ª× ×•<br>
          ×©×ª×¢×¨×š ×‘×™×•× <span id="dayName">×—××™×©×™</span>, <span id="hebDate">×›' ×‘××“×¨ ×”×ª×©×¦"×</span>
        </div>
      </div>

      <div class="final-element" style="left: 73.0%; top: 59.0%; transform: translate(-50%, -50%) rotate(5.0deg) scale(1.00);">
        <div class="greg-txt" id="gregDate">07.03.2030</div>
      </div>

      <div class="final-element" style="left: 72.0%; top: 64.0%; transform: translate(-50%, -50%) rotate(5.0deg) scale(1.00);">
        <div class="loc-title-txt" id="locTitleText">××•×œ××™ "× ×•××¨"</div>
      </div>

      <div class="final-element" style="left: 72.0%; top: 66.0%; transform: translate(-50%, -50%) rotate(5.0deg) scale(1.00);">
        <div class="address-txt" id="addressText">×”×©×“×¨×” 14, ×ª×œ ××‘×™×‘</div>
      </div>

      <div class="final-element" style="left: 72.0%; top: 73.0%; transform: translate(-50%, -50%) rotate(5.0deg) scale(1.00);">
        <div style="display:flex; gap:60px;">
          <div class="time-box"><div class="icon">ğŸ’</div><b id="timeChupa">20:30</b><small>×—×•×¤×” ×•×§×™×“×•×©×™×Ÿ</small></div>
          <div class="time-box"><div class="icon">ğŸ¥‚</div><b id="timeReception">19:30</b><small>×§×‘×œ×ª ×¤× ×™×</small></div>
        </div>
      </div>

      <div class="final-element" style="left: 58.3%; top: 82.4%; transform: translate(-50%, -50%) rotate(5.0deg) scale(1.00);">
        <div class="parents-txt">
          <b>×”×•×¨×™ ×”×—×ª×Ÿ</b><br><span id="parentsGroomName">×œ×‘× ×” ×•×™×•×¡×™ ×¨××•×‘× ×™</span>
        </div>
      </div>

      <div class="final-element" style="left: 83.5%; top: 84.7%; transform: translate(-50%, -50%) rotate(5.0deg) scale(1.00);">
        <div class="parents-txt">
          <b>×”×•×¨×™ ×”×›×œ×”</b><br><span id="parentsBrideName">×–×™×•×” ×•×’×™×œ ×™×•×¡×£</span>
        </div>
      </div>

      <div class="final-element" style="left: 31.2%; top: 29.3%; transform: translate(-50%, -50%) rotate(-5.0deg) scale(1.00);">
        <div class="initial-txt" id="groomInitialText">D</div>
      </div>

      <div class="final-element" style="left: 33.3%; top: 54.1%; transform: translate(-50%, -50%) rotate(-5.0deg) scale(1.00);">
        <div class="initial-txt" id="brideInitialText">S</div>
      </div>

      <div class="final-element" style="left: 33.9%; top: 65.4%; transform: translate(-50%, -50%) rotate(-5.0deg) scale(1.00);">
        <div class="left-date-txt" id="leftDateText">07.03.2030</div>
      </div>
    </div>
  </div>

  <div class="controls">
    <div class="input-group">
      <label>×©× ×”×—×ª×Ÿ (×× ×’×œ×™×ª):</label>
      <input type="text" id="groomInput" value="Dor" oninput="updateNames()">
    </div>

    <div class="input-group">
      <label>×©× ×”×›×œ×” (×× ×’×œ×™×ª):</label>
      <input type="text" id="brideInput" value="Shani" oninput="updateNames()">
    </div>

    <div class="input-group">
      <label>×ª××¨×™×š:</label>
      <input type="date" id="dateInput">
    </div>

    <div class="input-group">
      <label>×©×¢×•×ª (×§×‘"×¤ / ×—×•×¤×”):</label>
      <div style="display:flex; gap:6px;">
        <input type="text" value="19:30" placeholder="×§×‘''×¤" style="width:70px;" oninput="updateText('timeReception', this.value)">
        <input type="text" value="20:30" placeholder="×—×•×¤×”" style="width:70px;" oninput="updateText('timeChupa', this.value)">
      </div>
    </div>

    <div class="input-group">
      <label>××•×œ× ×•×›×ª×•×‘×ª:</label>
      <input type="text" value='××•×œ××™ "× ×•××¨"' oninput="updateText('locTitleText', this.value)">
      <input type="text" value="×”×©×“×¨×” 14, ×ª×œ ××‘×™×‘" oninput="updateText('addressText', this.value)">
    </div>

    <div class="input-group">
      <label>×”×•×¨×™× (×—×ª×Ÿ / ×›×œ×”):</label>
      <input type="text" value="×œ×‘× ×” ×•×™×•×¡×™ ×¨××•×‘× ×™" placeholder="×”×•×¨×™ ×”×—×ª×Ÿ" oninput="updateText('parentsGroomName', this.value)">
      <input type="text" value="×–×™×•×” ×•×’×™×œ ×™×•×¡×£" placeholder="×”×•×¨×™ ×”×›×œ×”" oninput="updateText('parentsBrideName', this.value)">
    </div>

    <button onclick="saveImage()">ğŸ“· ×©××•×¨</button>
  </div>

  <script>
    // ×—×¡×™××ª pinch-to-zoom + double-tap zoom
    document.addEventListener('gesturestart', (e) => e.preventDefault(), { passive: false });
    document.addEventListener('gesturechange', (e) => e.preventDefault(), { passive: false });
    document.addEventListener('gestureend', (e) => e.preventDefault(), { passive: false });

    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (e) {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) e.preventDefault();
      lastTouchEnd = now;
    }, { passive: false });

    // ===== ×× ×’× ×•×Ÿ FIT ×××™×ª×™: ×”×ª××•× ×” × ×©××¨×ª ×‘××™×“×” ××§×•×¨×™×ª, ×•×›×œ ×”×‘×œ×•×§ scaled ×œ××¡×š =====
    function fitToScreen() {
      const capture = document.getElementById('captureTarget');
      const img = document.getElementById('bgImage');

      // ×—×™×™×‘×™× ××™×“×•×ª ×˜×‘×¢×™×•×ª ×©×œ ×”×ª××•× ×”
      const naturalW = img.naturalWidth || 0;
      const naturalH = img.naturalHeight || 0;
      if (!naturalW || !naturalH) return;

      // ×§×•×‘×¢×™× ×œ-preview-area ×’×•×“×œ â€œ××§×•×¨×™â€
      capture.style.width = naturalW + 'px';
      capture.style.height = naturalH + 'px';

      // ××™×–×•×¨ ×–××™×Ÿ ×‘×ª×•×š stage (×‘×œ×™ ×œ×©×‘×•×¨ layout)
      const stage = document.querySelector('.stage');
      const stageRect = stage.getBoundingClientRect();

      // ××¨×•×•×— ×¤× ×™××™ ×§×˜×Ÿ
      const pad = 8;
      const availW = Math.max(10, stageRect.width - pad * 2);
      const availH = Math.max(10, stageRect.height - pad * 2);

      // scale ×›×“×™ ×œ×”×›× ×™×¡ ××ª ×›×œ ×”×ª××•× ×” ×œ××¡×š ×‘×œ×™ ×’×œ×™×œ×”
      const scale = Math.min(availW / naturalW, availH / naturalH);

      capture.style.transform = `scale(${scale})`;
    }

    // ×¢×“×›×•×Ÿ ×©××•×ª ×•××•×ª×™×•×ª
    function updateNames() {
      const groom = document.getElementById('groomInput').value;
      const bride = document.getElementById('brideInput').value;

      document.getElementById('namesText').innerHTML =
        `<span>${escapeHtml(groom)}</span><span class="flower-icon">â€</span><span>${escapeHtml(bride)}</span>`;

      if (groom.length > 0) document.getElementById('groomInitialText').innerText = groom.charAt(0).toUpperCase();
      if (bride.length > 0) document.getElementById('brideInitialText').innerText = bride.charAt(0).toUpperCase();
    }

    function updateText(elementId, val) {
      const el = document.getElementById(elementId);
      if (el) el.innerText = val;
    }

    function toGematria(num) {
      const letters = ['', '×', '×‘', '×’', '×“', '×”', '×•', '×–', '×—', '×˜', '×™', '×™×', '×™×‘', '×™×’', '×™×“', '×˜×•', '×˜×–', '×™×–', '×™×—', '×™×˜', '×›', '×›×', '×›×‘', '×›×’', '×›×“', '×›×”', '×›×•', '×›×–', '×›×—', '×›×˜', '×œ', '×œ×'];
      return num > 30 ? num : letters[num];
    }

    document.getElementById('dateInput').addEventListener('change', function () {
      if (!this.value) return;
      const d = new Date(this.value);

      const parts = new Intl.DateTimeFormat('he-IL-u-ca-hebrew', { weekday: 'long', month: 'long', day: 'numeric' }).formatToParts(d);
      let weekday = '', month = '', dayNum = 0;

      parts.forEach(p => {
        if (p.type === 'weekday') weekday = p.value;
        if (p.type === 'month') month = p.value;
        if (p.type === 'day') dayNum = parseInt(p.value, 10);
      });

      document.getElementById('dayName').innerText = weekday.replace('×™×•× ', '');
      document.getElementById('hebDate').innerText = `${toGematria(dayNum)} ×‘${month} ×ª×©×¤"×“`;

      const gDate = `${String(d.getDate()).padStart(2, '0')}.${String(d.getMonth() + 1).padStart(2, '0')}.${d.getFullYear()}`;
      document.getElementById('gregDate').innerText = gDate;
      document.getElementById('leftDateText').innerText = gDate;
    });

    function saveImage() {
      const captureElement = document.getElementById('captureTarget');

      // ×—×©×•×‘: ×›×©×™×© scale ×‘-CSS, html2canvas ×—×™×™×‘ ×œ×§×‘×œ ××ª ×”-transform â€œ××—×¨×™â€ â€” ×•×œ×›×Ÿ ×× ×• ××™×™×¦×¨×™× ×¦×™×œ×•× ×œ×¤×™ ×”××™×“×” ×”××§×•×¨×™×ª
      const prevTransform = captureElement.style.transform;
      captureElement.style.transform = 'scale(1)';

      html2canvas(captureElement, { useCORS: true, scale: 2, backgroundColor: null }).then(canvas => {
        const link = document.createElement('a');
        link.download = "wedding_invite_final.jpg";
        link.href = canvas.toDataURL("image/jpeg", 0.9);
        link.click();
      }).finally(() => {
        captureElement.style.transform = prevTransform;
      });
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, m => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[m]));
    }

    // ×”×ª×××” ×¨××©×•× ×” ×œ××—×¨ ×˜×¢×™× ×ª ×ª××•× ×” + ×©×™× ×•×™×™ ××¡×š/×¡×™×‘×•×‘
    const bg = document.getElementById('bgImage');
    bg.addEventListener('load', () => {
      fitToScreen();
    });

    window.addEventListener('resize', () => {
      fitToScreen();
    });

    // iOS ×œ×¤×¢××™× ××©× ×” ×’×•×‘×” ×‘×’×œ×œ ×¡×¨×’×œ×™× â€” × ×‘×¦×¢ ×¢×•×“ ×”×ª×××” ×§×¦×¨×”
    window.addEventListener('orientationchange', () => {
      setTimeout(fitToScreen, 200);
      setTimeout(fitToScreen, 600);
    });

    // init
    updateNames();
  </script>
</body>
</html>
