<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <title>××—×•×œ×œ ×—×ª×•× ×” - ×’×¨×¡×” ×¡×•×¤×™×ª (Final)</title>

  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Rubik:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <style>
    :root { --text-color:#1a1a1a; --gold-color:#c5a059; }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #111;
      font-family: 'Rubik', sans-serif;
      -webkit-text-size-adjust: 100%;
    }

    .app {
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      background: #111;
      padding-top: env(safe-area-inset-top);
      padding-right: env(safe-area-inset-right);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
    }

    .stage {
      width: 100%;
      height: 100%;
      display: grid;
      place-items: center;
      overflow: hidden;
      box-sizing: border-box;
      padding: 8px;
      position: relative; /* ×—×©×•×‘ ×œ××¨×›×•×– ×”××‘×¡×•×œ×•×˜×™ */
    }

    .preview-area {
      position: absolute;  /* ×”××¨×›×•×– × ×¢×©×” ×¢"×™ left/top 50% */
      left: 50%;
      top: 50%;

      background: #fff;
      box-shadow: 0 0 40px rgba(0,0,0,0.55);
      overflow: hidden;

      transform-origin: center center;
      will-change: transform;

      user-select: none;
      touch-action: manipulation;
    }

    #bgImage {
      display: block;
      width: auto;
      height: auto;
      max-width: none;
      max-height: none;
      pointer-events: none;
    }

    .final-element {
      position: absolute;
      transform-origin: center center;
      text-align: center;
      color: var(--text-color);
      white-space: nowrap;
      filter: blur(0.4px);
      transform: translate(-50%, -50%);
    }

    /* --- ×¢×™×¦×•×‘ ×˜×§×¡×˜ --- */
    .bsd-txt { font-size: 14px; font-weight: 500; }
    .names-txt { font-family: 'Playfair Display', serif; font-size: 40px; display: flex; gap: 30px; direction: ltr; align-items: center; }
    .intro-txt { font-size: 14px; line-height: 1.3; }
    .greg-txt { font-size: 32px; font-weight: 900; letter-spacing: 2px; }
    .left-date-txt { font-weight: 900; font-size: 16px; letter-spacing: 1px; }
    .loc-title-txt { font-weight: 700; font-size: 16px; }
    .address-txt { font-weight: 500; font-size: 14px; }
    .time-box { display: flex; flex-direction: column; align-items: center; }
    .icon { font-size: 24px; margin-bottom: 2px; }
    .flower-icon { color: var(--gold-color); font-size: 24px; }
    .parents-txt { font-size: 12px; text-align: center; line-height: 1.3; }
    .initial-txt { font-family: 'Playfair Display', serif; font-size: 80px; font-weight: 400; line-height: 1; }

    /* ===== ×›×¤×ª×•×¨ ×¦×£ ×œ×¤×ª×™×—×” ===== */
    .btn-gear {
      position: fixed;
      z-index: 2600;
      right: calc(env(safe-area-inset-right) + 12px);
      bottom: calc(env(safe-area-inset-bottom) + 12px);
      width: 56px;
      height: 56px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.22);
      background: rgba(30,30,30,0.92);
      color: #fff;
      font-size: 22px;
      font-weight: 900;
      display: grid;
      place-items: center;
      backdrop-filter: blur(10px);
      cursor: pointer;
    }

    /* ===== ×©×›×‘×ª ×¨×§×¢ ×›×©×”×ª×¤×¨×™×˜ ×¤×ª×•×— ===== */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      z-index: 2400;
      opacity: 0;
      pointer-events: none;
      transition: opacity 180ms ease;
    }
    .overlay.open {
      opacity: 1;
      pointer-events: auto;
    }

    /* ===== ×ª×¤×¨×™×˜ â€œ×›×¨×˜×™×¡â€ ×‘×××¦×¢ ×”××¡×š ===== */
    .controls {
      position: fixed;
      z-index: 2500;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%) scale(0.98);
      width: min(420px, calc(100vw - 24px));
      max-height: min(72vh, 560px);
      overflow: auto;

      background: rgba(45,45,45,0.96);
      border: 1px solid rgba(160,160,160,0.30);
      border-radius: 18px;
      padding: 14px 14px calc(14px + env(safe-area-inset-bottom));
      box-sizing: border-box;
      color: #fff;
      backdrop-filter: blur(12px);

      opacity: 0;
      pointer-events: none;
      transition: opacity 180ms ease, transform 180ms ease;
    }
    .controls.open {
      opacity: 1;
      pointer-events: auto;
      transform: translate(-50%, -50%) scale(1);
    }
    .controls { -webkit-overflow-scrolling: touch; }

    .controls-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      align-items: start;
      justify-items: stretch;
    }

    .row2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .input-group { display:flex; flex-direction:column; gap:6px; }
    label { font-size: 0.9rem; color: #eee; }

    input[type="text"], input[type="date"] {
      padding: 12px 12px;
      border-radius: 12px;
      border: none;
      font-family: 'Rubik', sans-serif;
      width: 100%;
      font-size: 1rem;
      outline: none;
      box-sizing: border-box;
    }

    button {
      background: #4CAF50;
      color: #fff;
      border: none;
      padding: 13px 16px;
      border-radius: 14px;
      font-weight: 900;
      cursor: pointer;
      height: 48px;
      font-size: 1.05rem;
      width: 100%;
    }
    .btn-mode { background:#2d6cdf; }
  </style>
</head>

<body>
  <div class="app">
    <div class="stage">
      <div class="preview-area" id="captureTarget">
        <img id="bgImage" src="wed2.jpg" onerror="alert('×—×¡×¨×” ×ª××•× ×” wed2.jpg')" alt="×¨×§×¢">

        <div class="final-element" style="left: 88.0%; top: 34.0%; transform: translate(-50%, -50%) rotate(4.5deg) scale(1.00);">
          <div class="bsd-txt">×‘×¡"×“</div>
        </div>

        <div class="final-element" style="left: 72.2%; top: 45.6%; transform: translate(-50%, -50%) rotate(5.0deg) scale(0.80);">
          <div class="names-txt" id="namesText"><span>Dor</span><span class="flower-icon">â€</span><span>Shani</span></div>
        </div>

        <div class="final-element" style="left: 72.0%; top: 52.0%; transform: translate(-50%, -50%) rotate(5.0deg) scale(1.00);">
          <div class="intro-txt">
            ×× ×• × ×¨×’×©×™× ×œ×”×–××™× ×›× ×œ×—×’×•×’ ××™×ª× ×• ××ª ×—×ª×•× ×ª× ×•<br>
            ×©×ª×¢×¨×š ×‘×™×•× <span id="dayName">×—××™×©×™</span>, <span id="hebDate">×›' ×‘××“×¨ ×”×ª×©×¦"×</span>
          </div>
        </div>

        <div class="final-element" style="left: 73.0%; top: 59.0%; transform: translate(-50%, -50%) rotate(5.0deg) scale(1.00);">
          <div class="greg-txt" id="gregDate">07.03.2030</div>
        </div>

        <div class="final-element" style="left: 72.0%; top: 64.0%; transform: translate(-50%, -50%) rotate(5.0deg) scale(1.00);">
          <div class="loc-title-txt" id="locTitleText">××•×œ××™ "× ×•××¨"</div>
        </div>

        <div class="final-element" style="left: 72.0%; top: 66.0%; transform: translate(-50%, -50%) rotate(5.0deg) scale(1.00);">
          <div class="address-txt" id="addressText">×”×©×“×¨×” 14, ×ª×œ ××‘×™×‘</div>
        </div>

        <div class="final-element" style="left: 72.0%; top: 73.0%; transform: translate(-50%, -50%) rotate(5.0deg) scale(1.00);">
          <div style="display:flex; gap:60px;">
            <div class="time-box"><div class="icon">ğŸ’</div><b id="timeChupa">20:30</b><small>×—×•×¤×” ×•×§×™×“×•×©×™×Ÿ</small></div>
            <div class="time-box"><div class="icon">ğŸ¥‚</div><b id="timeReception">19:30</b><small>×§×‘×œ×ª ×¤× ×™×</small></div>
          </div>
        </div>

        <div class="final-element" style="left: 58.3%; top: 82.4%; transform: translate(-50%, -50%) rotate(5.0deg) scale(1.00);">
          <div class="parents-txt">
            <b>×”×•×¨×™ ×”×—×ª×Ÿ</b><br><span id="parentsGroomName">×œ×‘× ×” ×•×™×•×¡×™ ×¨××•×‘× ×™</span>
          </div>
        </div>

        <div class="final-element" style="left: 83.5%; top: 84.7%; transform: translate(-50%, -50%) rotate(5.0deg) scale(1.00);">
          <div class="parents-txt">
            <b>×”×•×¨×™ ×”×›×œ×”</b><br><span id="parentsBrideName">×–×™×•×” ×•×’×™×œ ×™×•×¡×£</span>
          </div>
        </div>

        <div class="final-element" style="left: 31.2%; top: 29.3%; transform: translate(-50%, -50%) rotate(-5.0deg) scale(1.00);">
          <div class="initial-txt" id="groomInitialText">D</div>
        </div>

        <div class="final-element" style="left: 33.3%; top: 54.1%; transform: translate(-50%, -50%) rotate(-5.0deg) scale(1.00);">
          <div class="initial-txt" id="brideInitialText">S</div>
        </div>

        <div class="final-element" style="left: 33.9%; top: 65.4%; transform: translate(-50%, -50%) rotate(-5.0deg) scale(1.00);">
          <div class="left-date-txt" id="leftDateText">07.03.2030</div>
        </div>
      </div>
    </div>

    <button class="btn-gear" id="gearBtn" type="button" aria-label="×¤×ª×—/×¡×’×•×¨ ×©×œ×™×˜×”">âš™ï¸</button>
    <div class="overlay" id="overlay"></div>

    <div class="controls" id="controlsPanel" role="dialog" aria-modal="true" aria-label="×¢×¨×™×›×ª ×¤×¨×˜×™×">
      <div class="controls-grid">

        <button class="btn-mode" type="button" id="modeBtn">××¦×‘: FIT</button>

        <div class="row2">
          <div class="input-group">
            <label>×©× ×”×—×ª×Ÿ (×× ×’×œ×™×ª):</label>
            <input type="text" id="groomInput" value="Dor" oninput="updateNames()">
          </div>

          <div class="input-group">
            <label>×©× ×”×›×œ×” (×× ×’×œ×™×ª):</label>
            <input type="text" id="brideInput" value="Shani" oninput="updateNames()">
          </div>
        </div>

        <div class="input-group">
          <label>×ª××¨×™×š:</label>
          <input type="date" id="dateInput">
        </div>

        <div class="input-group">
          <label>×©×¢×•×ª (×§×‘"×¤ / ×—×•×¤×”):</label>
          <div class="row2">
            <input type="text" value="19:30" oninput="updateText('timeReception', this.value)">
            <input type="text" value="20:30" oninput="updateText('timeChupa', this.value)">
          </div>
        </div>

        <div class="input-group">
          <label>××•×œ× ×•×›×ª×•×‘×ª:</label>
          <input type="text" value='××•×œ××™ "× ×•××¨"' oninput="updateText('locTitleText', this.value)">
          <input type="text" value="×”×©×“×¨×” 14, ×ª×œ ××‘×™×‘" oninput="updateText('addressText', this.value)">
        </div>

        <div class="input-group">
          <label>×”×•×¨×™× (×—×ª×Ÿ / ×›×œ×”):</label>
          <input type="text" value="×œ×‘× ×” ×•×™×•×¡×™ ×¨××•×‘× ×™" oninput="updateText('parentsGroomName', this.value)">
          <input type="text" value="×–×™×•×” ×•×’×™×œ ×™×•×¡×£" oninput="updateText('parentsBrideName', this.value)">
        </div>

        <button type="button" onclick="saveImage()">ğŸ“· ×©××•×¨</button>
      </div>
    </div>
  </div>

  <script>
    // ×—×¡×™××ª pinch-to-zoom + double-tap zoom
    document.addEventListener('gesturestart', e => e.preventDefault(), { passive:false });
    document.addEventListener('gesturechange', e => e.preventDefault(), { passive:false });
    document.addEventListener('gestureend', e => e.preventDefault(), { passive:false });

    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (e) {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) e.preventDefault();
      lastTouchEnd = now;
    }, { passive:false });

    // ×¤×ª×™×—×”/×¡×’×™×¨×” ×ª×¤×¨×™×˜
    const controlsPanel = document.getElementById('controlsPanel');
    const overlay = document.getElementById('overlay');
    const gearBtn = document.getElementById('gearBtn');

    function openMenu() {
      controlsPanel.classList.add('open');
      overlay.classList.add('open');
    }
    function closeMenu() {
      controlsPanel.classList.remove('open');
      overlay.classList.remove('open');
    }
    gearBtn.addEventListener('click', () => {
      if (controlsPanel.classList.contains('open')) closeMenu();
      else openMenu();
    });
    overlay.addEventListener('click', closeMenu);

    // ××¦×‘ ×ª×¦×•×’×” FIT / FILL
    let VIEW_MODE = 'FIT';
    const modeBtn = document.getElementById('modeBtn');
    modeBtn.addEventListener('click', () => {
      VIEW_MODE = (VIEW_MODE === 'FIT') ? 'FILL' : 'FIT';
      modeBtn.textContent = `××¦×‘: ${VIEW_MODE}`;
      fitToScreen();
    });

    function fitToScreen() {
      const capture = document.getElementById('captureTarget');
      const img = document.getElementById('bgImage');
      const stage = document.querySelector('.stage');

      const nw = img.naturalWidth || 0;
      const nh = img.naturalHeight || 0;
      if (!nw || !nh) return;

      // ××™×“×•×ª ×§×•××¤×•×–×™×¦×™×” = ××™×“×•×ª ××§×•×¨
      capture.style.width = nw + 'px';
      capture.style.height = nh + 'px';

      // ×©×˜×— ×–××™×Ÿ ×œ××¡×š
      const vv = window.visualViewport;
      const rect = stage.getBoundingClientRect();
      let availW = rect.width;
      let availH = rect.height;
      if (vv) { availW = Math.min(availW, vv.width); availH = Math.min(availH, vv.height); }

      const pad = 8;
      availW = Math.max(50, availW - pad * 2);
      availH = Math.max(50, availH - pad * 2);

      const sContain = Math.min(availW / nw, availH / nh);
      const sCover   = Math.max(availW / nw, availH / nh);
      const scale = (VIEW_MODE === 'FILL') ? sCover : sContain;

      // ××¨×›×•×– ××•×—×œ×˜ + ×¡×§×™×™×œ
      capture.style.transform = `translate(-50%, -50%) scale(${scale})`;
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, m => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[m]));
    }

    function updateNames() {
      const groom = document.getElementById('groomInput').value;
      const bride = document.getElementById('brideInput').value;

      document.getElementById('namesText').innerHTML =
        `<span>${escapeHtml(groom)}</span><span class="flower-icon">â€</span><span>${escapeHtml(bride)}</span>`;

      if (groom.length > 0) document.getElementById('groomInitialText').innerText = groom.charAt(0).toUpperCase();
      if (bride.length > 0) document.getElementById('brideInitialText').innerText = bride.charAt(0).toUpperCase();
    }

    function updateText(elementId, val) {
      const el = document.getElementById(elementId);
      if (el) el.innerText = val;
    }

    function toGematria(num) {
      const letters = ['', '×', '×‘', '×’', '×“', '×”', '×•', '×–', '×—', '×˜', '×™', '×™×', '×™×‘', '×™×’', '×™×“', '×˜×•', '×˜×–', '×™×–', '×™×—', '×™×˜', '×›', '×›×', '×›×‘', '×›×’', '×›×“', '×›×”', '×›×•', '×›×–', '×›×—', '×›×˜', '×œ', '×œ×'];
      return num > 30 ? num : letters[num];
    }

    document.getElementById('dateInput').addEventListener('change', function() {
      if (!this.value) return;
      const d = new Date(this.value);

      const parts = new Intl.DateTimeFormat('he-IL-u-ca-hebrew', { weekday:'long', month:'long', day:'numeric' }).formatToParts(d);
      let weekday='', month='', dayNum=0;
      parts.forEach(p => {
        if (p.type==='weekday') weekday=p.value;
        if (p.type==='month') month=p.value;
        if (p.type==='day') dayNum=parseInt(p.value,10);
      });

      document.getElementById('dayName').innerText = weekday.replace('×™×•× ', '');
      document.getElementById('hebDate').innerText = `${toGematria(dayNum)} ×‘${month} ×ª×©×¤"×“`;

      const gDate = `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`;
      document.getElementById('gregDate').innerText = gDate;
      document.getElementById('leftDateText').innerText = gDate;
    });

    function saveImage() {
      const captureElement = document.getElementById('captureTarget');
      const prevTransform = captureElement.style.transform;

      // ×¦×™×œ×•× ×‘×’×•×“×œ ×”××§×•×¨×™ (×‘×œ×™ scale/translate ×œ××¡×š)
      captureElement.style.transform = 'none';
      captureElement.style.left = '0';
      captureElement.style.top = '0';

      html2canvas(captureElement, { useCORS: true, scale: 2, backgroundColor: null }).then(canvas => {
        const link = document.createElement('a');
        link.download = "wedding_invite_final.jpg";
        link.href = canvas.toDataURL("image/jpeg", 0.9);
        link.click();
      }).finally(() => {
        // ××—×–×™×¨×™× ××¦×‘ ×ª×¦×•×’×” ×œ××¡×š
        captureElement.style.left = '50%';
        captureElement.style.top = '50%';
        captureElement.style.transform = prevTransform || 'translate(-50%, -50%) scale(1)';
        fitToScreen();
      });
    }

    // init
    updateNames();
    const bg = document.getElementById('bgImage');
    bg.addEventListener('load', fitToScreen);

    window.addEventListener('resize', () => requestAnimationFrame(fitToScreen));
    window.addEventListener('orientationchange', () => { setTimeout(fitToScreen, 150); setTimeout(fitToScreen, 550); });

    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', () => requestAnimationFrame(fitToScreen));
      window.visualViewport.addEventListener('scroll', () => requestAnimationFrame(fitToScreen));
    }
  </script>
</body>
</html>