<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>שידור חי</title>
<style>
body {
  margin:0;
  overflow:hidden;
  background:#000;
  font-family:"Heebo",Arial,sans-serif;
}

/* כל המסך */
.player-shell {
  position:fixed;
  inset:0;
  width:100vw;
  height:100vh;
  background:#000;
  overflow:hidden;
}

/* --------- שכבת הוידאו --------- */
.video-layer {
  position:absolute;
  inset:0;
  background:#000;
  overflow:hidden;
}

.rotator {
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%, -50%) rotate(-90deg) scale(1.7);
  transform-origin:center center;
  background:#000;
  display:flex;
  justify-content:center;
  align-items:center;
  width:100vw;
  height:100vh;
}

.rotator iframe {
  border:none;
  width:100vw;
  height:100vh;
  background:#000;
}

/* --------- שכבת ה-UI --------- */
.ui-layer {
  position:absolute;
  inset:0;
  pointer-events:none;
  font-family:"Heebo",Arial,sans-serif;
  color:#fff;
}

/* סקורבורד - שמאל למעלה */
.score-overlay-wrapper {
  position:absolute;
  top:12px;
  left:8px;
  z-index:100;
  pointer-events:auto;
  display:flex;
  flex-direction:row;
  align-items:center;
  font-size:0.8rem;
  font-weight:600;
  line-height:1.2;
  font-family:"Heebo",Arial,sans-serif;
}

.score-box {
  display:flex;
  align-items:center;
  background:#1a1446;
  border-radius:4px;
  box-shadow:0 4px 12px rgba(0,0,0,0.8);
  overflow:hidden;
  border:1px solid rgba(0,0,0,0.6);
  direction:ltr;
}

.team-label {
  color:#fff;
  padding:4px 8px;
  font-size:0.8rem;
  max-width:32vw;
  white-space:nowrap;
  text-overflow:ellipsis;
  overflow:hidden;
  background:#1a1446;
}

.team-score-block {
  background:#f4dd3a;
  color:#000;
  padding:4px 6px;
  font-weight:700;
  min-width:24px;
  text-align:center;
  font-family:"Roboto Mono","Courier New",monospace;
  font-size:0.8rem;
  border-left:1px solid rgba(0,0,0,0.4);
  border-right:1px solid rgba(0,0,0,0.4);
}

.timer-block {
  background:#ffffff;
  color:#000000;
  font-weight:700;
  padding:4px 8px;
  min-width:50px;
  text-align:center;
  font-family:"Roboto Mono","Courier New",monospace;
  font-size:0.8rem;
  border-left:1px solid rgba(0,0,0,0.4);
  border-right:1px solid rgba(0,0,0,0.4);
}

/* אזור ימין למעלה: לוגו + רענון + גרסה + דיבאג */
.top-right-cluster {
  position:absolute;
  top:8px;
  right:8px;
  z-index:200;
  display:flex;
  flex-direction:row;
  align-items:flex-start;
  gap:8px;
  pointer-events:auto;
  font-family:"Heebo",Arial,sans-serif;
  color:#fff;
}

/* לוגו לחיץ */
.channel-logo-wrap {
  position:relative;
  display:flex;
  flex-direction:column;
  align-items:center;
}
.channel-logo {
  width:52px;
  height:52px;
  border-radius:50%;
  border:2px solid rgba(255,255,255,0.4);
  box-shadow:0 0 10px rgba(0,0,0,0.7);
  cursor:pointer;
  object-fit:cover;
  background:#000;
}
.version-tag {
  margin-top:4px;
  font-size:0.65rem;
  font-weight:600;
  color:#00ffa9;
  text-shadow:0 0 6px rgba(0,255,169,0.6);
  font-family:"Heebo",Arial,sans-serif;
  line-height:1.1;
  text-align:center;
}

/* DEBUG BOX */
.debug-info {
  margin-top:4px;
  min-width:80px;
  max-width:140px;
  font-size:0.6rem;
  line-height:1.2;
  font-weight:500;
  font-family:"Roboto Mono","Courier New",monospace;
  background:rgba(0,0,0,0.6);
  border:1px solid rgba(0,255,169,0.4);
  box-shadow:0 0 6px rgba(0,255,169,0.4);
  border-radius:6px;
  padding:4px 6px;
  color:#00ffa9;
  white-space:pre-line;
  text-align:center;
}
.debug-error {
  color:#ff4a4a;
}

/* כפתור רענון קטן */
.refresh-btn-circle {
  width:28px;
  height:28px;
  border-radius:50%;
  background:rgba(0,0,0,0.6);
  border:2px solid rgba(0,255,169,0.6);
  box-shadow:0 0 8px rgba(0,0,0,0.8), 0 0 6px rgba(0,255,169,0.4);
  color:#00ffa9;
  font-size:0.8rem;
  font-weight:600;
  display:flex;
  align-items:center;
  justify-content:center;
  line-height:1;
  cursor:pointer;
  user-select:none;
  font-family:"Heebo",Arial,sans-serif;
}
.refresh-btn-circle:active {
  transform:scale(0.95);
}

/* כפתור מסך מלא */
.fullscreen-btn {
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  z-index:200;
  background:rgba(0,0,0,0.55);
  color:#00ffa9;
  border:1px solid rgba(0,255,169,0.6);
  border-radius:12px;
  padding:14px 26px;
  font-size:1.2rem;
  font-weight:600;
  cursor:pointer;
  box-shadow:0 8px 24px rgba(0,0,0,0.8);
  pointer-events:auto;
}

/* חלון סיסמה */
.passgate {
  position:absolute;
  top:70px;
  right:50%;
  transform:translateX(50%);
  background:#1a1f2b;
  color:#fff;
  border-radius:12px;
  box-shadow:0 30px 60px rgba(0,0,0,0.9);
  border:1px solid rgba(255,255,255,0.15);
  padding:20px;
  width:260px;
  max-width:90vw;
  font-size:0.9rem;
  line-height:1.5;
  z-index:400;
  text-align:center;
  pointer-events:auto;
  display:none;
}
.passgate input {
  width:100%;
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.2);
  background:#0f1115;
  color:#fff;
  padding:10px 12px;
  font-size:1rem;
  outline:none;
  text-align:center;
  font-family:"Heebo",Arial,sans-serif;
  margin-bottom:12px;
}
.passgate button {
  width:100%;
  padding:10px 12px;
  border:1px solid rgba(0,255,169,0.4);
  background:#0f1115;
  color:#00ffa9;
  border-radius:8px;
  cursor:pointer;
  font-size:1rem;
  font-weight:600;
  text-align:center;
  box-shadow:0 0 10px rgba(0,255,169,0.3);
}
.passgate .err {
  color:#ff4a4a;
  font-size:0.8rem;
  min-height:1em;
  margin-top:6px;
}

/* חלון שליטה (אדמין) */
.edit-popup {
  position:absolute;
  top:70px;
  right:50%;
  transform:translateX(50%);
  background:#1a1f2b;
  color:#fff;
  border-radius:12px;
  box-shadow:0 30px 60px rgba(0,0,0,0.9);
  border:1px solid rgba(255,255,255,0.15);
  padding:20px;
  width:320px;
  max-width:90vw;
  font-size:0.9rem;
  line-height:1.5;
  display:none;
  z-index:300;
  text-align:right;
  pointer-events:auto;
}
.edit-popup h2 {
  font-size:1rem;
  text-align:center;
  margin:0 0 14px;
  color:#fff;
}
.edit-field {
  margin-bottom:14px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.edit-field label {
  font-size:0.8rem;
  color:#9aa3b2;
}
.team-line {
  display:flex;
  gap:8px;
  width:100%;
}
.team-line input {
  flex:1;
}
.score-input {
  flex:0 0 60px;
  max-width:60px;
  text-align:center;
}
.edit-input {
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.2);
  background:#0f1115;
  color:#fff;
  padding:10px 12px;
  font-size:0.9rem;
  outline:none;
  width:100%;
}
.ctl-btn {
  width:100%;
  padding:10px 12px;
  border:1px solid rgba(255,255,255,0.2);
  background:#0f1115;
  color:#fff;
  border-radius:8px;
  cursor:pointer;
  margin-bottom:8px;
  font-size:0.9rem;
  font-weight:600;
  text-align:center;
}
</style>
</head>
<body>

<div class="player-shell" id="videoContainer">

  <!-- וידאו -->
  <div class="video-layer">
    <div class="rotator">
      <iframe id="livePlayer"
        src="https://www.youtube.com/embed/live_stream?channel=UCu2doG-TFmd4b2paosdg1xg&autoplay=1&mute=1&playsinline=1"
        allow="autoplay; encrypted-media; picture-in-picture"
      ></iframe>
    </div>
  </div>

  <!-- UI -->
  <div class="ui-layer">

    <!-- סקורבורד -->
    <div class="score-overlay-wrapper">
      <div class="score-box">
        <div class="team-label" id="teamHome_name">הפועל חיפה</div>
        <div class="team-score-block" id="teamHome_score">0</div>

        <div class="timer-block" id="liveTimer">00:00</div>

        <div class="team-score-block" id="teamAway_score">0</div>
        <div class="team-label" id="teamAway_name">מכבי חיפה</div>
      </div>
    </div>

    <!-- מסך מלא -->
    <button class="fullscreen-btn" id="fullscreenBtn">⛶ מסך מלא</button>

    <!-- למעלה ימין -->
    <div class="top-right-cluster">
      <div class="channel-logo-wrap">
        <img class="channel-logo" id="channelLogo"
          src="https://yt3.ggpht.com/XEIE69D8DP1huYwLhSrHbEPhU9nfLjqSX7P8mZ8NLceUeDX68BoH1ORcxWy-NufREOy9xo1Dkw=s600-c-k-c0x00ffffff-no-rj-rp-mo"
          alt="ערוץ">
        <div class="version-tag" id="versionTag">v1.7</div>
        <div class="debug-info" id="debugBox">
          init...
        </div>
      </div>

      <div class="refresh-btn-circle" id="refreshBtnCircle">↻</div>
    </div>

    <!-- סיסמה -->
    <div class="passgate" id="passGate">
      <div style="font-weight:600; margin-bottom:8px;">כניסה לניהול</div>
      <input id="adminPassInput" type="password" placeholder="הכנס קוד">
      <button id="adminPassBtn">אישור</button>
      <div class="err" id="adminPassErr"></div>
    </div>

    <!-- שליטה -->
    <div class="edit-popup" id="editPopup">
      <h2>שליטה בשידור</h2>

      <div class="edit-field">
        <label>שם הליגה</label>
        <input class="edit-input" id="league_input" value="שידורי חי הפועל חיפה נערים א' 2009">
      </div>

      <div class="edit-field">
        <label>קבוצה ביתית + תוצאה</label>
        <div class="team-line">
          <input id="teamHome_input" class="edit-input" value="הפועל חיפה">
          <input id="scoreHome_input" class="edit-input score-input" type="number" min="0" value="0">
        </div>
      </div>

      <div class="edit-field">
        <label>קבוצה אורחת + תוצאה</label>
        <div class="team-line">
          <input id="teamAway_input" class="edit-input" value="מכבי חיפה">
          <input id="scoreAway_input" class="edit-input score-input" type="number" min="0" value="0">
        </div>
      </div>

      <button class="ctl-btn" id="startBtn">הפעל שעון</button>
      <button class="ctl-btn" id="pauseBtn">הפסקת מחצית / המשך</button>
      <button class="ctl-btn" id="resetBtn">איפוס שעון</button>
      <button class="ctl-btn" id="closePopupBtn">יציאה</button>
    </div>

  </div><!-- /ui-layer -->
</div><!-- /player-shell -->

<script>
// ===== הגדרות JSONBin PUBLIC/PRIVATE =====
// bin ציבורי חדש ל-GET
const BIN_ID_PUBLIC  = "6900b89cae596e708f32e6a5";
// כתובת לקריאה (לכולם, בלי מפתח)
const READ_URL       = `https://api.jsonbin.io/v3/b/${BIN_ID_PUBLIC}?meta=false`;

// אותה כתובת גם לעדכון (PUT), אבל פה רק האדמין ישלח עם מפתח
const WRITE_URL      = `https://api.jsonbin.io/v3/b/${BIN_ID_PUBLIC}`;
const MASTER_KEY     = "$2a$10$hqpd8DlBhDKDlR35sf3JF.Xa9YLAZ5milWTy84TC1qHpEWZpuil3e";

// ===== מצב לוקאלי =====
let isAdmin = false;
let currentData = {
  leagueName: "שידורי חי הפועל חיפה נערים א' 2009",
  homeName: "הפועל חיפה",
  homeScore: 0,
  awayName: "מכבי חיפה",
  awayScore: 0,
  clockRunning: false,
  startTime: 0,
  pausedTotalMs: 0
};

// ===== אלמנטים =====
const debugBox          = document.getElementById("debugBox");
const popup             = document.getElementById('editPopup');
const passGate          = document.getElementById('passGate');
const adminPassInput    = document.getElementById('adminPassInput');
const adminPassBtn      = document.getElementById('adminPassBtn');
const adminPassErr      = document.getElementById('adminPassErr');
const logoBtn           = document.getElementById('channelLogo');
const closeBtn          = document.getElementById('closePopupBtn');
const iframeEl          = document.getElementById('livePlayer');
const refreshCircle     = document.getElementById('refreshBtnCircle');
const videoContainer    = document.getElementById('videoContainer');
const fsBtn             = document.getElementById('fullscreenBtn');

// ===== פונקציות עזר =====
function dlog(msg,isError=false){
  const t = new Date();
  const hh = String(t.getHours()).padStart(2,"0");
  const mm = String(t.getMinutes()).padStart(2,"0");
  const ss = String(t.getSeconds()).padStart(2,"0");
  let line = hh+":"+mm+":"+ss+" "+msg;
  console.log("[DBG]", line);
  if (isError) {
    line = "ERR "+hh+":"+mm+":"+ss+"\n"+msg;
    debugBox.innerHTML = '<span class="debug-error">'+line+'</span>';
  } else {
    debugBox.textContent = line;
  }
}

// ודא שכל המפתחות קיימים
function normalizeData(obj){
  if (typeof obj.leagueName    === "undefined") obj.leagueName    = "";
  if (typeof obj.homeName      === "undefined") obj.homeName      = "";
  if (typeof obj.homeScore     === "undefined") obj.homeScore     = 0;
  if (typeof obj.awayName      === "undefined") obj.awayName      = "";
  if (typeof obj.awayScore     === "undefined") obj.awayScore     = 0;
  if (typeof obj.clockRunning  === "undefined") obj.clockRunning  = false;
  if (typeof obj.startTime     === "undefined") obj.startTime     = 0;
  if (typeof obj.pausedTotalMs === "undefined") obj.pausedTotalMs = 0;
}

// שעון
function fmt(sec){
  const m = Math.floor(sec/60);
  const s = sec % 60;
  return String(m).padStart(2,"0")+":"+String(s).padStart(2,"0");
}
function getDisplaySeconds() {
  const d = currentData;
  if (!d) return 0;
  if (!d.clockRunning || !d.startTime) {
    return Math.floor((d.pausedTotalMs||0)/1000);
  }
  const now = Date.now();
  const totalMs = (d.pausedTotalMs||0) + (now - d.startTime);
  return Math.floor(totalMs/1000);
}

// ציור למסך
function renderScoreboard() {
  document.getElementById("teamHome_name").textContent  = currentData.homeName;
  document.getElementById("teamHome_score").textContent = currentData.homeScore;
  document.getElementById("teamAway_name").textContent  = currentData.awayName;
  document.getElementById("teamAway_score").textContent = currentData.awayScore;
  document.getElementById("liveTimer").textContent      = fmt(getDisplaySeconds());

  if (isAdmin && popup.style.display === "block") {
    document.getElementById("league_input").value      = currentData.leagueName || "";
    document.getElementById("teamHome_input").value    = currentData.homeName  || "";
    document.getElementById("scoreHome_input").value   = currentData.homeScore;
    document.getElementById("teamAway_input").value    = currentData.awayName  || "";
    document.getElementById("scoreAway_input").value   = currentData.awayScore;
  }
}

// שליפת מצב (לכולם, בלי מפתח)
async function fetchState() {
  try {
    const res = await fetch(READ_URL, {
      method: "GET",
      headers: {
        "Content-Type": "application/json"
      }
    });
    if (!res.ok) {
      dlog("fetchState HTTP "+res.status,true);
      return;
    }
    const data = await res.json();
    console.log("[DBG] fetchState data:", data);
    normalizeData(data);
    currentData = data;
    renderScoreboard();
    dlog("lastFetch OK");
  } catch(e) {
    dlog("fetchState err "+e,true);
  }
}

// דחיפת עדכון (רק אדמין, עם מפתח)
async function pushState() {
  if (!isAdmin) return;
  try {
    const res = await fetch(WRITE_URL, {
      method: "PUT",
      headers: {
        "Content-Type":"application/json",
        "X-Master-Key": MASTER_KEY
      },
      body: JSON.stringify(currentData)
    });
    if (!res.ok) {
      dlog("pushState HTTP "+res.status,true);
      return;
    }
    dlog("lastPushOK");
    // מושך מחדש לאימות
    fetchState();
  } catch(e){
    dlog("pushState err "+e,true);
  }
}

// רענון שעון מקומי כל 0.5ש
setInterval(()=>{
  renderScoreboard();
},500);

// פולינג מהשרת כל 1.5ש (זה מה שמסנכרן את כולם)
setInterval(()=>{
  fetchState();
},1500);

// טעינה ראשונה
fetchState();
renderScoreboard();
dlog("init v1.7 ready");

// מסך מלא
fsBtn.addEventListener('click', () => {
  if (!document.fullscreenElement) {
    videoContainer.requestFullscreen().catch(err => {
      alert('לא ניתן לעבור למסך מלא: ' + err.message);
    });
  } else {
    document.exitFullscreen();
  }
});
document.addEventListener('fullscreenchange', () => {
  fsBtn.style.display = document.fullscreenElement ? "none" : "block";
});

// רענון יוטיוב
function forcePlay() {
  if (iframeEl && iframeEl.contentWindow) {
    iframeEl.contentWindow.postMessage(
      '{"event":"command","func":"playVideo","args":""}',
      '*'
    );
  }
}
function refreshLive() {
  const baseUrl = "https://www.youtube.com/embed/live_stream?channel=UCu2doG-TFmd4b2paosdg1xg&autoplay=1&mute=1&playsinline=1";
  iframeEl.src = baseUrl + "&t=" + Date.now();
  setTimeout(forcePlay, 1200);
}
refreshCircle.addEventListener('click', () => {
  refreshLive();
  refreshCircle.style.transition = "transform 0.3s";
  refreshCircle.style.transform = "rotate(-360deg) scale(0.9)";
  setTimeout(()=>{
    refreshCircle.style.transform = "rotate(0deg) scale(1)";
  },300);
});

// כניסה לאדמין
logoBtn.addEventListener('click', () => {
  if (!isAdmin) {
    passGate.style.display = "block";
    adminPassInput.value = "";
    adminPassErr.textContent = "";
  } else {
    togglePopup();
  }
});
adminPassBtn.addEventListener('click', () => {
  const val = adminPassInput.value.trim();
  if (val === "4451") {
    isAdmin = true;
    passGate.style.display = "none";
    popup.style.display = "block";
    fetchState().then(()=>{ renderScoreboard(); });
  } else {
    adminPassErr.textContent = "סיסמה לא נכונה";
  }
});
closeBtn.addEventListener('click', () => {
  popup.style.display = "none";
});
function togglePopup(){
  if (popup.style.display === "block") {
    popup.style.display = "none";
  } else {
    popup.style.display = "block";
    renderScoreboard();
  }
}

// עדכון טקסטים/תוצאות → שלח
function syncFromInputsAndPush() {
  if (!isAdmin) return;
  const li = document.getElementById("league_input");
  const ha = document.getElementById("teamHome_input");
  const hs = document.getElementById("scoreHome_input");
  const aa = document.getElementById("teamAway_input");
  const as = document.getElementById("scoreAway_input");

  currentData.leagueName   = li.value;
  currentData.homeName     = ha.value;
  currentData.homeScore    = parseInt(hs.value||"0",10);
  currentData.awayName     = aa.value;
  currentData.awayScore    = parseInt(as.value||"0",10);

  renderScoreboard();
  pushState();
}

// שליטת שעון
document.getElementById('startBtn').addEventListener('click', () => {
  if (!isAdmin) return;
  currentData.pausedTotalMs = 0;
  currentData.startTime = Date.now();
  currentData.clockRunning = true;
  renderScoreboard();
  pushState();
});

document.getElementById('pauseBtn').addEventListener('click', () => {
  if (!isAdmin) return;
  if (currentData.clockRunning) {
    // עצור
    const now = Date.now();
    const runMs = now - (currentData.startTime || now);
    currentData.pausedTotalMs = (currentData.pausedTotalMs||0) + runMs;
    currentData.clockRunning = false;
    currentData.startTime = 0;
  } else {
    // המשך
    currentData.startTime = Date.now();
    currentData.clockRunning = true;
  }
  renderScoreboard();
  pushState();
});

document.getElementById('resetBtn').addEventListener('click', () => {
  if (!isAdmin) return;
  currentData.clockRunning = false;
  currentData.startTime = 0;
  currentData.pausedTotalMs = 0;
  renderScoreboard();
  pushState();
});

// אירועים על שינוי טקסט/תוצאה
document.getElementById("league_input").addEventListener("change", syncFromInputsAndPush);
document.getElementById("teamHome_input").addEventListener("change", syncFromInputsAndPush);
document.getElementById("scoreHome_input").addEventListener("change", syncFromInputsAndPush);
document.getElementById("teamAway_input").addEventListener("change", syncFromInputsAndPush);
document.getElementById("scoreAway_input").addEventListener("change", syncFromInputsAndPush);
</script>
</body>
</html>
