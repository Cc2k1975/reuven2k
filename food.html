<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>בחירת תפריט משפחתי</title>
<style>
:root {
  --bg-page:#fffaf0;
  --card-bg:#ffffff;
  --border:#e2d7b8;
  --gold:#c59d2f;
  --green:#3c7a4c;
  --green-dark:#2e5f3b;
  --text-main:#333;
  --text-dim:#666;
  --radius:16px;
  --shadow:0 8px 24px rgba(0,0,0,0.12);
  --shadow-inner:0 0 10px rgba(0,0,0,0.08) inset;
  --ok-bg:#2e7d32;
  --err-bg:#a01919;
}

body {
  background:var(--bg-page);
  margin:0;
  font-family:"Heebo",Arial,sans-serif;
  color:var(--text-main);
  display:flex;
  justify-content:center;
  padding:16px;
  text-align:center;
}

.wrap {
  width:100%;
  max-width:600px;
  background:var(--card-bg);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:24px 20px 32px;
  border:2px solid var(--border);
  position:relative;
}

/* כותרת עליונה */
h1 {
  margin:0;
  font-size:28px;
  color:var(--green);
  font-weight:700;
  line-height:1.3;
  text-align:center;
  white-space:nowrap;
}

/* שורת מידע על האירוע */
#welcomeExtra {
  margin-top:8px;
  text-align:center;
  line-height:1.5;
  color:var(--text-main);
  font-size:16px;
  font-weight:500;
  white-space:nowrap;
}

/* פס סטטוס */
#statusBox {
  display:none;
  margin-top:12px;
  font-size:16px;
  font-weight:600;
  color:#fff;
  border-radius:var(--radius);
  padding:10px 14px;
  line-height:1.4;
  text-align:center;
}
#statusBox.ok  { background:var(--ok-bg); }
#statusBox.err { background:var(--err-bg); }

/* כותרות קטגוריה */
.sectionHead {
  font-size:20px;
  font-weight:700;
  color:var(--gold);
  border-bottom:2px solid var(--gold);
  display:inline-block;
  margin:28px 0 8px;
  line-height:1.4;
}

/* בחירות */
select {
  width:100%;
  appearance:none;
  -webkit-appearance:none;
  background:#fff;
  border:2px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow-inner);
  padding:14px;
  font-size:18px;
  font-family:inherit;
  font-weight:500;
  text-align:right;
  color:var(--text-main);
}
select:disabled {
  background:#f3f3f3;
  color:#aaa;
}

/* כפתור שליחה */
button#sendBtn {
  width:100%;
  background:var(--green);
  color:#fff;
  border:0;
  border-radius:var(--radius);
  padding:16px;
  font-size:20px;
  font-weight:700;
  margin-top:28px;
  box-shadow:var(--shadow);
}
button#sendBtn:active { background:var(--green-dark); }
button#sendBtn:disabled {
  background:#999;
  box-shadow:none;
  opacity:0.7;
  cursor:not-allowed;
}

/* popup סיכום */
.popup-bg {
  position:fixed;
  top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,0.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.popup {
  background:var(--bg-page);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  border:2px solid var(--border);
  width:90%;
  max-width:400px;
  padding:24px 20px 28px;
  text-align:center;
  animation:pop .3s ease-out;
}
@keyframes pop {
  from {transform:scale(.8);opacity:0;}
  to   {transform:scale(1);opacity:1;}
}
.popup h2 {
  margin:0 0 8px;
  color:var(--green);
  font-size:22px;
  font-weight:700;
  line-height:1.4;
}
.popup p {
  margin:6px 0;
  font-size:18px;
  color:var(--text-main);
  line-height:1.4;
  font-weight:500;
}
.popup .emoji {
  font-size:22px;
  margin-left:6px;
}
.closeBtn {
  margin-top:20px;
  background:var(--green);
  color:#fff;
  font-size:18px;
  font-weight:700;
  border:0;
  border-radius:var(--radius);
  padding:12px 20px;
  box-shadow:var(--shadow);
  width:100%;
}

/* פוטר */
.footerInfo {
  text-align:center;
  font-size:13px;
  color:var(--text-dim);
  margin-top:28px;
}
</style>
</head>
<body>

<div class="wrap">
  <!-- כותרת משפחה + פרטי מפגש -->
  <h1 id="welcomeTitle">טוען...</h1>
  <div id="welcomeExtra">
    <div id="eventLocationLine"></div>
    <div id="eventDateLine"></div>
  </div>

  <!-- סטטוס מערכת -->
  <div id="statusBox"></div>

  <!-- הטופס (ללא "בחר מה אתה מביא") -->
  <form id="foodForm" style="margin-top:20px;">

    <div class="sectionHead">מנה בשרית</div>
    <select id="meat" required>
      <option disabled selected value=""></option>
    </select>

    <div class="sectionHead">פחמימה</div>
    <select id="carb" required>
      <option disabled selected value=""></option>
    </select>

    <div class="sectionHead">סלט 1</div>
    <select id="salad1" required>
      <option disabled selected value=""></option>
    </select>

    <div class="sectionHead">סלט 2</div>
    <select id="salad2" required>
      <option disabled selected value=""></option>
    </select>

    <div class="sectionHead">שתייה</div>
    <select id="drink" required>
      <option disabled selected value=""></option>
    </select>

    <div class="sectionHead">קינוח</div>
    <select id="dessert" required>
      <option disabled selected value=""></option>
    </select>

    <button id="sendBtn" type="submit">שלח תפריט</button>
  </form>

  <div class="footerInfo">גרסה: v2.6 · food.html</div>
</div>

<!-- פופאפ סיכום -->
<div class="popup-bg" id="popupBG">
  <div class="popup">
    <h2 id="popupTitle"></h2>
    <div id="popupContent"></div>
    <button class="closeBtn" onclick="closePopup()">סגור</button>
  </div>
</div>

<script>
// ===== פרמטרים של JSONBin =====
const BIN_ID      = "68ff447a43b1c97be9844c29";
const MASTER_KEY  = "$2a$10$4rynniEMuvwqg2nDb5KSEe/lAVYp8a7L3xWzp9GsO6n49OfXc3FCO";
const API         = "https://api.jsonbin.io/v3/b";

// DOM refs
const welcomeTitle      = document.getElementById("welcomeTitle");
const eventLocationLine = document.getElementById("eventLocationLine");
const eventDateLine     = document.getElementById("eventDateLine");

const statusBox         = document.getElementById("statusBox");
const formEl            = document.getElementById("foodForm");
const sendBtn           = document.getElementById("sendBtn");

const meat              = document.getElementById("meat");
const carb              = document.getElementById("carb");
const salad1            = document.getElementById("salad1");
const salad2            = document.getElementById("salad2");
const drink             = document.getElementById("drink");
const dessert           = document.getElementById("dessert");

const popupBG        = document.getElementById("popupBG");
const popupTitleEl   = document.getElementById("popupTitle");
const popupContentEl = document.getElementById("popupContent");

// מצב
const urlParams = new URLSearchParams(window.location.search);
let currentCode = (urlParams.get("code") || "").trim();

let familyName    = "";     // "משפחת שיין"
let formOpen      = true;   // האם אפשר למלא
let alreadySent   = false;  // האם הקוד הזה כבר שמר
let menuOptions   = {};     // כל הרשימות הארוכות
let eventLocation = "";     // מיקום
let eventDate     = "";     // תאריך

// ===== עוזרי UI =====
function showStatus(msg, ok){
  statusBox.style.display="block";
  statusBox.className = ok ? "ok" : "err";
  statusBox.textContent = msg;
}

function lockAllSelects(lock){
  [meat,carb,salad1,salad2,drink,dessert].forEach(sel=>{
    sel.disabled = lock;
  });
  sendBtn.disabled = lock;
}

// ממלא <select> ממערך
function fillSelectOptions(selectEl, arr){
  for(const item of arr){
    const opt = document.createElement("option");
    opt.value = item;
    opt.textContent = item;
    selectEl.appendChild(opt);
  }
}

// מכבה אופציות שכבר נתפסו ע"י משפחות אחרות
function disableUsedOptions(usedList){
  const allSelects=[meat,carb,salad1,salad2,drink,dessert];
  allSelects.forEach(sel=>{
    for(const opt of sel.options){
      if(!opt.value) continue;
      if(usedList.includes(opt.textContent)){
        opt.disabled = true;
        opt.style.color = "#aaa";
      }
    }
  });
}

// מציג כותרת + מיקום + תאריך
function renderHeaderInfo(){
  // כותרת משפחה ממורכזת בלי האייקון
  welcomeTitle.textContent = "ברוכים הבאים " + familyName;

  // שורת מיקום
  if(eventLocation){
    eventLocationLine.textContent = "נפגשים ב: " + eventLocation;
  } else {
    eventLocationLine.textContent = "";
  }

  // שורת תאריך
  if(eventDate){
    eventDateLine.textContent = "בתאריך: " + eventDate;
  } else {
    eventDateLine.textContent = "";
  }
}

// ===== טעינת מצב ראשוני =====
async function initData(){
  if(!currentCode){
    welcomeTitle.textContent = "אין קוד זיהוי";
    showStatus("כדי לבחור אתם חייבים להיכנס מהקישור האישי שלכם.", false);
    lockAllSelects(true);
    return;
  }

  try {
    const res = await fetch(`${API}/${BIN_ID}/latest`, {
      headers: { "X-Master-Key": MASTER_KEY }
    });
    const j = await res.json();

    formOpen      = j.record?.formOpen !== false;
    const map     = j.record?.map || {};
    menuOptions   = j.record?.menuOptions || {};
    const allCh   = Array.isArray(j.record?.בחירות) ? j.record.בחירות : [];

    eventLocation = j.record?.eventLocation || "";
    eventDate     = j.record?.eventDate || "";

    // מי אני?
    familyName = map[currentCode] || "";
    if(!familyName){
      welcomeTitle.textContent = "קוד לא מזוהה";
      showStatus("הקוד הזה לא מוכר. דברו איתי.", false);
      lockAllSelects(true);
      return;
    }

    // בנה טקסט כותרת + מקום/תאריך
    renderHeaderInfo();

    // בנה בחירות
    fillSelectOptions(meat,   menuOptions.meat   || []);
    fillSelectOptions(carb,   menuOptions.carb   || []);
    fillSelectOptions(salad1, menuOptions.salad1 || []);
    fillSelectOptions(salad2, menuOptions.salad2 || []);
    fillSelectOptions(drink,  menuOptions.drink  || []);
    fillSelectOptions(dessert,menuOptions.dessert|| []);

    // כל פריט שכבר תפוס ע"י מישהו (כל המשפחות יחד)
    const usedItems=[];
    allCh.forEach(rec=>{
      if(rec.מנה)    usedItems.push(rec.מנה);
      if(rec.פחמימה) usedItems.push(rec.פחמימה);
      if(rec.סלט1)   usedItems.push(rec.סלט1);
      if(rec.סלט2)   usedItems.push(rec.סלט2);
      if(rec.שתייה)  usedItems.push(rec.שתייה);
      if(rec.קינוח)  usedItems.push(rec.קינוח);
    });
    disableUsedOptions(usedItems);

    // האם הקוד הזה כבר שלח?
    const mine = allCh.find(rec => rec.code === currentCode);
    if(mine){
      alreadySent = true;
      showStatus("כבר שלחתם את הבחירה. אם צריך לשנות דברו איתי 🙏", true);
      lockAllSelects(true);
      return;
    }

    // האם כרגע OFFLINE?
    if(!formOpen){
      showStatus("הרישום סגור כרגע. דברו איתי.", false);
      lockAllSelects(true);
      return;
    }

    // הכל פתוח
    lockAllSelects(false);
    showStatus("מלאו את הבחירה שלכם 🙌", true);

  } catch(err){
    console.error(err);
    welcomeTitle.textContent = "שגיאה בטעינה";
    showStatus("שגיאה בטעינת הנתונים. נסו שוב מאוחר יותר.", false);
    lockAllSelects(true);
  }
}
initData();

// ===== שליחה =====
formEl.addEventListener("submit", async (e)=>{
  e.preventDefault();

  if(!currentCode){
    showStatus("קוד לא זוהה, אי אפשר לשלוח.", false);
    return;
  }
  if(!familyName){
    showStatus("קוד לא מוכר, אי אפשר לשלוח.", false);
    return;
  }
  if(alreadySent){
    showStatus("כבר שלחתם. אם צריך לשנות דברו איתי.", false);
    return;
  }
  if(!formOpen){
    showStatus("הרישום סגור כרגע.", false);
    return;
  }

  const oneChoice = {
    "code": currentCode,
    "שם": familyName,
    "מנה": meat.value,
    "פחמימה": carb.value,
    "סלט1": salad1.value,
    "סלט2": salad2.value,
    "שתייה": drink.value,
    "קינוח": dessert.value,
    "ts": new Date().toISOString()
  };

  try {
    // מושך עותק עדכני ישר לפני כתיבה
    const res1 = await fetch(`${API}/${BIN_ID}/latest`, {
      headers: { "X-Master-Key": MASTER_KEY }
    });
    const data1 = await res1.json();

    const existingChoices = Array.isArray(data1.record?.בחירות)
      ? data1.record.בחירות
      : [];

    const stillOpen    = data1.record?.formOpen !== false;
    const latestMap    = data1.record?.map || {};
    const latestMenu   = data1.record?.menuOptions || {};
    const latestLoc    = data1.record?.eventLocation || "";
    const latestDate   = data1.record?.eventDate || "";

    // וידוא שעדיין יש מיפוי לקוד שלי
    if(!latestMap[currentCode]){
      showStatus("הקוד הזה כבר לא פעיל. דברו איתי.", false);
      lockAllSelects(true);
      return;
    }

    // וידוא שלא מילאתי בינתיים
    if(existingChoices.find(rec => rec.code === currentCode)){
      showStatus("כבר שלחתם.", true);
      lockAllSelects(true);
      return;
    }

    // וידוא שהטופס לא נסגר בינתיים
    if(!stillOpen){
      showStatus("הרישום נסגר כרגע.", false);
      lockAllSelects(true);
      return;
    }

    // מוסיף את הבחירה שלי
    existingChoices.push(oneChoice);

    // שומר בחזרה לכל המבנה (כולל לוקיישן ותאריך!)
    const putRes = await fetch(`${API}/${BIN_ID}`, {
      method:"PUT",
      headers:{
        "Content-Type":"application/json",
        "X-Master-Key": MASTER_KEY
      },
      body:JSON.stringify({
        "formOpen": stillOpen,
        "map": latestMap,
        "menuOptions": latestMenu,
        "בחירות": existingChoices,
        "eventLocation": latestLoc,
        "eventDate": latestDate
      })
    });

    if(!putRes.ok){
      showStatus("שמירה נכשלה. נסו שוב.", false);
      return;
    }

    // הצלחה ✔
    alreadySent = true;
    lockAllSelects(true);
    showStatus("הנתונים נשמרו בהצלחה ✅", true);
    showPopup(oneChoice);

  } catch(err){
    console.error(err);
    showStatus("שגיאה בזמן שליחה. נסו שוב.", false);
  }
});

// ===== פופאפ סיכום =====
function showPopup(choice){
  popupTitleEl.textContent = familyName + " – הבחירות שלכם";
  popupContentEl.innerHTML = `
    <p><span class="emoji">🍗</span> מנה: ${choice.מנה}</p>
    <p><span class="emoji">🍚</span> פחמימה: ${choice.פחמימה}</p>
    <p><span class="emoji">🥗</span> סלט 1: ${choice.סלט1}</p>
    <p><span class="emoji">🥗</span> סלט 2: ${choice.סלט2}</p>
    <p><span class="emoji">🥤</span> שתייה: ${choice.שתייה}</p>
    <p><span class="emoji">🍰</span> קינוח: ${choice.קינוח}</p>
  `;
  popupBG.style.display="flex";
}

function closePopup(){
  popupBG.style.display="none";
}
</script>
</body>
</html>
