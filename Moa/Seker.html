<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>טופס סקר</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<style>
  body {
    font-family: Arial, Helvetica, sans-serif;
    background: #000;
    margin: 0;
    padding: 0;
    color: #d4af37;
  }

  .wrap {
    max-width: 520px;
    margin: 12px auto;
    padding: 20px 24px 24px;
    background: #111;
    border-radius: 16px;
    box-shadow: 0 6px 18px rgba(255,215,0,0.25);
  }

  h1 {
    margin: 0 0 16px;
    font-size: 24px;
    color: #ffd700;
    text-align: center;
  }

  label {
    display: block;
    margin: 12px 4px 5px;
    font-weight: 600;
    color: #ffd700;
    font-size: 16px;
  }

  input, select, button {
    width: 100%;
    padding: 12px 14px;
    border: 1px solid #d4af37;
    border-radius: 10px;
    font-size: 16px;
    box-sizing: border-box;
    background: #222;
    color: #ffd700;
  }

  input[type="tel"] {
    text-align: right;
  }

  .btn {
    background: #d4af37;
    color: #000;
    border: 0;
    cursor: pointer;
    margin-top: 20px;
    font-weight: 700;
    font-size: 16px;
  }

  .btn[disabled] {
    opacity: .6;
    cursor: not-allowed;
  }

  .info {
    font-size: 13px;
    color: #bfa76f;
    margin-top: 6px;
    text-align: center;
  }

  .error {
    background: #330000;
    color: #ff6666;
    border: 1px solid #ff9999;
    padding: 9px;
    border-radius: 10px;
    margin-top: 9px;
    display: none;
    font-size: 15px;
  }

  .success {
    background: #003300;
    color: #66ff99;
    border: 1px solid #99ffcc;
    padding: 9px;
    border-radius: 10px;
    margin-top: 9px;
    display: none;
    font-size: 15px;
  }

  .ver {
    margin-top: 16px;
    font-size: 12px;
    color: #bfa76f;
    text-align: center;
  }
</style>
</head>
<body>

<div class="wrap">
  <h1>טופס סקר</h1>

  <div id="msgError" class="error" role="alert"></div>
  <div id="msgOk" class="success" role="status"></div>

  <!-- מחלקה (קומבו) -->
  <label for="dept">מחלקה:</label>
  <select id="dept" required>
    <option value="">בחר מחלקה…</option>
    <option>אווירודינמיקה</option>
    <option>מחמ</option>
    <option>מטה</option>
    <option>ניווט</option>
    <option>בקמ</option>
    <option>טילאות</option>
    <option>סימולציות</option>
  </select>

  <!-- שם העובד -->
  <label for="workerName">שם העובד:</label>
  <input type="text" id="workerName" placeholder="שם מלא" required />

  <!-- מספר נייד -->
  <label for="phone">מספר נייד:</label>
  <input type="tel" id="phone" placeholder="מספר טלפון" required />

  <!-- מבנה -->
  <label for="building">מבנה:</label>
  <input type="text" id="building" placeholder="לדוגמה: מבנה 12" required />

  <!-- קומה -->
  <label for="floor">קומה:</label>
  <input type="text" id="floor" placeholder="לדוגמה: 3" required />

  <!-- מספר חדר -->
  <label for="room">מספר חדר:</label>
  <input type="text" id="room" placeholder="לדוגמה: 305B" required />

  <!-- כמות אריזות (קומבו 1..5) -->
  <label for="packs">כמות אריזות:</label>
  <select id="packs" required>
    <option value="">בחר כמות…</option>
    <option>1</option>
    <option>2</option>
    <option>3</option>
    <option>4</option>
    <option>5</option>
  </select>

  <!-- חדר יעד -->
  <label for="targetRoom">חדר יעד:</label>
  <input type="text" id="targetRoom" placeholder="לאן לשלוח / איפה לקבל" required />

  <button id="sendBtn" class="btn">שלח</button>
  <div id="savingIndicator" class="info" style="display:none;">שומר…</div>

  <div class="ver">גרסה 0.1 – סקר</div>
</div>

<script>
/* =============================
   הגדרות JSONBin (תעדכן בעצמך)
   ============================= */
const BIN_ID = '*** תכניס כאן ***';        // למשל: '68f0e7bed0ea881f40a63b29'
const MASTER_KEY = '*** תכניס כאן ***';    // המפתח של הבין החדש
const BIN_URL = 'https://api.jsonbin.io/v3/b/' + BIN_ID;

/* מבנה שאנחנו שומרים: { answers: [ {...}, {...} ] }
   כל תשובה = אובייקט עם כל השדות שלך + timestamp
*/

const elDept        = document.getElementById('dept');
const elWorkerName  = document.getElementById('workerName');
const elPhone       = document.getElementById('phone');
const elBuilding    = document.getElementById('building');
const elFloor       = document.getElementById('floor');
const elRoom        = document.getElementById('room');
const elPacks       = document.getElementById('packs');
const elTargetRoom  = document.getElementById('targetRoom');
const elSend        = document.getElementById('sendBtn');
const savingIndicator = document.getElementById('savingIndicator');

const msgErr = document.getElementById('msgError');
const msgOk  = document.getElementById('msgOk');

function showErr(t){
  msgErr.textContent = t;
  msgErr.style.display = 'block';
  setTimeout(()=>{ msgErr.style.display='none'; }, 5000);
}
function showOk(t){
  msgOk.textContent = t;
  msgOk.style.display = 'block';
  setTimeout(()=>{ msgOk.style.display='none'; }, 4000);
}

function setSavingState(isSaving){
  elSend.disabled = isSaving;
  savingIndicator.style.display = isSaving ? 'block' : 'none';
}

/* ניקוי לא-ספרות מהטלפון ובדיקה בסיסית */
function normalizePhone(p){ return (p||'').replace(/\D/g,''); }
function validPhone(p){
  const digits = normalizePhone(p);
  return digits.length >= 8;
}

/* שולף את המצב האחרון מהענן */
async function fetchRecord(){
  const r = await fetch(BIN_URL + '?ts=' + Date.now(), {
    headers: { 'X-Master-Key': MASTER_KEY },
    cache: 'no-store'
  });
  if(!r.ok){
    const txt = await r.text().catch(()=> '');
    throw new Error('fetch failed '+r.status+' '+txt);
  }
  const j = await r.json();
  // אם אין answers -> נבנה בסיס
  let rec = (j.record && Array.isArray(j.record.answers)) ? j.record : { answers: [] };
  return rec;
}

/* שומר חזרה לענן */
async function putRecord(rec){
  const r = await fetch(BIN_URL + '?ts=' + Date.now(), {
    method:'PUT',
    headers:{
      'Content-Type':'application/json',
      'X-Master-Key':MASTER_KEY
    },
    body: JSON.stringify(rec),
    cache:'no-store'
  });
  if(!r.ok){
    const txt = await r.text().catch(()=> '');
    throw new Error('put failed '+r.status+' '+txt);
  }
  return r.json().catch(()=> ({}));
}

/* שליחה */
elSend.addEventListener('click', async ()=>{
  // ולידציה בסיסית – כולם שדות חובה
  if(!elDept.value.trim()
    || !elWorkerName.value.trim()
    || !elPhone.value.trim()
    || !elBuilding.value.trim()
    || !elFloor.value.trim()
    || !elRoom.value.trim()
    || !elPacks.value.trim()
    || !elTargetRoom.value.trim()
  ){
    showErr('נא למלא את כל השדות');
    return;
  }

  if(!validPhone(elPhone.value)){
    showErr('מספר נייד לא תקין');
    return;
  }

  const newAnswer = {
    dept:        elDept.value.trim(),
    workerName:  elWorkerName.value.trim(),
    phone:       elPhone.value.trim(),
    building:    elBuilding.value.trim(),
    floor:       elFloor.value.trim(),
    room:        elRoom.value.trim(),
    packs:       elPacks.value.trim(),
    targetRoom:  elTargetRoom.value.trim(),
    ts:          Date.now()
  };

  setSavingState(true);
  try {
    // מושך את כל התשובות האחרונות
    let rec = await fetchRecord();

    // דוחף את הרשומה החדשה
    rec.answers.push(newAnswer);

    // שומר חזרה
    await putRecord(rec);

    showOk('הנתונים נשמרו בהצלחה!');
    // איפוס טופס
    elDept.value="";
    elWorkerName.value="";
    elPhone.value="";
    elBuilding.value="";
    elFloor.value="";
    elRoom.value="";
    elPacks.value="";
    elTargetRoom.value="";
  } catch(e){
    console.error('save error', e);
    showErr('שגיאת רשת או שרת. נסה שוב.');
  } finally {
    setSavingState(false);
  }
});
</script>

</body>
</html>
