<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מכשיר קצה - אבי</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #1a1a1a; color: white; padding: 50px 20px; }
        #status { font-size: 22px; margin-top: 20px; padding: 15px; border-radius: 8px; }
        .waiting { background: #333; }
        .active { background: #28a745; color: white; }
        .ringing { background: #dc3545; animation: blink 0.5s infinite; }
        @keyframes blink { 0% {opacity: 1;} 50% {opacity: 0.5;} 100% {opacity: 1;} }
        button { padding: 20px 40px; font-size: 20px; border-radius: 50px; border: none; background: #ff4757; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(255,71,87,0.4); }
    </style>
</head>
<body>
    <h1>מערכת קבלת קריאות</h1>
    <div id="setup">
        <button onclick="initSystem()">לחץ כאן להפעלת המערכת</button>
        <p>חובה ללחוץ כדי לאפשר צליל</p>
    </div>
    
    <div id="status" class="waiting" style="display:none;">מתחבר לשרת...</div>
    
    <audio id="ringtone" src="https://www.soundjay.com/phone/phone-ringing-01.mp3" preload="auto" loop></audio>

    <script>
        // ההגדרות שלך מהתמונה
        const firebaseConfig = {
            apiKey: "AIzaSyA5g_stbjtOv577cm47scGQ61SI5MbND4g",
            authDomain: "intercom-62434.firebaseapp.com",
            databaseURL: "https://intercom-62434-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "intercom-62434",
            storageBucket: "intercom-62434.firebasestorage.app",
            messagingSenderId: "827508017014",
            appId: "1:827508017014:web:c34e8ed05bc28c2a56dc57"
        };

        const myName = "avi"; // שם המכשיר

        function initSystem() {
            // 1. אתחול פיירבייס
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            
            const audio = document.getElementById('ringtone');
            const statusDiv = document.getElementById('status');
            const setupDiv = document.getElementById('setup');

            // 2. ניסיון ניגון ראשוני (כדי "לפתוח" את הסאונד בדפדפן)
            audio.play().then(() => {
                audio.pause();
                audio.currentTime = 0;
                
                setupDiv.style.display = "none";
                statusDiv.style.display = "block";
                statusDiv.innerText = "המערכת בהאזנה עבור: " + myName;
                statusDiv.className = "active";

                // 3. האזנה לשינויים ב-Database
                const dbRef = firebase.database().ref('calls/' + myName);
                dbRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data && data.action === "ring") {
                        audio.play();
                        statusDiv.innerText = "קריאה נכנסת!!!";
                        statusDiv.className = "ringing";
                        
                        // הפסקת הצלצול אוטומטית אחרי 10 שניות וניקוי הנתונים
                        setTimeout(() => {
                            audio.pause();
                            audio.currentTime = 0;
                            dbRef.set(null); // מוחק את הקריאה מהשרת
                            statusDiv.innerText = "המערכת בהאזנה עבור: " + myName;
                            statusDiv.className = "active";
                        }, 10000);
                    }
                });
            }).catch(err => {
                alert("שגיאה בהפעלת סאונד: " + err);
            });
        }
    </script>
</body>
</html>
