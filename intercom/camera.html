<!DOCTYPE html>
<html lang="he" dir="rtl">
<body>
    <h2>משדר (מצלמה)</h2>
    <video id="v" autoplay playsinline muted style="width:200px; border:1px solid red;"></video>
    <button onclick="start()">הפעל שידור</button>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const config = {
            apiKey: "AIzaSyALAVQSl6FcuF0HYhCfIgVz-GUMSJKcT5c",
            authDomain: "zamir15-intercom.firebaseapp.com",
            projectId: "zamir15-intercom"
        };
        firebase.initializeApp(config);
        const db = firebase.firestore();
        const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });

        async function start() {
            const s = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('v').srcObject = s;
            s.getTracks().forEach(t => pc.addTrack(t, s));

            const doc = db.collection('calls').doc('test');
            pc.onicecandidate = e => e.candidate && doc.collection('o').add(e.candidate.toJSON());

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            await doc.set({ offer: { type: offer.type, sdp: offer.sdp } });

            doc.onSnapshot(snap => {
                const d = snap.data();
                if (d?.answer && !pc.currentRemoteDescription) pc.setRemoteDescription(new RTCSessionDescription(d.answer));
            });
            doc.collection('a').onSnapshot(snap => {
                snap.docChanges().forEach(c => c.type === 'added' && pc.addIceCandidate(new RTCIceCandidate(c.doc.data())));
            });
        }
    </script>
</body>
</html>
