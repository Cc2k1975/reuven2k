<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BUYRU – סריקה בצילום יחיד</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{ --bg:#f7f7f7; --card:#fff; --text:#222; --muted:#666; --pri:#1f7aeb; --radius:12px; --shadow:0 6px 24px rgba(0,0,0,.12); }
  body{font-family:Heebo,system-ui,Arial;background:var(--bg);margin:0;padding:16px;color:var(--text)}
  .wrap{max-width:760px;margin:0 auto}
  h1{font-size:22px;margin:0 0 12px}
  .row{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;align-items:center}
  input[type="text"]{flex:1;min-width:160px;padding:10px;border:1px solid #ccc;border-radius:8px;font-size:16px}
  button{padding:10px 14px;border:0;border-radius:10px;cursor:pointer;font-weight:600}
  .primary{background:var(--pri);color:#fff}
  .ghost{background:#eee}
  .card{margin-top:14px;background:var(--card);border-radius:var(--radius);box-shadow:0 4px 16px rgba(0,0,0,.08);padding:14px}
  .imgbox img{max-width:100%;border-radius:10px}
  .meta{font-size:14px;color:#555;margin-top:8px}
  .links a{display:inline-block;margin:6px 8px 0 0;color:var(--pri);text-decoration:none}
  .small{font-size:12px;color:#777;margin-top:6px}
  .banner{background:#fff3cd;border:1px solid #ffe08a;color:#6b5800;border-radius:10px;padding:10px;margin:10px 0}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;color:#555;white-space:pre-wrap;word-break:break-all}
  .thumb{margin-top:8px;border-radius:10px;box-shadow:var(--shadow);max-height:240px}
  .foot{margin-top:20px;text-align:center;color:#888;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>BUYRU – סריקה בצילום יחיד</h1>

  <div id="httpsWarn" class="banner" style="display:none">
    כדי לצלם יש לעבוד ב-<b>https://</b>. פתח דרך: <a id="httpsLink" href="#">קישור מאובטח</a>
  </div>

  <div class="row">
    <!-- כפתור צילום: פותח מצלמה מובנית בטלפון -->
    <input id="capture" type="file" accept="image/*" capture="environment" style="display:none">
    <button class="primary" id="btnShot">צלם וסרוק</button>
    <button class="ghost" id="btnPick">בחר תמונה מהגלריה</button>
    <input id="manual" type="text" placeholder="או הזן ידנית ברקוד (GTIN/UPC/EAN)..." />
    <button class="ghost" id="btnLookup">חפש תמונה</button>
  </div>

  <div class="card" id="status">מוכן לצילום.</div>

  <img id="thumb" class="thumb" alt="" style="display:none" />

  <div class="card imgbox" id="imgBox" style="display:none">
    <div class="meta" id="codeMeta"></div>
    <img id="imgProduct" alt="תמונת מוצר" />
    <div class="links" id="links"></div>
    <div class="small">
      מקורות: Open Food/Beauty/Products Facts (ציבוריים) ורמי-לוי (POC). ייתכנו חסימות/שינויים.
    </div>
  </div>

  <div class="card"><div class="mono" id="diag"></div></div>
  <div class="foot">v2.0.0 – BUYRU (צילום יחיד, בלי וידאו)</div>
</div>

<!-- ZXing לדיקוד מתוך תמונה כגיבוי -->
<script src="https://unpkg.com/@zxing/browser@0.1.1"></script>
<script>
const statusEl = document.getElementById('status');
const diagEl   = document.getElementById('diag');
const imgBox   = document.getElementById('imgBox');
const imgEl    = document.getElementById('imgProduct');
const codeMeta = document.getElementById('codeMeta');
const linksEl  = document.getElementById('links');
const thumbEl  = document.getElementById('thumb');

const btnShot  = document.getElementById('btnShot');
const btnPick  = document.getElementById('btnPick');
const capture  = document.getElementById('capture');
const manual   = document.getElementById('manual');
const btnLookup= document.getElementById('btnLookup');

const httpsWarn= document.getElementById('httpsWarn');
const httpsLink= document.getElementById('httpsLink');

let lastCode = '';

function setStatus(m){ statusEl.textContent = m; }
function log(m){ diagEl.textContent += (diagEl.textContent?'\n':'') + m; }

(function httpsBanner(){
  const isLocal=/^(localhost|127\.0\.0\.1)$/.test(location.hostname);
  if(location.protocol!=='https:' && !isLocal){
    httpsWarn.style.display='block';
    httpsLink.href='https://' + location.host + location.pathname;
  }
})();

/* ---------- שליפת תמונת מוצר לפי ברקוד (כמו קודם) ---------- */
function gtinToPath(code){ const c=(code||'').replace(/\D/g,''); const p=[]; for(let i=0;i<c.length;i+=3)p.push(c.slice(i,i+3)); return p.join('/'); }
function openFactsCandidates(code){
  const base=['https://images.openfoodfacts.org/images/products/','https://images.openbeautyfacts.org/images/products/','https://images.openproductsfacts.org/images/products/'];
  const path=gtinToPath(code);
  return [`${base[0]}${path}/front.400.jpg`,`${base[0]}${path}/front.jpg`,`${base[1]}${path}/front.400.jpg`,`${base[1]}${path}/front.jpg`,`${base[2]}${path}/front.400.jpg`,`${base[2]}${path}/front.jpg`];
}
function ramiLevyCandidates(code){
  const base=`https://img.rami-levy.co.il/product/${code}`;
  return [`${base}/small.jpg`,`${base}/large.jpg`,`https://www.rami-levy.co.il/_ipx/w_500,f_webp/${base}/small.jpg`,`https://www.rami-levy.co.il/_ipx/w_800,f_webp/${base}/large.jpg`];
}
function firstWorkingImage(urls){ return new Promise(res=>{ let i=0; (function next(){ if(i>=urls.length) return res(null); const url=urls[i++]; const im=new Image(); im.onload=()=>res(url); im.onerror=next; im.src=url+`?t=${Date.now()}`; })(); }); }
async function tryLoadImageFor(code){ return await firstWorkingImage([...openFactsCandidates(code),...ramiLevyCandidates(code)]); }
function a(txt,href){ return `<a target="_blank" rel="noopener" href="${href}">${txt}</a>`; }
async function showByCode(code){
  if(!code) return;
  lastCode = (code||'').trim();
  setStatus(`מחפש תמונה לברקוד: ${lastCode} ...`);
  imgBox.style.display='none'; imgEl.src=''; linksEl.innerHTML='';
  const url = await tryLoadImageFor(lastCode);
  codeMeta.textContent = `ברקוד: ${lastCode}`;
  if(url){ imgEl.src=url; setStatus('נמצאה תמונה.'); } else { setStatus('לא נמצאה תמונה במקורות הנ״ל.'); }
  imgBox.style.display='block';
  linksEl.innerHTML = [
    a('גוגל תמונות', `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(lastCode)}`),
    a('שופרסל', `https://www.shufersal.co.il/online/he/search?text=${encodeURIComponent(lastCode)}`),
    a('רמי לוי', `https://www.rami-levy.co.il/he/Search?search=${encodeURIComponent(lastCode)}`)
  ].join(' ');
}

/* ---------- דיקוד ברקוד מתמונה (צילום/גלריה) ---------- */
async function decodeFromImageBitmap(bitmap){
  // 1) אם יש BarcodeDetector מובנה – הכי יציב
  if('BarcodeDetector' in window){
    try{
      const det = new window.BarcodeDetector({ formats:['ean_13','ean_8','upc_a','upc_e','code_128','code_39','itf','qr_code'] });
      const res = await det.detect(bitmap);
      if(res && res.length) return (res[0].rawValue||'').trim();
    }catch(e){ log('BarcodeDetector error: ' + (e.message||e)); }
  }
  // 2) גיבוי ZXing – דיקוד מתוך אלמנט תמונה
  try{
    // מציירים לקנבס קטן כדי לוודא תאימות
    const cnv = document.createElement('canvas');
    const MAX_W = 1280; const scale = Math.min(1, MAX_W / bitmap.width);
    cnv.width = Math.round(bitmap.width * scale);
    cnv.height= Math.round(bitmap.height * scale);
    const ctx = cnv.getContext('2d');
    ctx.drawImage(bitmap, 0, 0, cnv.width, cnv.height);

    const imgElTemp = new Image();
    imgElTemp.src = cnv.toDataURL('image/png');
    await imgElTemp.decode();

    const reader = new ZXing.BrowserMultiFormatReader();
    const result = await reader.decodeFromImageElement(imgElTemp).catch(()=>null);
    if(result && result.text) return result.text.trim();
  }catch(e){ log('ZXing image decode error: ' + (e.message||e)); }
  return '';
}

async function handleFile(file){
  if(!file){ setStatus('לא נבחר קובץ.'); return; }
  setStatus('טוען תמונה...');
  const url = URL.createObjectURL(file);
  thumbEl.src = url; thumbEl.style.display='block';

  // הופכים ל-ImageBitmap (מהיר)
  let bitmap = null;
  try{ bitmap = await createImageBitmap(file); }
  catch{ // נפילה אחורה: מה-URL
    const img = new Image(); img.src = url; await img.decode();
    const c = document.createElement('canvas'); c.width=img.naturalWidth; c.height=img.naturalHeight;
    c.getContext('2d').drawImage(img,0,0);
    bitmap = await createImageBitmap(c);
  }

  setStatus('מזהה ברקוד מהצילום...');
  const code = await decodeFromImageBitmap(bitmap);
  if(code){
    setStatus('ברקוד זוהה: ' + code);
    await showByCode(code);
  }else{
    setStatus('לא זוהה ברקוד בתמונה. נסה לצלם שוב מקרוב ובפוקוס.');
  }
  // משחררים URL זמני
  setTimeout(()=> URL.revokeObjectURL(url), 2000);
}

/* ---------- אירועים ---------- */
btnShot.addEventListener('click', ()=> { capture.setAttribute('capture','environment'); capture.click(); });
btnPick.addEventListener('click',  ()=> { capture.removeAttribute('capture'); capture.click(); });
capture.addEventListener('change', async (e)=> {
  const file = e.target.files && e.target.files[0];
  handleFile(file);
});
btnLookup.addEventListener('click', ()=> showByCode(manual.value));
manual.addEventListener('keydown', (e)=>{ if(e.key==='Enter') showByCode(manual.value); });

/* ---------- אתחול ---------- */
setStatus('מוכן לצילום – לחץ "צלם וסרוק".');
</script>
</body>
</html>
