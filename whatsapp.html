<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WhatsApp Direct - Fixed</title>
    <style>
        :root { --wa-green: #25D366; --wa-dark: #075E54; }
        body { 
            font-family: system-ui, sans-serif; background-color: #f0f2f5; 
            display: flex; justify-content: center; align-items: center; 
            min-height: 100vh; margin: 0; padding: 15px; 
            user-select: none; -webkit-user-select: none; touch-action: manipulation;
        }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); width: 100%; max-width: 400px; text-align: center; }
        .box { background: #f8f9fa; border: 2px solid #eaebec; border-radius: 12px; padding: 15px; margin-bottom: 15px; text-align: right; }
        .label { font-size: 12px; color: #666; font-weight: bold; }
        .field { font-size: 18px; font-weight: bold; color: var(--wa-dark); min-height: 25px; word-break: break-all; }
        
        .ptt-btn { 
            width: 180px; height: 180px; border-radius: 50%; border: none;
            background-color: #34b7f1; color: white; font-size: 20px; font-weight: bold;
            cursor: pointer; box-shadow: 0 6px 15px rgba(0,0,0,0.2);
            margin: 20px auto; display: block; touch-action: none;
            transition: transform 0.1s; -webkit-tap-highlight-color: transparent;
        }
        .ptt-btn:active { background-color: #ff4b2b; transform: scale(0.95); }

        .btn-paste { width: 100%; padding: 14px; background-color: #6c757d; color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="color: var(--wa-dark); margin-top: 0;">×“×‘×¨ ×•×©×œ×—</h2>
    
    <div class="box">
        <div class="label">××¡×¤×¨ ×™×¢×“:</div>
        <div id="phoneField" class="field">---</div>
    </div>
    
    <div class="box">
        <div class="label">×”×•×“×¢×”:</div>
        <div id="msgField" class="field" style="font-weight: normal;">---</div>
    </div>

    <button class="btn-paste" onclick="pasteFromClipboard()">ğŸ“‹ ×”×“×‘×§ ××¡×¤×¨ ××”×–×™×›×¨×•×Ÿ</button>

    <button id="pttBtn" class="ptt-btn">×œ×—×¥ ×•×”×—×–×§<br>ğŸ¤</button>
    
    <p id="status" style="font-size: 14px; color: #888;">×××•×¨ ××¡×¤×¨ ×•××– ×”×•×“×¢×” ×•×©×—×¨×¨</p>
    
    <button class="btn-paste" style="background:#eee; color:#333; margin-top:10px;" onclick="location.reload()">× ×§×” ×”×›×œ</button>
</div>

<script>
    let recognition;
    let lockedNumber = "";
    let finalMsg = "";

    let finalTranscript = "";
    let isListening = false;

    function init() {
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new Speech();
        recognition.lang = 'he-IL';
        recognition.continuous = true;
        recognition.interimResults = true;

        recognition.onresult = (event) => {
            let interim = "";

            for (let i = event.resultIndex; i < event.results.length; i++) {
                const t = (event.results[i][0].transcript || "").trim();
                if (!t) continue;

                if (event.results[i].isFinal) {
                    finalTranscript += (finalTranscript ? " " : "") + t;
                } else {
                    interim += (interim ? " " : "") + t;
                }
            }

            const latestText = (finalTranscript + " " + interim).trim();
            processText(latestText);
        };

        recognition.onerror = () => {
            isListening = false;
            document.getElementById('status').innerText = "×©×’×™××” ×‘×–×™×”×•×™ ×“×™×‘×•×¨";
        };
    }

    // ××•×¦× ××¡×¤×¨ ×™×©×¨××œ×™ ×‘×ª×•×š ×˜×§×¡×˜, ×’× ×× ×™×© ××§×¤×™×/×¨×•×•×—×™×
    // ×“×•×’×××•×ª: 0587449001 / 058-7449001 / 05 8 744 9001
    function extractIsraeliPhone(text) {
        // ××—×¤×© ××§×˜×¢ ×©××ª×—×™×œ ×‘-0 ×•××– ×¡×¤×¨×•×ª, ×¢× ××¤×©×¨×•×ª ×œ×¨×•×•×—×™×/××§×¤×™× ×‘×™×Ÿ ×”×¡×¤×¨×•×ª
        // ×•××•×•×“× ×©××—×¨×™ × ×™×§×•×™ ×™×© 9-10 ×¡×¤×¨×•×ª (× ×™×™×“ ×œ×¨×•×‘ 10)
        const candidates = text.match(/0[\d\s\-]{7,20}\d/g) || [];
        for (const c of candidates) {
            const digits = c.replace(/\D/g, '');
            if (digits.length === 10 && digits.startsWith('05')) return digits;   // × ×™×™×“
            if (digits.length === 9) return digits;                               // ×§×•×•×™/×—×¨×™×’×™×
        }

        // fallback: ×× ×™×© ×¤×©×•×˜ 10 ×¡×¤×¨×•×ª ×¨×¦×•×£ ××™×¤×©×”×•
        const d = text.replace(/\D/g, '');
        if (d.length >= 10) {
            // ××—×¤×© ×ª×ª-×¨×¦×£ ×©× ×¨××” × ×™×™×“
            const m = d.match(/05\d{8}/);
            if (m) return m[0];
        }
        return "";
    }

    function processText(text) {
        const phoneElem = document.getElementById('phoneField');
        const msgElem = document.getElementById('msgField');

        // 1) ××¡×¤×¨ â€“ × × ×¢×œ ×¤×¢× ××—×ª, ×¨×§ ×× ×–×•×”×” ×‘×¦×•×¨×” ×ª×§×™× ×”
        if (!lockedNumber) {
            const found = extractIsraeliPhone(text);
            if (found) {
                lockedNumber = found;
                phoneElem.innerText = lockedNumber;
            } else {
                // ××¦×™×’ "×¨××–" ×‘×œ×‘×“ ×‘×œ×™ ×œ×”×¨×•×¡ (×œ× ××•×¡×£ ××ª ×›×œ ×”×¡×¤×¨×•×ª ××”×˜×§×¡×˜!)
                phoneElem.innerText = "---";
            }
        }

        // 2) ×”×•×“×¢×” â€“ ××•×¦×™× ××ª ×”××¡×¤×¨ ××”×˜×§×¡×˜ ×•××– ×× ×§×” ×›×œ ×¡×¤×¨×” ×©× ×©××¨×”
        let msg = text;

        if (lockedNumber) {
            // ××•×—×§ ×›×œ ××•×¤×¢ ×©×œ ×”××¡×¤×¨ ×’× ×× × ×××¨ ×¢× ×¨×•×•×—×™×/××§×¤×™×
            const loose = new RegExp(lockedNumber.split('').join('\\D*'), 'g');
            msg = msg.replace(loose, ' ');
        }

        // ×× ×§×” ×¡×¤×¨×•×ª ×œ×—×œ×•×˜×™×Ÿ ×›×“×™ ×©×œ× ×™×™×©××¨×• ×©××¨×™×•×ª ××¡×¤×¨ ×‘×”×•×“×¢×”
        msg = msg.replace(/\d/g, ' ');

        // × ×™×§×•×™ ×ª×•×•×™× ××™×•×ª×¨×™× ×•×¨×•×•×—×™×
        msg = msg.replace(/[^\p{L}\p{N}\s\.\,\!\?\-\u0590-\u05FF]/gu, ' ');
        msg = msg.replace(/\s+/g, ' ').trim();

        msgElem.innerText = msg || "---";
        finalMsg = msg;
    }

    const btn = document.getElementById('pttBtn');

    btn.addEventListener('pointerdown', (e) => {
        e.preventDefault();
        if (!recognition) init();

        lockedNumber = "";
        finalMsg = "";
        finalTranscript = "";
        isListening = true;

        document.getElementById('phoneField').innerText = "---";
        document.getElementById('msgField').innerText = "---";
        document.getElementById('status').innerText = "××§×©×™×‘... ×©×—×¨×¨ ×œ×©×œ×™×—×”";

        try { recognition.start(); } catch(_) {}
    });

    window.addEventListener('pointerup', (e) => {
        if (!recognition || !isListening) return;

        isListening = false;
        try { recognition.stop(); } catch(_) {}

        const num = (lockedNumber || "").replace(/\D/g, '');
        if (num.length >= 9) {
            let cleanNum = num.startsWith('0') ? '972' + num.substring(1) : num;
            window.location.href = `https://wa.me/${cleanNum}?text=${encodeURIComponent(finalMsg)}`;
        } else {
            document.getElementById('status').innerText = "×œ× ×–×•×”×” ××¡×¤×¨";
        }
    });

    async function pasteFromClipboard() {
        try {
            const text = await navigator.clipboard.readText();
            let digits = text.replace(/\D/g, '');
            if (digits.length === 10 && digits.startsWith('05')) {
                lockedNumber = digits;
                document.getElementById('phoneField').innerText = lockedNumber;
                document.getElementById('status').innerText = "××¡×¤×¨ ×”×•×“×‘×§. ×¢×›×©×™×• ×œ×—×¥ ×•×“×‘×¨ ×”×•×“×¢×”.";
            } else {
                alert("×œ× ×–×•×”×” ××¡×¤×¨ × ×™×™×“ ×ª×§×™×Ÿ");
            }
        } catch (e) { alert("××©×¨ ×’×™×©×” ×œ×œ×•×—"); }
    }

    window.oncontextmenu = (e) => { e.preventDefault(); return false; };
</script>
</body>
</html>
