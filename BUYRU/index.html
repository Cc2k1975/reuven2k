<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>BUYRU – סריקה חיה (חלון קטן)</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f172a; --ink:#f8fafc; --muted:#9aa8c7;
    --card:#0b1224; --border:1px solid rgba(255,255,255,.08);
    --accent:#22c55e; --radius:16px; --shadow:0 16px 36px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:Heebo,system-ui,Arial;background:var(--bg);color:var(--ink)}
  .wrap{max-width:740px;margin:0 auto;padding:18px}
  header{display:flex;align-items:center;gap:10px;margin-bottom:12px}
  h1{margin:0;font-size:20px;font-weight:800}
  .panel{background:#0b1630;border:var(--border);border-radius:var(--radius);padding:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{padding:10px 14px;border:0;border-radius:12px;font-weight:800;cursor:pointer}
  .primary{background:linear-gradient(135deg,var(--accent),#38bdf8);color:#062;box-shadow:var(--shadow)}
  .ghost{background:transparent;border:var(--border);color:#dbeafe}
  select{padding:10px 12px;border-radius:12px;border:var(--border);background:#0b1630;color:#e5e7eb}
  .camDock{
    position:relative; width:340px; max-width:100%; aspect-ratio:16/10;
    border-radius:14px; overflow:hidden; border:var(--border); background:#000
  }
  .camDock video{width:100%;height:100%;object-fit:cover}
  .scanLine{
    position:absolute; left:8%; right:8%; top:50%; height:2px; background:rgba(255,255,255,.65);
    transform:translateY(-50%); box-shadow:0 0 12px rgba(255,255,255,.55)
  }
  .grid{display:grid; gap:14px; margin-top:14px}
  @media(min-width:760px){ .grid{grid-template-columns: 1fr 1fr} }
  .shot{background:var(--card);border:var(--border);border-radius:16px;padding:14px}
  .shot img{width:100%;max-height:360px;object-fit:contain;border-radius:12px;background:#000}
  .code{margin-top:10px;font-size:22px;font-weight:900;text-align:center;letter-spacing:1px}
  .hide{display:none!important}
  .note{font-size:12px;color:var(--muted)}
  .foot{margin-top:12px;text-align:center;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <header><h1>BUYRU – סריקה חיה (חלון קטן)</h1></header>

  <div class="panel">
    <button id="btnStart" class="btn primary">הפעל סריקה</button>
    <button id="btnStop" class="btn ghost" disabled>עצור</button>
    <select id="cameraSel" title="מצלמה"></select>
    <button id="btnTorch" class="btn ghost" disabled>פנס כבוי</button>
    <span id="httpsWarn" class="note hide">מצלמה דורשת <b>https://</b> (או localhost)</span>
  </div>

  <div class="grid">
    <div class="shot">
      <div class="camDock" id="camDock">
        <video id="preview" playsinline muted></video>
        <div class="scanLine" id="scanLine"></div>
      </div>
      <div class="note">חלון מצלמה קטן. הזז את הברקוד במרכז הקו הלבן.</div>
    </div>

    <div class="shot" id="resultBox">
      <img id="productImg" alt="תמונת מוצר" class="hide">
      <div id="code" class="code"></div>
    </div>
  </div>

  <footer class="foot">v3.0.0 • חלון מצלמה קטן • מציג רק תמונה ומק״ט</footer>
</div>

<!-- ZXing fallback -->
<script src="https://unpkg.com/@zxing/browser@0.1.1"></script>
<script>
/* ===== אלמנטים ===== */
const btnStart  = document.getElementById('btnStart');
const btnStop   = document.getElementById('btnStop');
const btnTorch  = document.getElementById('btnTorch');
const cameraSel = document.getElementById('cameraSel');
const preview   = document.getElementById('preview');
const codeEl    = document.getElementById('code');
const imgProd   = document.getElementById('productImg');
const httpsWarn = document.getElementById('httpsWarn');
const scanLine  = document.getElementById('scanLine');

let stream = null;
let track = null;
let rafId = null;
let reader = null; // ZXing fallback
let lastCode = '';

/* ===== עזרי HTTPS ===== */
(function(){
  const isLocal=/^(localhost|127\.0\.0\.1)$/.test(location.hostname);
  if(location.protocol!=='https:' && !isLocal){
    httpsWarn.classList.remove('hide');
  }
})();

/* ===== רשימת מצלמות ===== */
async function listVideoInputs(){
  const all = await navigator.mediaDevices.enumerateDevices();
  return all.filter(d => d.kind === 'videoinput');
}
function preferBack(devs){
  const backs = devs.filter(d => /back|rear|environment/i.test(d.label||''));
  return backs.length ? backs[backs.length-1] : devs[0];
}
async function fillCameras(){
  try{
    // בקשה קצרה להרשאה כדי לקבל labels
    const isLocal=/^(localhost|127\.0\.0\.1)$/.test(location.hostname);
    if(location.protocol==='https:' || isLocal){
      await navigator.mediaDevices.getUserMedia({video:true});
    }
  }catch{}
  const devs = await listVideoInputs();
  cameraSel.innerHTML='';
  devs.forEach((d,i)=>{
    const opt=document.createElement('option');
    opt.value=d.deviceId; opt.textContent=(d.label||`camera ${i}`)+(/(back|rear|environment)/i.test(d.label||'')?' (אחורית)':'');
    cameraSel.appendChild(opt);
  });
  const pref = preferBack(devs);
  if(pref) cameraSel.value = pref.deviceId;
}

/* ===== תמונת מוצר לפי מק״ט (Open*Facts + רמי לוי) ===== */
function gtinToPath(code){ const c=(code||'').replace(/\D/g,''); const p=[]; for(let i=0;i<c.length;i+=3)p.push(c.slice(i,i+3)); return p.join('/'); }
function openFactsCandidates(code){
  const base=['https://images.openfoodfacts.org/images/products/','https://images.openbeautyfacts.org/images/products/','https://images.openproductsfacts.org/images/products/'];
  const path=gtinToPath(code);
  return [`${base[0]}${path}/front.400.jpg`,`${base[0]}${path}/front.jpg`,`${base[1]}${path}/front.400.jpg`,`${base[1]}${path}/front.jpg`,`${base[2]}${path}/front.400.jpg`,`${base[2]}${path}/front.jpg`];
}
function ramiLevyCandidates(code){
  const base=`https://img.rami-levy.co.il/product/${code}`;
  return [`${base}/small.jpg`,`${base}/large.jpg`,`https://www.rami-levy.co.il/_ipx/w_500,f_webp/${base}/small.jpg`,`https://www.rami-levy.co.il/_ipx/w_800,f_webp/${base}/large.jpg`];
}
function raceImage(url){
  return new Promise((resolve,reject)=>{
    const im=new Image();
    im.onload=()=>resolve(url); im.onerror=()=>reject(url);
    im.src=url+`?t=${Date.now()}`;
  });
}
async function findImageFast(code){
  const cands=[...openFactsCandidates(code), ...ramiLevyCandidates(code)];
  if (Promise.any){
    try{ return await Promise.any(cands.map(raceImage)); }catch{ return null; }
  }else{
    for (let i=0;i<cands.length;i+=3){
      try{ return await Promise.race(cands.slice(i,i+3).map(raceImage)); }catch{}
    }
    return null;
  }
}

/* ===== התחלה/עצירה ===== */
async function stopScan(){
  if(rafId){ cancelAnimationFrame(rafId); rafId=null; }
  if(reader){ reader.reset(); reader=null; }
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  track=null;
  btnStart.disabled=false; btnStop.disabled=true; btnTorch.disabled=true;
}
async function startScan(){
  await stopScan();
  codeEl.textContent=''; imgProd.classList.add('hide'); imgProd.removeAttribute('src');

  const deviceId = cameraSel.value || undefined;
  const constraints = {
    audio:false,
    video: deviceId ? { deviceId:{exact:deviceId}, width:{ideal:1280}, height:{ideal:720}, focusMode:{ideal:'continuous'} }
                    : { facingMode:{ideal:'environment'}, width:{ideal:1280}, height:{ideal:720}, focusMode:{ideal:'continuous'} }
  };
  try{
    // פותחים סטרים יחיד
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    preview.srcObject = stream;
    track = stream.getVideoTracks()[0] || null;
    btnStart.disabled=true; btnStop.disabled=false;

    // פנס
    try{
      const caps=track?.getCapabilities?.();
      if(caps?.torch){ btnTorch.disabled=false; btnTorch.textContent='פנס כבוי'; } else { btnTorch.disabled=true; }
    }catch{ btnTorch.disabled=true; }

    // זיהוי חי: עדיפות BarcodeDetector; נפילה ל-ZXing אם אין
    if ('BarcodeDetector' in window){
      await liveDetectWithDetector();
    }else{
      await liveDetectWithZXing(deviceId);
    }
  }catch(e){
    alert('כשל בהפעלת מצלמה: ' + (e.name? e.name+' – ':'') + (e.message||e));
    await stopScan();
  }
}

/* ===== פנס ===== */
btnTorch.addEventListener('click', async ()=>{
  if(!track) return;
  try{
    const caps=track.getCapabilities?.();
    if(!caps?.torch) return;
    const cur = track.getSettings?.().torch === true;
    await track.applyConstraints({ advanced:[{ torch: !cur }] });
    btnTorch.textContent = !cur ? 'פנס דלוק' : 'פנס כבוי';
  }catch{}
});

/* ===== זיהוי חי עם BarcodeDetector ===== */
async function liveDetectWithDetector(){
  const det = new window.BarcodeDetector({ formats:['ean_13','ean_8','upc_a','upc_e'] });

  const loop = async () => {
    try{
      // נזהה על רצועה מרכזית צרה – מהיר יותר
      const bmp = await createFrameBandBitmap(preview, 0.22);
      const res = await det.detect(bmp);
      if(res && res.length){
        const code = (res[0].rawValue||'').trim();
        if(code && code !== lastCode){
          await onCodeDetected(code);
          return; // עצירה אחרי זיהוי
        }
      }
    }catch{}
    rafId = requestAnimationFrame(loop);
  };
  rafId = requestAnimationFrame(loop);
}

/* יצירת ביטמאפ של רצועה אופקית מרכזית מהווידאו */
async function createFrameBandBitmap(video, bandRatio=0.22){
  const w = video.videoWidth || 1280;
  const h = video.videoHeight|| 720;
  const bandH = Math.max(40, Math.round(h * bandRatio));
  const y = Math.round((h - bandH)/2);
  const cnv = document.createElement('canvas');
  cnv.width = w; cnv.height = bandH;
  const ctx = cnv.getContext('2d', { willReadFrequently:true });
  ctx.drawImage(video, 0, y, w, bandH, 0, 0, w, bandH);
  return await createImageBitmap(cnv);
}

/* ===== זיהוי חי עם ZXing (fallback) ===== */
async function liveDetectWithZXing(deviceId){
  reader = new ZXing.BrowserMultiFormatReader();
  await reader.decodeFromConstraints(
    { audio:false, video: deviceId ? {deviceId:{exact:deviceId}} : {facingMode:{ideal:'environment'}} },
    preview,
    (result)=>{ if(result){ const code=(result.text||'').trim(); if(code) onCodeDetected(code); } }
  );
}

/* ===== בעת זיהוי מק״ט ===== */
async function onCodeDetected(code){
  lastCode = code;
  codeEl.textContent = code;

  // עוצרים סריקה ומכבּים מצלמה כדי לפנות משאבים
  await stopScan();

  // טוענים תמונת מוצר (הראשונה שמצליחה)
  const url = await findImageFast(code);
  if(url){ imgProd.src = url; imgProd.classList.remove('hide'); }
}

/* ===== אירועים ===== */
btnStart.addEventListener('click', startScan);
btnStop .addEventListener('click', stopScan);
cameraSel.addEventListener('change', async ()=>{
  if(!btnStop.disabled){ await startScan(); } // אם רץ – הפעלה מחדש עם המצלמה החדשה
});

/* ===== אתחול ===== */
fillCameras();

/* ===== פס סריקה קטן – אפקט אנימציה קל ===== */
(function animateScanLine(){
  let t=0;
  const anim = ()=>{
    t+=0.02; const amp=6; scanLine.style.top = `calc(50% + ${Math.sin(t)*amp}px)`;
    requestAnimationFrame(anim);
  };
  anim();
})();
</script>
</body>
</html>
