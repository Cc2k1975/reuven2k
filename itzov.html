<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>×¤×Ÿ ××§×¡×¤×¨×¡ - ×”×’×¨×¡×” ×”×¡×•×¤×™×ª</title>
    <style>
        :root { --primary: #ff6b81; --bg: #f8f9fa; --purple: #6c5ce7; }
        body { font-family: system-ui, sans-serif; text-align: center; background-color: var(--bg); margin: 0; padding: 10px; }
        .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); padding-bottom: 50px; }

        /* ××–×•×¨ ××¦×œ××” ×—×™×” */
        #camContainer { width: 100%; aspect-ratio: 3/4; background: #000; position: relative; border-radius: 20px; overflow: hidden; display: none; margin-bottom: 15px; }
        #videoLive { width: 100%; height: 100%; object-fit: cover; }
        .yellow-line { position: absolute; top: 25%; left: 0; width: 100%; height: 4px; background: yellow; box-shadow: 0 0 15px yellow; z-index: 10; }

        .upload-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .box { border: 2px dashed #ddd; border-radius: 15px; height: 120px; display: flex; align-items: center; justify-content: center; position: relative; background: #fafafa; overflow: hidden; }
        img.prev { width: 100%; height: 100%; object-fit: contain; position: absolute; }

        button { background: var(--purple); color: white; border: none; padding: 15px; font-size: 18px; border-radius: 15px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 10px; }
        .snap-btn { background: var(--primary); margin-top: 5px; }
        .fallback-btn { background: #555; font-size: 14px; }

        #status { font-weight: bold; color: var(--primary); margin: 15px 0; }
        video#finalVid { width: 100%; border-radius: 15px; display: none; margin-top: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        .save-btn { background: #2ed573; text-decoration: none; display: none; padding: 18px; border-radius: 50px; color: white; font-weight: bold; margin-top: 15px; }

        /* ×›×œ×™ ×›×™×•×•× ×•×Ÿ ×™×“× ×™ (×œ××§×¨×” ×©×”×¦×™×œ×•× ×œ× ×™×¦× ×‘×•×œ) */
        #adjustArea { display: none; border: 2px solid var(--purple); border-radius: 15px; overflow: hidden; background: #000; margin-top: 15px; touch-action: none; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="margin-bottom:5px;">âœ¨ ×¤×Ÿ ××§×¡×¤×¨×¡ âœ¨</h2>
    <p style="font-size: 12px; color: #666; margin-bottom: 15px;">×¦×™×œ×•× ×¢× ×›×•×•× ×ª ×¦×”×•×‘×” ×œ×”×ª×××” ××•×©×œ××ª</p>

    <div id="camContainer">
        <video id="videoLive" autoplay playsinline muted></video>
        <div class="yellow-line"></div>
    </div>

    <div class="upload-grid">
        <div class="box" id="boxB"><span>×œ×¤× ×™</span><img id="imgB" class="prev"></div>
        <div class="box" id="boxA"><span>××—×¨×™</span><img id="imgA" class="prev"></div>
    </div>

    <div id="ui-capture">
        <button id="btnOpenCam">×¤×ª×— ××¦×œ××” ×¢× ×¤×¡ ×¦×”×•×‘ ğŸ“¸</button>
        <button id="btnSnap" class="snap-btn" style="display:none">×œ×—×™×¦×” ×œ×¦×™×œ×•× ğŸ“¸</button>
        <div style="margin-top:10px">
            <label id="fallbackLabel" style="font-size:12px; color:#888; display:none;">×”××¦×œ××” ×œ× × ×¤×ª×—×ª? ×”×©×ª××© ×‘××¦×œ××” ×”×¨×’×™×œ×”:</label>
            <button id="btnFallback" class="fallback-btn" style="display:none" onclick="document.getElementById('fileIn').click()">××¦×œ××” ×¨×’×™×œ×” (×œ×œ× ×¤×¡)</button>

            <!-- ×©×™× ×•×™ ×§×˜×Ÿ: capture=environment ×›×“×™ ×œ×›×•×•×Ÿ ××—×•×¨×™×ª -->
            <input type="file" id="fileIn" accept="image/*" capture="environment" style="display:none">
        </div>
    </div>

    <div id="adjustArea">
        <p style="color:white; font-size:12px; margin:5px;">×›×•×•×Ÿ ××ª ×”×§×•×“×§×•×“ ×œ×¤×¡ ×”×¦×”×•×‘ ğŸ‘†</p>
        <canvas id="adjustCanvas" style="width:100%; display:block;"></canvas>
    </div>

    <button id="btnCreate" style="display:none; background:#2ed573;">×¦×•×¨ ×¡×¨×˜×•×Ÿ ×××•×ª×’ ğŸ¬</button>

    <div id="status"></div>
    <video id="finalVid" controls playsinline loop muted></video>
    <a id="btnDownload" class="save-btn">×©××™×¨×” ×œ×’×œ×¨×™×” â¬‡ï¸</a>
</div>

<script>
    const video = document.getElementById('videoLive');
    const camContainer = document.getElementById('camContainer');
    const btnOpen = document.getElementById('btnOpenCam');
    const btnSnap = document.getElementById('btnSnap');
    const btnCreate = document.getElementById('btnCreate');
    const fileIn = document.getElementById('fileIn');
    const adjustArea = document.getElementById('adjustArea');
    const adjustCanvas = document.getElementById('adjustCanvas');
    const statusEl = document.getElementById('status');

    let beforeImg = new Image(), afterImg = new Image();
    let mode = 'before';
    let offsetX = 0, offsetY = 0;

    let liveStream = null;

    function showFallbackUI(msg) {
        if (msg) statusEl.innerText = msg;
        document.getElementById('fallbackLabel').style.display = 'block';
        document.getElementById('btnFallback').style.display = 'block';
    }

    function stopLiveCamera() {
        try {
            if (liveStream) {
                liveStream.getTracks().forEach(t => t.stop());
                liveStream = null;
            }
            video.srcObject = null;
        } catch {}
    }

    async function openLiveCamera() {
        // ××¦×œ××” ×—×™×” ×¢×•×‘×“×ª ×¨×§ ×‘-Secure Context (HTTPS ××• localhost)
        if (!window.isSecureContext) {
            showFallbackUI("â„¹ï¸ ××¦×œ××” ×—×™×” × ×—×¡××ª ×‘×œ×™ HTTPS. ×”×©×ª××© ×‘××¦×œ××” ×”×¨×’×™×œ×”.");
            document.getElementById('btnFallback').click();
            return;
        }

        // × ×™×¡×™×•×Ÿ 1: ××™×œ×•×¦×™× "××—×•×¨×™×ª" + ××™×›×•×ª
        const c1 = { video: { facingMode: { ideal: "environment" }, width: { ideal: 1280 }, height: { ideal: 720 } }, audio: false };
        // × ×™×¡×™×•×Ÿ 2: ×¨×§ ×•×™×“××• (×œ××›×©×™×¨×™× ×‘×¢×™×™×ª×™×™×)
        const c2 = { video: true, audio: false };

        try {
            stopLiveCamera();
            liveStream = await navigator.mediaDevices.getUserMedia(c1);
        } catch (e1) {
            try {
                stopLiveCamera();
                liveStream = await navigator.mediaDevices.getUserMedia(c2);
            } catch (e2) {
                // ×¤×” ×œ×¨×•×‘ ×–×”: NotAllowedError / SecurityError / NotFoundError
                const name = (e2 && e2.name) ? e2.name : "CameraError";
                let msg = "×”××¦×œ××” ×”×—×™×” ×—×¡×•××” ×‘××›×©×™×¨ ×”×–×”. ×”×©×ª××© ×‘××¦×œ××” ×”×¨×’×™×œ×”.";
                if (name === "NotAllowedError" || name === "SecurityError") {
                    msg = "××™×Ÿ ×’×™×©×” ×œ××¦×œ××” ×—×™×” (×œ×¨×•×‘ ×‘×’×œ×œ ×“×¤×“×¤×Ÿ ×¤× ×™××™/×œ× HTTPS). ×¢×•×‘×¨ ×œ××¦×œ××” ×”×¨×’×™×œ×”.";
                } else if (name === "NotFoundError") {
                    msg = "×œ× × ××¦××” ××¦×œ××” ×–××™× ×”. ×¢×•×‘×¨ ×œ××¦×œ××” ×”×¨×’×™×œ×”.";
                }
                alert(msg);
                showFallbackUI("ğŸ“· ×¢×‘×¨×ª ×œ××¦×œ××” ×¨×’×™×œ×”.");
                document.getElementById('btnFallback').click();
                return;
            }
        }

        video.srcObject = liveStream;

        // ×—×©×•×‘: ×œ×¤×¢××™× ×—×™×™×‘×™× play ××¤×•×¨×© ××—×¨×™ ×”×¦××“×”
        try { await video.play(); } catch {}

        camContainer.style.display = 'block';
        btnSnap.style.display = 'block';
        btnOpen.style.display = 'none';
        showFallbackUI(""); // ××¦×™×’ ×’× ××ª ×›×¤×ª×•×¨ ×”-fallback ×›×’×™×‘×•×™
        statusEl.innerText = "âœ… ××¦×œ××” ×—×™×” ×¤×ª×•×—×”. ×œ×—×¥ ×œ×¦×™×œ×•×.";
    }

    // ×¤×ª×™×—×ª ××¦×œ××” ×—×™×”
    btnOpen.onclick = () => openLiveCamera();

    // ×¦×™×œ×•× ××”×•×•×™×“××•
    btnSnap.onclick = () => {
        if (!video.videoWidth || !video.videoHeight) {
            alert("×”××¦×œ××” ×¢×“×™×™×Ÿ ×œ× ××•×›× ×”. × ×¡×” ×©×•×‘ ×‘×¢×•×“ ×©× ×™×™×”.");
            return;
        }
        const c = document.createElement('canvas');
        c.width = video.videoWidth; c.height = video.videoHeight;
        c.getContext('2d').drawImage(video, 0, 0);
        const data = c.toDataURL('image/jpeg', 0.92);
        processPhoto(data);
    };

    // ×¦×™×œ×•× ×××¦×œ××” ×¨×’×™×œ×” (Fallback)
    fileIn.onchange = (e) => {
        const f = e.target.files && e.target.files[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = (ev) => processPhoto(ev.target.result);
        reader.readAsDataURL(f);
        // ×××¤×©×¨ ×œ×‘×—×•×¨ ×©×•×‘ ××•×ª×• ×§×•×‘×¥ ×× ×¦×¨×™×š
        e.target.value = "";
    };

    function processPhoto(data) {
        if (mode === 'before') {
            beforeImg = new Image();
            beforeImg.onload = () => {
                document.getElementById('imgB').src = data;
                mode = 'after';
                statusEl.innerText = "××¢×•×œ×”! ×¢×›×©×™×• ×¦×œ× ××ª ×”'××—×¨×™'";
            };
            beforeImg.src = data;
        } else {
            afterImg = new Image();
            afterImg.onload = () => {
                document.getElementById('imgA').src = data;

                // ×¡×•×’×¨ ××¦×œ××” ×—×™×” ×× ×¤×ª×•×—×”
                stopLiveCamera();

                camContainer.style.display = 'none';
                btnSnap.style.display = 'none';
                document.getElementById('ui-capture').style.display = 'none';
                initAdjust();
            };
            afterImg.src = data;
        }
    }

    function initAdjust() {
        adjustArea.style.display = 'block';
        btnCreate.style.display = 'block';

        // ××•×•×“× ×©×”×§× ×‘×¡ × ×‘× ×” ×œ×¤×™ BEFORE (×›××• ×©×”×™×” ××¦×œ×š)
        adjustCanvas.width = beforeImg.naturalWidth || beforeImg.width;
        adjustCanvas.height = beforeImg.naturalHeight || beforeImg.height;

        offsetX = 0; offsetY = 0;
        drawAdjust();
    }

    function drawAdjust() {
        const ctx = adjustCanvas.getContext('2d');
        const w = adjustCanvas.width, h = adjustCanvas.height;
        ctx.clearRect(0,0,w,h);

        ctx.globalAlpha = 1;
        ctx.drawImage(beforeImg, 0, 0, w, h);

        ctx.globalAlpha = 0.5;
        ctx.drawImage(afterImg, offsetX, offsetY, w, h);

        ctx.globalAlpha = 1;
        ctx.strokeStyle = "yellow";
        ctx.lineWidth = 10;
        ctx.beginPath();
        ctx.moveTo(0, h*0.25);
        ctx.lineTo(w, h*0.25);
        ctx.stroke();
    }

    // ×’×¨×™×¨×” ×œ×ª×™×§×•×Ÿ (×¨×§ Y ×›××• ×©×”×™×” ××¦×œ×š)
    let isDrag = false, startY;
    adjustCanvas.ontouchstart = (e) => { isDrag = true; startY = e.touches[0].clientY - offsetY; };
    adjustCanvas.ontouchmove = (e) => { if(!isDrag) return; offsetY = e.touches[0].clientY - startY; drawAdjust(); };
    adjustCanvas.ontouchend = () => isDrag = false;

    function pickSupportedMime() {
        // MP4 ×›××¢×˜ ×ª××™×“ ×‘×¢×™×™×ª×™ ×‘×“×¤×“×¤× ×™×. ×‘×•×—×¨×™× ××•×˜×•××˜×™×ª ××©×”×• × ×ª××š.
        const candidates = [
            'video/webm;codecs=vp9',
            'video/webm;codecs=vp8',
            'video/webm',
            'video/mp4' // ×¨×§ ×× ×××© × ×ª××š
        ];
        for (const c of candidates) {
            if (window.MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(c)) return c;
        }
        return ''; // ×™×™×ª×Ÿ ×œ×“×¤×“×¤×Ÿ ×œ×‘×—×•×¨ ×‘×¨×™×¨×ª ××—×“×œ
    }

    // ×™×¦×™×¨×ª ×•×™×“××•
    btnCreate.onclick = () => {
        statusEl.innerText = "â³ ××™×™×¦×¨ ×¡×¨×˜×•×Ÿ... ×œ× ×œ×¦××ª";
        btnCreate.disabled = true;

        const vCanvas = document.createElement('canvas');
        const vCtx = vCanvas.getContext('2d');

        const w = beforeImg.naturalWidth || beforeImg.width;
        const h = beforeImg.naturalHeight || beforeImg.height;
        vCanvas.width = w; vCanvas.height = h;

        const stream = vCanvas.captureStream(30);
        const mimeType = pickSupportedMime();

        let recorder;
        try {
            recorder = mimeType
                ? new MediaRecorder(stream, { mimeType, videoBitsPerSecond: 6000000 })
                : new MediaRecorder(stream, { videoBitsPerSecond: 6000000 });
        } catch (e) {
            alert("×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘×”×§×œ×˜×ª ×•×™×“××• ×›××Ÿ. ×× ×ª×¨×¦×”, × ×¢×‘×•×¨ ×œ×™×¦×™×¨×ª ×ª××•× ×ª '×œ×¤× ×™/××—×¨×™' ×‘××§×•× ×¡×¨×˜×•×Ÿ.");
            btnCreate.disabled = false;
            statusEl.innerText = "âŒ ××™×Ÿ ×ª××™×›×” ×‘×”×§×œ×˜×ª ×•×™×“××• ×‘××›×©×™×¨ ×”×–×”.";
            return;
        }

        const chunks = [];
        recorder.ondataavailable = e => { if (e.data && e.data.size) chunks.push(e.data); };
        recorder.onstop = () => {
            const finalType = (mimeType && mimeType.includes('mp4')) ? 'video/mp4' : 'video/webm';
            const blob = new Blob(chunks, { type: finalType });
            const url = URL.createObjectURL(blob);

            const finalVid = document.getElementById('finalVid');
            finalVid.src = url;
            finalVid.style.display = 'block';

            const btnDownload = document.getElementById('btnDownload');
            btnDownload.href = url;
            btnDownload.download = finalType === 'video/mp4' ? 'Express_Hair.mp4' : 'Express_Hair.webm';
            btnDownload.style.display = 'block';

            statusEl.innerText = "âœ… ××•×›×Ÿ!";
        };

        recorder.start();

        const start = Date.now();
        const dur = 8000;

        function render() {
            const elapsed = Date.now() - start;
            if (elapsed >= dur) { recorder.stop(); return; }

            vCtx.clearRect(0,0,w,h);

            let op = 1;
            if (elapsed < 2000) op = 1;
            else if (elapsed < 5000) op = 1 - (elapsed - 2000) / 3000;
            else op = 0;

            vCtx.globalAlpha = 1;
            vCtx.drawImage(afterImg, offsetX, offsetY, w, h);

            vCtx.globalAlpha = op;
            vCtx.drawImage(beforeImg, 0, 0, w, h);

            // ×—×•×ª××ª ××•×ª×’
            vCtx.globalAlpha = 1;
            const fs = w * 0.06;
            vCtx.font = `900 ${fs}px system-ui`;
            vCtx.textAlign = "center";
            const txt = "×¤×Ÿ ××§×¡×¤×¨×¡ 0507449001";

            vCtx.strokeStyle = "white";
            vCtx.lineWidth = fs * 0.2;
            vCtx.strokeText(txt, w/2, h * 0.95);

            vCtx.fillStyle = "#ff0000";
            vCtx.fillText(txt, w/2, h * 0.95);

            vCtx.fillStyle = "white";
            vCtx.shadowBlur = 10;
            vCtx.shadowColor = "black";
            vCtx.fillText(op > 0.5 ? "×œ×¤× ×™" : "××—×¨×™ âœ¨", w/2, h * 0.1);
            vCtx.shadowBlur = 0;

            requestAnimationFrame(render);
        }
        render();
    };

    // ×‘×˜×™×—×•×ª: ×›×©×¢×•×–×‘×™× ×“×£, ×œ×¡×’×•×¨ ××¦×œ××”
    window.addEventListener('pagehide', stopLiveCamera);
</script>
</body>
</html>
