<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>מועדפים</title>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1115; --card:#171a21; --card-2:#1b2030;
      --text:#e8ebf1; --muted:#9aa3b2; --accent:#7aa2ff; --accent-2:#4dd6c1;
      --ring: rgba(122,162,255,0.35); --danger:#ff6b6b;
      --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 80% -10%, #1b2233 0%, #0f1115 55%) fixed;
      color:var(--text);
      font-family:"Heebo",sans-serif;
    }
    .wrap{max-width:1000px;margin:auto;padding:18px 12px 120px;}
    header{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
    .logo{
      width:38px;height:38px;border-radius:10px;
      background: conic-gradient(from 210deg, var(--accent), var(--accent-2));
      display:grid;place-items:center;box-shadow: var(--shadow);
    }
    .logo svg{width:22px;height:22px;}
    h1{margin:0;font-size:20px;font-weight:800;letter-spacing:.2px}

    /* === GRID: תמיד 4 בעמודה === */
    .grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      margin:12px 0 24px;
    }

    /* אנימציית כניסה */
    @keyframes fadeUp {
      from { opacity:0; transform: translateY(10px); }
      to   { opacity:1; transform: translateY(0); }
    }

    /* CARD קומפקטי לנייד */
    .card{
      background: linear-gradient(180deg, var(--card), var(--card-2));
      border-radius: var(--radius);
      padding:14px 10px;
      text-align:center;
      border:1px solid rgba(255,255,255,0.06);
      box-shadow: var(--shadow);
      transition: transform .18s, border-color .18s, box-shadow .18s;
      position: relative;
      opacity:0; transform: translateY(10px); /* מצב לפני אנימציה */
    }
    .card.appear{
      animation: fadeUp .45s ease forwards;
    }
    .card:hover{ transform: translateY(-2px); border-color: rgba(122,162,255,.22); box-shadow: 0 16px 36px rgba(0,0,0,.48) }

    /* אייקון קטן יותר */
    .fav{
      width:46px;height:46px;border-radius:16px;
      margin:0 auto 10px;
      background: linear-gradient(135deg, rgba(122,162,255,.15), rgba(77,214,193,.12));
      display:grid;place-items:center;border:1px solid rgba(255,255,255,.06);
    }
    .fav img{width:28px;height:28px}

    /* כפתור פתח קישור ממורכז */
    .card a.open{
      display:inline-block;width:100%;
      font-size:12.5px;font-weight:700;
      padding:9px 10px;border-radius:12px;text-decoration:none;color:var(--text);
      background: linear-gradient(135deg, rgba(122,162,255,.18), rgba(77,214,193,.18));
      border:1px solid rgba(255,255,255,.10);
      transition:transform .15s, border-color .15s, background .15s;
    }
    .card a.open:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.24) }

    /* פקדי עריכה/מחיקה קטנים */
    .actions{
      position:absolute; top:6px; inset-inline-start:6px; display:flex; gap:6px; z-index:2;
    }
    .iconbtn{
      width:26px;height:26px;border-radius:8px;border:1px solid rgba(255,255,255,.10);
      background:#0d0f14aa;color:var(--text);display:grid;place-items:center;cursor:pointer;
      transition:transform .12s, border-color .12s, background .12s;
      font-size:0;
    }
    .iconbtn:hover{ transform:translateY(-1px); border-color: rgba(255,255,255,.22); background:#11141b; }
    .iconbtn svg{width:14px;height:14px;opacity:.9}

    /* סרגל תחתון – מותאם לנייד */
    .bar{
      position:fixed;bottom:0;left:0;right:0;
      background:rgba(15,17,21,.92);backdrop-filter: blur(8px);
      border-top:1px solid rgba(255,255,255,.06);padding:10px 12px;
    }
    .bar-inner{
      max-width:1000px;margin:auto;
      display:grid;gap:10px;
      grid-template-columns: 1fr 1fr auto;
      align-items:end;
    }
    label{font-size:12px;color:var(--muted);margin-bottom:6px;display:block}
    input{
      width:100%;padding:10px 12px;border-radius:12px;background:#0d0f14;color:var(--text);
      border:1px solid rgba(255,255,255,.10);outline:none;direction:rtl;
      font-size:14px;
    }
    input:focus{border-color:#7aa2ff;box-shadow:0 0 0 6px var(--ring)}
    .btn{
      padding:11px 14px;border:none;border-radius:12px;font-weight:800;font-size:14px;
      background: linear-gradient(135deg,#7aa2ff,#4dd6c1);color:#0b0d12;cursor:pointer;box-shadow:var(--shadow);
    }
    .btn:hover{transform:translateY(-1px);filter:saturate(112%)}
    .err{color:var(--danger);font-size:12px;margin-top:6px}
    .empty{margin:18px 0 26px;color:var(--muted);text-align:center;font-size:14px}

    /* התאמות למסכים קטנים מאוד */
    @media (max-width: 360px){
      .grid{gap:8px}
      .fav{width:42px;height:42px}.fav img{width:26px;height:26px}
      .card a.open{font-size:12px;padding:8px 8px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">
        <svg viewBox="0 0 24 24" fill="none"><path d="M4 12a8 8 0 1 0 16 0" stroke="white" stroke-width="2.5" stroke-linecap="round"/><circle cx="12" cy="12" r="3" fill="white"/></svg>
      </div>
      <h1>מועדפים</h1>
    </header>

    <section id="cards" class="grid" aria-live="polite"></section>
    <div id="empty" class="empty" hidden>אין עדיין קישורים בקובץ.</div>
  </div>

  <div class="bar">
    <div class="bar-inner">
      <div>
        <label for="name">שם הקישור</label>
        <input id="name" type="text" autocomplete="off">
      </div>
      <div>
        <label for="url">הכנס קישור</label>
        <input id="url" type="text" autocomplete="off" inputmode="url">
        <div id="err" class="err" hidden></div>
      </div>
      <button id="saveAll" class="btn" type="button">שמור לכולם</button>
    </div>
  </div>

  <script>
    const $ = s=>document.querySelector(s);
    const cards=$("#cards"), empty=$("#empty"),
          inpName=$("#name"), inpUrl=$("#url"),
          btnSave=$("#saveAll"), err=$("#err");
    const JSON_PATH="data/links.json"; let list=[];
    const GH_EDIT_URL="https://github.com/Cc2k1975/reuven2k/edit/main/data/links.json";
    const faviconFor=u=>`https://www.google.com/s2/favicons?domain=${encodeURIComponent(new URL(u).hostname)}&sz=64`;

    /* === טעינת JSON ועיבוד === */
    async function loadJson(){
      try{
        const r=await fetch(`${JSON_PATH}?v=${Date.now()}`,{cache:"no-store"});
        if(!r.ok) throw 0;
        list=await r.json();
        if(!Array.isArray(list)) list=[];
      }catch{ list=[]; }
      render(true);
    }

    function normalizeUrl(raw){
      let s=(raw||"").trim();
      if(!s) throw new Error("נא למלא קישור");
      if(!/^https?:\/\//i.test(s)) s="https://"+s;
      try{ return new URL(s).toString(); }
      catch{ throw new Error("כתובת לא תקינה"); }
    }

    /* === רנדר כרטיסים + אנימציה + פקדים === */
    function render(withAnimation=false){
      cards.innerHTML="";
      if(!list.length){ empty.hidden=false; return; }
      empty.hidden=true;

      list.forEach((item, i)=>{
        const c=document.createElement("div"); c.className="card";
        if(withAnimation){ c.classList.add("appear"); c.style.animationDelay = (i*0.06)+"s"; }

        const fav = `<div class="fav"><img src="${faviconFor(item.url)}" alt=""></div>`;
        const open = `<a class="open" href="${item.url}" target="_blank" rel="noopener">${item.name}</a>`;

        const actions = `
          <div class="actions">
            <button class="iconbtn" title="ערוך" data-action="edit" data-index="${i}">
              <svg viewBox="0 0 24 24" fill="none"><path d="M4 16.5V20h3.5L19 8.5l-3.5-3.5L4 16.5z" stroke="white" stroke-width="1.6"/></svg>
            </button>
            <button class="iconbtn" title="מחק" data-action="delete" data-index="${i}">
              <svg viewBox="0 0 24 24" fill="none"><path d="M6 7h12M9 7V5h6v2m-8 3 1 9h8l1-9" stroke="white" stroke-width="1.6"/></svg>
            </button>
          </div>
        `;

        c.innerHTML = actions + fav + open;
        cards.appendChild(c);
      });

      // מאזינים לפקדי עריכה/מחיקה
      cards.querySelectorAll(".iconbtn").forEach(btn=>{
        btn.addEventListener("click", onAction);
      });
    }

    /* === הוספה + שמירה לכולם (העתקה + פתיחת עריכה בגיטהאב) === */
    function addAndSave(){
      err.hidden=true; err.textContent="";
      const name=(inpName.value||"").trim();
      const raw=(inpUrl.value||"").trim();
      if(!name || !raw){ err.textContent="נא למלא את שני השדות"; err.hidden=false; return; }
      let url;
      try{ url = normalizeUrl(raw); } catch(e){ err.textContent=e.message; err.hidden=false; return; }

      // מניעת כפילויות (לפי URL)
      const i = list.findIndex(x=>x.url?.toLowerCase()===url.toLowerCase());
      if(i>-1) list.splice(i,1);
      list.unshift({name, url, ts: Date.now()});
      inpName.value=""; inpUrl.value="";
      render();

      copyAndOpen();
    }

    function copyAndOpen(){
      const txt = JSON.stringify(list, null, 2);
      const openEdit = () => window.open(GH_EDIT_URL,"_blank");
      if(navigator.clipboard?.writeText){
        navigator.clipboard.writeText(txt).then(openEdit, openEdit);
      }else{
        const ta=document.createElement("textarea"); ta.value=txt; document.body.appendChild(ta); ta.select();
        try{ document.execCommand("copy"); }catch{}
        ta.remove(); openEdit();
      }
    }

    /* === פעולות עריכה/מחיקה === */
    function onAction(e){
      const btn = e.currentTarget;
      const idx = Number(btn.getAttribute("data-index"));
      const action = btn.getAttribute("data-action");
      if(Number.isNaN(idx) || !list[idx]) return;

      if(action==="delete"){
        if(confirm(`למחוק את "${list[idx].name}"?`)){
          list.splice(idx,1);
          render();
          copyAndOpen(); // עדכן את כולם
        }
      }else if(action==="edit"){
        const curr = list[idx];
        const newName = prompt("שם חדש לקישור:", curr.name ?? "");
        if(newName===null) return;
        const newUrlRaw = prompt("קישור חדש (URL):", curr.url ?? "");
        if(newUrlRaw===null) return;
        try{
          const newUrl = normalizeUrl(newUrlRaw);
          list[idx] = { ...curr, name: (newName||"").trim() || curr.name, url: newUrl, ts: Date.now() };
          render();
          copyAndOpen(); // עדכן את כולם
        }catch(errMsg){
          alert(errMsg.message || "כתובת לא תקינה");
        }
      }
    }

    btnSave.addEventListener("click", addAndSave);
    [inpName, inpUrl].forEach(el=>el.addEventListener("keydown", e=>{ if(e.key==="Enter") addAndSave(); }));

    loadJson();
  </script>
</body>
</html>
