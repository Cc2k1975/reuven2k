<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>5100 - Final Pro System</title>
  <style>
    :root { --primary: #1e3a8a; --accent: #2563eb; --bg: #f3f4f6; --card: #ffffff; --text: #1f2937; --wa: #16a34a; }

    body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
    .section { width: 100%; max-width: 480px; background: var(--card); padding: 12px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 12px; box-sizing: border-box; }
    h1 { color: var(--primary); margin: 5px 0; text-align: center; }
    label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px; color: var(--primary); }

    .grid-7 { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }

    button { padding: 10px 2px; border: 1px solid #d1d5db; background: #f9fafb; border-radius: 8px; cursor: pointer; font-size: 12px; }
    button.active { background: var(--accent); color: white; border-color: var(--accent); }
    input, textarea, select { width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 16px; box-sizing: border-box; outline: none; background: #fff; }
    textarea { height: 40px; resize: none; font-size: 14px; }

    #settings-trigger { position: absolute; top: 10px; left: 10px; font-size: 14px; cursor: pointer; opacity: 0.4; padding: 10px; }
    #settings-panel { display: none; width: 100%; max-width: 500px; background: #fff; padding: 15px; border-radius: 12px; border: 2px solid var(--primary); margin-top: 10px; box-sizing: border-box; }

    .btn-save { width: 100%; max-width: 480px; padding: 15px; background: #059669; color: white; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; margin-bottom: 20px; cursor: pointer; }
    .item-row { background: white; padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #eee; }
    .summary-row { padding: 10px; border-bottom: 1px solid #ddd; cursor: pointer; font-size: 13px; }

    .pdf-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
    .btn-red { background: #dc2626; color: white; border: none; padding: 14px; border-radius: 8px; font-weight: bold; }
    .btn-wa { background: var(--wa); color: white; border: none; padding: 14px; border-radius: 8px; font-weight: bold; }

    .status-bar { font-size: 11px; color: #64748b; margin-bottom: 8px; font-weight: bold; text-align: center; }

    @media print {
      .no-print, #settings-panel, #settings-trigger, .section, button, h1, .btn-save, .status-bar { display: none !important; }
      .print-only { display: block !important; width: 100%; }
      body { background: white !important; padding: 0 !important; }
      .report-table { width: 100% !important; border-collapse: collapse !important; border: 1px solid black !important; }
      .report-table th, .report-table td { border: 1px solid black !important; padding: 8px !important; text-align: right !important; }
    }

    .print-only { display: none; }
    .report-table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
    .report-table th, .report-table td { border: 1px solid #000; padding: 8px; text-align: right; }

    .chart-container { display: flex; flex-direction: column; align-items: center; margin-top: 10px; }
    .legend { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; justify-content: center; }
    .legend-item { display: flex; align-items: center; font-size: 11px; padding: 3px 6px; background: #f8fafc; border-radius: 10px; border: 1px solid #e2e8f0; }
    .legend-color { width: 8px; height: 8px; border-radius: 50%; margin-left: 5px; }

    .report-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 5px; }
    .btn-report-action { border: none; padding: 10px; border-radius: 6px; font-weight: bold; font-size: 12px; color: white; cursor: pointer; }

    /* ====== ×¡×™×“×•×¨ ×œ×¤×™ × ×•×©××™× + ××™×™×§×•×Ÿ (×‘×œ×™ ×¨×™×§×™× ×‘×“×£ ×”×¨××©×™) ====== */
    .group-title {
      grid-column: 1 / -1;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border: 1px solid #e5e7eb;
      background: #f8fafc;
      border-radius: 10px;
      font-weight: 900;
      color: var(--primary);
      font-size: 12px;
      margin-top: 4px;
    }
    .group-title .g-ico { font-size: 14px; line-height: 1; }
    .gap-btn-inner { display: inline-flex; align-items: center; justify-content: center; gap: 6px; width: 100%; }
    .gap-ico { font-size: 13px; line-height: 1; opacity: 0.95; }
    .gap-txt { line-height: 1.1; }

    /* ====== ×¢×•×¨×š × ×•×©××™× (10 ×œ×›×œ × ×•×©×) ====== */
    .topic-card { border: 1px solid #cbd5e1; background: #f8fafc; border-radius: 12px; padding: 10px; }
    .topic-head { display: grid; grid-template-columns: 48px 1fr; gap: 8px; align-items: center; margin-bottom: 8px; }
    .topic-slots { display: grid; grid-template-columns: 1fr; gap: 6px; }
    .mini-note { font-size: 11px; color: #64748b; margin-top: 8px; font-weight: 700; }
  </style>
</head>
<body>

  <div id="settings-trigger" class="no-print" onclick="checkPass()">âš™ï¸</div>
  <div id="status-bar" class="status-bar no-print">××ª×—×‘×¨ ×œ×¢× ×Ÿ...</div>

  <div id="main-ui" class="no-print">
    <h1>5100</h1>

    <div class="section">
      <label>×§×•××”</label>
      <div class="grid-7" id="floorContainer"></div>
    </div>

    <div class="section">
      <label>××¡×¤×¨ ×—×“×¨</label>
      <input type="number" id="roomInput" list="roomSuggestions" placeholder="×—×“×¨...">
      <datalist id="roomSuggestions"></datalist>
    </div>

    <div class="section">
      <label>×¢××“×”</label>
      <div class="grid-3" id="posContainer">
        <button onclick="setPos(this, '×™××™×Ÿ')">×™××™×Ÿ</button>
        <button onclick="setPos(this, '×©×××œ')">×©×××œ</button>
        <button onclick="setPos(this, '×“×œ×ª')">×“×œ×ª</button>
      </div>
    </div>

    <div class="section">
      <label id="gapHeaderLabel">×¤×¢×¨×™× (28 ×œ×—×¦× ×™×)</label>
      <div class="grid-4" id="gapContainer"></div>
    </div>

    <div class="section">
      <label>×”×¢×¨×•×ª</label>
      <textarea id="notesInput" placeholder="×”×¢×¨×” ×§×¦×¨×”..."></textarea>
    </div>

    <button id="saveBtn" class="btn-save" onclick="saveData()">×©××•×¨ ×œ×¢× ×Ÿ â˜ï¸</button>

    <div class="section" style="background: #eff6ff;" id="editArea">
      <label>×—×¤×© ×—×“×¨</label>
      <div style="display: flex; gap: 8px; margin-bottom: 10px;">
        <input type="number" id="searchRoomInput" placeholder="×—×“×¨...">
        <button onclick="searchByRoom()" style="background: var(--accent); color: white; border:none; padding: 0 15px; border-radius: 8px;">×”×¦×’</button>
      </div>
      <div id="searchResults"></div>
    </div>

    <div class="section">
      <label>×¤×¢×¨×™× ×¤×ª×•×—×™× ×‘×‘× ×™×™×Ÿ</label>
      <div id="mainSummary"></div>
    </div>
  </div>

  <div id="settings-panel" class="no-print">
    <h2 style="text-align:center; margin-top:0;">× ×™×”×•×œ ×•×“×•×—×•×ª</h2>

    <div style="background: #f8fafc; padding: 12px; border-radius: 10px; border: 1px solid #cbd5e1; margin-bottom: 15px;">
      <label>ğŸ“Š ×“×•×—×•×ª ×¨×™×›×•×– ×‘× ×™×™×Ÿ:</label>
      <div style="margin-top:10px;">
        <span style="font-size:12px; font-weight:bold;">×“×•×— ×œ×¤×™ ×¤×¢×¨×™× (×§×‘×œ× ×™×):</span>
        <div class="report-group">
          <button class="btn-report-action" style="background:#4f46e5;" onclick="generateReport('category')">×”×“×¤×¡×”/PDF</button>
          <button class="btn-report-action" style="background:#16a34a;" onclick="shareSummaryWA('category')">×©×œ×— ×‘×•×•××˜×¡××¤</button>
        </div>
      </div>
      <div style="margin-top:15px;">
        <span style="font-size:12px; font-weight:bold;">×“×•×— ×œ×¤×™ ×—×“×¨×™× (×§×•××•×ª):</span>
        <div class="report-group">
          <button class="btn-report-action" style="background:#4f46e5;" onclick="generateReport('room')">×”×“×¤×¡×”/PDF</button>
          <button class="btn-report-action" style="background:#16a34a;" onclick="shareSummaryWA('room')">×©×œ×— ×‘×•×•××˜×¡××¤</button>
        </div>
      </div>
    </div>

    <div style="margin-bottom:15px;">
      <label>ğŸ“Š ×¤×™×œ×•×— ×¤×¢×¨×™× (×’×¨×£):</label>
      <div class="chart-container">
        <div id="pie-chart-svg-container"></div>
        <div id="legend" class="legend"></div>
      </div>
    </div>

    <div style="margin-bottom:15px;">
      <label>âœï¸ ×¢×¨×™×›×ª 28 ×œ×—×¦× ×™×:</label>
      <div id="gap-editor-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;"></div>
    </div>

    <div style="margin-bottom:15px;">
      <label>ğŸ§© ×¡×™×“×•×¨ ×œ×¤×™ × ×•×©××™× (10 ×œ×›×œ × ×•×©×):</label>
      <div id="topic-editor" style="display:grid; grid-template-columns: 1fr; gap: 10px;"></div>
      <div class="mini-note">×”×“×£ ×”×¨××©×™ ××¦×™×’ ×¨×§ ××” ×©×‘×—×¨×ª (××™×Ÿ â€œ×¨×™×§×™×â€). ×× ×¤×¢×¨ ×œ× ×©×•×‘×¥ ×œ×©×•× × ×•×©× â€“ ×”×•× ×™×™×›× ×¡ ××•×˜×•××˜×™×ª ×œâ€œ××—×¨â€.</div>
    </div>

    <button onclick="closeSettings()" style="width:100%; background:var(--primary); color:white; padding:15px; border:none; border-radius:10px; font-weight:bold;">×©××•×¨ ×•×¦×</button>
  </div>

  <div id="printableReport" class="print-only" style="direction: rtl; padding: 20px;">
    <div style="border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 20px;">
      <h1 id="repTitle" style="margin:0; font-size: 24px;">×“×•×— ×¤×¢×¨×™× 5100</h1>
      <p>×ª××¨×™×š: <span id="repDate"></span></p>
    </div>
    <div id="repContent"></div>
    <div style="margin-top:50px; display:flex; justify-content:space-around;">
      <div>_________________<br>×—×ª×™××ª ××¤×§×—</div>
      <div>_________________<br>×—×ª×™××ª ×× ×”×œ ×¢×‘×•×“×”</div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, doc, getDoc, setDoc,
      getDocs, addDoc, updateDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ===== Firebase config (×›××• ×©× ×ª×ª) =====
    const firebaseConfig = {
      apiKey: "AIzaSyDe7vJA75cYtMxWQJSEPDf-iAVo3zFzozI",
      authDomain: "project-8467519916200199486.firebaseapp.com",
      projectId: "project-8467519916200199486",
      storageBucket: "project-8467519916200199486.firebasestorage.app",
      messagingSenderId: "261656799022",
      appId: "1:261656799022:web:687e615f891cccc869bcbf"
    };

    const app = initializeApp(firebaseConfig);
    const FS = getFirestore(app);

    // ====== × ×ª×•× ×™× (×›××• ×‘×§×•×“ ×©×œ×š) ======
    let db = [];
    let gapList = ["×—×©××œ", "×¨×©×ª", "×ª×§×©×•×¨×ª", "×ª××•×¨×”", "×’×œ××™", "×©×§×¢", "××¤×¡×§", "×œ×•×— ×—×©××œ", "××™×–×•×’", "×¡×¤×¨×™× ×§×œ×¨", "×˜×™×—", "×¦×‘×¢", "×¨×™×¦×•×£", "×—×™×¤×•×™", "×ª×§×¨×”", "×“×œ×ª", "×× ×¢×•×œ", "×—×œ×•×Ÿ", "××™×˜×•×", "× ×™×§×™×•×Ÿ", "×¤×¢×¨ 21", "×¤×¢×¨ 22", "×¤×¢×¨ 23", "×¤×¢×¨ 24", "×¤×¢×¨ 25", "×¤×¢×¨ 26", "×¤×¢×¨ 27", "×¤×¢×¨ 28"];
    let selectedFloor = null, selectedPos = null, selectedGaps = [];

    const colors = ["#ef4444", "#3b82f6", "#10b981", "#f59e0b", "#8b5cf6", "#ec4899", "#06b6d4", "#f97316", "#14b8a6", "#6366f1", "#d946ef", "#84cc16", "#0ea5e9", "#f43f5e", "#71717a", "#451a03", "#171717", "#fbbf24", "#6d28d9", "#34495e", "#546e7a", "#ff7043", "#8d6e63", "#78909c", "#d4e157", "#26a69a", "#ab47bc", "#26c6da"];

    const statusBar = document.getElementById('status-bar');

    // ===== Firestore "××‘× ×” ××—×¡×•×Ÿ" =====
    const ITEMS_COL = collection(FS, "items");
    const META_DOC = doc(FS, "meta", "config");

    function nowHeDate() {
      return new Date().toLocaleDateString('he-IL');
    }

    // ====== × ×•×©××™× (×›×•×ª×¨×•×ª + 10 ×¡×œ×•×˜×™× ×œ×›×œ × ×•×©×) ======
    // × ×©××¨ ×‘-Firestore: meta.topics, meta.topicSlots
    let topics = [
      { id: "power", title: "×—×©××œ / ×ª×§×©×•×¨×ª", icon: "âš¡" },
      { id: "furniture", title: "×¨×™×”×•×˜", icon: "ğŸª‘" },
      { id: "build", title: "×‘×™× ×•×™", icon: "ğŸ§±" },
      { id: "hvac", title: "××™×–×•×’", icon: "â„ï¸" },
      { id: "other", title: "××—×¨", icon: "ğŸ“Œ" }
    ];
    // topicSlots: { [topicId]: Array(10).fill(null|indexNumber) } indexNumber = 0..27
    let topicSlots = {};

    function ensureDefaultTopicSlots() {
      // ×× ×œ× ×§×™×™× - × ×‘× ×” ×‘×¨×™×¨×ª ××—×“×œ: 28 ×”×¨××©×•× ×™× ×™×ª×¤×–×¨×• ×œ×¤×™ ×¡×“×¨ ×¢×œ 4 × ×•×©××™×, ×”×©××¨ ×™×™×¤×•×œ ×œ"××—×¨" ××•×˜×•××˜×™×ª ×‘×“×£ ×”×¨××©×™
      const ids = topics.map(t => t.id);
      topicSlots = {};
      ids.forEach(id => topicSlots[id] = Array(10).fill(null));

      // ×¤×™×–×•×¨ ×¤×©×•×˜ (×œ× ××©× ×” ×©××•×ª/×œ×•×’×™×§×” ×©×œ gapList)
      // 0-9 => power, 10-15 => build, 16-19 => hvac, 20-27 => other (×‘×¤×•×¢×œ ×’× ×× ×œ× ×©×•×‘×¥, "××—×¨" ×™××œ× ×œ×‘×“)
      for (let i = 0; i < 28; i++) {
        let target = "other";
        if (i <= 9) target = "power";
        else if (i <= 19) target = "build";
        else if (i <= 20) target = "hvac";
        else target = "other";

        const slots = topicSlots[target];
        const firstEmpty = slots.findIndex(x => x === null);
        if (firstEmpty !== -1) slots[firstEmpty] = i;
      }
    }

    async function fetchCloudData() {
      statusBar.innerText = "â³ ××ª×—×‘×¨ ×œ×¢× ×Ÿ (Firebase)...";
      try {
        const metaSnap = await getDoc(META_DOC);
        if (metaSnap.exists()) {
          const meta = metaSnap.data() || {};
          if (Array.isArray(meta.gapList) && meta.gapList.length === 28) gapList = meta.gapList;

          if (Array.isArray(meta.topics) && meta.topics.length) topics = meta.topics;
          if (meta.topicSlots && typeof meta.topicSlots === "object") topicSlots = meta.topicSlots;

          // ×× ×—×¡×¨ ××©×”×• - × ×™×¦×•×¨ ×‘×¨×™×¨×ª ××—×“×œ ×¢×“×™× ×”
          const haveAll = topics.every(t => topicSlots && Array.isArray(topicSlots[t.id]) && topicSlots[t.id].length === 10);
          if (!haveAll) {
            ensureDefaultTopicSlots();
            await setDoc(META_DOC, { gapList, topics, topicSlots }, { merge: true });
          }
        } else {
          ensureDefaultTopicSlots();
          await setDoc(META_DOC, { gapList, topics, topicSlots }, { merge: true });
        }

        const snap = await getDocs(ITEMS_COL);
        db = snap.docs.map(d => ({ id: d.id, ...d.data() }));

        statusBar.innerText = "âœ… ××—×•×‘×¨ ×œ×¢× ×Ÿ ×•××¡×•× ×›×¨×Ÿ (Firebase)";
      } catch (e) {
        statusBar.innerText = "âŒ ×©×’×™××ª ×”×ª×—×‘×¨×•×ª ×œ×¢× ×Ÿ (Firebase)";
        console.error(e);
        alert("×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª ×œ-Firebase. ×‘×“×•×§ Rules/×—×™×‘×•×¨ ××™× ×˜×¨× ×˜.");
      }
    }

    async function syncGapListToCloud() {
      await setDoc(META_DOC, { gapList }, { merge: true });
      return true;
    }
    async function syncTopicsToCloud() {
      await setDoc(META_DOC, { topics, topicSlots }, { merge: true });
      return true;
    }

    function gapIconByName(name) {
      const s = String(name || "");
      if (/(×—×©××œ|× ×§×•×“×ª ×—×©××œ|××¤×¡×§|×ª××•×¨×”|×©×§×¢|×œ×•×—)/.test(s)) return "âš¡";
      if (/(×¨×©×ª|××™× ×˜×¨× ×˜|×˜×œ×¤×•×Ÿ|×ª×§×©×•×¨×ª)/.test(s)) return "ğŸ“¶";
      if (/(××–×’×Ÿ|××™×–×•×’|× ×–×™×œ×ª)/.test(s)) return "â„ï¸";
      if (/(×“×œ×ª|×—×œ×•×Ÿ|×¡×£|×ª×§×¨×”|×¨×™×¦×•×£|×¤×× ×œ|×˜×™×—|×¦×‘×¢|×—×™×¤×•×™|××™×˜×•×)/.test(s)) return "ğŸ§±";
      if (/(×›×™×¡×|×©×•×œ×—×Ÿ|××¨×•×Ÿ|××’×™×¨×•×ª|×¨×™×”×•×˜)/.test(s)) return "ğŸª‘";
      if (/(××–×¢×§×”|×¡×¤×¨×™× ×§×œ×¨|××©|×’×œ××™)/.test(s)) return "ğŸ›¡ï¸";
      return "ğŸ“Œ";
    }

    function buildMainGroupsFromSlots() {
      // ××—×–×™×¨ ××¢×¨×š ×§×‘×•×¦×•×ª ×œ×“×£ ×”×¨××©×™: ×¨×§ ××” ×©× ×‘×—×¨ (×œ×œ× ×¨×™×§×™×), + "××—×¨" ××§×‘×œ ×›×œ ××” ×©×œ× ×©×•×‘×¥
      const used = new Set();

      const result = topics.map(t => {
        const slots = Array.isArray(topicSlots[t.id]) ? topicSlots[t.id] : Array(10).fill(null);
        const idxs = slots.filter(v => Number.isInteger(v) && v >= 0 && v < 28);
        const unique = [];
        idxs.forEach(i => { if (!used.has(i)) { used.add(i); unique.push(i); } });
        return { id: t.id, title: t.title, icon: t.icon, idxs: unique };
      });

      // ×›×œ ××” ×©×œ× ×©×•×‘×¥ -> × ×›× ×¡ ×œ"××—×¨"
      const unassigned = [];
      for (let i = 0; i < 28; i++) if (!used.has(i)) unassigned.push(i);

      const other = result.find(g => g.id === "other");
      if (other) other.idxs = other.idxs.concat(unassigned);
      else if (unassigned.length) result.push({ id: "other", title: "××—×¨", icon: "ğŸ“Œ", idxs: unassigned });

      // ××¡×™×¨ ×§×‘×•×¦×•×ª ×¨×™×§×•×ª ×œ×’××¨×™ ×›×“×™ ×œ× ×œ×”×¦×™×’ ×›×•×ª×¨×ª ××™×•×ª×¨×ª
      return result.filter(g => g.idxs.length > 0);
    }

    function renderGapButtonsGroupedMain() {
      const gCont = document.getElementById('gapContainer');
      gCont.innerHTML = '';

      const groups = buildMainGroupsFromSlots();

      groups.forEach(gr => {
        const title = document.createElement('div');
        title.className = 'group-title';
        title.innerHTML = `<span class="g-ico">${gr.icon || "ğŸ“Œ"}</span><span>${gr.title || ""}</span>`;
        gCont.appendChild(title);

        gr.idxs.forEach(idx => {
          const gap = gapList[idx];

          const btn = document.createElement('button');
          btn.dataset.gap = gap;
          btn.innerHTML = `<span class="gap-btn-inner"><span class="gap-ico">${gapIconByName(gap)}</span><span class="gap-txt">${gap}</span></span>`;
          if (selectedGaps.includes(gap)) btn.classList.add('active');

          btn.onclick = () => {
            if (selectedGaps.includes(gap)) {
              selectedGaps = selectedGaps.filter(g => g !== gap);
              btn.classList.remove('active');
            } else {
              selectedGaps.push(gap);
              btn.classList.add('active');
            }
          };

          gCont.appendChild(btn);
        });
      });
    }

    function initUI() {
      const fCont = document.getElementById('floorContainer'); fCont.innerHTML = '';
      for (let i = 1; i <= 7; i++) {
        const btn = document.createElement('button'); btn.innerText = i;
        btn.onclick = () => {
          document.querySelectorAll('#floorContainer button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedFloor = i;
          updateRoomSuggestions();
        };
        fCont.appendChild(btn);
      }

      renderGapButtonsGroupedMain();
      renderSummary();
    }

    function updateRoomSuggestions() {
      const list = document.getElementById('roomSuggestions'); list.innerHTML = '';
      if (!selectedFloor) return;
      for (let i = selectedFloor * 100 + 1; i <= selectedFloor * 100 + 99; i++) {
        const opt = document.createElement('option'); opt.value = i; list.appendChild(opt);
      }
    }

    window.setPos = function(btn, val) {
      document.querySelectorAll('#posContainer button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      selectedPos = val;
    }

    // ===== SAVE =====
    window.saveData = async function() {
      const room = document.getElementById('roomInput').value;
      if (!selectedFloor || !room || !selectedPos || selectedGaps.length === 0) return alert("××œ× × ×ª×•× ×™×!");

      statusBar.innerText = "â³ ×©×•××¨ ×œ×¢× ×Ÿ...";

      try {
        const notes = document.getElementById('notesInput').value;
        const date = nowHeDate();

        for (const gap of selectedGaps) {
          await addDoc(ITEMS_COL, {
            status: 'active',
            date,
            room: String(room),
            position: selectedPos,
            gap,
            notes: notes || ""
          });
        }

        location.reload();
      } catch (e) {
        console.error(e);
        statusBar.innerText = "âŒ ×©×’×™××ª ×©××™×¨×” ×‘×¢× ×Ÿ";
        alert("×©×’×™××ª ×©××™×¨×” ×‘×¢× ×Ÿ (Firebase). ×‘×“×•×§ Rules/×—×™×‘×•×¨.");
      }
    }

    // ===== REPORT =====
    window.generateReport = function(type) {
      const active = db.filter(i => i.status === 'active');
      if (!active.length) return alert("××™×Ÿ × ×ª×•× ×™× ×¤×ª×•×—×™×");
      document.getElementById('repDate').innerText = nowHeDate();

      let content = '';
      if (type === 'category') {
        document.getElementById('repTitle').innerText = "×“×•×— ×¨×™×›×•×– ×œ×¤×™ ×¤×¢×¨×™× (×§×‘×œ× ×™×)";
        const grouped = {};
        active.forEach(i => { if (!grouped[i.gap]) grouped[i.gap] = []; grouped[i.gap].push(i.room + ` (${i.position})`); });
        content = `<table class="report-table"><tr><th>×¡×•×’ ×¤×¢×¨</th><th>×—×“×¨×™×</th></tr>`;
        Object.keys(grouped).sort().forEach(g => content += `<tr><td><b>${g}</b></td><td>${grouped[g].join(', ')}</td></tr>`);
      } else {
        document.getElementById('repTitle').innerText = "×“×•×— ×¨×™×›×•×– ×œ×¤×™ ×—×“×¨×™× (×§×•××•×ª)";
        const grouped = {};
        active.forEach(i => { if (!grouped[i.room]) grouped[i.room] = []; grouped[i.room].push(i.gap + ` (${i.position})`); });
        content = `<table class="report-table"><tr><th>×—×“×¨</th><th>×¤×¢×¨×™×</th></tr>`;
        Object.keys(grouped).sort((a,b)=>a-b).forEach(r => content += `<tr><td><b>×—×“×¨ ${r}</b></td><td>${grouped[r].join(', ')}</td></tr>`);
      }
      document.getElementById('repContent').innerHTML = content + "</table>";
      window.print();
    }

    window.shareSummaryWA = function(type) {
      const active = db.filter(i => i.status === 'active');
      if (!active.length) return alert("××™×Ÿ × ×ª×•× ×™×");
      let msg = `*×“×•×— ×¨×™×›×•×– 5100 - ${nowHeDate()}*%0A%0A`;
      if (type === 'category') {
        const grouped = {};
        active.forEach(i => { if (!grouped[i.gap]) grouped[i.gap] = []; grouped[i.gap].push(`×—×“×¨ ${i.room} (${i.position})`); });
        Object.keys(grouped).sort().forEach(g => msg += `*${g}:*%0A${grouped[g].join(', ')}%0A%0A`);
      } else {
        const grouped = {};
        active.forEach(i => { if (!grouped[i.room]) grouped[i.room] = []; grouped[i.room].push(`${i.gap} (${i.position})`); });
        Object.keys(grouped).sort((a,b)=>a-b).forEach(r => msg += `*×—×“×¨ ${r}:*%0A${grouped[r].join(', ')}%0A%0A`);
      }
      window.open(`https://wa.me/?text=${msg}`, '_blank');
    }

    // ===== SETTINGS =====
    window.checkPass = function() {
      if (prompt("×¡×™×¡××”:") === "4451") {
        document.getElementById('main-ui').style.display = 'none';
        document.getElementById('settings-panel').style.display = 'block';
        updateChart();
        loadEditor();
        loadTopicEditor();
      }
    }

    function loadEditor() {
      const grid = document.getElementById('gap-editor-grid'); grid.innerHTML = '';
      gapList.forEach((gap, idx) => {
        const inp = document.createElement('input');
        inp.value = gap;
        inp.onchange = (e) => { gapList[idx] = e.target.value; };
        grid.appendChild(inp);
      });
    }

    function loadTopicEditor() {
      const cont = document.getElementById('topic-editor');
      cont.innerHTML = '';

      // ×•×“× ×©×™×© 10 ×¡×œ×•×˜×™× ×œ×›×œ × ×•×©×
      topics.forEach(t => {
        if (!Array.isArray(topicSlots[t.id]) || topicSlots[t.id].length !== 10) topicSlots[t.id] = Array(10).fill(null);
      });

      topics.forEach(t => {
        const card = document.createElement('div');
        card.className = 'topic-card';

        // ×›×•×ª×¨×ª+××™×™×§×•×Ÿ ×œ×¢×¨×™×›×”
        const head = document.createElement('div');
        head.className = 'topic-head';

        const ico = document.createElement('input');
        ico.value = t.icon || "";
        ico.placeholder = "××™×™×§×•×Ÿ";
        ico.style.textAlign = 'center';
        ico.onchange = (e) => { t.icon = e.target.value; };

        const title = document.createElement('input');
        title.value = t.title || "";
        title.placeholder = "×›×•×ª×¨×ª × ×•×©×...";
        title.onchange = (e) => { t.title = e.target.value; };

        head.appendChild(ico);
        head.appendChild(title);

        // 10 ×¡×œ×•×˜×™×: ×›×œ ×¡×œ×•×˜ = SELECT ×œ×¤×¢×¨ (××• ×¨×™×§)
        const slotsWrap = document.createElement('div');
        slotsWrap.className = 'topic-slots';

        for (let i = 0; i < 10; i++) {
          const sel = document.createElement('select');

          const optEmpty = document.createElement('option');
          optEmpty.value = "";
          optEmpty.textContent = `â€” ×¨×™×§ (${i+1}) â€”`;
          sel.appendChild(optEmpty);

          for (let idx = 0; idx < 28; idx++) {
            const opt = document.createElement('option');
            opt.value = String(idx);
            opt.textContent = gapList[idx];
            sel.appendChild(opt);
          }

          const cur = topicSlots[t.id][i];
          sel.value = Number.isInteger(cur) ? String(cur) : "";

          sel.onchange = (e) => {
            const v = e.target.value;
            topicSlots[t.id][i] = (v === "" ? null : parseInt(v, 10));
          };

          slotsWrap.appendChild(sel);
        }

        card.appendChild(head);
        card.appendChild(slotsWrap);
        cont.appendChild(card);
      });
    }

    function sanitizeTopicSlots() {
      // 1) ×©×•××¨ 10 ×¡×œ×•×˜×™× ×œ×›×œ × ×•×©×
      topics.forEach(t => {
        if (!Array.isArray(topicSlots[t.id]) || topicSlots[t.id].length !== 10) topicSlots[t.id] = Array(10).fill(null);
        topicSlots[t.id] = topicSlots[t.id].map(v => (Number.isInteger(v) && v >= 0 && v < 28) ? v : null);
      });

      // 2) ×× ×§×” ×›×¤×™×œ×•×™×•×ª: ×× ××•×ª×• ××™× ×“×§×¡ ××•×¤×™×¢ ×¤×¢××™×™× -> ×¨×§ ×”×¨××©×•×Ÿ × ×©××¨, ×”×©××¨ × ×”×™×” null
      const seen = new Set();
      topics.forEach(t => {
        topicSlots[t.id] = topicSlots[t.id].map(v => {
          if (v === null) return null;
          if (seen.has(v)) return null;
          seen.add(v);
          return v;
        });
      });
    }

    window.closeSettings = async function() {
      statusBar.innerText = "â³ ××¢×“×›×Ÿ ×”×’×“×¨×•×ª...";

      try {
        sanitizeTopicSlots();

        await syncGapListToCloud();
        await syncTopicsToCloud();

        location.reload();
      } catch (e) {
        console.error(e);
        statusBar.innerText = "âŒ ×©×’×™××ª ×©××™×¨×” ×‘×¢× ×Ÿ";
        alert("×©×’×™××ª ×©××™×¨×” ×‘×¢× ×Ÿ (Firebase).");
      }
    }

    function updateChart() {
      const active = db.filter(i => i.status === 'active');
      if (!active.length) { document.getElementById('pie-chart-svg-container').innerHTML = "××™×Ÿ × ×ª×•× ×™×"; return; }
      const stats = {}; active.forEach(i => stats[i.gap] = (stats[i.gap] || 0) + 1);
      const sorted = Object.entries(stats).sort((a,b) => b[1] - a[1]);
      const total = active.length;
      let currentAngle = 0, svg = '';
      const leg = document.getElementById('legend'); leg.innerHTML = '';

      sorted.forEach(([n, c], idx) => {
        const angle = (c / total) * 360; const color = colors[idx % colors.length];
        const x1 = 100 + 100 * Math.cos(Math.PI * currentAngle / 180); const y1 = 100 + 100 * Math.sin(Math.PI * currentAngle / 180);
        currentAngle += angle;
        const x2 = 100 + 100 * Math.cos(Math.PI * currentAngle / 180); const y2 = 100 + 100 * Math.sin(Math.PI * currentAngle / 180);
        svg += `<path d="M100,100 L${x1},${y1} A100,100 0 ${angle > 180 ? 1 : 0},1 ${x2},${y2} Z" fill="${color}" style="stroke:#fff;"></path>`;
        leg.innerHTML += `<div class="legend-item"><div style="width:8px; height:8px; border-radius:50%; background:${color}; margin-left:5px;"></div>${n} (${c})</div>`;
      });

      document.getElementById('pie-chart-svg-container').innerHTML =
        `<svg width="150" height="150" viewBox="0 0 200 200" style="transform: rotate(-90deg);">${svg}</svg>`;
    }
    window.updateChart = updateChart;

    // ===== SEARCH / ACTIONS =====
    window.searchByRoom = function() {
      const val = document.getElementById('searchRoomInput').value;
      const res = document.getElementById('searchResults'); res.innerHTML = '';
      const filtered = db.filter(i => String(i.room) == String(val));
      if (!filtered.length) return res.innerHTML = '××™×Ÿ × ×ª×•× ×™×';

      // âœ… ×ª×™×§×•×Ÿ: ×‘××§×•× window.print() ×©×’×¨× ×œ×“×£ ×¨×™×§, ××“×¤×™×¡ ×“×¨×š printableReport ×›××• ×‘×“×•×—×•×ª
      res.innerHTML = `<div class="pdf-actions"><button class="btn-red" onclick="printRoomReport('${val}')">ğŸ“„ ×”×“×¤×¡×”</button><button class="btn-wa" onclick="sendWA(${val})">ğŸ’¬ ×•×•××˜×¡××¤</button></div>`;

      filtered.forEach(item => {
        res.innerHTML += `<div class="item-row ${item.status === 'done' ? 'done' : ''}" style="${item.status === 'done' ? 'background:#f0fdf4; opacity:0.6;' : ''}">
          <span><b>${item.gap}</b> (${item.position})</span>
          <div>
            <button onclick="markDone('${item.id}')">âœ”ï¸</button>
            <button onclick="deleteItem('${item.id}')">ğŸ—‘ï¸</button>
          </div>
        </div>`;
      });
    }

    // âœ… ×ª×™×§×•×Ÿ: ×”×“×¤×¡×” ×œ×—×“×¨ (×›××• ×”×œ×•×’×™×§×” ×‘×“×•×—×•×ª settings) ×›×“×™ ×©×œ× ×™×¦× ×“×£ ×¨×™×§
    window.printRoomReport = function(roomNum) {
      const items = db.filter(i => String(i.room) == String(roomNum));
      if (!items.length) return alert("××™×Ÿ × ×ª×•× ×™× ×œ×—×“×¨ ×”×–×”");

      document.getElementById('repTitle').innerText = `×“×•×— ×¤×¢×¨×™× - ×—×“×¨ ${roomNum}`;
      document.getElementById('repDate').innerText = nowHeDate();

      let content = `<table class="report-table">
        <tr>
          <th>#</th>
          <th>×¤×¢×¨</th>
          <th>×¢××“×”</th>
          <th>×¡×˜×˜×•×¡</th>
          <th>×”×¢×¨×•×ª</th>
          <th>×ª××¨×™×š</th>
        </tr>`;

      items.forEach((it, idx) => {
        const st = (it.status === 'done') ? '×‘×•×¦×¢' : '×¤×ª×•×—';
        const notes = (it.notes || '').toString();
        const date = (it.date || '').toString();
        content += `<tr>
          <td>${idx + 1}</td>
          <td><b>${it.gap || ''}</b></td>
          <td>${it.position || ''}</td>
          <td>${st}</td>
          <td>${notes}</td>
          <td>${date}</td>
        </tr>`;
      });

      content += `</table>`;
      document.getElementById('repContent').innerHTML = content;

      window.print();
    }

    window.sendWA = function(roomNum) {
      const items = db.filter(i => String(i.room) == String(roomNum) && i.status === 'active');
      let msg = `*×“×•×— ×¤×¢×¨×™× - ×—×“×¨ ${roomNum}*%0A%0A`;
      items.forEach((it, idx) => msg += `${idx+1}. ${it.gap} (${it.position})%0A`);
      window.open(`https://wa.me/?text=${msg}`, '_blank');
    }

    window.markDone = async function(id) {
      try {
        await updateDoc(doc(FS, "items", id), { status: "done" });
        await fetchCloudData();
        window.searchByRoom();
        renderSummary();
      } catch (e) {
        console.error(e);
        alert("×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×‘×¢× ×Ÿ (Firebase).");
      }
    }

    window.deleteItem = async function(id) {
      if (!confirm("××—×§?")) return;
      try {
        await deleteDoc(doc(FS, "items", id));
        await fetchCloudData();
        window.searchByRoom();
        renderSummary();
      } catch (e) {
        console.error(e);
        alert("×©×’×™××” ×‘××—×™×§×” ×‘×¢× ×Ÿ (Firebase).");
      }
    }

    function renderSummary() {
      const cont = document.getElementById('mainSummary'); cont.innerHTML = '';
      const active = db.filter(i => i.status === 'active');
      const groups = {};
      active.forEach(i => { if (!groups[i.room]) groups[i.room] = new Set(); groups[i.room].add(i.gap); });

      Object.keys(groups).sort((a,b)=>a-b).forEach(r => {
        cont.innerHTML += `<div class="summary-row" onclick="document.getElementById('searchRoomInput').value = ${r}; searchByRoom();">
          <strong>×—×“×¨ ${r}</strong>: ${Array.from(groups[r]).join(', ')}
        </div>`;
      });
    }
    window.renderSummary = renderSummary;

    async function initApp() {
      await fetchCloudData();
      initUI();
    }

    initApp();
  </script>
</body>
</html>
