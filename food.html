<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>×‘×—×™×¨×ª ×ª×¤×¨×™×˜ ××©×¤×—×ª×™</title>
<style>
:root {
  --bg-page:#fffaf0;
  --card-bg:#ffffff;
  --border:#e2d7b8;
  --gold:#c59d2f;
  --green:#3c7a4c;
  --green-dark:#2e5f3b;
  --text-main:#333;
  --text-dim:#666;
  --radius:16px;
  --shadow:0 8px 24px rgba(0,0,0,0.12);
  --shadow-inner:0 0 10px rgba(0,0,0,0.08) inset;
  --ok-bg:#2e7d32;
  --err-bg:#a01919;
}

body {
  background:var(--bg-page);
  margin:0;
  font-family:"Heebo",Arial,sans-serif;
  color:var(--text-main);
  display:flex;
  justify-content:center;
  padding:16px;
  text-align:center;
}

.wrap {
  width:100%;
  max-width:600px;
  background:var(--card-bg);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:24px 20px 32px;
  border:2px solid var(--border);
  position:relative;
}

/* ×›×•×ª×¨×ª ×¢×œ×™×•× ×” */
h1 {
  margin:0;
  font-size:28px;
  color:var(--green);
  font-weight:700;
  line-height:1.3;
  text-align:center;
  white-space:nowrap;
}

/* ×©×•×¨×ª ××™×“×¢ ×¢×œ ×”××™×¨×•×¢ */
#welcomeExtra {
  margin-top:8px;
  text-align:center;
  line-height:1.5;
  color:var(--text-main);
  font-size:16px;
  font-weight:500;
  white-space:nowrap;
}

/* ×¤×¡ ×¡×˜×˜×•×¡ */
#statusBox {
  display:none;
  margin-top:12px;
  font-size:16px;
  font-weight:600;
  color:#fff;
  border-radius:var(--radius);
  padding:10px 14px;
  line-height:1.4;
  text-align:center;
}
#statusBox.ok  { background:var(--ok-bg); }
#statusBox.err { background:var(--err-bg); }

/* ×›×•×ª×¨×•×ª ×§×˜×’×•×¨×™×” */
.sectionHead {
  font-size:20px;
  font-weight:700;
  color:var(--gold);
  border-bottom:2px solid var(--gold);
  display:inline-block;
  margin:28px 0 8px;
  line-height:1.4;
}

/* ×‘×—×™×¨×•×ª */
select {
  width:100%;
  appearance:none;
  -webkit-appearance:none;
  background:#fff;
  border:2px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow-inner);
  padding:14px;
  font-size:18px;
  font-family:inherit;
  font-weight:500;
  text-align:right;
  color:var(--text-main);
}
select:disabled {
  background:#f3f3f3;
  color:#aaa;
}

/* ×›×¤×ª×•×¨ ×©×œ×™×—×” */
button#sendBtn {
  width:100%;
  background:var(--green);
  color:#fff;
  border:0;
  border-radius:var(--radius);
  padding:16px;
  font-size:20px;
  font-weight:700;
  margin-top:28px;
  box-shadow:var(--shadow);
}
button#sendBtn:active { background:var(--green-dark); }
button#sendBtn:disabled {
  background:#999;
  box-shadow:none;
  opacity:0.7;
  cursor:not-allowed;
}

/* popup ×¡×™×›×•× */
.popup-bg {
  position:fixed;
  top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,0.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.popup {
  background:var(--bg-page);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  border:2px solid var(--border);
  width:90%;
  max-width:400px;
  padding:24px 20px 28px;
  text-align:center;
  animation:pop .3s ease-out;
}
@keyframes pop {
  from {transform:scale(.8);opacity:0;}
  to   {transform:scale(1);opacity:1;}
}
.popup h2 {
  margin:0 0 8px;
  color:var(--green);
  font-size:22px;
  font-weight:700;
  line-height:1.4;
}
.popup p {
  margin:6px 0;
  font-size:18px;
  color:var(--text-main);
  line-height:1.4;
  font-weight:500;
}
.popup .emoji {
  font-size:22px;
  margin-left:6px;
}
.closeBtn {
  margin-top:20px;
  background:var(--green);
  color:#fff;
  font-size:18px;
  font-weight:700;
  border:0;
  border-radius:var(--radius);
  padding:12px 20px;
  box-shadow:var(--shadow);
  width:100%;
}

/* ×¤×•×˜×¨ */
.footerInfo {
  text-align:center;
  font-size:13px;
  color:var(--text-dim);
  margin-top:28px;
}
</style>
</head>
<body>

<div class="wrap">
  <!-- ×›×•×ª×¨×ª ××©×¤×—×” + ×¤×¨×˜×™ ××¤×’×© -->
  <h1 id="welcomeTitle">×˜×•×¢×Ÿ...</h1>
  <div id="welcomeExtra">
    <div id="eventLocationLine"></div>
    <div id="eventDateLine"></div>
  </div>

  <!-- ×¡×˜×˜×•×¡ ××¢×¨×›×ª -->
  <div id="statusBox"></div>

  <!-- ×”×˜×•×¤×¡ (×œ×œ× "×‘×—×¨ ××” ××ª×” ××‘×™×") -->
  <form id="foodForm" style="margin-top:20px;">

    <div class="sectionHead">×× ×” ×‘×©×¨×™×ª</div>
    <select id="meat" required>
      <option disabled selected value=""></option>
    </select>

    <div class="sectionHead">×¤×—××™××”</div>
    <select id="carb" required>
      <option disabled selected value=""></option>
    </select>

    <div class="sectionHead">×¡×œ×˜ 1</div>
    <select id="salad1" required>
      <option disabled selected value=""></option>
    </select>

    <div class="sectionHead">×¡×œ×˜ 2</div>
    <select id="salad2" required>
      <option disabled selected value=""></option>
    </select>

    <div class="sectionHead">×©×ª×™×™×”</div>
    <select id="drink" required>
      <option disabled selected value=""></option>
    </select>

    <div class="sectionHead">×§×™× ×•×—</div>
    <select id="dessert" required>
      <option disabled selected value=""></option>
    </select>

    <button id="sendBtn" type="submit">×©×œ×— ×ª×¤×¨×™×˜</button>
  </form>

  <div class="footerInfo">×’×¨×¡×”: v2.6 Â· food.html</div>
</div>

<!-- ×¤×•×¤××¤ ×¡×™×›×•× -->
<div class="popup-bg" id="popupBG">
  <div class="popup">
    <h2 id="popupTitle"></h2>
    <div id="popupContent"></div>
    <button class="closeBtn" onclick="closePopup()">×¡×’×•×¨</button>
  </div>
</div>

<script>
// ===== ×¤×¨××˜×¨×™× ×©×œ JSONBin =====
const BIN_ID      = "68ff447a43b1c97be9844c29";
const MASTER_KEY  = "$2a$10$4rynniEMuvwqg2nDb5KSEe/lAVYp8a7L3xWzp9GsO6n49OfXc3FCO";
const API         = "https://api.jsonbin.io/v3/b";

// DOM refs
const welcomeTitle      = document.getElementById("welcomeTitle");
const eventLocationLine = document.getElementById("eventLocationLine");
const eventDateLine     = document.getElementById("eventDateLine");

const statusBox         = document.getElementById("statusBox");
const formEl            = document.getElementById("foodForm");
const sendBtn           = document.getElementById("sendBtn");

const meat              = document.getElementById("meat");
const carb              = document.getElementById("carb");
const salad1            = document.getElementById("salad1");
const salad2            = document.getElementById("salad2");
const drink             = document.getElementById("drink");
const dessert           = document.getElementById("dessert");

const popupBG        = document.getElementById("popupBG");
const popupTitleEl   = document.getElementById("popupTitle");
const popupContentEl = document.getElementById("popupContent");

// ××¦×‘
const urlParams = new URLSearchParams(window.location.search);
let currentCode = (urlParams.get("code") || "").trim();

let familyName    = "";     // "××©×¤×—×ª ×©×™×™×Ÿ"
let formOpen      = true;   // ×”×× ××¤×©×¨ ×œ××œ×
let alreadySent   = false;  // ×”×× ×”×§×•×“ ×”×–×” ×›×‘×¨ ×©××¨
let menuOptions   = {};     // ×›×œ ×”×¨×©×™××•×ª ×”××¨×•×›×•×ª
let eventLocation = "";     // ××™×§×•×
let eventDate     = "";     // ×ª××¨×™×š

// ===== ×¢×•×–×¨×™ UI =====
function showStatus(msg, ok){
  statusBox.style.display="block";
  statusBox.className = ok ? "ok" : "err";
  statusBox.textContent = msg;
}

function lockAllSelects(lock){
  [meat,carb,salad1,salad2,drink,dessert].forEach(sel=>{
    sel.disabled = lock;
  });
  sendBtn.disabled = lock;
}

// ×××œ× <select> ×××¢×¨×š
function fillSelectOptions(selectEl, arr){
  for(const item of arr){
    const opt = document.createElement("option");
    opt.value = item;
    opt.textContent = item;
    selectEl.appendChild(opt);
  }
}

// ××›×‘×” ××•×¤×¦×™×•×ª ×©×›×‘×¨ × ×ª×¤×¡×• ×¢"×™ ××©×¤×—×•×ª ××—×¨×•×ª
function disableUsedOptions(usedList){
  const allSelects=[meat,carb,salad1,salad2,drink,dessert];
  allSelects.forEach(sel=>{
    for(const opt of sel.options){
      if(!opt.value) continue;
      if(usedList.includes(opt.textContent)){
        opt.disabled = true;
        opt.style.color = "#aaa";
      }
    }
  });
}

// ××¦×™×’ ×›×•×ª×¨×ª + ××™×§×•× + ×ª××¨×™×š
function renderHeaderInfo(){
  // ×›×•×ª×¨×ª ××©×¤×—×” ×××•×¨×›×–×ª ×‘×œ×™ ×”××™×™×§×•×Ÿ
  welcomeTitle.textContent = "×‘×¨×•×›×™× ×”×‘××™× " + familyName;

  // ×©×•×¨×ª ××™×§×•×
  if(eventLocation){
    eventLocationLine.textContent = "× ×¤×’×©×™× ×‘: " + eventLocation;
  } else {
    eventLocationLine.textContent = "";
  }

  // ×©×•×¨×ª ×ª××¨×™×š
  if(eventDate){
    eventDateLine.textContent = "×‘×ª××¨×™×š: " + eventDate;
  } else {
    eventDateLine.textContent = "";
  }
}

// ===== ×˜×¢×™× ×ª ××¦×‘ ×¨××©×•× ×™ =====
async function initData(){
  if(!currentCode){
    welcomeTitle.textContent = "××™×Ÿ ×§×•×“ ×–×™×”×•×™";
    showStatus("×›×“×™ ×œ×‘×—×•×¨ ××ª× ×—×™×™×‘×™× ×œ×”×™×›× ×¡ ××”×§×™×©×•×¨ ×”××™×©×™ ×©×œ×›×.", false);
    lockAllSelects(true);
    return;
  }

  try {
    const res = await fetch(`${API}/${BIN_ID}/latest`, {
      headers: { "X-Master-Key": MASTER_KEY }
    });
    const j = await res.json();

    formOpen      = j.record?.formOpen !== false;
    const map     = j.record?.map || {};
    menuOptions   = j.record?.menuOptions || {};
    const allCh   = Array.isArray(j.record?.×‘×—×™×¨×•×ª) ? j.record.×‘×—×™×¨×•×ª : [];

    eventLocation = j.record?.eventLocation || "";
    eventDate     = j.record?.eventDate || "";

    // ××™ ×× ×™?
    familyName = map[currentCode] || "";
    if(!familyName){
      welcomeTitle.textContent = "×§×•×“ ×œ× ××–×•×”×”";
      showStatus("×”×§×•×“ ×”×–×” ×œ× ××•×›×¨. ×“×‘×¨×• ××™×ª×™.", false);
      lockAllSelects(true);
      return;
    }

    // ×‘× ×” ×˜×§×¡×˜ ×›×•×ª×¨×ª + ××§×•×/×ª××¨×™×š
    renderHeaderInfo();

    // ×‘× ×” ×‘×—×™×¨×•×ª
    fillSelectOptions(meat,   menuOptions.meat   || []);
    fillSelectOptions(carb,   menuOptions.carb   || []);
    fillSelectOptions(salad1, menuOptions.salad1 || []);
    fillSelectOptions(salad2, menuOptions.salad2 || []);
    fillSelectOptions(drink,  menuOptions.drink  || []);
    fillSelectOptions(dessert,menuOptions.dessert|| []);

    // ×›×œ ×¤×¨×™×˜ ×©×›×‘×¨ ×ª×¤×•×¡ ×¢"×™ ××™×©×”×• (×›×œ ×”××©×¤×—×•×ª ×™×—×“)
    const usedItems=[];
    allCh.forEach(rec=>{
      if(rec.×× ×”)    usedItems.push(rec.×× ×”);
      if(rec.×¤×—××™××”) usedItems.push(rec.×¤×—××™××”);
      if(rec.×¡×œ×˜1)   usedItems.push(rec.×¡×œ×˜1);
      if(rec.×¡×œ×˜2)   usedItems.push(rec.×¡×œ×˜2);
      if(rec.×©×ª×™×™×”)  usedItems.push(rec.×©×ª×™×™×”);
      if(rec.×§×™× ×•×—)  usedItems.push(rec.×§×™× ×•×—);
    });
    disableUsedOptions(usedItems);

    // ×”×× ×”×§×•×“ ×”×–×” ×›×‘×¨ ×©×œ×—?
    const mine = allCh.find(rec => rec.code === currentCode);
    if(mine){
      alreadySent = true;
      showStatus("×›×‘×¨ ×©×œ×—×ª× ××ª ×”×‘×—×™×¨×”. ×× ×¦×¨×™×š ×œ×©× ×•×ª ×“×‘×¨×• ××™×ª×™ ğŸ™", true);
      lockAllSelects(true);
      return;
    }

    // ×”×× ×›×¨×’×¢ OFFLINE?
    if(!formOpen){
      showStatus("×”×¨×™×©×•× ×¡×’×•×¨ ×›×¨×’×¢. ×“×‘×¨×• ××™×ª×™.", false);
      lockAllSelects(true);
      return;
    }

    // ×”×›×œ ×¤×ª×•×—
    lockAllSelects(false);
    showStatus("××œ××• ××ª ×”×‘×—×™×¨×” ×©×œ×›× ğŸ™Œ", true);

  } catch(err){
    console.error(err);
    welcomeTitle.textContent = "×©×’×™××” ×‘×˜×¢×™× ×”";
    showStatus("×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×. × ×¡×• ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.", false);
    lockAllSelects(true);
  }
}
initData();

// ===== ×©×œ×™×—×” =====
formEl.addEventListener("submit", async (e)=>{
  e.preventDefault();

  if(!currentCode){
    showStatus("×§×•×“ ×œ× ×–×•×”×”, ××™ ××¤×©×¨ ×œ×©×œ×•×—.", false);
    return;
  }
  if(!familyName){
    showStatus("×§×•×“ ×œ× ××•×›×¨, ××™ ××¤×©×¨ ×œ×©×œ×•×—.", false);
    return;
  }
  if(alreadySent){
    showStatus("×›×‘×¨ ×©×œ×—×ª×. ×× ×¦×¨×™×š ×œ×©× ×•×ª ×“×‘×¨×• ××™×ª×™.", false);
    return;
  }
  if(!formOpen){
    showStatus("×”×¨×™×©×•× ×¡×’×•×¨ ×›×¨×’×¢.", false);
    return;
  }

  const oneChoice = {
    "code": currentCode,
    "×©×": familyName,
    "×× ×”": meat.value,
    "×¤×—××™××”": carb.value,
    "×¡×œ×˜1": salad1.value,
    "×¡×œ×˜2": salad2.value,
    "×©×ª×™×™×”": drink.value,
    "×§×™× ×•×—": dessert.value,
    "ts": new Date().toISOString()
  };

  try {
    // ××•×©×š ×¢×•×ª×§ ×¢×“×›× ×™ ×™×©×¨ ×œ×¤× ×™ ×›×ª×™×‘×”
    const res1 = await fetch(`${API}/${BIN_ID}/latest`, {
      headers: { "X-Master-Key": MASTER_KEY }
    });
    const data1 = await res1.json();

    const existingChoices = Array.isArray(data1.record?.×‘×—×™×¨×•×ª)
      ? data1.record.×‘×—×™×¨×•×ª
      : [];

    const stillOpen    = data1.record?.formOpen !== false;
    const latestMap    = data1.record?.map || {};
    const latestMenu   = data1.record?.menuOptions || {};
    const latestLoc    = data1.record?.eventLocation || "";
    const latestDate   = data1.record?.eventDate || "";

    // ×•×™×“×•× ×©×¢×“×™×™×Ÿ ×™×© ××™×¤×•×™ ×œ×§×•×“ ×©×œ×™
    if(!latestMap[currentCode]){
      showStatus("×”×§×•×“ ×”×–×” ×›×‘×¨ ×œ× ×¤×¢×™×œ. ×“×‘×¨×• ××™×ª×™.", false);
      lockAllSelects(true);
      return;
    }

    // ×•×™×“×•× ×©×œ× ××™×œ××ª×™ ×‘×™× ×ª×™×™×
    if(existingChoices.find(rec => rec.code === currentCode)){
      showStatus("×›×‘×¨ ×©×œ×—×ª×.", true);
      lockAllSelects(true);
      return;
    }

    // ×•×™×“×•× ×©×”×˜×•×¤×¡ ×œ× × ×¡×’×¨ ×‘×™× ×ª×™×™×
    if(!stillOpen){
      showStatus("×”×¨×™×©×•× × ×¡×’×¨ ×›×¨×’×¢.", false);
      lockAllSelects(true);
      return;
    }

    // ××•×¡×™×£ ××ª ×”×‘×—×™×¨×” ×©×œ×™
    existingChoices.push(oneChoice);

    // ×©×•××¨ ×‘×—×–×¨×” ×œ×›×œ ×”××‘× ×” (×›×•×œ×œ ×œ×•×§×™×™×©×Ÿ ×•×ª××¨×™×š!)
    const putRes = await fetch(`${API}/${BIN_ID}`, {
      method:"PUT",
      headers:{
        "Content-Type":"application/json",
        "X-Master-Key": MASTER_KEY
      },
      body:JSON.stringify({
        "formOpen": stillOpen,
        "map": latestMap,
        "menuOptions": latestMenu,
        "×‘×—×™×¨×•×ª": existingChoices,
        "eventLocation": latestLoc,
        "eventDate": latestDate
      })
    });

    if(!putRes.ok){
      showStatus("×©××™×¨×” × ×›×©×œ×”. × ×¡×• ×©×•×‘.", false);
      return;
    }

    // ×”×¦×œ×—×” âœ”
    alreadySent = true;
    lockAllSelects(true);
    showStatus("×”× ×ª×•× ×™× × ×©××¨×• ×‘×”×¦×œ×—×” âœ…", true);
    showPopup(oneChoice);

  } catch(err){
    console.error(err);
    showStatus("×©×’×™××” ×‘×–××Ÿ ×©×œ×™×—×”. × ×¡×• ×©×•×‘.", false);
  }
});

// ===== ×¤×•×¤××¤ ×¡×™×›×•× =====
function showPopup(choice){
  popupTitleEl.textContent = familyName + " â€“ ×”×‘×—×™×¨×•×ª ×©×œ×›×";
  popupContentEl.innerHTML = `
    <p><span class="emoji">ğŸ—</span> ×× ×”: ${choice.×× ×”}</p>
    <p><span class="emoji">ğŸš</span> ×¤×—××™××”: ${choice.×¤×—××™××”}</p>
    <p><span class="emoji">ğŸ¥—</span> ×¡×œ×˜ 1: ${choice.×¡×œ×˜1}</p>
    <p><span class="emoji">ğŸ¥—</span> ×¡×œ×˜ 2: ${choice.×¡×œ×˜2}</p>
    <p><span class="emoji">ğŸ¥¤</span> ×©×ª×™×™×”: ${choice.×©×ª×™×™×”}</p>
    <p><span class="emoji">ğŸ°</span> ×§×™× ×•×—: ${choice.×§×™× ×•×—}</p>
  `;
  popupBG.style.display="flex";
}

function closePopup(){
  popupBG.style.display="none";
}
</script>
</body>
</html>
