<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>×¤×Ÿ ××§×¡×¤×¨×¡ - ×”×’×¨×¡×” ×”×¡×•×¤×™×ª</title>
  <style>
    :root { --primary: #ff6b81; --bg: #f8f9fa; --purple: #6c5ce7; }
    body { font-family: system-ui, sans-serif; text-align: center; background-color: var(--bg); margin: 0; padding: 10px; }
    .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); padding-bottom: 50px; }

    /* ××–×•×¨ ××¦×œ××” ×—×™×” */
    #camContainer {
      width: 100%;
      aspect-ratio: 4/5;          /* ×”×™×” 3/4 -> ×¢×›×©×™×• ××¢×˜ ×™×•×ª×¨ × ××•×š ×›×“×™ ×©×™×™×›× ×¡ ×”×›×¤×ª×•×¨ + ×”-preview ×‘××¡×š */
      max-height: 48vh;           /* ××‘×˜×™×— ×©×œ× â€œ×™×‘×œ×¢â€ ××ª ×”××¡×š */
      background: #000;
      position: relative;
      border-radius: 20px;
      overflow: hidden;
      display: none;
      margin-bottom: 10px;        /* ××¢×˜ ×¤×—×•×ª ×›×“×™ ×œ×—×¡×•×š ××§×•× */
    }
    #videoLive { width: 100%; height: 100%; object-fit: cover; }

    /* âœ… ×›×•×•× ×ª ×¨××©: ×—×¦×™-×¢×™×’×•×œ ×¦×”×•×‘ */
    .head-guide{
      position:absolute;
      top: 10%;                 /* ×”××™×§×•× ×”××¦×•×™×™×Ÿ */
      left: 50%;
      transform: translateX(-50%);
      width: 68%;
      max-width: 420px;
      aspect-ratio: 2 / 1;
      border: 6px solid yellow;
      border-bottom: none;
      border-radius: 9999px 9999px 0 0;
      box-shadow: 0 0 18px yellow;
      z-index: 10;
      pointer-events: none;
    }
    .head-guide::after{
      content:"";
      position:absolute;
      left:50%;
      bottom:-3px;
      transform: translateX(-50%);
      width: 44px;
      height: 6px;
      background: yellow;
      border-radius: 999px;
      box-shadow: 0 0 12px yellow;
      opacity: 0.9;
    }

    .upload-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    .box { border: 2px dashed #ddd; border-radius: 15px; height: 105px; display: flex; align-items: center; justify-content: center; position: relative; background: #fafafa; overflow: hidden; }
    img.prev { width: 100%; height: 100%; object-fit: contain; position: absolute; }

    button { background: var(--purple); color: white; border: none; padding: 15px; font-size: 18px; border-radius: 15px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 10px; }
    .snap-btn { background: var(--primary); margin-top: 6px; }

    #status { font-weight: bold; color: var(--primary); margin: 12px 0; }
    video#finalVid { width: 100%; border-radius: 15px; display: none; margin-top: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
    .save-btn { background: #2ed573; text-decoration: none; display: none; padding: 18px; border-radius: 50px; color: white; font-weight: bold; margin-top: 15px; }

    /* ×›×œ×™ ×›×™×•×•× ×•×Ÿ ×™×“× ×™ */
    #adjustArea { display: none; border: 2px solid var(--purple); border-radius: 15px; overflow: hidden; background: #000; margin-top: 15px; touch-action: none; }
  </style>
</head>
<body>

<div class="container">
  <h2 style="margin-bottom:5px;">âœ¨ ×¤×Ÿ ××§×¡×¤×¨×¡ âœ¨</h2>
  <p style="font-size: 12px; color: #666; margin-bottom: 12px;">×¦×™×œ×•× ×¢× ×›×•×•× ×ª ×œ×”×ª×××” ××•×©×œ××ª</p>

  <div id="camContainer">
    <video id="videoLive" autoplay playsinline muted></video>
    <div class="head-guide"></div>
  </div>

  <div id="ui-capture">
    <button id="btnOpenCam">×¤×ª×— ××¦×œ××” ×¢× ×›×•×•× ×ª ×¨××© ğŸ“¸</button>
    <button id="btnSnap" class="snap-btn" style="display:none">×œ×—×™×¦×” ×œ×¦×™×œ×•× ğŸ“¸</button>
  </div>

  <div class="upload-grid">
    <div class="box" id="boxB"><span>×œ×¤× ×™</span><img id="imgB" class="prev"></div>
    <div class="box" id="boxA"><span>××—×¨×™</span><img id="imgA" class="prev"></div>
  </div>

  <div id="adjustArea">
    <p style="color:white; font-size:12px; margin:5px;">×›×•×•×Ÿ ×ª××•× ×” ×¢×œ ×ª××•× ×” ğŸ‘† (×’×¨×•×¨ ×—×•×¤×©×™ ×œ×›×œ ×›×™×•×•×Ÿ)</p>
    <canvas id="adjustCanvas" style="width:100%; display:block;"></canvas>
  </div>

  <button id="btnCreate" style="display:none; background:#2ed573;">×¦×•×¨ ×¡×¨×˜×•×Ÿ ×××•×ª×’ ğŸ¬</button>

  <div id="status"></div>
  <video id="finalVid" controls playsinline loop muted></video>
  <a id="btnDownload" class="save-btn">×©××™×¨×” ×œ×’×œ×¨×™×” â¬‡ï¸</a>
</div>

<script>
  const video = document.getElementById('videoLive');
  const camContainer = document.getElementById('camContainer');
  const btnOpen = document.getElementById('btnOpenCam');
  const btnSnap = document.getElementById('btnSnap');
  const btnCreate = document.getElementById('btnCreate');
  const adjustArea = document.getElementById('adjustArea');
  const adjustCanvas = document.getElementById('adjustCanvas');
  const statusEl = document.getElementById('status');

  let beforeImg = new Image(), afterImg = new Image();
  let mode = 'before';
  let offsetX = 0, offsetY = 0;

  let liveStream = null;

  function stopLiveCamera() {
    try {
      if (liveStream) {
        liveStream.getTracks().forEach(t => t.stop());
        liveStream = null;
      }
      video.srcObject = null;
    } catch {}
  }

  async function openLiveCamera() {
    if (!window.isSecureContext) {
      alert("××¦×œ××” ×—×™×” ×“×•×¨×©×ª HTTPS. ×¤×ª×— ××ª ×”×“×£ ×“×¨×š https://");
      return;
    }

    const c1 = { video: { facingMode: { ideal: "environment" }, width: { ideal: 1280 }, height: { ideal: 720 } }, audio: false };
    const c2 = { video: true, audio: false };

    try {
      stopLiveCamera();
      liveStream = await navigator.mediaDevices.getUserMedia(c1);
    } catch (e1) {
      try {
        stopLiveCamera();
        liveStream = await navigator.mediaDevices.getUserMedia(c2);
      } catch (e2) {
        const name = (e2 && e2.name) ? e2.name : "CameraError";
        let msg = "×”××¦×œ××” ×”×—×™×” ×—×¡×•××” ×‘××›×©×™×¨ ×”×–×”.";
        if (name === "NotAllowedError" || name === "SecurityError") {
          msg = "××™×Ÿ ×’×™×©×” ×œ××¦×œ××” (× ×—×¡×/××™×Ÿ ×”×¨×©××”/×“×¤×“×¤×Ÿ ×¤× ×™××™).";
        } else if (name === "NotFoundError") {
          msg = "×œ× × ××¦××” ××¦×œ××” ×–××™× ×”.";
        }
        alert(msg);
        return;
      }
    }

    video.srcObject = liveStream;
    try { await video.play(); } catch {}

    camContainer.style.display = 'block';
    btnSnap.style.display = 'block';
    btnOpen.style.display = 'none';
    statusEl.innerText = "âœ… ××¦×œ××” ×¤×ª×•×—×”. ×œ×—×¥ ×œ×¦×™×œ×•×.";
  }

  btnOpen.onclick = () => openLiveCamera();

  btnSnap.onclick = () => {
    if (!video.videoWidth || !video.videoHeight) {
      alert("×”××¦×œ××” ×¢×“×™×™×Ÿ ×œ× ××•×›× ×”. × ×¡×” ×©×•×‘ ×‘×¢×•×“ ×©× ×™×™×”.");
      return;
    }
    const c = document.createElement('canvas');
    c.width = video.videoWidth; c.height = video.videoHeight;
    c.getContext('2d').drawImage(video, 0, 0);
    const data = c.toDataURL('image/jpeg', 0.92);
    processPhoto(data);
  };

  function processPhoto(data) {
    if (mode === 'before') {
      beforeImg = new Image();
      beforeImg.onload = () => {
        document.getElementById('imgB').src = data;
        mode = 'after';
        statusEl.innerText = "××¢×•×œ×”! ×¢×›×©×™×• ×¦×œ× ××ª ×”'××—×¨×™'";
        // ××©××™×¨ ××¦×œ××” ×¤×ª×•×—×” + ×›×•×•× ×ª, ×××©×™×›×™× ×œ×¦×™×œ×•× ×”×‘×
        btnOpen.style.display = 'none';
        camContainer.style.display = 'block';
        btnSnap.style.display = 'block';
      };
      beforeImg.src = data;
    } else {
      afterImg = new Image();
      afterImg.onload = () => {
        document.getElementById('imgA').src = data;

        stopLiveCamera();

        camContainer.style.display = 'none';
        btnSnap.style.display = 'none';
        document.getElementById('ui-capture').style.display = 'none';

        initAdjust();
      };
      afterImg.src = data;
    }
  }

  function initAdjust() {
    adjustArea.style.display = 'block';
    btnCreate.style.display = 'block';

    adjustCanvas.width = beforeImg.naturalWidth || beforeImg.width;
    adjustCanvas.height = beforeImg.naturalHeight || beforeImg.height;

    offsetX = 0; offsetY = 0;
    drawAdjust();
  }

  function drawAdjust() {
    const ctx = adjustCanvas.getContext('2d');
    const w = adjustCanvas.width, h = adjustCanvas.height;
    ctx.clearRect(0,0,w,h);

    ctx.globalAlpha = 1;
    ctx.drawImage(beforeImg, 0, 0, w, h);

    ctx.globalAlpha = 0.5;
    ctx.drawImage(afterImg, offsetX, offsetY, w, h);

    // ××©××™×¨ ××ª ×§×• ×”×”×ª×××” ×‘×§× ×‘×¡ ×›××• ×©×”×™×” ××¦×œ×š (25%)
    ctx.globalAlpha = 1;
    ctx.strokeStyle = "yellow";
    ctx.lineWidth = 10;
    ctx.beginPath();
    ctx.moveTo(0, h*0.25);
    ctx.lineTo(w, h*0.25);
    ctx.stroke();
  }

  /* âœ… ×’×¨×™×¨×” ×—×•×¤×©×™×ª X+Y (×’× ×œ×˜××¥' ×•×’× ×œ×¢×›×‘×¨) */
  let isDrag = false;
  let startPX = 0, startPY = 0;
  let startOX = 0, startOY = 0;

  function getPoint(e) {
    if (e.touches && e.touches[0]) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
    return { x: e.clientX, y: e.clientY };
  }

  function dragStart(e) {
    isDrag = true;
    const p = getPoint(e);
    startPX = p.x; startPY = p.y;
    startOX = offsetX; startOY = offsetY;
    e.preventDefault?.();
  }

  function dragMove(e) {
    if (!isDrag) return;
    const p = getPoint(e);
    const dx = p.x - startPX;
    const dy = p.y - startPY;

    // ×××™×¨×™× ×ª×–×•×–×” ×¢×œ ×”××¡×š ×œâ€×¤×™×§×¡×œ×™×â€ ×©×œ ×”×§× ×‘×¡
    const rect = adjustCanvas.getBoundingClientRect();
    const scaleX = adjustCanvas.width / rect.width;
    const scale
