<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>BUYRU â€“ ×¡×¨×™×§×ª ×‘×¨×§×•×“ ×•×ª××•× ×ª ××•×¦×¨</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f172a;           /* slate-900 */
    --card:#0b1224;         /* deep */
    --panel:#111b34;        /* mid */
    --ink:#f8fafc;          /* almost white */
    --muted:#9aa8c7;        /* slate-400 */
    --accent:#22c55e;       /* green-500 */
    --accent-2:#38bdf8;     /* sky-400 */
    --danger:#ef4444;
    --gold:#fbbf24;
    --radius:18px;
    --shadow:0 20px 50px rgba(0,0,0,.35);
    --border:1px solid rgba(255,255,255,.08);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    font-family:Heebo,system-ui,Arial; margin:0; color:var(--ink);
    background:
      radial-gradient(1200px 600px at 90% -10%, #143b56 0%, transparent 60%),
      radial-gradient(900px 500px at -10% 0%, #0f3c2a 0%, transparent 55%),
      var(--bg);
  }
  .wrap{max-width:880px;margin:0 auto;padding:18px 18px 28px}
  header{
    display:flex;justify-content:space-between;align-items:center;margin-bottom:14px
  }
  .title{display:flex;gap:12px;align-items:center}
  .logo{
    width:42px;height:42px;border-radius:12px;display:grid;place-items:center;
    background:linear-gradient(135deg, var(--accent), var(--accent-2));
    color:#002; font-weight:800; box-shadow:var(--shadow)
  }
  h1{font-size:22px;margin:0}
  .sub{color:var(--muted);font-size:14px;margin-top:4px}

  .surface{
    background:rgba(255,255,255,.03); border-radius:var(--radius); border:var(--border);
    box-shadow:var(--shadow); overflow:hidden
  }

  /* ××–×•×¨ ××™× ×˜×¨××§×¦×™×” */
  .hero{
    padding:18px;
    display:grid; gap:16px;
  }
  .drop{
    border:2px dashed rgba(255,255,255,.14);
    border-radius:16px; padding:18px; text-align:center;
    background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00));
    transition:.2s border-color;
  }
  .drop.drag{ border-color: var(--accent) }
  .drop h2{margin:0 0 6px 0; font-size:16px}
  .drop p{margin:0; color:var(--muted); font-size:14px}
  .actions{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:14px}
  .btn{
    padding:12px 16px;border:0;border-radius:12px;cursor:pointer;font-weight:700;
    display:inline-flex;gap:8px;align-items:center
  }
  .btn.primary{background:var(--accent);color:#062;box-shadow:0 8px 24px rgba(34,197,94,.35)}
  .btn.secondary{background:#0f1b35;color:#dbeafe;border:var(--border)}
  .btn.ghost{background:transparent;color:#e2e8f0;border:var(--border)}
  .btn.icon{width:44px;height:44px;justify-content:center;padding:0}

  /* ××¦×‘/×˜×•×¡×˜ */
  .status{
    background:var(--panel); border:var(--border); border-radius:12px; padding:12px 14px;
    font-size:14px; display:flex;align-items:center;gap:10px
  }
  .dot{width:10px;height:10px;border-radius:50%}
  .ok{background:var(--accent)} .warn{background:var(--gold)} .err{background:var(--danger)}

  /* ×›×¨×˜×™×¡ ×ª×•×¦××” */
  .result{
    display:grid; gap:12px; padding:16px; background:var(--card); border:var(--border); border-radius:16px;
  }
  .meta{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .tag{padding:6px 10px;background:#0c1a31;border-radius:999px;border:var(--border);color:#cbd5e1;font-size:12px}
  .thumb{
    width:100%; max-height:260px; object-fit:contain; border-radius:12px; background:#000;
  }
  .product{
    width:100%; border-radius:14px; background:#000; box-shadow:var(--shadow);
  }
  .grid{display:grid; gap:16px}
  @media(min-width:780px){
    .grid{grid-template-columns: 1.3fr 1fr}
  }
  .links{display:flex;flex-wrap:wrap;gap:8px}
  .links .btn{padding:10px 12px;border-radius:10px}
  .hint{font-size:12px;color:var(--muted)}

  /* ×”×™×¡×˜×•×¨×™×” */
  .history{
    display:flex; gap:10px; overflow:auto; padding:10px 4px 4px
  }
  .pill{
    background:#0c1a31;border:var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:#cbd5e1;cursor:pointer;white-space:nowrap
  }

  /* ×›×¤×ª×•×¨ ×¦×™×œ×•× ×¦×£ ×‘××•×‘×™×™×œ */
  .fab{
    position:fixed; right:16px; bottom:16px; width:58px; height:58px; border-radius:50%;
    display:grid; place-items:center; background:linear-gradient(135deg, var(--accent), var(--accent-2));
    color:#021; font-weight:900; font-size:20px; border:0; box-shadow:0 14px 40px rgba(56,189,248,.35); z-index:5
  }

  .foot{margin-top:18px;text-align:center;color:var(--muted);font-size:12px}
  .hide{display:none!important}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <div class="logo">BR</div>
      <div>
        <h1>BUYRU â€“ ×¡×¨×™×§×ª ×‘×¨×§×•×“ ×•×ª××•× ×ª ××•×¦×¨</h1>
        <div class="sub">××¦×œ×/×‘×•×—×¨ ×ª××•× ×” â†’ ××–×”×” ×‘×¨×§×•×“ â†’ ××¦×™×’ ×ª××•× ×ª ××•×¦×¨ (Open*Facts / ×¨××™-×œ×•×™)</div>
      </div>
    </div>
  </header>

  <section class="surface hero">
    <div id="httpsWarn" class="status hide">
      <div class="dot warn"></div>
      <div>×œ×¦×™×œ×•× ×™×© ×œ×”×©×ª××© ×‘-<b>https://</b>.  
        <a id="httpsLink" href="#" style="color:#93c5fd;text-decoration:none">×¤×ª×— ×‘-HTTPS</a></div>
    </div>

    <div id="drop" class="drop">
      <h2>×¦×œ× ××• ×’×¨×•×¨ ×ª××•× ×” ×¢× ×‘×¨×§×•×“</h2>
      <p>××•××œ×¥ ×œ×”×ª×§×¨×‘ ×›×š ×©×”×‘×¨×§×•×“ ×—×“, ××•××¨ ×•×™×©×¨</p>
      <div class="actions">
        <input id="capture" type="file" accept="image/*" capture="environment" class="hide">
        <button class="btn primary" id="btnShot">ğŸ“· ×¦×œ× ×•×¡×¨×•×§</button>
        <button class="btn secondary" id="btnPick">ğŸ–¼ï¸ ×‘×—×¨ ××”×’×œ×¨×™×”</button>
        <input id="manual" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="××• ×”×–×Ÿ ×‘×¨×§×•×“ ×™×“× ×™×ªâ€¦" style="flex:1;min-width:220px;padding:12px 14px;border-radius:12px;border:var(--border);background:#0b1630;color:#e5e7eb">
        <button class="btn ghost" id="btnLookup">×—×¤×©</button>
      </div>
    </div>

    <div id="state" class="status"><div class="dot ok" id="stateDot"></div><div id="stateMsg">××•×›×Ÿ.</div></div>

    <div class="grid">
      <div class="result" id="resultBox" style="display:none">
        <div class="meta">
          <span class="tag" id="barTag">×‘×¨×§×•×“: â€”</span>
          <span class="tag" id="fmtTag">×¤×•×¨××˜: â€”</span>
          <span class="tag" id="srcTag">××§×•×¨: â€”</span>
        </div>
        <img id="productImg" class="product" alt="×ª××•× ×ª ××•×¦×¨" />
        <div class="links" id="quickLinks"></div>
        <div class="hint">×× ×œ× × ××¦××” ×ª××•× ×” â€“ × ×¡×” ×œ×¦×œ× ×©×•×‘ ××§×¨×•×‘ ×•×‘×¤×•×§×•×¡, ××• ×”×–×Ÿ ×‘×¨×§×•×“ ×™×“× ×™×ª.</div>
      </div>

      <div class="result">
        <div class="meta"><span class="tag">×ª×¦×•×’×” ××§×“×™××” ×©×œ ×”×ª××•× ×” ×©×¦×•×œ××”</span></div>
        <img id="thumb" class="thumb" alt="" />
        <div class="history" id="history"></div>
      </div>
    </div>
  </section>

  <button class="fab" id="fab">ï¼‹</button>

  <footer class="foot">v2.5.0 â€¢ BUYRU â€¢ ×¢×™×¦×•×‘ × ×§×™, ××™×™×§×•× ×™×, ×”×™×¡×˜×•×¨×™×”, ×©×™×ª×•×£/×”×¢×ª×§×” â€¢ by Charles2K</footer>
</div>

<!-- ZXing ×›×’×™×‘×•×™ ×œ×¤×¢× ×•×— ×ª××•× ×” -->
<script src="https://unpkg.com/@zxing/browser@0.1.1"></script>
<script>
/* ====== ×¢×–×¨×™ UI ====== */
const qs = s=>document.querySelector(s);
const stateMsg = qs('#stateMsg');
const stateDot = qs('#stateDot');
function setState(type,msg){
  stateDot.className='dot';
  if(type==='ok') stateDot.classList.add('ok');
  else if(type==='warn') stateDot.classList.add('warn');
  else stateDot.classList.add('err');
  stateMsg.textContent = msg;
}
function toastOK(m){ setState('ok', m) }
function toastWarn(m){ setState('warn', m) }
function toastErr(m){ setState('err', m) }

/* ====== ××œ×× ×˜×™× ====== */
const httpsWarn = qs('#httpsWarn'); const httpsLink = qs('#httpsLink');
const capture = qs('#capture'); const btnShot = qs('#btnShot'); const btnPick = qs('#btnPick'); const fab = qs('#fab');
const drop = qs('#drop');
const manual = qs('#manual'); const btnLookup = qs('#btnLookup');
const thumb = qs('#thumb'); const resultBox = qs('#resultBox'); const productImg = qs('#productImg');
const barTag = qs('#barTag'); const fmtTag = qs('#fmtTag'); const srcTag = qs('#srcTag');
const quickLinks = qs('#quickLinks'); const historyEl = qs('#history');

let lastCode=''; let lastFormat=''; let history=[];

/* ====== HTTPS ×‘×“×™×§×” ====== */
(function httpsBanner(){
  const isLocal=/^(localhost|127\.0\.0\.1)$/.test(location.hostname);
  if(location.protocol!=='https:' && !isLocal){
    httpsWarn.classList.remove('hide');
    httpsLink.href='https://' + location.host + location.pathname;
  }
})();

/* ====== ×œ×•×’×™×§×ª ××¦×™××ª ×ª××•× ×•×ª ×œ×¤×™ ×‘×¨×§×•×“ (Open*Facts + ×¨××™ ×œ×•×™) ====== */
function gtinToPath(code){ const c=(code||'').replace(/\D/g,''); const p=[]; for(let i=0;i<c.length;i+=3)p.push(c.slice(i,i+3)); return p.join('/'); }
function openFactsCandidates(code){
  const base=['https://images.openfoodfacts.org/images/products/','https://images.openbeautyfacts.org/images/products/','https://images.openproductsfacts.org/images/products/'];
  const path=gtinToPath(code);
  return [`${base[0]}${path}/front.400.jpg`,`${base[0]}${path}/front.jpg`,`${base[1]}${path}/front.400.jpg`,`${base[1]}${path}/front.jpg`,`${base[2]}${path}/front.400.jpg`,`${base[2]}${path}/front.jpg`];
}
function ramiLevyCandidates(code){
  const base=`https://img.rami-levy.co.il/product/${code}`;
  return [`${base}/small.jpg`,`${base}/large.jpg`,`https://www.rami-levy.co.il/_ipx/w_500,f_webp/${base}/small.jpg`,`https://www.rami-levy.co.il/_ipx/w_800,f_webp/${base}/large.jpg`];
}
function firstWorkingImage(urls){ return new Promise(res=>{ let i=0; (function next(){ if(i>=urls.length) return res({ok:false}); const url=urls[i++]; const im=new Image(); im.onload=()=>res({ok:true,url,src: url.includes('rami-levy')?'Rami-Levy':'OpenFacts'}); im.onerror=next; im.src=url+`?t=${Date.now()}`; })(); }); }
async function fetchProductImage(code){
  const tries=[...openFactsCandidates(code),...ramiLevyCandidates(code)];
  return await firstWorkingImage(tries);
}

/* ====== ×¤×¢× ×•×— ×‘×¨×§×•×“ ××ª×•×š ×ª××•× ×” ====== */
async function toBitmap(file){
  try{ return await createImageBitmap(file); }
  catch{
    const img = new Image(); const url=URL.createObjectURL(file);
    img.src=url; await img.decode();
    const c=document.createElement('canvas'); c.width=img.naturalWidth; c.height=img.naturalHeight;
    c.getContext('2d').drawImage(img,0,0); URL.revokeObjectURL(url);
    return await createImageBitmap(c);
  }
}
async function decodeFromBitmap(bitmap){
  // 1) ×¢×“×™×¤×•×ª ×œ-BarcodeDetector ×× ×§×™×™×
  if('BarcodeDetector' in window){
    try{
      const det = new window.BarcodeDetector({ formats:['ean_13','ean_8','upc_a','upc_e','code_128','code_39','itf','qr_code'] });
      const res = await det.detect(bitmap);
      if(res && res.length) return { code:(res[0].rawValue||'').trim(), fmt:res[0].format||'detector' };
    }catch(e){ /* ×××©×™×›×™× ×œ×’×™×‘×•×™ */ }
  }
  // 2) ×’×™×‘×•×™ ZXing
  try{
    const cnv=document.createElement('canvas'), MAX=1400, scale=Math.min(1, MAX/bitmap.width);
    cnv.width=Math.round(bitmap.width*scale); cnv.height=Math.round(bitmap.height*scale);
    cnv.getContext('2d').drawImage(bitmap,0,0,cnv.width,cnv.height);
    const im=new Image(); im.src=cnv.toDataURL('image/png'); await im.decode();
    const reader = new ZXing.BrowserMultiFormatReader();
    const result = await reader.decodeFromImageElement(im).catch(()=>null);
    if(result?.text) return { code: result.text.trim(), fmt: result.getBarcodeFormat?.() || 'zxing' };
  }catch(e){}
  return { code:'', fmt:'' };
}

/* ====== UI ×¢×™×§×¨×™ ====== */
function setThumb(file){
  const url = URL.createObjectURL(file);
  thumb.src=url; thumb.onload = ()=> URL.revokeObjectURL(url);
}
function setQuickLinks(code){
  quickLinks.innerHTML='';
  const mk=(txt,href)=>`<a class="btn ghost" target="_blank" rel="noopener" href="${href}">${txt}</a>`;
  quickLinks.innerHTML = [
    mk('ğŸ” ×’×•×’×œ ×ª××•× ×•×ª', `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(code)}`),
    mk('ğŸ›’ ×©×•×¤×¨×¡×œ', `https://www.shufersal.co.il/online/he/search?text=${encodeURIComponent(code)}`),
    mk('ğŸ›’ ×¨××™ ×œ×•×™', `https://www.rami-levy.co.il/he/Search?search=${encodeURIComponent(code)}`),
    `<button class="btn ghost" id="copyBtn">ğŸ“‹ ×”×¢×ª×§ ×‘×¨×§×•×“</button>`,
    `<button class="btn ghost" id="shareBtn">ğŸ”— ×©×ª×£</button>`
  ].join(' ');
  qs('#copyBtn').onclick = async()=>{ await navigator.clipboard.writeText(code); toastOK('×”×‘×¨×§×•×“ ×”×•×¢×ª×§.'); };
  qs('#shareBtn').onclick = async()=>{
    const text=`×‘×¨×§×•×“: ${code}\n×§×™×©×•×¨×™× ××”×™×¨×™×:\n`+
      `Google: https://www.google.com/search?tbm=isch&q=${encodeURIComponent(code)}\n`+
      `×©×•×¤×¨×¡×œ: https://www.shufersal.co.il/online/he/search?text=${encodeURIComponent(code)}\n`+
      `×¨××™ ×œ×•×™: https://www.rami-levy.co.il/he/Search?search=${encodeURIComponent(code)}`;
    if(navigator.share){ try{ await navigator.share({title:'BUYRU', text}); }catch{} }
    else { await navigator.clipboard.writeText(text); toastOK('×”×¤×¨×˜×™× ×”×•×¢×ª×§×• ×œ×©×™×ª×•×£.'); }
  };
}
function pushHistory(code){
  if(!code) return;
  history = [code, ...history.filter(c=>c!==code)].slice(0,12);
  renderHistory();
}
function renderHistory(){
  historyEl.innerHTML = history.map(c=>`<div class="pill" data-code="${c}">${c}</div>`).join('');
  historyEl.querySelectorAll('.pill').forEach(el=> el.onclick = ()=> showByCode(el.dataset.code,'History') );
}

async function showByCode(code, sourceLabel='Manual'){
  if(!code) return;
  lastCode=code; barTag.textContent = `×‘×¨×§×•×“: ${code}`;
  fmtTag.textContent  = `×¤×•×¨××˜: â€”`;
  srcTag.textContent  = `××§×•×¨: â€”`;
  productImg.removeAttribute('src');
  resultBox.style.display='block';
  setState('ok','××—×¤×© ×ª××•× ×ª ××•×¦×¨â€¦');
  const got = await fetchProductImage(code);
  if(got.ok){
    productImg.src = got.url;
    srcTag.textContent = `××§×•×¨: ${got.src}`;
    setState('ok','× ××¦××” ×ª××•× ×ª ××•×¦×¨');
  }else{
    productImg.removeAttribute('src');
    srcTag.textContent = `××§×•×¨: â€”`;
    setState('warn','×œ× × ××¦××” ×ª××•× ×” â€“ × ×¡×” ×œ×¦×œ× ×©×•×‘ ××• ×œ×—×¤×©');
  }
  setQuickLinks(code);
  pushHistory(code);
}

async function processFile(file){
  if(!file){ toastWarn('×œ× × ×‘×—×¨ ×§×•×‘×¥'); return; }
  setThumb(file);
  setState('ok','××–×”×” ×‘×¨×§×•×“ ××”×¦×™×œ×•×â€¦');
  const bmp = await toBitmap(file);
  const {code, fmt} = await decodeFromBitmap(bmp);
  if(code){
    fmtTag.textContent = `×¤×•×¨××˜: ${fmt||'× ×–×”×”'}`;
    await showByCode(code, 'Image');
  }else{
    fmtTag.textContent = `×¤×•×¨××˜: â€”`;
    resultBox.style.display='block';
    productImg.removeAttribute('src');
    setState('err','×œ× ×–×•×”×” ×‘×¨×§×•×“ â€“ ×¦×œ× ×§×¨×•×‘/×—×“ ×™×•×ª×¨');
  }
}

/* ====== ××™×¨×•×¢×™× ====== */
btnShot.onclick = ()=> { capture.setAttribute('capture','environment'); capture.click(); };
btnPick.onclick = ()=> { capture.removeAttribute('capture'); capture.click(); };
fab.onclick     = ()=> { capture.setAttribute('capture','environment'); capture.click(); };
capture.onchange= (e)=> { const f=e.target.files?.[0]; if(f) processFile(f); e.target.value=''; };

btnLookup.onclick = ()=> showByCode(manual.value.trim(),'Manual');
manual.addEventListener('keydown', e=>{ if(e.key==='Enter') showByCode(manual.value.trim(),'Manual'); });

['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.add('drag'); }));
['dragleave','drop'].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.remove('drag'); }));
drop.addEventListener('drop', e=>{
  const f = e.dataTransfer?.files?.[0]; if(f) processFile(f);
});

/* ====== ××ª×—×•×œ ====== */
(function init(){
  // ×”×™×¡×˜×•×¨×™×” ××§×•××™×ª
  try{
    const raw = localStorage.getItem('buyru_history'); if(raw) history = JSON.parse(raw)||[];
  }catch{}
  renderHistory();
  const saveHist = ()=>{ try{ localStorage.setItem('buyru_history', JSON.stringify(history)); }catch{} };
  window.addEventListener('beforeunload', saveHist);

  toastOK('××•×›×Ÿ â€“ ×¦×œ× ××• ×‘×—×¨ ×ª××•× ×” ×¢× ×‘×¨×§×•×“.');
})();
</script>
</body>
</html>
