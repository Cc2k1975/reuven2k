<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>זמיר 15 - שער</title>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: white; margin: 0; text-align: center; }
        header { background: #000; padding: 20px; border-bottom: 2px solid #3498db; }
        #grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 20px; }
        .btn { background: #2d2d2d; padding: 20px; border-radius: 10px; cursor: pointer; border: 1px solid #444; }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        video { width: 80%; max-width: 300px; border: 2px solid #3498db; border-radius: 10px; }
    </style>
</head>
<body>
    <header><h1>זמיר 15</h1></header>
    <div id="grid"></div>
    <div id="status" class="overlay">
        <video id="localVideo" autoplay playsinline muted></video>
        <h2 id="statusText">מחייג...</h2>
        <button onclick="location.reload()" style="padding:15px; background:#e74c3c; color:white; border:none; border-radius:5px;">ביטול</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyALAVQSl6FcuF0HYhCfIgVz-GUMSJKcT5c",
            authDomain: "zamir15-intercom.firebaseapp.com",
            projectId: "zamir15-intercom",
            storageBucket: "zamir15-intercom.firebasestorage.app",
            messagingSenderId: "823056442276",
            appId: "1:823056442276:web:a4235e2219152bb6789731"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });

        const grid = document.getElementById('grid');
        for (let i = 1; i <= 24; i++) {
            const div = document.createElement('div');
            div.className = 'btn';
            div.innerHTML = `דירה ${i}`;
            div.onclick = () => startCall(i);
            grid.appendChild(div);
        }

        async function startCall(aptId) {
            document.getElementById('status').style.display = 'flex';
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('localVideo').srcObject = stream;
            stream.getTracks().forEach(t => pc.addTrack(t, stream));

            const callDoc = doc(collection(db, "calls"));
            pc.onicecandidate = (e) => e.candidate && addDoc(collection(callDoc, "offerCandidates"), e.candidate.toJSON());

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            await setDoc(callDoc, { apartment: aptId, status: "dialing", offer: { type: offer.type, sdp: offer.sdp }, createdAt: serverTimestamp() });

            onSnapshot(callDoc, (s) => {
                const d = s.data();
                if (d?.answer && !pc.currentRemoteDescription) pc.setRemoteDescription(new RTCSessionDescription(d.answer));
                if (d?.status === "opened") location.reload();
            });

            onSnapshot(collection(callDoc, "answerCandidates"), (s) => {
                s.docChanges().forEach(c => c.type === "added" && pc.addIceCandidate(new RTCIceCandidate(c.doc.data())));
            });
        }
    </script>
</body>
</html>
7
