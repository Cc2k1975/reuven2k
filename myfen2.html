<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>×¤×Ÿ ××§×¡×¤×¨×¡ â€“ ×¦'××˜ ×œ×–×™××•×Ÿ ×ª×•×¨</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#d4af37">
<link rel="apple-touch-icon" href="/Icon app.png" />

<style>
  :root{
    --gold:#b89016;
    --gold2:#d4af37;
    --bg:#f4f4f6;
    --card:#ffffff;
    --text:#111;
    --muted:#555;
    --border:#e3e3e7;
    --bot:#fff7dd;
    --me:#d4af37;
  }

  body{
    font-family: Arial, Helvetica, sans-serif;
    background: var(--bg);
    margin:0;
    color: var(--text);
  }

  .hero-logo{
    width: 96px;
    display:block;
    margin: 10px auto 0 auto;
  }

  .wrap{
    max-width: 560px;
    margin: 10px auto 18px;
    padding: 16px 14px 14px;
    background: var(--card);
    border-radius: 18px;
    box-shadow: 0 10px 26px rgba(0,0,0,.08);
    border:1px solid var(--border);
  }

  h1{
    margin: 6px 0 2px;
    font-size: 34px;
    text-align:center;
    color: var(--gold);
    letter-spacing: .2px;
  }

  h2{
    margin: 0 0 12px;
    font-size: 20px;
    text-align:center;
    color: var(--muted);
  }

  .chat{
    height: min(66vh, 560px);
    overflow:auto;
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: 16px;
    background: #fbfbfc;
  }

  .row{
    display:flex;
    margin: 10px 0;
  }

  .bubble{
    max-width: 92%;
    padding: 12px 14px;
    border-radius: 16px;
    line-height: 1.45;
    font-size: 19px;              /* ×’×“×•×œ ×•×‘×¨×•×¨ */
    white-space: pre-line;
  }

  .bot{ justify-content: flex-end; }
  .bot .bubble{
    background: var(--bot);
    border: 1px solid rgba(212,175,55,.55);
    color: #1a1a1a;
    border-bottom-right-radius: 8px;
  }

  .me{ justify-content: flex-start; }
  .me .bubble{
    background: var(--me);
    color: #000;
    font-weight: 800;
    border-bottom-left-radius: 8px;
  }

  .hint{
    font-size: 15.5px;
    color: var(--muted);
    margin-top: 10px;
    line-height: 1.3;
  }

  .composer{
    display:flex;
    gap: 10px;
    margin-top: 12px;
    align-items:center;
  }

  #input{
    flex:1;
    padding: 14px 14px;
    border: 1px solid var(--border);
    border-radius: 14px;
    font-size: 19px;              /* ×’×“×•×œ ×•×‘×¨×•×¨ */
    background: #fff;
    color: var(--text);
    outline: none;
  }

  #send{
    width: 94px;
    padding: 14px 10px;
    border-radius: 14px;
    border:0;
    background: var(--gold2);
    color:#000;
    font-weight: 900;
    font-size: 18px;
    cursor:pointer;
  }

  #send[disabled], #input[disabled]{ opacity:.65; cursor:not-allowed; }

  .error{
    background: #ffe8e8;
    color: #a10000;
    border: 1px solid #ffbcbc;
    padding: 10px 12px;
    border-radius: 14px;
    margin: 10px 0 12px;
    display:none;
    font-size: 17px;
    line-height:1.35;
  }

  .success{
    background: #e8fff0;
    color: #0c6b2e;
    border: 1px solid #b9f3cd;
    padding: 10px 12px;
    border-radius: 14px;
    margin: 10px 0 12px;
    display:none;
    font-size: 17px;
    line-height:1.35;
  }

  .toolbar{
    display:flex;
    gap: 10px;
    margin-top: 12px;
  }

  .btn-secondary{
    flex:1;
    background:#fff;
    color: var(--gold);
    border:1px solid rgba(212,175,55,.65);
    padding: 12px 10px;
    border-radius: 14px;
    cursor:pointer;
    font-weight: 900;
    font-size: 16.5px;
  }

  .btn-secondary img.icon{
    width: 22px;
    height: 22px;
    vertical-align: middle;
    margin: 0 6px;
  }

  .ver{
    margin-top: 12px;
    font-size: 12.8px;
    color: #777;
    text-align:center;
  }

  /* Modal (× ×©××¨ ×›××• ××¦×œ×š) */
  .modal-backdrop{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.72);
    display:none;
    align-items:center;
    justify-content:center;
    z-index: 50;
  }

  .modal{
    background:#fff;
    border-radius: 16px;
    max-width: 440px;
    width: 92%;
    padding: 18px 18px 12px;
    box-shadow: 0 16px 40px rgba(0,0,0,.28);
    color:#111;
  }

  .modal h3{
    margin: 0 0 8px;
    font-size: 22px;
    color: #111;
  }

  .modal p{
    margin: 0 0 14px;
    color:#111;
    white-space: pre-line;
    font-size: 17px;
    line-height:1.35;
  }

  .modal .row2{
    display:flex;
    gap: 10px;
    justify-content: space-between;
  }

  .modal .row2 button{
    flex: 1;
    padding: 12px;
    border-radius: 12px;
    border:0;
    font-weight: 900;
    font-size: 16.5px;
    cursor:pointer;
  }

  .modal .cancel{
    background:#fff;
    color:#111;
    border:1px solid #bbb;
  }

  .modal .ok{
    background: var(--gold2);
    color:#000;
  }
</style>
</head>
<body>

<img src="https://reuven2k.com/exe.gif" alt="×¤×Ÿ ××§×¡×¤×¨×¡" class="hero-logo" />

<div class="wrap">
  <h1>×¤×Ÿ ××§×¡×¤×¨×¡</h1>
  <h2>×¦'××˜ ×œ×–×™××•×Ÿ ×ª×•×¨×™×</h2>

  <div id="msgError" class="error"></div>
  <div id="msgOk" class="success"></div>

  <div id="chat" class="chat" aria-live="polite"></div>
  <div class="hint" id="hintText"></div>

  <div class="composer">
    <input id="input" type="text" placeholder="×›×ª×•×‘ ×›××Ÿ..." autocomplete="off" inputmode="text" />
    <button id="send">×©×œ×—</button>
  </div>

  <div class="toolbar">
    <button id="galleryBtn" type="button" class="btn-secondary"><b>×’×œ×¨×™×™×ª ×¢×‘×•×“×•×ª</b></button>
    <button id="navWaze" type="button" class="btn-secondary">
      <b>× ×•×•×˜ ×œ ×¤×Ÿ-××§×¡×¤×¨×¡</b>
      <img class="icon" src="https://reuven2k.com/map.png" alt="" />
    </button>
  </div>

  <div class="ver">Version: 1.6.2-chat-light</div>
</div>

<div id="icsModal" class="modal-backdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <h3>×œ×”×•×¡×™×£ ×ª×–×›×•×¨×ª ×œ×™×•××Ÿ?</h3>
    <p id="icsText">× ×™×¦×•×¨ ××™×¨×•×¢ ×œ×™×•××Ÿ ×‘×ª××¨×™×š ___ ×‘×©×¢×” ___ ×›×•×œ×œ ×ª×–×›×•×¨×ª ×©×¢×” ×œ×¤× ×™.
×œ×§×•×—×” ×™×§×¨×”, ××–×›×™×¨×” ×œ×š ×œ×”×’×™×¢ ×—×¤×•×¤×” ×•×‘×–××Ÿ ğŸ’‡â€â™€ï¸
×ª×•×“×” - ×¤×Ÿ ××§×¡×¤×¨×¡</p>
    <div class="row2">
      <button type="button" class="cancel" id="btnCancel">×‘×™×˜×•×œ</button>
      <button type="button" class="ok" id="btnOk">××™×©×•×¨</button>
    </div>
  </div>
</div>

<script>
/* ===== Backend × ×©××¨ ×‘×“×™×•×§ ×›××• ××¦×œ×š ===== */
const BIN_ID = '68f0e7bed0ea881f40a63b29';
const MASTER_KEY = '$2a$10$4rynniEMuvwqg2nDb5KSEe/lAVYp8a7L3xWzp9GsO6n49OfXc3FCO';
const BIN_URL = 'https://api.jsonbin.io/v3/b/' + BIN_ID;

const MAP_URL = 'https://maps.google.com/?q=33.003292,35.108864';
const WAZE_DEEP = 'waze://?ll=33.003292,35.108864&navigate=yes';
const WAZE_WEB  = 'https://waze.com/ul?ll=33.003292%2C35.108864&navigate=yes';
const GALLERY_URL = 'https://reuven2k.com/images/index.html';

const TIMEZONE = 'Asia/Jerusalem';
const EVENT_TITLE = '×ª×•×¨ ×œ ×¤×Ÿ ××§×¡×¤×¨×¡';
const ALARM_MINUTES = 60;
const SLOT_MINUTES = 20;

const pad2 = n => (n<10?('0'+n):''+n);

/* ===== ×¡×œ×•×˜×™× 20 ×“×§×•×ª: 08:00â€“20:00 ===== */
function genTimeSlots(){
  const slots=[];
  for(let h=8; h<=20; h++){
    for(let m of [0,20,40]){
      if(h===20 && m>0) continue;
      slots.push(`${pad2(h)}:${pad2(m)}`);
    }
  }
  return slots;
}
const SLOTS = genTimeSlots();

function todayStr(){ return new Date().toISOString().slice(0,10); }
function addDaysStr(days){ const d=new Date(); d.setDate(d.getDate()+days); return d.toISOString().slice(0,10); }
function fmtDateHeb(s){ const [y,m,d]=s.split('-'); return `${d}.${m}.${y}`; }

function validPhone(p){ return (p||'').replace(/\D/g,'').length>=8; }
function normalizePhone(p){ return (p||'').replace(/\D/g,''); }

let BOOKING_OPEN = true;

async function fetchRecord(){
  const r = await fetch(BIN_URL+'?ts='+Date.now(), { headers:{'X-Master-Key':MASTER_KEY}, cache:'no-store' });
  if(!r.ok) throw new Error('fetch failed');
  const j = await r.json();
  const rec = (j.record && Array.isArray(j.record.bookings)) ? j.record : {bookings:[]};
  BOOKING_OPEN = (typeof rec.bookingOpen === 'boolean') ? rec.bookingOpen : true;
  return rec;
}

async function putRecord(rec){
  const r = await fetch(BIN_URL+'?ts='+Date.now(), {
    method:'PUT',
    headers:{'Content-Type':'application/json','X-Master-Key':MASTER_KEY},
    body: JSON.stringify(rec),
    cache:'no-store'
  });
  if(!r.ok) throw new Error('put failed');
  return r.json().catch(()=> ({}));
}

/* ===== ICS (×›××• ××¦×œ×š) ===== */
function toICSLocal(dateStr,timeStr){
  const [y,m,d]=dateStr.split('-').map(Number);
  const [hh,mm]=timeStr.split(':').map(Number);
  const dt=new Date(y,m-1,d,hh,mm,0);
  return `${dt.getFullYear()}${pad2(dt.getMonth()+1)}${pad2(dt.getDate())}T${pad2(dt.getHours())}${pad2(dt.getMinutes())}00`;
}
function buildICS({title,location,startLocal,endLocal,tzid}){
  const uid=`${Date.now()}-${Math.random().toString(36).slice(2)}@fenexpress`;
  const dtstamp=new Date().toISOString().replace(/[-:]/g,'').replace(/\.\d{3}Z$/,'Z');
  const details=`×§×™×©×•×¨ ×™×©×™×¨ ×œ×”×’×¢×” ×œ×¤×Ÿ ××§×¡×¤×¨×¡:\n${MAP_URL}`;
  return [
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//FenExpress//Booking//HE',
    'CALSCALE:GREGORIAN',
    'METHOD:PUBLISH',
    'BEGIN:VEVENT',
    `UID:${uid}`,
    `DTSTAMP:${dtstamp}`,
    `DTSTART;TZID=${tzid}:${startLocal}`,
    `DTEND;TZID=${tzid}:${endLocal}`,
    `SUMMARY:${title}`,
    `DESCRIPTION:${details.replace(/\n/g,'\\n')}`,
    `LOCATION:${location}`,
    'BEGIN:VALARM',
    'ACTION:DISPLAY',
    'DESCRIPTION:Reminder',
    `TRIGGER:-PT${ALARM_MINUTES}M`,
    'END:VALARM',
    'END:VEVENT',
    'END:VCALENDAR'
  ].join('\r\n');
}
function openCalendarDirect(dateStr,timeStr){
  const ua = navigator.userAgent || '';
  const isAndroid = /Android/i.test(ua);
  const isIOS = /iPhone|iPad|iPod/i.test(ua);

  const [y,m,d]=dateStr.split('-').map(Number);
  const [hh,mm]=timeStr.split(':').map(Number);
  const start=new Date(y,m-1,d,hh,mm,0);
  const end=new Date(start.getTime()+SLOT_MINUTES*60000);

  if(isAndroid){
    const fmt = (dt)=>`${dt.getFullYear()}${pad2(dt.getMonth()+1)}${pad2(dt.getDate())}T${dt.getHours().toString().padStart(2,'0')}${dt.getMinutes().toString().padStart(2,'0')}00`;
    const dates = `${fmt(start)}/${fmt(end)}`;
    const text = encodeURIComponent(EVENT_TITLE);
    const details = encodeURIComponent(`×§×™×©×•×¨ ×™×©×™×¨ ×œ×”×’×¢×” ×œ×¤×Ÿ ××§×¡×¤×¨×¡:\n${MAP_URL}\n(×ª×–×›×•×¨×ª 60 ×“×§×³ ×œ×¤× ×™)`);
    const loc = encodeURIComponent(MAP_URL);
    const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${dates}&details=${details}&location=${loc}`;
    window.location.href = url;
    return;
  }

  if(isIOS){
    const startLocal=toICSLocal(dateStr,timeStr);
    const endLocal=`${end.getFullYear()}${pad2(end.getMonth()+1)}${pad2(end.getDate())}T${pad2(end.getHours())}${pad2(end.getMinutes())}00`;
    const ics = buildICS({title:EVENT_TITLE,location:MAP_URL,startLocal,endLocal,tzid:TIMEZONE});
    const blob=new Blob([ics],{type:'text/calendar;charset=utf-8'});
    const url=URL.createObjectURL(blob);
    window.location.href = url;
    setTimeout(()=>URL.revokeObjectURL(url), 4000);
    return;
  }

  const fmt = (dt)=>`${dt.getFullYear()}${pad2(dt.getMonth()+1)}${pad2(dt.getDate())}T${dt.getHours().toString().padStart(2,'0')}${dt.getMinutes().toString().padStart(2,'0')}00`;
  const dates = `${fmt(start)}/${fmt(end)}`;
  const text = encodeURIComponent(EVENT_TITLE);
  const details = encodeURIComponent(`×§×™×©×•×¨ ×™×©×™×¨ ×œ×”×’×¢×” ×œ×¤×Ÿ ××§×¡×¤×¨×¡:\n${MAP_URL}\n(×ª×–×›×•×¨×ª 60 ×“×§×³ ×œ×¤× ×™)`);
  const loc = encodeURIComponent(MAP_URL);
  const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${dates}&details=${details}&location=${loc}`;
  window.location.href = url;
}

/* ===== Chat UI ===== */
const elChat = document.getElementById('chat');
const elInput = document.getElementById('input');
const elSend = document.getElementById('send');
const msgErr = document.getElementById('msgError');
const msgOk = document.getElementById('msgOk');
const hintText = document.getElementById('hintText');

const icsModal = document.getElementById('icsModal');
const btnOk = document.getElementById('btnOk');
const btnCancel = document.getElementById('btnCancel');
const icsText = document.getElementById('icsText');

function showErr(t){ msgErr.textContent=t; msgErr.style.display='block'; setTimeout(()=>msgErr.style.display='none',4500); }
function showOk(t){ msgOk.textContent=t; msgOk.style.display='block'; setTimeout(()=>msgOk.style.display='none',4500); }

function scrollDown(){ elChat.scrollTop = elChat.scrollHeight; }
function addBubble(text, who){
  const row = document.createElement('div');
  row.className = 'row ' + (who==='me'?'me':'bot');
  const b = document.createElement('div');
  b.className = 'bubble';
  b.textContent = text;
  row.appendChild(b);
  elChat.appendChild(row);
  scrollDown();
}
function setHint(t){ hintText.textContent = t || ''; }

function setComposerEnabled(enabled){
  elInput.disabled = !enabled;
  elSend.disabled = !enabled;
}

/* ===== Understanding inputs ===== */
function normalizeText(s){
  return (s||'').trim().replace(/\s+/g,' ');
}

function parseDateFromUser(s){
  const t = normalizeText(s).toLowerCase();

  const today = todayStr();
  const tomorrow = addDaysStr(1);

  // ×”×™×•× / ××—×¨
  if(t.includes('×”×™×•×')) return today;
  if(t.includes('××—×¨')) return tomorrow;

  // YYYY-MM-DD
  if(/^\d{4}-\d{2}-\d{2}$/.test(t)) return t;

  // DD.MM.YYYY
  const m=t.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
  if(m){
    const dd=pad2(+m[1]), mm=pad2(+m[2]), yy=m[3];
    return `${yy}-${mm}-${dd}`;
  }

  return null;
}

function isAllowedDate(d){
  const allowed = new Set([todayStr(), addDaysStr(1), addDaysStr(2), addDaysStr(3)]);
  return allowed.has(d);
}

function parsePartOfDay(s){
  const t = normalizeText(s).toLowerCase();
  // ×ª×•××š ×’× â€œ×¦×”×¨×™×™× / ×¢×¨×‘â€
  if(t.includes('×‘×•×§×¨')) return 'MORNING';
  if(t.includes('×¦×”×¨×™×™×')) return 'AFTERNOON';
  if(t.includes('×¢×¨×‘')) return 'EVENING';
  return null;
}

function parseTimeLike(t){
  const s=(t||'').trim();
  // "17:20" / "17.20"
  let m=s.match(/^(\d{1,2})\s*[:.]\s*(\d{2})$/);
  if(m){
    let hh=+m[1], mm=+m[2];
    if(hh>=0 && hh<=23 && (mm===0||mm===20||mm===40)) return `${pad2(hh)}:${pad2(mm)}`;
    return null;
  }
  // "1720"
  m=s.match(/^(\d{1,2})(\d{2})$/);
  if(m){
    let hh=+m[1], mm=+m[2];
    if(hh>=0 && hh<=23 && (mm===0||mm===20||mm===40)) return `${pad2(hh)}:${pad2(mm)}`;
  }
  return null;
}

function timeToMin(t){
  const [h,m]=t.split(':').map(Number);
  return h*60+m;
}

function inRange(t, start, endExclusive){
  const m = timeToMin(t);
  return m >= timeToMin(start) && m < timeToMin(endExclusive);
}

/* ===== Availability ===== */
const RANGE = {
  MORNING: {start:'08:00', end:'12:00'},
  AFTERNOON: {start:'12:00', end:'20:00'},
  EVENING: {start:'12:00', end:'20:00'} // ×œ×¤×™ ×”×“×¨×™×©×” ×©×œ×š: ×¦×”×¨×™×™×/×¢×¨×‘ ××•×ª×• ×˜×•×•×—
};

let model = {
  name:'',
  date:'',
  part:'',
  time:'',
  phone:'',
  rec:null,
  bookings:[]
};

function takenSetForDate(dateStr){
  return new Set(model.bookings.filter(b=>b.date===dateStr).map(b=>b.time));
}

function freeSlotsFor(dateStr, partKey){
  const taken = takenSetForDate(dateStr);
  const r = RANGE[partKey];
  return SLOTS.filter(t => !taken.has(t) && inRange(t, r.start, r.end));
}

function formatSlotsList(slots){
  if(!slots.length) return '××™×Ÿ ×©×¢×•×ª ×¤× ×•×™×•×ª ×‘×˜×•×•×— ×”×–×”.';
  // ×¨×©×™××” ×§×•××¤×§×˜×™×ª ×‘×ª×•×š ×”×¦'××˜
  return slots.join('  â€¢  ');
}

function nearestAlternativesWithin(dateStr, partKey, desiredTime){
  const free = freeSlotsFor(dateStr, partKey);
  if(!free.length) return [];
  const target = timeToMin(desiredTime);
  const sorted = free.slice().sort((a,b)=>Math.abs(timeToMin(a)-target)-Math.abs(timeToMin(b)-target));
  return sorted.slice(0,3);
}

/* ===== Conversation flow ===== */
const State = {
  ASK_NAME:'ASK_NAME',
  ASK_DATE:'ASK_DATE',
  ASK_PART:'ASK_PART',
  SHOW_SLOTS_AND_ASK_TIME:'SHOW_SLOTS_AND_ASK_TIME',
  ASK_PHONE:'ASK_PHONE',
  DONE:'DONE'
};
let state = State.ASK_NAME;
let lastSavedPayload = null;

async function loadBookings(){
  try{
    const rec = await fetchRecord();
    model.rec = rec;
    model.bookings = Array.isArray(rec.bookings) ? rec.bookings : [];
    return true;
  }catch(e){
    showErr('×©×’×™××ª ×¨×©×ª ×‘×˜×¢×™× ×ª ×ª×•×¨×™×');
    return false;
  }
}

function askName(){
  state = State.ASK_NAME;
  addBubble('×”×™×™ ××” ×§×•×¨×”? ×ª×–×›×™×¨×™ ×œ×™ ××™×š ×§×•×¨××™× ×œ×š', 'bot');
  setHint('×œ×“×•×’××”: ×©×•×©× ×”');
  elInput.placeholder = '×©× ×”×œ×§×•×—×”...';
}

function askDate(){
  state = State.ASK_DATE;
  addBubble(`×”×™×™ ${model.name} ×©××—×ª×™ ×©×‘×—×¨×ª ×‘×¤×Ÿ ××§×¡×¤×¨×¡ âœ¨\n××ª×™ × ×•×— ×œ×š? (×”×™×•× / ××—×¨ / ×ª××¨×™×š)\n××¤×©×¨ ×’× ×œ×›×ª×•×‘ ×ª××¨×™×š ×›××• 14.01.2026`, 'bot');
  setHint('××¤×©×¨ ×œ×§×‘×•×¢ ××”×™×•× ×•×¢×“ 3 ×™××™× ×§×“×™××”.');
  elInput.placeholder = '×”×™×•× / ××—×¨ / 14.01.2026 ...';
}

function askPartOfDay(){
  state = State.ASK_PART;
  addBubble('××¢×•×œ×”.\n×‘××™×–×” ×—×œ×§ ×©×œ ×”×™×•× × ×•×— ×œ×š? (×‘×•×§×¨ / ×¦×”×¨×™×™× / ×¢×¨×‘)', 'bot');
  setHint('×‘×•×§×¨: 08:00â€“12:00 | ×¦×”×¨×™×™×/×¢×¨×‘: 12:00â€“20:00');
  elInput.placeholder = '×‘×•×§×¨ / ×¦×”×¨×™×™× / ×¢×¨×‘';
}

function showSlotsAndAskTime(){
  state = State.SHOW_SLOTS_AND_ASK_TIME;

  if(!BOOKING_OPEN){
    addBubble('×›×¨×’×¢ ×§×‘×™×¢×ª ×ª×•×¨×™× ×¡×’×•×¨×”. ××¤×©×¨ ×œ× ×¡×•×ª ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨ ğŸ™', 'bot');
    setHint('');
    setComposerEnabled(false);
    return;
  }

  const slots = freeSlotsFor(model.date, model.part);
  const label = (model.part==='MORNING') ? '×‘×•×§×¨' : '×¦×”×¨×™×™×/×¢×¨×‘';

  if(!slots.length){
    addBubble(`××™×Ÿ ×©×¢×•×ª ×¤× ×•×™×•×ª ×‘${label} ×‘×ª××¨×™×š ${fmtDateHeb(model.date)} ğŸ˜•\n×ª×¨×¦×™ ×œ× ×¡×•×ª ×—×œ×§ ××—×¨ ×©×œ ×”×™×•×? (×‘×•×§×¨/×¦×”×¨×™×™×/×¢×¨×‘)`, 'bot');
    setHint('×¤×©×•×˜ ×›×ª×‘×™: ×‘×•×§×¨ ××• ×¦×”×¨×™×™× ××• ×¢×¨×‘');
    state = State.ASK_PART;
    return;
  }

  addBubble(
    `×‘×ª××¨×™×š ${fmtDateHeb(model.date)} ×‘${label} ××œ×• ×”×©×¢×•×ª ×”×¤× ×•×™×•×ª:\n${formatSlotsList(slots)}\n\n×ª×›×ª×‘×™ ×œ×™ ××ª ×”×©×¢×” ×©××ª ×¨×•×¦×” (×œ×“×•×’××” 16:20)`,
    'bot'
  );
  setHint('×“×§×•×ª ××¤×©×¨×™×•×ª: 00 / 20 / 40');
  elInput.placeholder = '×œ×“×•×’××”: 16:20';
}

function askPhone(){
  state = State.ASK_PHONE;
  addBubble('×¡×’×•×¨ âœ…\n××” ××¡×¤×¨ ×”×˜×œ×¤×•×Ÿ ×©×œ×š?', 'bot');
  setHint('××¤×©×¨ ×œ×¨×©×•× ×¢× ××• ×‘×œ×™ ××§×¤×™×.');
  elInput.placeholder = '×˜×œ×¤×•×Ÿ...';
}

async function trySave(){
  const payload = {
    date: model.date,
    time: model.time,
    name: model.name.trim(),
    phone: model.phone.trim()
  };

  setComposerEnabled(false);
  try{
    let rec = await fetchRecord();

    const normPhone = normalizePhone(payload.phone);
    const existsSameDayPhone = rec.bookings.some(b=>b.date===payload.date && normalizePhone(b.phone)===normPhone);
    if(existsSameDayPhone){
      addBubble('×§×™×™× ×›×‘×¨ ×ª×•×¨ ×¢×œ ×©××š ×œ××•×ª×• ×™×•×.\n×‘×•××™ × ×‘×—×¨ ×ª××¨×™×š ××—×¨ ğŸ™', 'bot');
      model.date=''; model.part=''; model.time='';
      await loadBookings();
      askDate();
      return;
    }

    if(rec.bookings.some(b=>b.date===payload.date && b.time===payload.time)){
      addBubble(`×”×©×¢×” ${payload.time} × ×ª×¤×¡×” ×”×¨×’×¢ ğŸ˜•`, 'bot');
      await loadBookings();

      const alts = nearestAlternativesWithin(payload.date, model.part, payload.time);
      if(alts.length){
        addBubble(`××¤×©×¨ ××•×§×“×/×××•×—×¨ ×§×¨×•×‘:\n${alts.join('  â€¢  ')}\n\n×ª×›×ª×‘×™ ××—×ª ××”×©×¢×•×ª ×”××œ×•, ××• ×›×ª×‘×™ "×—×œ×§ ××—×¨" ×›×“×™ ×œ×¢×‘×•×¨ ×œ×‘×•×§×¨/×¦×”×¨×™×™×/×¢×¨×‘.`, 'bot');
        setHint('×œ×“×•×’××”: 15:40 ××• 16:00 | ××• ×›×ª×‘×™: ×—×œ×§ ××—×¨');
        state = State.SHOW_SLOTS_AND_ASK_TIME;
      }else{
        addBubble('××™×Ÿ ×—×œ×•×¤×•×ª ×‘×˜×•×•×— ×”×–×”.\n×ª×¨×¦×™ ×œ×¢×‘×•×¨ ×œ×—×œ×§ ××—×¨ ×©×œ ×”×™×•×? (×‘×•×§×¨/×¦×”×¨×™×™×/×¢×¨×‘)', 'bot');
        state = State.ASK_PART;
      }
      return;
    }

    rec.bookings.push({date: payload.date, time: payload.time, name: payload.name, phone: payload.phone, ts: Date.now()});
    await putRecord(rec);

    showOk('×”×ª×•×¨ × ×©××¨ ×‘×”×¦×œ×—×”!');
    addBubble(`×§×‘×¢× ×• âœ…\n×ª××¨×™×š: ${fmtDateHeb(payload.date)}\n×©×¢×”: ${payload.time}\n××—×›×™× ×œ×š ğŸ’‡â€â™€ï¸`, 'bot');

    icsText.textContent =
`× ×™×¦×•×¨ ××™×¨×•×¢ ×œ×™×•××Ÿ ×‘×ª××¨×™×š ${fmtDateHeb(payload.date)} ×‘×©×¢×” ${payload.time} ×›×•×œ×œ ×ª×–×›×•×¨×ª ×©×¢×” ×œ×¤× ×™.
×œ×§×•×—×” ×™×§×¨×”, ××–×›×™×¨×” ×œ×š ×œ×”×’×™×¢ ×—×¤×•×¤×” ×•×‘×–××Ÿ ğŸ’‡â€â™€ï¸
×ª×•×“×” - ×¤×Ÿ ××§×¡×¤×¨×¡`;

    lastSavedPayload = payload;
    icsModal.style.display='flex';

    await loadBookings();
    state = State.DONE;

  }catch(e){
    showErr('×©×’×™××ª ×¨×©×ª ×‘×©××™×¨×”');
    addBubble('×”×™×™×ª×” ×©×’×™××ª ×¨×©×ª. ××¤×©×¨ ×œ× ×¡×•×ª ×©×•×‘ ×¢×•×“ ×¨×’×¢ ğŸ™', 'bot');
  }finally{
    setComposerEnabled(true);
  }
}

/* ===== Input handler ===== */
async function handleUserText(raw){
  const text = normalizeText(raw);
  if(!text) return;

  addBubble(text, 'me');

  if(state === State.ASK_NAME){
    model.name = text;
    if(model.name.length < 2){
      addBubble('××¤×©×¨ ×©× ×§×¦×ª ×™×•×ª×¨ ×‘×¨×•×¨? ğŸ™', 'bot');
      return;
    }
    await loadBookings();
    askDate();
    return;
  }

  if(state === State.ASK_DATE){
    const d = parseDateFromUser(text);
    if(!d || !isAllowedDate(d)){
      addBubble('××¤×©×¨ ×œ×§×‘×•×¢ ×¨×§ ××”×™×•× ×•×¢×“ 3 ×™××™× ×§×“×™××”.\n×ª×›×ª×‘×™: ×”×™×•× / ××—×¨ / ×ª××¨×™×š (×œ××©×œ 14.01.2026)', 'bot');
      return;
    }
    model.date = d;
    askPartOfDay();
    return;
  }

  if(state === State.ASK_PART){
    const part = parsePartOfDay(text);
    if(!part){
      addBubble('×œ× ×”×‘× ×ª×™ ğŸ™‚\n×ª×›×ª×‘×™ ××—×“ ×××œ×”: ×‘×•×§×¨ / ×¦×”×¨×™×™× / ×¢×¨×‘', 'bot');
      return;
    }
    model.part = part;
    showSlotsAndAskTime();
    return;
  }

  if(state === State.SHOW_SLOTS_AND_ASK_TIME){
    if(text.includes('×—×œ×§') && text.includes('××—×¨')){
      askPartOfDay();
      return;
    }

    const t = parseTimeLike(text);
    if(!t){
      addBubble('×ª×›×ª×‘×™ ×©×¢×” ×‘×¤×•×¨××˜ 16:20 (×“×§×•×ª 00/20/40)', 'bot');
      return;
    }

    // ×œ×•×•×“× ×‘×ª×•×š ×”×˜×•×•×— ×©× ×‘×—×¨
    const r = RANGE[model.part];
    if(!inRange(t, r.start, r.end)){
      const label = (model.part==='MORNING') ? '×‘×•×§×¨ (08:00â€“12:00)' : '×¦×”×¨×™×™×/×¢×¨×‘ (12:00â€“20:00)';
      addBubble(`×”×©×¢×” ${t} ×œ× ×‘×ª×•×š ×”×˜×•×•×— ×©×‘×—×¨×ª (${label}).\n×ª×¨×¦×™ ×œ×”×™×©××¨ ×‘××•×ª×• ×˜×•×•×—? ×›×ª×‘×™ ×©×¢×” ××—×¨×ª.\n××• ×›×ª×‘×™ "×—×œ×§ ××—×¨" ×›×“×™ ×œ×¢×‘×•×¨ ×˜×•×•×—.`, 'bot');
      return;
    }

    // ×‘×“×™×§×” ××•×œ ×ª×¤×•×¡×™×
    const taken = takenSetForDate(model.date);
    if(taken.has(t)){
      const alts = nearestAlternativesWithin(model.date, model.part, t);
      if(alts.length){
        addBubble(`×”×©×¢×” ${t} ×ª×¤×•×¡×” ğŸ˜•\n××¤×©×¨ ××•×§×“×/×××•×—×¨ ×§×¨×•×‘:\n${alts.join('  â€¢  ')}\n\n×ª×›×ª×‘×™ ×©×¢×” ×—×“×©×”, ××• ×›×ª×‘×™ "×—×œ×§ ××—×¨".`, 'bot');
      }else{
        addBubble(`×”×©×¢×” ${t} ×ª×¤×•×¡×” ğŸ˜•\n××™×Ÿ ×—×œ×•×¤×•×ª ×‘×˜×•×•×— ×”×–×”.\n×ª×¨×¦×™ ×œ×¢×‘×•×¨ ×œ×—×œ×§ ××—×¨ ×©×œ ×”×™×•×? (×‘×•×§×¨/×¦×”×¨×™×™×/×¢×¨×‘)`, 'bot');
        state = State.ASK_PART;
      }
      return;
    }

    // ×¤× ×•×™
    model.time = t;
    askPhone();
    return;
  }

  if(state === State.ASK_PHONE){
    model.phone = text;
    if(!validPhone(model.phone)){
      addBubble('×”×˜×œ×¤×•×Ÿ ×œ× × ×¨××” ×ª×§×™×Ÿ. ×ª×¨×©××™ ×©×•×‘ ×‘×‘×§×©×” ğŸ™', 'bot');
      return;
    }

    addBubble(`×¨×§ ×¡×™×›×•× ×§×¦×¨:\n×©×: ${model.name}\n×ª××¨×™×š: ${fmtDateHeb(model.date)}\n×©×¢×”: ${model.time}\n×˜×œ×¤×•×Ÿ: ${model.phone}\n×©×•××¨×ªâ€¦`, 'bot');
    await trySave();
    return;
  }

  if(state === State.DONE){
    addBubble('×”×ª×•×¨ ×›×‘×¨ × ×©××¨ ğŸ™‚\n×× ×ª×¨×¦×™ ×œ×§×‘×•×¢ ×ª×•×¨ × ×•×¡×£, ×›×ª×‘×™: "×ª×•×¨ ×—×“×©"', 'bot');
    if(text.includes('×ª×•×¨') && text.includes('×—×“×©')){
      model = {name:model.name, date:'', part:'', time:'', phone:'', rec:model.rec, bookings:model.bookings};
      askDate();
    }
    return;
  }
}

/* ===== Send bindings ===== */
elSend.addEventListener('click', ()=>{
  const t = elInput.value;
  elInput.value = '';
  handleUserText(t);
});

elInput.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){
    e.preventDefault();
    elSend.click();
  }
});

/* ===== Toolbar ===== */
document.getElementById('galleryBtn').addEventListener('click', ()=> window.location.href = GALLERY_URL);

document.getElementById('navWaze').addEventListener('click', ()=>{
  const start = Date.now();
  window.location.href = WAZE_DEEP;
  setTimeout(()=>{
    if (Date.now() - start < 1200) window.location.href = WAZE_WEB;
  }, 900);
});

/* ===== Modal ===== */
btnCancel.addEventListener('click', ()=>{ icsModal.style.display='none'; });

btnOk.addEventListener('click', ()=>{
  icsModal.style.display='none';
  if(!lastSavedPayload) return;
  openCalendarDirect(lastSavedPayload.date, lastSavedPayload.time);
});

/* ===== Init ===== */
(async ()=>{
  await loadBookings();
  askName();
})();

/* PWA: Service Worker */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(()=>{});
}
</script>
</body>
</html>
