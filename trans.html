<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>מתורגמן מולטי מהיר</title>

    <link rel="manifest" href="translate.json">
    
    <link rel="apple-touch-icon" href="https://reuven2k.com/translate.jpg">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0056b3">

    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; background-color: #000; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .mega-button { width: 100%; height: 50vh; border: none; font-size: 3.5rem; font-weight: 800; color: rgba(255, 255, 255, 0.4); cursor: pointer; display: flex; justify-content: center; align-items: center; outline: none; transition: all 0.1s; -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; position: relative; z-index: 1; }
        #btn-top { background-color: #0056b3; }
        #btn-bottom { background-color: #c82333; }
        .mega-button:active, .active-press { filter: brightness(80%); transform: scale(0.98); }
        #settings-btn { position: absolute; top: 20px; left: 20px; width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.9); z-index: 100; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        #center-replay-btn { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 35px; height: 35px; background: white; border-radius: 50%; z-index: 150; display: flex; align-items: center; justify-content: center; font-size: 40px; box-shadow: 0 0 25px rgba(0,0,0,0.6); cursor: pointer; border: 5px solid #f0f0f0; transition: transform 0.2s; }
        #translation-text { position: absolute; width: 80%; left: 10%; color: #fff; font-size: 2.2rem; font-weight: bold; text-align: center; z-index: 50; pointer-events: none; text-shadow: 0 2px 10px rgba(0,0,0,0.8); line-height: 1.3; opacity: 0; transition: opacity 0.3s; }
        .text-pos-top { top: 25%; transform: translateY(-50%) rotate(180deg); }
        .text-pos-bottom { bottom: 25%; transform: translateY(50%); }
        #modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 200; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 80%; max-width: 300px; text-align: center; }
        select { width: 100%; padding: 10px; margin: 10px 0 20px 0; font-size: 18px; border-radius: 8px; }
        .close-btn { background: #28a745; color: white; border: none; padding: 10px 30px; font-size: 18px; border-radius: 50px; width: 100%; }
    </style>
</head>
<body>

    <div id="settings-btn" onclick="openSettings()">⚙️</div>
    <div id="center-replay-btn" onclick="replayLast()">↺</div>
    <div id="translation-text"></div>

    <div id="btn-top" class="mega-button">ENGLISH</div>
    <div id="btn-bottom" class="mega-button">עברית</div>

    <div id="modal">
        <div class="modal-content">
            <h3>הגדרת שפות</h3>
            <label>כפתור עליון (כחול)</label>
            <select id="select-top">
                <option value="he">עברית</option>
                <option value="en" selected>English</option>
                <option value="es">Español (ספרדית)</option>
                <option value="pt">Português (ברזיל)</option>
                <option value="fr">Français (צרפתית)</option>
                <option value="ru">Русский (רוסית)</option>
                <option value="ar">العربية (ערבית)</option>
                <option value="th">ภาษาไทย (תאילנדית)</option>
                <option value="el">Ελληνικά (יוונית)</option>
                <option value="tr">Türkçe (טורקית)</option>
                <option value="zh">中文 (סינית)</option>
            </select>
            <label>כפתור תחתון (אדום)</label>
            <select id="select-bottom">
                <option value="he" selected>עברית</option>
                <option value="en">English</option>
                <option value="es">Español (ספרדית)</option>
                <option value="pt">Português (ברזיל)</option>
                <option value="fr">Français (צרפתית)</option>
                <option value="ru">Русский (רוסית)</option>
                <option value="ar">العربية (ערבית)</option>
                <option value="th">ภาษาไทย (תאילנדית)</option>
                <option value="el">Ελληνικά (יוונית)</option>
                <option value="tr">Türkçe (טורקית)</option>
                <option value="zh">中文 (סינית)</option>
            </select>
            <button class="close-btn" onclick="saveSettings()">שמור וסגור</button>
        </div>
    </div>

    <script>
        // רישום ה-Service Worker (חובה להתקנה אוטומטית)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }

        // לוגיקת התרגום המקורית שלך
        const languages = {
            'he': { code: 'he-IL', name: 'עברית' },
            'en': { code: 'en-US', name: 'ENGLISH' },
            'es': { code: 'es-ES', name: 'ESPAÑOL' },
            'pt': { code: 'pt-BR', name: 'PORTUGUÊS' },
            'fr': { code: 'fr-FR', name: 'FRANÇAIS' },
            'ru': { code: 'ru-RU', name: 'РУССКИЙ' },
            'ar': { code: 'ar-SA', name: 'العربية' },
            'th': { code: 'th-TH', name: 'ภาษาไทย' },
            'el': { code: 'el-GR', name: 'ΕΛΛΗנΙΚΑ' },
            'tr': { code: 'tr-TR', name: 'TÜRKÇE' },
            'zh': { code: 'zh-CN', name: '中文' }
        };

        let currentTop = 'en';
        let currentBottom = 'he';
        let lastTranslationText = "";
        let lastTranslationLang = "";

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        const synthesis = window.speechSynthesis;
        recognition.continuous = false;
        recognition.interimResults = false;
        let isRecording = false;

        setupButton('btn-top', 'top');
        setupButton('btn-bottom', 'bottom');

        function setupButton(elementId, position) {
            const btn = document.getElementById(elementId);
            btn.addEventListener('touchstart', (e) => { e.preventDefault(); start(position); });
            btn.addEventListener('touchend', (e) => { e.preventDefault(); stop(); });
            btn.addEventListener('mousedown', () => start(position));
            btn.addEventListener('mouseup', stop);
        }

        function start(position) {
            if (isRecording) return;
            synthesis.cancel();
            hideText();
            let langKey = (position === 'top') ? currentTop : currentBottom;
            recognition.lang = languages[langKey].code;
            const btn = document.getElementById(position === 'top' ? 'btn-top' : 'btn-bottom');
            btn.classList.add('active-press');
            btn.innerText = "...";
            try { recognition.start(); isRecording = true; } catch (e) { console.error(e); }
        }

        function stop() {
            if (!isRecording) return;
            recognition.stop();
            isRecording = false;
            document.getElementById('btn-top').innerText = languages[currentTop].name;
            document.getElementById('btn-bottom').innerText = languages[currentBottom].name;
            document.getElementById('btn-top').classList.remove('active-press');
            document.getElementById('btn-bottom').classList.remove('active-press');
        }

        recognition.onresult = async (event) => {
            const transcript = event.results[0][0].transcript;
            let sourceLang = recognition.lang === languages[currentTop].code ? currentTop : currentBottom;
            let targetLang = sourceLang === currentTop ? currentBottom : currentTop;
            try {
                const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sourceLang}&tl=${targetLang}&dt=t&q=${encodeURIComponent(transcript)}`;
                const response = await fetch(url);
                const data = await response.json();
                const translatedText = data[0][0][0];
                speak(translatedText, languages[targetLang].code);
            } catch (error) { console.error("Translation error", error); }
        };

        function speak(text, langCode) {
            lastTranslationText = text;
            lastTranslationLang = langCode;
            showTranslationText(text, langCode);
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = langCode;
            utterance.rate = 1.2;
            synthesis.speak(utterance);
        }

        function replayLast() {
            if (lastTranslationText && lastTranslationLang) {
                showTranslationText(lastTranslationText, lastTranslationLang);
                const utterance = new SpeechSynthesisUtterance(lastTranslationText);
                utterance.lang = lastTranslationLang;
                utterance.rate = 1.2;
                synthesis.speak(utterance);
            }
        }

        function showTranslationText(text, langCode) {
            const textDiv = document.getElementById('translation-text');
            textDiv.innerText = text;
            textDiv.className = '';
            if (langCode === languages[currentTop].code) { textDiv.classList.add('text-pos-top'); } 
            else { textDiv.classList.add('text-pos-bottom'); }
            textDiv.style.opacity = '1';
            setTimeout(() => { if (textDiv.innerText === text) { textDiv.style.opacity = '0'; } }, 6000);
        }

        function hideText() { document.getElementById('translation-text').style.opacity = '0'; }
        function openSettings() { document.getElementById('modal').style.display = 'flex'; }
        function saveSettings() {
            currentTop = document.getElementById('select-top').value;
            currentBottom = document.getElementById('select-bottom').value;
            document.getElementById('btn-top').innerText = languages[currentTop].name;
            document.getElementById('btn-bottom').innerText = languages[currentBottom].name;
            document.getElementById('modal').style.display = 'none';
        }
    </script>
</body>
</html>
