<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>שידור חי</title>
<style>
body {
  margin:0;
  overflow:hidden;
  background:#000;
  font-family:"Heebo",Arial,sans-serif;
}

/* כל המסך */
.player-shell {
  position:fixed;
  inset:0;
  width:100vw;
  height:100vh;
  background:#000;
  overflow:hidden;
}

/* --------- שכבת הוידאו --------- */
.video-layer {
  position:absolute;
  inset:0;
  background:#000;
  overflow:hidden;
}

.rotator {
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%, -50%) rotate(-90deg) scale(1.7);
  transform-origin:center center;
  background:#000;
  display:flex;
  justify-content:center;
  align-items:center;
  width:100vw;
  height:100vh;
}

.rotator iframe {
  border:none;
  width:100vw;
  height:100vh;
  background:#000;
}

/* --------- שכבת ה-UI --------- */
.ui-layer {
  position:absolute;
  inset:0;
  pointer-events:none;
  font-family:"Heebo",Arial,sans-serif;
  color:#fff;
}

/* סקורבורד - שמאל למעלה */
.score-overlay-wrapper {
  position:absolute;
  top:12px;
  left:8px;
  z-index:100;
  pointer-events:auto;
  display:flex;
  flex-direction:row;
  align-items:center;
  font-size:0.8rem;
  font-weight:600;
  line-height:1.2;
  font-family:"Heebo",Arial,sans-serif;
}

.score-box {
  display:flex;
  align-items:center;
  background:#1a1446;
  border-radius:4px;
  box-shadow:0 4px 12px rgba(0,0,0,0.8);
  overflow:hidden;
  border:1px solid rgba(0,0,0,0.6);
  direction:ltr;
}

/* שם קבוצה */
.team-label {
  color:#fff;
  padding:4px 8px;
  font-size:0.8rem;
  max-width:32vw;
  white-space:nowrap;
  text-overflow:ellipsis;
  overflow:hidden;
  background:#1a1446;
}

/* תוצאה */
.team-score-block {
  background:#f4dd3a;
  color:#000;
  padding:4px 6px;
  font-weight:700;
  min-width:24px;
  text-align:center;
  font-family:"Roboto Mono","Courier New",monospace;
  font-size:0.8rem;
  border-left:1px solid rgba(0,0,0,0.4);
  border-right:1px solid rgba(0,0,0,0.4);
}

/* שעון */
.timer-block {
  background:#ffffff;
  color:#000000;
  font-weight:700;
  padding:4px 8px;
  min-width:50px;
  text-align:center;
  font-family:"Roboto Mono","Courier New",monospace;
  font-size:0.8rem;
  border-left:1px solid rgba(0,0,0,0.4);
  border-right:1px solid rgba(0,0,0,0.4);
}

/* אזור ימין למעלה: לוגו + רענון + גרסה */
.top-right-cluster {
  position:absolute;
  top:8px;
  right:8px;
  z-index:200;
  display:flex;
  flex-direction:row;
  align-items:flex-start;
  gap:8px;
  pointer-events:auto;
  font-family:"Heebo",Arial,sans-serif;
  color:#fff;
}

/* לוגו לחיץ */
.channel-logo-wrap {
  position:relative;
  display:flex;
  flex-direction:column;
  align-items:center;
}
.channel-logo {
  width:52px;
  height:52px;
  border-radius:50%;
  border:2px solid rgba(255,255,255,0.4);
  box-shadow:0 0 10px rgba(0,0,0,0.7);
  cursor:pointer;
  object-fit:cover;
  background:#000;
}
.version-tag {
  margin-top:4px;
  font-size:0.65rem;
  font-weight:600;
  color:#00ffa9;
  text-shadow:0 0 6px rgba(0,255,169,0.6);
  font-family:"Heebo",Arial,sans-serif;
  line-height:1.1;
}

/* כפתור רענון קטן */
.refresh-btn-circle {
  width:28px;
  height:28px;
  border-radius:50%;
  background:rgba(0,0,0,0.6);
  border:2px solid rgba(0,255,169,0.6);
  box-shadow:0 0 8px rgba(0,0,0,0.8), 0 0 6px rgba(0,255,169,0.4);
  color:#00ffa9;
  font-size:0.8rem;
  font-weight:600;
  display:flex;
  align-items:center;
  justify-content:center;
  line-height:1;
  cursor:pointer;
  user-select:none;
  font-family:"Heebo",Arial,sans-serif;
}
.refresh-btn-circle:active {
  transform:scale(0.95);
}

/* כפתור מסך מלא (במרכז לפני כניסה למסך מלא) */
.fullscreen-btn {
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  z-index:200;
  background:rgba(0,0,0,0.55);
  color:#00ffa9;
  border:1px solid rgba(0,255,169,0.6);
  border-radius:12px;
  padding:14px 26px;
  font-size:1.2rem;
  font-weight:600;
  cursor:pointer;
  box-shadow:0 8px 24px rgba(0,0,0,0.8);
  pointer-events:auto;
}

/* פופאפ שליטה (איפה שמשנים קבוצות, תוצאה, שעון) */
.edit-popup {
  position:absolute;
  top:70px;
  right:50%;
  transform:translateX(50%);
  background:#1a1f2b;
  color:#fff;
  border-radius:12px;
  box-shadow:0 30px 60px rgba(0,0,0,0.9);
  border:1px solid rgba(255,255,255,0.15);
  padding:20px;
  width:320px;
  max-width:90vw;
  font-size:0.9rem;
  line-height:1.5;
  display:none;
  z-index:300;
  text-align:right;
  pointer-events:auto;
}
.edit-popup h2 {
  font-size:1rem;
  text-align:center;
  margin:0 0 14px;
  color:#fff;
}
.edit-field {
  margin-bottom:14px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.edit-field label {
  font-size:0.8rem;
  color:#9aa3b2;
}
.team-line {
  display:flex;
  gap:8px;
  width:100%;
}
.team-line input {
  flex:1;
}
.score-input {
  flex:0 0 60px;
  max-width:60px;
  text-align:center;
}
.edit-input {
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.2);
  background:#0f1115;
  color:#fff;
  padding:10px 12px;
  font-size:0.9rem;
  outline:none;
  width:100%;
}
.ctl-btn {
  width:100%;
  padding:10px 12px;
  border:1px solid rgba(255,255,255,0.2);
  background:#0f1115;
  color:#fff;
  border-radius:8px;
  cursor:pointer;
  margin-bottom:8px;
  font-size:0.9rem;
  font-weight:600;
  text-align:center;
}

/* מסך סיסמה ראשוני */
.passgate {
  position:absolute;
  top:70px;
  right:50%;
  transform:translateX(50%);
  background:#1a1f2b;
  color:#fff;
  border-radius:12px;
  box-shadow:0 30px 60px rgba(0,0,0,0.9);
  border:1px solid rgba(255,255,255,0.15);
  padding:20px;
  width:260px;
  max-width:90vw;
  font-size:0.9rem;
  line-height:1.5;
  z-index:400;
  text-align:center;
  pointer-events:auto;
  display:none;
}
.passgate input {
  width:100%;
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.2);
  background:#0f1115;
  color:#fff;
  padding:10px 12px;
  font-size:1rem;
  outline:none;
  text-align:center;
  font-family:"Heebo",Arial,sans-serif;
  margin-bottom:12px;
}
.passgate button {
  width:100%;
  padding:10px 12px;
  border:1px solid rgba(0,255,169,0.4);
  background:#0f1115;
  color:#00ffa9;
  border-radius:8px;
  cursor:pointer;
  font-size:1rem;
  font-weight:600;
  text-align:center;
  box-shadow:0 0 10px rgba(0,255,169,0.3);
}
.passgate .err {
  color:#ff4a4a;
  font-size:0.8rem;
  min-height:1em;
  margin-top:6px;
}
</style>
</head>
<body>

<div class="player-shell" id="videoContainer">

  <!-- שכבת הוידאו -->
  <div class="video-layer">
    <div class="rotator">
      <iframe id="livePlayer"
        src="https://www.youtube.com/embed/live_stream?channel=UCu2doG-TFmd4b2paosdg1xg&autoplay=1&mute=1&playsinline=1"
        allow="autoplay; encrypted-media; picture-in-picture"
      ></iframe>
    </div>
  </div>

  <!-- שכבת ה-UI -->
  <div class="ui-layer">

    <!-- סקורבורד (שמאל למעלה) -->
    <div class="score-overlay-wrapper">
      <div class="score-box">
        <div class="team-label" id="teamHome_name">הפועל חיפה</div>
        <div class="team-score-block" id="teamHome_score">0</div>

        <div class="timer-block" id="liveTimer">00:00</div>

        <div class="team-score-block" id="teamAway_score">0</div>
        <div class="team-label" id="teamAway_name">מכבי חיפה</div>
      </div>
    </div>

    <!-- מסך מלא -->
    <button class="fullscreen-btn" id="fullscreenBtn">⛶ מסך מלא</button>

    <!-- אזור ימין למעלה: לוגו, גירסה, רענון -->
    <div class="top-right-cluster">
      <div class="channel-logo-wrap">
        <img class="channel-logo" id="channelLogo"
          src="https://yt3.ggpht.com/XEIE69D8DP1huYwLhSrHbEPhU9nfLjqSX7P8mZ8NLceUeDX68BoH1ORcxWy-NufREOy9xo1Dkw=s600-c-k-c0x00ffffff-no-rj-rp-mo"
          alt="ערוץ">
        <div class="version-tag" id="versionTag">v1.4</div>
      </div>

      <div class="refresh-btn-circle" id="refreshBtnCircle">↻</div>
    </div>

    <!-- חלון סיסמה -->
    <div class="passgate" id="passGate">
      <div style="font-weight:600; margin-bottom:8px;">כניסה לניהול</div>
      <input id="adminPassInput" type="password" placeholder="הכנס קוד">
      <button id="adminPassBtn">אישור</button>
      <div class="err" id="adminPassErr"></div>
    </div>

    <!-- חלון שליטה -->
    <div class="edit-popup" id="editPopup">
      <h2>שליטה בשידור</h2>

      <div class="edit-field">
        <label>שם הליגה</label>
        <input class="edit-input" id="league_input" value="שידורי חי הפועל חיפה נערים א' 2009">
      </div>

      <div class="edit-field">
        <label>קבוצה ביתית + תוצאה</label>
        <div class="team-line">
          <input id="teamHome_input" class="edit-input" value="הפועל חיפה">
          <input id="scoreHome_input" class="edit-input score-input" type="number" min="0" value="0">
        </div>
      </div>

      <div class="edit-field">
        <label>קבוצה אורחת + תוצאה</label>
        <div class="team-line">
          <input id="teamAway_input" class="edit-input" value="מכבי חיפה">
          <input id="scoreAway_input" class="edit-input score-input" type="number" min="0" value="0">
        </div>
      </div>

      <button class="ctl-btn" id="startBtn">הפעל שעון</button>
      <button class="ctl-btn" id="pauseBtn">הפסקת מחצית / המשך</button>
      <button class="ctl-btn" id="resetBtn">איפוס שעון</button>
      <button class="ctl-btn" id="closePopupBtn">יציאה</button>
    </div>

  </div><!-- /ui-layer -->
</div><!-- /player-shell -->

<script>
// ========== הגדרות JSONBin ==========
const BIN_ID = "69009c64d0ea881f40c1ebdb";
const READ_URL  = `https://api.jsonbin.io/v3/b/${BIN_ID}?meta=false`;
const WRITE_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
const MASTER_KEY = "$2a$10$rHMLGk7wrx0ukvA.pNejbOgN14ZKGhcOJTfaXJzQV1D.QECG0yI5O";

// ========== סטייט לוקאלי ==========
let isAdmin = false;
let currentData = {
  leagueName: "שידורי חי הפועל חיפה נערים א' 2009",
  homeName: "הפועל חיפה",
  homeScore: 0,
  awayName: "מכבי חיפה",
  awayScore: 0,
  clockRunning: false,
  startTime: 0,
  pausedTotalMs: 0
};

// עידכון מהשרת -> למסך
function applyFromServer(data) {
  // אם אני אדמין באמצע עדכון חי, אל תמחוק לי ערכים שאני עוד לא שמרתי?
  // החלטה: האדמין הוא בעל הבית. אם האדמין פתח את ה-popup, נשאיר את הטופס שלו כמו שהוא.
  // אבל את התצוגה על המסך (סקורבורד) תמיד נרנדר מהשרת.
  currentData = data;
  renderScoreboard();
}

// עידכון למסך (טיימר, קבוצות, תוצאה)
function fmt(sec){
  const m = Math.floor(sec/60);
  const s = sec % 60;
  return String(m).padStart(2,"0")+":"+String(s).padStart(2,"0");
}
function getDisplaySeconds() {
  const d = currentData;
  if (!d) return 0;
  if (!d.clockRunning || !d.startTime) {
    return Math.floor((d.pausedTotalMs||0)/1000);
  }
  const now = Date.now();
  const totalMs = (d.pausedTotalMs||0) + (now - d.startTime);
  return Math.floor(totalMs/1000);
}
function renderScoreboard() {
  document.getElementById("teamHome_name").textContent  = currentData.homeName;
  document.getElementById("teamHome_score").textContent = currentData.homeScore;
  document.getElementById("teamAway_name").textContent  = currentData.awayName;
  document.getElementById("teamAway_score").textContent = currentData.awayScore;
  document.getElementById("liveTimer").textContent      = fmt(getDisplaySeconds());

  // אם אדמין ופתוח הפופאפ, תעדכן שדות הטופס מהמצב האחרון (שאני רואה/שומר)
  if (isAdmin && popup.style.display === "block") {
    document.getElementById("league_input").value      = currentData.leagueName || "";
    document.getElementById("teamHome_input").value    = currentData.homeName || "";
    document.getElementById("scoreHome_input").value   = currentData.homeScore;
    document.getElementById("teamAway_input").value    = currentData.awayName || "";
    document.getElementById("scoreAway_input").value   = currentData.awayScore;
  }
}

// משיכת מצב מהשרת
async function fetchState() {
  try {
    const res = await fetch(READ_URL, {
      method: "GET",
      headers: {
        "Content-Type": "application/json"
      }
    });
    if (!res.ok) return;
    const data = await res.json();
    // לוודא שיש כל השדות
    normalizeData(data);
    applyFromServer(data);
  } catch(e) { /* שקט */ }
}

// דוחף מצב לשרת (PUT)
async function pushState() {
  if (!isAdmin) return;
  try {
    const res = await fetch(WRITE_URL, {
      method: "PUT",
      headers: {
        "Content-Type":"application/json",
        "X-Master-Key": MASTER_KEY
      },
      body: JSON.stringify(currentData)
    });
    // לא חייבים לטפל בתשובה, אבל אפשר למשוך שוב לוודא שכולם באותו מצב
    if (res.ok) {
      // רענון עצמי אחרי כתיבה: לוודא שזיהינו שהשרת קיבל
      fetchState();
    }
  } catch(e){
    // שקט
  }
}

// וידוא שכל המפתחות קיימים
function normalizeData(obj){
  if (typeof obj.leagueName    === "undefined") obj.leagueName    = "";
  if (typeof obj.homeName      === "undefined") obj.homeName      = "";
  if (typeof obj.homeScore     === "undefined") obj.homeScore     = 0;
  if (typeof obj.awayName      === "undefined") obj.awayName      = "";
  if (typeof obj.awayScore     === "undefined") obj.awayScore     = 0;
  if (typeof obj.clockRunning  === "undefined") obj.clockRunning  = false;
  if (typeof obj.startTime     === "undefined") obj.startTime     = 0;
  if (typeof obj.pausedTotalMs === "undefined") obj.pausedTotalMs = 0;
}

// טיימר מקומי לרענון התצוגה של השעון
setInterval(()=>{
  renderScoreboard();
},500);

// פולינג מהשרת לכל הצופים (1.5 שניות)
setInterval(()=>{
  fetchState();
},1500);

// קריאה ראשונה כשנטען הדף
fetchState();


// ========== מסך מלא ==========
const videoContainer = document.getElementById('videoContainer');
const fsBtn = document.getElementById('fullscreenBtn');
fsBtn.addEventListener('click', () => {
  if (!document.fullscreenElement) {
    videoContainer.requestFullscreen().catch(err => {
      alert('לא ניתן לעבור למסך מלא: ' + err.message);
    });
  } else {
    document.exitFullscreen();
  }
});
document.addEventListener('fullscreenchange', () => {
  fsBtn.style.display = document.fullscreenElement ? "none" : "block";
});


// ========== רענון שידור מהיוטיוב ==========
const iframeEl = document.getElementById('livePlayer');
const refreshCircle = document.getElementById('refreshBtnCircle');

function forcePlay() {
  if (iframeEl && iframeEl.contentWindow) {
    iframeEl.contentWindow.postMessage(
      '{"event":"command","func":"playVideo","args":""}',
      '*'
    );
  }
}
function refreshLive() {
  if (!iframeEl) return;
  const baseUrl = "https://www.youtube.com/embed/live_stream?channel=UCu2doG-TFmd4b2paosdg1xg&autoplay=1&mute=1&playsinline=1";
  iframeEl.src = baseUrl + "&t=" + Date.now();
  setTimeout(forcePlay, 1200);
}
refreshCircle.addEventListener('click', () => {
  refreshLive();
  refreshCircle.style.transition = "transform 0.3s";
  refreshCircle.style.transform = "rotate(-360deg) scale(0.9)";
  setTimeout(()=>{
    refreshCircle.style.transform = "rotate(0deg) scale(1)";
  },300);
});


// ========== כניסה לאיזור הסודי עם קוד פעם אחת ==========
const passGate = document.getElementById('passGate');
const adminPassInput = document.getElementById('adminPassInput');
const adminPassBtn = document.getElementById('adminPassBtn');
const adminPassErr = document.getElementById('adminPassErr');
const popup = document.getElementById('editPopup');
const logoBtn = document.getElementById('channelLogo');
const closeBtn = document.getElementById('closePopupBtn');

// כשלוחצים על הלוגו:
logoBtn.addEventListener('click', () => {
  if (!isAdmin) {
    // אם עוד לא אישרנו סיסמה לשידור הזה - תבקש
    passGate.style.display = "block";
    adminPassInput.value = "";
    adminPassErr.textContent = "";
  } else {
    // כבר אדמין -> פתח/סגור פופאפ שליטה
    togglePopup();
  }
});

// בדיקת סיסמה 4451
adminPassBtn.addEventListener('click', () => {
  const val = adminPassInput.value.trim();
  if (val === "4451") {
    isAdmin = true;
    passGate.style.display = "none";
    popup.style.display = "block";
    // כשנכנסתי לאדמין - תמשוך מצב עדכני ותמלא שדות
    fetchState().then(()=>{ renderScoreboard(); });
  } else {
    adminPassErr.textContent = "סיסמה לא נכונה";
  }
});

// יציאה מהפופאפ (לא מאפסת isAdmin)
closeBtn.addEventListener('click', () => {
  popup.style.display = "none";
});

// פתח/סגור פופאפ ידנית
function togglePopup(){
  if (popup.style.display === "block") {
    popup.style.display = "none";
  } else {
    popup.style.display = "block";
    // עדכן שדות לפי מצב עדכני
    renderScoreboard();
  }
}


// ========== כפתורי שליטה בפועל ==========

// עדכון שמות ותוצאות -> שולח לשרת
function syncFromInputsAndPush() {
  if (!isAdmin) return;

  const li = document.getElementById("league_input");
  const ha = document.getElementById("teamHome_input");
  const hs = document.getElementById("scoreHome_input");
  const aa = document.getElementById("teamAway_input");
  const as = document.getElementById("scoreAway_input");

  currentData.leagueName   = li.value;
  currentData.homeName     = ha.value;
  currentData.homeScore    = parseInt(hs.value||"0",10);
  currentData.awayName     = aa.value;
  currentData.awayScore    = parseInt(as.value||"0",10);

  renderScoreboard();
  pushState();
}

// התחלת שעון (מאפס ומתחיל לרוץ)
document.getElementById('startBtn').addEventListener('click', () => {
  if (!isAdmin) return;
  currentData.pausedTotalMs = 0;
  currentData.startTime = Date.now();
  currentData.clockRunning = true;
  renderScoreboard();
  pushState();
});

// הפסקת מחצית / המשך
document.getElementById('pauseBtn').addEventListener('click', () => {
  if (!isAdmin) return;

  if (currentData.clockRunning) {
    // עכשיו עוצרים את השעון:
    const now = Date.now();
    const runMs = now - (currentData.startTime || now);
    currentData.pausedTotalMs = (currentData.pausedTotalMs||0) + runMs;
    currentData.clockRunning = false;
    currentData.startTime = 0;
  } else {
    // עכשיו ממשיכים את השעון:
    currentData.startTime = Date.now();
    currentData.clockRunning = true;
  }

  renderScoreboard();
  pushState();
});

// איפוס שעון לגמרי
document.getElementById('resetBtn').addEventListener('click', () => {
  if (!isAdmin) return;
  currentData.clockRunning = false;
  currentData.startTime = 0;
  currentData.pausedTotalMs = 0;
  renderScoreboard();
  pushState();
});

// כל שינוי בטקסטים/תוצאות -> שלח מיד
document.getElementById("league_input").addEventListener("change", syncFromInputsAndPush);
document.getElementById("teamHome_input").addEventListener("change", syncFromInputsAndPush);
document.getElementById("scoreHome_input").addEventListener("change", syncFromInputsAndPush);
document.getElementById("teamAway_input").addEventListener("change", syncFromInputsAndPush);
document.getElementById("scoreAway_input").addEventListener("change", syncFromInputsAndPush);
</script>
</body>
</html>
