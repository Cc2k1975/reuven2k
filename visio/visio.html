<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>××ª×›× ×Ÿ ×—×œ×œ ×—×•×¤×©×™ - ×¤× ×™×§×¡×¤×¨×¡</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --bg: #e0e0e0; --panel: #ffffff; --accent: #3498db; --wall: #2c3e50; }
        body { font-family: system-ui, sans-serif; margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; touch-action: none; }
        
        .toolbar { background: var(--panel); padding: 10px; display: flex; gap: 8px; flex-wrap: wrap; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        button, select { padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; font-weight: bold; cursor: pointer; background: white; }
        .btn-add { background: var(--accent); color: white; border: none; }
        .btn-save { background: #27ae60; color: white; border: none; }

        #workspace { flex: 1; position: relative; overflow: hidden; background-image: radial-gradient(#bcbcbc 1px, transparent 1px); background-size: 20px 20px; }
        #canvas { position: absolute; transform-origin: 0 0; }

        .element { position: absolute; box-sizing: border-box; display: flex; align-items: center; justify-content: center; touch-action: none; cursor: move; min-width: 10px; min-height: 10px; }
        .wall { background: var(--wall); z-index: 10; }
        .furniture { background: rgba(255,255,255,0.9); border: 2px solid var(--wall); z-index: 20; }
        
        /* × ×§×•×“×•×ª ××ª×™×—×” - Handles */
        .resizer { width: 15px; height: 15px; background: var(--accent); position: absolute; border-radius: 50%; border: 2px solid white; }
        .resizer.nw { top: -7px; left: -7px; cursor: nw-resize; }
        .resizer.ne { top: -7px; right: -7px; cursor: ne-resize; }
        .resizer.sw { bottom: -7px; left: -7px; cursor: sw-resize; }
        .resizer.se { bottom: -7px; right: -7px; cursor: se-resize; }

        .label-dim { position: absolute; background: white; padding: 2px 4px; border-radius: 4px; font-size: 10px; font-weight: bold; pointer-events: none; border: 1px solid #ccc; }
        .label-w { top: -20px; left: 50%; transform: translateX(-50%); }
        .label-h { right: -45px; top: 50%; transform: translateY(-50%); }

        .selected { outline: 2px solid var(--accent); box-shadow: 0 0 10px rgba(52, 152, 219, 0.5); }
        .selected .resizer { display: block; }
        .resizer { display: none; }

        #fab-delete { position: fixed; bottom: 20px; left: 20px; background: #e74c3c; color: white; border-radius: 50%; width: 50px; height: 50px; display: none; align-items: center; justify-content: center; font-size: 24px; z-index: 2000; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

<div class="toolbar">
    <select id="objType">
        <option value="wall">ğŸ§± ×§×™×¨</option>
        <option value="table">ğŸª‘ ×©×•×œ×—×Ÿ/××¨×•×Ÿ</option>
        <option value="bed">ğŸ›ï¸ ××™×˜×”</option>
        <option value="door">ğŸšª ×“×œ×ª</option>
    </select>
    <button class="btn-add" onclick="addElement()">+ ×”×•×¡×£</button>
    <button onclick="resetZoom()">ğŸ  ××¤×¡ ××‘×˜</button>
    <button class="btn-save" onclick="exportImg()">ğŸ“¸ ×¦×™×œ×•×</button>
    <div style="margin-right: auto; font-size: 12px; color: #666;">×¦×‘×™×˜×” ×œ×–×•× | ×’×¨×™×¨×” ×œ×”×–×–×”</div>
</div>

<div id="workspace">
    <div id="canvas"></div>
</div>

<div id="fab-delete" onclick="deleteSelected()">ğŸ—‘ï¸</div>

<script>
    let scale = 1, zoom = 1, offsetX = 50, offsetY = 50, selected = null, zIdx = 100;
    const canvas = document.getElementById('canvas');
    const workspace = document.getElementById('workspace');

    // ××ª×—×•×œ ×œ×•×—
    function updateTransform() {
        canvas.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${zoom})`;
    }
    updateTransform();

    function addElement() {
        const type = document.getElementById('objType').value;
        const el = document.createElement('div');
        el.className = `element ${type}`;
        el.style.width = '100px';
        el.style.height = type === 'wall' ? '10px' : '100px';
        el.style.left = `${(Math.abs(offsetX) + 50) / zoom}px`;
        el.style.top = `${(Math.abs(offsetY) + 50) / zoom}px`;
        
        el.innerHTML = `
            <div class="label-dim label-w">100cm</div>
            <div class="label-dim label-h">10cm</div>
            <div class="resizer nw"></div><div class="resizer ne"></div>
            <div class="resizer sw"></div><div class="resizer se"></div>
            <span style="pointer-events:none; font-size:10px">${type === 'wall' ? '' : type}</span>
        `;

        el.onpointerdown = onElementDown;
        canvas.appendChild(el);
        selectElement(el);
    }

    function onElementDown(e) {
        if (e.target.classList.contains('resizer')) return onResizeStart(e, this);
        e.stopPropagation();
        selectElement(this);
        let startX = e.clientX, startY = e.clientY;
        let left = parseInt(this.style.left), top = parseInt(this.style.top);

        const onMove = (me) => {
            this.style.left = left + (me.clientX - startX) / zoom + 'px';
            this.style.top = top + (me.clientY - startY) / zoom + 'px';
        };
        const onUp = () => { document.removeEventListener('pointermove', onMove); };
        document.addEventListener('pointermove', onMove);
        document.addEventListener('pointerup', onUp, {once:true});
    }

    function onResizeStart(e, el) {
        e.stopPropagation();
        const handle = e.target.classList;
        let startX = e.clientX, startY = e.clientY;
        let startW = el.offsetWidth, startH = el.offsetHeight;
        let startL = parseInt(el.style.left), startT = parseInt(el.style.top);

        const onMove = (me) => {
            let dx = (me.clientX - startX) / zoom;
            let dy = (me.clientY - startY) / zoom;

            if (handle.contains('se')) {
                el.style.width = startW + dx + 'px';
                el.style.height = startH + dy + 'px';
            } else if (handle.contains('sw')) {
                el.style.width = startW - dx + 'px';
                el.style.left = startL + dx + 'px';
                el.style.height = startH + dy + 'px';
            } else if (handle.contains('ne')) {
                el.style.width = startW + dx + 'px';
                el.style.height = startH - dy + 'px';
                el.style.top = startT + dy + 'px';
            } else if (handle.contains('nw')) {
                el.style.width = startW - dx + 'px';
                el.style.left = startL + dx + 'px';
                el.style.height = startH - dy + 'px';
                el.style.top = startT + dy + 'px';
            }
            updateLabels(el);
        };
        document.addEventListener('pointermove', onMove);
        document.addEventListener('pointerup', () => document.removeEventListener('pointermove', onMove), {once:true});
    }

    function updateLabels(el) {
        el.querySelector('.label-w').innerText = Math.round(el.offsetWidth) + 'cm';
        el.querySelector('.label-h').innerText = Math.round(el.offsetHeight) + 'cm';
    }

    function selectElement(el) {
        if (selected) selected.classList.remove('selected');
        selected = el;
        selected.classList.add('selected');
        selected.style.zIndex = zIdx++;
        document.getElementById('fab-delete').style.display = 'flex';
    }

    workspace.onpointerdown = (e) => {
        if (e.target === workspace || e.target === canvas) {
            deselect();
            let sX = e.clientX, sY = e.clientY;
            const onMove = (me) => {
                offsetX += me.clientX - sX;
                offsetY += me.clientY - sY;
                sX = me.clientX; sY = me.clientY;
                updateTransform();
            };
            document.addEventListener('pointermove', onMove);
            document.addEventListener('pointerup', () => document.removeEventListener('pointermove', onMove), {once:true});
        }
    };

    function deselect() { if(selected) selected.classList.remove('selected'); selected = null; document.getElementById('fab-delete').style.display = 'none'; }
    function deleteSelected() { if(selected) { selected.remove(); deselect(); } }
    function resetZoom() { zoom = 1; offsetX = 50; offsetY = 50; updateTransform(); }

    // ×–×•× ×¢× ×’×œ×’×œ×ª ××• ×¦×‘×™×˜×”
    workspace.onwheel = (e) => {
        e.preventDefault();
        zoom += e.deltaY * -0.001;
        zoom = Math.max(0.2, Math.min(3, zoom));
        updateTransform();
    };

    function exportImg() {
        deselect();
        html2canvas(canvas, { backgroundColor: '#e0e0e0' }).then(c => {
            const link = document.createElement('a');
            link.download = 'sketch.png';
            link.href = c.toDataURL();
            link.click();
        });
    }
</script>

</body>
</html>
