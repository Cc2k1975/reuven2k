<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <title>××—×•×œ×œ ×—×™× ×” - ×’×¨×¡×” ×¡×•×¤×™×ª</title>

  <link href="https://fonts.googleapis.com/css2?family=Frank+Ruhl+Libre:wght@400;700&family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --text-color:#4A2E36;
    }

    html, body{
      margin:0; padding:0;
      width:100%; height:100%;
      overflow:hidden;
      background:#111;
      font-family:'Rubik', sans-serif;
      -webkit-text-size-adjust:100%;
    }

    .app{
      position:fixed;
      inset:0;
      display:grid;
      place-items:center;
      background:#111;
      padding-top: env(safe-area-inset-top);
      padding-right: env(safe-area-inset-right);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
    }

    .stage{
      width:100%;
      height:100%;
      display:grid;
      place-items:center;
      overflow:hidden;
      box-sizing:border-box;
      padding:8px;
      position:relative;
    }

    /* --- ×ª×¦×•×’×” (×§×•××¤×•×–×™×¦×™×”) --- */
    .preview-area{
      position:absolute;
      left:50%;
      top:50%;
      background:#fff;
      box-shadow: 0 0 40px rgba(0,0,0,0.55);
      overflow:hidden;
      transform-origin:center center;
      will-change: transform;
      user-select:none;
      touch-action: manipulation;
    }

    /* ×—×©×•×‘: ×ª××™×“ ×œ××œ× ××ª ×”×§×•××¤×•×–×™×¦×™×” */
    #bgImage{
      display:block;
      width:100%;
      height:100%;
      object-fit: contain; /* ×œ× ×—×•×ª×š */
      pointer-events:none;
    }

    /* --- ××œ×× ×˜×™× ××§×•×‘×¢×™× --- */
    .final-element{
      position:absolute;
      transform-origin:center center;
      text-align:center;
      color:var(--text-color);
      white-space:nowrap;
      filter: blur(0.4px);
      transform: translate(-50%, -50%);
    }

    /* --- ×¢×™×¦×•×‘ ×˜×§×¡×˜ (×›××• ×”××§×•×¨ ×©×œ×š) --- */
    .header-txt { font-family:'Frank Ruhl Libre', serif; font-size:32px; font-weight:700; line-height:1; }
    .names-txt  { font-family:'Frank Ruhl Libre', serif; font-size:58px; font-weight:700; line-height:1; }
    .intro-txt  { font-size:16px; line-height:1.4; font-weight:400; margin-top:15px; }
    .date-txt   { font-family:'Rubik', sans-serif; font-size:36px; font-weight:700; letter-spacing:1px; margin-top:10px; }
    .loc-title-txt { font-size:24px; font-weight:700; }
    .address-txt   { font-size:16px; font-weight:400; }
    .time-txt      { font-family:'Rubik', sans-serif; font-size:20px; font-weight:700; }
    .parents-txt   { font-size:14px; font-weight:400; line-height:1.3; }

    /* ===== ×›×¤×ª×•×¨ ×¦×£ ×œ×¤×ª×™×—×” ===== */
    .btn-gear{
      position:fixed;
      z-index:2600;
      right: calc(env(safe-area-inset-right) + 12px);
      bottom: calc(env(safe-area-inset-bottom) + 12px);
      width:56px; height:56px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.22);
      background: rgba(30,30,30,0.92);
      color:#fff;
      font-size:22px;
      font-weight:900;
      display:grid;
      place-items:center;
      backdrop-filter: blur(10px);
      cursor:pointer;
    }

    /* ===== ×©×›×‘×ª ×¨×§×¢ ×›×©×”×ª×¤×¨×™×˜ ×¤×ª×•×— ===== */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.55);
      z-index:2400;
      opacity:0;
      pointer-events:none;
      transition: opacity 180ms ease;
    }
    .overlay.open{
      opacity:1;
      pointer-events:auto;
    }

    /* ===== ×ª×¤×¨×™×˜ ×›×¨×˜×™×¡ ×‘×××¦×¢ ×”××¡×š ===== */
    .controls{
      position:fixed;
      z-index:2500;
      left:50%;
      top:50%;
      transform: translate(-50%, -50%) scale(0.98);
      width: min(440px, calc(100vw - 24px));
      max-height: min(74vh, 620px);
      overflow:auto;

      background: rgba(45,45,45,0.96);
      border:1px solid rgba(160,160,160,0.30);
      border-radius:18px;
      padding:14px 14px calc(14px + env(safe-area-inset-bottom));
      box-sizing:border-box;
      color:#fff;
      backdrop-filter: blur(12px);

      opacity:0;
      pointer-events:none;
      transition: opacity 180ms ease, transform 180ms ease;
      -webkit-overflow-scrolling: touch;
    }
    .controls.open{
      opacity:1;
      pointer-events:auto;
      transform: translate(-50%, -50%) scale(1);
    }

    .controls-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      align-items:start;
      justify-items:stretch;
    }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    .input-group{ display:flex; flex-direction:column; gap:6px; }
    label{ font-size:0.9rem; color:#eee; margin:0; font-weight:900; }

    input[type="text"], input[type="date"], input[type="time"]{
      padding:12px 12px;
      border-radius:12px;
      border:none;
      font-family:'Rubik', sans-serif;
      font-size:1rem;
      outline:none;
      width:100%;
      box-sizing:border-box;
    }

    button{
      background:#4CAF50;
      color:#fff;
      border:none;
      padding:13px 16px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      height:48px;
      font-size:1.05rem;
      width:100%;
      transition: background 0.2s;
    }
    button:hover{ background:#45a049; }
    .btn-mode{ background:#2d6cdf; }
  </style>
</head>

<body>
  <div class="app">
    <div class="stage">
      <div class="preview-area" id="captureTarget">
        <img id="bgImage" src="hina2.jpg" onerror="alert('×—×¡×¨×” ×ª××•× ×” hina2.jpg')" alt="×¨×§×¢">

        <div class="final-element" style="left: 42.8%; top: 33.6%; transform: translate(-50%, -50%) rotate(-22.0deg);">
          <div class="header-txt" id="headerText">×˜×§×¡ ×”×—×™× ×” ×©×œ</div>
        </div>

        <div class="final-element" style="left: 45.0%; top: 39.8%; transform: translate(-50%, -50%) rotate(-22.5deg);">
          <div class="names-txt" id="namesText">×©×™×¨ ×•××•×¨××œ</div>
        </div>

        <div class="final-element" style="left: 48.4%; top: 46.7%; transform: translate(-50%, -50%) rotate(-22.5deg);">
          <div class="intro-txt">
            ×©××—×™× ×œ×”×–××™× ×›× ×œ×—×’×•×’ ×¢×™×× ×• ××ª<br>
            ×˜×§×¡ ×”×—×™× ×” ×©×œ× ×• ×©×™×™×¢×¨×š ××™"×”<br>
            ×‘×™×•× <span id="dayName">×¨×‘×™×¢×™</span>, <span id="hebDate">×›"×‘ ×‘×˜×‘×ª ×ª×©×¤"×“</span>
          </div>
        </div>

        <div class="final-element" style="left: 50.9%; top: 54.6%; transform: translate(-50%, -50%) rotate(-22.5deg);">
          <div class="date-txt" id="dateText">03.01.2024</div>
        </div>

        <div class="final-element" style="left: 53.7%; top: 60.3%; transform: translate(-50%, -50%) rotate(-22.5deg);">
          <div class="loc-title-txt" id="locTitleText">××•×œ××™ ××‘× ×™×•</div>
        </div>

        <div class="final-element" style="left: 55.4%; top: 63.6%; transform: translate(-50%, -50%) rotate(-23.0deg);">
          <div class="address-txt" id="addressText">×”×ª×¢×©×™×™×” 12, ×©×•×”×</div>
        </div>

        <div class="final-element" style="left: 57.2%; top: 67.1%; transform: translate(-50%, -50%) rotate(-22.5deg);">
          <div class="time-txt" id="timeText">19:30</div>
        </div>

        <div class="final-element" style="left: 72.0%; top: 65.9%; transform: translate(-50%, -50%) rotate(-23.0deg);">
          <div class="parents-txt" id="parentsBrideText">×¦×“ ×”×›×œ×”,<br>×’×‘××™</div>
        </div>

        <div class="final-element" style="left: 43.1%; top: 77.2%; transform: translate(-50%, -50%) rotate(-22.5deg);">
          <div class="parents-txt" id="parentsGroomText">×¦×“ ×”×—×ª×Ÿ,<br>××•×—×™×•×Ÿ</div>
        </div>

      </div>
    </div>

    <button class="btn-gear" id="gearBtn" type="button" aria-label="×¤×ª×—/×¡×’×•×¨ ×©×œ×™×˜×”">âš™ï¸</button>
    <div class="overlay" id="overlay"></div>

    <div class="controls" id="controlsPanel" role="dialog" aria-modal="true" aria-label="×¢×¨×™×›×ª ×¤×¨×˜×™×">
      <div class="controls-grid">

        <button class="btn-mode" type="button" id="modeBtn">××¦×‘: FIT</button>

        <div class="input-group">
          <label>×›×•×ª×¨×ª:</label>
          <input type="text" value="×˜×§×¡ ×”×—×™× ×” ×©×œ" oninput="updateText('headerText', this.value)">
        </div>

        <div class="input-group">
          <label>×©××•×ª:</label>
          <input type="text" value="×©×™×¨ ×•××•×¨××œ" oninput="updateText('namesText', this.value)">
        </div>

        <div class="row2">
          <div class="input-group">
            <label>×ª××¨×™×š:</label>
            <input type="date" id="dateInput">
          </div>
          <div class="input-group">
            <label>×©×¢×”:</label>
            <input type="time" value="19:30" oninput="updateText('timeText', this.value)">
          </div>
        </div>

        <div class="input-group">
          <label>×©× ×”××•×œ×:</label>
          <input type="text" value="××•×œ××™ ××‘× ×™×•" oninput="updateText('locTitleText', this.value)">
        </div>

        <div class="input-group">
          <label>×›×ª×•×‘×ª:</label>
          <input type="text" value="×”×ª×¢×©×™×™×” 12, ×©×•×”×" oninput="updateText('addressText', this.value)">
        </div>

        <div class="input-group">
          <label>×¦×“ ×”×›×œ×” (×”×¤×¨×“ ×‘×¤×¡×™×§):</label>
          <input type="text" value="×¦×“ ×”×›×œ×”, ×’×‘××™" oninput="updateText('parentsBrideText', this.value.replace(',', '<br>'))">
        </div>

        <div class="input-group">
          <label>×¦×“ ×”×—×ª×Ÿ (×”×¤×¨×“ ×‘×¤×¡×™×§):</label>
          <input type="text" value="×¦×“ ×”×—×ª×Ÿ, ××•×—×™×•×Ÿ" oninput="updateText('parentsGroomText', this.value.replace(',', '<br>'))">
        </div>

        <button type="button" onclick="saveImage()">ğŸ“· ×©××•×¨</button>
      </div>
    </div>
  </div>

  <script>
    // ×—×¡×™××ª pinch-to-zoom + double-tap zoom
    document.addEventListener('gesturestart', e => e.preventDefault(), { passive:false });
    document.addEventListener('gesturechange', e => e.preventDefault(), { passive:false });
    document.addEventListener('gestureend', e => e.preventDefault(), { passive:false });

    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(e){
      const now = Date.now();
      if (now - lastTouchEnd <= 300) e.preventDefault();
      lastTouchEnd = now;
    }, { passive:false });

    // ×¤×ª×™×—×”/×¡×’×™×¨×” ×ª×¤×¨×™×˜
    const controlsPanel = document.getElementById('controlsPanel');
    const overlay = document.getElementById('overlay');
    const gearBtn = document.getElementById('gearBtn');

    function openMenu(){ controlsPanel.classList.add('open'); overlay.classList.add('open'); }
    function closeMenu(){ controlsPanel.classList.remove('open'); overlay.classList.remove('open'); }

    gearBtn.addEventListener('click', () => {
      if (controlsPanel.classList.contains('open')) closeMenu();
      else openMenu();
    });
    overlay.addEventListener('click', closeMenu);

    // ××¦×‘ ×ª×¦×•×’×” FIT / FILL
    let VIEW_MODE = 'FIT';
    const modeBtn = document.getElementById('modeBtn');
    modeBtn.addEventListener('click', () => {
      VIEW_MODE = (VIEW_MODE === 'FIT') ? 'FILL' : 'FIT';
      modeBtn.textContent = `××¦×‘: ${VIEW_MODE}`;
      fitToScreen();
    });

    function fitToScreen(){
      const capture = document.getElementById('captureTarget');
      const img = document.getElementById('bgImage');
      const stage = document.querySelector('.stage');

      const nw = img.naturalWidth || 0;
      const nh = img.naturalHeight || 0;
      if (!nw || !nh) return;

      // ×§×•××¤×•×–×™×¦×™×” ×‘×’×•×“×œ ×”××§×•×¨×™
      capture.style.width  = nw + 'px';
      capture.style.height = nh + 'px';

      const vv = window.visualViewport;
      const rect = stage.getBoundingClientRect();
      let availW = rect.width;
      let availH = rect.height;
      if (vv) { availW = Math.min(availW, vv.width); availH = Math.min(availH, vv.height); }

      const pad = 8;
      availW = Math.max(50, availW - pad*2);
      availH = Math.max(50, availH - pad*2);

      const sContain = Math.min(availW / nw, availH / nh);
      const sCover   = Math.max(availW / nw, availH / nh);
      const scale = (VIEW_MODE === 'FILL') ? sCover : sContain;

      capture.style.transform = `translate(-50%, -50%) scale(${scale})`;
    }

    function updateText(elementId, val){
      const el = document.getElementById(elementId);
      if (!el) return;
      // ×—×œ×§ ××”×©×“×•×ª ××©×ª××©×™× ×‘-<br>
      el.innerHTML = val;
    }

    function toGematria(num){
      const letters = ['', '×', '×‘', '×’', '×“', '×”', '×•', '×–', '×—', '×˜', '×™', '×™×', '×™×‘', '×™×’', '×™×“', '×˜×•', '×˜×–', '×™×–', '×™×—', '×™×˜', '×›', '×›×', '×›×‘', '×›×’', '×›×“', '×›×”', '×›×•', '×›×–', '×›×—', '×›×˜', '×œ', '×œ×'];
      return num > 30 ? num : letters[num];
    }

    document.getElementById('dateInput').addEventListener('change', function(){
      if (!this.value) return;
      const d = new Date(this.value);

      const parts = new Intl.DateTimeFormat('he-IL-u-ca-hebrew', { weekday:'long', month:'long', day:'numeric' }).formatToParts(d);
      let weekday='', month='', dayNum=0;
      parts.forEach(p => {
        if (p.type==='weekday') weekday=p.value;
        if (p.type==='month') month=p.value;
        if (p.type==='day') dayNum=parseInt(p.value,10);
      });

      document.getElementById('dayName').innerText = weekday.replace('×™×•× ', '');
      document.getElementById('hebDate').innerText = `${toGematria(dayNum)} ×‘${month} ×ª×©×¤"×“`;

      const gDate = `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`;
      document.getElementById('dateText').innerText = gDate;
    });

    async function saveImage(){
      const original = document.getElementById('captureTarget');
      const img = document.getElementById('bgImage');

      const nw = img.naturalWidth || 0;
      const nh = img.naturalHeight || 0;
      if (!nw || !nh) { alert('×”×¨×§×¢ ×¢×“×™×™×Ÿ ×œ× × ×˜×¢×Ÿ ×œ×’××¨×™. × ×¡×” ×©×•×‘ ×‘×¢×•×“ ×©× ×™×™×”.'); return; }

      // Clone × ×¡×ª×¨ ××—×•×¥ ×œ××¡×š â€” ×¦×™×œ×•× ××œ× ×ª××™×“
      const clone = original.cloneNode(true);
      clone.style.position = 'fixed';
      clone.style.left = '-100000px';
      clone.style.top = '0';
      clone.style.transform = 'none';
      clone.style.width = nw + 'px';
      clone.style.height = nh + 'px';
      clone.style.boxShadow = 'none';
      clone.style.overflow = 'hidden';
      clone.style.background = '#fff';

      // ×œ×”×¡×™×¨ id ×›×“×™ ×œ× ×œ×”×ª× ×’×©
      clone.querySelectorAll('[id]').forEach(el => el.removeAttribute('id'));

      // ×œ×•×•×“× ×ª××•× ×” ×‘×§×œ×•×Ÿ ×××œ××ª 100%Ã—100%
      const cimg = clone.querySelector('img');
      if (cimg){
        cimg.style.width = '100%';
        cimg.style.height = '100%';
        cimg.style.objectFit = 'contain';
        cimg.style.display = 'block';
      }

      document.body.appendChild(clone);

      // ×œ×”××ª×™×Ÿ ×œ×ª××•× ×” ×‘×§×œ×•×Ÿ
      await new Promise(resolve => {
        if (!cimg) return resolve();
        if (cimg.complete && cimg.naturalWidth) return resolve();
        cimg.onload = () => resolve();
        cimg.onerror = () => resolve();
      });

      try{
        const canvas = await html2canvas(clone, { useCORS:true, scale:2, backgroundColor:null });
        const link = document.createElement('a');
        link.download = "henna_final.jpg";
        link.href = canvas.toDataURL("image/jpeg", 0.92);
        link.click();
      } finally {
        clone.remove();
      }
    }

    // init ×ª×¦×•×’×”
    const bg = document.getElementById('bgImage');
    function kickFit(){ requestAnimationFrame(fitToScreen); }

    bg.addEventListener('load', kickFit);
    document.addEventListener('DOMContentLoaded', kickFit);

    if (bg.complete && bg.naturalWidth){
      setTimeout(kickFit, 0);
      setTimeout(kickFit, 120);
    }

    window.addEventListener('resize', kickFit);
    window.addEventListener('orientationchange', () => { setTimeout(kickFit,150); setTimeout(kickFit,550); });

    if (window.visualViewport){
      window.visualViewport.addEventListener('resize', kickFit);
      window.visualViewport.addEventListener('scroll', kickFit);
    }
  </script>
</body>
</html>
