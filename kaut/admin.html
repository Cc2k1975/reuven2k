<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ××©×—×§ - ×’×¨×¡×” ×¡×•×¤×™×ª</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Rubik', sans-serif; background: #f0f2f5; margin: 0; padding: 0; }
        
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        #login-box { background: white; padding: 30px; border-radius: 10px; text-align: center; width: 300px; }
        
        .main-content { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .main-content { grid-template-columns: 1fr; } }

        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, select { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        
        .btn-start { background: #27ae60; }
        .btn-stop { background: #e74c3c; font-size: 0.8rem; }
        .btn-reveal { background: #e67e22; border: 2px solid #d35400; }
        .btn-next { background: #2980b9; }
        .btn-winner { background: #f1c40f; color: #2c3e50; font-size: 1.3rem; border: 2px solid #f39c12; animation: pulse 2s infinite; }
        
        .btn-icon { width: auto; padding: 5px 10px; margin: 0 0 0 5px; float: left; }
        .btn-del { background: #c0392b; }
        .btn-edit { background: #f39c12; }
        .btn-add { background: #2980b9; }
        .btn-update-mode { background: #f39c12; }
        .btn-cancel { background: #95a5a6; }

        .question-item { background: #f9f9f9; border: 1px solid #eee; padding: 10px; margin-bottom: 10px; border-radius: 5px; overflow: hidden; }
        .status-badge { display: inline-block; padding: 5px 10px; border-radius: 5px; font-size: 0.8em; font-weight: bold; color: white; margin-bottom: 10px; }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div id="login-box">
            <h2>ğŸ”’ ×›× ×™×¡×” ×œ×× ×”×œ</h2>
            <input type="password" id="pass-input" placeholder="×”×›× ×¡ ×¡×™×¡××”">
            <button onclick="checkPass()" style="background:#2c3e50;">×›× ×™×¡×”</button>
            <p id="error-msg" style="color:red; display:none;">×¡×™×¡××” ×©×’×•×™×”!</p>
        </div>
    </div>

    <div id="app-content">
        <h1 style="text-align:center; color:#2c3e50;">××¢×¨×›×ª × ×™×”×•×œ</h1>
        <div class="main-content">
            <div class="col-right">
                <div class="card" style="border-top: 5px solid #27ae60;">
                    <h2>ğŸš€ × ×™×”×•×œ ×‘×–××Ÿ ×××ª</h2>
                    <div id="status-indicator" class="status-badge" style="background:#95a5a6;">×××ª×™×Ÿ...</div>
                    <p>×©×—×§× ×™× ××—×•×‘×¨×™×: <b id="connected-count">0</b></p>
                    
                    <button class="btn-start" onclick="startGame()">â–¶ï¸ ×”×ª×—×œ ××©×—×§ ×—×“×©</button>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <button class="btn-reveal" onclick="revealResults()">ğŸ›‘ ×¢×¦×•×¨ ×¡×‘×‘</button>
                        <button class="btn-next" onclick="nextQuestion()">â¡ï¸ ×©××œ×” ×”×‘××”</button>
                    </div>

                    <div id="winner-section" style="display:none; margin-top:20px; border-top:1px solid #eee; padding-top:10px;">
                        <p>×¡×™×™×× ×• ××ª ×”×©××œ×•×ª! ×›×¢×ª ××¤×©×¨ ×œ×¢×‘×•×¨ ×¢×œ ×”×ª×©×•×‘×•×ª ×•××– ×œ×—×©×•×£:</p>
                        <button class="btn-winner" onclick="revealFinalWinner()">ğŸ† ×—×©×•×£ ××ª ×”×× ×¦×—!</button>
                    </div>

                    <button class="btn-stop" onclick="resetGame()" style="margin-top:20px;">ğŸ”„ ××™×¤×•×¡ ××œ×</button>
                </div>

                <div class="card" id="editor-card">
                    <h2 id="editor-title">â• ×”×•×¡×£ ×©××œ×”</h2>
                    <input type="text" id="q-text" placeholder="×©××œ×”...">
                    <input type="text" id="ans-1" placeholder="×ª×©×•×‘×” 1">
                    <input type="text" id="ans-2" placeholder="×ª×©×•×‘×” 2">
                    <input type="text" id="ans-3" placeholder="×ª×©×•×‘×” 3">
                    <input type="text" id="ans-4" placeholder="×ª×©×•×‘×” 4">
                    <select id="correct-idx">
                        <option value="0">×ª×©×•×‘×” 1 × ×›×•× ×”</option>
                        <option value="1">×ª×©×•×‘×” 2 × ×›×•× ×”</option>
                        <option value="2">×ª×©×•×‘×” 3 × ×›×•× ×”</option>
                        <option value="3">×ª×©×•×‘×” 4 × ×›×•× ×”</option>
                    </select>
                    <button id="save-btn" class="btn-add" onclick="saveQuestion()">×©××•×¨</button>
                    <button id="cancel-btn" class="btn-cancel" onclick="cancelEdit()" style="display:none;">×‘×™×˜×•×œ</button>
                </div>
                
                <div class="card">
                     <label>×›×•×ª×¨×ª:</label>
                     <div style="display:flex; gap:5px;"><input type="text" id="game-title"><button onclick="updateTitle()" style="width:auto; margin:0; background:#2980b9;">×¢×“×›×Ÿ</button></div>
                </div>
            </div>

            <div class="col-left">
                <div class="card">
                    <h2>ğŸ“š ×‘× ×§ ×©××œ×•×ª (<span id="q-count">0</span>)</h2>
                    <div id="questions-list"></div>
                    <button onclick="loadDefaults()" style="background:#bdc3c7; color:#333; margin-top:20px;">×˜×¢×Ÿ ×©××œ×•×ª ×œ×“×•×’××”</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, remove, push, update, onValue, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyDJN7sN1lT5Qi8zFV6ad8PtXc6oc7cElY0", authDomain: "kaut-72127.firebaseapp.com", databaseURL: "https://kaut-72127-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "kaut-72127", storageBucket: "kaut-72127.firebasestorage.app", messagingSenderId: "125458113848", appId: "1:125458113848:web:6b7acfd03b629cebb90dcd" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let currentQuestions = [];
        let editingKey = null;
        let currentQIndex = 0;

        window.checkPass = function() {
            if (document.getElementById('pass-input').value === '4451') {
                document.getElementById('login-overlay').style.display = 'none';
                document.querySelector('.main-content').style.display = 'grid';
            } else { document.getElementById('error-msg').style.display = 'block'; }
        };

        onValue(ref(db, 'questions'), (snapshot) => {
            const listDiv = document.getElementById('questions-list');
            listDiv.innerHTML = '';
            const data = snapshot.val();
            let count = 0;
            if (data) {
                const entries = Object.entries(data); 
                currentQuestions = entries;
                entries.forEach(([key, q]) => {
                    count++;
                    const div = document.createElement('div');
                    div.className = 'question-item';
                    if(key === editingKey) div.classList.add('editing-now');
                    div.innerHTML = `<div style="float:left;"><button class="btn-icon btn-del" onclick="deleteQ('${key}')">ğŸ—‘ï¸</button><button class="btn-icon btn-edit" onclick="editQ('${key}')">âœï¸</button></div><div style="margin-left: 10px;"><div style="font-weight:bold;">${count}. ${q.q}</div><div style="color:gray; font-size:0.9em;">×ª×©×•×‘×”: ${q.ans[q.correct]}</div></div>`;
                    listDiv.appendChild(div);
                });
            }
            document.getElementById('q-count').innerText = count;
        });

        onValue(ref(db, 'players'), (s) => { document.getElementById('connected-count').innerText = s.size; });
        onValue(ref(db, 'gameSettings/title'), (s) => { if(s.val()) document.getElementById('game-title').value = s.val(); });

        onValue(ref(db, 'gameState'), (s) => {
            const st = s.val();
            const badge = document.getElementById('status-indicator');
            const winnerSec = document.getElementById('winner-section');
            if(!st) return;
            currentQIndex = st.qIndex || 0;
            
            winnerSec.style.display = 'none'; // ×”×¡×ª×¨×” ×›×‘×¨×™×¨×ª ××—×“×œ

            if(st.status === 'playing') {
                badge.innerText = `×©××œ×” ${currentQIndex + 1} ×¨×¦×”`;
                badge.style.background = "#e74c3c";
            } else if (st.status === 'round_results') {
                badge.innerText = "×ª×•×¦××•×ª ×¡×™×‘×•×‘";
                badge.style.background = "#e67e22";
            } else if (st.status === 'summary') {
                badge.innerText = "×¡×™×›×•× ×©××œ×•×ª (×× ×¦×— ××•×¡×ª×¨)";
                badge.style.background = "#3498db"; // ×›×—×•×œ
                winnerSec.style.display = 'block'; // ×”×¦×’×ª ×›×¤×ª×•×¨ ×”×—×©×™×¤×”!
            } else if (st.status === 'finished') {
                badge.innerText = "××©×—×§ ×”×¡×ª×™×™× - ×× ×¦×— × ×—×©×£";
                badge.style.background = "#f1c40f"; // ×–×”×‘
                badge.style.color = "#333";
            } else {
                badge.innerText = "×××ª×™×Ÿ";
                badge.style.background = "#95a5a6";
            }
        });

        window.startGame = function() {
             get(ref(db, 'questions')).then(qSnap => {
                 if(!qSnap.exists()) return alert("××™×Ÿ ×©××œ×•×ª ×‘×‘× ×§!");
                 get(ref(db, 'players')).then(pSnap => {
                    const updates = {};
                    if(pSnap.exists()) {
                        pSnap.forEach(c => {
                            updates['players/' + c.key + '/score'] = 0;
                            updates['players/' + c.key + '/lastAnswerTime'] = 0;
                            updates['players/' + c.key + '/lastAnswerCorrect'] = false;
                        });
                    }
                    updates['gameState'] = { status: 'playing', qIndex: 0, startTime: Date.now() };
                    update(ref(db), updates);
                 });
             });
        };

        window.revealResults = function() { update(ref(db, 'gameState'), { status: 'round_results' }); };

        window.nextQuestion = function() {
             const nextIdx = currentQIndex + 1;
             
             // ×× × ×’××¨×• ×”×©××œ×•×ª -> ×”×•×œ×›×™× ×œ××¦×‘ "×¡×™×›×•×" (Summary) ×‘××§×•× ×™×©×¨ ×œ"×¡×™×•×"
             if (nextIdx >= currentQuestions.length) {
                 update(ref(db, 'gameState'), { status: 'summary' });
                 return;
             }

             get(ref(db, 'players')).then(snap => {
                 const updates = {};
                 if(snap.exists()) {
                    snap.forEach(p => {
                        updates['players/' + p.key + '/lastAnswerCorrect'] = false;
                        updates['players/' + p.key + '/lastAnswerTime'] = 0;
                    });
                 }
                 updates['gameState'] = { status: 'playing', qIndex: nextIdx, startTime: Date.now() };
                 update(ref(db), updates);
             });
        };

        // ×”×¤×•× ×§×¦×™×” ×”×—×“×©×” ×œ×—×©×™×¤×” ×”×¡×•×¤×™×ª
        window.revealFinalWinner = function() {
            update(ref(db, 'gameState'), { status: 'finished' });
        };

        window.resetGame = function() {
            if(!confirm("×–×” ×™×¢×™×£ ××ª ×›×œ ×”×©×—×§× ×™×. ×‘×˜×•×—?")) return;
            remove(ref(db, 'players'));
            update(ref(db, 'gameState'), { status: 'waiting', qIndex: 0 });
        };

        // (×¤×•× ×§×¦×™×•×ª ×”×¢×¨×™×›×” ×”×•×¡×¨×• ×œ×§×™×¦×•×¨, ×”×Ÿ ×–×”×•×ª ×œ×§×•×“×)
        window.saveQuestion = function() {
            const q = document.getElementById('q-text').value;
            const a1 = document.getElementById('ans-1').value;
            const a2 = document.getElementById('ans-2').value;
            const a3 = document.getElementById('ans-3').value;
            const a4 = document.getElementById('ans-4').value;
            const correct = parseInt(document.getElementById('correct-idx').value);
            if (!q || !a1) return alert("×—×¡×¨×™× × ×ª×•× ×™×!");
            const qObj = { q: q, ans: [a1, a2, a3, a4], correct: correct };
            if (editingKey) set(ref(db, 'questions/' + editingKey), qObj).then(() => cancelEdit());
            else push(ref(db, 'questions'), qObj).then(() => cancelEdit());
        };
        window.editQ = function(key) {
            const found = currentQuestions.find(item => item[0] === key);
            if (!found) return;
            const qData = found[1];
            document.getElementById('q-text').value = qData.q;
            document.getElementById('ans-1').value = qData.ans[0];
            document.getElementById('ans-2').value = qData.ans[1];
            document.getElementById('ans-3').value = qData.ans[2];
            document.getElementById('ans-4').value = qData.ans[3];
            document.getElementById('correct-idx').value = qData.correct;
            editingKey = key;
            document.getElementById('editor-title').innerText = "×¢×¨×•×š ×©××œ×”";
            document.getElementById('cancel-btn').style.display = "inline-block";
        };
        window.cancelEdit = function() {
            editingKey = null;
            document.getElementById('q-text').value = ""; document.getElementById('ans-1').value = ""; document.getElementById('ans-2').value = ""; document.getElementById('ans-3').value = ""; document.getElementById('ans-4').value = "";
            document.getElementById('editor-title').innerText = "×”×•×¡×£ ×©××œ×”";
            document.getElementById('cancel-btn').style.display = "none";
        };
        window.deleteQ = function(key) { if(confirm("×œ××—×•×§?")) remove(ref(db, 'questions/' + key)); };
        window.updateTitle = function() { set(ref(db, 'gameSettings/title'), document.getElementById('game-title').value); };
        window.loadDefaults = function() {
             const defaultQuestions = [{ q: "× ×™×¡×™×•×Ÿ", ans: ["1", "2", "3", "4"], correct: 0 }];
             push(ref(db, 'questions'), defaultQuestions[0]);
        };
    </script>
</body>
</html>
