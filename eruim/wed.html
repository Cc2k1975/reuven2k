<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <title>××—×•×œ×œ ×—×ª×•× ×” - ×’×¨×¡×” ×¡×•×¤×™×ª (Final)</title>

  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Rubik:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <style>
    :root { --text-color:#1a1a1a; --gold-color:#c5a059; }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden; /* ×‘×œ×™ ×’×œ×™×œ×” ×‘×“×£ ×¢×¦××• */
      background: #111;
      font-family: 'Rubik', sans-serif;
      -webkit-text-size-adjust: 100%;
    }

    /* ××¤×œ×™×§×¦×™×” ×‘××¡×š ××œ× */
    .app {
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      background: #111;
      padding-top: env(safe-area-inset-top);
      padding-right: env(safe-area-inset-right);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
    }

    /* ××–×•×¨ ×”×ª×¦×•×’×” â€“ ×ª××™×“ ×‘××¨×›×– */
    .stage {
      width: 100%;
      height: 100%;
      display: grid;
      place-items: center;
      overflow: hidden;
      box-sizing: border-box;
      padding: 10px;
    }

    .preview-area {
      position: relative;
      background: #fff;
      box-shadow: 0 0 40px rgba(0,0,0,0.55);
      overflow: hidden;
      transform-origin: center center;
      will-change: transform;
      user-select: none;

      /* ×—×©×•×‘: ×¨×§ ×›××Ÿ "×—×•×¡××™×" ××—×•×•×ª, ×œ× ×¢×œ ×›×œ ×”×“×£ */
      touch-action: manipulation;
    }

    #bgImage {
      display: block;
      width: auto;
      height: auto;
      max-width: none;
      max-height: none;
      pointer-events: none;
    }

    .final-element {
      position: absolute;
      transform-origin: center center;
      text-align: center;
      color: var(--text-color);
      white-space: nowrap;
      filter: blur(0.4px);
      transform: translate(-50%, -50%);
    }

    /* --- ×¢×™×¦×•×‘ ×˜×§×¡×˜ --- */
    .bsd-txt { font-size: 14px; font-weight: 500; }
    .names-txt { font-family: 'Playfair Display', serif; font-size: 40px; display: flex; gap: 30px; direction: ltr; align-items: center; }
    .intro-txt { font-size: 14px; line-height: 1.3; }
    .greg-txt { font-size: 32px; font-weight: 900; letter-spacing: 2px; }
    .left-date-txt { font-weight: 900; font-size: 16px; letter-spacing: 1px; }
    .loc-title-txt { font-weight: 700; font-size: 16px; }
    .address-txt { font-weight: 500; font-size: 14px; }
    .time-box { display: flex; flex-direction: column; align-items: center; }
    .icon { font-size: 24px; margin-bottom: 2px; }
    .flower-icon { color: var(--gold-color); font-size: 24px; }
    .parents-txt { font-size: 12px; text-align: center; line-height: 1.3; }
    .initial-txt { font-family: 'Playfair Display', serif; font-size: 80px; font-weight: 400; line-height: 1; }

    /* ====== ×©×œ×™×˜×”: ×‘××—×©×‘ ×§×•×¤×¡×” ×¨×’×™×œ×” ×œ××¢×œ×” ====== */
    .controls {
      position: fixed;
      top: calc(env(safe-area-inset-top) + 10px);
      left: 50%;
      transform: translateX(-50%);
      z-index: 2000;

      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
      align-items: flex-end;

      background: rgba(40,40,40,0.92);
      border: 1px solid rgba(140,140,140,0.35);
      border-radius: 14px;
      padding: 12px;
      width: min(980px, calc(100vw - 24px));
      color: #fff;
      backdrop-filter: blur(10px);
    }

    .input-group { display:flex; flex-direction:column; gap:5px; }
    label { font-size: 0.85rem; color: #ddd; }

    input[type="text"], input[type="date"] {
      padding: 10px 10px;
      border-radius: 10px;
      border: none;
      font-family: 'Rubik', sans-serif;
      width: 150px;
      font-size: 0.95rem;
      outline: none;
    }

    button {
      background: #4CAF50;
      color: #fff;
      border: none;
      padding: 12px 18px;
      border-radius: 12px;
      font-weight: 900;
      cursor: pointer;
      height: 44px;
      font-size: 1rem;
      white-space: nowrap;
    }

    .btn-gear {
      display: none;
      position: fixed;
      z-index: 2500;
      right: calc(env(safe-area-inset-right) + 12px);
      bottom: calc(env(safe-area-inset-bottom) + 12px);
      width: 54px;
      height: 54px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(30,30,30,0.92);
      color: #fff;
      font-size: 22px;
      font-weight: 900;
      display: grid;
      place-items: center;
      backdrop-filter: blur(10px);
    }

    /* ====== ××•×‘×™×™×œ: ×©×œ×™×˜×” ×›××’×™×¨×” ××œ××˜×” ====== */
    @media (max-width: 820px) {
      .controls {
        top: auto;
        bottom: 0;
        left: 0;
        transform: none;
        width: 100vw;
        max-width: none;
        border-radius: 18px 18px 0 0;
        padding: 12px 12px calc(12px + env(safe-area-inset-bottom));
        justify-content: flex-start;
        overflow: auto;
        max-height: 58vh;

        /* ××’×™×¨×” */
        transition: transform 220ms ease;
        transform: translateY(100%);
      }
      .controls.open { transform: translateY(0); }
      .btn-gear { display: grid; }
      input[type="text"], input[type="date"] { width: 140px; }
      button { width: 100%; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="stage">
      <div class="preview-area" id="captureTarget">
        <img id="bgImage" src="wed2.jpg" onerror="alert('×—×¡×¨×” ×ª××•× ×” wed2.jpg')" alt="×¨×§×¢">

        <div class="final-element" style="left: 88.0%; top: 34.0%; transform: translate(-50%, -50%) rotate(4.5deg) scale(1.00);">
          <div class="bsd-txt">×‘×¡"×“</div>
        </div>

        <div class="final-element" style="left: 72.2%; top: 45.6%; transform: translate(-50%, -50%) rotate(5.0deg) scale(0.80);">
          <div class="names-txt" id="namesText"><span>Dor</span><span class="flower-icon">â€</span><span>Shani</span></div>
        </div>

        <div class="final-element" style="left: 72.0%; top: 52.0%; transform: translate(-50%, -50%) rotate(5.0deg) scale(1.00);">
          <div class="intro-txt">
            ×× ×• × ×¨×’×©×™× ×œ×”×–××™× ×›× ×œ×—×’×•×’ ××™×ª× ×• ××ª ×—×ª×•× ×ª× ×•<br>
            ×©×ª×¢×¨×š ×‘×™×•× <span id="dayName">×—××™×©×™</span>, <span id="hebDate">×›' ×‘××“×¨ ×”×ª×©×¦"×</span>
          </div>
        </div>

        <div class="final-element" style="left: 73.0%; top: 59.0%; transform: translate(-50%, -50%) rotate(5.0deg) scale(1.00);">
          <div class="greg-txt" id="gregDate">07.03.2030</div>
        </div>

        <div class="final-element" style="left: 72.0%; top: 64.0%; transform: translate(-50%, -50%) rotate(5.0deg) scale(1.00);">
          <div class="loc-title-txt" id="locTitleText">××•×œ××™ "× ×•××¨"</div>
        </div>

        <div class="final-element" style="left: 72.0%; top: 66.0%; transform: translate(-50%, -50%) rotate(5.0deg) scale(1.00);">
          <div class="address-txt" id="addressText">×”×©×“×¨×” 14, ×ª×œ ××‘×™×‘</div>
        </div>

        <div class="final-element" style="left: 72.0%; top: 73.0%; transform: translate(-50%, -50%) rotate(5.0deg) scale(1.00);">
          <div style="display:flex; gap:60px;">
            <div class="time-box"><div class="icon">ğŸ’</div><b id="timeChupa">20:30</b><small>×—×•×¤×” ×•×§×™×“×•×©×™×Ÿ</small></div>
            <div class="time-box"><div class="icon">ğŸ¥‚</div><b id="timeReception">19:30</b><small>×§×‘×œ×ª ×¤× ×™×</small></div>
          </div>
        </div>

        <div class="final-element" style="left: 58.3%; top: 82.4%; transform: translate(-50%, -50%) rotate(5.0deg) scale(1.00);">
          <div class="parents-txt">
            <b>×”×•×¨×™ ×”×—×ª×Ÿ</b><br><span id="parentsGroomName">×œ×‘× ×” ×•×™×•×¡×™ ×¨××•×‘× ×™</span>
          </div>
        </div>

        <div class="final-element" style="left: 83.5%; top: 84.7%; transform: translate(-50%, -50%) rotate(5.0deg) scale(1.00);">
          <div class="parents-txt">
            <b>×”×•×¨×™ ×”×›×œ×”</b><br><span id="parentsBrideName">×–×™×•×” ×•×’×™×œ ×™×•×¡×£</span>
          </div>
        </div>

        <div class="final-element" style="left: 31.2%; top: 29.3%; transform: translate(-50%, -50%) rotate(-5.0deg) scale(1.00);">
          <div class="initial-txt" id="groomInitialText">D</div>
        </div>

        <div class="final-element" style="left: 33.3%; top: 54.1%; transform: translate(-50%, -50%) rotate(-5.0deg) scale(1.00);">
          <div class="initial-txt" id="brideInitialText">S</div>
        </div>

        <div class="final-element" style="left: 33.9%; top: 65.4%; transform: translate(-50%, -50%) rotate(-5.0deg) scale(1.00);">
          <div class="left-date-txt" id="leftDateText">07.03.2030</div>
        </div>
      </div>
    </div>

    <button class="btn-gear" id="gearBtn" type="button" aria-label="×¤×ª×—/×¡×’×•×¨ ×©×œ×™×˜×”">âš™ï¸</button>

    <div class="controls" id="controlsPanel">
      <div class="input-group">
        <label>×©× ×”×—×ª×Ÿ (×× ×’×œ×™×ª):</label>
        <input type="text" id="groomInput" value="Dor" inputmode="text" oninput="updateNames()">
      </div>

      <div class="input-group">
        <label>×©× ×”×›×œ×” (×× ×’×œ×™×ª):</label>
        <input type="text" id="brideInput" value="Shani" inputmode="text" oninput="updateNames()">
      </div>

      <div class="input-group">
        <label>×ª××¨×™×š:</label>
        <input type="date" id="dateInput">
      </div>

      <div class="input-group">
        <label>×©×¢×•×ª (×§×‘"×¤ / ×—×•×¤×”):</label>
        <div style="display:flex; gap:8px;">
          <input type="text" value="19:30" placeholder="×§×‘''×¤" style="width:78px;" inputmode="numeric" oninput="updateText('timeReception', this.value)">
          <input type="text" value="20:30" placeholder="×—×•×¤×”" style="width:78px;" inputmode="numeric" oninput="updateText('timeChupa', this.value)">
        </div>
      </div>

      <div class="input-group">
        <label>××•×œ× ×•×›×ª×•×‘×ª:</label>
        <input type="text" value='××•×œ××™ "× ×•××¨"' oninput="updateText('locTitleText', this.value)">
        <input type="text" value="×”×©×“×¨×” 14, ×ª×œ ××‘×™×‘" oninput="updateText('addressText', this.value)">
      </div>

      <div class="input-group">
        <label>×”×•×¨×™× (×—×ª×Ÿ / ×›×œ×”):</label>
        <input type="text" value="×œ×‘× ×” ×•×™×•×¡×™ ×¨××•×‘× ×™" placeholder="×”×•×¨×™ ×”×—×ª×Ÿ" oninput="updateText('parentsGroomName', this.value)">
        <input type="text" value="×–×™×•×” ×•×’×™×œ ×™×•×¡×£" placeholder="×”×•×¨×™ ×”×›×œ×”" oninput="updateText('parentsBrideName', this.value)">
      </div>

      <button type="button" onclick="saveImage()">ğŸ“· ×©××•×¨</button>
    </div>
  </div>

  <script>
    // ===== ×—×¡×™××ª pinch-to-zoom + double-tap zoom (×‘×œ×™ ×œ×”×¨×•×’ inputs) =====
    document.addEventListener('gesturestart', e => e.preventDefault(), { passive:false });
    document.addEventListener('gesturechange', e => e.preventDefault(), { passive:false });
    document.addEventListener('gestureend', e => e.preventDefault(), { passive:false });

    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (e) {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) e.preventDefault();
      lastTouchEnd = now;
    }, { passive:false });

    // ===== ××’×™×¨×” ×‘××•×‘×™×™×œ =====
    const controlsPanel = document.getElementById('controlsPanel');
    const gearBtn = document.getElementById('gearBtn');
    if (gearBtn) {
      gearBtn.addEventListener('click', () => {
        controlsPanel.classList.toggle('open');
      });
    }

    // ===== FIT: ×¡×§×™×™×œ ××—×™×“ ×œ×›×œ ×”×”×–×× ×” ×›×“×™ ×©×ª×™×›× ×¡ ×œ××¡×š =====
    function fitToScreen() {
      const capture = document.getElementById('captureTarget');
      const img = document.getElementById('bgImage');
      const stage = document.querySelector('.stage');

      const nw = img.naturalWidth || 0;
      const nh = img.naturalHeight || 0;
      if (!nw || !nh) return;

      // ×××“×™ ×”×§×•××¤×•×–×™×¦×™×” = ×”××™×“×•×ª ×”××§×•×¨×™×•×ª ×©×œ ×”×ª××•× ×”
      capture.style.width = nw + 'px';
      capture.style.height = nh + 'px';

      // ×’×•×“×œ ×–××™×Ÿ (×›×•×œ×œ ×”×ª×××•×ª ×œ-visualViewport ×× ×™×©)
      const vv = window.visualViewport;
      const stageRect = stage.getBoundingClientRect();
      let availW = stageRect.width;
      let availH = stageRect.height;

      if (vv) {
        // ×‘××•×‘×™×™×œ ×–×” ×™×•×ª×¨ ××“×•×™×§ ×›×©××§×œ×“×ª/×¡×¨×’×œ×™× ××©× ×™× ×’×•×‘×”
        availW = Math.min(availW, vv.width);
        availH = Math.min(availH, vv.height);
      }

      const pad = 10;
      availW = Math.max(50, availW - pad * 2);
      availH = Math.max(50, availH - pad * 2);

      const scale = Math.min(availW / nw, availH / nh);
      capture.style.transform = `scale(${scale})`;
    }

    // ===== ×¤×•× ×§×¦×™×•×ª ×”×ª×•×›×Ÿ ×”××§×•×¨×™×•×ª ×©×œ×š =====
    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, m => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[m]));
    }

    function updateNames() {
      const groom = document.getElementById('groomInput').value;
      const bride = document.getElementById('brideInput').value;

      document.getElementById('namesText').innerHTML =
        `<span>${escapeHtml(groom)}</span><span class="flower-icon">â€</span><span>${escapeHtml(bride)}</span>`;

      if (groom.length > 0) document.getElementById('groomInitialText').innerText = groom.charAt(0).toUpperCase();
      if (bride.length > 0) document.getElementById('brideInitialText').innerText = bride.charAt(0).toUpperCase();
    }

    function updateText(elementId, val) {
      const el = document.getElementById(elementId);
      if (el) el.innerText = val;
    }

    function toGematria(num) {
      const letters = ['', '×', '×‘', '×’', '×“', '×”', '×•', '×–', '×—', '×˜', '×™', '×™×', '×™×‘', '×™×’', '×™×“', '×˜×•', '×˜×–', '×™×–', '×™×—', '×™×˜', '×›', '×›×', '×›×‘', '×›×’', '×›×“', '×›×”', '×›×•', '×›×–', '×›×—', '×›×˜', '×œ', '×œ×'];
      return num > 30 ? num : letters[num];
    }

    document.getElementById('dateInput').addEventListener('change', function() {
      if (!this.value) return;
      const d = new Date(this.value);

      const parts = new Intl.DateTimeFormat('he-IL-u-ca-hebrew', { weekday:'long', month:'long', day:'numeric' }).formatToParts(d);
      let weekday='', month='', dayNum=0;
      parts.forEach(p => {
        if (p.type==='weekday') weekday=p.value;
        if (p.type==='month') month=p.value;
        if (p.type==='day') dayNum=parseInt(p.value,10);
      });

      document.getElementById('dayName').innerText = weekday.replace('×™×•× ', '');
      document.getElementById('hebDate').innerText = `${toGematria(dayNum)} ×‘${month} ×ª×©×¤"×“`;

      const gDate = `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`;
      document.getElementById('gregDate').innerText = gDate;
      document.getElementById('leftDateText').innerText = gDate;
    });

    function saveImage() {
      const captureElement = document.getElementById('captureTarget');
      const prevTransform = captureElement.style.transform;

      // ×¦×™×œ×•× ×‘×’×•×“×œ ×”××§×•×¨×™ (×‘×œ×™ scale ×œ××¡×š)
      captureElement.style.transform = 'scale(1)';

      html2canvas(captureElement, { useCORS: true, scale: 2, backgroundColor: null }).then(canvas => {
        const link = document.createElement('a');
        link.download = "wedding_invite_final.jpg";
        link.href = canvas.toDataURL("image/jpeg", 0.9);
        link.click();
      }).finally(() => {
        captureElement.style.transform = prevTransform;
        fitToScreen();
      });
    }

    // ===== init =====
    updateNames();

    const bg = document.getElementById('bgImage');
    bg.addEventListener('load', () => {
      fitToScreen();
    });

    // ×”×ª×××•×ª ×œ××¡×š/×¡×™×‘×•×‘/×¡×¨×’×œ×™×
    window.addEventListener('resize', () => requestAnimationFrame(fitToScreen));
    window.addEventListener('orientationchange', () => {
      setTimeout(fitToScreen, 150);
      setTimeout(fitToScreen, 550);
    });
    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', () => requestAnimationFrame(fitToScreen));
      window.visualViewport.addEventListener('scroll', () => requestAnimationFrame(fitToScreen));
    }
  </script>
</body>
</html>
