<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<title>×©×¨×˜×•×˜ ×—×›× - ×¦×™×œ×•× â†’ ×–×™×”×•×™ ×¦×œ×¢×•×ª â†’ ×©×¨×˜×•×˜ ××“×•×™×§</title>

<script async src="https://docs.opencv.org/4.7.0/opencv.js" onload="__onCvScriptLoaded()"></script>

<style>
:root{--bg:#f4f6f9;--card:#fff;--text:#111827;--muted:#6b7280;--primary:#2563eb;--danger:#dc2626;--line:#e5e7eb;}
*{box-sizing:border-box}
body{margin:0;padding:16px;font-family:system-ui,Arial;background:var(--bg);color:var(--text)}
.wrap{max-width:980px;margin:0 auto}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:14px;box-shadow:0 10px 25px rgba(0,0,0,.08)}
h2{margin:0 0 10px}
.btn{width:100%;padding:14px;border:0;border-radius:12px;background:var(--primary);color:#fff;font-size:18px;cursor:pointer}
.btn.secondary{background:#111827}
.btn:disabled{opacity:.55}
video,canvas{width:100%;border-radius:12px;border:1px solid var(--line);background:#fff}
.hidden{display:none}
input{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;font-size:16px;margin-bottom:10px}
.note{color:var(--muted);font-size:14px;margin-top:8px}
.status{padding:10px;border-radius:12px;border:1px solid var(--line)}
.status.good{border-color:#22c55e}
.status.bad{border-color:#dc2626}
#zoomWrap{margin-top:10px}
#zoomWrap input{width:100%}
#resultContainer{overflow:auto}
</style>
</head>

<body>
<div class="wrap">

<!-- CAMERA -->
<div class="card">
<h2>1ï¸âƒ£ ×¦×™×œ×•× ×©×¨×˜×•×˜</h2>
<div id="statusBox" class="status">×××ª×—×œâ€¦</div>
<video id="video" autoplay playsinline></video>
<canvas id="photo" class="hidden"></canvas>
<br><br>
<button id="btnShot" class="btn" disabled>ğŸ“¸ ×¦×œ×</button>
<button id="btnRestart" class="btn secondary">ğŸ”„ ××ª×—×œ</button>
</div>

<!-- OVERLAY -->
<div class="card hidden" id="previewCard">
<h2>2ï¸âƒ£ ×–×™×”×•×™ ×•××¡×¤×•×¨ ×¦×œ×¢×•×ª</h2>
<canvas id="overlay"></canvas>
<div id="overlayInfo" class="note"></div>
</div>

<!-- INPUTS -->
<div class="card hidden" id="inputsCard">
<h2>3ï¸âƒ£ ×”×–×Ÿ ××™×“×•×ª (×‘×¡×´×)</h2>
<div id="inputs"></div>
<button id="btnBuild" class="btn">ğŸ“ ×‘× ×” ×©×¨×˜×•×˜</button>
</div>

<!-- RESULT -->
<div class="card hidden" id="resultCard">
<h2>4ï¸âƒ£ ×©×¨×˜×•×˜ ×¡×•×¤×™</h2>

<div id="zoomWrap">
<label>ğŸ” ×–×•×:</label>
<input type="range" min="50" max="200" value="100" id="zoomRange">
</div>

<div id="resultContainer">
<canvas id="result"></canvas>
</div>

<div id="report" class="note"></div>
</div>

</div>

<script>
let video=document.getElementById("video"),
photo=document.getElementById("photo"),
overlay=document.getElementById("overlay"),
result=document.getElementById("result"),
btnShot=document.getElementById("btnShot"),
btnRestart=document.getElementById("btnRestart"),
btnBuild=document.getElementById("btnBuild"),
statusBox=document.getElementById("statusBox"),
zoomRange=document.getElementById("zoomRange"),
resultContainer=document.getElementById("resultContainer");

let cvReady=false, videoReady=false, stream=null;
let polyPts=[], edgeDirs=[], edgeCount=0;

function setStatus(t,c){statusBox.textContent=t;statusBox.className="status"+(c?" "+c:"")}
function updateBtn(){btnShot.disabled=!(cvReady&&videoReady)}

function __onCvScriptLoaded(){
let i=setInterval(()=>{try{let t=new cv.Mat();t.delete();cvReady=true;setStatus("OpenCV ××•×›×Ÿ âœ…","good");updateBtn();clearInterval(i)}catch{}},80)
}

async function startCamera(){
try{
stream&&stream.getTracks().forEach(t=>t.stop());
stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{exact:"environment"}}});
video.srcObject=stream;
await video.play();
videoReady=true;
setStatus("××¦×œ××” ××•×›× ×” âœ…","good");
updateBtn();
}catch(e){setStatus("×©×’×™××ª ××¦×œ××”","bad")}
}

function capture(){
photo.width=video.videoWidth;
photo.height=video.videoHeight;
photo.getContext("2d").drawImage(video,0,0);
}

function centroid(p){return p.reduce((a,b)=>({x:a.x+b.x,y:a.y+b.y}),{x:0,y:0})}
function sortPts(p){
let c=centroid(p);c.x/=p.length;c.y/=p.length;
return [...p].sort((a,b)=>Math.atan2(a.y-c.y,a.x-c.x)-Math.atan2(b.y-c.y,b.x-c.x))
}
function snap(dx,dy){return Math.abs(dx)>Math.abs(dy)?{dx:Math.sign(dx)||1,dy:0}:{dx:0,dy:Math.sign(dy)||1}}

function detect(){
let src=cv.imread(photo),g=new cv.Mat(),b=new cv.Mat(),e=new cv.Mat();
cv.cvtColor(src,g,cv.COLOR_RGBA2GRAY);
cv.GaussianBlur(g,b,new cv.Size(5,5),0);
cv.Canny(b,e,60,180);
let cs=new cv.MatVector(),h=new cv.Mat();
cv.findContours(e,cs,h,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);
let best=null,ma=0;
for(let i=0;i<cs.size();i++){let a=cv.contourArea(cs.get(i));if(a>ma){ma=a;best=cs.get(i)}}
let ap=new cv.Mat();cv.approxPolyDP(best,ap,0.02*cv.arcLength(best,true),true);
let pts=[];
for(let i=0;i<ap.rows;i++)pts.push({x:ap.intPtr(i,0)[0],y:ap.intPtr(i,0)[1]});
polyPts=sortPts(pts);edgeCount=polyPts.length;
edgeDirs=[];
for(let i=0;i<edgeCount;i++){
let a=polyPts[i],b=polyPts[(i+1)%edgeCount];
edgeDirs.push(snap(b.x-a.x,b.y-a.y));
}
overlay.width=photo.width;overlay.height=photo.height;
let o=overlay.getContext("2d");o.drawImage(photo,0,0);
o.strokeStyle="#2563eb";o.lineWidth=6;o.beginPath();
o.moveTo(polyPts[0].x,polyPts[0].y);
polyPts.forEach(p=>o.lineTo(p.x,p.y));o.closePath();o.stroke();
o.fillStyle="#fff";o.font="bold 40px system-ui";o.textAlign="center";o.textBaseline="middle";
for(let i=0;i<edgeCount;i++){
let p1=polyPts[i],p2=polyPts[(i+1)%edgeCount];
o.fillText(i+1,(p1.x+p2.x)/2,(p1.y+p2.y)/2);
}
document.getElementById("previewCard").classList.remove("hidden");
buildInputs();
src.delete();g.delete();b.delete();e.delete();cs.delete();h.delete();ap.delete();
}

function buildInputs(){
let box=document.getElementById("inputs");box.innerHTML="";
for(let i=0;i<edgeCount;i++){
let inp=document.createElement("input");
inp.type="number";inp.placeholder="×¦×œ×¢ "+(i+1)+" ×‘×¡×´×";
box.appendChild(inp);
}
document.getElementById("inputsCard").classList.remove("hidden");
}

function polygonArea(pts){
let a=0;
for(let i=0;i<pts.length-1;i++)a+=pts[i].x*pts[i+1].y-pts[i+1].x*pts[i].y;
return Math.abs(a)/2;
}

function buildFinal(){
let vals=[...document.querySelectorAll("#inputs input")].map(i=>+i.value);
let pts=[{x:0,y:0}];let x=0,y=0;
for(let i=0;i<edgeCount;i++){x+=edgeDirs[i].dx*vals[i];y+=edgeDirs[i].dy*vals[i];pts.push({x,y})}
let areaCm=polygonArea(pts);
let areaM=areaCm/10000;
let xs=pts.map(p=>p.x),ys=pts.map(p=>p.y);
let minX=Math.min(...xs),maxX=Math.max(...xs),minY=Math.min(...ys),maxY=Math.max(...ys);
let W=900,H=520,p=60;
let sc=Math.min((W-2*p)/(maxX-minX||1),(H-2*p)/(maxY-minY||1));
result.width=W;result.height=H;
let c=result.getContext("2d");
c.clearRect(0,0,W,H);
c.strokeStyle="#2563eb";c.lineWidth=3;c.fillStyle="rgba(37,99,235,0.07)";
c.beginPath();
c.moveTo(p+(pts[0].x-minX)*sc,p+(pts[0].y-minY)*sc);
pts.forEach(pt=>c.lineTo(p+(pt.x-minX)*sc,p+(pt.y-minY)*sc));
c.closePath();c.fill();c.stroke();
document.getElementById("report").textContent=
`×”×™×§×£: ${vals.reduce((a,b)=>a+b,0)} ×¡×´× | ×©×˜×—: ${areaCm.toFixed(0)} ×¡×´×Â² (${areaM.toFixed(2)} ×"×¨)`;
document.getElementById("resultCard").classList.remove("hidden");
}

zoomRange.oninput=()=>{result.style.transform=`scale(${zoomRange.value/100})`;result.style.transformOrigin="top right"};

btnShot.onclick=()=>{capture();detect()};
btnRestart.onclick=()=>{startCamera()};
btnBuild.onclick=()=>{buildFinal()};

startCamera();
</script>
</body>
</html>