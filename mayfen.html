<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>×¤×Ÿ ××§×¡×¤×¨×¡ â€“ ×§×‘×™×¢×ª ×ª×•×¨</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#d4af37">
<link rel="apple-touch-icon" href="/Icon app.png" />

<style>
body {font-family:Arial,Helvetica,sans-serif;background:#000;margin:0;padding:0;color:#d4af37;}
.hero-logo{width:92px;display:block;margin:-6px auto -12px auto;}
.wrap{max-width:520px;margin:4px auto;padding:20px 24px 24px;background:#111;border-radius:16px;box-shadow:0 6px 18px rgba(255,215,0,0.25);}
h1{margin:0 0 4px;font-size:33px;color:#ffd700;text-align:center;}
h2{margin:0 0 16px;font-size:20.7px;color:#d4af37;text-align:center;}
label{display:block;margin:12px 4px 5px;font-weight:600;color:#ffd700;font-size:16.6px;}
input,select,button{width:100%;padding:12px 14px;border:1px solid #d4af37;border-radius:10px;font-size:16.6px;box-sizing:border-box;background:#222;color:#ffd700;}
input[type="tel"]{text-align:right;}
.btn{background:#d4af37;color:#000;border:0;cursor:pointer;margin-top:16px;font-weight:700;font-size:16.6px;}
.btn[disabled]{opacity:.6;cursor:not-allowed;}
.btn-secondary{background:#000;color:#ffd700;border:1px solid #d4af37;margin-top:9px;font-size:14.5px;padding:10px;}
.btn-secondary img.icon{width:26.4px;height:26.4px;vertical-align:middle;margin:0 6px;}
.error{background:#330000;color:#ff6666;border:1px solid #ff9999;padding:9px;border-radius:10px;margin-top:9px;display:none;font-size:15px;}
.success{background:#003300;color:#66ff99;border:1px solid #99ffcc;padding:9px;border-radius:10px;margin-top:9px;display:none;font-size:15px;}
option.taken{color:#888;background:#333;}
.ver{margin-top:14px;font-size:12.4px;color:#bfa76f;text-align:center;}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:50;}
.modal{background:#111;border-radius:14px;max-width:420px;width:92%;padding:18px;box-shadow:0 0 25px rgba(255,215,0,.3);color:#ffd700;}
.modal h3{margin:0 0 8px;font-size:20.7px;color:#ffd700;}
.modal p{margin:0 0 14px;color:#ffd700;white-space:pre-line;font-size:15px;}
.modal .row{display:flex;gap:10px;justify-content:space-between;}
.modal .row button{flex:1;padding:10px;border-radius:10px;border:0;font-weight:700;font-size:15px;}
.modal .cancel{background:#222;color:#ffd700;border:1px solid #ffd700;}
.modal .ok{background:#ffd700;color:#000;}
</style>
</head>
<body>

<img src="https://reuven2k.com/exe.gif" alt="×¤×Ÿ ××§×¡×¤×¨×¡" class="hero-logo" />
<div class="wrap">
  <h1>×¤×Ÿ ××§×¡×¤×¨×¡</h1>
  <h2>××¢×¨×›×ª ×œ×–×™××•×Ÿ ×ª×•×¨×™×</h2>
  <div id="msgError" class="error"></div>
  <div id="msgOk" class="success"></div>

  <label for="date">×‘×—×¨×™ ×ª××¨×™×š:</label>
  <input type="date" id="date" required />

  <label for="time">×‘×—×¨×™ ×©×¢×” ×¤× ×•×™×”:</label>
  <select id="time" required><option value="">×˜×•×¢×Ÿ ×©×¢×•×ªâ€¦</option></select>

  <label for="name">×©× ×”×œ×§×•×—×”:</label>
  <input type="text" id="name" placeholder="×”×›× ×¡ ×©×" required />

  <label for="phone">××¡×¤×¨ ×˜×œ×¤×•×Ÿ:</label>
  <input type="tel" id="phone" placeholder="×”×›× ×¡ ×˜×œ×¤×•×Ÿ" required />

  <button id="save" class="btn">×©××•×¨</button>

  <button id="galleryBtn" type="button" class="btn-secondary"><b>×’×œ×¨×™×™×ª ×¢×‘×•×“×•×ª</b></button>
  <button id="navWaze" type="button" class="btn-secondary">
    <b>× ×•×•×˜ ×œ ×¤×Ÿ-××§×¡×¤×¨×¡</b>
    <img class="icon" src="https://reuven2k.com/map.png" alt="" />
  </button>

  <div class="ver">Version: 1.6.4</div>
</div>

<div id="icsModal" class="modal-backdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <h3>×œ×”×•×¡×™×£ ×ª×–×›×•×¨×ª ×œ×™×•××Ÿ?</h3>
    <p id="icsText">× ×™×¦×•×¨ ××™×¨×•×¢ ×œ×™×•××Ÿ ×‘×ª××¨×™×š ___ ×‘×©×¢×” ___ ×›×•×œ×œ ×ª×–×›×•×¨×ª ×©×¢×” ×œ×¤× ×™.
×œ×§×•×—×” ×™×§×¨×”, ××–×›×™×¨×” ×œ×š ×œ×”×’×™×¢ ×—×¤×•×¤×” ×•×‘×–××Ÿ ğŸ’‡â€â™€ï¸
×ª×•×“×” - ×¤×Ÿ ××§×¡×¤×¨×¡</p>
    <div class="row">
      <button type="button" class="cancel" id="btnCancel">×‘×™×˜×•×œ</button>
      <button type="button" class="ok" id="btnOk">××™×©×•×¨</button>
    </div>
  </div>
</div>

<script>
/* === ×›×œ ××¢×¨×›×ª ×”×–×× ×ª ×”×ª×•×¨×™× ×©×œ×š ×‘×“×™×•×§ ×›×¤×™ ×©×”×™×™×ª×” === */
const BIN_ID='68f0e7bed0ea881f40a63b29';
const MASTER_KEY='$2a$10$4rynniEMuvwqg2nDb5KSEe/lAVYp8a7L3xWzp9GsO6n49OfXc3FCO';
const BIN_URL='https://api.jsonbin.io/v3/b/'+BIN_ID;
const MAP_URL='https://maps.google.com/?q=33.003292,35.108864';
const WAZE_DEEP='waze://?ll=33.003292,35.108864&navigate=yes';
const WAZE_WEB='https://waze.com/ul?ll=33.003292%2C35.108864&navigate=yes';
const GALLERY_URL='https://reuven2k.com/images/index.html';
const TIMEZONE='Asia/Jerusalem';
const EVENT_TITLE='×ª×•×¨ ×œ ×¤×Ÿ ××§×¡×¤×¨×¡';
const ALARM_MINUTES=60;
const SLOT_MINUTES=20;
const pad2=n=>(n<10?('0'+n):''+n);
function genTimeSlots(){const s=[];for(let h=8;h<=20;h++){for(let m of[0,20,40]){if(h===20&&m>0)continue;s.push(`${pad2(h)}:${pad2(m)}`);}}return s;}
const SLOTS=genTimeSlots();
function todayStr(){return new Date().toISOString().slice(0,10);}
function addDaysStr(dy){const d=new Date();d.setDate(d.getDate()+dy);return d.toISOString().slice(0,10);}
const elDate=document.getElementById('date'),elTime=document.getElementById('time'),elName=document.getElementById('name'),elPhone=document.getElementById('phone'),elSave=document.getElementById('save'),msgErr=document.getElementById('msgError'),msgOk=document.getElementById('msgOk'),icsModal=document.getElementById('icsModal'),btnOk=document.getElementById('btnOk'),btnCancel=document.getElementById('btnCancel'),icsText=document.getElementById('icsText'),btnGallery=document.getElementById('galleryBtn');
function showErr(t){msgErr.textContent=t;msgErr.style.display='block';setTimeout(()=>msgErr.style.display='none',4000);}
function showOk(t){msgOk.textContent=t;msgOk.style.display='block';setTimeout(()=>msgOk.style.display='none',4000);}
function setDateLimits(){elDate.min=todayStr();elDate.max=addDaysStr(3);if(!elDate.value)elDate.value=todayStr();}
setDateLimits();
btnGallery.addEventListener('click',()=>window.location.href=GALLERY_URL);
async function fetchRecord(){const r=await fetch(BIN_URL+'?ts='+Date.now(),{headers:{'X-Master-Key':MASTER_KEY},cache:'no-store'});if(!r.ok)throw new Error('fetch');const j=await r.json();return j.record||{bookings:[]};}
async function putRecord(rec){await fetch(BIN_URL+'?ts='+Date.now(),{method:'PUT',headers:{'Content-Type':'application/json','X-Master-Key':MASTER_KEY},body:JSON.stringify(rec),cache:'no-store'});}
function validPhone(p){return(p||'').replace(/\D/g,'').length>=8;}
function normalizePhone(p){return(p||'').replace(/\D/g,'');}
async function refreshTimes(){elTime.innerHTML='<option>×˜×•×¢×Ÿâ€¦</option>';try{const{bookings}=await fetchRecord();const date=elDate.value;const taken=new Set(bookings.filter(b=>b.date===date).map(b=>b.time));elTime.innerHTML='<option value="">×‘×—×¨ ×©×¢×”â€¦</option>'+SLOTS.map(t=>`<option value="${t}"${taken.has(t)?'disabled class="taken"':''}>${t}${taken.has(t)?' â€“ ×ª×¤×•×¡':''}</option>`).join('');}catch(e){showErr('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×');}}
elDate.addEventListener('change',refreshTimes);refreshTimes();
function fmtDateHeb(s){const[y,m,d]=s.split('-');return`${d}.${m}.${y}`;}
function toICSLocal(ds,ts){const[y,m,d]=ds.split('-').map(Number);const[hh,mm]=ts.split(':').map(Number);const dt=new Date(y,m-1,d,hh,mm,0);return`${dt.getFullYear()}${pad2(dt.getMonth()+1)}${pad2(dt.getDate())}T${pad2(dt.getHours())}${pad2(dt.getMinutes())}00`;}
function buildICS({title,location,startLocal,endLocal,tzid}){return['BEGIN:VCALENDAR','VERSION:2.0','BEGIN:VEVENT',`SUMMARY:${title}`,`LOCATION:${location}`,`DTSTART;TZID=${tzid}:${startLocal}`,`DTEND;TZID=${tzid}:${endLocal}`,'END:VEVENT','END:VCALENDAR'].join('\r\n');}
function openCalendarDirect(ds,ts){const ua=navigator.userAgent,isAndroid=/Android/i.test(ua),isIOS=/iPhone|iPad|iPod/i.test(ua);const[y,m,d]=ds.split('-').map(Number);const[hh,mm]=ts.split(':').map(Number);const start=new Date(y,m-1,d,hh,mm,0);const end=new Date(start.getTime()+SLOT_MINUTES*60000);
if(isAndroid){const fmt=dt=>`${dt.getFullYear()}${pad2(dt.getMonth()+1)}${pad2(dt.getDate())}T${pad2(dt.getHours())}${pad2(dt.getMinutes())}00`;const url=`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(EVENT_TITLE)}&dates=${fmt(start)}/${fmt(end)}&details=${encodeURIComponent(MAP_URL)}`;window.location.href=url;return;}
if(isIOS){const s=toICSLocal(ds,ts),e=`${end.getFullYear()}${pad2(end.getMonth()+1)}${pad2(end.getDate())}T${pad2(end.getHours())}${pad2(end.getMinutes())}00`;const ics=buildICS({title:EVENT_TITLE,location:MAP_URL,startLocal:s,endLocal:e,tzid:TIMEZONE});const blob=new Blob([ics],{type:'text/calendar'});const url=URL.createObjectURL(blob);window.location.href=url;setTimeout(()=>URL.revokeObjectURL(url),3000);return;}}

let lastSaved=null;
elSave.addEventListener('click',async()=>{const p={date:elDate.value,time:elTime.value,name:elName.value.trim(),phone:elPhone.value.trim()};if(!p.date||!p.time||!p.name||!p.phone){showErr('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª');return;}if(!validPhone(p.phone)){showErr('××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×ª×§×™×Ÿ');return;}
elSave.disabled=true;try{let rec=await fetchRecord();const exists=rec.bookings.some(b=>b.date===p.date&&b.time===p.time);if(exists){showErr('×”×©×¢×” × ×ª×¤×¡×”');elSave.disabled=false;return;}rec.bookings.push({...p,ts:Date.now()});await putRecord(rec);lastSaved=p;showOk('×”×ª×•×¨ × ×©××¨ ×‘×”×¦×œ×—×”!');icsText.textContent=`× ×™×¦×•×¨ ××™×¨×•×¢ ×œ×™×•××Ÿ ×‘×ª××¨×™×š ${fmtDateHeb(p.date)} ×‘×©×¢×” ${p.time} ×›×•×œ×œ ×ª×–×›×•×¨×ª ×©×¢×” ×œ×¤× ×™.`;icsModal.style.display='flex';refreshTimes();elTime.value="";elName.value="";elPhone.value="";}catch(e){showErr('×©×’×™××ª ×¨×©×ª');}finally{elSave.disabled=false;}});
btnCancel.onclick=()=>icsModal.style.display='none';
btnOk.onclick=()=>{icsModal.style.display='none';if(lastSaved)openCalendarDirect(lastSaved.date,lastSaved.time);}
if('serviceWorker'in navigator){navigator.serviceWorker.register('/sw.js').catch(()=>{});}

/* âœ… ×ª×•×¡×¤×ª × ×§×™×™×” â€” ×”×¦×¢×” ×œ×”×ª×§× ×” ×œ××¡×š ×”×‘×™×ª */
let deferredPrompt;
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();
  deferredPrompt=e;
  if(localStorage.getItem('pwaShown'))return;
  const btn=document.createElement('button');
  btn.textContent='ğŸ“² ×”×•×¡×£ ××ª ×¤×Ÿ ××§×¡×¤×¨×¡ ×œ××¡×š ×”×‘×™×ª';
  Object.assign(btn.style,{position:'fixed',bottom:'20px',left:'50%',transform:'translateX(-50%)',background:'#ffd700',color:'#000',border:'none',padding:'12px 18px',fontSize:'15px',borderRadius:'12px',boxShadow:'0 0 20px rgba(255,215,0,0.4)',fontWeight:'700',cursor:'pointer',zIndex:'9999',opacity:'0',transition:'opacity 0.3s'});
  document.body.appendChild(btn);
  setTimeout(()=>btn.style.opacity='1',150);
  btn.onclick=async()=>{
    btn.remove();
    localStorage.setItem('pwaShown','1');
    deferredPrompt.prompt();
    await deferredPrompt.userChoice;
    deferredPrompt=null;
  };
});
</script>
</body>
</html>
