<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>BUYRU â€“ ×–×™×”×•×™ ×¢×•×‘×“ + ×¡×¨×™×§×” ×¨×¦×™×¤×”</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f172a; --ink:#f8fafc; --muted:#9aa8c7;
    --card:#0b1224; --border:1px solid rgba(255,255,255,.08);
    --accent:#22c55e; --radius:16px; --shadow:0 16px 36px rgba(0,0,0,.35);
    --pill:#0c1a31; --danger:#ef4444;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:Heebo,system-ui,Arial;background:var(--bg);color:var(--ink)}
  .wrap{max-width:860px;margin:0 auto;padding:18px}
  header{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px}
  h1{margin:0;font-size:20px;font-weight:800}
  .btn{padding:10px 14px;border:0;border-radius:12px;font-weight:800;cursor:pointer}
  .primary{background:linear-gradient(135deg,var(--accent),#38bdf8);color:#062;box-shadow:var(--shadow)}
  .ghost{background:transparent;border:var(--border);color:#dbeafe}
  .danger{background:var(--danger);color:#fff}
  .panel{background:#0b1630;border:var(--border);border-radius:var(--radius);padding:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input[type="text"]{padding:10px 12px;border-radius:12px;border:var(--border);background:#0b1630;color:#e5e7eb;min-width:220px}
  .camDock{position:relative;width:360px;max-width:100%;aspect-ratio:16/10;border-radius:14px;overflow:hidden;border:var(--border);background:#000}
  .camDock video{width:100%;height:100%;object-fit:cover}
  .scanLine{position:absolute;left:8%;right:8%;top:50%;height:2px;background:rgba(255,255,255,.65);transform:translateY(-50%);box-shadow:0 0 12px rgba(255,255,255,.55)}
  .grid{display:grid;gap:14px;margin-top:14px}
  @media(min-width:800px){ .grid{grid-template-columns:1fr 1fr} }
  .shot{background:var(--card);border:var(--border);border-radius:16px;padding:14px}
  .list{display:flex;flex-direction:column;gap:10px;max-height:70vh;overflow:auto}
  .item{display:grid;grid-template-columns:88px 1fr auto;gap:10px;align-items:center;background:#0b1630;border:var(--border);border-radius:14px;padding:8px}
  .thumb{width:88px;height:88px;border-radius:10px;object-fit:contain;background:#000}
  .code{font-weight:900;font-size:18px;letter-spacing:.5px}
  .pill{background:var(--pill);border:var(--border);border-radius:999px;padding:4px 10px;font-size:12px;color:#cbd5e1;display:inline-block}
  .note{font-size:12px;color:var(--muted)}
  .foot{margin-top:12px;text-align:center;color:var(--muted);font-size:12px}
  .hide{display:none!important}
  .emp{font-weight:800}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>BUYRU â€“ ×–×™×”×•×™ ×¢×•×‘×“ + ×¡×¨×™×§×” ×¨×¦×™×¤×”</h1>
    <button id="btnSwitchUser" class="btn ghost hide">×”×—×œ×£ ×¢×•×‘×“</button>
  </header>

  <!-- ×©×œ×‘ 1: ×–×™×”×•×™ ×¢×•×‘×“ -->
  <section id="stepUser" class="panel">
    <div class="row" style="margin-bottom:10px">
      <div style="font-weight:800">×–×™×”×•×™ ×¢×•×‘×“</div>
      <span class="note">×”×›× ×¡ ××¡×¤×¨ ×–×”×•×ª ××• ×¡×¨×•×§ ×ª×’ ×‘×¨×§×•×“</span>
    </div>
    <div class="row" style="margin-bottom:10px">
      <input id="empIdInput" type="text" placeholder="××¡×¤×¨ ×–×”×•×ª" inputmode="numeric" autocomplete="off" />
      <button id="btnUseEmp" class="btn primary">××™×©×•×¨</button>
      <input id="empCapture" type="file" accept="image/*" capture="environment" class="hide">
      <button id="btnScanTag" class="btn ghost">ğŸ“· ×¡×¨×•×§ ×ª×’</button>
      <span id="empHint" class="note"></span>
    </div>
    <div class="note">×˜×™×¤: ××¤×©×¨ ×¤×©×•×˜ ×œ×¦×œ× ××ª ×ª×’-×”×¢×•×‘×“ (×‘×¨×§×•×“) â€“ × ×–×”×” ××ª ×”××¡×¤×¨ ××•×˜×•××˜×™×ª.</div>
  </section>

  <!-- ×©×œ×‘ 2: ×¡×¨×™×§×” ×¨×¦×™×¤×” -->
  <section id="stepScan" class="hide">
    <div class="panel row" style="justify-content:space-between">
      <div class="row" style="gap:12px">
        <div class="pill">×¢×•×‘×“: <span id="empLabel" class="emp">â€”</span></div>
      </div>
      <div class="row">
        <button id="btnStart" class="btn primary">×”×¤×¢×œ ×¡×¨×™×§×”</button>
        <button id="btnStop" class="btn ghost" disabled>×¢×¦×•×¨</button>
        <select id="cameraSel" title="××¦×œ××”"></select>
        <button id="btnTorch" class="btn ghost" disabled>×¤× ×¡ ×›×‘×•×™</button>
        <button id="btnReset" class="btn danger">××™×¤×•×¡ ×¡×œ</button>
        <button id="btnExport" class="btn ghost">×™×™×¦×•× CSV</button>
        <span id="httpsWarn" class="note hide">××¦×œ××” ×“×•×¨×©×ª <b>https://</b></span>
      </div>
    </div>

    <div class="grid">
      <div class="shot">
        <div class="camDock">
          <video id="preview" playsinline muted autoplay></video>
          <div class="scanLine"></div>
        </div>
        <div class="note"></div>
      </div>

      <div class="shot">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <div class="pill">×¤×¨×™×˜×™× ×‘×¡×œ: <span id="count">0</span></div>
          <div class="note"></div>
        </div>
        <div id="list" class="list" onclick="return false;"></div>
      </div>
    </div>
  </section>

  <footer class="foot">v3.3.1</footer>
</div>

<!-- ZXing fallback -->
<script src="https://unpkg.com/@zxing/browser@0.1.1"></script>
<script>
/* ===== ××œ×× ×˜×™× ===== */
const stepUser = document.getElementById('stepUser');
const stepScan = document.getElementById('stepScan');
const btnSwitchUser = document.getElementById('btnSwitchUser');

const empIdInput = document.getElementById('empIdInput');
const empLabel   = document.getElementById('empLabel');
const empCapture = document.getElementById('empCapture');
const btnScanTag = document.getElementById('btnScanTag');
const btnUseEmp  = document.getElementById('btnUseEmp');
const empHint    = document.getElementById('empHint');

const btnStart=document.getElementById('btnStart'),btnStop=document.getElementById('btnStop'),btnTorch=document.getElementById('btnTorch'),btnReset=document.getElementById('btnReset'),btnExport=document.getElementById('btnExport'),cameraSel=document.getElementById('cameraSel'),preview=document.getElementById('preview'),listEl=document.getElementById('list'),countEl=document.getElementById('count'),httpsWarn=document.getElementById('httpsWarn');

/* ===== ××¦×‘ ===== */
let EMPLOYEE_ID = '';
let stream=null,track=null,rafId=null,reader=null,lastCode='',lastTime=0;
const DEBOUNCE_MS = 1200;
let items=[]; // {code, img}

/* ===== ×¢×–×¨×™ UI ===== */
function show(el){ el.classList.remove('hide'); }
function hide(el){ el.classList.add('hide'); }

/* ===== ×©××™×¨×” ××§×•××™×ª ===== */
function saveState(){
  try{
    localStorage.setItem('buyru_emp', EMPLOYEE_ID||'');
    localStorage.setItem('buyru_cart', JSON.stringify(items||[]));
  }catch{}
}
function loadState(){
  try{
    EMPLOYEE_ID = localStorage.getItem('buyru_emp')||'';
    items = JSON.parse(localStorage.getItem('buyru_cart')||'[]');
  }catch{ EMPLOYEE_ID=''; items=[]; }
}

/* ===== ×¡××•× ×“ ===== */
function beep(){
  try{
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type='sine'; o.frequency.value=880; o.connect(g); g.connect(ctx.destination);
    g.gain.setValueAtTime(0.18,ctx.currentTime);
    o.start(); o.stop(ctx.currentTime+0.12);
  }catch{}
}

/* ===== Employee: ××¢×‘×¨ ×‘×™×Ÿ ××¡×›×™× ===== */
function enterScan(){
  empLabel.textContent = EMPLOYEE_ID || 'â€”';
  hide(stepUser); show(stepScan); show(btnSwitchUser);
  saveState();
}
function backToUser(){
  hide(stepScan); show(stepUser); hide(btnSwitchUser);
  stopScan();
}
btnSwitchUser.addEventListener('click', backToUser);

/* ===== ××™××•×ª ×ª×´×– (×¤×©×•×˜: ×¡×¤×¨×•×ª ×‘×œ×‘×“, 5â€“10 ×¡×¤×¨×•×ª) ===== */
function isValidEmpId(v){ return /^\d{5,10}$/.test((v||'').trim()); }

/* ===== ×–×™×”×•×™ ×ª×´×– ××ª××•× ×” (×ª×’) ===== */
btnScanTag.addEventListener('click', ()=> empCapture.click());
empCapture.addEventListener('change', async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const code = await decodeSingleImage(f);
  if(code){
    empIdInput.value = code.replace(/\D/g,'');
    empHint.textContent = '×–×•×”×” ××¡×¤×¨ ××”×ª×’ â€“ ××¤×©×¨ ×œ××©×¨.';
  }else{
    empHint.textContent = '×œ× ×–×•×”×” ×‘×¨×§×•×“. × ×¡×” ×ª××•× ×” ×—×“×”/×§×¨×•×‘×” ×™×•×ª×¨.';
  }
  e.target.value='';
});
btnUseEmp.addEventListener('click', ()=>{
  const id = (empIdInput.value||'').trim();
  if(!isValidEmpId(id)){ empHint.textContent='× × ×œ×”×–×™×Ÿ ××¡×¤×¨ ×–×”×•×ª (5â€“10 ×¡×¤×¨×•×ª).'; return; }
  EMPLOYEE_ID = id;
  enterScan();
});

/* ===== ×“×™×§×•×“ ×‘×¨×§×•×“ ××ª×•×š ×ª××•× ×” ×‘×•×“×“×ª (×œ×ª×’ ×¢×•×‘×“) ===== */
async function decodeSingleImage(file){
  const bmp = await toBitmap(file);
  if('BarcodeDetector' in window){
    try{
      const det = new window.BarcodeDetector({ formats:['ean_13','ean_8','upc_a','upc_e','code_128','code_39','itf'] });
      const res = await det.detect(bmp);
      if(res && res.length) return (res[0].rawValue||'').trim();
    }catch{}
  }
  try{
    const cnv=document.createElement('canvas');
    cnv.width=bmp.width; cnv.height=bmp.height;
    cnv.getContext('2d').drawImage(bmp,0,0);
    const im=new Image(); im.src=cnv.toDataURL('image/png'); await im.decode();
    const reader = new ZXing.BrowserMultiFormatReader();
    const res = await reader.decodeFromImageElement(im).catch(()=>null);
    if(res?.text) return res.text.trim();
  }catch{}
  return '';
}
async function toBitmap(file){
  try{ return await createImageBitmap(file, { resizeWidth: 1024, resizeQuality:'high' }); }
  catch{
    const url=URL.createObjectURL(file); const img=new Image();
    img.src=url; await img.decode();
    const c=document.createElement('canvas'), s=Math.min(1, 1024/img.naturalWidth);
    c.width=Math.round(img.naturalWidth*s); c.height=Math.round(img.naturalHeight*s);
    c.getContext('2d').drawImage(img,0,0,c.width,c.height);
    URL.revokeObjectURL(url);
    return await createImageBitmap(c);
  }
}

/* ===== ××¦×œ××•×ª ===== */
(async function httpsNotice(){
  const isLocal=/^(localhost|127\.0\.0\.1)$/.test(location.hostname);
  if(location.protocol!=='https:' && !isLocal) httpsWarn.classList.remove('hide');
})();
async function listVideoInputs(){const all=await navigator.mediaDevices.enumerateDevices();return all.filter(d=>d.kind==='videoinput');}
function preferBack(devs){const backs=devs.filter(d=>/back|rear|environment/i.test(d.label||''));return backs.length?backs[backs.length-1]:devs[0];}
async function fillCameras(){
  try{
    const isLocal=/^(localhost|127\.0\.0\.1)$/.test(location.hostname);
    if(location.protocol==='https:' || isLocal){ await navigator.mediaDevices.getUserMedia({video:true}); }
  }catch{}
  const devs=await listVideoInputs();
  cameraSel.innerHTML='';
  devs.forEach((d,i)=>{
    const opt=document.createElement('option');
    opt.value=d.deviceId; opt.textContent=(d.label||`camera ${i}`)+(/(back|rear|environment)/i.test(d.label||'')?' (××—×•×¨×™×ª)':'');
    cameraSel.appendChild(opt);
  });
  const pref=preferBack(devs); if(pref) cameraSel.value=pref.deviceId;
}

/* ===== ××§×•×¨×•×ª ×ª××•× ×” ×œ××•×¦×¨ ===== */
function gtinToPath(code){ const c=(code||'').replace(/\D/g,''); const p=[]; for(let i=0;i<c.length;i+=3)p.push(c.slice(i,i+3)); return p.join('/'); }
function openFactsCandidates(code){
  const b='https://images.openfoodfacts.org/images/products/'; const p=gtinToPath(code);
  return [`${b}${p}/front.400.jpg`, `${b}${p}/front.jpg`];
}
function ramiLevyCandidates(code){
  const b=`https://img.rami-levy.co.il/product/${code}`;
  return [`${b}/small.jpg`, `${b}/large.jpg`, `https://www.rami-levy.co.il/_ipx/w_360,f_webp/${b}/small.jpg`, `https://www.rami-levy.co.il/_ipx/w_640,f_webp/${b}/large.jpg`];
}
function race(url){ return new Promise((res,rej)=>{ const im=new Image(); im.onload=()=>res(url); im.onerror=()=>rej(); im.src=url+`?t=${Date.now()}`; }); }
async function findImageFast(code){
  const cands=[...openFactsCandidates(code), ...ramiLevyCandidates(code)];
  for(let i=0;i<cands.length;i++){ try{ const ok=await race(cands[i]); if(ok) return ok; }catch{} }
  return null;
}

/* ===== ×¡×¨×™×§×” ×¨×¦×™×¤×” (BarcodeDetector ×× ×§×™×™×, ××—×¨×ª ZXing) ===== */
async function bandBitmap(v,band=0.22){
  const w=v.videoWidth||1280,h=v.videoHeight||720,bh=Math.max(40,Math.round(h*band)),y=Math.round((h-bh)/2);
  const c=document.createElement('canvas'); c.width=w; c.height=bh;
  c.getContext('2d',{willReadFrequently:true}).drawImage(v,0,y,w,bh,0,0,w,bh);
  return await createImageBitmap(c);
}
async function liveDetectContinuous(){
  const det=new window.BarcodeDetector({formats:['ean_13','ean_8','upc_a','upc_e']});
  const loop=async()=>{
    try{
      const now=Date.now();
      const bmp=await bandBitmap(preview,0.22);
      const res=await det.detect(bmp);
      if(res && res.length){
        const code=(res[0].rawValue||'').trim();
        // ×©×™× ×•×™: ×××¤×©×¨ ×”×•×¡×¤×” ×—×•×–×¨×ª ×©×œ ××•×ª×• ×§×•×“ (× ×©××¨ ×“×™×‘××•× ×¡ ×‘×œ×‘×“)
        if(code && (code!==lastCode || (now-lastTime)>DEBOUNCE_MS)){
          lastCode=code; lastTime=now; beep(); onNewCode(code);
        }
      }
    }catch{}
    rafId=requestAnimationFrame(loop);
  };
  rafId=requestAnimationFrame(loop);
}

/* ===== ×¤×ª×™×—×”/×¢×¦×™×¨×” ===== */
async function openStreamWithFallbacks(deviceId){
  const tries=[
    {audio:false, video:{ deviceId: deviceId? {exact:deviceId}: undefined, width:{ideal:1280}, height:{ideal:720}, focusMode:{ideal:'continuous'} }},
    {audio:false, video:{ facingMode:{ideal:'environment'}, width:{ideal:1280}, height:{ideal:720}, focusMode:{ideal:'continuous'} }},
    {audio:false, video:{ facingMode:'environment' }},
    {audio:false, video:true}
  ];
  let lastErr=null;
  for(const c of tries){ try{ return await navigator.mediaDevices.getUserMedia(c); }catch(e){ lastErr=e; } }
  throw lastErr || new Error('No camera');
}
async function startScan(){
  await stopScan();
  if('BarcodeDetector' in window){
    const dev=cameraSel.value||undefined;
    stream=await openStreamWithFallbacks(dev);
    preview.srcObject=stream; preview.muted=true; preview.playsInline=true;
    await preview.play().catch(()=>{});
    track=stream.getVideoTracks()[0];
    btnStart.disabled=true; btnStop.disabled=false;
    try{ const caps=track?.getCapabilities?.(); if(caps?.torch){ btnTorch.disabled=false; btnTorch.textContent='×¤× ×¡ ×›×‘×•×™'; } }catch{ btnTorch.disabled=true; }
    await liveDetectContinuous();
  }else{
    btnStart.disabled=true; btnStop.disabled=false;
    reader = new ZXing.BrowserMultiFormatReader();
    await reader.decodeFromConstraints(
      { audio:false, video: cameraSel.value? {deviceId:{exact:cameraSel.value}} : {facingMode:{ideal:'environment'}} },
      preview,
      (result)=>{
        if(result){
          const code=(result.text||'').trim();
          const now=Date.now();
          // ×©×™× ×•×™: ×××¤×©×¨ ×”×•×¡×¤×” ×—×•×–×¨×ª ×©×œ ××•×ª×• ×§×•×“ (× ×©××¨ ×“×™×‘××•× ×¡ ×‘×œ×‘×“)
          if(code && (code!==lastCode || (now-lastTime)>DEBOUNCE_MS)){
            lastCode=code; lastTime=now; beep(); onNewCode(code);
          }
        }
      }
    );
  }
}
async function stopScan(){
  if(rafId) cancelAnimationFrame(rafId), rafId=null;
  if(reader) reader.reset(), reader=null;
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  track=null;
  btnStart.disabled=false; btnStop.disabled=true; btnTorch.disabled=true;
}

/* ===== ×¤× ×¡ ===== */
btnTorch.addEventListener('click', async ()=>{
  if(!track) return;
  try{
    const caps=track.getCapabilities?.(); if(!caps?.torch) return;
    const cur=track.getSettings?.().torch===true;
    await track.applyConstraints({ advanced:[{ torch: !cur }] });
    btnTorch.textContent = !cur ? '×¤× ×¡ ×“×œ×•×§' : '×¤× ×¡ ×›×‘×•×™';
  }catch{}
});

/* ===== ×œ×•×’×™×§×ª ×¡×œ ===== */
function renderList(){
  listEl.innerHTML = items.map(it=>`
    <div class="item" data-code="${it.code}">
      <img class="thumb" src="${it.img||''}" alt="">
      <div><div class="code">${it.code}</div></div>
      <button class="btn ghost danger remove-btn" data-code="${it.code}" aria-label="×”×¡×¨">×”×¡×¨ ××•×¦×¨</button>
    </div>
  `).join('');
  countEl.textContent = items.length;
}
function addItem(code,img=''){
  // ×©×™× ×•×™: ×‘×™×˜×œ×ª×™ ××ª ×× ×™×¢×ª ×”×›×¤×™×œ×•×™×•×ª ×›××Ÿ
  items.unshift({code,img});
  if(items.length>400) items.length=400;
  renderList(); saveState();
}
function updateItemImage(code,url){
  const i=items.findIndex(x=>x.code===code); if(i<0) return;
  items[i].img=url; saveState();
  const el=listEl.querySelector(`.item[data-code="${CSS.escape(code)}"] img.thumb`);
  if(el){ el.src=url; }
}
function removeItem(code){
  const idx=items.findIndex(x=>x.code===code);
  if(idx>=0){ items.splice(idx,1); renderList(); saveState(); }
}
listEl.addEventListener('click', (e)=>{
  const btn=e.target.closest('.remove-btn'); if(!btn) return;
  const code=btn.getAttribute('data-code'); removeItem(code);
});
btnReset.addEventListener('click', ()=>{
  if(confirm('×œ××¤×¡ ××ª ×”×¡×œ?')){ items=[]; renderList(); saveState(); }
});

/* ===== ×‘×¢×ª ×§×‘×œ×ª ×‘×¨×§×•×“ ×—×“×© ===== */
async function onNewCode(code){
  addItem(code);
  const img=await findImageFast(code);
  if(img) updateItemImage(code,img);
}

/* ===== CSV â€“ ×¢×‘×¨×™×ª ×ª×§×™× ×” ×‘××§×¡×œ + A1=××¡×¤×¨ ×–×”×•×ª ===== */
btnExport.addEventListener('click', ()=>{
  if(!items.length && !EMPLOYEE_ID){ alert('××™×Ÿ × ×ª×•× ×™× ×œ×™×™×¦×•×'); return; }

  // ×©×•×¨×” 1: A1 = TZ
  const rows = [[EMPLOYEE_ID || '']];

  // ×©×•×¨×” 2: ×›×•×ª×¨×•×ª ×‘×¢×‘×¨×™×ª
  rows.push(['BARCODE','PIC LINK']);

  // ××©×•×¨×” 3: ×”× ×ª×•× ×™×
  items.forEach(i => rows.push([i.code, i.img || '']));

  // ×‘× ×™×™×ª CSV ×¢× BOM ×œ-Excel ×‘×¢×‘×¨×™×ª
  const csv = rows
    .map(r => r.map(x => `"${String(x||'').replace(/"/g,'""')}"`).join(','))
    .join('\n');

  const BOM = '\uFEFF'; // ×—×•×‘×” ×›×“×™ ×œ×× ×•×¢ "×’×³×™×‘×¨×™×©" ×‘×¢×‘×¨×™×ª ×‘××§×¡×œ
  const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });

  const a = document.createElement('a');
  const empPart = EMPLOYEE_ID ? ('_'+EMPLOYEE_ID) : '';
  a.href = URL.createObjectURL(blob);
  a.download = 'buyru_scan'+empPart+'_'+new Date().toISOString().slice(0,19).replace(/[:T]/g,'_')+'.csv';
  a.click();
});

/* ===== ××ª×—×•×œ ===== */
loadState();
empIdInput.value = EMPLOYEE_ID || '';
if(EMPLOYEE_ID){ enterScan(); } else { backToUser(); }
renderList();
fillCameras();

/* ===== SCAN start/stop ===== */
btnStart.onclick=startScan; btnStop.onclick=stopScan;

/* ===== ×× ×™××¦×™×™×ª ×§×• ===== */
(function anim(){ const line=document.querySelector('.scanLine'); let t=0; const step=()=>{t+=0.02; line.style.top=`calc(50% + ${Math.sin(t)*6}px)`; requestAnimationFrame(step);}; step(); })();
</script>
</body>
</html>
