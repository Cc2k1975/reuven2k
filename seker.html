<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>טופס סקר</title>
<style>
  :root{
    --bg:#000;
    --panel:#0f0f0f;
    --panel-inner:#121212;
    --accent:#d4af37;
    --border-col:rgba(212,175,55,0.4);
    --border-col-soft:rgba(212,175,55,0.18);
    --txt:#f8e9a8;
    --ok:#145a2b;
    --err:#6b1b1b;
  }

  body{
    margin:0;
    background:var(--bg);
    color:var(--accent);
    font-family:Arial, Helvetica, sans-serif;
  }

  .wrap{
    max-width:520px;
    margin:20px auto 80px;
    background:var(--panel);
    border-radius:20px;
    box-shadow:0 24px 60px rgba(0,0,0,0.8);
    border:2px solid var(--border-col-soft);
    padding:20px 24px 32px;
  }

  h1{
    margin:0 0 16px;
    text-align:center;
    font-size:28px;
    font-weight:700;
    color:var(--accent);
  }

  .msg{
    border-radius:10px;
    padding:12px 16px;
    margin-bottom:16px;
    text-align:center;
    font-size:16px;
    font-weight:700;
    line-height:1.4;
    display:none;
    color:#fff;
  }
  .msg.ok{
    background:var(--ok);
  }
  .msg.err{
    background:var(--err);
  }

  .field{
    margin-bottom:16px;
  }
  .label{
    color:var(--accent);
    font-weight:700;
    font-size:18px;
    margin-bottom:6px;
  }

  input, select, textarea{
    width:100%;
    background:#1a1a1a;
    color:var(--accent);
    border:2px solid var(--border-col);
    border-radius:10px;
    padding:14px 16px;
    font-size:20px;
    font-weight:500;
    outline:none;
  }
  input::placeholder{
    color:#777;
  }

  select{
    appearance:none;
  }

  .btnSend{
    width:100%;
    background:var(--accent);
    color:#000;
    font-size:24px;
    font-weight:700;
    border:none;
    border-radius:12px;
    padding:16px;
    margin-top:24px;
    box-shadow:0 10px 30px rgba(212,175,55,0.4);
  }

  .versionBox{
    margin-top:24px;
    text-align:center;
    font-size:14px;
    line-height:1.5;
    color:#cabb88;
  }
</style>
</head>
<body>

<div class="wrap">

  <h1>טופס סקר</h1>

  <!-- הודעת הצלחה/שגיאה -->
  <div id="statusBox" class="msg"></div>

  <!-- מחלקה -->
  <div class="field">
    <div class="label">מחלקה:</div>
    <select id="dept">
      <option value="">בחר מחלקה…</option>
      <option>אווירודינמיקה</option>
      <option>מחמ</option>
      <option>מטה</option>
      <option>ניווט</option>
      <option>בקמ</option>
      <option>טילאות</option>
      <option>סימולציות</option>
    </select>
  </div>

  <!-- שם העובד -->
  <div class="field">
    <div class="label">שם העובד:</div>
    <input id="workerName" placeholder="שם מלא" />
  </div>

  <!-- מספר נייד -->
  <div class="field">
    <div class="label">מספר נייד:</div>
    <input id="phone" placeholder="05X-XXXXXXX" />
  </div>

  <!-- מבנה -->
  <div class="field">
    <div class="label">מבנה:</div>
    <input id="building" placeholder="לדוגמה: 66" />
  </div>

  <!-- קומה -->
  <div class="field">
    <div class="label">קומה:</div>
    <input id="floor" placeholder="לדוגמה: 3" />
  </div>

  <!-- מספר חדר -->
  <div class="field">
    <div class="label">מספר חדר:</div>
    <input id="room" placeholder="לדוגמה: 305B" />
  </div>

  <!-- כמות אריזות -->
  <div class="field">
    <div class="label">כמות אריזות:</div>
    <select id="packs">
      <option value="">בחר כמות…</option>
      <option>1</option>
      <option>2</option>
      <option>3</option>
      <option>4</option>
      <option>5</option>
    </select>
  </div>

  <!-- חדר יעד -->
  <div class="field">
    <div class="label">חדר יעד:</div>
    <input id="targetRoom" placeholder="לאן לשלוח / איפה לקבל" />
  </div>

  <button id="sendBtn" class="btnSend">שלח</button>

  <div class="versionBox">
    גרסה 1.2.0 · קובץ: Seker.html  
    שמירה בענן (JSONBin) בפורמט answers[] מצטבר.
  </div>

</div>

<script>
/*
  גרסה: 1.2.0
  קובץ: Seker.html
  אחריות: להוסיף רשומה חדשה למערך answers בבין,
  לא לדרוס!

  חשוב: אם תשנה BIN או KEY תשנה כאן וב-moadata.html באותו אופן.
*/
const BIN_ID = "68fefa3dd0ea881f40beb941";
const ACCESS_KEY = "$2a$10$cSsqpLyw9Jl/8q0El4JzqOuwLRUINEoMNeyxeUQ726QdlvNMD0iTe";
const API_BASE = "https://api.jsonbin.io/v3/b";

const statusBox   = document.getElementById("statusBox");
const btnSend     = document.getElementById("sendBtn");

/* שדות הטופס */
const f_dept       = document.getElementById("dept");
const f_name       = document.getElementById("workerName");
const f_phone      = document.getElementById("phone");
const f_building   = document.getElementById("building");
const f_floor      = document.getElementById("floor");
const f_room       = document.getElementById("room");
const f_packs      = document.getElementById("packs");
const f_targetRoom = document.getElementById("targetRoom");

function showStatus(msg,isOk){
  statusBox.style.display="block";
  statusBox.className = "msg " + (isOk?"ok":"err");
  statusBox.textContent = msg;
}
function hideStatus(){
  statusBox.style.display="none";
}

/* שלב 1: נטען את המצב הנוכחי מהבין */
async function fetchCurrentAnswers(){
  const url = `${API_BASE}/${BIN_ID}/latest`;
  try{
    const res = await fetch(url,{
      method:"GET",
      headers:{
        "Content-Type":"application/json",
        "X-Access-Key": ACCESS_KEY
      }
    });
    const text = await res.text();
    if(!res.ok){
      console.warn("GET failed", res.status, text);
      return {answers:[]};
    }
    const data = JSON.parse(text);
    // jsonbin v3:
    // {record:{...}, metadata:{...}}
    // אנחנו תמיד רוצים מבנה של {answers:[...]}.
    const record = data.record || data.data || data || {};
    if(Array.isArray(record.answers)){
      return {answers:record.answers};
    }
    // אם קיים אובייקט בודד בלי answers (legacy) נהפוך אותו לרשומה ראשונה
    if(record && Object.keys(record).length>0){
      // זה מקרה של "דורכים" ישן
      return {answers:[record]};
    }
    return {answers:[]};
  }catch(e){
    console.error("fetchCurrentAnswers error", e);
    return {answers:[]};
  }
}

/* שלב 2: נכניס את הרשומה החדשה למערך ונעלה PUT */
async function saveAnswersBack(answersArr){
  const url = `${API_BASE}/${BIN_ID}`;
  const bodyObj = { answers: answersArr };
  const res = await fetch(url,{
    method:"PUT",
    headers:{
      "Content-Type":"application/json",
      "X-Access-Key": ACCESS_KEY
    },
    body: JSON.stringify(bodyObj)
  });
  const txt = await res.text();
  if(!res.ok){
    throw new Error("PUT failed status="+res.status+" body="+txt);
  }
  return true;
}

/* יצירת רשומה חדשה מתוך הטופס */
function buildNewRecord(){
  return {
    dept:        f_dept.value.trim(),
    workerName:  f_name.value.trim(),
    phone:       f_phone.value.trim(),
    building:    f_building.value.trim(),
    floor:       f_floor.value.trim(),
    room:        f_room.value.trim(),
    packs:       f_packs.value.trim(),
    targetRoom:  f_targetRoom.value.trim(),
    ts:          new Date().toISOString()
  };
}

/* ולידציה בסיסית */
function validateForm(r){
  if(!r.dept)        return "בחר מחלקה.";
  if(!r.workerName)  return "נא למלא שם עובד.";
  if(!r.phone)       return "נא למלא טלפון.";
  if(!r.building)    return "נא למלא מבנה.";
  if(!r.floor)       return "נא למלא קומה.";
  if(!r.room)        return "נא למלא מספר חדר.";
  if(!r.packs)       return "נא לבחור כמות אריזות.";
  // targetRoom מותר לריק
  return "";
}

/* כשלוחצים שלח */
btnSend.addEventListener("click", async ()=>{
  hideStatus();

  // 1. אוסף נתונים מהטופס
  const rec = buildNewRecord();

  // 2. בדיקה
  const err = validateForm(rec);
  if(err){
    showStatus(err,false);
    return;
  }

  btnSend.disabled = true;
  btnSend.textContent = "שולח…";

  try{
    // 3. הבא מערך answers קיים מהענן
    const current = await fetchCurrentAnswers();
    const arr = current.answers || [];

    // 4. דחוף את הרשומה החדשה
    arr.push(rec);

    // 5. שמור חזרה בענן עם PUT
    await saveAnswersBack(arr);

    // הצלחה
    showStatus("נשמר בהצלחה בענן ✅",true);

    // אפס טופס
    f_dept.value="";
    f_name.value="";
    f_phone.value="";
    f_building.value="";
    f_floor.value="";
    f_room.value="";
    f_packs.value="";
    f_targetRoom.value="";

  }catch(e){
    console.error(e);
    showStatus("שגיאה בשליחה. נסה שוב.",false);
  }

  btnSend.disabled = false;
  btnSend.textContent = "שלח";
});
</script>
</body>
</html>
