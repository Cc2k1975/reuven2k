<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ריבוע קבוע</title>
  <style>
    body{
      margin:0; padding:0; background:#000;
      height:100vh; display:flex; flex-direction:column;
      overflow:hidden; font-family:Arial,sans-serif;
    }

    /* ======= זה גובה ה"ריבוע" שאתה רואה תמיד ======= */
    :root { --boxH: 300px; }  /* אם תרצה יותר/פחות, תשנה פה */

    #view-container{
      position:relative;
      width:100%;
      height: var(--boxH);
      background:#fff;
      overflow:hidden;
      border-bottom:2px solid #333;
      flex-shrink:0;
    }

    iframe{
      position:absolute;
      width:1200px;
      height:1500px;
      border:none;
      transform-origin:0 0;
      top:-200px;
      left:-200px;
      transform:scale(0.6);
      opacity:1;
      transition:opacity 0.12s linear;
      will-change: transform, top, left, opacity;
    }

    #loader{
      position:absolute;
      bottom:0; left:0;
      height:5px;
      background:#00ff00;
      width:0%;
      transition:width 1s linear;
      z-index:10;
    }

    /* ===== כפתור שמירה למעלה ===== */
    #saveTopBtn{
      position:fixed;
      top:10px;
      right:10px;
      z-index:10000;
      background:#28a745;
      color:#fff;
      border:1px solid #28a745;
      border-radius:12px;
      padding:10px 14px;
      font-size:16px;
      font-weight:bold;
      cursor:pointer;
      touch-action: manipulation;
      box-shadow: 0 4px 14px rgba(0,0,0,0.35);
    }

    /* ===== גלגל שיניים קטן שמאל למעלה ===== */
    #gearBtn{
      position:fixed;
      top:8px;
      left:8px;
      z-index:10000;
      width:26px;
      height:26px;
      border-radius:50%;
      background:rgba(255,255,255,0.20);
      color:#fff;
      border:1px solid rgba(255,255,255,0.20);
      display:none;
      align-items:center;
      justify-content:center;
      font-size:16px;
      cursor:pointer;
      touch-action: manipulation;
      user-select:none;
    }

    #controls{
      flex:1;
      background:#222;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:15px;
      padding:20px;
    }

    .row{ display:flex; gap:20px; }

    button.ctrl{
      width:70px; height:70px;
      background:#444; color:#fff;
      border:1px solid #666;
      border-radius:10px;
      font-size:24px;
      cursor:pointer;
      touch-action: manipulation;
    }
    button.ctrl:active{ background:#666; }

    button.small{
      width:auto;
      padding:0 18px;
      height:52px;
      font-size:16px;
      font-weight:bold;
      border-radius:12px;
      border:1px solid #666;
      background:#444;
      color:#fff;
      touch-action: manipulation;
    }

    #resetBtn{
      background:#dc3545;
      border-color:#dc3545;
      font-size:14px;
      height:44px;
      padding:0 18px;
      border-radius:12px;
    }

    /* ===== מצב צפייה נקי: מסתיר חצים בלבד, לא משנה גובה הריבוע ===== */
    .locked-view #controls{ display:none !important; }
    .locked-view #saveTopBtn{ display:none !important; }
    .locked-view #gearBtn{ display:flex !important; }
    .locked-view #loader{ display:none !important; } /* נקי */
  </style>
</head>
<body>

  <button id="saveTopBtn">✅ שמור</button>
  <div id="gearBtn" title="עריכה">⚙️</div>

  <div id="view-container">
    <iframe id="gameFrame" scrolling="no"></iframe>
    <div id="loader"></div>
  </div>

  <div id="controls">
    <div style="color:white; margin-bottom:10px;">כוון את התוצאה למרכז המסך:</div>

    <button class="ctrl" onclick="move(0, 20)">⬆️</button>
    <div class="row">
      <button class="ctrl" onclick="move(-20, 0)">⬅️</button>
      <button class="ctrl" onclick="move(20, 0)">➡️</button>
    </div>
    <button class="ctrl" onclick="move(0, -20)">⬇️</button>

    <div class="row" style="margin-top: 10px;">
      <button class="small" onclick="zoom(-0.05)">זום -</button>
      <button class="small" onclick="zoom(0.05)">זום +</button>
    </div>

    <button id="resetBtn" class="small" onclick="resetSettings()" style="margin-top:14px;">איפוס הגדרות</button>
  </div>

<script>
  const BASE_URL = "https://www.football.org.il/leagues/games/game/?game_id=1066561";
  const REFRESH_EVERY = 15;

  let posY = -200;
  let posX = -200;
  let scale = 0.6;

  const loader = document.getElementById('loader');
  const saveTopBtn = document.getElementById('saveTopBtn');
  const gearBtn = document.getElementById('gearBtn');

  const LS_Y = 'my_soccer_y';
  const LS_X = 'my_soccer_x';
  const LS_S = 'my_soccer_scale';
  const LS_SETUP = 'is_setup';

  function clampScale(s){ return Math.max(0.2, Math.min(2.0, s)); }
  function getFrame(){ return document.getElementById('gameFrame'); }

  function applyViewOnce(){
    const iframe = getFrame();
    iframe.style.top = posY + 'px';
    iframe.style.left = posX + 'px';
    iframe.style.transform = `scale(${scale})`;
  }
  function applyViewHard(){
    applyViewOnce();
    setTimeout(applyViewOnce, 80);
    setTimeout(applyViewOnce, 250);
    setTimeout(applyViewOnce, 700);
    setTimeout(applyViewOnce, 1400);
  }

  function persist(){
    localStorage.setItem(LS_Y, String(posY));
    localStorage.setItem(LS_X, String(posX));
    localStorage.setItem(LS_S, String(scale));
  }

  function move(dx, dy){
    posX += dx;
    posY += dy;
    applyViewOnce();
  }

  function zoom(dz){
    scale = clampScale(scale + dz);
    applyViewOnce();
  }

  function enterLockedView(){
    document.body.classList.add('locked-view');
  }
  function exitLockedView(){
    document.body.classList.remove('locked-view');
  }

  function saveAndLock(){
    persist();
    localStorage.setItem(LS_SETUP, 'true');
    enterLockedView();
    applyViewHard();
  }

  function resetSettings(){
    localStorage.removeItem(LS_Y);
    localStorage.removeItem(LS_X);
    localStorage.removeItem(LS_S);
    localStorage.removeItem(LS_SETUP);
    location.reload();
  }

  function loadSettings(){
    const isSetup = localStorage.getItem(LS_SETUP);
    if(isSetup === 'true'){
      const savedY = localStorage.getItem(LS_Y);
      const savedX = localStorage.getItem(LS_X);
      const savedS = localStorage.getItem(LS_S);

      if(savedY !== null) posY = parseInt(savedY, 10);
      if(savedX !== null) posX = parseInt(savedX, 10);
      if(savedS !== null) scale = clampScale(parseFloat(savedS));

      enterLockedView();  // נפתח נקי אוטומטית
    }
  }

  saveTopBtn.onclick = saveAndLock;
  gearBtn.onclick = () => { exitLockedView(); };

  // ריפרש יציב
  function attachLoadHandler(iframe){
    iframe.addEventListener('load', () => {
      applyViewHard();
      requestAnimationFrame(() => { iframe.style.opacity = '1'; });
    });
  }

  function createFreshIframe(){
    const old = getFrame();
    const fresh = document.createElement('iframe');
    fresh.id = 'gameFrame';
    fresh.scrolling = 'no';
    fresh.style.opacity = '0';
    attachLoadHandler(fresh);
    old.replaceWith(fresh);
    return fresh;
  }

  function setFrameSrcWithBust(iframe){
    iframe.src = BASE_URL + "&_t=" + Date.now();
  }

  function refreshIframe(){
    const iframe = createFreshIframe();
    applyViewOnce();
    setFrameSrcWithBust(iframe);
  }

  let seconds = 0;
  setInterval(() => {
    seconds++;
    if(!document.body.classList.contains('locked-view')){
      loader.style.width = (seconds / REFRESH_EVERY * 100) + "%";
    }
    if(seconds >= REFRESH_EVERY){
      refreshIframe();
      seconds = 0;
      loader.style.width = "0%";
    }
  }, 1000);

  // אתחול
  loadSettings();

  const first = getFrame();
  attachLoadHandler(first);
  first.style.opacity = '0';
  applyViewOnce();
  setFrameSrcWithBust(first);
</script>

</body>
</html>