<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>BUYRU â€“ ×¦×™×œ×•× ×‘×¨×§×•×“</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f172a; --ink:#f8fafc; --muted:#9aa8c7;
    --card:#0b1224; --border:1px solid rgba(255,255,255,.08);
    --accent:#22c55e; --radius:18px; --shadow:0 18px 40px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:Heebo,system-ui,Arial;background:var(--bg);color:var(--ink)}
  .wrap{max-width:720px;margin:0 auto;padding:20px}
  header{display:flex;align-items:center;gap:10px;margin-bottom:16px}
  h1{margin:0;font-size:20px;font-weight:800}
  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:8px;
    font-weight:800;border:0;border-radius:16px;cursor:pointer;
    padding:14px 18px;background:linear-gradient(135deg,var(--accent),#38bdf8);color:#062;
    box-shadow:var(--shadow); width:100%;
  }
  .panel{background:#0b1630;border:var(--border);border-radius:var(--radius);padding:14px}
  .note{font-size:12px;color:var(--muted);text-align:center;margin-top:8px}
  .shot{margin-top:16px;background:var(--card);border:var(--border);border-radius:var(--radius);padding:16px}
  .shot img{width:100%;max-height:360px;object-fit:contain;border-radius:12px;background:#000}
  .code{margin-top:12px;font-size:22px;font-weight:900;text-align:center;letter-spacing:1px}
  .hide{display:none!important}
  .foot{margin-top:14px;text-align:center;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <header><h1>BUYRU â€“ ×¦×™×œ×•× ×‘×¨×§×•×“</h1></header>

  <div class="panel">
    <input id="capture" type="file" accept="image/*" capture="environment" class="hide">
    <button id="btnShot" class="btn">ğŸ“· ×¦×œ× ×•×¡×¨×•×§</button>
    <div class="note">×”×ª×•×¦××” ×ª×¦×™×’ ×¨×§: ×ª××•× ×ª ××•×¦×¨ + ××§×´×˜</div>
  </div>

  <div id="box" class="shot hide">
    <img id="productImg" alt="×ª××•× ×ª ××•×¦×¨">
    <div id="code" class="code"></div>
  </div>

  <footer class="foot">v2.6.0 â€¢ ×¨×§ ×ª××•× ×” ×•××§×´×˜</footer>
</div>

<!-- ZXing ×›×’×™×‘×•×™ ×œ×¤×¢× ×•×— ×ª××•× ×” -->
<script src="https://unpkg.com/@zxing/browser@0.1.1"></script>
<script>
const capture   = document.getElementById('capture');
const btnShot   = document.getElementById('btnShot');
const box       = document.getElementById('box');
const imgProd   = document.getElementById('productImg');
const codeEl    = document.getElementById('code');

let lastCode = '';

/* ---- ×—×™×¤×•×© ×ª××•× ×ª ××•×¦×¨ (Open*Facts + ×¨××™ ×œ×•×™) â€” ×œ×œ× ×˜×§×¡×˜×™× × ×•×¡×¤×™× ---- */
function gtinToPath(code){ const c=(code||'').replace(/\D/g,''); const p=[]; for(let i=0;i<c.length;i+=3)p.push(c.slice(i,i+3)); return p.join('/'); }
function openFactsCandidates(code){
  const base=['https://images.openfoodfacts.org/images/products/','https://images.openbeautyfacts.org/images/products/','https://images.openproductsfacts.org/images/products/'];
  const path=gtinToPath(code);
  return [`${base[0]}${path}/front.400.jpg`,`${base[0]}${path}/front.jpg`,`${base[1]}${path}/front.400.jpg`,`${base[1]}${path}/front.jpg`,`${base[2]}${path}/front.400.jpg`,`${base[2]}${path}/front.jpg`];
}
function ramiLevyCandidates(code){
  const base=`https://img.rami-levy.co.il/product/${code}`;
  return [`${base}/small.jpg`,`${base}/large.jpg`,`https://www.rami-levy.co.il/_ipx/w_500,f_webp/${base}/small.jpg`,`https://www.rami-levy.co.il/_ipx/w_800,f_webp/${base}/large.jpg`];
}
function firstWorkingImage(urls){ return new Promise(res=>{ let i=0; (function next(){ if(i>=urls.length) return res(null); const url=urls[i++]; const im=new Image(); im.onload=()=>res(url); im.onerror=next; im.src=url+`?t=${Date.now()}`; })(); }); }
async function findImageByCode(code){
  return await firstWorkingImage([ ...openFactsCandidates(code), ...ramiLevyCandidates(code) ]);
}

/* ---- ×“×™×§×•×“ ×‘×¨×§×•×“ ××”×ª××•× ×” ---- */
async function toBitmap(file){
  try{ return await createImageBitmap(file); }
  catch{
    const img = new Image(); const url=URL.createObjectURL(file);
    img.src=url; await img.decode();
    const c=document.createElement('canvas'); c.width=img.naturalWidth; c.height=img.naturalHeight;
    c.getContext('2d').drawImage(img,0,0); URL.revokeObjectURL(url);
    return await createImageBitmap(c);
  }
}
async function decodeFromBitmap(bitmap){
  // 1) BarcodeDetector ×× ×§×™×™×
  if('BarcodeDetector' in window){
    try{
      const det = new window.BarcodeDetector({ formats:['ean_13','ean_8','upc_a','upc_e','code_128','code_39','itf','qr_code'] });
      const res = await det.detect(bitmap);
      if(res && res.length) return (res[0].rawValue||'').trim();
    }catch{}
  }
  // 2) ZXing ×’×™×‘×•×™
  try{
    const cnv=document.createElement('canvas'), MAX=1400, scale=Math.min(1, MAX/bitmap.width);
    cnv.width=Math.round(bitmap.width*scale); cnv.height=Math.round(bitmap.height*scale);
    cnv.getContext('2d').drawImage(bitmap,0,0,cnv.width,cnv.height);
    const im=new Image(); im.src=cnv.toDataURL('image/png'); await im.decode();
    const reader = new ZXing.BrowserMultiFormatReader();
    const result = await reader.decodeFromImageElement(im).catch(()=>null);
    if(result?.text) return result.text.trim();
  }catch{}
  return '';
}

/* ---- ×–×¨×™××” ×¨××©×™×ª: ×¦×™×œ×•× â†’ ×¤×¢× ×•×— â†’ ×”×¦×’×” ---- */
async function handleFile(file){
  if(!file) return;
  const bmp = await toBitmap(file);
  const code = await decodeFromBitmap(bmp);

  box.classList.remove('hide');        // ××¦×™×’ ××ª ×”×ª×•×¦××” ×’× ×× ×œ× × ××¦× (× ×©××¨ ×¨×™×§)
  codeEl.textContent = code ? code : '';

  if(code){
    lastCode = code;
    const url = await findImageByCode(code);
    if(url){ imgProd.src = url; }
    else { imgProd.removeAttribute('src'); }
  }else{
    imgProd.removeAttribute('src');
  }
}

btnShot.addEventListener('click', ()=>{
  // ×”×¢×¨×”: ××¢×¨×›×ª ×”×”×¤×¢×œ×” ×¢×©×•×™×” ×œ×“×¨×•×© ×”×§×©×” ×œ××™×©×•×¨ ×œ××—×¨ ×”×¦×™×œ×•× â€” ××™ ××¤×©×¨ ×œ×¢×§×•×£ ×‘×“×¤×“×¤×Ÿ
  capture.setAttribute('capture','environment');
  capture.click();
});
capture.addEventListener('change', e=>{
  const f = e.target.files?.[0];
  handleFile(f);
  e.target.value='';
});
</script>
</body>
</html>
