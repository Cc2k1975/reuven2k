<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>רישום הכנסות יומי</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0;}
    html,body{
      font-family:system-ui,"Heebo","Arial",sans-serif;
      background:#f3f5fa;
      color:#111;
      font-size:18px;
    }
    body{
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:12px;
    }
    .app{
      width:100%;
      max-width:600px;
      background:#fff;
      border-radius:16px;
      box-shadow:0 10px 24px rgba(0,0,0,0.08);
      padding:16px 14px 20px;
    }
    h1{
      font-size:22px;
      margin-bottom:4px;
      text-align:center;
    }
    .sub{
      font-size:14px;
      color:#555;
      text-align:center;
      margin-bottom:12px;
    }
    .today-date{
      text-align:center;
      font-size:16px;
      font-weight:600;
      margin-bottom:14px;
    }

    /* עיצוב לחצני ענק */
    .buttons-grid{
      display:grid;
      grid-template-columns:repeat(2, 1fr);
      gap:12px;
      margin-bottom:15px;
    }
    .btn-amount{
      height: 110px;
      font-family:inherit;
      border:none;
      border-radius:16px;
      font-size:20px;
      font-weight: 700;
      cursor:pointer;
      background:#e8f3ff;
      border:2px solid #b6d4ff;
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      transition: transform 0.1s;
    }
    .btn-amount:active{
      transform:scale(0.95);
    }

    /* לחצן ביטול */
    #undoContainer {
      height: 45px;
      margin-bottom: 10px;
      display: flex;
      justify-content: center;
    }
    .btn-undo {
      background: #ff4d4d;
      color: white;
      padding: 0 20px;
      border-radius: 20px;
      font-weight: bold;
      border: none;
      display: none;
      cursor: pointer;
      animation: fadeIn 0.3s;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .toggle-details-btn{
      width:100%;
      margin-bottom:6px;
      background:#fff3cd;
      border:1px solid #ffe08a;
      font-weight:600;
      padding: 12px;
      border-radius: 12px;
      cursor: pointer;
    }

    .section{
      margin-top:12px;
      padding:10px;
      border-radius:12px;
      background:#f7f8fc;
      border:1px solid #e1e4f0;
    }
    .section-title{
      font-size:18px;
      font-weight:600;
      margin-bottom:6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .today-total{
      margin-top:6px;
      font-weight:600;
      color:#0a5;
    }
    .list{
      margin-top:6px;
      max-height:250px;
      overflow-y:auto;
    }
    .entry-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:6px 4px;
      border-bottom:1px solid #e0e3ee;
      font-size:15px;
    }
    .btn-delete{
      background:#ffebee;
      border:1px solid #ffcdd2;
      color:#c62828;
      font-size:13px;
      padding:4px 8px;
      border-radius:10px;
    }
    .btn-sort{
      font-size: 11px;
      padding: 3px 6px;
      background: #eee;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .btn-sort.active{
      background: #0a5;
      color: white;
    }
    .details-wrapper{
      max-height:0;
      opacity:0;
      overflow:hidden;
      transition:max-height 0.4s ease, opacity 0.4s ease;
    }
    .details-wrapper.open{
      max-height:3000px;
      opacity:1;
    }
    .month-row{
      display:flex;
      flex-direction: column;
      padding:6px 2px;
      border-bottom:1px solid #dde1ee;
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="app" id="mainApp" style="display:none;">
    <h1>רישום הכנסות</h1>
    <div class="sub">סיכום יום עבודה - הזנה מהירה</div>
    <div class="today-date" id="todayDate"></div>

    <div class="buttons-grid">
      <button class="btn-amount" data-amount="50" data-label="פן 50">פן 50</button>
      <button class="btn-amount" data-amount="60" data-label="פן 60">פן 60</button>
      <button class="btn-amount" data-amount="70" data-label="פן 70">פן 70</button>
      <button class="btn-amount" data-amount="70" data-label="מסכת שיער">מסכת שיער</button>
      <button class="btn-amount" data-amount="30" data-label="ספריי לשיער">ספריי</button>
      <button class="btn-amount" data-amount="150" data-label="מכשיר פן">מכשיר פן</button>
    </div>

    <div id="undoContainer">
      <button id="undoBtn" class="btn-undo">בטל לחיצה אחרונה (5 ש')</button>
    </div>

    <button id="toggleDetails" class="toggle-details-btn">צפייה בפירוט וסיכומים</button>

    <div id="detailsWrapper" class="details-wrapper">
      <div class="section">
        <div class="section-title">היום</div>
        <div class="list" id="todayList"></div>
        <div class="today-total" id="todayTotal"></div>
      </div>

      <div class="section">
        <div class="section-title">
          <span>היסטוריה יומית</span>
          <div class="sort-btns">
            <button class="btn-sort active" id="sortByDate">תאריך</button>
            <button class="btn-sort" id="sortByCustomers">לקוחות</button>
          </div>
        </div>
        <div class="list" id="historyDays"></div>
      </div>

      <div class="section">
        <div class="section-title">סיכום חודשי</div>
        <div class="list" id="historyMonths"></div>
        <div class="today-total" id="grandTotal" style="text-align:left; direction:ltr;"></div>
      </div>
    </div>
  </div>

  <script>
    // משתנים
    let entries = [];
    let currentSortMode = 'date';
    let lastEntryId = null;
    let undoTimeout = null;
    const STORAGE_KEY = 'income_log_v1';
    const cashSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2017/2017-preview.mp3');

    // אבטחה
    (function checkLogin() {
      let entered = "";
      while (entered !== "4451") {
        entered = prompt("הקישו סיסמה:");
        if (entered === null) return;
      }
      document.getElementById('mainApp').style.display = 'block';
    })();

    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCg7xjTPHeRemfCyz0xG5uoolMR8tvVve8",
      authDomain: "sikom-2b922.firebaseapp.com",
      projectId: "sikom-2b922",
      storageBucket: "sikom-2b922.firebasestorage.app",
      messagingSenderId: "252762640424",
      appId: "1:252762640424:web:9485bbe58dc80f46a4651d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // עזרים
    function getTodayIso() {
      const now = new Date();
      return `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
    }
    function formatDateHeb(iso) { return iso.split('-').reverse().join('/'); }

    // פונקציית ספירה
    function getCounts(items) {
      const counts = { customers: 0, mask: 0, spray: 0, device: 0 };
      items.forEach(e => {
        if (e.label.includes('פן 50') || e.label.includes('פן 60') || e.label.includes('פן 70')) counts.customers++;
        else if (e.label.includes('מסכת')) counts.mask++;
        else if (e.label.includes('ספריי')) counts.spray++;
        else if (e.label.includes('מכשיר')) counts.device++;
      });
      return counts;
    }

    // הוספת רשומה
    function addEntry(amount, label) {
      const entry = {
        id: Date.now().toString() + '_' + Math.random().toString(16).slice(2),
        date: getTodayIso(),
        time: new Date().toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'}),
        amount: Number(amount),
        label: label
      };

      entries.push(entry);
      lastEntryId = entry.id;
      
      cashSound.play().catch(e => console.log("Sound blocked"));
      showUndo();
      saveToStorage();
      renderAll();

      db.collection("incomeEntries").doc(entry.id).set(entry);
    }

    function showUndo() {
      const btn = document.getElementById('undoBtn');
      btn.style.display = 'block';
      clearTimeout(undoTimeout);
      undoTimeout = setTimeout(() => btn.style.display = 'none', 5000);
    }

    function undoLast() {
      if (!lastEntryId) return;
      entries = entries.filter(e => e.id !== lastEntryId);
      db.collection("incomeEntries").doc(lastEntryId).delete();
      lastEntryId = null;
      document.getElementById('undoBtn').style.display = 'none';
      saveToStorage();
      renderAll();
    }

    function deleteEntry(id) {
      if (prompt("סיסמה למחיקה:") !== "4451") return alert("טעות");
      entries = entries.filter(e => e.id !== id);
      saveToStorage();
      renderAll();
      db.collection("incomeEntries").doc(id).delete();
    }

    function renderAll() {
      const todayIso = getTodayIso();
      document.getElementById('todayDate').textContent = 'היום: ' + formatDateHeb(todayIso);
      
      // היום
      const todayList = entries.filter(e => e.date === todayIso);
      const todaySum = todayList.reduce((s, e) => s + e.amount, 0);
      const c = getCounts(todayList);
      document.getElementById('todayList').innerHTML = todayList.map(e => `
        <div class="entry-row">
          <span>${e.label} (${e.amount} ₪) - ${e.time}</span>
          <button class="btn-delete" onclick="deleteEntry('${e.id}')">מחק</button>
        </div>
      `).join('') || 'אין נתונים';
      document.getElementById('todayTotal').innerHTML = `סה״כ: ${todaySum} ₪ <br><small>(לקוחות: ${c.customers}, מסכה: ${c.mask}, ספריי: ${c.spray})</small>`;

      // היסטוריה
      const groups = {};
      entries.forEach(e => { if(!groups[e.date]) groups[e.date] = []; groups[e.date].push(e); });
      let dates = Object.keys(groups);
      if(currentSortMode === 'date') dates.sort((a,b) => new Date(b) - new Date(a));
      else dates.sort((a,b) => getCounts(groups[b]).customers - getCounts(groups[a]).customers);
      
      document.getElementById('historyDays').innerHTML = dates.map(d => {
        const list = groups[d];
        const sum = list.reduce((s, e) => s + e.amount, 0);
        const gc = getCounts(list);
        return `<div class="month-row" style="border-bottom:1px solid #ddd; padding:8px 0;">
          <div style="display:flex; justify-content:space-between; font-weight:bold;"><span>${formatDateHeb(d)}</span><span>${sum} ₪</span></div>
          <div style="font-size:12px; color:#0a5;">לקוחות: ${gc.customers} | מסכה: ${gc.mask} | ספריי: ${gc.spray} | מכשיר: ${gc.device}</div>
        </div>`;
      }).join('');

      // חודשי
      const months = {};
      let gTotal = 0;
      entries.forEach(e => {
        const m = e.date.substring(0,7);
        if(!months[m]) months[m] = {sum:0, items:[]};
        months[m].sum += e.amount;
        months[m].items.push(e);
        gTotal += e.amount;
      });
      document.getElementById('historyMonths').innerHTML = Object.keys(months).sort().reverse().map(m => {
        const mc = getCounts(months[m].items);
        return `<div class="month-row">
          <div style="display:flex; justify-content:space-between; font-weight:bold;"><span>חודש ${m}</span><span>${months[m].sum} ₪</span></div>
          <div style="font-size:12px; color:#666;">לקוחות: ${mc.customers} | מסכה: ${mc.mask} | ספריי: ${mc.spray} | מכשירים: ${mc.device}</div>
        </div>`;
      }).join('');
      document.getElementById('grandTotal').textContent = 'סה״כ תקופה: ' + gTotal + ' ₪';
    }

    // אחסון
    function saveToStorage() { localStorage.setItem(STORAGE_KEY, JSON.stringify(entries)); }
    async function loadData() {
      try {
        const snap = await db.collection("incomeEntries").get();
        const serverData = [];
        snap.forEach(doc => serverData.push(doc.data()));
        if (serverData.length > 0) entries = serverData;
        else {
          const local = localStorage.getItem(STORAGE_KEY);
          if (local) entries = JSON.parse(local);
        }
      } catch (e) { console.error(e); }
      renderAll();
    }

    // אירועים
    document.querySelectorAll('.btn-amount').forEach(btn => {
      btn.addEventListener('click', () => addEntry(btn.dataset.amount, btn.dataset.label));
    });
    document.getElementById('undoBtn').onclick = undoLast;
    document.getElementById('toggleDetails').onclick = () => {
      const open = document.getElementById('detailsWrapper').classList.toggle('open');
      document.getElementById('toggleDetails').textContent = open ? 'הסתר פירוט' : 'צפייה בפירוט וסיכומים';
    };
    document.getElementById('sortByDate').onclick = () => { currentSortMode='date'; renderAll(); };
    document.getElementById('sortByCustomers').onclick = () => { currentSortMode='customers'; renderAll(); };

    loadData();
  </script>
</body>
</html>
