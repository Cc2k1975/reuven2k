<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>砖专 </title>

<script async src="https://docs.opencv.org/4.7.0/opencv.js" onload="onCvReady()"></script>

<style>
body{margin:0;padding:16px;font-family:system-ui;background:#f4f6f9}
.card{background:#fff;border-radius:14px;padding:16px;margin-bottom:14px;box-shadow:0 10px 25px rgba(0,0,0,.1)}
button{width:100%;padding:14px;border:0;border-radius:12px;background:#2563eb;color:#fff;font-size:18px}
button.secondary{background:#111}
video,canvas{width:100%;border-radius:12px;border:1px solid #ddd}
.hidden{display:none}
input{width:100%;padding:12px;font-size:16px;margin-bottom:10px}
#canvasWrap{
  overflow:auto;
  touch-action: pan-x pan-y pinch-zoom;
}
.note{color:#555;font-size:14px;margin-top:6px}
</style>
</head>

<body>

<div class="card">
<h2>爪 砖专</h2>
<video id="video" autoplay playsinline></video>
<button id="shoot" disabled> 爪</button>
</div>

<div class="card hidden" id="overlayCard">
<h2>住驻专 爪注转</h2>
<canvas id="overlay"></canvas>
</div>

<div class="card hidden" id="inputsCard">
<h2> 转 (住状)</h2>
<div id="inputs"></div>
<button id="build"> 砖专</button>
</div>

<div class="card hidden" id="resultCard">
<h2>砖专 住驻</h2>
<div id="canvasWrap">
  <canvas id="result"></canvas>
</div>
<div id="info" class="note"></div>
</div>

<script>
let cvReady=false, stream;
let polyPts=[], edgeDirs=[];
const video=document.getElementById("video");
const shoot=document.getElementById("shoot");

function onCvReady(){cvReady=true;shoot.disabled=false}

navigator.mediaDevices.getUserMedia({video:{facingMode:{exact:"environment"}}})
.then(s=>{stream=s;video.srcObject=s});

shoot.onclick=()=>{
  const c=document.createElement("canvas");
  c.width=video.videoWidth;
  c.height=video.videoHeight;
  c.getContext("2d").drawImage(video,0,0);
  detect(c);
};

function detect(photo){
  let src=cv.imread(photo),g=new cv.Mat(),e=new cv.Mat();
  cv.cvtColor(src,g,cv.COLOR_RGBA2GRAY);
  cv.Canny(g,e,60,180);
  let cs=new cv.MatVector(),h=new cv.Mat();
  cv.findContours(e,cs,h,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);
  let best=cs.get(0);
  let ap=new cv.Mat();
  cv.approxPolyDP(best,ap,0.02*cv.arcLength(best,true),true);

  let pts=[];
  for(let i=0;i<ap.rows;i++)
    pts.push({x:ap.intPtr(i,0)[0],y:ap.intPtr(i,0)[1]});

  let cx=pts.reduce((a,b)=>a+b.x,0)/pts.length;
  let cy=pts.reduce((a,b)=>a+b.y,0)/pts.length;
  polyPts=[...pts].sort((a,b)=>Math.atan2(a.y-cy,a.x-cx)-Math.atan2(b.y-cy,b.x-cx));

  edgeDirs=[];
  for(let i=0;i<polyPts.length;i++){
    let a=polyPts[i],b=polyPts[(i+1)%polyPts.length];
    edgeDirs.push(Math.abs(b.x-a.x)>Math.abs(b.y-a.y)?{dx:Math.sign(b.x-a.x),dy:0}:{dx:0,dy:Math.sign(b.y-a.y)});
  }

  const ov=document.getElementById("overlay");
  ov.width=photo.width;ov.height=photo.height;
  const o=ov.getContext("2d");
  o.drawImage(photo,0,0);
  o.strokeStyle="#2563eb";o.lineWidth=5;
  o.beginPath();
  o.moveTo(polyPts[0].x,polyPts[0].y);
  polyPts.forEach(p=>o.lineTo(p.x,p.y));
  o.closePath();o.stroke();
  o.fillStyle="#fff";o.font="bold 40px system-ui";
  for(let i=0;i<polyPts.length;i++){
    let p1=polyPts[i],p2=polyPts[(i+1)%polyPts.length];
    o.fillText(i+1,(p1.x+p2.x)/2,(p1.y+p2.y)/2);
  }

  document.getElementById("overlayCard").classList.remove("hidden");
  buildInputs();
}

function buildInputs(){
  const box=document.getElementById("inputs");
  box.innerHTML="";
  for(let i=0;i<polyPts.length;i++){
    const inp=document.createElement("input");
    inp.placeholder=`爪注 ${i+1} 住状`;
    inp.type="number";
    box.appendChild(inp);
  }
  document.getElementById("inputsCard").classList.remove("hidden");
}

document.getElementById("build").onclick=()=>{
  const vals=[...document.querySelectorAll("#inputs input")].map(i=>+i.value);
  let pts=[{x:0,y:0}],x=0,y=0;
  for(let i=0;i<vals.length;i++){
    x+=edgeDirs[i].dx*vals[i];
    y+=edgeDirs[i].dy*vals[i];
    pts.push({x,y});
  }

  const res=document.getElementById("result");
  res.width=900;res.height=600;
  const c=res.getContext("2d");
  c.clearRect(0,0,res.width,res.height);

  const xs=pts.map(p=>p.x),ys=pts.map(p=>p.y);
  const minX=Math.min(...xs),maxX=Math.max(...xs);
  const minY=Math.min(...ys),maxY=Math.max(...ys);
  const s=Math.min(700/(maxX-minX),400/(maxY-minY));

  c.strokeStyle="#2563eb";c.lineWidth=3;c.fillStyle="rgba(37,99,235,.08)";
  c.beginPath();
  c.moveTo(100+(pts[0].x-minX)*s,100+(pts[0].y-minY)*s);
  for(let i=1;i<pts.length;i++)
    c.lineTo(100+(pts[i].x-minX)*s,100+(pts[i].y-minY)*s);
  c.closePath();c.fill();c.stroke();

  c.fillStyle="#111";c.font="14px system-ui";
  for(let i=0;i<vals.length;i++){
    let p1=pts[i],p2=pts[i+1];
    let mx=(p1.x+p2.x)/2,my=(p1.y+p2.y)/2;
    c.fillText(vals[i]+" 住状",100+(mx-minX)*s,90+(my-minY)*s);
  }

  let area=0;
  for(let i=0;i<pts.length-1;i++)
    area+=pts[i].x*pts[i+1].y-pts[i+1].x*pts[i].y;
  area=Math.abs(area/2)/10000;

  document.getElementById("info").textContent=
    `砖: ${area.toFixed(2)} "专`;

  document.getElementById("resultCard").classList.remove("hidden");
};
</script>
</body>
</html>