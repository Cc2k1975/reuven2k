<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Barcode Label – Mobile</title>

  <!-- JsBarcode -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

  <style>
    *{box-sizing:border-box;margin:0;padding:0;}

    html,body{
      height:100%;
    }

    body{
      font-family:system-ui,"Heebo","Arial",sans-serif;
      background:#111827;
      color:#f9fafb;
      display:flex;
      justify-content:center;
      align-items:center;
    }

    .app{
      width:100%;
      max-width:420px;
      height:100%;
      max-height:720px;
      background:#1f2937;
      border-radius:18px;
      padding:16px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    h1{
      text-align:center;
      font-size:18px;
      margin-bottom:4px;
    }

    .field{
      margin-bottom:8px;
    }

    label{
      display:block;
      font-size:14px;
      margin-bottom:4px;
    }

    select,input{
      width:100%;
      padding:8px 10px;
      font-size:15px;
      border-radius:10px;
      border:1px solid #4b5563;
      background:#111827;
      color:#f9fafb;
    }

    select:focus,input:focus{
      outline:none;
      border-color:#60a5fa;
    }

    .buttons{
      display:flex;
      gap:8px;
      margin-top:8px;
    }

    button{
      flex:1;
      border:none;
      border-radius:999px;
      padding:10px;
      font-size:14px;
      font-weight:600;
      color:#fff;
      background:#2563eb;
      text-align:center;
      cursor:pointer;
    }

    #clearBtn{
      background:#4b5563;
    }

    #downloadBtn{
      background:#10b981;
    }

    .previewBox{
      flex:1;
      margin-top:8px;
      border-radius:12px;
      background:#020617;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:10px;
    }

    #previewSvg{
      width:90%;
      height:auto;
    }

    .hint{
      font-size:12px;
      color:#9ca3af;
      text-align:center;
      margin-top:4px;
    }

    /* הדפסה – רק המדבקה, 50×20 מ"מ */
    @page{
      size:50mm 20mm;
      margin:0;
    }
    @media print{
      body{
        margin:0;
        padding:0;
        background:#fff;
      }
      .app{display:none;}
      #printArea{
        display:block !important;
        width:50mm;
        height:20mm;
        padding:0;
      }
      #printBarcode{
        width:48mm;
        height:14mm;
      }
    }

    #printArea{
      display:none;
      text-align:center;
    }
  </style>
</head>
<body>

  <div class="app">
    <div>
      <h1>Barcode Label (Mobile)</h1>
    </div>

    <div class="field">
      <label for="siteSelect">Site (אות/קוד באנגלית)</label>
      <select id="siteSelect">
        <option value="">בחר אתר...</option>
        <option value="L">L</option>
        <option value="D">D</option>
        <option value="J">J</option>
        <option value="TER">TER</option>
        <option value="TLV">TLV</option>
        <option value="H">H</option>
      </select>
    </div>

    <div class="field">
      <label for="buildingInput">Building (מספר בלבד)</label>
      <input type="number" id="buildingInput" inputmode="numeric" placeholder="לדוגמה: 291">
    </div>

    <div class="field">
      <label for="roomInput">Room (מספר בלבד)</label>
      <input type="number" id="roomInput" inputmode="numeric" placeholder="לדוגמה: 6">
    </div>

    <div class="buttons">
      <button id="clearBtn" type="button">איפוס</button>
      <button id="printBtn" type="button">הדפס</button>
    </div>
    <div class="buttons">
      <button id="downloadBtn" type="button">הורד כתמונה</button>
    </div>

    <div class="previewBox">
      <svg id="previewSvg"></svg>
    </div>

    <div class="hint">
      להדפסה מהסמארטפון:<br>
      • הדפס מהחלון של אנדרואיד (אם אפשר)<br>
      • או "הורד כתמונה" → לפתוח באפליקציית Phomemo / Print Master ולהדפיס 50×20mm
    </div>
  </div>

  <!-- אזור שמודפס בפועל -->
  <div id="printArea">
    <svg id="printBarcode"></svg>
  </div>

  <script>
    const siteSelect    = document.getElementById('siteSelect');
    const buildingInput = document.getElementById('buildingInput');
    const roomInput     = document.getElementById('roomInput');
    const clearBtn      = document.getElementById('clearBtn');
    const printBtn      = document.getElementById('printBtn');
    const downloadBtn   = document.getElementById('downloadBtn');
    const previewSvg    = document.getElementById('previewSvg');
    const printBarcode  = document.getElementById('printBarcode');

    clearBtn.addEventListener('click', () => {
      siteSelect.value = "";
      buildingInput.value = "";
      roomInput.value = "";
      siteSelect.focus();
      previewSvg.innerHTML = "";
    });

    function getFields(){
      const site  = siteSelect.value.trim();
      const b     = buildingInput.value.trim();
      const r     = roomInput.value.trim();

      if(!site){ alert("בחר אתר"); return null; }
      if(!b){ alert("הכנס מספר מבנה"); return null; }
      if(!r){ alert("הכנס מספר חדר"); return null; }

      if(typeof JsBarcode === "undefined"){
        alert("JsBarcode לא נטען (צריך אינטרנט ל-CDN).");
        return null;
      }

      return {site, b, r};
    }

    // חישוב רוחב פס כך שהברקוד ייכנס ל-50×20 מ"מ
    function computeBarWidth(data){
      const maxWidthPx = 380;
      const len = data.length;
      const approxModules = len * 11 + 35;
      let w = maxWidthPx / approxModules;

      if(w > 3) w = 3;
      if(w < 0.6) w = 0.6;
      return w;
    }

    function renderBarcode(targetSvg, data, forPrint){
      const barWidth = computeBarWidth(data);
      JsBarcode(targetSvg, data, {
        format:"CODE128",
        width:barWidth,
        height: forPrint ? 50 : 60,
        displayValue:false,
        margin:2
      });
    }

    // הדפסה
    printBtn.addEventListener('click', () => {
      const fields = getFields();
      if(!fields) return;

      const data = `${fields.site} ${fields.b} ${fields.r}`;

      renderBarcode(previewSvg, data, false);
      renderBarcode(printBarcode, data, true);

      window.print();
    });

    // הורדה כתמונה – שם קובץ: Site-Room-Building.png (למשל L-6-291.png)
    // + שוליים לבנים (Quiet Zone) מסביב לברקוד כדי שלא ייחתך ולא תהיה בעיה בסריקה
    downloadBtn.addEventListener('click', () => {
      const fields = getFields();
      if(!fields) return;

      const data = `${fields.site} ${fields.b} ${fields.r}`;
      const fileBaseName = `${fields.site}-${fields.r}-${fields.b}`; // L-6-291

      // קודם מייצר ברקוד ב-SVG בתצוגה
      renderBarcode(previewSvg, data, false);

      const svgData = new XMLSerializer().serializeToString(previewSvg);
      const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
      const url = URL.createObjectURL(svgBlob);

      const img = new Image();
      img.onload = function(){
        // נבנה קנבס עם שוליים לבנים מסביב (Quiet Zone אמיתי)
        const margin = 20;          // שוליים לבנים מכל צד
        const innerW = 400;         // אזור הברקוד עצמו
        const innerH = 120;         // קצת פחות מהגובה הכולל
        const canvasW = innerW + margin * 2;
        const canvasH = innerH + margin * 2;

        const canvas = document.createElement('canvas');
        canvas.width  = canvasW;
        canvas.height = canvasH;

        const ctx = canvas.getContext('2d');

        // רקע לבן לכל המדבקה
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvasW, canvasH);

        // הברקוד מצויר באמצע עם שוליים לבנים מכל הצדדים
        ctx.drawImage(img, margin, margin, innerW, innerH);

        const pngUrl = canvas.toDataURL('image/png');

        const a = document.createElement('a');
        a.href = pngUrl;
        a.download = fileBaseName + '.png';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      img.src = url;
    });
  </script>
</body>
</html>
