<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>×“×™×™×¨ - ×–××™×¨ 15</title>
  <style>
    body { font-family: sans-serif; background: #000; color: #fff; margin: 0; overflow: hidden;
      display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
    video { position: fixed; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; background: #000; }
    .ui { z-index: 10; position: relative; text-align: center; background: rgba(0,0,0,0.7); padding: 20px; border-radius: 15px; }
    .controls { position: fixed; bottom: 40px; width: 100%; display: none; justify-content: space-around; z-index: 20; }
    .btn { width: 80px; height: 80px; border-radius: 50%; border: none; font-size: 2rem; cursor: pointer; color: white; }
    .hint { opacity: 0.8; font-size: 0.9rem; margin-top: 10px; }
  </style>
</head>
<body>
  <div id="setup" class="ui">
    <h2>×”×’×“×¨×ª ×“×™×¨×”</h2>
    <input type="number" id="apt" style="padding:10px; width:80px; text-align:center;">
    <button id="btnListen" style="padding:10px; background:#3498db; color:white; border:none; border-radius:10px; margin-right:8px;">×”×ª×—×œ</button>
    <div class="hint">×˜×™×¤: ×ª×¤×ª×— ××ª ×–×” ×‘-HTTPS (××• localhost), ××—×¨×ª WebRTC ×™×›×•×œ ×œ×”×™×—×¡×.</div>
  </div>

  <div id="incoming" class="ui" style="display:none;">
    <h1>ğŸ“ ×©×™×—×” ××”×©×¢×¨</h1>
    <button id="btnAccept" style="padding:20px 40px; background:#2ecc71; color:white; border:none; border-radius:50px; font-size:1.5rem;">×¢× ×” ×•×¦×¤×”</button>
    <div id="debug" class="hint"></div>
  </div>

  <video id="remoteVideo" autoplay playsinline muted></video>

  <div id="controls" class="controls">
    <button class="btn" style="background:#e74c3c;" onclick="location.reload()">âœ–</button>
    <button class="btn" style="background:#2ecc71;" onclick="openDoor()">âœ”</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, collection, query, where, onSnapshot,
      updateDoc, doc, addDoc, orderBy, limit
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyALAVQSl6FcuF0HYhCfIgVz-GUMSJKcT5c",
      authDomain: "zamir15-intercom.firebaseapp.com",
      projectId: "zamir15-intercom",
      storageBucket: "zamir15-intercom.firebasestorage.app",
      messagingSenderId: "823056442276",
      appId: "1:823056442276:web:a4235e2219152bb6789731"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // NOTE: ×× ××ª× ×××—×•×¨×™ NAT ×§×©×•×—/×¡×œ×•×œ×¨/×¨××•×˜×¨ ×‘×¢×™×™×ª×™ â€“ ×™×™×ª×›×Ÿ ×©×ª×¦×˜×¨×š TURN (×œ× ×›×œ ×—×™×‘×•×¨ ×™×¢×‘×•×“ ×¢× STUN ×‘×œ×‘×“)
    const pc = new RTCPeerConnection({
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    });

    let callId = null;
    let unsubCallDoc = null;
    let unsubOfferCandidates = null;

    const remoteVideo = document.getElementById("remoteVideo");
    const incomingUI = document.getElementById("incoming");
    const debugEl = document.getElementById("debug");

    function dbg(msg) {
      if (!debugEl) return;
      debugEl.textContent = msg;
    }

    pc.ontrack = (e) => {
      if (remoteVideo.srcObject !== e.streams[0]) {
        remoteVideo.srcObject = e.streams[0];
        remoteVideo.onloadedmetadata = async () => {
          try { await remoteVideo.play(); } catch (_) {}
          document.getElementById("controls").style.display = "flex";
        };
      }
    };

    pc.onconnectionstatechange = () => {
      dbg("××¦×‘ ×—×™×‘×•×¨: " + pc.connectionState);
    };
    pc.oniceconnectionstatechange = () => {
      // ××¤×©×¨ ×œ×¨××•×ª ×× × ×ª×§×¢ ×‘-checking/failed
      // dbg("ICE: " + pc.iceConnectionState);
    };

    // ×—×©×•×‘: × ×’×“×™×¨ onicecandidate ××•×§×“× â€“ ×œ×¤× ×™ setLocalDescription(answer)
    pc.onicecandidate = async (e) => {
      if (!e.candidate || !callId) return;
      const callDocRef = doc(db, "calls", callId);
      await addDoc(collection(callDocRef, "answerCandidates"), e.candidate.toJSON());
    };

    document.getElementById("btnListen").addEventListener("click", listen);
    document.getElementById("btnAccept").addEventListener("click", accept);

    function listen() {
      const aptNum = parseInt(document.getElementById("apt").value, 10);
      if (!aptNum) return alert("×ª×›× ×™×¡ ××¡×¤×¨ ×“×™×¨×” ×ª×§×™×Ÿ");
      document.getElementById("setup").style.display = "none";

      // ×ª×™×§×•×Ÿ: × ×‘×™× ××ª ×”×§×¨×™××” ×”××—×¨×•× ×” (orderBy + limit)
      const q = query(
        collection(db, "calls"),
        where("apartment", "==", aptNum),
        where("status", "==", "dialing"),
        orderBy("createdAt", "desc"),
        limit(1)
      );

      onSnapshot(q, (sn) => {
        sn.docChanges().forEach((c) => {
          if (c.type === "added" || c.type === "modified") {
            callId = c.doc.id;
            incomingUI.style.display = "block";
            dbg("×××ª×™×Ÿ ×œ××™×©×•×¨ ×©×œ×š...");
          }
        });
      });
    }

    async function accept() {
      if (!callId) return alert("×œ× × ××¦××” ×©×™×—×” ×¤×¢×™×œ×” ×œ×“×™×¨×” ×”×–××ª");

      incomingUI.style.display = "none";
      const callDocRef = doc(db, "calls", callId);

      // ×××–×™× ×™× ×œ××•×¢××“×™× ××”×©×¢×¨ (offerCandidates)
      unsubOfferCandidates = onSnapshot(collection(callDocRef, "offerCandidates"), (s) => {
        s.docChanges().forEach((c) => {
          if (c.type === "added") {
            pc.addIceCandidate(new RTCIceCandidate(c.doc.data())).catch(() => {});
          }
        });
      });

      // ×××–×™× ×™× ×œ××¡××š ×”×©×™×—×”: ××—×›×™× ×œ-offer ×•××– ×¢×•× ×™×
      unsubCallDoc = onSnapshot(callDocRef, async (s) => {
        const data = s.data();
        if (!data) return;

        if (data.offer && !pc.currentRemoteDescription) {
          try {
            await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);

            await updateDoc(callDocRef, {
              answer: { type: answer.type, sdp: answer.sdp },
              status: "connected"
            });
          } catch (err) {
            console.error(err);
            alert("×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª: " + (err?.message || err));
          }
        }

        if (data.status === "opened") {
          location.reload();
        }
      });
    }

    window.openDoor = async () => {
      if (callId) await updateDoc(doc(db, "calls", callId), { status: "opened" });
      location.reload();
    };
  </script>
</body>
</html>
12
