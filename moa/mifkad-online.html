<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>מפקד ציוד – אונליין</title>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#e0f2ff;
      --card:#ffffff;
      --border:#d0e2f5;
      --accent:#14b8a6;
      --accent-soft:#ccfbf1;
      --danger:#ef4444;
      --danger-soft:#fee2e2;
      --ink:#0f172a;
      --muted:#6b7280;
      --pill:#f1f5f9;
      --shadow:0 10px 25px rgba(15,23,42,.18);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Heebo,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--ink);
    }
    .wrap{
      max-width:900px;
      margin:0 auto;
      padding:16px 12px 80px;
    }
    h1{
      text-align:center;
      margin:8px 0 16px;
      font-size:1.8rem;
      font-weight:800;
      color:#0f172a;
    }
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px 14px 16px;
      margin-bottom:14px;
      border:1px solid rgba(148,163,184,.5);
    }
    .card-title{
      font-weight:700;
      margin-bottom:8px;
      font-size:.95rem;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .row{
      display:flex;
      gap:8px;
      margin-bottom:8px;
      flex-wrap:wrap;
    }
    input[type="text"]{
      width:100%;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:1rem;
      outline:none;
      transition:.15s border-color,.15s box-shadow;
      background:#f8fafc;
    }
    input[type="text"]:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(45,212,191,.35);
    }
    .btn{
      border:none;
      border-radius:999px;
      padding:9px 14px;
      font-size:.9rem;
      font-weight:600;
      cursor:pointer;
      white-space:nowrap;
    }
    .btn-main{
      background:var(--accent);
      color:#ecfeff;
    }
    .btn-ghost{
      background:var(--pill);
      color:var(--ink);
    }
    .btn-danger{
      background:var(--danger);
      color:#fef2f2;
    }
    .btn-sm{
      padding:5px 9px;
      font-size:.8rem;
    }

    .active-employee{
      margin-top:8px;
      padding:10px 14px;
      border-radius:var(--radius);
      background:var(--danger-soft);
      color:var(--danger);
      text-align:center;
      border:1px solid #fecaca;
    }
    .active-employee .label{
      font-size:.85rem;
      color:#b91c1c;
      margin-bottom:2px;
    }
    .active-employee .value{
      font-size:1.4rem;
      font-weight:800;
      letter-spacing:.06em;
    }

    .last-inv{
      margin-top:8px;
      padding:10px 14px;
      border-radius:var(--radius);
      background:var(--accent-soft);
      color:#047857;
      text-align:center;
      border:1px solid #99f6e4;
    }
    .last-inv .label{
      font-size:.85rem;
      color:#0f766e;
      margin-bottom:2px;
    }
    .last-inv .value{
      font-size:1.3rem;
      font-weight:800;
      letter-spacing:.04em;
      word-break:break-all;
    }

    .groups-title{
      font-weight:700;
      margin:6px 0 4px;
      font-size:1.05rem;
      color:#0f172a;
    }

    .group-card{
      border-radius:var(--radius);
      background:#f9fafb;
      border:1px solid var(--border);
      margin-bottom:10px;
      overflow:hidden;
    }
    .group-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:9px 10px;
      background:#e0f2fe;
      border-bottom:1px solid var(--border);
    }
    .group-id{
      font-weight:800;
      color:#047857;
      font-size:1rem;
    }
    .group-id small{
      font-weight:600;
      font-size:.85rem;
      color:#0f766e;
      margin-left:4px;
    }
    .group-meta{
      font-size:.8rem;
      color:var(--muted);
    }
    .group-actions{
      display:flex;
      gap:6px;
      margin-top:4px;
    }
    .group-body{
      padding:6px 8px 8px;
    }
    .item-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:6px 8px;
      border-radius:10px;
      background:#ffffff;
      border:1px solid #e5e7eb;
      margin-top:6px;
      gap:6px;
      flex-wrap:wrap;
    }
    .item-code{
      font-weight:700;
      font-size:.95rem;
      word-break:break-all;
    }
    .item-meta{
      font-size:.75rem;
      color:var(--muted);
    }

    .footer-bar{
      text-align:center;
      margin-top:12px;
      font-size:.8rem;
      color:#64748b;
    }

    .toast{
      position:fixed;
      bottom:16px;
      right:50%;
      transform:translateX(50%);
      background:#22c55e;
      color:#ecfdf5;
      padding:8px 14px;
      border-radius:999px;
      font-size:.85rem;
      box-shadow:0 10px 20px rgba(22,163,74,.35);
      opacity:0;
      pointer-events:none;
      transition:.2s opacity,.2s transform;
      z-index:9999;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .toast.show{
      opacity:1;
      transform:translateX(50%) translateY(-4px);
    }

    @media (min-width:700px){
      .wrap{padding:20px 8px 100px;}
      .card{padding:16px 18px 18px;}
      h1{font-size:2.1rem;margin-bottom:18px;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>מפקד ציוד</h1>

    <!-- סריקת עובד -->
    <div class="card">
      <div class="card-title">
        <span>סריקת תג עובד / הקלדת מספר זהות</span>
      </div>
      <div class="row">
        <input id="employeeInput" type="text" placeholder="סורק תג עובד או מקליד ת.ז." />
      </div>
      <div class="row">
        <button class="btn btn-main" id="btnSetEmployee">הוסף תג עובד</button>
        <button class="btn btn-ghost" id="btnClearAll">נקה נתונים</button>
      </div>
      <div id="activeEmployeeBox" class="active-employee" style="display:none;">
        <div class="label">מספר זהות העובד</div>
        <div class="value" id="activeEmployeeText"></div>
      </div>
    </div>

    <!-- סריקת אינוונטר -->
    <div class="card">
      <div class="card-title">
        <span>סריקת מספר אינוונטר / הקלדת מספר פריט</span>
      </div>
      <div class="row">
        <input id="inventoryInput" type="text" placeholder="סורק ברקוד או מקליד קוד פריט" />
      </div>
      <div class="row">
        <button class="btn btn-main" id="btnAddInventory">הוסף אינוונטר לעובד</button>
      </div>
      <small style="font-size:.8rem;color:var(--muted);">
        המערכת מתאימה לסורק USB – כל סריקה מאשרת אוטומטית לאחר לחיצה על &quot;הוסף אינוונטר&quot; או Enter.
      </small>
      <div id="lastInvBox" class="last-inv" style="display:none;">
        <div class="label">אינוונטר אחרון שנסרק</div>
        <div class="value" id="lastInvText"></div>
      </div>
    </div>

    <!-- קבוצות -->
    <div class="card">
      <div class="card-title">
        <span class="groups-title">אינוונטר לעובד</span>
        <button class="btn btn-main btn-sm" id="btnExport">ייצוא</button>
      </div>
      <div id="groupsContainer"></div>
    </div>

    <div class="footer-bar">
      נתונים נשמרים אונליין ב-Firebase – גרסה מותאמת סלולר ומחשב.
    </div>
  </div>

  <!-- טוסט -->
  <div id="toast" class="toast">
    <span id="toastText"></span>
  </div>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
    // ***** Firebase config שלך – בדיוק מהמסך *****
    const firebaseConfig = {
      apiKey: "AIzaSyBpiYodCIBxCReDSyTfoFiDJp-xksOzuzY",
      authDomain: "mifkad-online.firebaseapp.com",
      projectId: "mifkad-online",
      storageBucket: "mifkad-online.firebasestorage.app",
      messagingSenderId: "602973543807",
      appId: "1:602973543807:web:222e052e99afd7edd3b4e6",
      measurementId: "G-L5HRJR1PC5"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    // מסמך אחד שמכיל את כל המצב
    const stateDoc = db.collection("mifkad").doc("state");

    // ***** מודל הנתונים בצד לקוח *****
    let groups = {};             // { employeeId: { name: null, items:[{code, ts}] } }
    let currentEmployee = null;
    let lastInv = null;

    // ***** DOM *****
    const employeeInput   = document.getElementById("employeeInput");
    const inventoryInput  = document.getElementById("inventoryInput");
    const btnSetEmployee  = document.getElementById("btnSetEmployee");
    const btnClearAll     = document.getElementById("btnClearAll");
    const btnAddInventory = document.getElementById("btnAddInventory");
    const btnExport       = document.getElementById("btnExport");
    const activeBox       = document.getElementById("activeEmployeeBox");
    const activeText      = document.getElementById("activeEmployeeText");
    const lastInvBox      = document.getElementById("lastInvBox");
    const lastInvText     = document.getElementById("lastInvText");
    const groupsContainer = document.getElementById("groupsContainer");
    const toastEl         = document.getElementById("toast");
    const toastText       = document.getElementById("toastText");

    // ***** צלילים *****
    const beepOk = new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=");
    const beepErr = new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=");

    function showToast(msg, ok=true){
      toastText.textContent = msg;
      toastEl.style.background = ok ? "#22c55e" : "#ef4444";
      toastEl.classList.add("show");
      setTimeout(()=>toastEl.classList.remove("show"), 1000);
    }

    function render(){
      // עובד פעיל
      if(currentEmployee){
        activeText.textContent = currentEmployee;
        activeBox.style.display = "block";
      }else{
        activeBox.style.display = "none";
      }

      // אחרון שנסרק
      if(lastInv){
        lastInvText.textContent = lastInv;
        lastInvBox.style.display = "block";
      }else{
        lastInvBox.style.display = "none";
      }

      // קבוצות
      groupsContainer.innerHTML = "";
      Object.entries(groups).forEach(([empId, data])=>{
        const items = data.items || [];
        const card = document.createElement("div");
        card.className = "group-card";

        const head = document.createElement("div");
        head.className = "group-head";

        const left = document.createElement("div");
        const idEl = document.createElement("div");
        idEl.className = "group-id";
        idEl.textContent = empId;
        const small = document.createElement("small");
        small.textContent = "ת.ז";
        idEl.appendChild(document.createTextNode(" "));
        idEl.appendChild(small);
        left.appendChild(idEl);

        const meta = document.createElement("div");
        meta.className = "group-meta";
        meta.textContent = `פריטים: ${items.length}`;
        left.appendChild(meta);

        head.appendChild(left);

        const actions = document.createElement("div");
        actions.className = "group-actions";

        const btnSelect = document.createElement("button");
        btnSelect.className = "btn btn-ghost btn-sm";
        btnSelect.textContent = "בחר עובד";
        btnSelect.onclick = ()=>{ currentEmployee = empId; render(); };
        actions.appendChild(btnSelect);

        const btnDel = document.createElement("button");
        btnDel.className = "btn btn-danger btn-sm";
        btnDel.textContent = "הסר עובד";
        btnDel.onclick = ()=>{ delete groups[empId]; saveState(); };
        actions.appendChild(btnDel);

        head.appendChild(actions);
        card.appendChild(head);

        const body = document.createElement("div");
        body.className = "group-body";

        items.forEach((item, idx)=>{
          const row = document.createElement("div");
          row.className = "item-row";

          const leftPart = document.createElement("div");
          const codeEl = document.createElement("div");
          codeEl.className = "item-code";
          codeEl.textContent = item.code;
          leftPart.appendChild(codeEl);

          const metaEl = document.createElement("div");
          metaEl.className = "item-meta";
          metaEl.textContent = item.ts || "";
          leftPart.appendChild(metaEl);
          row.appendChild(leftPart);

          const buttons = document.createElement("div");
          const bEdit = document.createElement("button");
          bEdit.className = "btn btn-ghost btn-sm";
          bEdit.textContent = "ערוך פריט";
          bEdit.onclick = ()=>{
            const nv = prompt("עריכת קוד אינוונטר:", item.code);
            if(nv && nv.trim()){
              item.code = nv.trim();
              saveState();
            }
          };
          const bDel = document.createElement("button");
          bDel.className = "btn btn-danger btn-sm";
          bDel.textContent = "מחק פריט";
          bDel.onclick = ()=>{
            groups[empId].items.splice(idx,1);
            saveState();
          };
          buttons.appendChild(bEdit);
          buttons.appendChild(bDel);
          row.appendChild(buttons);

          body.appendChild(row);
        });

        card.appendChild(body);
        groupsContainer.appendChild(card);
      });
    }

    async function saveState(show=true){
      try{
        await stateDoc.set({
          groups,
          currentEmployee,
          lastInv
        });
        render();
        if(show){ beepOk.play(); showToast("נשמר בהצלחה לשרת", true); }
      }catch(err){
        console.error("save error", err);
        beepErr.play();
        showToast("שגיאה בשמירה לשרת", false);
      }
    }

    async function loadState(){
      try{
        const snap = await stateDoc.get();
        if(snap.exists){
          const data = snap.data();
          groups = data.groups || {};
          currentEmployee = data.currentEmployee || null;
          lastInv = data.lastInv || null;
        }else{
          groups = {};
          currentEmployee = null;
          lastInv = null;
        }
        render();
      }catch(err){
        console.error("load error", err);
        showToast("שגיאה בטעינת נתונים מהשרת", false);
      }
    }

    // ***** אירועים *****
    btnSetEmployee.addEventListener("click", ()=>{
      const id = employeeInput.value.trim();
      if(!id){ beepErr.play(); return; }
      if(!groups[id]) groups[id] = {items:[]};
      currentEmployee = id;
      employeeInput.value = "";
      saveState(false);
      beepOk.play();
      showToast("עובד פעיל עודכן", true);
    });

    employeeInput.addEventListener("keydown", e=>{
      if(e.key === "Enter"){
        e.preventDefault();
        btnSetEmployee.click();
      }
    });

    btnAddInventory.addEventListener("click", ()=>{
      const code = inventoryInput.value.trim();
      if(!code || !currentEmployee){
        beepErr.play();
        showToast(currentEmployee ? "אין קוד פריט" : "לא נבחר עובד פעיל", false);
        return;
      }
      const ts = new Date().toLocaleString("he-IL");
      if(!groups[currentEmployee]) groups[currentEmployee] = {items:[]};
      groups[currentEmployee].items.push({code, ts});
      lastInv = code;
      inventoryInput.value = "";
      saveState(true);
    });

    inventoryInput.addEventListener("keydown", e=>{
      if(e.key === "Enter"){
        e.preventDefault();
        btnAddInventory.click();
      }
    });

    btnClearAll.addEventListener("click", ()=>{
      if(!confirm("האם אתה בטוח שברצונך למחוק את כל הנתונים?")) return;
      if(!confirm("אישור סופי: למחוק את כל הנתונים מהשרת?")) return;
      groups = {};
      currentEmployee = null;
      lastInv = null;
      saveState(true);
    });

    btnExport.addEventListener("click", ()=>{
      const rows = [["מספר זהות","אינוונטר","תאריך ושעה"]];
      Object.entries(groups).forEach(([empId,data])=>{
        (data.items||[]).forEach(item=>{
          rows.push([empId, item.code, item.ts||""]);
        });
      });
      if(rows.length===1){
        showToast("אין נתונים לייצוא", false);
        return;
      }
      const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\r\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "mifkad-export.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // טעינה ראשונית מהשרת
    loadState();
  </script>
</body>
</html>
