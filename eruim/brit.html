<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <title>מחולל הזמנות - סופי בהחלט</title>

  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700;900&display=swap" rel="stylesheet">
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --main-gold:#896b1a;
      --text-dark:#3a3a3a;
    }

    html, body{
      margin:0; padding:0;
      width:100%; height:100%;
      overflow:hidden;
      background:#111;
      font-family:'Rubik', sans-serif;
      -webkit-text-size-adjust:100%;
    }

    .app{
      position:fixed;
      inset:0;
      display:grid;
      place-items:center;
      background:#111;
      padding-top: env(safe-area-inset-top);
      padding-right: env(safe-area-inset-right);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
    }

    .stage{
      width:100%;
      height:100%;
      display:grid;
      place-items:center;
      overflow:hidden;
      box-sizing:border-box;
      padding:8px;
      position:relative;
    }

    /* --- תצוגה (קומפוזיציה) --- */
    .preview-area{
      position:absolute;
      left:50%;
      top:50%;
      background:#fff;
      box-shadow: 0 0 40px rgba(0,0,0,0.55);
      overflow:hidden;
      transform-origin:center center;
      will-change: transform;
      user-select:none;
      touch-action: manipulation;
    }

    /* חשוב: תמיד למלא את הקומפוזיציה */
    #bgImage{
      display:block;
      width:100%;
      height:100%;
      object-fit: contain; /* לא חותך */
      pointer-events:none;
    }

    /* --- הקונטיינר של הטקסט (שמרתי את הערכים המקוריים שלך) --- */
    .text-container{
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      width:80%;
      text-align:center;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:start;

      /* *** הערכים הסופיים שלך *** */
      top:44%;
      filter: blur(0.6px);
    }

    .scaler-wrapper{
      width:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      transform-origin: top center;

      /* *** הערכים הסופיים שלך *** */
      transform: scale(0.8);
      gap:4px;
    }

    /* --- טיפוגרפיה --- */
    .header-quote{
      color:var(--main-gold);
      font-weight:700;
      font-size:24px;
      line-height:1.1;
      margin-bottom:10px;
    }
    .intro-text{
      color:var(--text-dark);
      font-size:16px;
      line-height:1.3;
    }
    .heb-date{
      color:var(--text-dark);
      font-size:16px;
      font-weight:500;
      margin-top:5px;
    }
    .greg-date{
      color:var(--main-gold);
      font-weight:900;
      font-size:32px;
      letter-spacing:1px;
      margin:5px 0;
      direction:ltr;
    }
    .location-text{
      color:var(--text-dark);
      font-size:16px;
      line-height:1.4;
      margin-bottom:15px;
    }
    .footer-text{
      color:var(--main-gold);
      font-weight:700;
      font-size:20px;
      line-height:1.2;
    }

    .hidden{ opacity:0; }
    .visible{ opacity:1; transition: opacity 0.3s; }

    /* ===== כפתור צף לפתיחה ===== */
    .btn-gear{
      position:fixed;
      z-index:2600;
      right: calc(env(safe-area-inset-right) + 12px);
      bottom: calc(env(safe-area-inset-bottom) + 12px);
      width:56px; height:56px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.22);
      background: rgba(30,30,30,0.92);
      color:#fff;
      font-size:22px;
      font-weight:900;
      display:grid;
      place-items:center;
      backdrop-filter: blur(10px);
      cursor:pointer;
    }

    /* ===== שכבת רקע כשהתפריט פתוח ===== */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.55);
      z-index:2400;
      opacity:0;
      pointer-events:none;
      transition: opacity 180ms ease;
    }
    .overlay.open{
      opacity:1;
      pointer-events:auto;
    }

    /* ===== תפריט כרטיס באמצע המסך ===== */
    .controls{
      position:fixed;
      z-index:2500;
      left:50%;
      top:50%;
      transform: translate(-50%, -50%) scale(0.98);
      width: min(420px, calc(100vw - 24px));
      max-height: min(72vh, 520px);
      overflow:auto;

      background: rgba(45,45,45,0.96);
      border:1px solid rgba(160,160,160,0.30);
      border-radius:18px;
      padding:14px 14px calc(14px + env(safe-area-inset-bottom));
      box-sizing:border-box;
      color:#fff;
      backdrop-filter: blur(12px);

      opacity:0;
      pointer-events:none;
      transition: opacity 180ms ease, transform 180ms ease;
      -webkit-overflow-scrolling: touch;
    }
    .controls.open{
      opacity:1;
      pointer-events:auto;
      transform: translate(-50%, -50%) scale(1);
    }

    .controls-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      align-items:start;
      justify-items:stretch;
    }

    .ctrl-item{ display:flex; flex-direction:column; gap:6px; }
    label{ font-size:0.95rem; color:#eee; margin:0; font-weight:900; }

    input[type="date"]{
      padding:12px 12px;
      border-radius:12px;
      border:none;
      font-family:'Rubik', sans-serif;
      font-size:1.05rem;
      outline:none;
      width:100%;
      box-sizing:border-box;
    }

    button{
      background:#4CAF50;
      color:#fff;
      border:none;
      padding:13px 16px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      height:48px;
      font-size:1.05rem;
      width:100%;
      transition: background 0.2s;
    }
    button:hover{ background:#45a049; }
    .btn-mode{ background:#2d6cdf; }
  </style>
</head>

<body>
  <div class="app">
    <div class="stage">
      <div class="preview-area" id="captureTarget">
        <img id="bgImage" src="blank_bg.jpg" onerror="alert('שגיאה: הקובץ blank_bg.jpg חסר בתיקייה!')" alt="רקע">

        <div class="text-container">
          <div class="scaler-wrapper">

            <div class="header-quote">
              "בסימן טוב בא לנו בימינו<br>יבוא הגואל"
            </div>

            <div class="intro-text">
              אנו שמחים להזמינכם לחגוג עימנו<br>
              את ברית המילה של בננו
            </div>

            <div style="display:flex; flex-direction:column; align-items:center;">
              <div class="heb-date hidden" id="hebDate">טוען...</div>
              <div class="greg-date hidden" id="gregDate">00.00.0000</div>
            </div>

            <div class="location-text">
              באולמי "יהלום", עין המפרץ<br>
              בשעה 12:30
            </div>

            <div class="footer-text">
              נשמח לראותכם,<br>
              דנה ורועי
            </div>

          </div>
        </div>

      </div>
    </div>

    <button class="btn-gear" id="gearBtn" type="button" aria-label="פתח/סגור שליטה">⚙️</button>
    <div class="overlay" id="overlay"></div>

    <div class="controls" id="controlsPanel" role="dialog" aria-modal="true" aria-label="עריכת פרטים">
      <div class="controls-grid">

        <button class="btn-mode" type="button" id="modeBtn">מצב: FIT</button>

        <div class="ctrl-item">
          <label>תאריך האירוע:</label>
          <input type="date" id="dateInput">
        </div>

        <div class="ctrl-item">
          <button type="button" onclick="saveImage()">שמור תמונה להדפסה</button>
        </div>

      </div>
    </div>
  </div>

  <script>
    // חסימת pinch-to-zoom + double-tap zoom
    document.addEventListener('gesturestart', e => e.preventDefault(), { passive:false });
    document.addEventListener('gesturechange', e => e.preventDefault(), { passive:false });
    document.addEventListener('gestureend', e => e.preventDefault(), { passive:false });

    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (e) {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) e.preventDefault();
      lastTouchEnd = now;
    }, { passive:false });

    // פתיחה/סגירה תפריט
    const controlsPanel = document.getElementById('controlsPanel');
    const overlay = document.getElementById('overlay');
    const gearBtn = document.getElementById('gearBtn');

    function openMenu(){ controlsPanel.classList.add('open'); overlay.classList.add('open'); }
    function closeMenu(){ controlsPanel.classList.remove('open'); overlay.classList.remove('open'); }

    gearBtn.addEventListener('click', () => {
      if (controlsPanel.classList.contains('open')) closeMenu();
      else openMenu();
    });
    overlay.addEventListener('click', closeMenu);

    // מצב תצוגה FIT / FILL
    let VIEW_MODE = 'FIT';
    const modeBtn = document.getElementById('modeBtn');
    modeBtn.addEventListener('click', () => {
      VIEW_MODE = (VIEW_MODE === 'FIT') ? 'FILL' : 'FIT';
      modeBtn.textContent = `מצב: ${VIEW_MODE}`;
      fitToScreen();
    });

    function fitToScreen(){
      const capture = document.getElementById('captureTarget');
      const img = document.getElementById('bgImage');
      const stage = document.querySelector('.stage');

      const nw = img.naturalWidth || 0;
      const nh = img.naturalHeight || 0;
      if (!nw || !nh) return;

      // קומפוזיציה בגודל המקורי
      capture.style.width  = nw + 'px';
      capture.style.height = nh + 'px';

      const vv = window.visualViewport;
      const rect = stage.getBoundingClientRect();
      let availW = rect.width;
      let availH = rect.height;
      if (vv) { availW = Math.min(availW, vv.width); availH = Math.min(availH, vv.height); }

      const pad = 8;
      availW = Math.max(50, availW - pad*2);
      availH = Math.max(50, availH - pad*2);

      const sContain = Math.min(availW / nw, availH / nh);
      const sCover   = Math.max(availW / nw, availH / nh);
      const scale = (VIEW_MODE === 'FILL') ? sCover : sContain;

      capture.style.transform = `translate(-50%, -50%) scale(${scale})`;
    }

    const els = {
      date: document.getElementById('dateInput'),
      heb: document.getElementById('hebDate'),
      greg: document.getElementById('gregDate')
    };

    function toGematria(num){
      const letters = ['', 'א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ז', 'ח', 'ט', 'י', 'יא', 'יב', 'יג', 'יד', 'טו', 'טז', 'יז', 'יח', 'יט', 'כ', 'כא', 'כב', 'כג', 'כד', 'כה', 'כו', 'כז', 'כח', 'כט', 'ל', 'לא'];
      let str = letters[num];
      if (!str) return "";
      if (str.length === 1) return str + "'";
      return str.slice(0,1) + '"' + str.slice(1);
    }

    els.date.addEventListener('change', function(){
      if (!this.value) return;
      const d = new Date(this.value);

      const parts = new Intl.DateTimeFormat('he-IL-u-ca-hebrew', { weekday:'long', month:'long', day:'numeric' }).formatToParts(d);
      let weekday='', month='', dayNum=0;
      parts.forEach(p => {
        if (p.type==='weekday') weekday=p.value;
        if (p.type==='month') month=p.value;
        if (p.type==='day') dayNum=parseInt(p.value,10);
      });
      if (!weekday.includes('יום')) weekday = "יום " + weekday;

      els.heb.innerText = `שתתקיים ב${weekday}, ${toGematria(dayNum)} ב${month}`;
      els.greg.innerText = `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`;

      els.heb.classList.remove('hidden'); els.heb.classList.add('visible');
      els.greg.classList.remove('hidden'); els.greg.classList.add('visible');
    });

    async function saveImage(){
      const original = document.getElementById('captureTarget');
      const img = document.getElementById('bgImage');

      const nw = img.naturalWidth || 0;
      const nh = img.naturalHeight || 0;
      if (!nw || !nh) { alert('הרקע עדיין לא נטען לגמרי. נסה שוב בעוד שנייה.'); return; }

      const filename = (els.greg.innerText && els.greg.innerText !== "00.00.0000") ? els.greg.innerText : "invitation";

      // Clone נסתר מחוץ למסך — כדי שהצילום תמיד יהיה מלא
      const clone = original.cloneNode(true);
      clone.style.position = 'fixed';
      clone.style.left = '-100000px';
      clone.style.top = '0';
      clone.style.transform = 'none';
      clone.style.width = nw + 'px';
      clone.style.height = nh + 'px';
      clone.style.boxShadow = 'none';
      clone.style.overflow = 'hidden';
      clone.style.background = '#fff';

      // להסיר id כדי לא להתנגש בדף
      clone.querySelectorAll('[id]').forEach(el => el.removeAttribute('id'));

      // לוודא תמונה בקלון ממלאת 100%×100%
      const cimg = clone.querySelector('img');
      if (cimg){
        cimg.style.width = '100%';
        cimg.style.height = '100%';
        cimg.style.objectFit = 'contain';
        cimg.style.display = 'block';
      }

      document.body.appendChild(clone);

      // להמתין לתמונה בקלון
      await new Promise(resolve => {
        if (!cimg) return resolve();
        if (cimg.complete && cimg.naturalWidth) return resolve();
        cimg.onload = () => resolve();
        cimg.onerror = () => resolve();
      });

      try{
        const canvas = await html2canvas(clone, { useCORS:true, scale:2, backgroundColor:null });
        const link = document.createElement('a');
        link.download = filename + ".jpg";
        link.href = canvas.toDataURL("image/jpeg", 0.92);
        link.click();
      } catch(err){
        alert("שגיאה בשמירה. אם אתה פותח כקובץ מקומי וזה נחסם, נסה דרך שרת / או אותו דפדפן אחר.");
      } finally {
        clone.remove();
      }
    }

    // init תצוגה
    const bg = document.getElementById('bgImage');
    function kickFit(){ requestAnimationFrame(fitToScreen); }

    bg.addEventListener('load', kickFit);
    document.addEventListener('DOMContentLoaded', kickFit);

    if (bg.complete && bg.naturalWidth){
      setTimeout(kickFit, 0);
      setTimeout(kickFit, 120);
    }

    window.addEventListener('resize', kickFit);
    window.addEventListener('orientationchange', () => { setTimeout(kickFit,150); setTimeout(kickFit,550); });

    if (window.visualViewport){
      window.visualViewport.addEventListener('resize', kickFit);
      window.visualViewport.addEventListener('scroll', kickFit);
    }
  </script>
</body>
</html>
