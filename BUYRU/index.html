<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>BUYRU – סריקה חיה (חלון קטן)</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f172a; --ink:#f8fafc; --muted:#9aa8c7;
    --card:#0b1224; --border:1px solid rgba(255,255,255,.08);
    --accent:#22c55e; --radius:16px; --shadow:0 16px 36px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:Heebo,system-ui,Arial;background:var(--bg);color:var(--ink)}
  .wrap{max-width:740px;margin:0 auto;padding:18px}
  header{display:flex;align-items:center;gap:10px;margin-bottom:12px}
  h1{margin:0;font-size:20px;font-weight:800}
  .panel{background:#0b1630;border:var(--border);border-radius:var(--radius);padding:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{padding:10px 14px;border:0;border-radius:12px;font-weight:800;cursor:pointer}
  .primary{background:linear-gradient(135deg,var(--accent),#38bdf8);color:#062;box-shadow:var(--shadow)}
  .ghost{background:transparent;border:var(--border);color:#dbeafe}
  select{padding:10px 12px;border-radius:12px;border:var(--border);background:#0b1630;color:#e5e7eb}
  .camDock{position:relative;width:340px;max-width:100%;aspect-ratio:16/10;border-radius:14px;overflow:hidden;border:var(--border);background:#000}
  .camDock video{width:100%;height:100%;object-fit:cover}
  .scanLine{position:absolute;left:8%;right:8%;top:50%;height:2px;background:rgba(255,255,255,.65);transform:translateY(-50%);box-shadow:0 0 12px rgba(255,255,255,.55)}
  .grid{display:grid;gap:14px;margin-top:14px}
  @media(min-width:760px){ .grid{grid-template-columns:1fr 1fr} }
  .shot{background:var(--card);border:var(--border);border-radius:16px;padding:14px}
  .shot img{width:100%;max-height:360px;object-fit:contain;border-radius:12px;background:#000}
  .code{margin-top:10px;font-size:22px;font-weight:900;text-align:center;letter-spacing:1px}
  .note{font-size:12px;color:var(--muted)}
  .hide{display:none!important}
  .foot{margin-top:12px;text-align:center;color:var(--muted);font-size:12px}
  .diag{font-size:11px;color:#9aa8c7;white-space:pre-wrap}
</style>
</head>
<body>
<div class="wrap">
  <header><h1>BUYRU – סריקה חיה (חלון קטן)</h1></header>

  <div class="panel">
    <button id="btnStart" class="btn primary">הפעל סריקה</button>
    <button id="btnStop" class="btn ghost" disabled>עצור</button>
    <select id="cameraSel" title="מצלמה"></select>
    <button id="btnTorch" class="btn ghost" disabled>פנס כבוי</button>
    <span id="httpsWarn" class="note hide">מצלמה דורשת <b>https://</b> (או localhost)</span>
  </div>

  <div class="grid">
    <div class="shot">
      <div class="camDock">
        <video id="preview" playsinline muted autoplay></video>
        <div class="scanLine"></div>
      </div>
      <div class="note">חלון מצלמה קטן. מקם את הברקוד על הקו הלבן.</div>
      <div id="diag" class="diag"></div>
    </div>

    <div class="shot" id="resultBox">
      <img id="productImg" alt="תמונת מוצר" class="hide">
      <div id="code" class="code"></div>
    </div>
  </div>

  <footer class="foot">v3.0.2 • חלון מצלמה קטן • מציג רק תמונה ומק״ט</footer>
</div>

<script src="https://unpkg.com/@zxing/browser@0.1.1"></script>
<script>
/* === אלמנטים === */
const btnStart  = document.getElementById('btnStart');
const btnStop   = document.getElementById('btnStop');
const btnTorch  = document.getElementById('btnTorch');
const cameraSel = document.getElementById('cameraSel');
const preview   = document.getElementById('preview');
const codeEl    = document.getElementById('code');
const imgProd   = document.getElementById('productImg');
const httpsWarn = document.getElementById('httpsWarn');
const diagEl    = document.getElementById('diag');

let stream = null, track = null, rafId = null, reader = null, lastCode = '';

/* === אבחון קצר למסך === */
function log(m){ diagEl.textContent += (diagEl.textContent?'\n':'') + m; }

/* === HTTPS התראה === */
(function(){
  const isLocal=/^(localhost|127\.0\.0\.1)$/.test(location.hostname);
  if(location.protocol!=='https:' && !isLocal){ httpsWarn.classList.remove('hide'); }
})();

/* === רשימת מצלמות === */
async function listVideoInputs(){
  const all = await navigator.mediaDevices.enumerateDevices();
  return all.filter(d => d.kind === 'videoinput');
}
function preferBack(devs){
  const backs = devs.filter(d => /back|rear|environment/i.test(d.label||''));
  return backs.length ? backs[backs.length-1] : devs[0];
}
async function fillCameras(){
  try{
    const isLocal=/^(localhost|127\.0\.0\.1)$/.test(location.hostname);
    if(location.protocol==='https:' || isLocal){ await navigator.mediaDevices.getUserMedia({video:true}); }
  }catch{}
  const devs = await listVideoInputs();
  cameraSel.innerHTML='';
  devs.forEach((d,i)=>{
    const opt=document.createElement('option');
    opt.value=d.deviceId; opt.textContent=(d.label||`camera ${i}`)+(/(back|rear|environment)/i.test(d.label||'')?' (אחורית)':'');
    cameraSel.appendChild(opt);
  });
  const pref=preferBack(devs); if(pref) cameraSel.value = pref.deviceId;
  log(`Video Inputs: ${devs.length}`);
}

/* === מציאת תמונת מוצר === */
function gtinToPath(code){ const c=(code||'').replace(/\D/g,''); const p=[]; for(let i=0;i<c.length;i+=3)p.push(c.slice(i,i+3)); return p.join('/'); }
function openFactsCandidates(code){
  const base=['https://images.openfoodfacts.org/images/products/','https://images.openbeautyfacts.org/images/products/','https://images.openproductsfacts.org/images/products/'];
  const path=gtinToPath(code);
  return [`${base[0]}${path}/front.400.jpg`,`${base[0]}${path}/front.jpg`,`${base[1]}${path}/front.400.jpg`,`${base[1]}${path}/front.jpg`,`${base[2]}${path}/front.400.jpg`,`${base[2]}${path}/front.jpg`];
}
function ramiLevyCandidates(code){
  const base=`https://img.rami-levy.co.il/product/${code}`;
  return [`${base}/small.jpg`,`${base}/large.jpg`,`https://www.rami-levy.co.il/_ipx/w_500,f_webp/${base}/small.jpg`,`https://www.rami-levy.co.il/_ipx/w_800,f_webp/${base}/large.jpg`];
}
function raceImage(url){
  return new Promise((resolve,reject)=>{ const im=new Image(); im.onload=()=>resolve(url); im.onerror=()=>reject(url); im.src=url+`?t=${Date.now()}`; });
}
async function findImageFast(code){
  const cands=[...openFactsCandidates(code), ...ramiLevyCandidates(code)];
  if (Promise.any){ try{ return await Promise.any(cands.map(raceImage)); }catch{ return null; } }
  for(let i=0;i<cands.length;i+=3){ try{ return await Promise.race(cands.slice(i,i+3).map(raceImage)); }catch{} }
  return null;
}

/* === עצירה בטוחה === */
async function stopScan(){
  if(rafId){ cancelAnimationFrame(rafId); rafId=null; }
  if(reader){ reader.reset(); reader=null; }
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  track=null;
  btnStart.disabled=false; btnStop.disabled=true; btnTorch.disabled=true;
}

/* === פתיחת סטרים עם רצף נסיונות === */
async function openStreamWithFallbacks(deviceId){
  const tries = [
    {audio:false, video:{ deviceId: deviceId? {exact:deviceId}: undefined, width:{ideal:1280}, height:{ideal:720}, focusMode:{ideal:'continuous'} }},
    {audio:false, video:{ facingMode:{ideal:'environment'}, width:{ideal:1280}, height:{ideal:720}, focusMode:{ideal:'continuous'} }},
    {audio:false, video:{ facingMode:'environment' }},
    {audio:false, video:true}
  ];
  let lastErr = null;
  for (const c of tries){
    try{ return await navigator.mediaDevices.getUserMedia(c); }
    catch(e){ lastErr = e; log(`getUserMedia fail: ${e.name||''} ${e.message||e}`); }
  }
  throw lastErr || new Error('No camera available');
}

/* === START === */
async function startScan(){
  await stopScan();
  codeEl.textContent=''; imgProd.classList.add('hide'); imgProd.removeAttribute('src');

  // אם יש BarcodeDetector – אנחנו מנהלים את הסטרים בעצמנו; אחרת ניתן ל-ZXing לנהל.
  if ('BarcodeDetector' in window){
    try{
      const deviceId = cameraSel.value || undefined;
      stream = await openStreamWithFallbacks(deviceId);
      preview.srcObject = stream;
      preview.muted = true;
      preview.playsInline = true;
      await preview.play().catch(()=>{});

      track = stream.getVideoTracks()[0] || null;
      btnStart.disabled=true; btnStop.disabled=false;

      try{
        const caps=track?.getCapabilities?.();
        if(caps?.torch){ btnTorch.disabled=false; btnTorch.textContent='פנס כבוי'; }
      }catch{ btnTorch.disabled=true; }

      await liveDetectWithDetector();
    }catch(e){
      alert('כשל מצלמה: ' + (e.name? e.name+' – ':'') + (e.message||e));
      await stopScan();
    }
  } else {
    // ZXing פותח סטרים בעצמו (לא פותחים stream קודם!)
    try{
      btnStart.disabled=true; btnStop.disabled=false;
      await liveDetectWithZXing(cameraSel.value || undefined);
    }catch(e){
      alert('כשל ZXing: ' + (e.name? e.name+' – ':'') + (e.message||e));
      await stopScan();
    }
  }
}

/* === פנס === */
btnTorch.addEventListener('click', async ()=>{
  if(!track) return;
  try{
    const caps=track.getCapabilities?.(); if(!caps?.torch) return;
    const cur = track.getSettings?.().torch === true;
    await track.applyConstraints({ advanced:[{ torch: !cur }] });
    btnTorch.textContent = !cur ? 'פנס דלוק' : 'פנס כבוי';
  }catch{}
});

/* === סריקה חיה עם BarcodeDetector === */
async function liveDetectWithDetector(){
  const det = new window.BarcodeDetector({ formats:['ean_13','ean_8','upc_a','upc_e'] });

  const loop = async ()=>{
    try{
      const bmp = await bandBitmap(preview, 0.22);
      const res = await det.detect(bmp);
      if(res && res.length){
        const code = (res[0].rawValue||'').trim();
        if(code && code!==lastCode){ await onCodeDetected(code); return; }
      }
    }catch(e){ /* ממשיכים לנסות */ }
    rafId = requestAnimationFrame(loop);
  };
  rafId = requestAnimationFrame(loop);
}
async function bandBitmap(video, bandRatio=0.22){
  const w = video.videoWidth || 1280, h = video.videoHeight || 720;
  const bandH = Math.max(40, Math.round(h * bandRatio));
  const y = Math.round((h - bandH)/2);
  const cnv = document.createElement('canvas'); cnv.width = w; cnv.height = bandH;
  cnv.getContext('2d', { willReadFrequently:true }).drawImage(video, 0, y, w, bandH, 0, 0, w, bandH);
  return await createImageBitmap(cnv);
}

/* === סריקה חיה עם ZXing (ללא פתיחת סטרים מוקדמת) === */
async function liveDetectWithZXing(deviceId){
  reader = new ZXing.BrowserMultiFormatReader();
  await reader.decodeFromConstraints(
    { audio:false, video: deviceId ? {deviceId:{exact:deviceId}} : {facingMode:{ideal:'environment'}} },
    preview,
    (result, err) => {
      if(result){
        const code=(result.text||'').trim();
        if(code) onCodeDetected(code);
      }
    }
  );
}

/* === בעת זיהוי מק״ט === */
async function onCodeDetected(code){
  lastCode = code;
  codeEl.textContent = code;

  // עוצרים סריקה ומכבים מצלמה כדי לפנות משאבים
  await stopScan();

  // טוענים תמונת מוצר – הראשון שמצליח יוצג
  const url = await findImageFast(code);
  if(url){ imgProd.src = url; imgProd.classList.remove('hide'); }
}

/* === אירועים ואתחול === */
btnStart.addEventListener('click', startScan);
btnStop .addEventListener('click', stopScan);
cameraSel.addEventListener('change', async ()=>{
  if(!btnStop.disabled){ await startScan(); }
});
fillCameras();
</script>
</body>
</html>
