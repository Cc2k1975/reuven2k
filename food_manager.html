<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Food Manager – ניהול תפריט משפחתי</title>
<style>
:root{
  --bg-page:#fffaf0;
  --panel-bg:#ffffff;
  --border:#e2d7b8;
  --text-main:#333;
  --text-dim:#666;
  --green:#3c7a4c;
  --green-dark:#2e5f3b;
  --gold:#c59d2f;
  --err-bg:#a01919;
  --ok-bg:#2e7d32;
  --radius:16px;
  --shadow:0 8px 24px rgba(0,0,0,0.12);
  --shadow-inner:0 0 10px rgba(0,0,0,0.08) inset;
  --btn-bg:#3c7a4c;
  --btn-text:#fff;

  --block-orders-bg:#eef9f1;   /* ירקרק בהיר */
  --block-orders-border:#b8dfc2;
  --block-orders-head:#2e7d32;

  --block-codes-bg:#fff8e6;    /* זהבי בהיר */
  --block-codes-border:#e9d39a;
  --block-codes-head:#b58900;

  --block-menu-bg:#fff0ef;     /* סלמון עדין */
  --block-menu-border:#e3b3ad;
  --block-menu-head:#a34a3a;
}

body{
  margin:0;
  background:var(--bg-page);
  font-family:"Heebo",Arial,sans-serif;
  color:var(--text-main);
  display:flex;
  justify-content:center;
  padding:16px;
  text-align:center;
}
.wrap{
  width:100%;
  max-width:1100px;
  background:var(--panel-bg);
  border-radius:var(--radius);
  border:2px solid var(--border);
  box-shadow:var(--shadow);
  padding:20px 16px 32px;
  text-align:initial;
}
h1{
  margin:0;
  font-size:26px;
  font-weight:700;
  color:var(--green);
  text-align:center;
  line-height:1.3;
}

/* פס סטטוס */
#statusBox{
  display:none;
  border-radius:var(--radius);
  padding:10px 14px;
  margin-top:12px;
  font-size:16px;
  font-weight:600;
  color:#fff;
  line-height:1.4;
  text-align:center;
}
#statusBox.ok{background:var(--ok-bg);}
#statusBox.err{background:var(--err-bg);}

/* כפתורי שליטה עליונים */
.controlsBar{
  margin-top:16px;
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:flex-start;
  justify-content:space-between;
  text-align:right;
}

.leftControls,
.rightControls{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
}

button.actionBtn{
  background:var(--btn-bg);
  color:var(--btn-text);
  border:0;
  border-radius:var(--radius);
  font-size:16px;
  font-weight:700;
  padding:10px 14px;
  box-shadow:var(--shadow);
  cursor:pointer;
}
button.actionBtn:active{background:var(--green-dark);}

#formToggle.online{
  background:var(--green);
  color:#fff;
}
#formToggle.offline{
  background:#a01919;
  color:#fff;
}

.searchWrap{
  display:flex;
  flex-wrap:nowrap;
  align-items:center;
  gap:8px;
}
.searchWrap input{
  background:#fff;
  border:2px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow-inner);
  padding:10px 12px;
  font-size:16px;
  color:var(--text-main);
  min-width:200px;
  font-family:inherit;
}

/* אקורדיון בלוקים */
.blockCard{
  border-radius:var(--radius);
  border-width:2px;
  border-style:solid;
  margin-top:20px;
  overflow:hidden;
  box-shadow:var(--shadow-inner);
}

/* כותרת בלוק של האקורדיון */
.blockHeaderBtn{
  width:100%;
  text-align:right;
  border:0;
  padding:16px;
  background:transparent;
  display:flex;
  flex-wrap:nowrap;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
  cursor:pointer;
}
.blockHeaderBtn h2{
  margin:0;
  font-size:20px;
  font-weight:700;
  line-height:1.4;
}
.blockHeaderBtn .arrow{
  font-size:20px;
  line-height:1;
  font-weight:700;
  min-width:24px;
  text-align:left;
  transition:transform .4s ease-in-out;
}

/* גוף הבלוק - האזור שנפתח/נסגר */
.blockBodyOuter{
  background:#fff;
  padding:0 16px 16px;
  max-height:0;
  overflow:hidden;
  transition:max-height .4s ease-in-out;
  border-top:2px solid transparent;
}
.blockBodyInner{
  padding-top:16px;
}

/* בלוק בחירות */
.blockOrders{
  background:var(--block-orders-bg);
  border-color:var(--block-orders-border);
}
.blockOrders .blockHeaderBtn h2{
  color:var(--block-orders-head);
}
.blockOrders .blockBodyOuter{
  background:var(--block-orders-bg);
  border-top-color:var(--block-orders-border);
}

/* בלוק קודים */
.blockCodes{
  background:var(--block-codes-bg);
  border-color:var(--block-codes-border);
}
.blockCodes .blockHeaderBtn h2{
  color:var(--block-codes-head);
}
.blockCodes .blockBodyOuter{
  background:var(--block-codes-bg);
  border-top-color:var(--block-codes-border);
}

/* בלוק תפריט */
.blockMenu{
  background:var(--block-menu-bg);
  border-color:var(--block-menu-border);
}
.blockMenu .blockHeaderBtn h2{
  color:var(--block-menu-head);
}
.blockMenu .blockBodyOuter{
  background:var(--block-menu-bg);
  border-top-color:var(--block-menu-border);
}

/* מצב פתוח */
.blockCard.open .blockBodyOuter{
  max-height:2000px; /* גובה גדול מספיק */
}
.blockCard.open .blockHeaderBtn .arrow{
  transform:rotate(90deg); /* מ▶ ל▼ (ביחד עם התו שנשים) */
}

/* טבלאות/טפסים פנימיים */
.tableWrap{
  background:#fff;
  border:2px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow-inner);
  margin-top:16px;
  overflow-x:auto;
}
table{
  border-collapse:collapse;
  width:100%;
  min-width:900px;
  font-size:14px;
  color:var(--text-main);
  border-radius:var(--radius);
}
thead{
  background:var(--bg-page);
  color:var(--green);
  font-weight:700;
}
th,td{
  text-align:center;
  padding:10px 6px;
  border-bottom:1px solid var(--border);
  white-space:nowrap;
  font-family:inherit;
}
tbody tr:nth-child(even){
  background:#faf8f0;
}
tbody tr:nth-child(odd){
  background:#ffffff;
}

td.actionsCell button,
.smallTable td button,
.whatsappBtn{
  background:#c59d2f;
  color:#000;
  border:0;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  font-size:13px;
  font-weight:700;
  padding:6px 10px;
  cursor:pointer;
}
td.actionsCell button:active,
.smallTable td button:active,
.whatsappBtn:active{
  filter:brightness(0.9);
}

/* טבלת הקודים */
.codeMapTableWrap{
  overflow-x:auto;
}
.smallTable{
  width:100%;
  min-width:480px;
  border-collapse:collapse;
  font-size:14px;
}
.smallTable th{
  background:var(--bg-page);
  color:var(--green);
  font-weight:700;
  text-align:center;
  border-bottom:1px solid var(--border);
  padding:8px;
}
.smallTable td{
  text-align:center;
  border-bottom:1px solid var(--border);
  padding:8px;
}

/* ניהול תפריט */
.menuCatWrap{
  margin-top:16px;
  border:2px solid var(--border);
  border-radius:var(--radius);
  padding:12px;
  background:#fff;
  box-shadow:var(--shadow-inner);
}
.menuCatHeader{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  flex-wrap:wrap;
  gap:8px;
}
.menuCatHeader h3{
  margin:0;
  font-size:16px;
  font-weight:700;
  color:var(--green-dark);
}
.menuList{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  margin-top:12px;
}
.menuItemTag{
  display:flex;
  align-items:center;
  gap:6px;
  background:#faf8f0;
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:6px 10px;
  font-size:14px;
  line-height:1.4;
}
.menuItemTag button{
  background:#a01919;
  color:#fff;
  border:0;
  border-radius:var(--radius);
  padding:4px 8px;
  font-size:12px;
  line-height:1.2;
  cursor:pointer;
}
.addRow{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:12px;
}
.addRow input{
  flex:1;
  min-width:160px;
  background:#fff;
  border:2px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow-inner);
  padding:8px 10px;
  font-size:14px;
  font-family:inherit;
}
.addRow button{
  background:var(--green);
  color:#fff;
  border:0;
  border-radius:var(--radius);
  padding:10px 14px;
  font-size:14px;
  font-weight:700;
  cursor:pointer;
  box-shadow:var(--shadow);
}
.addRow button:active{
  background:var(--green-dark);
}

/* פוטר */
.footerInfo{
  text-align:center;
  font-size:13px;
  color:var(--text-dim);
  margin-top:24px;
}
</style>
</head>
<body>
<div class="wrap">
  <h1>ניהול תפריט – Food Manager</h1>

  <div id="statusBox"></div>

  <div class="controlsBar">
    <div class="leftControls">
      <button id="formToggle" class="actionBtn online">ONLINE</button>
      <button id="refreshBtn" class="actionBtn">רענן</button>
      <button id="csvBtn" class="actionBtn">ייצוא CSV</button>
    </div>

    <div class="rightControls">
      <div class="searchWrap">
        <input id="searchInput" type="text" placeholder="חפש… קוד / משפחה / מנה / שתייה / קינוח">
      </div>
    </div>
  </div>

  <!-- בלוק 1: בחירות שנשלחו (עכשיו סגור כברירת מחדל, אין class 'open') -->
  <div class="blockCard blockOrders" data-block="orders">
    <button class="blockHeaderBtn" type="button">
      <h2>בחירות שנשלחו</h2>
      <div class="arrow">▶</div>
    </button>
    <div class="blockBodyOuter">
      <div class="blockBodyInner">

        <div class="tableWrap">
          <table id="answersTable">
            <thead>
              <tr>
                <th>קוד</th>
                <th>משפחה</th>
                <th>מנה</th>
                <th>פחמימה</th>
                <th>סלט 1</th>
                <th>סלט 2</th>
                <th>שתייה</th>
                <th>קינוח</th>
                <th>תאריך/שעה</th>
                <th>פעולות</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <tr><td colspan="10" style="text-align:center;color:#777;">טוען…</td></tr>
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

  <!-- בלוק 2: קודים -->
  <div class="blockCard blockCodes" data-block="codes">
    <button class="blockHeaderBtn" type="button">
      <h2>ניהול קודים (קישור → שם משפחה)</h2>
      <div class="arrow">▶</div>
    </button>
    <div class="blockBodyOuter">
      <div class="blockBodyInner">

        <div class="codeMapTableWrap">
          <table class="smallTable">
            <thead>
              <tr>
                <th>קוד</th>
                <th>שם משפחה להצגה</th>
                <th>ווצאפ</th>
                <th>מחק</th>
              </tr>
            </thead>
            <tbody id="codeMapBody">
            </tbody>
          </table>
        </div>

        <div class="addRow" style="margin-top:16px;">
          <input id="newCodeInput" type="text" placeholder="קוד (לדוגמה: 3)">
          <input id="newFamilyInput" type="text" placeholder="שם להצגה (לדוגמה: משפחת מלול)">
          <button id="addCodeBtn">הוסף / עדכן קוד</button>
        </div>
        <div class="addRow">
          <button id="saveMapBtn" style="background:#c59d2f;color:#000;">שמור מיפוי קודים</button>
        </div>

      </div>
    </div>
  </div>

  <!-- בלוק 3: תפריט -->
  <div class="blockCard blockMenu" data-block="menu">
    <button class="blockHeaderBtn" type="button">
      <h2>ניהול תפריט (מנות לבחירה)</h2>
      <div class="arrow">▶</div>
    </button>
    <div class="blockBodyOuter">
      <div class="blockBodyInner">

        <div id="menuSections">
          <!-- מתמלא דינמית -->
        </div>

        <div class="addRow">
          <button id="saveMenuBtn" style="background:#c59d2f;color:#000;">שמור תפריט</button>
        </div>

      </div>
    </div>
  </div>

  <div class="footerInfo">גרסה 2.4 · food_manager.html</div>
</div>

<script>
// ===== הגדרות BIN =====
const BIN_ID     = "68ff447a43b1c97be9844c29";
const MASTER_KEY = "$2a$10$4rynniEMuvwqg2nDb5KSEe/lAVYp8a7L3xWzp9GsO6n49OfXc3FCO";
const API        = "https://api.jsonbin.io/v3/b";

// DOM
const statusBox      = document.getElementById("statusBox");
const tableBody      = document.getElementById("tableBody");
const searchInput    = document.getElementById("searchInput");
const refreshBtn     = document.getElementById("refreshBtn");
const csvBtn         = document.getElementById("csvBtn");
const toggleBtn      = document.getElementById("formToggle");

const codeMapBody    = document.getElementById("codeMapBody");
const newCodeInput   = document.getElementById("newCodeInput");
const newFamilyInput = document.getElementById("newFamilyInput");
const addCodeBtn     = document.getElementById("addCodeBtn");
const saveMapBtn     = document.getElementById("saveMapBtn");

const menuSections   = document.getElementById("menuSections");
const saveMenuBtn    = document.getElementById("saveMenuBtn");

let formOpen        = true;
let allChoices      = [];
let filteredChoices = [];
let codeMap         = {};
let menuOptions     = {};

// ===== אקורדיון =====
function setupAccordion(){
  document.querySelectorAll(".blockCard").forEach(block=>{
    const headerBtn = block.querySelector(".blockHeaderBtn");
    const bodyOuter = block.querySelector(".blockBodyOuter");
    const arrowEl   = block.querySelector(".arrow");

    // התחל סגור (אין class open כבר ב-HTML)
    bodyOuter.style.maxHeight = "0px";
    arrowEl.textContent = "▶";

    headerBtn.addEventListener("click", ()=>{
      const isOpen = block.classList.contains("open");
      if(isOpen){
        // סגור
        block.classList.remove("open");
        bodyOuter.style.maxHeight = "0px";
        arrowEl.textContent = "▶";
      }else{
        // פתח
        block.classList.add("open");
        bodyOuter.style.maxHeight = bodyOuter.scrollHeight + "px";
        arrowEl.textContent = "▼";
      }
    });

    // שמור פונקציה לעדכון גובה אחרי רינדור דינמי
    block._recalcHeight = ()=>{
      if(block.classList.contains("open")){
        bodyOuter.style.maxHeight = bodyOuter.scrollHeight + "px";
      }
    };
  });
}

function recalcAccordionHeights(){
  document.querySelectorAll(".blockCard").forEach(block=>{
    if(block._recalcHeight){
      block._recalcHeight();
    }
  });
}

// ===== עוזרי UI =====
function showStatus(msg, ok){
  statusBox.style.display="block";
  statusBox.className = ok ? "ok" : "err";
  statusBox.textContent=msg;
}

function prettyTS(s){
  const d=new Date(s);
  if(isNaN(d)) return "";
  const dd  = String(d.getDate()).padStart(2,"0");
  const mm  = String(d.getMonth()+1).padStart(2,"0");
  const yy  = d.getFullYear();
  const hh  = String(d.getHours()).padStart(2,"0");
  const min = String(d.getMinutes()).padStart(2,"0");
  return `${dd}.${mm}.${yy} ${hh}:${min}`;
}

// ===== משיכה מהשרת =====
async function fetchAll(){
  try {
    const res = await fetch(`${API}/${BIN_ID}/latest`, {
      headers: { "X-Master-Key": MASTER_KEY }
    });
    const j = await res.json();

    formOpen    = j.record?.formOpen !== false;
    allChoices  = Array.isArray(j.record?.בחירות) ? j.record.בחירות : [];
    codeMap     = j.record?.map || {};
    menuOptions = j.record?.menuOptions || {};

    filteredChoices = [...allChoices];

    renderChoicesTable();
    renderToggleButton();
    renderCodeMapTable();
    renderMenuOptionsEditor();

    showStatus(`נטענו ${allChoices.length} בחירות`, true);

    recalcAccordionHeights();
  } catch(err){
    console.error(err);
    showStatus("שגיאה בטעינה", false);
  }
}

// ===== טבלת הבחירות =====
function renderChoicesTable(){
  if(!filteredChoices.length){
    tableBody.innerHTML =
      '<tr><td colspan="10" style="text-align:center;color:#777;">אין נתונים</td></tr>';
  } else {
    tableBody.innerHTML = filteredChoices.map((rec,i)=>`
      <tr>
        <td>${rec.code||""}</td>
        <td>${rec["שם"]||""}</td>
        <td>${rec["מנה"]||""}</td>
        <td>${rec["פחמימה"]||""}</td>
        <td>${rec["סלט1"]||""}</td>
        <td>${rec["סלט2"]||""}</td>
        <td>${rec["שתייה"]||""}</td>
        <td>${rec["קינוח"]||""}</td>
        <td>${prettyTS(rec.ts)}</td>
        <td class="actionsCell"><button data-i="${i}">מחק</button></td>
      </tr>
    `).join("");
  }
}

// מחיקת בחירה אחת
tableBody.addEventListener("click", async (e)=>{
  if(e.target.tagName==="BUTTON"){
    const idx = e.target.dataset.i;
    allChoices.splice(idx,1);
    await saveAllToServer();
    await fetchAll();
  }
});

// ===== חיפוש =====
function applySearch(){
  const q = searchInput.value.trim().toLowerCase();
  if(!q){
    filteredChoices=[...allChoices];
  } else {
    filteredChoices = allChoices.filter(rec=>{
      return JSON.stringify(rec).toLowerCase().includes(q);
    });
  }
  renderChoicesTable();
  recalcAccordionHeights();
}

// ===== CSV =====
function exportCSV(){
  if(!filteredChoices.length) return;
  const BOM="\uFEFF";

  const rows=[["קוד","משפחה","מנה","פחמימה","סלט1","סלט2","שתייה","קינוח","תאריך"]];
  filteredChoices.forEach(rec=>{
    rows.push([
      rec.code||"",
      rec["שם"]||"",
      rec["מנה"]||"",
      rec["פחמימה"]||"",
      rec["סלט1"]||"",
      rec["סלט2"]||"",
      rec["שתייה"]||"",
      rec["קינוח"]||"",
      prettyTS(rec.ts)
    ]);
  });

  const blob=new Blob(
    [BOM+rows.map(r=>r.join(",")).join("\n")],
    {type:"text/csv;charset=utf-8;"}
  );
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="food_manager.csv";
  a.click();
  URL.revokeObjectURL(url);
}

// ===== ONLINE / OFFLINE =====
function renderToggleButton(){
  toggleBtn.className = formOpen ? "actionBtn online" : "actionBtn offline";
  toggleBtn.textContent = formOpen ? "ONLINE" : "OFFLINE";
}

async function toggleForm(){
  formOpen = !formOpen;
  renderToggleButton();
  showStatus("שומר מצב טופס...", true);
  await saveAllToServer();
  showStatus(`הטופס עכשיו ${formOpen ? "פתוח" : "סגור"}`, true);
}

// ===== טבלת הקודים =====
function renderCodeMapTable(){
  const keys = Object.keys(codeMap).sort((a,b)=> {
    const na = Number(a), nb=Number(b);
    if(!isNaN(na) && !isNaN(nb)) return na-nb;
    return a.localeCompare(b,"he");
  });

  if(!keys.length){
    codeMapBody.innerHTML =
      '<tr><td colspan="4" style="text-align:center;color:#777;">אין קודים מוגדרים</td></tr>';
  } else {
    codeMapBody.innerHTML = keys.map(code=>{
      const famName = codeMap[code];
      const msg =
`שלום ${famName}
מצורף קישור לבחירת תפריט שבועי
נא למלא את הנתונים בהקדם:
${window.location.origin}/food.html?code=${encodeURIComponent(code)}`;
      const waUrl = "https://wa.me/?text="+encodeURIComponent(msg);

      return `
        <tr>
          <td>${code}</td>
          <td>${famName}</td>
          <td>
            <button class="whatsappBtn"
                    data-wa="${waUrl}">
              ווצאפ
            </button>
          </td>
          <td>
            <button class="delCodeBtn"
                    data-code="${code}">
              מחק
            </button>
          </td>
        </tr>
      `;
    }).join("");
  }

  recalcAccordionHeights();
}

// הוספה/עדכון קוד
addCodeBtn.addEventListener("click", ()=>{
  const c = newCodeInput.value.trim();
  const f = newFamilyInput.value.trim();
  if(!c || !f){
    showStatus("חסר קוד או שם משפחה", false);
    return;
  }
  codeMap[c]=f;
  newCodeInput.value="";
  newFamilyInput.value="";
  renderCodeMapTable();
  showStatus("הקוד הוסף/עודכן ברשימה. עדיין לא נשמר בשרת.", true);
});

// ווצאפ / מחיקה
codeMapBody.addEventListener("click",(e)=>{
  if(e.target.classList.contains("whatsappBtn")){
    const wa = e.target.getAttribute("data-wa");
    if(wa){
      window.open(wa, "_blank");
    }
    return;
  }
  if(e.target.classList.contains("delCodeBtn")){
    const c = e.target.getAttribute("data-code");
    if(c && codeMap[c]!==undefined){
      delete codeMap[c];
      renderCodeMapTable();
      showStatus("הקוד הוסר מהרשימה. עדיין לא נשמר בשרת.", true);
    }
    return;
  }
});

// שמירת map לשרת
saveMapBtn.addEventListener("click", async ()=>{
  showStatus("שומר מיפוי קודים...", true);
  await saveAllToServer();
  showStatus("המיפוי נשמר בהצלחה ✅", true);
});

// ===== ניהול תפריט =====
function categoryLabel(key){
  switch(key){
    case "meat": return "מנה בשרית";
    case "carb": return "פחמימה";
    case "salad1": return "סלט 1";
    case "salad2": return "סלט 2";
    case "drink": return "שתייה";
    case "dessert": return "קינוח";
    default: return key;
  }
}

function renderMenuOptionsEditor(){
  menuSections.innerHTML = "";
  const categories = ["meat","carb","salad1","salad2","drink","dessert"];

  categories.forEach(cat=>{
    if(!Array.isArray(menuOptions[cat])) menuOptions[cat]=[];

    const div = document.createElement("div");
    div.className="menuCatWrap";
    div.setAttribute("data-cat",cat);

    const header = document.createElement("div");
    header.className="menuCatHeader";
    header.innerHTML = `
      <h3>${categoryLabel(cat)}</h3>
      <small style="color:#666;font-size:13px;">
        פריטים קיימים (אפשר למחוק), ואז להוסיף חדש למטה
      </small>
    `;
    div.appendChild(header);

    const listDiv=document.createElement("div");
    listDiv.className="menuList";
    menuOptions[cat].forEach((item,idx)=>{
      const tag=document.createElement("div");
      tag.className="menuItemTag";
      tag.innerHTML=`
        <span>${item}</span>
        <button data-cat="${cat}" data-idx="${idx}">X</button>
      `;
      listDiv.appendChild(tag);
    });
    div.appendChild(listDiv);

    const addRow=document.createElement("div");
    addRow.className="addRow";
    addRow.innerHTML=`
      <input type="text" class="newItemInput" placeholder="הוסף מנה חדשה ל-${categoryLabel(cat)}">
      <button data-cat="${cat}" class="addItemBtn">הוסף</button>
    `;
    div.appendChild(addRow);

    menuSections.appendChild(div);
  });

  recalcAccordionHeights();
}

// מחיקת פריט מרשימה מקומית
menuSections.addEventListener("click",(e)=>{
  if(e.target.tagName==="BUTTON"
     && e.target.dataset
     && e.target.dataset.idx!==undefined
     && e.target.dataset.cat){
    const cat = e.target.dataset.cat;
    const idx = Number(e.target.dataset.idx);
    if(Array.isArray(menuOptions[cat]) && menuOptions[cat][idx]!==undefined){
      menuOptions[cat].splice(idx,1);
      renderMenuOptionsEditor();
      showStatus("נמחק מהרשימה המקומית. עדיין לא נשמר בשרת.", true);
    }
  }
});

// הוספת פריט חדש
menuSections.addEventListener("click",(e)=>{
  if(e.target.classList.contains("addItemBtn")){
    const cat = e.target.getAttribute("data-cat");
    const wrap = e.target.closest(".menuCatWrap");
    const input = wrap.querySelector(".newItemInput");
    const val   = input.value.trim();
    if(!val){
      showStatus("לא הוכנס פריט חדש", false);
      return;
    }
    if(!menuOptions[cat]) menuOptions[cat]=[];
    if(!menuOptions[cat].includes(val)){
      menuOptions[cat].push(val);
    }
    input.value="";
    renderMenuOptionsEditor();
    showStatus("הפריט התווסף לרשימה המקומית. עדיין לא נשמר בשרת.", true);
  }
});

// שמירת תפריט לשרת
saveMenuBtn.addEventListener("click", async ()=>{
  showStatus("שומר תפריט (menuOptions)...", true);
  await saveAllToServer();
  showStatus("התפריט נשמר בהצלחה ✅", true);
});

// ===== שמירה כוללת לשרת =====
async function saveAllToServer(){
  const body = {
    "formOpen": formOpen,
    "map": codeMap,
    "menuOptions": menuOptions,
    "בחירות": allChoices
  };

  try{
    const putRes = await fetch(`${API}/${BIN_ID}`,{
      method:"PUT",
      headers:{
        "Content-Type":"application/json",
        "X-Master-Key": MASTER_KEY
      },
      body:JSON.stringify(body)
    });
    if(!putRes.ok){
      showStatus("שמירה נכשלה בשרת", false);
    }
  }catch(err){
    console.error(err);
    showStatus("שמירה נכשלה בשרת", false);
  }
}

// ===== מאזינים =====
refreshBtn.onclick = async ()=>{
  await fetchAll();
};
toggleBtn.onclick  = toggleForm;
csvBtn.onclick     = exportCSV;
searchInput.oninput= applySearch;

saveMapBtn.onclick = async ()=>{
  showStatus("שומר מיפוי קודים...", true);
  await saveAllToServer();
  showStatus("המיפוי נשמר בהצלחה ✅", true);
};
saveMenuBtn.onclick = async ()=>{
  showStatus("שומר תפריט...", true);
  await saveAllToServer();
  showStatus("התפריט נשמר בהצלחה ✅", true);
};

// ===== הפעלה =====
setupAccordion();
fetchAll();
</script>
</body>
</html>
