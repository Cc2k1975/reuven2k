<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>BUYRU â€“ ×¦×™×œ×•× ×‘×¨×§×•×“ (××”×™×¨)</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f172a; --ink:#f8fafc; --muted:#9aa8c7;
    --card:#0b1224; --border:1px solid rgba(255,255,255,.08);
    --accent:#22c55e; --radius:18px; --shadow:0 18px 40px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:Heebo,system-ui,Arial;background:var(--bg);color:var(--ink)}
  .wrap{max-width:720px;margin:0 auto;padding:20px}
  header{display:flex;align-items:center;gap:10px;margin-bottom:16px}
  h1{margin:0;font-size:20px;font-weight:800}
  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:8px;
    font-weight:800;border:0;border-radius:16px;cursor:pointer;
    padding:14px 18px;background:linear-gradient(135deg,var(--accent),#38bdf8);color:#062;
    box-shadow:var(--shadow); width:100%;
  }
  .panel{background:#0b1630;border:var(--border);border-radius:var(--radius);padding:14px}
  .note{font-size:12px;color:var(--muted);text-align:center;margin-top:8px}
  .shot{margin-top:16px;background:var(--card);border:var(--border);border-radius:var(--radius);padding:16px}
  .shot img{width:100%;max-height:360px;object-fit:contain;border-radius:12px;background:#000}
  .code{margin-top:12px;font-size:22px;font-weight:900;text-align:center;letter-spacing:1px}
  .skeleton{width:100%;height:260px;border-radius:12px;background:linear-gradient(90deg, #0d1428 25%, #111a33 37%, #0d1428 63%); background-size:400% 100%; animation:sh 1.2s infinite}
  @keyframes sh{0%{background-position:100% 50%}100%{background-position:0 50%}}
  .hide{display:none!important}
  .foot{margin-top:14px;text-align:center;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <header><h1>BUYRU â€“ ×¦×™×œ×•× ×‘×¨×§×•×“ (××”×™×¨)</h1></header>

  <div class="panel">
    <input id="capture" type="file" accept="image/*" capture="environment" class="hide">
    <button id="btnShot" class="btn">ğŸ“· ×¦×œ× ×•×¡×¨×•×§</button>
    <div class="note">××¦×™×’ ×¨×§: ×ª××•× ×ª ××•×¦×¨ + ××§×´×˜. ××•×¤×˜×™××™×–×¦×™×•×ª ××”×™×¨×•×ª ×œ×–×™×”×•×™.</div>
  </div>

  <div id="box" class="shot hide">
    <div id="skeleton" class="skeleton hide"></div>
    <img id="productImg" alt="×ª××•× ×ª ××•×¦×¨" class="hide">
    <div id="code" class="code"></div>
  </div>

  <footer class="foot">v2.7.0 â€¢ ××™× ×™××œ×™×¡×˜×™ ×•××”×™×¨</footer>
</div>

<script src="https://unpkg.com/@zxing/browser@0.1.1"></script>
<script>
const capture   = document.getElementById('capture');
const btnShot   = document.getElementById('btnShot');
const box       = document.getElementById('box');
const imgProd   = document.getElementById('productImg');
const codeEl    = document.getElementById('code');
const skeleton  = document.getElementById('skeleton');

let lastCode = '';

/* ---------- ××•×¢××“×™× ×œ×ª××•× ×ª ××•×¦×¨ ---------- */
function gtinToPath(code){ const c=(code||'').replace(/\D/g,''); const p=[]; for(let i=0;i<c.length;i+=3)p.push(c.slice(i,i+3)); return p.join('/'); }
function openFactsCandidates(code){
  const base=['https://images.openfoodfacts.org/images/products/','https://images.openbeautyfacts.org/images/products/','https://images.openproductsfacts.org/images/products/'];
  const path=gtinToPath(code);
  // × × ×¡×” ×§×•×“× ×’×¨×¡××•×ª ×§×˜× ×•×ª (× ×˜×¢× ×•×ª ××”×¨ ×™×•×ª×¨)
  return [`${base[0]}${path}/front.400.jpg`, `${base[0]}${path}/front.jpg`,
          `${base[1]}${path}/front.400.jpg`, `${base[1]}${path}/front.jpg`,
          `${base[2]}${path}/front.400.jpg`, `${base[2]}${path}/front.jpg`];
}
function ramiLevyCandidates(code){
  const base=`https://img.rami-levy.co.il/product/${code}`;
  // ×’× ×›××Ÿ ×§×•×“× small
  return [`${base}/small.jpg`, `${base}/large.jpg`,
          `https://www.rami-levy.co.il/_ipx/w_500,f_webp/${base}/small.jpg`,
          `https://www.rami-levy.co.il/_ipx/w_800,f_webp/${base}/large.jpg`];
}

/* ---------- ×˜×¢×™× ×” ×ª×—×¨×•×ª×™×ª: ×”×¨××©×•×Ÿ ×©××¦×œ×™×— ×× ×¦×— ---------- */
function raceImage(url){
  return new Promise((resolve, reject)=>{
    const im = new Image();
    const done = (ok)=>{ im.onload=null; im.onerror=null; ok? resolve(url): reject(url); };
    im.onload = ()=> done(true);
    im.onerror= ()=> done(false);
    im.src = url + `?t=${Date.now()}`;
  });
}
async function findImageFast(code){
  const candidates = [...openFactsCandidates(code), ...ramiLevyCandidates(code)];
  // Promise.any ×™×¨×•×¥ ×¢×œ ×›×•×œ× ×‘××§×‘×™×œ ×•×™×—×–×™×¨ ××ª ×”×¨××©×•×Ÿ ×©×˜×¢×Ÿ
  if (Promise.any) {
    try { return await Promise.any(candidates.map(raceImage)); }
    catch { return null; }
  } else {
    // ×¤×•×œ×™×¤×™×œ ×¤×©×•×˜: × × ×¡×” ×‘×§×‘×•×¦×•×ª ×§×˜× ×•×ª ×‘××§×‘×™×œ
    const chunk = 3;
    for(let i=0;i<candidates.length;i+=chunk){
      const group = candidates.slice(i,i+chunk).map(raceImage);
      try { return await Promise.race(group); } catch{}
    }
    return null;
  }
}

/* ---------- ×”××¨×” ××”×™×¨×” ×œÖ¾ImageBitmap (×¢× Resize) ---------- */
async function toBitmapFast(file){
  // createImageBitmap ×¢× resizeWidth ××”×™×¨ ××©××¢×•×ª×™×ª
  if ('createImageBitmap' in window) {
    try {
      // ×¨×•×—×‘ ×™×¢×“ 1024 â€“ ××¡×¤×™×§ ×œ×‘×¨×§×•×“ ×•××§×˜×™×Ÿ ×××•×“ ××ª ×”×—×™×©×•×‘
      return await createImageBitmap(file, { resizeWidth: 1024, resizeQuality: 'high' });
    } catch {}
  }
  // ×¤×•×œ×‘×§: ×˜×¢×Ÿ ×œ××œ×× ×˜ ×ª××•× ×” ×•××– ×œ×¦×™×™×¨ ×œ×§× ×‘×¡ ××•×§×˜×Ÿ
  const url = URL.createObjectURL(file);
  const img = new Image(); img.src = url; await img.decode();
  const scale = Math.min(1, 1024 / img.naturalWidth);
  const cnv = document.createElement('canvas');
  cnv.width = Math.round(img.naturalWidth * scale);
  cnv.height= Math.round(img.naturalHeight * scale);
  cnv.getContext('2d').drawImage(img, 0, 0, cnv.width, cnv.height);
  URL.revokeObjectURL(url);
  return await createImageBitmap(cnv);
}

/* ---------- ×–×™×”×•×™ ××”×™×¨: BarcodeDetector ×¢× ×¡×˜ ×¤×•×¨××˜×™× ××¦×•××¦× ---------- */
async function detectFast(bitmap){
  // ×§×•×“× × × ×¡×” BarcodeDetector ×¨×§ ×¢× ×”×¤×•×¨××˜×™× ×”×¨×œ×•×•× ×˜×™×™× ×œ×¡×•×¤×¨×™×
  if ('BarcodeDetector' in window) {
    try{
      const det = new window.BarcodeDetector({ formats: ['ean_13','ean_8','upc_a','upc_e'] });
      // ×§×¨×•×¤ ××¨×›×–×™ ×¦×¨ (××¤×—×™×ª ×¤×™×§×¡×œ×™× â†’ ××”×™×¨ ×™×•×ª×¨), ×•×× ×œ× ×¢×•×‘×“ â€“ ×¢×œ ×›×œ ×”×¤×¨×™×™×
      const codeCenter = await detectOnCrop(det, bitmap, 0.2); // ×¨×¦×•×¢×” ××¨×›×–×™×ª 20% ××”×’×•×‘×”
      if (codeCenter) return codeCenter;
      const codeFull = await detectOnBitmap(det, bitmap);
      if (codeFull) return codeFull;
    }catch{}
  }
  // ZXing ××”×™×¨: ×¢×œ ×ª××•× ×” ××•×§×˜× ×ª ××¨××© (×›×‘×¨ 1024px)
  try{
    const cnv=document.createElement('canvas');
    cnv.width=bitmap.width; cnv.height=bitmap.height;
    cnv.getContext('2d').drawImage(bitmap,0,0);
    const im=new Image(); im.src=cnv.toDataURL('image/png'); await im.decode();
    const reader = new ZXing.BrowserMultiFormatReader();
    const res = await reader.decodeFromImageElement(im).catch(()=>null);
    if(res?.text) return res.text.trim();
  }catch{}
  return '';
}

async function detectOnBitmap(det, bitmap){
  try{
    const res = await det.detect(bitmap);
    if (res && res.length) return (res[0].rawValue||'').trim();
  }catch{}
  return '';
}

async function detectOnCrop(det, bitmap, bandRatio=0.2){
  try{
    const h = bitmap.height, w = bitmap.width;
    const bandH = Math.max(40, Math.round(h * bandRatio));
    const y = Math.round((h - bandH)/2);
    const cnv = document.createElement('canvas');
    cnv.width = w; cnv.height = bandH;
    const ctx = cnv.getContext('2d');
    ctx.drawImage(bitmap, 0, y, w, bandH, 0, 0, w, bandH);
    // ××¤×©×¨×•×ª: ×œ×”×‘×”×™×¨/×œ×”×¢×œ×•×ª ×§×•× ×˜×¨×¡×˜ â€” ×œ×¨×•×‘ ×œ× × ×“×¨×©
    const bandBitmap = await createImageBitmap(cnv);
    const res = await det.detect(bandBitmap);
    if (res && res.length) return (res[0].rawValue||'').trim();
  }catch{}
  return '';
}

/* ---------- ×–×¨×™××” ×¨××©×™×ª: ×¦×™×œ×•× â†’ ×–×™×”×•×™ (××™×™×“ ××¦×™×’ ××§×´×˜) â†’ ×˜×¢×™× ×ª ×ª××•× ×” ×‘××§×‘×™×œ ---------- */
async function handleFile(file){
  if(!file) return;

  box.classList.remove('hide');
  imgProd.classList.add('hide');
  skeleton.classList.remove('hide');
  codeEl.textContent = '';

  // 1) ×”××¨×” ××”×™×¨×” ×œ×‘×™×˜××¤ ××•×§×˜×Ÿ
  const bmp = await toBitmapFast(file);

  // 2) ×–×™×”×•×™ ××§×´×˜ (××™×™×“ ×©××™× ×¢×œ ×”××¡×š ×›×©× ××¦×)
  const code = await detectFast(bmp);
  if (code) {
    lastCode = code;
    codeEl.textContent = code;
  } else {
    // ××™×Ÿ ××§×´×˜ â†’ ××¤×¡×™×§×™× ×›××Ÿ
    skeleton.classList.add('hide');
    return;
  }

  // 3) ×‘××§×‘×™×œ ×˜×•×¢× ×™× ×ª××•× ×” â€“ ××™ ×©××’×™×¢ ×¨××©×•×Ÿ ××•×¦×’
  const imgUrl = await findImageFast(code);

  skeleton.classList.add('hide');
  if (imgUrl){
    imgProd.src = imgUrl;
    imgProd.classList.remove('hide');
  } else {
    imgProd.removeAttribute('src');
    imgProd.classList.add('hide');
  }
}

btnShot.addEventListener('click', ()=>{
  capture.setAttribute('capture','environment');
  capture.click();
});
capture.addEventListener('change', e=>{
  const f = e.target.files?.[0];
  handleFile(f);
  e.target.value='';
});
</script>
</body>
</html>
