<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>住专拽 Pro - 驻转专 砖转 Mat</title>
    <script src="https://docs.opencv.org/4.7.0/opencv.js" async></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root { --primary: #007aff; --success: #2ecc71; --bg: #000; }
        * { box-sizing: border-box; }
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: var(--bg); color: white; font-family: system-ui, sans-serif; }
        .app-container { display: flex; flex-direction: column; height: 100dvh; }
        
        #debug { background: #1a1a1a; color: #0f0; font-size: 11px; padding: 5px; text-align: center; border-bottom: 1px solid #333; }

        .viewer { flex: 1; position: relative; background: #000; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: contain; }
        /* 拽住 住转专 注 */
        #hiddenCanvas, #outputCanvas { display: none; }

        .thumbnails-strip { height: 100px; background: #111; display: flex; gap: 10px; padding: 10px; overflow-x: auto; border-top: 1px solid #333; }
        .thumb { width: 60px; height: 80px; background: #333; border-radius: 6px; object-fit: cover; border: 2px solid #555; }

        .controls { background: #111; padding: 20px; border-top: 1px solid #222; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .main-row { display: flex; align-items: center; justify-content: space-around; width: 100%; }

        .snap-btn { width: 75px; height: 75px; background: white; border-radius: 50%; border: 6px solid #444; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .snap-btn:active { transform: scale(0.9); background: #ddd; }
        .snap-inner { width: 55px; height: 55px; border-radius: 50%; border: 2px solid black; }

        .btn { padding: 15px 25px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; color: white; display: flex; align-items: center; gap: 8px; }
        .btn-pdf { background: var(--success); width: 90%; justify-content: center; font-size: 16px; }
        .btn-reset { background: #333; font-size: 12px; }
        .counter { background: #222; padding: 8px 15px; border-radius: 20px; font-size: 13px; border: 1px solid #444; }

        #loader { position: fixed; inset: 0; background: #000; z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 3px solid #222; border-top: 3px solid white; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <p style="margin-top: 15px;">注 转 住专拽...</p>
</div>

<div class="app-container">
    <div id="debug">Log: 转...</div>

    <div class="viewer">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="hiddenCanvas"></canvas>
        <canvas id="outputCanvas"></canvas>
    </div>

    <div class="thumbnails-strip" id="thumbnails"></div>

    <div class="controls">
        <div class="main-row">
            <button class="btn btn-reset" onclick="resetAll()">驻住</button>
            
            <div class="snap-btn" onclick="captureAndProcess()">
                <div class="snap-inner"></div>
            </div>

            <div class="counter">住: <span id="pageCount">0</span></div>
        </div>

        <div id="finalActions" style="display: none; width: 100%; justify-content: center;">
            <button class="btn btn-pdf" onclick="sendPDF()"> 砖 PDF 住驻</button>
        </div>
    </div>
</div>

<script>
    const log = (m) => document.getElementById('debug').innerText = "Log: " + m;
    const video = document.getElementById('video');
    const hiddenCanvas = document.getElementById('hiddenCanvas');
    const outputCanvas = document.getElementById('outputCanvas');
    const thumbnailsDiv = document.getElementById('thumbnails');
    
    let scannedPages = [];
    let cvReady = false;

    // 1. 注转 OpenCV 爪专 
    window.onload = () => {
        let checkCV = setInterval(() => {
            if (typeof cv !== 'undefined' && cv.Mat) {
                clearInterval(checkCV);
                cvReady = true;
                document.getElementById('loader').style.display = 'none';
                log("OpenCV ");
                initCamera();
            }
        }, 500);
    };

    async function initCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } } 
            });
            video.srcObject = stream;
        } catch (e) { log("砖转 爪: " + e.message); }
    }

    // 2. 爪 注 - 驻转专 砖转 Bad Size
    function captureAndProcess() {
        if (!cvReady) return;
        log("注 住专拽...");

        // ) 爪专 驻专 拽住 住转专  拽注 转 转
        const width = video.videoWidth;
        const height = video.videoHeight;
        hiddenCanvas.width = width;
        hiddenCanvas.height = height;
        const ctx = hiddenCanvas.getContext('2d');
        ctx.drawImage(video, 0, 0, width, height);

        try {
            // ) 拽专 拽住 -OpenCV ( 转 注   住专)
            let src = cv.imread(hiddenCanvas);
            let dst = new cv.Mat();

            // ) 注 砖专- 拽爪注
            cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);
            cv.adaptiveThreshold(dst, dst, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 21, 15);

            // ) 爪转 转爪 拽住 驻 砖专
            cv.imshow('outputCanvas', dst);
            const imgData = outputCanvas.toDataURL('image/jpeg', 0.8);
            scannedPages.push(imgData);

            // ) 拽 专
            src.delete(); dst.delete();
            
            updateUI();
            log("注 住专拽 爪");
        } catch (err) {
            log("砖: " + err.message);
            console.error(err);
        }
    }

    function updateUI() {
        document.getElementById('pageCount').innerText = scannedPages.length;
        thumbnailsDiv.innerHTML = "";
        scannedPages.forEach(img => {
            const el = document.createElement('img');
            el.src = img;
            el.className = 'thumb';
            thumbnailsDiv.appendChild(el);
        });
        if (scannedPages.length > 0) {
            document.getElementById('finalActions').style.display = 'flex';
        }
    }

    async function sendPDF() {
        log("爪专 拽抓 PDF...");
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();

        for (let i = 0; i < scannedPages.length; i++) {
            if (i > 0) pdf.addPage();
            // 转转 转  祝 A4
            pdf.addImage(scannedPages[i], 'JPEG', 0, 0, 210, 297);
        }

        const blob = pdf.output('blob');
        const file = new File([blob], "Srika_Pro.pdf", { type: "application/pdf" });

        if (navigator.share) {
            try {
                await navigator.share({ files: [file], title: '住专拽 砖' });
            } catch (e) { log("砖转祝 "); }
        } else {
            pdf.save("scan.pdf");
        }
    }

    function resetAll() {
        if (confirm("拽 ?")) {
            scannedPages = [];
            updateUI();
            document.getElementById('finalActions').style.display = 'none';
            log("驻住");
        }
    }
</script>
</body>
</html>
