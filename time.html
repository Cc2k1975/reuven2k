<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Global Timer</title>

  <style>
    *{margin:0;padding:0;box-sizing:border-box;}

    html, body {
      width:100%;
      height:100%;
      overflow:hidden;
      background:#000;
      color:#fff;
      font-family:"Courier New", monospace;
    }

    body {
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
    }

    .wrapper {
      width:100%;
      max-width:800px;
      padding:20px;
    }

    #eventTitle {
      font-size:clamp(1.8rem,5vw,2.8rem);
      font-weight:900;
      margin-bottom:1rem;
      color:#ffffff;
      word-break:break-word;
    }

    #countdown {
      font-size:clamp(3rem,15vw,5rem);
      font-weight:900;
      letter-spacing:0.07em;
      direction:ltr;
      color:#00ff55;
      text-shadow:0 0 12px #00ff55,0 0 22px #009933;
    }

    .labels {
      margin-top:10px;
      font-size:clamp(1rem,4vw,1.4rem);
      font-weight:800;
      letter-spacing:0.3em;
    }

    /* כפתור סודי */
    #secretBtn {
      position:fixed;
      bottom:10px;
      right:10px;
      width:45px;
      height:45px;
      opacity:0; /* כפתור נסתר */
      z-index:50;
    }

    /* חלון הגדרות */
    .overlay {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.65);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:100;
    }
    .overlay.active {display:flex;}

    .dialog {
      background:#111;
      padding:20px;
      border-radius:12px;
      width:90%;
      max-width:420px;
      color:#fff;
      text-align:right;
      box-shadow:0 20px 40px rgba(0,0,0,0.7);
      font-family:Arial,"Heebo",sans-serif;
    }

    .dialog h2 {margin-bottom:15px;font-size:1.2rem;}

    .field {margin-bottom:15px;}
    .field label {display:block;margin-bottom:5px;font-size:0.95rem;}
    .field input {
      width:100%;
      padding:10px;
      border:1px solid #555;
      border-radius:8px;
      background:#000;
      color:#fff;
      font-size:1rem;
    }

    .buttons {display:flex;justify-content:flex-end;gap:12px;margin-top:10px;}
    .btn {
      padding:9px 16px;
      border-radius:20px;
      cursor:pointer;
      border:1px solid #fff;
      font-size:0.9rem;
      font-weight:600;
    }
    .btn.secondary {background:#000;color:#fff;}
    .btn.primary {background:#00ff55;color:#000;}
  </style>
</head>
<body>

<div class="wrapper">
  <div id="eventTitle">אין אירוע מוגדר</div>
  <div id="countdown">000:00:00:00:00</div>
  <div class="labels">D&nbsp;&nbsp;H&nbsp;&nbsp;M&nbsp;&nbsp;S</div>
</div>

<button id="secretBtn"></button>

<div class="overlay" id="overlay">
  <div class="dialog">
    <h2>הגדרת אירוע חדש</h2>

    <div class="field">
      <label>שם האירוע</label>
      <input id="eventNameInput" type="text">
    </div>

    <div class="field">
      <label>תאריך ושעה</label>
      <input id="eventTimeInput" type="datetime-local">
    </div>

    <div class="buttons">
      <button class="btn secondary" id="cancelBtn">ביטול</button>
      <button class="btn primary" id="saveBtn">שמור</button>
    </div>
  </div>
</div>

<script type="module">

  /* ------------------------ FIREBASE ------------------------ */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

  // ⭐⭐⭐ הדבק כאן את ה־firebaseConfig של global-timer ⭐⭐⭐
  const firebaseConfig = {
    apiKey: "AIzaSyBpiYodCIBxCReDSyfToFiDJp-xksOzuzY",
    authDomain: "mifkad-online.firebaseapp.com",
    databaseURL: "https://mifkad-online-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "mifkad-online",
    storageBucket: "mifkad-online.firebasestorage.app",
    messagingSenderId: "602973548307",
    appId: "1:602973548307:web:36c639ca2f030e61d3b4e6",
    measurementId: "G-K11QKY18SK"
  };
  // ⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const ref = doc(db, "globalTimer", "event");

  /* ------------------------ אלמנטים ------------------------ */
  const eventTitleEl   = document.getElementById("eventTitle");
  const countdownEl    = document.getElementById("countdown");
  const secretBtn      = document.getElementById("secretBtn");
  const overlay        = document.getElementById("overlay");
  const eventNameInput = document.getElementById("eventNameInput");
  const eventTimeInput = document.getElementById("eventTimeInput");
  const cancelBtn      = document.getElementById("cancelBtn");
  const saveBtn        = document.getElementById("saveBtn");

  let targetTime = null;
  let timerId    = null;

  /* ------------------------ פונקציות ------------------------ */

  function pad(n, size){
    let s = String(n);
    while (s.length < size) s = "0" + s;
    return s;
  }

  function updateTimer(){
    if (!targetTime){
      countdownEl.textContent = "000:00:00:00:00";
      return;
    }

    const now = Date.now();
    let diff = targetTime - now;
    if (diff < 0) diff = 0;

    const days    = Math.floor(diff / 86400000);
    const hours   = Math.floor((diff / 3600000) % 24);
    const minutes = Math.floor((diff / 60000) % 60);
    const seconds = Math.floor((diff / 1000) % 60);
    const millis  = Math.floor((diff % 1000) / 10); // 2 ספרות בלבד

    countdownEl.textContent =
      pad(days,3) + ":" +
      pad(hours,2) + ":" +
      pad(minutes,2) + ":" +
      pad(seconds,2) + ":" +
      pad(millis,2);
  }

  function startInterval(){
    if (timerId) clearInterval(timerId);
    timerId = setInterval(updateTimer, 10);
  }

  /* ------------------------ מאזין FIRESTORE ------------------------ */

  onSnapshot(ref, snap => {
    const data = snap.data();

    if (!data || !data.timestamp){
      targetTime = null;
      eventTitleEl.textContent = "אין אירוע מוגדר";
      updateTimer();
      return;
    }

    targetTime = data.timestamp;
    eventTitleEl.textContent = data.name || "אירוע ללא שם";

    startInterval();
  });

  /* ------------------------ כפתור סודי ------------------------ */

  secretBtn.onclick = () => {
    overlay.classList.add("active");
    eventNameInput.focus();
  };

  cancelBtn.onclick = () => {
    overlay.classList.remove("active");
  };

  saveBtn.onclick = async () => {

    const name = eventNameInput.value.trim();
    const d = eventTimeInput.value;

    if (!d){
      alert("בחר תאריך ושעה");
      return;
    }

    const t = new Date(d);
    if (isNaN(t.getTime())){
      alert("תאריך לא תקין");
      return;
    }

    await setDoc(ref, {
      name: name || "אירוע ללא שם",
      timestamp: t.getTime()
    }, { merge:true });

    overlay.classList.remove("active");
  };

  overlay.onclick = e => {
    if (e.target === overlay)
      overlay.classList.remove("active");
  };

</script>

</body>
</html>
