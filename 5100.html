<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>5100 - Cloud Fix</title>
    <style>
        :root { --primary: #1e3a8a; --accent: #2563eb; --bg: #f3f4f6; --card: #ffffff; --text: #1f2937; --wa: #16a34a; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        #settings-trigger { position: absolute; top: 10px; left: 10px; font-size: 14px; cursor: pointer; opacity: 0.3; padding: 10px; z-index: 100; }
        .section { width: 100%; max-width: 480px; background: var(--card); padding: 12px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 12px; box-sizing: border-box; }
        h1 { color: var(--primary); margin: 5px 0; text-align: center; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px; color: var(--primary); }
        .grid-7, .grid-3, .grid-4 { display: grid; gap: 4px; }
        .grid-7 { grid-template-columns: repeat(7, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .grid-4 { grid-template-columns: repeat(4, 1fr); gap: 6px; }
        button { padding: 10px 2px; border: 1px solid #d1d5db; background: #f9fafb; border-radius: 8px; cursor: pointer; font-size: 12px; }
        button.active { background: var(--accent); color: white; border-color: var(--accent); }
        input, textarea { width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 16px; box-sizing: border-box; outline: none; }
        textarea { height: 40px; resize: none; font-size: 14px; }
        .btn-save { width: 100%; max-width: 480px; padding: 15px; background: #059669; color: white; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; margin-bottom: 20px; cursor: pointer; }
        .status-bar { font-size: 11px; color: #64748b; margin-bottom: 8px; font-weight: bold; }
        #settings-panel { display: none; width: 100%; max-width: 500px; background: #fff; padding: 15px; border-radius: 12px; border: 2px solid var(--primary); margin-top: 10px; box-sizing: border-box; }
        .item-row { background: white; padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #eee; font-size: 13px; }
        .summary-row { padding: 10px; border-bottom: 1px solid #ddd; cursor: pointer; font-size: 13px; }
        @media print { .no-print { display: none !important; } .print-only { display: block !important; } }
        .print-only { display: none; }
        .report-table { width: 100%; border-collapse: collapse; margin-top: 15px; border: 1px solid black; }
        .report-table th, .report-table td { border: 1px solid black; padding: 8px; text-align: right; }
    </style>
</head>
<body>

    <div id="settings-trigger" class="no-print" onclick="checkPass()">âš™ï¸</div>
    <div id="status-bar" class="status-bar no-print">×× ×¡×” ×œ×”×ª×—×‘×¨ ×œ×¢× ×Ÿ...</div>

    <div id="main-ui" class="no-print">
        <h1>5100</h1>

        <div class="section">
            <label>×§×•××”</label>
            <div class="grid-7" id="floorContainer"></div>
        </div>

        <div class="section">
            <label>××¡×¤×¨ ×—×“×¨</label>
            <input type="number" id="roomInput" list="roomSuggestions" placeholder="×—×“×¨...">
            <datalist id="roomSuggestions"></datalist>
        </div>

        <div class="section">
            <label>×¢××“×”</label>
            <div class="grid-3" id="posContainer">
                <button onclick="setPos(this, '×™××™×Ÿ')">×™××™×Ÿ</button>
                <button onclick="setPos(this, '×©×××œ')">×©×××œ</button>
                <button onclick="setPos(this, '×“×œ×ª')">×“×œ×ª</button>
            </div>
        </div>

        <div class="section">
            <label>×¤×¢×¨×™× (28 ×œ×—×¦× ×™×)</label>
            <div class="grid-4" id="gapContainer"></div>
        </div>

        <div class="section">
            <label>×”×¢×¨×•×ª</label>
            <textarea id="notesInput" placeholder="×”×¢×¨×” ×§×¦×¨×”..."></textarea>
        </div>

        <button id="saveBtn" class="btn-save" onclick="saveData()">×©××•×¨ ×œ×¢× ×Ÿ â˜ï¸</button>

        <div class="section" style="background: #eff6ff;" id="editArea">
            <label>×—×¤×© ×—×“×¨</label>
            <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                <input type="number" id="searchRoomInput" placeholder="×—×“×¨...">
                <button onclick="searchByRoom()" style="background: var(--accent); color: white; border:none; padding: 0 15px; border-radius: 8px;">×”×¦×’</button>
            </div>
            <div id="searchResults"></div>
        </div>

        <div class="section">
            <label>×¤×¢×¨×™× ×¤×ª×•×—×™× (×‘× ×™×™×Ÿ ×©×œ×)</label>
            <div id="mainSummary"></div>
        </div>
    </div>

    <div id="settings-panel" class="no-print">
        <h2 style="text-align:center;">× ×™×”×•×œ (4451)</h2>
        <div style="margin-bottom:15px;">
            <label>âœï¸ ×¢×¨×™×›×ª 28 ×œ×—×¦× ×™×:</label>
            <div id="gap-editor-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;"></div>
        </div>
        <button onclick="closeSettings()" style="width:100%; background:var(--primary); color:white; padding:15px; border:none; border-radius:10px; font-weight:bold;">×©××•×¨ ×•×¦×</button>
    </div>

    <div id="printableReport" class="print-only" style="direction: rtl; padding: 20px;">
        <h1 id="repTitle">×“×•×— ×¤×¢×¨×™× 5100</h1>
        <p>×ª××¨×™×š: <span id="repDate"></span></p>
        <div id="repContent"></div>
    </div>

    <script>
        // --- ×¤×¨×˜×™ ×”-GITHUB ×©×œ×š ---
        const GH_CONFIG = {
            user: 'Cc2k1975',
            repo: 'reuven2k',
            path: 'data/5100.json',
            token: '×›××Ÿ_×œ×”×“×‘×™×§_××ª_×”×˜×•×§×Ÿ_×”×—×“×©' // <--- ×ª×—×œ×™×£ ×‘×˜×•×§×Ÿ ×”×—×“×© ×©×™×™×¦×¨×ª
        };

        let db = [];
        let gapList = ["×—×©××œ", "×¨×©×ª", "×ª×§×©×•×¨×ª", "×ª××•×¨×”", "×’×œ××™", "×©×§×¢", "××¤×¡×§", "×œ×•×— ×—×©××œ", "××™×–×•×’", "×¡×¤×¨×™× ×§×œ×¨", "×˜×™×—", "×¦×‘×¢", "×¨×™×¦×•×£", "×—×™×¤×•×™", "×ª×§×¨×”", "×“×œ×ª", "×× ×¢×•×œ", "×—×œ×•×Ÿ", "××™×˜×•×", "× ×™×§×™×•×Ÿ", "×¤×¢×¨ 21", "×¤×¢×¨ 22", "×¤×¢×¨ 23", "×¤×¢×¨ 24", "×¤×¢×¨ 25", "×¤×¢×¨ 26", "×¤×¢×¨ 27", "×¤×¢×¨ 28"];
        let selectedFloor = null, selectedPos = null, selectedGaps = [];
        let ghFileSha = null;

        async function initApp() {
            const status = document.getElementById('status-bar');
            if (GH_CONFIG.token.includes('×›××Ÿ')) {
                status.innerText = "âŒ ×©×’×™××”: ×œ× ×”×›× ×¡×ª ×˜×•×§×Ÿ ×‘×§×•×“!";
                return;
            }
            await fetchCloudData();
            renderUI();
        }

        async function fetchCloudData() {
            const url = `https://api.github.com/repos/${GH_CONFIG.user}/${GH_CONFIG.repo}/contents/${GH_CONFIG.path}`;
            try {
                const response = await fetch(url, {
                    headers: { 'Authorization': `token ${GH_CONFIG.token}`, 'Accept': 'application/vnd.github.v3+json' }
                });
                if (response.ok) {
                    const data = await response.json();
                    ghFileSha = data.sha;
                    const contentRaw = decodeURIComponent(escape(atob(data.content)));
                    if (contentRaw.trim() === "") {
                        db = [];
                    } else {
                        const content = JSON.parse(contentRaw);
                        db = content.db || [];
                        gapList = content.gapList || gapList;
                    }
                    document.getElementById('status-bar').innerText = "âœ… ××—×•×‘×¨ ×œ×¢× ×Ÿ ×•××¡×•× ×›×¨×Ÿ";
                } else {
                    document.getElementById('status-bar').innerText = "âŒ ×©×’×™××” ×‘×˜×¢×™× ×”: " + response.status;
                }
            } catch (e) { document.getElementById('status-bar').innerText = "âŒ ×©×’×™××ª ×”×ª×—×‘×¨×•×ª ×œ-GitHub"; }
        }

        async function syncToCloud() {
            const url = `https://api.github.com/repos/${GH_CONFIG.user}/${GH_CONFIG.repo}/contents/${GH_CONFIG.path}`;
            const contentString = JSON.stringify({ db, gapList });
            const body = {
                message: "Update 5100 data",
                content: btoa(unescape(encodeURIComponent(contentString))),
                sha: ghFileSha
            };
            
            const response = await fetch(url, {
                method: 'PUT',
                headers: { 'Authorization': `token ${GH_CONFIG.token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            if (response.ok) {
                const resData = await response.json();
                ghFileSha = resData.content.sha;
                return true;
            } else {
                const errData = await response.json();
                console.error("GitHub Error:", errData);
                return false;
            }
        }

        function renderUI() {
            const fCont = document.getElementById('floorContainer'); fCont.innerHTML = '';
            for (let i = 1; i <= 7; i++) {
                const btn = document.createElement('button'); btn.innerText = i;
                btn.onclick = () => { document.querySelectorAll('#floorContainer button').forEach(b => b.classList.remove('active')); btn.classList.add('active'); selectedFloor = i; updateRoomSuggestions(); };
                fCont.appendChild(btn);
            }
            const gCont = document.getElementById('gapContainer'); gCont.innerHTML = '';
            gapList.forEach(gap => {
                const btn = document.createElement('button'); btn.innerText = gap;
                btn.onclick = () => {
                    if(selectedGaps.includes(gap)) { selectedGaps = selectedGaps.filter(g => g !== gap); btn.classList.remove('active'); }
                    else { selectedGaps.push(gap); btn.classList.add('active'); }
                };
                gCont.appendChild(btn);
            });
            renderSummary();
        }

        async function saveData() {
            const status = document.getElementById('status-bar');
            const room = document.getElementById('roomInput').value;
            if(!selectedFloor || !room || !selectedPos || selectedGaps.length === 0) return alert("××œ× × ×ª×•× ×™×");
            
            selectedGaps.forEach(gap => {
                db.push({ id: Date.now() + Math.random(), status: 'active', date: new Date().toLocaleDateString('he-IL'), room: room, position: selectedPos, gap: gap, notes: document.getElementById('notesInput').value });
            });

            status.innerText = "â³ ×©×•××¨ ×œ×¢× ×Ÿ...";
            const success = await syncToCloud();
            if(success) {
                status.innerText = "âœ… × ×©××¨ ×‘×”×¦×œ×—×”!";
                setTimeout(() => location.reload(), 800);
            } else {
                alert("×©×’×™××ª ×©××™×¨×”! ×•×•×“× ×©×”×§×•×‘×¥ ×‘×’×™×˜×”××‘ ×œ× ×¨×™×§ ×•×©×™×© ×œ×š ×˜×•×§×Ÿ ×ª×§×™×Ÿ.");
                status.innerText = "âŒ ×©×’×™××ª ×©××™×¨×”";
            }
        }

        function checkPass() { if(prompt("×¡×™×¡××”:") === "4451") { document.getElementById('main-ui').style.display = 'none'; document.getElementById('settings-panel').style.display = 'block'; loadEditor(); } }
        function loadEditor() {
            const grid = document.getElementById('gap-editor-grid'); grid.innerHTML = '';
            gapList.forEach((gap, idx) => {
                const inp = document.createElement('input'); inp.value = gap;
                inp.onchange = (e) => { gapList[idx] = e.target.value; };
                grid.appendChild(inp);
            });
        }
        async function closeSettings() { await syncToCloud(); location.reload(); }

        function searchByRoom() {
            const val = document.getElementById('searchRoomInput').value;
            const res = document.getElementById('searchResults'); res.innerHTML = '';
            const filtered = db.filter(i => i.room == val);
            if(!filtered.length) return res.innerHTML = '××™×Ÿ × ×ª×•× ×™×';
            res.innerHTML = `<div class="pdf-actions"><button onclick="window.print()" style="background:#dc2626; color:white; padding:10px; border-radius:8px; border:none; width:100%;">ğŸ“„ ×”×“×¤×¡×”</button></div>`;
            filtered.forEach(item => {
                res.innerHTML += `<div class="item-row"><span><b>${item.gap}</b> (${item.position})</span><div><button onclick="markDone(${item.id})">âœ”ï¸</button><button onclick="deleteItem(${item.id})">ğŸ—‘ï¸</button></div></div>`;
            });
        }

        async function markDone(id) {
            const i = db.find(x => x.id === id); if(i) i.status = 'done';
            await syncToCloud();
            searchByRoom(); renderSummary();
        }

        async function deleteItem(id) {
            if(confirm("××—×§?")) { db = db.filter(x => x.id !== id); await syncToCloud(); searchByRoom(); renderSummary(); }
        }

        function renderSummary() {
            const cont = document.getElementById('mainSummary'); cont.innerHTML = '';
            const active = db.filter(i => i.status === 'active');
            const groups = {}; active.forEach(i => { if(!groups[i.room]) groups[i.room] = new Set(); groups[i.room].add(i.gap); });
            Object.keys(groups).sort((a,b)=>a-b).forEach(r => {
                cont.innerHTML += `<div class="summary-row" onclick="document.getElementById('searchRoomInput').value = ${r}; searchByRoom();"><strong>×—×“×¨ ${r}</strong>: ${Array.from(groups[r]).join(', ')}</div>`;
            });
        }

        function updateRoomSuggestions() {
            const list = document.getElementById('roomSuggestions'); list.innerHTML = '';
            if(!selectedFloor) return;
            for(let i = selectedFloor * 100 + 1; i <= selectedFloor * 100 + 99; i++) {
                const opt = document.createElement('option'); opt.value = i; list.appendChild(opt);
            }
        }
        function setPos(btn, val) { document.querySelectorAll('#posContainer button').forEach(b => b.classList.remove('active')); btn.classList.add('active'); selectedPos = val; }

        initApp();
    </script>
</body>
</html>
