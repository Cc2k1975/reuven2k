<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>פן אקספרס – קביעת תור</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<style>
  body {
    font-family: Arial, Helvetica, sans-serif;
    background: #000;
    margin: 0;
    padding: 0;
    color: #d4af37;
  }

  .hero-logo {
    width: 92px;
    display: block;
    margin: -6px auto -12px auto;
  }

  .wrap {
    max-width: 520px;
    margin: 4px auto;
    padding: 20px 24px 24px;
    background: #111;
    border-radius: 16px;
    box-shadow: 0 6px 18px rgba(255, 215, 0, 0.25);
  }

  h1 {
    margin: 0 0 4px;
    font-size: 33px;
    color: #ffd700;
    text-align: center;
  }

  h2 {
    margin: 0 0 16px;
    font-size: 20.7px;
    color: #d4af37;
    text-align: center;
  }

  label {
    display: block;
    margin: 12px 4px 5px;
    font-weight: 600;
    color: #ffd700;
    font-size: 16.6px;
  }

  input, select, button {
    width: 100%;
    padding: 12px 14px;
    border: 1px solid #d4af37;
    border-radius: 10px;
    font-size: 16.6px;
    box-sizing: border-box;
    background: #222;
    color: #ffd700;
  }

  input[type="tel"] { text-align: right; }

  .btn {
    background: #d4af37;
    color: #000;
    border: 0;
    cursor: pointer;
    margin-top: 16px;
    font-weight: 700;
    font-size: 16.6px;
  }

  .btn[disabled] { opacity: .6; cursor: not-allowed; }

  .btn-secondary {
    background: #000;
    color: #ffd700;
    border: 1px solid #d4af37;
    margin-top: 9px;
    font-size: 14.5px;
    padding: 10px;
  }

  /* אייקון קטן בתוך כפתורי המשנה – מוגדל ב-30% ל-23.4px */
  .btn-secondary img.icon {
    width: 23.4px;
    height: 23.4px;
    vertical-align: middle;
    margin: 0 6px;
  }

  .error {
    background: #330000;
    color: #ff6666;
    border: 1px solid #ff9999;
    padding: 9px;
    border-radius: 10px;
    margin-top: 9px;
    display: none;
    font-size: 15px;
  }

  .success {
    background: #003300;
    color: #66ff99;
    border: 1px solid #99ffcc;
    padding: 9px;
    border-radius: 10px;
    margin-top: 9px;
    display: none;
    font-size: 15px;
  }

  option.taken { color: #888; background: #333; }

  .ver {
    margin-top: 14px;
    font-size: 12.4px;
    color: #bfa76f;
    text-align: center;
  }

  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 50;
  }

  .modal {
    background: #111;
    border-radius: 14px;
    max-width: 420px;
    width: 92%;
    padding: 18px 18px 12px;
    box-shadow: 0 0 25px rgba(255,215,0,.3);
    color: #ffd700;
  }

  .modal h3 {
    margin: 0 0 8px;
    font-size: 20.7px;
    color: #ffd700;
  }

  .modal p {
    margin: 0 0 14px;
    color: #ffd700;
    white-space: pre-line;
    font-size: 15px;
  }

  .modal .row {
    display: flex;
    gap: 10px;
    justify-content: space-between;
  }

  .modal .row button {
    flex: 1;
    padding: 10px;
    border-radius: 10px;
    border: 0;
    font-weight: 700;
    font-size: 15px;
  }

  .modal .cancel {
    background: #222;
    color: #ffd700;
    border: 1px solid #ffd700;
  }

  .modal .ok {
    background: #ffd700;
    color: #000;
  }
</style>
</head>
<body>

  <img src="https://reuven2k.com/exe.gif" alt="פן אקספרס" class="hero-logo" />

  <div class="wrap">
    <h1>פן אקספרס</h1>
    <h2>מערכת לזימון תורים</h2>

    <div id="msgError" class="error"></div>
    <div id="msgOk" class="success"></div>

    <label for="date">בחר תאריך:</label>
    <input type="date" id="date" required />

    <label for="time">שעה פנויה:</label>
    <select id="time" required>
      <option value="">טוען שעות…</option>
    </select>

    <label for="name">שם הלקוחה:</label>
    <input type="text" id="name" placeholder="הכנס שם" required />

    <label for="phone">מספר טלפון:</label>
    <input type="tel" id="phone" placeholder="הכנס טלפון" required />

    <button id="save" class="btn">שמור</button>

    <button id="galleryBtn" type="button" class="btn-secondary">
      <b>גלריית עבודות</b>
    </button>

    <button id="navWaze" type="button" class="btn-secondary">
      <b>נווט ל פן-אקספרס</b>
      <img class="icon" src="https://reuven2k.com/map.png" alt="" />
    </button>

    <div class="ver">Version: 1.6.1</div>
  </div>

  <div id="icsModal" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h3>להוסיף תזכורת ליומן?</h3>
      <p id="icsText">ניצור אירוע ליומן בתאריך ___ בשעה ___ כולל תזכורת שעה לפני.
לקוחה יקרה, מזכירה לך להגיע חפופה ובזמן 💇‍♀️
תודה - פן אקספרס</p>
      <div class="row">
        <button type="button" class="cancel" id="btnCancel">ביטול</button>
        <button type="button" class="ok" id="btnOk">אישור</button>
      </div>
    </div>
  </div>

<script>
const BIN_ID = '68f0e7bed0ea881f40a63b29';
const MASTER_KEY = '$2a$10$4rynniEMuvwqg2nDb5KSEe/lAVYp8a7L3xWzp9GsO6n49OfXc3FCO';
const BIN_URL = 'https://api.jsonbin.io/v3/b/' + BIN_ID;
const MAP_URL = 'https://maps.google.com/?q=33.003292,35.108864';
const WAZE_DEEP = 'waze://?ll=33.003292,35.108864&navigate=yes';
const WAZE_WEB  = 'https://waze.com/ul?ll=33.003292%2C35.108864&navigate=yes';
const GALLERY_URL = 'https://reuven2k.com/images/index.html';
const TIMEZONE = 'Asia/Jerusalem';
const EVENT_TITLE = 'תור ל פן אקספרס'; // עודכן לפי הבקשה
const ALARM_MINUTES = 60;
const SLOT_MINUTES = 20;

const pad2 = n => (n<10?('0'+n):''+n);
function genTimeSlots(){
  const slots=[]; for(let h=8; h<=20; h++){ for(let m of [0,20,40]){ if(h===20 && m>0) continue; slots.push(`${pad2(h)}:${pad2(m)}`);} }
  return slots;
}
const SLOTS = genTimeSlots();

function todayStr(){ return new Date().toISOString().slice(0,10); }
function addDaysStr(days){ const d=new Date(); d.setDate(d.getDate()+days); return d.toISOString().slice(0,10); }
function setDateLimits(){ elDate.min=todayStr(); elDate.max=addDaysStr(3); if(!elDate.value) elDate.value=todayStr(); }
function fmtDateHeb(s){ const [y,m,d]=s.split('-'); return `${d}.${m}.${y}`; }

const elDate=document.getElementById('date');
const elTime=document.getElementById('time');
const elName=document.getElementById('name');
const elPhone=document.getElementById('phone');
const elSave=document.getElementById('save');
const msgErr=document.getElementById('msgError');
const msgOk=document.getElementById('msgOk');
const icsModal=document.getElementById('icsModal');
const btnOk=document.getElementById('btnOk');
const btnCancel=document.getElementById('btnCancel');
const icsText=document.getElementById('icsText');
const btnWaze=document.getElementById('navWaze');
const btnGallery=document.getElementById('galleryBtn');

btnGallery.addEventListener('click', ()=> window.location.href = GALLERY_URL);

function showErr(t){ msgErr.textContent=t; msgErr.style.display='block'; setTimeout(()=>msgErr.style.display='none',4000); }
function showOk(t){ msgOk.textContent=t; msgOk.style.display='block'; setTimeout(()=>msgOk.style.display='none',4000); }

setDateLimits();

/* === סטטוס פתיחה/סגירה כפי שהיה בשינויים הקודמים (כיבוד bookingOpen אם קיים) === */
let BOOKING_OPEN = true;
function setBookingEnabledState(isEnabled){
  elSave.disabled = !isEnabled;
}

async function fetchRecord(){
  const r=await fetch(BIN_URL+'?ts='+Date.now(),{headers:{'X-Master-Key':MASTER_KEY},cache:'no-store'});
  if(!r.ok) throw new Error('fetch failed');
  const j=await r.json();
  const rec = (j.record && Array.isArray(j.record.bookings))? j.record : {bookings:[]};
  BOOKING_OPEN = (typeof rec.bookingOpen === 'boolean') ? rec.bookingOpen : true;
  setBookingEnabledState(BOOKING_OPEN);
  return rec;
}
async function putRecord(rec){
  const r=await fetch(BIN_URL+'?ts='+Date.now(),{method:'PUT',headers:{'Content-Type':'application/json','X-Master-Key':MASTER_KEY},body:JSON.stringify(rec),cache:'no-store'});
  if(!r.ok) throw new Error('put failed');
  return r.json().catch(()=> ({}));
}

async function refreshTimes(){
  elTime.innerHTML = `<option value="">טוען…</option>`;
  try{
    const {bookings}=await fetchRecord();
    const date=elDate.value;

    if(!BOOKING_OPEN){
      elTime.innerHTML = `<option value="">בחר שעה…</option>` + SLOTS.map(t=>`<option value="${t}" disabled class="taken">${t} – תפוס</option>`).join('');
      return;
    }

    const taken=new Set(bookings.filter(b=>b.date===date).map(b=>b.time));
    elTime.innerHTML = `<option value="">בחר שעה…</option>` + SLOTS.map(t=>{
      const isTaken=taken.has(t);
      return `<option value="${t}" ${isTaken?'disabled class="taken"':''}>${t}${isTaken?' – תפוס':''}</option>`;
    }).join('');
  }catch(e){ showErr('שגיאה בטעינת נתונים'); }
}
elDate.addEventListener('change',refreshTimes);
refreshTimes();

function validPhone(p){ return (p||'').replace(/\D/g,'').length>=8; }
function normalizePhone(p){ return (p||'').replace(/\D/g,''); }

/* ==== ICS עם תזכורת 60 דק' — עובד גם באייפון וגם באנדרואיד ==== */
function toICSLocal(dateStr,timeStr){
  const [y,m,d]=dateStr.split('-').map(Number);
  const [hh,mm]=timeStr.split(':').map(Number);
  const dt=new Date(y,m-1,d,hh,mm,0);
  return `${dt.getFullYear()}${pad2(dt.getMonth()+1)}${pad2(dt.getDate())}T${pad2(dt.getHours())}${pad2(dt.getMinutes())}00`;
}
function buildICS({title,location,startLocal,endLocal,tzid}){
  const uid=`${Date.now()}-${Math.random().toString(36).slice(2)}@fenexpress`;
  const dtstamp=new Date().toISOString().replace(/[-:]/g,'').replace(/\.\d{3}Z$/,'Z');
  const details=`קישור ישיר להגעה לפן אקספרס:\n${MAP_URL}`;
  return [
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//FenExpress//Booking//HE',
    'CALSCALE:GREGORIAN',
    'METHOD:PUBLISH',
    'BEGIN:VEVENT',
    `UID:${uid}`,
    `DTSTAMP:${dtstamp}`,
    `DTSTART;TZID=${tzid}:${startLocal}`,
    `DTEND;TZID=${tzid}:${endLocal}`,
    `SUMMARY:${title}`,
    `DESCRIPTION:${details.replace(/\n/g,'\\n')}`,
    `LOCATION:${location}`,
    'BEGIN:VALARM',
    `TRIGGER:-PT${ALARM_MINUTES}M`,
    'ACTION:DISPLAY',
    'DESCRIPTION:Reminder',
    'END:VALARM',
    'END:VEVENT',
    'END:VCALENDAR'
  ].join('\r\n');
}
function downloadICS(filename,content){
  const blob=new Blob([content],{type:'text/calendar;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download=filename;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},1200);
}
function openCalendarICS(dateStr,timeStr){
  const [y,m,d]=dateStr.split('-').map(Number);
  const [hh,mm]=timeStr.split(':').map(Number);
  const start=new Date(y,m-1,d,hh,mm,0);
  const end=new Date(start.getTime()+SLOT_MINUTES*60000);
  const startLocal=toICSLocal(dateStr,timeStr);
  const endLocal=`${end.getFullYear()}${pad2(end.getMonth()+1)}${pad2(end.getDate())}T${pad2(end.getHours())}${pad2(end.getMinutes())}00`;
  const ics = buildICS({title:EVENT_TITLE,location:MAP_URL,startLocal,endLocal,tzid:TIMEZONE});
  downloadICS('fen-appointment.ics', ics);
}
/* ================================================================ */

document.getElementById('navWaze').addEventListener('click', ()=>{
  const start = Date.now();
  window.location.href = WAZE_DEEP;
  setTimeout(()=>{
    if (Date.now() - start < 1200) {
      window.location.href = WAZE_WEB;
    }
  }, 900);
});

let lastSavedPayload=null;
elSave.addEventListener('click',async ()=>{
  const payload={date:elDate.value,time:elTime.value,name:elName.value.trim(),phone:elPhone.value.trim()};
  if(!payload.date||!payload.time||!payload.name||!payload.phone){showErr('נא למלא את כל השדות');return;}
  if(!validPhone(payload.phone)){showErr('מספר טלפון לא תקין');return;}

  elSave.disabled=true;
  try{
    let rec=await fetchRecord();
    const normPhone=normalizePhone(payload.phone);
    const existsSameDayPhone=rec.bookings.some(b=>b.date===payload.date && normalizePhone(b.phone)===normPhone);
    if(existsSameDayPhone){showErr('קיים כבר תור על שמך לאותו יום. נא לבחור תאריך אחר.'); elSave.disabled=false; await refreshTimes(); return;}
    if(rec.bookings.some(b=>b.date===payload.date && b.time===payload.time)){showErr('השעה נתפסה הרגע. בחר שעה אחרת.'); elSave.disabled=false; await refreshTimes(); return;}

    rec.bookings.push({date:payload.date,time:payload.time,name:payload.name,phone:payload.phone,ts:Date.now()});
    await putRecord(rec);

    lastSavedPayload=payload;
    showOk('התור נשמר בהצלחה!');
    icsText.textContent=`ניצור אירוע ליומן בתאריך ${fmtDateHeb(payload.date)} בשעה ${payload.time} כולל תזכורת שעה לפני.\nלקוחה יקרה, מזכירה לך להגיע חפופה ובזמן 💇‍♀️\nתודה - פן אקספרס`;

    /* פתיחת חלון "שמור תור ביומן" — שינוי מינימלי כדי שיופיע */
    icsModal.style.display='flex';

    await new Promise(r=>setTimeout(r,300));
    await refreshTimes();
    elTime.value=""; elName.value=""; elPhone.value="";
  }catch(e){ showErr('שגיאת רשת'); }
  finally{ elSave.disabled=false; }
});

btnCancel.addEventListener('click',()=>{ icsModal.style.display='none'; });
btnOk.addEventListener('click',()=>{
  icsModal.style.display='none';
  if(!lastSavedPayload) return;
  /* שמירה ביומן: תמיד ICS עם תזכורת 60 דק', עובד גם באייפון וגם באנדרואיד */
  openCalendarICS(lastSavedPayload.date,lastSavedPayload.time);
});
</script>
</body>
</html>
