<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>××©×—×§ ××ª× ×•×ª ×™×•× ×”×•×œ×“×ª</title>

  <!-- ×¡×•×¨×§ QR -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <!-- ×™×¦×™×¨×ª QR ×œ×”×“×¤×¡×” -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      /* ×¢×¨×›×™ ×‘×¨×™×¨×ª ××—×“×œ â€“ ×™×¢×•×“×›× ×• ×œ×¤×™ gender ×‘×§×•×“ */
      --bg:#ffeef7;
      --card:#ffffff;
      --accent:#ff4081;
      --accent-dark:#e91e63;
      --text:#222;
      --muted:#666;
      --radius:18px;
      --shadow:0 10px 25px rgba(0,0,0,0.12);
    }
    *{box-sizing:border-box}
    html,body{
      margin:0; padding:0;
      font-family:system-ui,"Heebo","Arial",sans-serif;
      background:linear-gradient(180deg,var(--bg),#fff);
      color:var(--text);
    }
    body{
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      padding:12px;
    }
    .app{
      width:100%; max-width:500px;
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px 16px 22px;
      position:relative; overflow:hidden;
    }
    h1,h2,h3{ margin:0 0 12px; text-align:center; }
    h1{ font-size:1.6rem; color:var(--accent-dark); }
    h2{ font-size:1.3rem; }
    p{ margin:0 0 10px; line-height:1.4; }
    .center{text-align:center}
    .btn{
      display:inline-block;
      padding:10px 18px;
      border-radius:999px;
      border:none;
      font-size:1rem;
      font-weight:600;
      cursor:pointer;
      background:var(--accent);
      color:#fff;
      box-shadow:0 6px 14px rgba(233,30,99,0.35);
      margin:8px 0;
    }
    .btn:active{
      transform:translateY(1px);
      box-shadow:0 3px 8px rgba(233,30,99,0.4);
    }
    .btn-secondary{
      background:#f1f1f1; color:#333; box-shadow:none;
    }
    .btn-small{ padding:6px 10px; font-size:0.85rem; }
    .hidden{display:none !important;}
    .tagline{
      font-size:0.95rem; color:var(--muted);
      text-align:center; margin-bottom:10px;
    }
    .progress{
      text-align:center; font-size:0.9rem;
      color:var(--muted); margin-top:6px;
    }
    .bubble{
      background:#fff3f8;
      border-radius:14px;
      padding:10px 12px;
      margin:10px 0;
      border:1px dashed #ff8bb3;
      font-size:0.95rem;
    }
    .screen{ display:none; }
    .screen.active{ display:block; }
    #qr-reader{
      width:100%; max-width:360px; margin:0 auto;
    }
    #scan-status{
      text-align:center; font-size:0.9rem;
      color:var(--muted); margin-top:8px; min-height:18px;
    }
    .station-box{
      background:#fff7fb;
      border-radius:16px;
      padding:14px;
      border:1px solid #ffd0e6;
    }
    .station-label{
      font-size:0.9rem; color:var(--muted); margin-bottom:6px;
    }
    .admin-open{
      position:absolute; top:8px; left:10px;
      background:transparent; border:none;
      color:#bbb; cursor:pointer; font-size:1.2rem; z-index:100;
    }
    .field-group{ margin-bottom:10px; }
    label{
      display:block; font-size:0.9rem;
      margin-bottom:3px; color:var(--muted);
    }
    input[type="text"], textarea, input[type="number"]{
      width:100%; padding:7px 8px;
      border-radius:10px;
      border:1px solid #dadada;
      font-size:0.9rem; font-family:inherit;
    }
    textarea{ min-height:50px; resize:vertical; }
    .stations-grid{
      max-height:320px; overflow-y:auto;
      border-radius:14px; border:1px solid #eee;
      padding:8px; background:#fafafa;
    }
    .station-edit{
      margin-bottom:10px; padding:6px 8px;
      border-radius:10px; background:#ffffff;
      border:1px solid #e5e5e5;
    }
    .station-edit h4{
      margin:0 0 6px;
      font-size:0.9rem; color:var(--accent-dark);
    }
    .footer-note{
      margin-top:8px; font-size:0.8rem;
      color:#999; text-align:center;
    }
    .loading{
      text-align:center; font-size:0.95rem; color:var(--muted);
    }
  </style>
</head>
<body>
  <div class="app">
    <button class="admin-open" id="adminOpenBtn" title="× ×™×”×•×œ">âš™</button>

    <section id="screen-loading" class="screen active">
      <h2>×˜×•×¢×Ÿ ××©×—×§â€¦</h2>
      <p class="loading">××ª×—×‘×¨ ×œÖ¾Firebase, ×¨×’×¢â€¦</p>
      <p id="error-msg" style="color:red; font-size:0.8rem; text-align:center; display:none;"></p>
    </section>

    <section id="screen-welcome" class="screen">
      <h1>××–×œ ×˜×•×‘ <span id="player-name-display">×œ×“× ×”</span>! ğŸ‰</h1>
      <p class="tagline">×”×™×•× ×× ×—× ×• ×™×•×¦××™× ×œ××¡×œ×•×œ ××¤×ª×™×¢ ×¢× ××ª× ×•×ª × ×¡×ª×¨×•×ªâ€¦</p>
      <div class="bubble">
        <p class="center" id="welcome-bubble-text">
          ×‘×›×œ ×ª×—× ×” ×ª××¦××™ ×‘×¨×§×•×“,<br>
          ×ª×¡×¨×§×™ ××•×ª×• ×•×ª×§×‘×œ×™ ×—×™×“×” ×©×ª×•×‘×™×œ ×œ××ª× ×” ×”×‘××” ğŸ
        </p>
      </div>
      <div class="center">
        <button class="btn" id="startGameBtn">×™××œ×œ×”, ××ª×—×™×œ×™×!</button>
      </div>
      <p class="progress" id="stations-count-label"></p>
    </section>

    <section id="screen-scan" class="screen">
      <h2>×¡×¨×§×™ ××ª ×”×‘×¨×§×•×“ ×”×‘× ğŸ“·</h2>
      <p class="tagline">×›×•×•× ×™ ××ª ×”××¦×œ××” ××œ ×”×‘×¨×§×•×“ ×”××¦×•×¨×£</p>
      <div id="qr-reader"></div>
      <div id="scan-status"></div>
      <div class="center" style="margin-top:12px;">
        <button class="btn-secondary btn-small" id="backToWelcomeBtn">×—×–×¨×” ×œ××¡×š ×”×¨××©×™</button>
      </div>
    </section>

    <section id="screen-station" class="screen">
      <h2 id="station-title">×›×œ ×”×›×‘×•×“! ğŸ</h2>
      <div class="station-box">
        <div class="station-label" id="station-index-label"></div>
        <p id="station-riddle"></p>
        <hr style="margin:10px 0;border:none;border-top:1px dashed #ffc0dd;">
        <p id="station-reward" style="font-weight:600;"></p>
      </div>
      <div class="center" style="margin-top:14px;">
        <button class="btn" id="continueScanBtn">×”××©×š ×œ×¡×¨×™×§×” ×”×‘××”</button>
        <button class="btn-secondary btn-small" id="backToScanBtn">×—×–×¨×” ×œ×¡×•×¨×§</button>
      </div>
    </section>

    <!-- ××¡×š ×¡×•×£ ××©×—×§ -->
    <section id="screen-end" class="screen">
      <h2>×¡×•×£ ×”××©×—×§ ğŸ‰</h2>
      <p class="center" id="end-main-text"></p>
      <p class="center" id="end-sub-text"></p>
      <div class="center" style="margin-top:16px;">
        <button class="btn" id="endExitBtn">×™×¦×™××”</button>
      </div>
    </section>

    <section id="screen-admin" class="screen">
      <h2>××¡×š × ×™×”×•×œ (×¡×•×“×™)</h2>

      <!-- ××™×Ÿ -->
      <div class="field-group">
        <label>××™×Ÿ ××§×‘×œ/×ª ×”××ª× ×•×ª:</label>
        <div style="font-size:0.9rem;color:#555;">
          <label style="margin-left:10px;">
            <input type="radio" name="gender" value="female" id="gender-female" checked> × ×§×‘×”
          </label>
          <label>
            <input type="radio" name="gender" value="male" id="gender-male"> ×–×›×¨
          </label>
        </div>
      </div>

      <div class="field-group">
        <label id="player-name-label" for="player-name-input">×©× ××§×‘×œ/×ª ×”××ª× ×•×ª:</label>
        <input type="text" id="player-name-input" placeholder="×œ××©×œ: ×“× ×”">
      </div>
      <div class="field-group">
        <label for="stations-number-input">××¡×¤×¨ ×ª×—× ×•×ª:</label>
        <!-- ×”×•×¡×¨ value="5" -->
        <input type="number" id="stations-number-input" min="1" max="30">
      </div>
      <div class="field-group">
        <p style="font-size:0.9rem;margin-bottom:4px;">×”×’×“×¨×ª ×”×ª×—× ×•×ª:</p>
        <div class="stations-grid" id="stations-edit-container"></div>
      </div>
      <div class="center" style="margin-top:10px;">
        <button class="btn" id="saveAdminBtn">×©××™×¨×” ×œÖ¾Firebase</button>
        <button class="btn-secondary btn-small" id="showBarcodesBtn">×”×¦×’ ×‘×¨×§×•×“×™×</button>
        <button class="btn-secondary btn-small" id="printBarcodesBtn">×”×“×¤×¡ ×‘×¨×§×•×“×™×</button>
        <button class="btn-secondary btn-small" id="exitAdminBtn">×™×¦×™××”</button>
      </div>

      <div id="barcode-preview" class="stations-grid" style="margin-top:10px; display:none;"></div>

      <p class="footer-note">×¢×¨×™×›×” × ×©××¨×ª ×‘×–××Ÿ ×××ª ×‘Ö¾Firebase.</p>
    </section>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBxh37gdksnvKyGZhKzcMEliRuRZaqFyRs",
      authDomain: "birthday-6673d.firebaseapp.com",
      projectId: "birthday-6673d",
      storageBucket: "birthday-6673d.firebasestorage.app",
      messagingSenderId: "815278978626",
      appId: "1:815278978626:web:2f5821014c768ee32d5fdb",
      measurementId: "G-295LG2HNQ8",
      databaseURL: "https://birthday-6673d-default-rtdb.europe-west1.firebasedatabase.app"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // --- ×‘×¨×™×¨×ª ××—×“×œ: 5 ×ª×—× ×•×ª ×¢× BARCODE1..5, ×—×™×“×•×ª/×¤×¨×¡×™× ×¨×™×§×™× ---
    const DEFAULT_CONFIG = {
      playerName: "×“× ×”",
      gender: "female",
      stations: Array.from({length:5}, (_,i) => ({
        code: `BARCODE${i+1}`,
        riddle: "",
        reward: ""
      }))
    };

    let gameConfig = null;
    let scannerInstance = null;
    let visitedCodes = new Set();

    // ××‘×˜×™×— ×©×œ×›×œ ×ª×—× ×” ×™×© code ××”×¦×•×¨×” BARCODE1..N ×× ×—×¡×¨
    function ensureBarcodeCodes(){
      if (!gameConfig.stations) gameConfig.stations = [];
      for (let i = 0; i < gameConfig.stations.length; i++){
        if (!gameConfig.stations[i].code){
          gameConfig.stations[i].code = `BARCODE${i+1}`;
        }
      }
    }

    // ×¢×“×›×•×Ÿ ×¦×‘×¢×™× ×•×˜×§×¡×˜×™× ×œ×¤×™ gender
    function applyGenderUI(){
      if (!gameConfig) return;
      const gender = gameConfig.gender || "female";
      const root = document.documentElement;

      if (gender === "male"){
        root.style.setProperty("--bg","#e5f4ff");
        root.style.setProperty("--accent","#2196f3");
        root.style.setProperty("--accent-dark","#1976d2");
      } else {
        root.style.setProperty("--bg","#ffeef7");
        root.style.setProperty("--accent","#ff4081");
        root.style.setProperty("--accent-dark","#e91e63");
      }

      const nameLabel = document.getElementById("player-name-label");
      const bubble = document.getElementById("welcome-bubble-text");

      if (nameLabel){
        nameLabel.textContent = (gender === "male")
          ? "×©× ××§×‘×œ ×”××ª× ×•×ª:"
          : "×©× ××§×‘×œ×ª ×”××ª× ×•×ª:";
      }

      if (bubble){
        if (gender === "male"){
          bubble.innerHTML = "×‘×›×œ ×ª×—× ×” ×ª××¦× ×‘×¨×§×•×“,<br>×ª×¡×¨×•×§ ××•×ª×• ×•×ª×§×‘×œ ×—×™×“×” ×©×ª×•×‘×™×œ ×œ××ª× ×” ×”×‘××” ğŸ";
        } else {
          bubble.innerHTML = "×‘×›×œ ×ª×—× ×” ×ª××¦××™ ×‘×¨×§×•×“,<br>×ª×¡×¨×§×™ ××•×ª×• ×•×ª×§×‘×œ×™ ×—×™×“×” ×©×ª×•×‘×™×œ ×œ××ª× ×” ×”×‘××” ğŸ";
        }
      }
    }

    function showScreen(name){
      document.querySelectorAll(".screen").forEach(sec => sec.classList.remove("active"));
      document.getElementById("screen-" + name).classList.add("active");
      if (name === "scan") startScanner(); else stopScanner();
    }

    function updateWelcomeScreen(){
      if (!gameConfig) return;
      document.getElementById("player-name-display").textContent =
        gameConfig.playerName || "×“× ×”";
      document.getElementById("stations-count-label").textContent =
        "×‘××©×—×§ ××—×›×•×ª ×œ×š " + (gameConfig.stations ? gameConfig.stations.length : 0) + " ×ª×—× ×•×ª ğŸ";
      applyGenderUI();
    }

    async function loadConfigFromFirebase(){
      const configRef = ref(db, "config");
      try {
        const snapshot = await get(configRef);
        if (snapshot.exists()){
          gameConfig = snapshot.val();
        } else {
          gameConfig = DEFAULT_CONFIG;
          await set(configRef, gameConfig);
        }
        if (!gameConfig.gender) gameConfig.gender = "female";
        ensureBarcodeCodes();
      } catch(err) {
        console.error("Firebase Error:", err);
        gameConfig = DEFAULT_CONFIG;
        ensureBarcodeCodes();
        const errEl = document.getElementById("error-msg");
        errEl.textContent = "×©×’×™××ª ×—×™×‘×•×¨ (×‘×“×•×§ Rules). ×”××©×—×§ ×¢×•×‘×“ ×‘××¦×‘ ××•×¤×œ×™×™×Ÿ.";
        errEl.style.display = "block";
      }
    }

    async function saveConfigToFirebase(){
      const configRef = ref(db, "config");
      ensureBarcodeCodes();
      await set(configRef, gameConfig);
    }

    function startScanner(){
      if (!window.Html5QrcodeScanner) {
        alert("×©×’×™××”: ×¡×¤×¨×™×™×ª ×”×¡×•×¨×§ ×œ× × ×˜×¢× ×”.");
        return;
      }
      stopScanner();
      scannerInstance = new Html5QrcodeScanner("qr-reader", { fps: 10, qrbox: 250 }, false);
      scannerInstance.render(onScanSuccess, () => {});
    }

    function onScanSuccess(decodedText){
      stopScanner();
      handleScannedCode(decodedText.trim());
    }

    function stopScanner(){
      if (scannerInstance){
        scannerInstance.clear().catch(console.error);
        scannerInstance = null;
      }
    }

    function handleScannedCode(codeText){
      const station = gameConfig.stations.find(s => (s.code || "").trim() === codeText);
      if (!station){
        alert("×‘×¨×§×•×“ ×œ× ××•×›×¨: " + codeText);
        showScreen("scan");
        return;
      }

      visitedCodes.add((station.code || "").trim());

      // ×× ×¡×¨×§× ×• ××ª ×›×œ ×”×ª×—× ×•×ª â€“ ××¢×‘×¨ ×œ××¡×š ×¡×•×£
      if (visitedCodes.size >= gameConfig.stations.length){
        showEndScreen();
      } else {
        showStationScreen(station);
      }
    }

    function showStationScreen(station){
      const idx = gameConfig.stations.indexOf(station);
      document.getElementById("station-title").textContent = "×ª×—× ×” " + (idx + 1) + " ğŸ‰";
      document.getElementById("station-index-label").textContent =
        "××ª×•×š " + gameConfig.stations.length;
      document.getElementById("station-riddle").textContent = station.riddle || "";
      document.getElementById("station-reward").textContent = station.reward || "";
      showScreen("station");
    }

    // ××¡×š ×¡×™×•×
    function showEndScreen(){
      const name = gameConfig.playerName || "";
      const mainEl = document.getElementById("end-main-text");
      const subEl  = document.getElementById("end-sub-text");

      mainEl.textContent = name
        ? `×©×•×‘ ××–×œ ×˜×•×‘ ${name}!`
        : "×©×•×‘ ××–×œ ×˜×•×‘!";
      subEl.textContent = "××§×•×•×™× ×©× ×”× ×™×ª ××”××©×—×§ ×•××”××ª× ×•×ª ğŸ";

      showScreen("end");
    }

    // *** ×©×™× ×•×™ ×¡×™×¡××” ×›××Ÿ ***
    function openAdmin(){
      const p = prompt("×”×›× ×¡ ×¡×™×¡××”:");
      if(p==="08061975"){
        populateAdmin();
        showScreen("admin");
      }
    }

    function populateAdmin(){
      ensureBarcodeCodes();
      document.getElementById("player-name-input").value = gameConfig.playerName;
      // ×‘××§×•× ×œ×©×™× ××¡×¤×¨ â€“ × ×©××™×¨ ×¨×™×§, ×©×ª×›×ª×•×‘ ×œ×‘×“
      document.getElementById("stations-number-input").value = "";

      const gender = gameConfig.gender || "female";
      document.getElementById("gender-female").checked = (gender !== "male");
      document.getElementById("gender-male").checked   = (gender === "male");

      renderStationsEdit();
      document.getElementById("barcode-preview").style.display = "none";
      applyGenderUI();
    }

    function renderStationsEdit(){
      const container = document.getElementById("stations-edit-container");
      container.innerHTML = "";
      gameConfig.stations.forEach((st, i) => {
        const div = document.createElement("div");
        div.className = "station-edit";
        div.innerHTML = `
          <h4>×ª×—× ×” ${i+1} (×§×•×“: ${st.code || ''})</h4>
          <input type="text" class="inp-code" placeholder="×§×•×“ ×‘×¨×§×•×“" value="${st.code||''}" style="margin-bottom:5px;">
          <textarea class="inp-riddle" placeholder="×—×™×“×”">${st.riddle||''}</textarea>
          <textarea class="inp-reward" placeholder="×¤×¨×¡">${st.reward||''}</textarea>
        `;
        container.appendChild(div);
      });
    }

    async function saveAdmin(){
      const newName = document.getElementById("player-name-input").value || "×“× ×”";
      const gender = document.getElementById("gender-male").checked ? "male" : "female";

      const container = document.getElementById("stations-edit-container");
      const blocks = container.querySelectorAll(".station-edit");
      const newStations = [];

      blocks.forEach((blk, index) => {
        let code = blk.querySelector(".inp-code").value.trim();
        if (!code) code = `BARCODE${index+1}`;
        newStations.push({
          code,
          riddle: blk.querySelector(".inp-riddle").value,
          reward: blk.querySelector(".inp-reward").value
        });
      });

      gameConfig.playerName = newName;
      gameConfig.gender    = gender;
      gameConfig.stations  = newStations;
      ensureBarcodeCodes();

      try {
        await saveConfigToFirebase();
        alert("× ×©××¨ ×‘×”×¦×œ×—×”!");
        updateWelcomeScreen();
        showScreen("welcome");
      } catch(e) {
        alert("×©×’×™××” ×‘×©××™×¨×”: " + e.message);
      }
    }

    // ×™×¦×™×¨×ª QR×™× ×‘××¡×š ×”×”×’×“×¨×•×ª
    function showBarcodes(){
      ensureBarcodeCodes();
      const preview = document.getElementById("barcode-preview");
      preview.innerHTML = "";

      if (!gameConfig.stations.length){
        preview.textContent = "××™×Ÿ ×ª×—× ×•×ª ××•×’×“×¨×•×ª.";
        preview.style.display = "block";
        return;
      }

      gameConfig.stations.forEach((st, index) => {
        const wrap = document.createElement("div");
        wrap.style.textAlign = "center";
        wrap.style.marginBottom = "12px";

        const title = document.createElement("div");
        title.textContent = `×ª×—× ×” ${index+1} â€“ ${st.code}`;
        title.style.marginBottom = "4px";
        title.style.fontSize = "0.9rem";

        const qrDiv = document.createElement("div");
        qrDiv.style.display = "inline-block";

        wrap.appendChild(title);
        wrap.appendChild(qrDiv);
        preview.appendChild(wrap);

        new QRCode(qrDiv, {
          text: st.code,
          width: 128,
          height: 128
        });
      });

      preview.style.display = "block";
    }

    // ×—×œ×•×Ÿ × ×§×™ ×œ×”×“×¤×¡×”
    function printBarcodes(){
      ensureBarcodeCodes();
      const codes = (gameConfig.stations || [])
        .map(s => (s.code || "").trim())
        .filter(Boolean);

      if (!codes.length){
        alert("××™×Ÿ ×ª×—× ×•×ª ×¢× ×§×•×“ ×‘×¨×§×•×“.");
        return;
      }

      const w = window.open("", "_blank");
      if (!w){
        alert("×”×“×¤×“×¤×Ÿ ×—×¡× ×—×œ×•×Ÿ ×§×•×¤×¥. ×‘×˜×œ ×—×¡×™××” ×•× ×¡×” ×©×•×‘.");
        return;
      }

      const codesJson = JSON.stringify(codes);
      const html =
`<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>×”×“×¤×¡×ª ×‘×¨×§×•×“×™×</title>
  <style>
    body{
      font-family:system-ui,"Heebo","Arial",sans-serif;
      direction:rtl;
      text-align:center;
      margin:20px;
    }
    h2{margin-bottom:16px;}
    .page{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
    }
    .item{
      margin:12px;
      padding:6px;
      border:1px dashed #ccc;
      border-radius:8px;
    }
    .item-title{
      margin-bottom:4px;
      font-size:0.9rem;
    }
    @media print{
      body{margin:0;}
      .item{border:none;}
    }
  </style>
</head>
<body>
  <h2>×‘×¨×§×•×“×™× ×œ××©×—×§ ××ª× ×•×ª</h2>
  <div class="page" id="codes-container"></div>
  <script>
    window.__CODES__ = ${codesJson};
  </scr` + `ipt>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></scr` + `ipt>
  <script>
    window.onload = function(){
      var codes = window.__CODES__ || [];
      var cont = document.getElementById('codes-container');
      codes.forEach(function(code, idx){
        var wrap = document.createElement('div');
        wrap.className = 'item';
        var title = document.createElement('div');
        title.className = 'item-title';
        title.textContent = '×ª×—× ×” ' + (idx+1) + ' â€“ ' + code;
        var qrDiv = document.createElement('div');
        wrap.appendChild(title);
        wrap.appendChild(qrDiv);
        cont.appendChild(wrap);
        new QRCode(qrDiv, { text: code, width: 128, height: 128 });
      });
      window.focus();
      window.print();
    };
  </scr` + `ipt>
</body>
</html>`;

      w.document.open();
      w.document.write(html);
      w.document.close();
    }

    async function initGame(){
      document.getElementById("startGameBtn").onclick      = () => { visitedCodes = new Set(); showScreen("scan"); };
      document.getElementById("backToWelcomeBtn").onclick  = () => showScreen("welcome");
      document.getElementById("continueScanBtn").onclick   = () => showScreen("scan");
      document.getElementById("backToScanBtn").onclick     = () => showScreen("scan");
      document.getElementById("endExitBtn").onclick        = () => { visitedCodes = new Set(); showScreen("welcome"); };

      document.getElementById("adminOpenBtn").onclick      = openAdmin;
      document.getElementById("saveAdminBtn").onclick      = saveAdmin;
      document.getElementById("exitAdminBtn").onclick      = () => showScreen("welcome");
      document.getElementById("showBarcodesBtn").onclick   = showBarcodes;
      document.getElementById("printBarcodesBtn").onclick  = printBarcodes;

      document.getElementById("stations-number-input").onchange = (e) => {
        let num = parseInt(e.target.value,10) || 1;
        if (num < 1) num = 1;
        if (num > 30) num = 30;
        e.target.value = num;

        while(gameConfig.stations.length < num){
          const nextIndex = gameConfig.stations.length;
          gameConfig.stations.push({
            code: `BARCODE${nextIndex+1}`,
            riddle: "",
            reward: ""
          });
        }
        while(gameConfig.stations.length > num){
          gameConfig.stations.pop();
        }
        ensureBarcodeCodes();
        renderStationsEdit();
      };

      await loadConfigFromFirebase();
      updateWelcomeScreen();
      showScreen("welcome");
    }

    initGame();
  </script>
</body>
</html>
