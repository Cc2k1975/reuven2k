<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>WhatsApp Direct - Stable</title>
  <style>
    :root { --wa-green:#25D366; --wa-dark:#075E54; }
    body{
      font-family:system-ui,sans-serif;background:#f0f2f5;
      display:flex;justify-content:center;align-items:center;
      min-height:100vh;margin:0;padding:15px;
      user-select:none;-webkit-user-select:none;touch-action:manipulation;
    }
    .card{background:#fff;padding:25px;border-radius:20px;box-shadow:0 4px 20px rgba(0,0,0,.15);width:100%;max-width:400px;text-align:center;}
    .box{background:#f8f9fa;border:2px solid #eaebec;border-radius:12px;padding:15px;margin-bottom:15px;text-align:right;}
    .label{font-size:12px;color:#666;font-weight:700;}
    .field{font-size:18px;font-weight:700;color:var(--wa-dark);min-height:25px;word-break:break-all;}
    .ptt-btn{
      width:180px;height:180px;border-radius:50%;border:none;
      background:#34b7f1;color:#fff;font-size:20px;font-weight:800;
      cursor:pointer;box-shadow:0 6px 15px rgba(0,0,0,.2);
      margin:20px auto;display:block;transition:transform .1s;
      -webkit-tap-highlight-color:transparent;
    }
    .ptt-btn:active{background:#ff4b2b;transform:scale(.95);}
    .btn-paste{width:100%;padding:14px;background:#6c757d;color:#fff;border:none;border-radius:10px;font-weight:800;cursor:pointer;}
  </style>
</head>
<body>

<div class="card">
  <h2 style="color:var(--wa-dark);margin-top:0;">×“×‘×¨ ×•×©×œ×—</h2>

  <div class="box">
    <div class="label">××¡×¤×¨ ×™×¢×“:</div>
    <div id="phoneField" class="field">---</div>
  </div>

  <div class="box">
    <div class="label">×”×•×“×¢×”:</div>
    <div id="msgField" class="field" style="font-weight:normal;">---</div>
  </div>

  <button class="btn-paste" onclick="pasteFromClipboard()">ğŸ“‹ ×”×“×‘×§ ××¡×¤×¨ ××”×–×™×›×¨×•×Ÿ</button>

  <button id="pttBtn" class="ptt-btn">×œ×—×¥ ×•×”×—×–×§<br>ğŸ¤</button>

  <p id="status" style="font-size:14px;color:#888;">×××•×¨ ××¡×¤×¨ ×•××– ×”×•×“×¢×” ×•×©×—×¨×¨</p>

  <button class="btn-paste" style="background:#eee;color:#333;margin-top:10px;" onclick="location.reload()">× ×§×” ×”×›×œ</button>
</div>

<a id="waLink" href="#" style="display:none;"></a>

<script>
  let recognition = null;

  let lockedNumber = "";     // × ×©××¨ ×’× ×× ×”×ª×—×œ×ª ×”×§×œ×˜×” ×—×“×©×” (×›×“×™ ×©×”×“×‘×§×” ×œ× ×ª×™××—×§)
  let finalTranscript = "";
  let finalMsg = "";
  let isListening = false;
  let activePointerId = null;
  let restartGuard = false;

  function safeInitRecognition(){
    if (recognition) return true;

    const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!Speech){
      alert("×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘×–×™×”×•×™ ×“×™×‘×•×¨ ×‘××›×©×™×¨ ×”×–×”. × ×¡×” Chrome.");
      return false;
    }

    recognition = new Speech();
    recognition.lang = "he-IL";

    // ×‘×× ×“×¨×•××™×“ continuous ×œ× ×ª××™×“ ×™×¦×™×‘. ×¢×“×™×£ false + restart ×‘-onend ×‘×–××Ÿ ×œ×—×™×¦×”
    recognition.continuous = false;
    recognition.interimResults = true;
    recognition.maxAlternatives = 1;

    recognition.onstart = () => {
      document.getElementById("status").innerText = "××§×©×™×‘... ×©×—×¨×¨ ×œ×©×œ×™×—×”";
    };

    recognition.onerror = (e) => {
      // NotAllowed / aborted / network × ×¤×•×¦×™× â€” ×œ× ××¤×•×¦×¦×™× ×”×›×œ
      document.getElementById("status").innerText = "×©×’×™××” ×‘×–×™×”×•×™ ×“×™×‘×•×¨: " + (e.error || "");
      // ×× ×¢×“×™×™×Ÿ ×‘×œ×—×™×¦×” â€” × × ×¡×” ×œ×”××©×™×š ×‘-onend
    };

    recognition.onresult = (event) => {
      let interim = "";

      for (let i = event.resultIndex; i < event.results.length; i++) {
        const t = (event.results[i][0].transcript || "").trim();
        if (!t) continue;

        if (event.results[i].isFinal) {
          finalTranscript += (finalTranscript ? " " : "") + t;
        } else {
          interim += (interim ? " " : "") + t;
        }
      }

      const latestText = (finalTranscript + " " + interim).trim();
      processText(latestText);
    };

    recognition.onend = () => {
      // ×× ×”××©×ª××© ×¢×“×™×™×Ÿ ×œ×•×—×¥, ×”×–×™×”×•×™ ×œ×¤×¢××™× × ×¡×’×¨ ×œ×‘×“ â€” × ×¤×ª×— ××—×“×© ×‘×¦×•×¨×” ×‘×˜×•×—×”
      if (isListening){
        if (restartGuard) return;
        restartGuard = true;
        setTimeout(() => {
          restartGuard = false;
          try { recognition.start(); } catch(e) {}
        }, 80);
      }
    };

    return true;
  }

  function extractIsraeliPhone(text){
    const matches = text.match(/0[\d\s\-]{7,20}\d/g) || [];
    for (const m of matches){
      const d = m.replace(/\D/g,'');
      if (d.length === 10 && d.startsWith('05')) return d;
      if (d.length === 9 && d.startsWith('0')) return d;
    }
    const all = text.replace(/\D/g,'');
    const mm = all.match(/05\d{8}/);
    return mm ? mm[0] : "";
  }

  function processText(text){
    const phoneElem = document.getElementById("phoneField");
    const msgElem = document.getElementById("msgField");

    // × × ×¢×œ ××¡×¤×¨ ×¨×§ ×× ××™×Ÿ ×›×‘×¨ ××¡×¤×¨ × ×¢×•×œ
    if (!lockedNumber){
      const found = extractIsraeliPhone(text);
      if (found){
        lockedNumber = found;
        phoneElem.innerText = lockedNumber;
      }
    } else {
      phoneElem.innerText = lockedNumber;
    }

    let msg = text;

    if (lockedNumber){
      // ××¡×™×¨ ××ª ×”××¡×¤×¨ ××”×˜×§×¡×˜ ×’× ×× × ×××¨ ×¢× ×¨×•×•×—×™×/××§×¤×™×
      const loose = new RegExp(lockedNumber.split('').join('\\D*'), 'g');
      msg = msg.replace(loose, " ");
    }

    // ××¡×™×¨ ×¡×¤×¨×•×ª (×›×“×™ ×©×œ× â€œ×™×ª×¢×¨×‘×‘×•â€ ×¡×¤×¨×•×ª ×©×œ ××¡×¤×¨×™× ×‘×”×•×“×¢×”)
    msg = msg.replace(/\d+/g, " ");
    msg = msg.replace(/\s+/g, " ").trim();

    msgElem.innerText = msg || "---";
    finalMsg = msg;
  }

  function startListening(){
    if (!safeInitRecognition()) return;

    // ×œ× ×××¤×¡ lockedNumber ×›×“×™ ×©×”×“×‘×§×” ×ª×™×©××¨
    finalTranscript = "";
    finalMsg = "";
    isListening = true;

    // ×××¤×¡ ×¨×§ ×”×•×“×¢×”
    document.getElementById("msgField").innerText = "---";
    document.getElementById("status").innerText = "××§×©×™×‘... ×©×—×¨×¨ ×œ×©×œ×™×—×”";

    try { recognition.start(); } catch(e) {}
  }

  function stopAndSendImmediately(){
    if (!recognition || !isListening) return;

    isListening = false;

    // stop ×××¤×©×¨ ×œ×ª×•×¦××•×ª ×”××—×¨×•× ×•×ª â€œ×œ×”×™×¡×’×¨â€ ×‘×œ×™ ×œ××—×•×§
    try { recognition.stop(); } catch(e) {}

    const num = (lockedNumber || "").replace(/\D/g,'');
    if (!(num.length === 10 && num.startsWith('05')) && !(num.length === 9 && num.startsWith('0'))){
      document.getElementById("status").innerText = "×œ× ×–×•×”×” ××¡×¤×¨ × ×™×™×“ ×ª×§×™×Ÿ";
      return;
    }

    const cleanNum = num.startsWith('0') ? ('972' + num.substring(1)) : num;
    const text = encodeURIComponent(finalMsg || "");

    const schemeUrl = `whatsapp://send?phone=${cleanNum}&text=${text}`;
    const webUrl = `https://wa.me/${cleanNum}?text=${text}`;

    document.getElementById("status").innerText = "×¤×•×ª×— ×•×•××˜×¡××¤...";

    // × ×™×¡×™×•×Ÿ ×œ×¤×ª×•×— ××¤×œ×™×§×¦×™×”
    const a = document.getElementById("waLink");
    a.href = schemeUrl;
    a.click();

    // × ×¤×™×œ×” ×œ×“×¤×“×¤×Ÿ -> ××¤×œ×™×§×¦×™×”
    window.location.assign(webUrl);
  }

  const btn = document.getElementById("pttBtn");

  // Pointer Events = ××•× ×¢ ×›×¤×™×œ×•×™×•×ª touch/mouse
  btn.addEventListener("pointerdown", (e) => {
    e.preventDefault();
    if (activePointerId !== null) return;
    activePointerId = e.pointerId;
    btn.setPointerCapture?.(e.pointerId);
    startListening();
  }, { passive:false });

  btn.addEventListener("pointerup", (e) => {
    e.preventDefault();
    if (activePointerId !== e.pointerId) return;
    activePointerId = null;
    stopAndSendImmediately();
  }, { passive:false });

  btn.addEventListener("pointercancel", (e) => {
    e.preventDefault();
    if (activePointerId !== e.pointerId) return;
    activePointerId = null;
    // ×‘×™×˜×•×œ ×‘×œ×™ ×©×œ×™×—×”
    isListening = false;
    try { recognition.stop(); } catch(err) {}
    document.getElementById("status").innerText = "×‘×•×˜×œ";
  }, { passive:false });

  async function pasteFromClipboard(){
    try{
      const text = await navigator.clipboard.readText();
      const digits = (text || "").replace(/\D/g,'');
      if (digits.length === 10 && digits.startsWith("05")){
        lockedNumber = digits;
        document.getElementById("phoneField").innerText = lockedNumber;
        document.getElementById("status").innerText = "××¡×¤×¨ ×”×•×“×‘×§. ×¢×›×©×™×• ×œ×—×¥ ×•×”×—×–×§ ×•×“×‘×¨ ×”×•×“×¢×”.";
      } else {
        alert("×œ× ×–×•×”×” ××¡×¤×¨ × ×™×™×“ ×ª×§×™×Ÿ ×‘×œ×•×—");
      }
    } catch(e){
      alert("××©×¨ ×’×™×©×” ×œ×œ×•×—");
    }
  }

  window.oncontextmenu = (e)=>{ e.preventDefault(); return false; };
</script>

</body>
</html>
