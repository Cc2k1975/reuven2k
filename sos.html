<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SOS Video</title>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

<style>
  *{margin:0;padding:0;box-sizing:border-box;}
  html,body{
    width:100%;
    height:100%;
    font-family:Heebo,Arial,sans-serif;
    background:#111;
    color:#fff;
  }
  body{
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
  }

  .wrapper{
    width:100%;
    max-width:500px;
    padding:16px;
    text-align:center;
  }

  h1{
    font-size:24px;
    margin-bottom:10px;
  }
  p{
    font-size:14px;
    margin-bottom:14px;
    color:#ccc;
  }

  #sosBtn{
    width:220px;
    height:220px;
    border-radius:50%;
    background:#d50000;
    border:none;
    color:#fff;
    font-size:42px;
    font-weight:bold;
    box-shadow:0 0 35px rgba(0,0,0,0.7);
    cursor:pointer;
    margin:20px auto;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  #sosBtn.in-call{
    background:#f57c00;
  }

  #statusText{
    margin-top:10px;
    font-size:15px;
    color:#ffeb3b;
    min-height:22px;
  }

  /* LIVE overlay */
  #liveOverlay{
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:#000;
    display:none;
    flex-direction:column;
    z-index:100;
  }

  #liveMain{
    flex:1;
    display:flex;
    flex-direction:row;
    height:100%;
  }

  /* פאנל משתמשים */
  #usersPanel{
    width:160px;
    min-width:120px;
    background:#181818;
    border-left:1px solid #333;
    padding:10px;
    font-size:14px;
  }
  #usersPanel h3{
    margin-bottom:8px;
    font-size:16px;
  }
  #usersList{
    list-style:none;
  }
  #usersList li{
    margin-bottom:6px;
  }
  .user-name{
    font-weight:bold;
  }
  .user-status{
    font-size:12px;
  }
  .online{
    color:#4caf50;
  }
  .offline{
    color:#b0bec5;
  }

  /* אזור הווידאו הראשי */
  #videoArea{
    flex:1;
    position:relative;
    background:#000;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
  }

  #remoteVideo{
    width:100%;
    height:100%;
    object-fit:cover;
    background:#000;
  }

  #localVideo{
    position:absolute;
    bottom:10px;
    right:10px;
    width:25%;
    max-width:220px;
    aspect-ratio:16/9;
    border-radius:10px;
    border:2px solid #fff;
    box-shadow:0 0 10px rgba(0,0,0,0.7);
    object-fit:cover;
    background:#000;
  }

  #liveControls{
    padding:8px;
    text-align:center;
    border-top:1px solid #333;
    background:#111;
  }
  #endBtn{
    padding:10px 18px;
    border:none;
    border-radius:8px;
    background:#f44336;
    color:#fff;
    font-size:16px;
    cursor:pointer;
  }

  /* שיחה נכנסת */
  #incomingCall{
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.7);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:110;
  }
  #incomingBox{
    background:#222;
    padding:20px;
    border-radius:14px;
    width:80%;
    max-width:320px;
    text-align:center;
    box-shadow:0 0 25px rgba(0,0,0,0.7);
  }
  #incomingBox h3{
    margin-top:0;
    margin-bottom:10px;
  }
  .incoming-btn{
    padding:8px 14px;
    margin:0 6px;
    border:none;
    border-radius:8px;
    cursor:pointer;
    font-size:14px;
    color:#fff;
  }
  #acceptBtn{background:#4caf50;}
  #rejectBtn{background:#f44336;}

  @media (max-width:700px){
    #liveMain{
      flex-direction:column;
    }
    #usersPanel{
      width:100%;
      min-width:100%;
      border-left:none;
      border-bottom:1px solid #333;
    }
  }
</style>
</head>
<body>

<div class="wrapper">
  <h1>SOS Video</h1>
  <p>כל מי שנכנס לדף מחובר. לוחצים SOS כדי להתחיל שיחת וידאו.</p>

  <button id="sosBtn">SOS</button>
  <div id="statusText"></div>
</div>

<!-- שכבת הווידאו -->
<div id="liveOverlay">
  <div id="liveMain">
    <!-- וידאו -->
    <div id="videoArea">
      <video id="remoteVideo" autoplay playsinline></video>
      <video id="localVideo" autoplay playsinline muted></video>
    </div>

    <!-- רשימת משתתפים -->
    <div id="usersPanel">
      <h3>משתתפים</h3>
      <ul id="usersList">
        <li>טוען...</li>
      </ul>
    </div>
  </div>

  <div id="liveControls">
    <button id="endBtn" onclick="endCall()">סיום שיחה</button>
  </div>
</div>

<!-- שיחת SOS נכנסת -->
<div id="incomingCall">
  <div id="incomingBox">
    <h3>שיחת SOS נכנסת</h3>
    <p>לאשר חיבור וידאו?</p>
    <button class="incoming-btn" id="acceptBtn" onclick="acceptCall()">אישור</button>
    <button class="incoming-btn" id="rejectBtn" onclick="rejectCall()">דחייה</button>
  </div>
</div>

<script>
/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyBPD1nZQVAdqSP4uS05TYXBeGtJKsjapA",
  authDomain: "private-chat-b3a36.firebaseapp.com",
  databaseURL: "https://private-chat-b3a36-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "private-chat-b3a36",
  storageBucket: "private-chat-b3a36.firebasestorage.app",
  messagingSenderId: "88424262632",
  appId: "1:88424262632:web:a38edf362b59703011525d",
  measurementId: "G-M9SGLXN3TV"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* מזהה ייחודי לכל מכשיר */
let clientId = localStorage.getItem("sosClientId");
if (!clientId) {
  clientId = "u_" + Math.random().toString(36).substr(2,8);
  localStorage.setItem("sosClientId", clientId);
}

/* מצב כללי */
let pc = null;
let localStream = null;
let inCall = false;
let isCaller = false;
let remoteCandidatesRef = null;

const sosBtn = document.getElementById("sosBtn");
const statusText = document.getElementById("statusText");
const usersListEl = document.getElementById("usersList");

const servers = {
  iceServers: [
    { urls: "stun:stun.l.google.com:19302" }
  ]
};

/* רינגטון + רטט */
let audioCtx = null;
let ringInterval = null;

function startRingtone() {
  try {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    } else if (audioCtx.state === "suspended") {
      audioCtx.resume();
    }
  } catch (e) {
    console.warn("AudioContext error:", e);
    return;
  }

  const playBeep = () => {
    if (!audioCtx) return;
    const duration = 0.4;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = "sine";
    osc.frequency.value = 900;

    osc.connect(gain);
    gain.connect(audioCtx.destination);

    const now = audioCtx.currentTime;
    gain.gain.setValueAtTime(0, now);
    gain.gain.linearRampToValueAtTime(0.3, now + 0.05);
    gain.gain.linearRampToValueAtTime(0, now + duration);

    osc.start(now);
    osc.stop(now + duration);
  };

  if (!ringInterval) {
    playBeep();
    ringInterval = setInterval(playBeep, 800);
  }

  if (navigator.vibrate) {
    navigator.vibrate([300, 200, 300, 200]);
  }
}

function stopRingtone() {
  if (ringInterval) {
    clearInterval(ringInterval);
    ringInterval = null;
  }
  if (navigator.vibrate) {
    navigator.vibrate(0);
  }
}

/* נוכחות */
function setPresenceOnline() {
  db.ref("sosPresence/" + clientId).set({
    status: "online",
    ts: firebase.database.ServerValue.TIMESTAMP
  });
  db.ref("sosPresence/" + clientId).onDisconnect().set({
    status: "offline",
    ts: firebase.database.ServerValue.TIMESTAMP
  });
}

function setPresenceOffline() {
  db.ref("sosPresence/" + clientId).set({
    status: "offline",
    ts: firebase.database.ServerValue.TIMESTAMP
  });
}

function listenPresence() {
  db.ref("sosPresence").on("value", snap => {
    const data = snap.val() || {};
    usersListEl.innerHTML = "";
    const entries = Object.entries(data).filter(([id, val]) => val.status === "online");

    if (entries.length === 0) {
      usersListEl.innerHTML = "<li>אף אחד לא מחובר</li>";
      return;
    }

    let index = 1;
    entries.forEach(([id, val]) => {
      const li = document.createElement("li");
      const isMe = (id === clientId);
      const name = isMe ? "אני" : ("משתתף " + index++);
      li.innerHTML =
        '<span class="user-name">' + name + '</span><br>' +
        '<span class="user-status online">מחובר</span>';
      usersListEl.appendChild(li);
    });
  });
}

/* PeerConnection + מצלמה */
async function setupPeerConnection(asCaller) {
  isCaller = asCaller;
  pc = new RTCPeerConnection(servers);

  pc.onicecandidate = event => {
    if (event.candidate) {
      const roleKey = asCaller ? "caller" : "callee";
      db.ref("sosCall/candidates/" + roleKey).push(event.candidate.toJSON());
    }
  };

  pc.oniceconnectionstatechange = () => {
    statusText.textContent = "מצב חיבור: " + pc.iceConnectionState;
  };

  pc.ontrack = event => {
    const remoteVideo = document.getElementById("remoteVideo");
    if (remoteVideo.srcObject !== event.streams[0]) {
      remoteVideo.srcObject = event.streams[0];
      remoteVideo.play().catch(e => console.log("remote play error", e));
    }
  };

  try {
    localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
  } catch (err) {
    alert("שגיאה בגישה למצלמה/מיקרופון: " + err.message);
    throw err;
  }

  const localVideo = document.getElementById("localVideo");
  localVideo.srcObject = localStream;
  localVideo.play().catch(e => console.log("local play error", e));

  localStream.getTracks().forEach(track => {
    pc.addTrack(track, localStream);
  });

  inCall = true;

  const remoteKey = asCaller ? "callee" : "caller";
  remoteCandidatesRef = db.ref("sosCall/candidates/" + remoteKey);
  remoteCandidatesRef.on("child_added", async snap => {
    const cand = snap.val();
    if (pc && cand) {
      try {
        await pc.addIceCandidate(new RTCIceCandidate(cand));
      } catch (e) {
        console.error("addIceCandidate error", e);
      }
    }
  });
}

/* התחלת שיחה כמתקשר */
async function startCall() {
  statusText.textContent = "מתחיל שיחת SOS...";
  sosBtn.classList.add("in-call");

  await db.ref("sosCall").set(null);

  await setupPeerConnection(true);

  try {
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    await db.ref("sosCall/offer").set(offer);
    await db.ref("sosCall").update({
      state: "calling",
      from: clientId
    });
    statusText.textContent = "ממתין לצד השני...";
    showLiveOverlay();
  } catch (err) {
    console.error(err);
    alert("שגיאה ביצירת שיחה: " + err.message);
    endCall(true);
  }
}

/* האזנה לשיחה ב-Firebase */
function listenForCall() {
  db.ref("sosCall").on("value", async snap => {
    const data = snap.val();
    if (!data) {
      hideIncoming();
      hideLiveOverlay();
      statusText.textContent = "";
      sosBtn.classList.remove("in-call");
      stopRingtone();
      return;
    }

    const state = data.state;
    const from = data.from || null;

    if (state === "calling" && from && from !== clientId && !inCall) {
      showIncoming();
      statusText.textContent = "שיחת SOS נכנסת...";
      startRingtone();
    }

    if (state === "ended") {
      endCall(true);
      statusText.textContent = "השיחה הסתיימה.";
      stopRingtone();
    }
  });

  db.ref("sosCall/answer").on("value", async snap => {
    const answer = snap.val();
    if (!answer || !pc || !isCaller) return;
    if (!pc.currentRemoteDescription) {
      try {
        await pc.setRemoteDescription(new RTCSessionDescription(answer));
      } catch (err) {
        console.error("setRemoteDescription(answer) error", err);
      }
    }
  });
}

/* מענה לשיחת SOS נכנסת */
async function acceptCall() {
  hideIncoming();
  stopRingtone();
  statusText.textContent = "מחבר וידאו...";
  sosBtn.classList.add("in-call");

  try {
    await setupPeerConnection(false);

    const offerSnap = await db.ref("sosCall/offer").once("value");
    const offer = offerSnap.val();
    if (!offer) {
      alert("אין הצעת שיחה זמינה.");
      return;
    }

    await pc.setRemoteDescription(new RTCSessionDescription(offer));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    await db.ref("sosCall/answer").set(answer);
    await db.ref("sosCall/state").set("accepted");

    showLiveOverlay();
    statusText.textContent = "שיחת SOS פעילה.";
  } catch (err) {
    console.error(err);
    alert("שגיאה במענה לשיחה: " + err.message);
    endCall(true);
  }
}

/* דחיית שיחה נכנסת */
async function rejectCall() {
  hideIncoming();
  stopRingtone();
  await db.ref("sosCall/state").set("ended");
}

/* סיום שיחה */
async function endCall(forceOnlyLocal=false) {
  stopRingtone();

  if (localStream) {
    localStream.getTracks().forEach(t => t.stop());
    localStream = null;
  }
  if (pc) {
    pc.close();
    pc = null;
  }
  if (remoteCandidatesRef) {
    remoteCandidatesRef.off();
    remoteCandidatesRef = null;
  }
  inCall = false;
  sosBtn.classList.remove("in-call");
  hideLiveOverlay();

  if (!forceOnlyLocal) {
    await db.ref("sosCall").set({ state:"ended" });
  }
}

/* לחיצה על SOS */
sosBtn.addEventListener("click", () => {
  if (!inCall) {
    startCall();
  } else {
    endCall();
  }
});

/* הצגת/הסתרת שכבות */
function showLiveOverlay() {
  document.getElementById("liveOverlay").style.display = "flex";
}
function hideLiveOverlay() {
  document.getElementById("liveOverlay").style.display = "none";
}
function showIncoming() {
  document.getElementById("incomingCall").style.display = "flex";
}
function hideIncoming() {
  document.getElementById("incomingCall").style.display = "none";
}

/* אתחול */
window.addEventListener("load", () => {
  setPresenceOnline();
  listenPresence();
  listenForCall();
});

/* לפני סגירת הדף – ניקוי */
window.addEventListener("beforeunload", () => {
  if (inCall) {
    endCall(true);
  } else {
    stopRingtone();
  }
  setPresenceOffline();
});
</script>

</body>
</html>
