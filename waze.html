<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waze Instant Commander</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: Arial, sans-serif;
            text-align: center;
        }

        #micBtn {
            width: 70vw;
            height: 70vw;
            max-width: 350px;
            max-height: 350px;
            border-radius: 50%;
            border: none;
            background-color: #33ccff;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            -webkit-tap-highlight-color: transparent;
        }

        #micBtn:active { transform: scale(0.95); }

        #icon { font-size: 4rem; margin-bottom: 10px; }

        #statusText {
            margin-top: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            min-height: 30px;
        }

        #debugText {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #666;
            background: #e0e0e0;
            padding: 5px 10px;
            border-radius: 5px;
            display: none;
        }

        .listening {
            background-color: #ff4444 !important;
            animation: pulse 1.0s infinite; /* אנימציה מהירה יותר */
        }

        .success { background-color: #00C853 !important; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(255, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0); }
        }
    </style>
</head>
<body>

    <button id="micBtn" onclick="startListening()">
        <div id="icon">⚡</div> <div id="btnText">לחץ ודבר</div>
    </button>

    <div id="statusText">המערכת מוכנה</div>
    <div id="debugText"></div>

    <script>
        // ==========================================
        //         איזור עריכת המקומות
        // ==========================================
        const locations = {
            "הביתה": "https://waze.com/ul?q=Home", 
            "בית": "https://waze.com/ul?q=Home", 
            "עבודה": "https://waze.com/ul?q=Work",
            "סופר": "https://waze.com/ul?q=Supermarket",
        };
        // ==========================================

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const micBtn = document.getElementById("micBtn");
        const btnText = document.getElementById("btnText");
        const statusText = document.getElementById("statusText");
        const debugText = document.getElementById("debugText");
        let recognition;
        let isRedirecting = false; // למנוע הפעלה כפולה

        function startListening() {
            if (!SpeechRecognition) {
                alert("הדפדפן לא תומך. נסה Chrome באנדרואיד.");
                return;
            }
            
            if (isRedirecting) return; // אם כבר עוברים עמוד, לא לעשות כלום

            recognition = new SpeechRecognition();
            recognition.lang = 'he-IL';
            
            // --- השינוי הגדול: מקשיב לתוצאות ביניים ---
            recognition.interimResults = true; 
            recognition.maxAlternatives = 1;

            recognition.start();

            micBtn.className = "listening";
            btnText.innerText = "מקשיב...";
            statusText.innerText = "דבר...";
            debugText.style.display = "none";

            recognition.onresult = (event) => {
                // לוקח את כל מה שנאמר עד עכשיו, כולל חלקי משפטים
                let transcript = Array.from(event.results)
                    .map(result => result[0].transcript)
                    .join('');

                debugText.style.display = "block";
                debugText.innerText = `מזהה: "${transcript}"`;

                // בדיקה מיידית מול הרשימה
                for (let key in locations) {
                    if (transcript.includes(key)) {
                        // ברגע שמצאנו התאמה - עוצרים הכל ומפעילים!
                        recognition.stop();
                        triggerAction(key, locations[key]);
                        return; // יוצאים מהפונקציה
                    }
                }
            };

            recognition.onspeechend = () => {
                // אם הפסקת לדבר ולא זיהינו כלום
                if (!isRedirecting) {
                    recognition.stop();
                    micBtn.className = "";
                    btnText.innerText = "לחץ ודבר";
                }
            };

            recognition.onerror = (event) => {
                if (event.error === 'no-speech') return; // מתעלם אם לא דיברו
                micBtn.className = "";
                btnText.innerText = "שגיאה";
                statusText.innerText = "שגיאה: " + event.error;
            };
        }

        function triggerAction(name, url) {
            if (isRedirecting) return;
            isRedirecting = true;

            micBtn.className = "success";
            btnText.innerText = "בוצע!";
            statusText.innerText = `נוסעים ל: ${name}`;
            
            // ביטול ההשהייה הארוכה - מעבר מיידי (חצי שנייה בשביל האנימציה)
            setTimeout(() => {
                window.location.href = url;
            }, 500);
        }
    </script>
</body>
</html>
