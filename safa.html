<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מזהה שפות מקצועי</title>
    <style>
        :root {
            --primary: #6c5ce7;
            --secondary: #a29bfe;
            --bg: #dfe6e9;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg);
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0;
            overflow: hidden;
        }

        /* הגדרות כפתור ענק */
        .big-button {
            width: 220px;
            height: 220px;
            border-radius: 50%;
            background: white;
            border: 8px solid var(--primary);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .big-button:active {
            transform: scale(0.95);
        }

        /* אנימציה בזמן הקלטה */
        .big-button.recording {
            background: #ff7675;
            border-color: #d63031;
            color: white;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 118, 117, 0.7); }
            70% { box-shadow: 0 0 0 40px rgba(255, 118, 117, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 118, 117, 0); }
        }

        /* תוצאות */
        .result-box {
            margin-top: 40px;
            text-align: center;
            min-height: 120px;
        }

        .lang-result {
            font-size: 3.5rem;
            font-weight: 800;
            color: #2d3436;
            margin: 10px 0;
        }

        .status-text {
            color: #636e72;
            font-size: 1.1rem;
        }

        /* הגדרות API Key */
        .api-setup {
            position: absolute;
            bottom: 20px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            background: rgba(255,255,255,0.8);
            padding: 15px;
            border-radius: 10px;
        }
        
        input[type="password"] {
            padding: 8px;
            width: 70%;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: center;
        }
        
        .save-btn {
            padding: 8px 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="result-box">
        <div id="status" class="status-text">לחץ על הכפתור והתחל לדבר</div>
        <div id="languageOutput" class="lang-result">?</div>
    </div>

    <button id="mainBtn" class="big-button" onclick="startProcess()">
        <span>הקש להקלטה</span>
        <span style="font-size:0.8rem; margin-top:5px">(2 שניות)</span>
    </button>

    <div class="api-setup" id="apiBox">
        <p style="margin:0 0 10px 0; font-size:0.9rem;">הכנס מפתח OpenAI API:</p>
        <input type="password" id="apiKeyInput" placeholder="sk-..." />
        <button class="save-btn" onclick="saveKey()">שמור</button>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        const btn = document.getElementById('mainBtn');
        const statusDiv = document.getElementById('status');
        const langDiv = document.getElementById('languageOutput');
        const apiBox = document.getElementById('apiBox');
        
        // מילון תרגום קודי שפה לשמות מלאים בעברית
        const langMap = {
            'en': 'אנגלית', 'he': 'עברית', 'iw': 'עברית',
            'ar': 'ערבית', 'ru': 'רוסית', 'es': 'ספרדית',
            'fr': 'צרפתית', 'de': 'גרמנית', 'it': 'איטלקית',
            'pt': 'פורטוגזית', 'ja': 'יפנית', 'zh': 'סינית',
            'tr': 'טורקית', 'hi': 'הינדי', 'nl': 'הולנדית'
        };

        // בדיקה אם יש מפתח שמור
        if (localStorage.getItem('openai_key')) {
            apiBox.classList.add('hidden');
        }

        function saveKey() {
            const key = document.getElementById('apiKeyInput').value;
            if (key.startsWith('sk-')) {
                localStorage.setItem('openai_key', key);
                apiBox.classList.add('hidden');
                alert('המפתח נשמר בהצלחה!');
            } else {
                alert('מפתח לא תקין. הוא אמור להתחיל ב-sk-');
            }
        }

        async function startProcess() {
            const apiKey = localStorage.getItem('openai_key');
            if (!apiKey) {
                alert('חובה להזין מפתח API למטה כדי שהזיהוי יעבוד!');
                return;
            }

            // איפוס
            audioChunks = [];
            langDiv.textContent = "...";
            statusDiv.textContent = "מקליט (2 שניות)...";
            btn.classList.add('recording');
            btn.innerHTML = "מקשיב...";

            try {
                // בקשת גישה למיקרופון
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);

                mediaRecorder.start();

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    btn.classList.remove('recording');
                    btn.innerHTML = "<span>הקש להקלטה</span><span style='font-size:0.8rem'>(2 שניות)</span>";
                    statusDiv.textContent = "מנתח שפה...";
                    
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' }); // או mp4
                    await sendToAI(audioBlob, apiKey);
                };

                // טיימר של 2 שניות בדיוק
                setTimeout(() => {
                    if (mediaRecorder.state === "recording") {
                        mediaRecorder.stop();
                    }
                }, 2000); // 2000 מילישניות = 2 שניות

            } catch (err) {
                console.error(err);
                alert("לא הצלחתי לגשת למיקרופון. וודא שנתת הרשאה.");
                btn.classList.remove('recording');
            }
        }

        async function sendToAI(audioBlob, key) {
            const formData = new FormData();
            formData.append("file", audioBlob, "recording.webm");
            formData.append("model", "whisper-1");
            formData.append("response_format", "verbose_json"); // חשוב כדי לקבל את פרטי השפה

            try {
                const response = await fetch("https://api.openai.com/v1/audio/transcriptions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${key}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error("שגיאה בחיבור לשרת (בדוק את המפתח שלך)");
                }

                const data = await response.json();
                
                // שליפת השפה
                const detectedCode = data.language;
                const detectedName = langMap[detectedCode] || detectedCode; // תרגום לעברית אם קיים

                // הצגה
                langDiv.textContent = detectedName;
                statusDiv.textContent = `הטקסט שזוהה: "${data.text}"`;

            } catch (error) {
                statusDiv.textContent = "שגיאה בזיהוי";
                alert(error.message);
            }
        }
    </script>
</body>
</html>
