<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>מפקד ציוד — מותאם לנייד + צפצוף</title>

<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;600;800&display=swap" rel="stylesheet">

<!-- QuaggaJS (סריקה מהמצלמה) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<!-- SheetJS for XLSX export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  :root{
    --bg:#f0fcff;
    --card:#ffffff;
    --ink:#06323a;
    --muted:#556b75;
    --accent:#0ea5a4;
    --danger:#dc2626;
    --radius:12px;
    --touch-size:52px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Heebo, system-ui, Arial, Roboto, "Segoe UI", sans-serif;
    background:linear-gradient(180deg,var(--bg),#f6feff);
    color:var(--ink);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  .page{max-width:1100px;margin:0 auto;padding:12px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
  h1{font-size:22px;margin:0;text-align:center;flex:1}
  .top-actions{display:flex;gap:8px;align-items:center}

  .wrap{display:flex;gap:12px;align-items:flex-start}
  .sidebar{
    width:300px;flex:0 0 300px;
    background:var(--card);border-radius:var(--radius);padding:12px;border:1px solid rgba(6,50,58,0.06);
    box-shadow:0 6px 20px rgba(2,6,23,0.06);
  }
  .main{flex:1}

  .card{background:var(--card);border-radius:var(--radius);padding:12px;margin-bottom:12px;border:1px solid rgba(6,50,58,0.06)}
  label{display:block;color:var(--muted);font-size:13px;margin-bottom:8px}
  input[type="text"], input[type="search"]{
    width:100%;padding:12px;border-radius:10px;border:1px solid rgba(6,50,58,0.08);font-size:16px;background:#fff
  }
  button{
    border:0;border-radius:10px;padding:10px 12px;font-weight:800;cursor:pointer;
    min-height:40px;
  }

  .btn-accent{background:var(--accent);color:#fff}
  .btn-export{background:#0b77b8;color:#fff}
  .btn-muted{background:#eef7f7;color:var(--muted);border:1px solid rgba(6,50,58,0.04)}
  .btn-danger{background:var(--danger);color:#fff}

  .indicator{padding:10px;border-radius:10px;background:#f8feff;border:1px solid rgba(6,50,58,0.03);margin-bottom:10px}
  .indicator .title{font-size:13px;color:var(--muted)}
  .indicator .val{font-size:20px;font-weight:800;color:var(--accent);margin-top:6px}

  .groups-container{display:flex;flex-direction:column;gap:10px}
  .group{background:linear-gradient(180deg,#fff,#fbfeff);border-radius:10px;padding:10px;border:1px solid rgba(6,50,58,0.04)}
  .group-header{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .items{display:flex;flex-direction:column;gap:6px;margin-top:8px}
  .item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:#f6feff;border:1px solid rgba(6,50,58,0.03)}
  .small{font-size:13px;color:var(--muted)}

  #cameraModal{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:60}
  #cameraModal .modalCard{width:100%;height:100%;border-radius:0;padding:12px;display:flex;flex-direction:column}
  #scanner{flex:1;background:#000;border-radius:8px;overflow:hidden}

  @media (max-width:900px){
    .wrap{flex-direction:column}
    .sidebar{width:100%;order:0}
    .main{order:1}
    header{align-items:center}
    h1{font-size:20px}
    button{min-height:var(--touch-size);font-size:16px;padding:12px 14px}
    input[type="text"], input[type="search"]{font-size:16px;padding:14px}
  }

  .sidebar.collapsed{display:none}
  .sidebar-toggle{display:none}
  @media (max-width:540px){
    .sidebar{display:none}
    .sidebar-toggle{display:inline-block;background:transparent;border:0;color:var(--accent);font-weight:800}
    .top-actions{gap:6px}
  }

  .row{display:flex;gap:8px;flex-wrap:wrap}
  .row > *{flex:1}
</style>
</head>
<body>
  <div class="page">
    <header>
      <button id="toggleSidebar" class="sidebar-toggle">הצג מידע</button>
      <h1>מפקד ציוד</h1>
      <div class="top-actions">
        <button id="btnExportTop" class="btn-export">ייצא</button>
        <button id="btnClearAll" class="btn-danger">נקה נתונים</button>
      </div>
    </header>

    <div class="wrap">
      <aside id="sidebar" class="sidebar" role="complementary" aria-label="מידע עובד">
        <div style="display:flex;flex-direction:column;gap:10px">
          <div>
            <label for="searchEmployee">חפש עובד לפי תעודת זהות או שם</label>
            <input id="searchEmployee" type="search" placeholder="הקלד ת.ז. או שם" />
          </div>

          <div class="indicator">
            <div class="title">מספר זהות העובד</div>
            <div class="val" id="currentEmployeeDisplay">אין</div>
          </div>

          <div class="indicator">
            <div class="title">אינוונטר אחרון שנסרק</div>
            <div class="val" id="lastInvDisplay">אין</div>
          </div>

          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="btnClearLocal" class="btn-muted">מחק שמירת מקומית</button>
            <button id="btnAutoSaveToggle" class="btn-muted">כיבוי שמירה אוטומטית</button>
          </div>

          <div class="small" style="margin-top:6px;color:var(--muted)">חלון זה מופרד מהאזור הראשי של הסריקה כדי למנוע בלבול וניתן להסתירו בטלפון.</div>
        </div>
      </aside>

      <main class="main" role="main">
        <section class="card" aria-labelledby="employee-heading">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <div style="flex:1;min-width:160px">
              <label for="employeeInput">סריקת תג עובד / הקלד מספר זהות</label>
              <div class="row">
                <input id="employeeInput" type="text" placeholder="סרוק תג עובד או הקלד ת.ז." />
                <button id="btnAddEmployee" class="btn-accent">הוסף תג עובד</button>
                <button id="btnClearEmployee" class="btn-muted">נקה</button>
              </div>
              <div style="margin-top:8px" class="row">
                <input id="employeeNameInput" type="text" placeholder="(אופציונלי) שם עובד להצגה ברשימה" />
                <button id="btnSaveName" class="btn-muted">שמור שם</button>
              </div>
            </div>

            <div style="width:200px">
              <div class="indicator"><div class="title">מצב שמירה</div><div class="val" id="autoSaveStatus">מופעלת</div></div>
            </div>
          </div>
        </section>

        <section class="card" aria-labelledby="inv-heading">
          <label for="invInput">סריקת מספר אינבנטור / הקלד מספר אינבנטור</label>
          <div class="row">
            <input id="invInput" type="text" placeholder="סרוק ברקוד או הקלד קוד" />
            <button id="btnAddInv" class="btn-accent">הוסף אינוונטר</button>
            <button id="btnManualInv" class="btn-muted">הוספה ידנית</button>
            <button id="btnCameraInv" class="btn-muted">סריקה מצלמה</button>
          </div>
          <div class="small" style="margin-top:8px;color:var(--muted)">סריקה מהמצלמה (אינוונטר) תקלט פריט אוטומטית כל 5 שניות.</div>
        </section>

        <section id="listSection" class="card" aria-labelledby="list-heading">
          <h3 id="list-heading" style="margin:0 0 10px 0">אינוונטר לעובד</h3>
          <div id="groupsContainer" class="groups-container"></div>
        </section>
      </main>
    </div>

    <div id="cameraModal">
      <div class="modalCard card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <h3 style="margin:0">סריקת ברקוד (מצלמה)</h3>
          <div style="display:flex;gap:8px">
            <button id="stopScanner" class="btn-muted">עצור</button>
            <button id="closeCamera" class="btn-muted">סגור</button>
          </div>
        </div>
        <div id="scanner" style="margin-top:12px"></div>
        <div style="margin-top:8px;color:var(--muted)" class="small">אם זו סריקת עובד — מזהה פעם אחת ועוצרת. אם זו סריקת אינוונטר — ממשיכה ומוסיפה קוד כל 5 שניות.</div>
      </div>
    </div>

    <footer style="text-align:center;color:var(--muted);font-size:13px;margin-top:10px">גרסה מותאמת סלולר — שמירה בדפדפן וייצוא ל-Excel. צפצוף ורטט בעת הוספה.</footer>
  </div>

<script>
/* גרסה עם צפצוף + רטט */
const STORAGE_KEY = 'mifkad_advanced_v2_mobile_beep';

const toggleSidebarBtn = document.getElementById('toggleSidebar');
const sidebar = document.getElementById('sidebar');

const searchEmployee = document.getElementById('searchEmployee');
const currentEmployeeDisplay = document.getElementById('currentEmployeeDisplay');
const lastInvDisplay = document.getElementById('lastInvDisplay');
const btnClearLocal = document.getElementById('btnClearLocal');
const btnAutoSaveToggle = document.getElementById('btnAutoSaveToggle');
const autoSaveStatusEl = document.getElementById('autoSaveStatus') || { textContent: 'מופעלת' };

const employeeInput = document.getElementById('employeeInput');
const btnAddEmployee = document.getElementById('btnAddEmployee');
const btnClearEmployee = document.getElementById('btnClearEmployee');
const employeeNameInput = document.getElementById('employeeNameInput');
const btnSaveName = document.getElementById('btnSaveName');

const invInput = document.getElementById('invInput');
const btnAddInv = document.getElementById('btnAddInv');
const btnManualInv = document.getElementById('btnManualInv');
const btnCameraInv = document.getElementById('btnCameraInv');

const groupsContainer = document.getElementById('groupsContainer');
const btnExportTop = document.getElementById('btnExportTop');

const cameraModal = document.getElementById('cameraModal');
const scannerDiv = document.getElementById('scanner');
const stopScanner = document.getElementById('stopScanner');
const closeCamera = document.getElementById('closeCamera');

let groups = [];
let currentEmployee = null;
let lastInv = null;
let autoSave = true;
let quaggaActive = false;
let quaggaCallbackTarget = null;
let lastProcessedInvTime = 0;

// --- Audio setup (Web Audio API) ---
let audioCtx = null;
function ensureAudioContext(){
  if(!audioCtx){
    try{
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }catch(e){
      console.warn('AudioContext not available', e);
      audioCtx = null;
    }
  }
}
// create a short beep tone
function playBeep({frequency=1200, duration=120, volume=0.15} = {}){
  ensureAudioContext();
  if(!audioCtx) return;
  // resume if suspended (required on mobile browsers after user gesture)
  if(audioCtx.state === 'suspended' && typeof audioCtx.resume === 'function'){
    audioCtx.resume().catch(()=>{/* ignore */});
  }
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = 'sine';
  o.frequency.value = frequency;
  g.gain.value = volume;
  o.connect(g);
  g.connect(audioCtx.destination);
  o.start();
  setTimeout(()=>{ o.stop(); o.disconnect(); g.disconnect(); }, duration);
  // vibrate if available
  try { if(navigator.vibrate) navigator.vibrate(80); } catch(e){}
}

// ensure audio context is created on first user interaction to satisfy autoplay policies
function initAudioOnFirstUserAction(){
  function initOnce(){
    ensureAudioContext();
    document.removeEventListener('touchstart', initOnce);
    document.removeEventListener('click', initOnce);
  }
  document.addEventListener('touchstart', initOnce, {passive:true});
  document.addEventListener('click', initOnce, {passive:true});
}
initAudioOnFirstUserAction();

// --- helpers & storage ---
function nowTS(){ const d=new Date(); return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')+' '+String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0')+':'+String(d.getSeconds()).padStart(2,'0'); }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function findGroup(id){ return groups.find(g=>g.idNumber===id); }
function ensureGroup(id){ let g=findGroup(id); if(!g){ g={idNumber:id,name:'',items:[]}; groups.unshift(g);} return g; }
function findInv(inv){ for(const g of groups){ for(const it of g.items){ if(it.inv===inv) return {groupId:g.idNumber,item:it}; } } return null; }
function save(){ if(!autoSave) return; localStorage.setItem(STORAGE_KEY, JSON.stringify({groups,currentEmployee,lastInv})); }
function forceSave(){ localStorage.setItem(STORAGE_KEY, JSON.stringify({groups,currentEmployee,lastInv})); }
function load(){ const raw=localStorage.getItem(STORAGE_KEY); if(!raw) return; try{ const p=JSON.parse(raw); groups=p.groups||[]; currentEmployee=p.currentEmployee||null; lastInv=p.lastInv||null; }catch(e){console.error(e);} }

function updateUI(filter=''){
  currentEmployeeDisplay.textContent = currentEmployee||'אין';
  lastInvDisplay.textContent = lastInv||'אין';
  groupsContainer.innerHTML = '';
  const flt = (filter||'').trim().toLowerCase();
  const visible = groups.filter(g => { if(!flt) return true; return (String(g.idNumber).toLowerCase().includes(flt) || (g.name||'').toLowerCase().includes(flt)); });
  if(visible.length===0){ groupsContainer.innerHTML = '<div class="small" style="color:var(--muted)">טרם בוצעו סריקות</div>'; return; }
  visible.forEach(g=>{
    const groupEl = document.createElement('div'); groupEl.className='group';
    const header = document.createElement('div'); header.className='group-header';
    const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:800">${escapeHtml(g.idNumber)}${g.name? ' — '+escapeHtml(g.name):''}</div><div class="small">פריטים: ${g.items.length}</div>`;
    const right = document.createElement('div');
    const chooseBtn = document.createElement('button'); chooseBtn.className='btn-muted'; chooseBtn.textContent='בחר עובד';
    chooseBtn.onclick = ()=>{ currentEmployee = g.idNumber; updateUI(searchEmployee.value||''); save(); };
    const editBtn = document.createElement('button'); editBtn.className='btn-muted'; editBtn.textContent='ערוך שם';
    editBtn.onclick = ()=>{ const nm = prompt('שם עובד:', g.name||''); if(nm!==null){ g.name = nm.trim(); updateUI(searchEmployee.value||''); save(); } };
    const removeBtn = document.createElement('button'); removeBtn.className='btn-danger'; removeBtn.textContent='הסר';
    removeBtn.onclick = ()=>{ if(confirm('להסיר עובד זה כולל כל הפריטים?')){ groups = groups.filter(x=>x.idNumber!==g.idNumber); if(currentEmployee===g.idNumber) currentEmployee=null; save(); updateUI(searchEmployee.value||''); } };
    right.appendChild(chooseBtn); right.appendChild(editBtn); right.appendChild(removeBtn);
    header.appendChild(left); header.appendChild(right); groupEl.appendChild(header);

    const itemsWrap = document.createElement('div'); itemsWrap.className='items';
    if(g.items.length===0){ const n=document.createElement('div'); n.className='small'; n.textContent='עדיין אין פריטים'; itemsWrap.appendChild(n); }
    else {
      g.items.forEach((it, idx)=>{
        const itemEl = document.createElement('div'); itemEl.className='item';
        const leftPart = document.createElement('div'); leftPart.innerHTML = `<div style="font-weight:700">${escapeHtml(it.inv)}</div><div class="small">${escapeHtml(it.ts)}</div>`;
        const rightPart = document.createElement('div');
        const editItemBtn = document.createElement('button'); editItemBtn.className='btn-muted'; editItemBtn.textContent='ערוך';
        editItemBtn.onclick = ()=>{ const nv = prompt('ערוך אינוונטר:', it.inv); if(nv!==null){ const ex=findInv(nv.trim()); if(ex && ex.groupId!==g.idNumber){ if(confirm('הקוד משויך לעובד אחר ('+ex.groupId+'). להעביר?')){ const other = findGroup(ex.groupId); if(other) other.items = other.items.filter(x=>x.inv!==it.inv); it.inv = nv.trim(); } else return; } else it.inv = nv.trim(); save(); updateUI(searchEmployee.value||''); } };
        const delItemBtn = document.createElement('button'); delItemBtn.className='btn-danger'; delItemBtn.textContent='מחק';
        delItemBtn.onclick = ()=>{ if(confirm('למחוק פריט זה?')){ g.items.splice(idx,1); save(); updateUI(searchEmployee.value||''); } };
        rightPart.appendChild(editItemBtn); rightPart.appendChild(delItemBtn);
        itemEl.appendChild(leftPart); itemEl.appendChild(rightPart); itemsWrap.appendChild(itemEl);
      });
    }
    groupEl.appendChild(itemsWrap);
    groupsContainer.appendChild(groupEl);
  });
}

// add employee
btnAddEmployee.addEventListener('click', ()=>{ const v = employeeInput.value.trim(); if(!v){ alert('אין מספר זהות'); employeeInput.focus(); return; } currentEmployee = v; ensureGroup(currentEmployee); employeeInput.value=''; updateUI(searchEmployee.value||''); save(); });
btnClearEmployee.addEventListener('click', ()=>{ if(confirm('נקה בחירה?')){ currentEmployee=null; updateUI(searchEmployee.value||''); save(); } });
btnSaveName.addEventListener('click', ()=>{ if(!currentEmployee){ alert('בחר עובד קודם'); return; } const nm = employeeNameInput.value.trim(); const g = ensureGroup(currentEmployee); g.name = nm; save(); updateUI(searchEmployee.value||''); });

// add inv
btnAddInv.addEventListener('click', ()=>{ addInvFromInput(invInput.value.trim()); invInput.value=''; invInput.focus(); });
invInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ addInvFromInput(invInput.value.trim()); invInput.value=''; } });
btnManualInv.addEventListener('click', ()=>{ const v=prompt('הכנס אינוונטר:'); if(v && v.trim()) addInvFromInput(v.trim()); });

function addInvFromInput(inv){
  if(!inv){ alert('אין קוד'); return; }
  const target = currentEmployee || 'לא מזוהה';
  const f = findInv(inv);
  if(f){
    if(f.groupId === target){ alert('הקוד כבר משויך לאותו עובד'); return; }
    if(confirm('הקוד כבר שויך לעובד '+f.groupId+'. להעביר לעובד הנוכחי?')){ const other = findGroup(f.groupId); if(other) other.items = other.items.filter(x=>x.inv!==inv); const g = ensureGroup(target); g.items.unshift({inv,ts:nowTS()}); lastInv=inv; // play beep on successful add
      playBeep({frequency:1200,duration:140,volume:0.16}); save(); updateUI(searchEmployee.value||''); return; } else return;
  } else {
    const g = ensureGroup(target);
    g.items.unshift({inv,ts:nowTS()});
    lastInv = inv;
    // הצלחה — פעולת משוב: צפצוף + רטט (אם יש)
    playBeep({frequency:1000,duration:120,volume:0.16});
    try { if(navigator.vibrate) navigator.vibrate(80); } catch(e){}
    save(); updateUI(searchEmployee.value||'');
  }
}

// search filter
searchEmployee.addEventListener('input', ()=> updateUI(searchEmployee.value||''));

// export XLSX
function exportXLSX(){
  const rows=[['CODE','TZ','TADE','NAME']];
  groups.forEach(g=>{ const items=g.items.slice().reverse(); items.forEach(it => rows.push([it.inv,g.idNumber,it.ts,g.name||''])); });
  const ws = XLSX.utils.aoa_to_sheet(rows); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'מפקד_ציוד');
  const wbout = XLSX.write(wb,{bookType:'xlsx',type:'array'}); const blob = new Blob([wbout],{type:'application/octet-stream'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url;
  const fn = 'mifkad_CODE_TZ_TADE_' + (new Date()).toISOString().slice(0,19).replace(/[:T]/g,'-') + '.xlsx';
  a.download = fn; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
btnExportTop.addEventListener('click', exportXLSX);

// clear / storage
document.getElementById('btnClearAll').addEventListener('click', ()=>{ if(confirm('למחוק את כל הנתונים המקומיים?')){ groups=[]; currentEmployee=null; lastInv=null; forceSave(); updateUI(); } });
btnClearLocal.addEventListener('click', ()=>{ if(confirm('מחק שמירת מקומית?')){ localStorage.removeItem(STORAGE_KEY); groups=[]; currentEmployee=null; lastInv=null; updateUI(); } });

// autosave toggle
btnAutoSaveToggle.addEventListener('click', ()=>{
  autoSave = !autoSave; autoSaveStatusEl.textContent = autoSave ? 'מופעלת' : 'כבויה';
  btnAutoSaveToggle.textContent = autoSave ? 'כיבוי שמירה אוטומטית' : 'הפעל שמירה אוטומטית';
  if(autoSave) save();
});

// sidebar toggle mobile
const toggleSidebarBtnEl = document.getElementById('toggleSidebar');
toggleSidebarBtnEl && toggleSidebarBtnEl.addEventListener('click', ()=>{
  if(sidebar.classList.contains('collapsed')){ sidebar.classList.remove('collapsed'); toggleSidebarBtnEl.textContent='הסתר מידע'; }
  else { sidebar.classList.add('collapsed'); toggleSidebarBtnEl.textContent='הצג מידע'; }
});

// Camera / Quagga
function startCameraScan(target){
  quaggaCallbackTarget = target; cameraModal.style.display='flex';
  if(quaggaActive) return;
  Quagga.init({
    inputStream:{ type:"LiveStream", constraints:{ width:640, height:480, facingMode:"environment" }, target: scannerDiv },
    decoder:{ readers:["code_128_reader","ean_reader","ean_8_reader","upc_reader","code_39_reader","codabar_reader"] },
    locate:true
  }, function(err){
    if(err){ console.error(err); alert('שגיאת מצלמה: '+(err.message||err)); cameraModal.style.display='none'; return; }
    Quagga.start(); quaggaActive=true; Quagga.onDetected(onQuaggaDetected);
  });
}
function stopCameraScan(){ if(quaggaActive){ Quagga.stop(); Quagga.offDetected(onQuaggaDetected); quaggaActive=false; } cameraModal.style.display='none'; quaggaCallbackTarget=null; lastProcessedInvTime=0; }

function onQuaggaDetected(result){
  if(!result || !result.codeResult) return; const code = result.codeResult.code; if(!code) return;
  if(quaggaCallbackTarget === 'employee'){ stopCameraScan(); employeeInput.value = code; btnAddEmployee.click(); return; }
  if(quaggaCallbackTarget === 'inv'){ const now = Date.now(); if(now - lastProcessedInvTime >= 5000){ addInvFromInput(code); lastProcessedInvTime = now; lastInv = code; save(); updateUI(searchEmployee.value||''); } }
}

btnCameraInv.addEventListener('click', ()=> startCameraScan('inv'));
closeCamera.addEventListener('click', stopCameraScan);
stopScanner.addEventListener('click', stopCameraScan);

// audio ensure on first user action (if page loaded without gesture)
function ensureAudioContext(){ if(!window._mifkad_audio_ctx){ try{ window._mifkad_audio_ctx = new (window.AudioContext || window.webkitAudioContext)(); }catch(e){ window._mifkad_audio_ctx = null; } } return window._mifkad_audio_ctx; }
// wrapper playBeep uses global audioCtx created earlier
function playBeep(params){ // fallback to ensureAudioContext if audioCtx null
  try{
    if(!audioCtx) audioCtx = ensureAudioContext();
    if(!audioCtx) return;
    if(audioCtx.state === 'suspended' && typeof audioCtx.resume === 'function') audioCtx.resume();
    const frequency = params && params.frequency ? params.frequency : 1000;
    const duration = params && params.duration ? params.duration : 120;
    const volume = params && params.volume ? params.volume : 0.16;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = 'sine';
    o.frequency.value = frequency;
    g.gain.value = volume;
    o.connect(g);
    g.connect(audioCtx.destination);
    o.start();
    setTimeout(()=>{ try{ o.stop(); o.disconnect(); g.disconnect(); }catch(e){} }, duration);
    try { if(navigator.vibrate) navigator.vibrate(80); } catch(e){}
  }catch(e){ console.warn('playBeep failed', e); }
}

// init audio on first user gesture
(function initAudioOnUserGesture(){
  function initOnce(){ ensureAudioContext(); document.removeEventListener('touchstart', initOnce); document.removeEventListener('click', initOnce); }
  document.addEventListener('touchstart', initOnce, {passive:true});
  document.addEventListener('click', initOnce, {passive:true});
})();

// init
load(); updateUI(); invInput.focus();
window.addEventListener('beforeunload', ()=> { if(autoSave) save(); });

</script>
</body>
</html>
