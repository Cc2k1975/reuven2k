<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>שער - זמיר 15</title>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: white; margin: 0; padding: 10px; text-align: center; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { background: #333; padding: 20px; border: 1px solid #555; border-radius: 8px; font-size: 1.2rem; cursor: pointer; }
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        video { width: 250px; border: 2px solid #3498db; border-radius: 10px; margin-bottom: 10px; background: #000; }
        #log { position: fixed; bottom: 0; left: 0; width: 100%; background: #000; color: #0f0; font-size: 12px; height: 80px; overflow-y: scroll; text-align: left; padding: 5px; border-top: 1px solid #0f0; }
    </style>
</head>
<body>
    <h2>זמיר 15 - שער</h2>
    <div id="grid" class="grid"></div>
    <div id="log">L: Ready</div>

    <div id="overlay">
        <video id="localVideo" autoplay playsinline muted></video>
        <h2 id="status">מחייג...</h2>
        <button onclick="location.reload()" style="padding:15px; background:red; color:white; border:none;">ביטול</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyALAVQSl6FcuF0HYhCfIgVz-GUMSJKcT5c",
            authDomain: "zamir15-intercom.firebaseapp.com",
            projectId: "zamir15-intercom",
            storageBucket: "zamir15-intercom.firebasestorage.app",
            messagingSenderId: "823056442276",
            appId: "1:823056442276:web:a4235e2219152bb6789731"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const log = (m) => { document.getElementById('log').innerHTML += ` | ${m}`; console.log(m); };

        const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });

        const grid = document.getElementById('grid');
        for (let i = 1; i <= 24; i++) {
            const b = document.createElement('div');
            b.className = 'btn'; b.innerText = `דירה ${i}`;
            b.onclick = () => startCall(i);
            grid.appendChild(b);
        }

        async function startCall(apt) {
            document.getElementById('overlay').style.display = 'flex';
            log(`Call apt ${apt}`);
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('localVideo').srcObject = stream;
            stream.getTracks().forEach(t => pc.addTrack(t, stream));

            const callDoc = db.collection('calls').doc();
            pc.onicecandidate = (e) => e.candidate && callDoc.collection('offerCandidates').add(e.candidate.toJSON());

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            await callDoc.set({ apartment: apt, status: 'dialing', offer: { type: offer.type, sdp: offer.sdp } });

            callDoc.onSnapshot(s => {
                const d = s.data();
                if (d.answer && !pc.currentRemoteDescription) pc.setRemoteDescription(new RTCSessionDescription(d.answer));
                if (d.status === 'opened') location.reload();
            });

            callDoc.collection('answerCandidates').onSnapshot(s => {
                s.docChanges().forEach(c => c.type === 'added' && pc.addIceCandidate(new RTCIceCandidate(c.doc.data())));
            });
        }
    </script>
</body>
</html>
10
