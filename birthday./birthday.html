<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>××©×—×§ ××ª× ×•×ª ×™×•× ×”×•×œ×“×ª</title>

  <!-- ×¡×¤×¨×™×™×ª ×¡×¨×™×§×ª QR/Barcode -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    :root{
      --bg:#ffeef7;
      --card:#ffffff;
      --accent:#ff4081;
      --accent-dark:#e91e63;
      --text:#222;
      --muted:#666;
      --radius:18px;
      --shadow:0 10px 25px rgba(0,0,0,0.12);
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;
      padding:0;
      font-family:system-ui,"Heebo","Arial",sans-serif;
      background:linear-gradient(180deg,#ffeef7,#fff);
      color:var(--text);
    }
    body{
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      padding:12px;
    }
    .app{
      width:100%;
      max-width:500px;
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px 16px 22px;
      position:relative;
      overflow:hidden;
    }
    h1,h2,h3{
      margin:0 0 12px;
      text-align:center;
    }
    h1{
      font-size:1.6rem;
      color:var(--accent-dark);
    }
    h2{
      font-size:1.3rem;
    }
    p{
      margin:0 0 10px;
      line-height:1.4;
    }
    .center{text-align:center}
    .btn{
      display:inline-block;
      padding:10px 18px;
      border-radius:999px;
      border:none;
      font-size:1rem;
      font-weight:600;
      cursor:pointer;
      background:var(--accent);
      color:#fff;
      box-shadow:0 6px 14px rgba(233,30,99,0.35);
      margin:8px 0;
    }
    .btn:active{
      transform:translateY(1px);
      box-shadow:0 3px 8px rgba(233,30,99,0.4);
    }
    .btn-secondary{
      background:#f1f1f1;
      color:#333;
      box-shadow:none;
    }
    .btn-small{
      padding:6px 10px;
      font-size:0.85rem;
    }
    .hidden{display:none !important;}

    .tagline{
      font-size:0.95rem;
      color:var(--muted);
      text-align:center;
      margin-bottom:10px;
    }
    .progress{
      text-align:center;
      font-size:0.9rem;
      color:var(--muted);
      margin-top:6px;
    }
    .bubble{
      background:#fff3f8;
      border-radius:14px;
      padding:10px 12px;
      margin:10px 0;
      border:1px dashed #ff8bb3;
      font-size:0.95rem;
    }

    /* ××¡×›×™× */
    .screen{
      display:none;
    }
    .screen.active{
      display:block;
    }

    /* ×¡×¨×™×§×” */
    #qr-reader{
      width:100%;
      max-width:360px;
      margin:0 auto;
    }
    #scan-status{
      text-align:center;
      font-size:0.9rem;
      color:var(--muted);
      margin-top:8px;
      min-height:18px;
    }

    /* ××¡×š ×ª×—× ×” */
    .station-box{
      background:#fff7fb;
      border-radius:16px;
      padding:14px;
      border:1px solid #ffd0e6;
    }
    .station-label{
      font-size:0.9rem;
      color:var(--muted);
      margin-bottom:6px;
    }

    /* ×›×¤×ª×•×¨ × ×™×”×•×œ ×¡×•×“×™ */
    .admin-open{
      position:absolute;
      top:8px;
      left:10px;
      background:transparent;
      border:none;
      color:#bbb;
      cursor:pointer;
      font-size:1.2rem;
    }

    .field-group{
      margin-bottom:10px;
    }
    label{
      display:block;
      font-size:0.9rem;
      margin-bottom:3px;
      color:var(--muted);
    }
    input[type="text"], textarea, input[type="number"]{
      width:100%;
      padding:7px 8px;
      border-radius:10px;
      border:1px solid #dadada;
      font-size:0.9rem;
      font-family:inherit;
    }
    textarea{
      min-height:50px;
      resize:vertical;
    }
    .stations-grid{
      max-height:320px;
      overflow-y:auto;
      border-radius:14px;
      border:1px solid #eee;
      padding:8px;
      background:#fafafa;
    }
    .station-edit{
      margin-bottom:10px;
      padding:6px 8px;
      border-radius:10px;
      background:#ffffff;
      border:1px solid #e5e5e5;
    }
    .station-edit h4{
      margin:0 0 6px;
      font-size:0.9rem;
      color:var(--accent-dark);
    }
    .footer-note{
      margin-top:8px;
      font-size:0.8rem;
      color:#999;
      text-align:center;
    }

    .loading{
      text-align:center;
      font-size:0.95rem;
      color:var(--muted);
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- ×›×¤×ª×•×¨ × ×™×”×•×œ ×¡×•×“×™ -->
    <button class="admin-open" id="adminOpenBtn" title="× ×™×”×•×œ">âš™</button>

    <!-- ××¡×š ×˜×¢×™× ×” ×§×¦×¨ ×œ×¤× ×™ ×©×”-config ××’×™×¢ ×Ö¾Firebase -->
    <section id="screen-loading" class="screen active">
      <h2>×˜×•×¢×Ÿ ××©×—×§â€¦</h2>
      <p class="loading">××ª×—×‘×¨ ×œÖ¾Firebase, ×¨×’×¢â€¦</p>
    </section>

    <!-- ××¡×š ×¤×ª×™×—×” -->
    <section id="screen-welcome" class="screen">
      <h1>××–×œ ×˜×•×‘ <span id="player-name-display">×œ×“× ×”</span>! ğŸ‰</h1>
      <p class="tagline">×”×™×•× ×× ×—× ×• ×™×•×¦××™× ×œ××¡×œ×•×œ ××¤×ª×™×¢ ×¢× ××ª× ×•×ª × ×¡×ª×¨×•×ªâ€¦</p>
      <div class="bubble">
        <p class="center">
          ×‘×›×œ ×ª×—× ×” ×ª××¦××™ ×‘×¨×§×•×“,<br>
          ×ª×¡×¨×§×™ ××•×ª×• ×•×ª×§×‘×œ×™ ×—×™×“×” ×©×ª×•×‘×™×œ ×œ××ª× ×” ×”×‘××” ğŸ
        </p>
      </div>
      <div class="center">
        <button class="btn" id="startGameBtn">×™××œ×œ×”, ××ª×—×™×œ×™×!</button>
      </div>
      <p class="progress" id="stations-count-label"></p>
    </section>

    <!-- ××¡×š ×¡×¨×™×§×” -->
    <section id="screen-scan" class="screen">
      <h2>×¡×¨×§×™ ××ª ×”×‘×¨×§×•×“ ×”×‘× ğŸ“·</h2>
      <p class="tagline">×›×•×•× ×™ ××ª ×”××¦×œ××” ××œ ×”×‘×¨×§×•×“ ×”××¦×•×¨×£</p>
      <div id="qr-reader"></div>
      <div id="scan-status"></div>
      <div class="center" style="margin-top:12px;">
        <button class="btn-secondary btn-small" id="backToWelcomeBtn">×—×–×¨×” ×œ××¡×š ×”×¨××©×™</button>
      </div>
    </section>

    <!-- ××¡×š ×ª×—× ×” (××©×™××”/××ª× ×”) -->
    <section id="screen-station" class="screen">
      <h2 id="station-title">×›×œ ×”×›×‘×•×“! ğŸ</h2>
      <div class="station-box">
        <div class="station-label" id="station-index-label"></div>
        <p id="station-riddle"></p>
        <hr style="margin:10px 0;border:none;border-top:1px dashed #ffc0dd;">
        <p id="station-reward" style="font-weight:600;"></p>
      </div>
      <div class="center" style="margin-top:14px;">
        <button class="btn" id="continueScanBtn">×”××©×š ×œ×¡×¨×™×§×” ×”×‘××”</button>
        <button class="btn-secondary btn-small" id="backToScanBtn">×—×–×¨×” ×œ×¡×•×¨×§</button>
      </div>
    </section>

    <!-- ××¡×š × ×™×”×•×œ ×¡×•×“×™ -->
    <section id="screen-admin" class="screen">
      <h2>××¡×š × ×™×”×•×œ (×¡×•×“×™)</h2>

      <div class="field-group">
        <label for="player-name-input">×©× ××§×‘×œ/×ª ×”××ª× ×•×ª (××•×¦×’ ×‘××¡×š ×”×¨××©×™):</label>
        <input type="text" id="player-name-input" placeholder="×œ××©×œ: ×“× ×”">
      </div>

      <div class="field-group">
        <label for="stations-number-input">×›××” ×ª×—× ×•×ª / ××ª× ×•×ª?</label>
        <input type="number" id="stations-number-input" min="1" max="30" value="5">
      </div>

      <div class="field-group">
        <p style="font-size:0.9rem;margin-bottom:4px;">
          ×”×’×“×¨×ª ×”×ª×—× ×•×ª (×§×•×“ ×‘×¨×§×•×“ + ×—×™×“×” + ×”×•×“×¢×ª ××ª× ×”):
        </p>
        <div class="stations-grid" id="stations-edit-container">
          <!-- ×›××Ÿ ×™×™×•×¦×¨×• ×©×•×¨×•×ª ×¢×¨×™×›×” ×“×™× ××™×•×ª -->
        </div>
      </div>

      <div class="center" style="margin-top:10px;">
        <button class="btn" id="saveAdminBtn">×©××™×¨×” ×œÖ¾Firebase</button>
        <button class="btn-secondary btn-small" id="exitAdminBtn">×™×¦×™××”</button>
      </div>

      <p class="footer-note">
        ×”×”×’×“×¨×•×ª × ×©××¨×•×ª ×‘Ö¾Firebase Realtime Database ×ª×—×ª ×”×¦×•××ª <code>config</code>.<br>
        ××¤×©×¨ ×œ×¢×¨×•×š ××›×œ ××›×©×™×¨, ×œ× ×¦×¨×™×š ×œ×’×¢×ª ×‘×˜×œ×¤×•×Ÿ ×©×œ ×“× ×”.
      </p>
    </section>
  </div>

  <!-- ×§×•×“ JS ××•×“×•×œ×¨×™ ×¢× Firebase -->
  <script type="module">
    // -------- Firebase SDK --------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBxh37gdksnvKyGZhKzcMEliRuRZaqFyRs",
      authDomain: "birthday-6673d.firebaseapp.com",
      projectId: "birthday-6673d",
      storageBucket: "birthday-6673d.firebasestorage.app",
      messagingSenderId: "815278978626",
      appId: "1:815278978626:web:2f5821014c768ee32d5fdb",
      measurementId: "G-295LG2HNQ8",
      databaseURL: "https://birthday-6673d-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // -------- ×œ×•×’×™×§×ª ×”××©×—×§ --------
    const DEFAULT_CONFIG = {
      playerName: "×“× ×”",
      stations: [
        {
          code: "DANA-1",
          riddle: "×”××ª× ×” ×”×¨××©×•× ×” ××—×›×” ×‘××§×•× ×©×‘×• ×©×•××¨×™× ××ª ×›×œ ×”××ª×•×§×™×â€¦",
          reward: "××ª× ×” 1: ×©×•×§×•×œ×“ ××”×•×‘ ×•×¤×ª×§ ××™×©×™ â¤ï¸"
        },
        {
          code: "DANA-2",
          riddle: "×¢×›×©×™×• ×œ×›×™ ×œ××§×•× ×©×‘×• ××ª ××ª×—×™×œ×” ××ª ×”×‘×•×§×¨ ×¢× ××™× ×—××™×â€¦",
          reward: "××ª× ×” 2: ××•×¦×¨ ×˜×™×¤×•×— ××¤× ×§ ğŸš¿"
        },
        {
          code: "DANA-3",
          riddle: "××™×¤×” ××ª ×”×›×™ ××•×”×‘×ª ×œ× ×•×— ×•×œ×¦×¤×•×ª ×‘×¡×“×¨×” ×˜×•×‘×”?",
          reward: "××ª× ×” 3: ×©××™×›×” ×¨×›×” ×œ× ×˜×¤×œ×™×§×¡ ğŸ›‹ï¸"
        },
        {
          code: "DANA-4",
          riddle: "×”××§×•× ×©×‘×• ××ª ×—×•×œ××ª ×¢×œ ×›×œ ×”×˜×™×•×œ×™× ×”×‘××™×â€¦",
          reward: "××ª× ×” 4: ××—×‘×¨×ª ×—×œ×•××•×ª ×•×¢×˜ âœˆï¸"
        },
        {
          code: "DANA-5",
          riddle: "×”×ª×—× ×” ×”××—×¨×•× ×” â€“ ×”××§×•× ×©×‘×• ×©×•××¨×™× ×–×™×›×¨×•× ×•×ªâ€¦",
          reward: "××ª× ×” 5: ××œ×‘×•× ×ª××•× ×•×ª ××™×•×—×“ ğŸ"
        }
      ]
    };

    let gameConfig     = null;
    let currentStation = null;
    let currentScreen  = "loading";
    let scannerInstance = null;

    // -------- ×¢×–×¨ ×œ××¡×›×™× --------
    function showScreen(name){
      currentScreen = name;
      document.querySelectorAll(".screen").forEach(sec => sec.classList.remove("active"));
      document.getElementById("screen-" + name).classList.add("active");

      if (name === "scan"){
        startScanner();
      } else {
        stopScanner();
      }
    }

    function updateWelcomeScreen(){
      if (!gameConfig) return;
      document.getElementById("player-name-display").textContent = gameConfig.playerName || "×“× ×”";
      document.getElementById("stations-count-label").textContent =
        "×‘××©×—×§ ××—×›×•×ª ×œ×š " + gameConfig.stations.length + " ×ª×—× ×•×ª ×¢× ××ª× ×•×ª ğŸ";
    }

    // -------- ×˜×¢×™× ×” ×•×©××™×¨×” ×Ö¾Firebase --------
    async function loadConfigFromFirebase(){
      const configRef = ref(db, "config");
      try{
        const snapshot = await get(configRef);
        if (snapshot.exists()){
          const data = snapshot.val();
          if (data.playerName && Array.isArray(data.stations)){
            gameConfig = data;
            return;
          }
        }
        // ×× ××™×Ÿ × ×ª×•× ×™× ×ª×§×™× ×™× â€“ ×“×—×™×¤×” ×©×œ ×‘×¨×™×¨×ª ××—×“×œ
        gameConfig = DEFAULT_CONFIG;
        await set(configRef, gameConfig);
      }catch(err){
        console.error("×©×’×™××” ×‘×§×¨×™××ª config ×Ö¾Firebase:", err);
        gameConfig = DEFAULT_CONFIG;
      }
    }

    async function saveConfigToFirebase(){
      const configRef = ref(db, "config");
      await set(configRef, gameConfig);
    }

    // -------- ×¡×¨×™×§×ª ×‘×¨×§×•×“ --------
    function startScanner(){
      const statusEl = document.getElementById("scan-status");
      statusEl.textContent = "×××ª×—×œ ××¦×œ××”â€¦";

      if (!window.Html5QrcodeScanner){
        statusEl.textContent = "×©×’×™××”: ×¡×¤×¨×™×™×ª ×”×¡×¨×™×§×” ×œ× × ×˜×¢× ×”.";
        return;
      }

      stopScanner(); // ×œ×™×ª×¨ ×‘×™×˜×—×•×Ÿ

      scannerInstance = new Html5QrcodeScanner(
        "qr-reader",
        { fps: 10, qrbox: 250, rememberLastUsedCamera: true },
        false
      );

      scannerInstance.render(onScanSuccess, onScanFailure);

      function onScanSuccess(decodedText, decodedResult){
        statusEl.textContent = "× ×¡×¨×§: " + decodedText;
        handleScannedCode(decodedText.trim());
      }

      function onScanFailure(errorMsg){
        // ×©×’×™××•×ª ×¡×¨×™×§×” ×©×•×˜×¤×•×ª â€“ ××ª×¢×œ××™×
      }
    }

    function stopScanner(){
      const statusEl = document.getElementById("scan-status");
      if (scannerInstance){
        scannerInstance.clear().catch(err => {
          console.warn("Failed to clear scanner", err);
        });
        scannerInstance = null;
      }
      const readerEl = document.getElementById("qr-reader");
      if (readerEl) readerEl.innerHTML = "";
      if (statusEl) statusEl.textContent = "";
    }

    function handleScannedCode(codeText){
      const station = gameConfig.stations.find(s => (s.code || "").trim() === codeText);
      if (!station){
        alert("×”×‘×¨×§×•×“ ×©× ×¡×¨×§ ×œ× ××•×›×¨ ×œ××©×—×§ ×”×–×”.\n\n×§×•×“ ×©× ×¡×¨×§: " + codeText);
        return;
      }
      currentStation = station;
      showStationScreen(station);
    }

    function showStationScreen(station){
      const idx = gameConfig.stations.indexOf(station);
      document.getElementById("station-title").textContent = "×›×œ ×”×›×‘×•×“, ×”×ª×—× ×” " + (idx + 1) + " ğŸ";
      document.getElementById("station-index-label").textContent =
        "×ª×—× ×” " + (idx + 1) + " ××ª×•×š " + gameConfig.stations.length;
      document.getElementById("station-riddle").textContent = station.riddle || "";
      document.getElementById("station-reward").textContent = station.reward || "";
      showScreen("station");
    }

    // -------- ××¡×š × ×™×”×•×œ --------
    function openAdminWithPassword(){
      const pass = prompt("×”×›× ×¡ ×¡×™×¡××ª × ×™×”×•×œ (×‘×¨×™×¨×ª ××—×“×œ: 2580):");
      if (pass === null) return;
      if (pass === "2580"){
        populateAdminForm();
        showScreen("admin");
      }else{
        alert("×¡×™×¡××” ×©×’×•×™×”");
      }
    }

    function populateAdminForm(){
      if (!gameConfig) return;
      document.getElementById("player-name-input").value = gameConfig.playerName || "";
      document.getElementById("stations-number-input").value = gameConfig.stations.length;

      const container = document.getElementById("stations-edit-container");
      container.innerHTML = "";
      const count = gameConfig.stations.length;

      for (let i = 0; i < count; i++){
        const st = gameConfig.stations[i] || {code:"",riddle:"",reward:""};
        const box = document.createElement("div");
        box.className = "station-edit";
        box.innerHTML = `
          <h4>×ª×—× ×” ${i+1}</h4>
          <div class="field-group">
            <label>×§×•×“ ×‘×¨×§×•×“ (××” ×›×ª×•×‘ ×‘-QR / ×‘×¨×§×•×“):</label>
            <input type="text" data-field="code" data-index="${i}" value="${(st.code || "").replace(/"/g,'&quot;')}">
          </div>
          <div class="field-group">
            <label>×—×™×“×” / ×”××©×™××” ×”××•×¦×’×ª ×œ××—×¨ ×”×¡×¨×™×§×”:</label>
            <textarea data-field="riddle" data-index="${i}">${st.riddle || ""}</textarea>
          </div>
          <div class="field-group">
            <label>×˜×§×¡×˜ ××ª× ×” / ×‘×¨×›×•×ª ×‘×ª×—× ×” ×–×•:</label>
            <textarea data-field="reward" data-index="${i}">${st.reward || ""}</textarea>
          </div>
        `;
        container.appendChild(box);
      }
    }

    async function applyAdminChanges(){
      if (!gameConfig) return;

      let newName = (document.getElementById("player-name-input").value || "").trim();
      if (!newName) newName = "×“× ×”";

      let newCount = parseInt(document.getElementById("stations-number-input").value,10);
      if (isNaN(newCount) || newCount < 1) newCount = 1;
      if (newCount > 30) newCount = 30;

      const container = document.getElementById("stations-edit-container");
      const newStations = [];

      for (let i = 0; i < newCount; i++){
        const st = {code:"",riddle:"",reward:""};
        const codeEl   = container.querySelector(`input[data-field="code"][data-index="${i}"]`);
        const riddleEl = container.querySelector(`textarea[data-field="riddle"][data-index="${i}"]`);
        const rewardEl = container.querySelector(`textarea[data-field="reward"][data-index="${i}"]`);
        if (codeEl)   st.code   = (codeEl.value || "").trim();
        if (riddleEl) st.riddle = (riddleEl.value || "").trim();
        if (rewardEl) st.reward = (rewardEl.value || "").trim();
        newStations.push(st);
      }

      gameConfig.playerName = newName;
      gameConfig.stations   = newStations;

      try{
        await saveConfigToFirebase();
        updateWelcomeScreen();
        alert("×”×”×’×“×¨×•×ª × ×©××¨×• ×‘Ö¾Firebase ×‘×”×¦×œ×—×” ğŸ‰");
        showScreen("welcome");
      }catch(err){
        console.error("×©×’×™××” ×‘×©××™×¨×ª config ×œÖ¾Firebase:", err);
        alert("××™×¨×¢×” ×©×’×™××” ×‘×©××™×¨×” ×œÖ¾Firebase. ×‘×“×•×§ ×§×•× ×¡×•×œ ×‘×“×¤×“×¤×Ÿ.");
      }
    }

    // -------- ×”××–× ×ª ××™×¨×•×¢×™× --------
    document.addEventListener("DOMContentLoaded", async () => {
      // ×˜×•×¢×Ÿ config ×Ö¾Firebase
      await loadConfigFromFirebase();
      updateWelcomeScreen();
      showScreen("welcome");

      document.getElementById("startGameBtn").addEventListener("click", () => {
        showScreen("scan");
      });

      document.getElementById("backToWelcomeBtn").addEventListener("click", () => {
        showScreen("welcome");
      });

      document.getElementById("continueScanBtn").addEventListener("click", () => {
        showScreen("scan");
      });

      document.getElementById("backToScanBtn").addEventListener("click", () => {
        showScreen("scan");
      });

      document.getElementById("adminOpenBtn").addEventListener("click", () => {
        openAdminWithPassword();
      });

      document.getElementById("saveAdminBtn").addEventListener("click", () => {
        applyAdminChanges();
      });

      document.getElementById("exitAdminBtn").addEventListener("click", () => {
        showScreen("welcome");
      });

      document.getElementById("stations-number-input").addEventListener("change", () => {
        if (!gameConfig) return;
        let newCount = parseInt(document.getElementById("stations-number-input").value,10) || 1;
        if (newCount < 1) newCount = 1;
        if (newCount > 30) newCount = 30;
        const oldStations = gameConfig.stations || [];
        const arr = [];
        for (let i = 0; i < newCount; i++){
          arr.push(oldStations[i] || {code:"",riddle:"",reward:""});
        }
        gameConfig.stations = arr;
        populateAdminForm();
      });
    });
  </script>
</body>
</html>

