<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>בחירת תפריט</title>
<style>
:root{
  --bg-page:#fffaf0;
  --panel-bg:#ffffff;
  --border:#e2d7b8;
  --text-main:#333;
  --text-dim:#666;
  --green:#3c7a4c;
  --green-dark:#2e5f3b;
  --gold:#c59d2f;
  --err-bg:#a01919;
  --ok-bg:#2e7d32;
  --radius:16px;
  --shadow:0 8px 24px rgba(0,0,0,0.12);
  --shadow-inner:0 0 10px rgba(0,0,0,0.08) inset;
  --btn-bg:#3c7a4c;
  --btn-text:#fff;
  --disabled-bg:#bbb;
  --disabled-text:#fff;
}

/* דף כללי */
body{
  margin:0;
  background:var(--bg-page);
  font-family:"Heebo",Arial,sans-serif;
  color:var(--text-main);
  display:flex;
  justify-content:center;
  padding:16px;
  text-align:center;
}
.wrap{
  width:100%;
  max-width:480px;
  background:var(--panel-bg);
  border-radius:var(--radius);
  border:2px solid var(--border);
  box-shadow:var(--shadow);
  padding:20px 16px 32px;
  text-align:initial;
}

/* הודעות סטטוס עליונות */
#statusBox{
  display:none;
  border-radius:var(--radius);
  padding:10px 14px;
  margin-bottom:16px;
  font-size:16px;
  font-weight:600;
  color:#fff;
  line-height:1.4;
  text-align:center;
}
#statusBox.ok{background:var(--ok-bg);}
#statusBox.err{background:var(--err-bg);}

/* בלוק קבלת פנים */
.welcomeBox{
  background:#ffffff;
  border:2px solid var(--border);
  border-radius:16px;
  box-shadow:0 8px 24px rgba(0,0,0,0.08);
  padding:16px;
  margin-bottom:16px;
  text-align:right;
  font-family:"Heebo", Arial, sans-serif;
}
.welcomeMainRow{
  display:flex;
  flex-wrap:nowrap;
  align-items:center;
  justify-content:flex-start;
  gap:10px;
}
.welcomeIcon{
  font-size:24px;
  line-height:1;
}
.welcomeTitle{
  font-size:20px;
  font-weight:700;
  color:var(--green-dark);
  white-space:nowrap; /* לא לשבור שורה במשפט */
}
.welcomeSubInfo{
  margin-top:8px;
  font-size:14px;
  line-height:1.4;
  color:#555;
}
.welcomeSubInfo div{
  white-space:nowrap;
}

/* אחרי שליחה */
#afterSubmitBox{
  display:none;
  background:#eef9f1;
  border:2px solid #b8dfc2;
  border-radius:var(--radius);
  padding:16px;
  text-align:center;
  font-size:16px;
  line-height:1.5;
  font-weight:600;
  color:#2e7d32;
  box-shadow:var(--shadow-inner);
  margin-bottom:16px;
}

/* כרטיס הטופס */
.formCard{
  background:#fff;
  border:2px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow-inner);
  padding:16px;
  margin-bottom:16px;
}
.formCard h2{
  margin:0 0 12px 0;
  font-size:18px;
  font-weight:700;
  color:var(--green);
  text-align:right;
}

/* שדות בחירה */
.selectRow{
  display:flex;
  flex-direction:column;
  margin-bottom:12px;
}
.selectRow label{
  font-size:15px;
  font-weight:600;
  color:var(--text-main);
  margin-bottom:6px;
  display:flex;
  align-items:center;
  justify-content:space-between;
}
.selectRow label .takenTag{
  font-size:12px;
  font-weight:700;
  color:#a01919;
  background:#fff0f0;
  border:1px solid #a01919;
  border-radius:12px;
  padding:2px 8px;
  display:none;
}
.selectRow select{
  background:#fff;
  border:2px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow-inner);
  padding:10px 12px;
  font-size:16px;
  color:var(--text-main);
  font-family:inherit;
}

/* כפתור שליחה */
#sendBtn{
  width:100%;
  background:var(--btn-bg);
  color:var(--btn-text);
  border:0;
  border-radius:var(--radius);
  font-size:18px;
  font-weight:700;
  padding:14px 16px;
  box-shadow:var(--shadow);
  cursor:pointer;
  margin-top:8px;
  text-align:center;
}
#sendBtn:active{
  background:var(--green-dark);
}
#sendBtn.disabled{
  background:var(--disabled-bg);
  color:var(--disabled-text);
  cursor:not-allowed;
}

/* פוטר */
.footerInfo{
  text-align:center;
  font-size:13px;
  color:var(--text-dim);
  margin-top:24px;
}
</style>
</head>
<body>
<div class="wrap">

  <!-- פס סטטוס (מצב, שגיאות, הצלחה) -->
  <div id="statusBox"></div>

  <!-- ברוכים הבאים למשפחה + מיקום + תאריך -->
  <div class="welcomeBox">
    <div class="welcomeMainRow">
      <div class="welcomeIcon">🍽️</div>
      <div class="welcomeTitle" id="welcomeTitleText">ברוכים הבאים משפחת ???</div>
    </div>
    <div class="welcomeSubInfo">
      <div id="eventLocationLine">נפגשים ב: ...</div>
      <div id="eventDateLine">בתאריך: ...</div>
    </div>
  </div>

  <!-- הודעת תודה אחרי שליחה -->
  <div id="afterSubmitBox">
    תודה! הבחירה שלך נשמרה בהצלחה ✅  
    אין צורך למלא שוב.
  </div>

  <!-- הטופס עצמו -->
  <div id="formCard" class="formCard">
    <h2>בחר/י מה אתה מביא</h2>

    <div class="selectRow">
      <label>מנה בשרית <span class="takenTag" data-tag="meat">תפוס</span></label>
      <select id="meatSelect"><option value="">בחר מנה בשרית…</option></select>
    </div>

    <div class="selectRow">
      <label>פחמימה <span class="takenTag" data-tag="carb">תפוס</span></label>
      <select id="carbSelect"><option value="">בחר פחמימה…</option></select>
    </div>

    <div class="selectRow">
      <label>סלט 1 <span class="takenTag" data-tag="salad1">תפוס</span></label>
      <select id="salad1Select"><option value="">בחר סלט ראשון…</option></select>
    </div>

    <div class="selectRow">
      <label>סלט 2 <span class="takenTag" data-tag="salad2">תפוס</span></label>
      <select id="salad2Select"><option value="">בחר סלט שני…</option></select>
    </div>

    <div class="selectRow">
      <label>שתייה <span class="takenTag" data-tag="drink">תפוס</span></label>
      <select id="drinkSelect"><option value="">בחר שתייה…</option></select>
    </div>

    <div class="selectRow">
      <label>קינוח <span class="takenTag" data-tag="dessert">תפוס</span></label>
      <select id="dessertSelect"><option value="">בחר קינוח…</option></select>
    </div>

    <button id="sendBtn">שלח</button>
  </div>

  <div class="footerInfo">גרסה 2.6 · food.html</div>
</div>

<script>
// ===== פרמטרים של ה-BIN =====
const BIN_ID     = "68ff447a43b1c97be9844c29";
const MASTER_KEY = "$2a$10$4rynniEMuvwqg2nDb5KSEe/lAVYp8a7L3xWzp9GsO6n49OfXc3FCO";
const API        = "https://api.jsonbin.io/v3/b";

// DOM
const statusBox          = document.getElementById("statusBox");
const afterSubmitBox     = document.getElementById("afterSubmitBox");
const formCard           = document.getElementById("formCard");

const welcomeTitleText   = document.getElementById("welcomeTitleText");
const eventLocationLine  = document.getElementById("eventLocationLine");
const eventDateLine      = document.getElementById("eventDateLine");

const meatSelect         = document.getElementById("meatSelect");
const carbSelect         = document.getElementById("carbSelect");
const salad1Select       = document.getElementById("salad1Select");
const salad2Select       = document.getElementById("salad2Select");
const drinkSelect        = document.getElementById("drinkSelect");
const dessertSelect      = document.getElementById("dessertSelect");

const sendBtn            = document.getElementById("sendBtn");

// מצב פנימי
let recordData   = null;
let myCode       = null;
let myFamilyName = "";
let formOpen     = true;

// ===== עוזרים =====

// הודעה עליונה
function showStatus(msg, ok){
  statusBox.style.display="block";
  statusBox.className = ok ? "ok" : "err";
  statusBox.textContent=msg;
}

// להביא את ה-code מה-URL: ?code=2
function getCodeFromURL(){
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get("code") || "";
}

// הצגת שם המשפחה + מיקום + תאריך
function renderHeaderInfo(){
  // שם המשפחה
  welcomeTitleText.textContent = "ברוכים הבאים " + myFamilyName;

  // שורת מיקום
  const loc = recordData?.eventLocation || "";
  if(loc){
    eventLocationLine.textContent = "נפגשים ב: " + loc;
  } else {
    eventLocationLine.textContent = "";
  }

  // שורת תאריך
  const dt = recordData?.eventDate || "";
  if(dt){
    eventDateLine.textContent = "בתאריך: " + dt;
  } else {
    eventDateLine.textContent = "";
  }
}

// בונה את כל האופציות בכל select לפי menuOptions
// ודואג להוריד פריטים שכבר נלקחו ע"י משפחות אחרות
function buildSelectOptions(){
  const menuOptions = recordData?.menuOptions || {};

  // מי כבר לקח מה
  const taken = {
    meat:new Set(),
    carb:new Set(),
    salad1:new Set(),
    salad2:new Set(),
    drink:new Set(),
    dessert:new Set()
  };

  const answers = Array.isArray(recordData?.["בחירות"])
    ? recordData["בחירות"]
    : [];

  answers.forEach(rec=>{
    if(!rec || !rec.code) return;
    if(rec.code !== myCode){
      if(rec["מנה"])      taken.meat.add(rec["מנה"]);
      if(rec["פחמימה"])   taken.carb.add(rec["פחמימה"]);
      if(rec["סלט1"])     taken.salad1.add(rec["סלט1"]);
      if(rec["סלט2"])     taken.salad2.add(rec["סלט2"]);
      if(rec["שתייה"])    taken.drink.add(rec["שתייה"]);
      if(rec["קינוח"])    taken.dessert.add(rec["קינוח"]);
    }
  });

  function fillSelect(selectEl, arr, takenSet, placeholderTxt){
    // שומר את האופציה הראשונה אם כבר קיימת
    const firstOption = selectEl.querySelector("option[value='']");
    selectEl.innerHTML = "";

    if(firstOption){
      selectEl.appendChild(firstOption);
    }else{
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = placeholderTxt;
      selectEl.appendChild(opt);
    }

    (arr||[]).forEach(item=>{
      const op=document.createElement("option");
      op.value=item;
      op.textContent=item;
      if(takenSet.has(item)){
        op.disabled=true;
        op.textContent = item+" (תפוס)";
      }
      selectEl.appendChild(op);
    });
  }

  fillSelect(meatSelect   , menuOptions.meat   || [], taken.meat   , "בחר מנה בשרית…");
  fillSelect(carbSelect   , menuOptions.carb   || [], taken.carb   , "בחר פחמימה…");
  fillSelect(salad1Select , menuOptions.salad1 || [], taken.salad1 , "בחר סלט ראשון…");
  fillSelect(salad2Select , menuOptions.salad2 || [], taken.salad2 , "בחר סלט שני…");
  fillSelect(drinkSelect  , menuOptions.drink  || [], taken.drink  , "בחר שתייה…");
  fillSelect(dessertSelect, menuOptions.dessert|| [], taken.dessert, "בחר קינוח…");

  // מציג תג "תפוס" ליד שם הקטגוריה אם אין בכלל אופציה חופשית
  updateTakenTag("meat"   , menuOptions.meat   || [], taken.meat);
  updateTakenTag("carb"   , menuOptions.carb   || [], taken.carb);
  updateTakenTag("salad1" , menuOptions.salad1 || [], taken.salad1);
  updateTakenTag("salad2" , menuOptions.salad2 || [], taken.salad2);
  updateTakenTag("drink"  , menuOptions.drink  || [], taken.drink);
  updateTakenTag("dessert", menuOptions.dessert|| [], taken.dessert);
}

// אם אין אפילו אפשרות אחת פנויה בקטגוריה – מציג "תפוס"
function updateTakenTag(cat, arr, takenSet){
  const tagEl = document.querySelector(`.takenTag[data-tag="${cat}"]`);
  if(!tagEl) return;
  let allTaken=true;
  for(const item of arr){
    if(!takenSet.has(item)){
      allTaken=false;
      break;
    }
  }
  tagEl.style.display = allTaken ? "inline-block":"none";
}

// בדיקה אם המשפחה הזו כבר מילאה בעבר
function alreadySubmitted(){
  const answers = Array.isArray(recordData?.["בחירות"])
    ? recordData["בחירות"]
    : [];
  return answers.some(r=>r.code===myCode);
}

// הפעלה/כיבוי של הטופס
function setFormEnabled(enabled){
  if(enabled){
    formCard.style.opacity="1";
    formCard.style.pointerEvents="auto";
    sendBtn.classList.remove("disabled");
  }else{
    formCard.style.opacity="0.5";
    formCard.style.pointerEvents="none";
    sendBtn.classList.add("disabled");
  }
}

// רענון מהשרת
async function refreshData(silent){
  if(!silent){
    showStatus("טוען נתונים...", true);
  }
  try{
    const res = await fetch(`${API}/${BIN_ID}/latest`, {
      headers:{ "X-Master-Key": MASTER_KEY }
    });
    const j = await res.json();

    recordData = j.record || null;
    formOpen   = recordData?.formOpen !== false;

    if(!silent){
      showStatus("", true);
      statusBox.style.display="none";
    }
  }catch(err){
    console.error(err);
    showStatus("שגיאה בטעינה", false);
  }
}

// בדיקה לפני שליחה אם מישהו אחר לקח בינתיים את מה שבחרתי
function someoneElseTookNow(vals){
  const answers = Array.isArray(recordData?.["בחירות"])
    ? recordData["בחירות"]
    : [];
  const usedByOthers = {
    meat:new Set(),
    carb:new Set(),
    salad1:new Set(),
    salad2:new Set(),
    drink:new Set(),
    dessert:new Set()
  };
  answers.forEach(rec=>{
    if(rec.code!==myCode){
      if(rec["מנה"])      usedByOthers.meat.add(rec["מנה"]);
      if(rec["פחמימה"])   usedByOthers.carb.add(rec["פחמימה"]);
      if(rec["סלט1"])     usedByOthers.salad1.add(rec["סלט1"]);
      if(rec["סלט2"])     usedByOthers.salad2.add(rec["סלט2"]);
      if(rec["שתייה"])    usedByOthers.drink.add(rec["שתייה"]);
      if(rec["קינוח"])    usedByOthers.dessert.add(rec["קינוח"]);
    }
  });

  if(usedByOthers.meat.has(vals.meatVal)) return true;
  if(usedByOthers.carb.has(vals.carbVal)) return true;
  if(usedByOthers.salad1.has(vals.s1Val)) return true;
  if(usedByOthers.salad2.has(vals.s2Val)) return true;
  if(usedByOthers.drink.has(vals.drinkVal)) return true;
  if(usedByOthers.dessert.has(vals.dessertVal)) return true;
  return false;
}

// שליחה
async function submitForm(){
  const meatVal    = meatSelect.value.trim();
  const carbVal    = carbSelect.value.trim();
  const s1Val      = salad1Select.value.trim();
  const s2Val      = salad2Select.value.trim();
  const drinkVal   = drinkSelect.value.trim();
  const dessertVal = dessertSelect.value.trim();

  if(!meatVal || !carbVal || !s1Val || !s2Val || !drinkVal || !dessertVal){
    showStatus("חסר פריט. תמלא הכל.", false);
    return;
  }

  // ריענון לפני שמירה כדי לוודא שלא נתפס עכשיו
  await refreshData(true);
  if(!recordData){
    showStatus("שגיאה בטעינה מחדש", false);
    return;
  }

  // מישהו אחר בדיוק לקח?
  const conflict = someoneElseTookNow({
    meatVal, carbVal, s1Val, s2Val, drinkVal, dessertVal
  });
  if(conflict){
    showStatus("מישהו בחר את אותה מנה עכשיו. תבחר מחדש.", false);
    buildSelectOptions();
    return;
  }

  // הטופס נסגר?
  if(recordData.formOpen === false){
    showStatus("הטופס נסגר. דבר עם המארגן.", false);
    return;
  }

  // כבר מילאתי?
  if(alreadySubmitted()){
    showStatus("כבר מילאת. אין צורך שוב.", true);
    return;
  }

  // מכין את הרשומה שלי
  const newRec = {
    code: myCode,
    "שם": myFamilyName,
    "מנה": meatVal,
    "פחמימה": carbVal,
    "סלט1": s1Val,
    "סלט2": s2Val,
    "שתייה": drinkVal,
    "קינוח": dessertVal,
    ts: new Date().toISOString()
  };

  const updatedAnswers = Array.isArray(recordData["בחירות"])
    ? [...recordData["בחירות"], newRec]
    : [newRec];

  // גוף מלא לשמירה (אנחנו משמרים הכל, לא מוחקים כלום)
  const body = {
    formOpen: (recordData.formOpen !== false),
    map: recordData.map || {},
    menuOptions: recordData.menuOptions || {},
    "בחירות": updatedAnswers,
    eventLocation: recordData.eventLocation || "",
    eventDate: recordData.eventDate || ""
  };

  try{
    const res = await fetch(`${API}/${BIN_ID}`, {
      method:"PUT",
      headers:{
        "Content-Type":"application/json",
        "X-Master-Key": MASTER_KEY
      },
      body: JSON.stringify(body)
    });
    if(!res.ok){
      showStatus("שמירה נכשלה .נסה שוב.", false);
      return;
    }

    showStatus("הנתונים נשמרו בהצלחה ✅", true);
    afterSubmitBox.style.display="block";
    setFormEnabled(false);

  }catch(err){
    console.error(err);
    showStatus("שגיאה בחיבור לשרת", false);
  }
}

// ===== Init =====
(async function init(){
  myCode = getCodeFromURL().trim();
  if(!myCode){
    showStatus("כדי לבחור אתה חייב להיכנס מהקישור האישי שלך", false);
    setFormEnabled(false);
    return;
  }

  await refreshData(true);

  if(!recordData){
    showStatus("שגיאה בטעינה", false);
    setFormEnabled(false);
    return;
  }

  // שם המשפחה לפי ה-map
  myFamilyName = recordData.map && recordData.map[myCode]
    ? recordData.map[myCode]
    : "משפחה לא מזוהה";

  // מציג כותרת עליונה ("ברוכים הבאים...", "נפגשים ב...", "בתאריך...")
  renderHeaderInfo();

  // הטופס פתוח?
  if(recordData.formOpen === false){
    showStatus("הטופס כרגע סגור. דבר עם המארגן.", false);
    setFormEnabled(false);
    return;
  }

  // כבר מילאתי?
  if(alreadySubmitted()){
    showStatus("כבר מילאת. תודה רבה 🙏", true);
    afterSubmitBox.style.display="block";
    setFormEnabled(false);
    return;
  }

  // בונה אפשרויות לבחירה עם סימון 'תפוס'
  buildSelectOptions();

  showStatus("בחר מה אתה מביא ✨", true);
  setFormEnabled(true);
})();

// לחיצה על שלח
sendBtn.addEventListener("click", ()=>{
  if(sendBtn.classList.contains("disabled")) return;
  submitForm();
});
</script>
</body>
</html>
