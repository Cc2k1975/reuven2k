<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MOA Data — צפייה וניהול</title>
<style>
  :root{
    --bg:#0f0f0f;
    --card:#121212;
    --accent:#d4af37;
    --muted:#2b2b2b;
    --danger:#6b1b1b;
    --success:#145a2b;
  }
  html,body{
    height:100%;
    margin:0;
    background:var(--bg);
    font-family: Arial, Helvetica, sans-serif;
    color:var(--accent);
  }
  .wrap{
    max-width:920px;
    margin:18px auto;
    padding:20px;
    border-radius:18px;
    background:linear-gradient(180deg,#0c0c0c,#0e0e0e);
    box-shadow:0 6px 30px rgba(0,0,0,0.6);
  }
  h1{
    margin:8px 0 20px;
    font-size:28px;
    text-align:center;
    color:var(--accent);
  }
  .status{
    padding:12px;
    border-radius:10px;
    margin:12px 0;
    font-weight:700;
    font-size:14px;
  }
  .status.ok{
    background:rgba(20,90,43,0.9);
    color:#fff;
  }
  .status.err{
    background:rgba(107,27,27,0.9);
    color:#fff;
  }
  .controls{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:center;
    margin-bottom:14px;
  }
  .controls input[type=text]{
    padding:10px;
    border-radius:10px;
    border:2px solid rgba(212,175,55,0.15);
    background:#111;
    color:var(--accent);
    min-width:240px
  }
  .btn{
    background:var(--accent);
    color:#000;
    padding:10px 14px;
    border-radius:10px;
    font-weight:700;
    border:none;
    cursor:pointer;
    font-size:14px;
  }
  .btn.ghost{
    background:transparent;
    color:var(--accent);
    border:1px solid rgba(212,175,55,0.15);
  }
  .table{
    width:100%;
    border-collapse:collapse;
    margin-top:8px;
    font-size:14px;
  }
  .table thead th{
    position:sticky;
    top:0;
    background:#0b0b0b;
    padding:12px;
    border-bottom:1px solid rgba(212,175,55,0.08);
    text-align:right;
    color:var(--accent);
    font-weight:700;
  }
  .table tbody tr{
    background:var(--card);
  }
  .table td{
    padding:10px 12px;
    vertical-align:middle;
    border-bottom:1px solid rgba(255,255,255,0.02);
    color:#f3d78a;
  }
  .actions{
    display:flex;
    gap:6px;
    justify-content:flex-start;
    flex-wrap:wrap;
  }
  .small{
    font-size:13px;
    color:#cdbb8d;
  }
  .debug{
    font-size:13px;
    color:#bbb;
    margin-top:12px;
    white-space:pre-wrap;
    background:#0b0b0b;
    padding:10px;
    border-radius:8px;
    border:1px solid rgba(255,255,255,0.02);
  }
  footer{
    margin-top:16px;
    text-align:center;
    color:#b8a16a;
    font-size:13px;
  }

  /* modal */
  .modal{
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    background:rgba(0,0,0,0.6);
    z-index:50;
  }
  .modal .box{
    background:#0f0f0f;
    padding:18px;
    border-radius:10px;
    min-width:300px;
    max-width:720px;
    border:2px solid rgba(212,175,55,0.06);
  }
  .field{
    display:flex;
    flex-direction:column;
    margin-bottom:10px
  }
  .field label{
    font-weight:800;
    margin-bottom:6px;
    color:var(--accent)
  }
  .field input,
  .field select,
  .field textarea{
    padding:10px;
    border-radius:10px;
    border:1px solid rgba(212,175,55,0.12);
    background:#121212;
    color:var(--accent);
    min-width:180px;
  }

  @media(max-width:600px){
    .table thead{
      display:none
    }
    .table tbody td{
      display:block;
      padding:12px;
    }
    .actions{
      justify-content:flex-end
    }
  }
</style>
</head>
<body>
  <div class="wrap" role="main">
    <h1>טופס סקר — ניהול MOA</h1>

    <!-- הודעת סטטוס למעלה -->
    <div id="statusTop" class="status" style="display:none"></div>

    <!-- שליטה -->
    <div class="controls" aria-hidden="false">
      <input id="filter" type="text" placeholder="חפש – שם/טלפון/מבנה..." />
      <button id="refreshBtn" class="btn">רענן</button>
      <button id="exportCsv" class="btn ghost">ייצא CSV</button>
    </div>

    <!-- טבלה -->
    <table class="table" aria-describedby="debug">
      <thead>
        <tr>
          <th>מחלקה</th>
          <th>שם העובד</th>
          <th>טלפון</th>
          <th>מבנה</th>
          <th>קומה</th>
          <th>חדר</th>
          <th>כמות אריזות</th>
          <th>חדר יעד</th>
          <th>נוצר</th>
          <th>פעולות</th>
        </tr>
      </thead>
      <tbody id="listBody">
        <tr><td colspan="10" class="small">טוען...</td></tr>
      </tbody>
    </table>

    <!-- דיבאג -->
    <div id="debug" class="debug" aria-live="polite"></div>

    <footer>
      גרסה: <span id="ver">1.0.0</span> — קובץ: moadata.html
    </footer>
  </div>

  <!-- חלון עריכה -->
  <div id="modalEdit" class="modal" style="display:none">
    <div class="box" role="dialog" aria-modal="true">
      <h3 style="margin-top:0;color:var(--accent)">ערוך רשומה</h3>

      <div class="field">
        <label>מחלקה</label>
        <select id="m_dept">
          <option>אווירודינמיקה</option>
          <option>מחמ</option>
          <option>מטה</option>
          <option>ניווט</option>
          <option>בקמ</option>
          <option>טילאות</option>
          <option>סימולציות</option>
        </select>
      </div>

      <div class="field">
        <label>שם העובד</label>
        <input id="m_name" />
      </div>

      <div class="field">
        <label>מספר נייד</label>
        <input id="m_phone" />
      </div>

      <div class="field">
        <label>מבנה</label>
        <input id="m_building" />
      </div>

      <div class="field">
        <label>קומה</label>
        <input id="m_floor" />
      </div>

      <div class="field">
        <label>מספר חדר</label>
        <input id="m_room" />
      </div>

      <div class="field">
        <label>כמות אריזות</label>
        <select id="m_packs">
          <option>1</option>
          <option>2</option>
          <option>3</option>
          <option>4</option>
          <option>5</option>
        </select>
      </div>

      <div class="field">
        <label>חדר יעד</label>
        <input id="m_target" />
      </div>

      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button id="saveEdit" class="btn">שמור</button>
        <button id="closeModal" class="btn ghost">ביטול</button>
      </div>
    </div>
  </div>

<script>
/*
  גרסה 1.0.0
  קובץ: moadata.html
  מובנה עם הערכים שסיפקת:
  BIN_ID = 68fe7e2bae596e708f2e965e
  ACCESS_KEY = $2a$10$cSsqpLyw9Jl/8q0El4JzqOuwLRUINEoMNeyxeUQ726QdlvNMD0iTe
*/

const BIN_ID = "68fe7e2bae596e708f2e965e";
const ACCESS_KEY = "$2a$10$cSsqpLyw9Jl/8q0El4JzqOuwLRUINEoMNeyxeUQ726QdlvNMD0iTe";

const API_BASE = "https://api.jsonbin.io/v3/b";

const STATUS_TOP = document.getElementById("statusTop");
const DEBUG = document.getElementById("debug");
const LIST_BODY = document.getElementById("listBody");
const VER = document.getElementById("ver");

const BTN_REFRESH = document.getElementById("refreshBtn");
const BTN_EXPORT = document.getElementById("exportCsv");
const FILTER = document.getElementById("filter");

const MODAL = document.getElementById("modalEdit");
const CLOSE_MODAL = document.getElementById("closeModal");
const SAVE_EDIT = document.getElementById("saveEdit");

const F_dept = document.getElementById("m_dept");
const F_name = document.getElementById("m_name");
const F_phone = document.getElementById("m_phone");
const F_building = document.getElementById("m_building");
const F_floor = document.getElementById("m_floor");
const F_room = document.getElementById("m_room");
const F_packs = document.getElementById("m_packs");
const F_target = document.getElementById("m_target");

let currentRecords = [];
let editingIndex = null;

/* כלי דיבוג למסך */
function debugLog(...args){
  const time = new Date().toLocaleTimeString();
  DEBUG.textContent =
    `[${time}] ` +
    args.map(a => (typeof a === 'object' ? JSON.stringify(a) : a)).join(" | ") +
    "\n" +
    DEBUG.textContent;
}

/* סטטוס למעלה */
function setStatus(msg, type){
  STATUS_TOP.style.display = "block";
  STATUS_TOP.className = "status " + (type === "err" ? "err" : "ok");
  STATUS_TOP.textContent = msg;
}
function clearStatus(){
  STATUS_TOP.style.display = "none";
}

/* קריאת תוכן ה-BIN */
async function fetchBinLatest(){
  clearStatus();
  debugLog("מנסה לקרוא BIN:", BIN_ID);

  const url = `${API_BASE}/${BIN_ID}/latest`;
  try{
    const res = await fetch(url, {
      method: "GET",
      headers: {
        "Content-Type":"application/json",
        "X-Access-Key": ACCESS_KEY
      }
    });
    const txt = await res.text();
    debugLog("GET", url, "status="+res.status, "body=", txt);

    if(!res.ok){
      setStatus(`שגיאה בטעינה: status=${res.status} body=${txt}`, "err");
      LIST_BODY.innerHTML = `<tr><td colspan="10" class="small" style="color:#ffb8b8">שגיאה בטעינה</td></tr>`;
      return;
    }

    // parse
    const j = JSON.parse(txt);
    // בפורמט של jsonbin v3: לרוב j.record הוא הנתון
    let data = j.record || j.data || j;
    // אם data.answers הוא מערך - זה המידע
    // אם data עצמו מערך - זה המידע
    // אם זה אובייקט יחיד - נהפוך למערך של רשומה אחת
    let records = [];
    if(Array.isArray(data)){
      records = data;
    } else if (Array.isArray(data.answers)){
      records = data.answers;
    } else {
      records = [data];
    }

    currentRecords = records;
    renderList(records);
    setStatus(`✅ נטען ${records.length} רשומות`, "ok");
  }catch(err){
    debugLog("fetch error:", err);
    setStatus("שגיאת רשת בטעינה: "+(err.message||err),"err");
    LIST_BODY.innerHTML = `<tr><td colspan="10" class="small" style="color:#ffb8b8">שגיאת רשת</td></tr>`;
  }
}

/* שליחת כל המערך חזרה לשרת ב-PUT כדי לשמור שינויים */
async function putBin(dataArr){
  const url = `${API_BASE}/${BIN_ID}`;
  const payload = { answers: dataArr };

  try{
    debugLog("PUT", url, "len="+dataArr.length, payload);
    const res = await fetch(url, {
      method: "PUT",
      headers: {
        "Content-Type":"application/json",
        "X-Access-Key": ACCESS_KEY
      },
      body: JSON.stringify(payload)
    });
    const txt = await res.text();
    debugLog("PUT result status="+res.status, "body=", txt);

    if(!res.ok){
      setStatus(`שגיאה בשמירה: status=${res.status} body=${txt}`, "err");
      return false;
    }

    setStatus("✅ נשמר בהצלחה בענן","ok");
    return true;
  }catch(e){
    debugLog("PUT error:", e);
    setStatus("שגיאת רשת בשמירה: "+(e.message||e),"err");
    return false;
  }
}

/* ציור הטבלה */
function renderList(records){
  LIST_BODY.innerHTML = "";
  if(!records || records.length===0){
    LIST_BODY.innerHTML = `<tr><td colspan="10" class="small">אין רשומות להצגה</td></tr>`;
    return;
  }

  records.forEach((r, idx)=>{
    const dept = r.dept || r.department || r.מחלקה || "";
    const name = r.workerName || r.name || r.שם || "";
    const phone = r.phone || r.phoneNumber || r.מספר || "";
    const building = r.building || r.מבנה || "";
    const floor = r.floor || r.קומה || "";
    const room = r.room || r.roomNumber || r.מספר_חדר || "";
    const packs = r.packs || r.packsCount || r.אריזות || "";
    const target = r.targetRoom || r.target || r.יעד || "";
    const ts = r.ts || r.created || r.timestamp || "";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(dept)}</td>
      <td>${escapeHtml(name)}</td>
      <td>${escapeHtml(phone)}</td>
      <td>${escapeHtml(building)}</td>
      <td>${escapeHtml(floor)}</td>
      <td>${escapeHtml(room)}</td>
      <td>${escapeHtml(packs)}</td>
      <td>${escapeHtml(target)}</td>
      <td class="small">${ts ? escapeHtml(formatTs(ts)) : ""}</td>
      <td class="actions">
        <button class="btn ghost" data-idx="${idx}" data-act="edit">ערוך</button>
        <button class="btn" data-idx="${idx}" data-act="del">מחק</button>
      </td>
    `;
    LIST_BODY.appendChild(tr);
  });

  // חבר מאזינים ללחצנים בכל שורה
  LIST_BODY.querySelectorAll("button").forEach(btn=>{
    btn.addEventListener("click", async (e)=>{
      const idx = parseInt(btn.dataset.idx,10);
      const act = btn.dataset.act;
      if(act==="edit"){
        openEdit(idx);
      }else if(act==="del"){
        if(!confirm("אתה בטוח שאתה רוצה למחוק את הרשומה הזאת?")) return;
        await deleteRecord(idx);
      }
    });
  });
}

/* פונקציות עזר */
function escapeHtml(s){
  if(s===null||s===undefined) return "";
  return String(s).replace(/[&<>"']/g, m => (
    {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]
  ));
}
function formatTs(ts){
  // אם זה ISO -> תרגום
  const d = new Date(ts);
  if(!isNaN(d)) return d.toLocaleString("he-IL");
  return ts;
}

/* חיפוש (פילטר) */
FILTER.addEventListener("input", ()=>{
  const q = FILTER.value.trim().toLowerCase();
  if(!q){
    renderList(currentRecords);
    return;
  }
  const filtered = currentRecords.filter(r=>{
    const blob = JSON.stringify(r).toLowerCase();
    return blob.includes(q);
  });
  renderList(filtered);
});

/* רענון ידני */
BTN_REFRESH.addEventListener("click", ()=>fetchBinLatest());

/* ייצוא CSV */
BTN_EXPORT.addEventListener("click", ()=>{
  if(!currentRecords || currentRecords.length===0){
    alert("אין נתונים לייצוא"); 
    return;
  }
  const keys = ["dept","workerName","phone","building","floor","room","packs","targetRoom","ts"];
  const rows = [keys.join(",")];
  currentRecords.forEach(rec=>{
    const line = keys.map(k=>{
      const v = rec[k] || "";
      return `"${String(v).replace(/"/g,'""')}"`;
    }).join(",");
    rows.push(line);
  });
  const csv = rows.join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "moa_data.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

/* --- עריכה --- */
function openEdit(idx){
  editingIndex = idx;
  const r = currentRecords[idx] || {};

  F_dept.value = r.dept || r.department || r.מחלקה || F_dept.value || "מחמ";
  F_name.value = r.workerName || r.name || r.שם || "";
  F_phone.value = r.phone || r.phoneNumber || r.מספר || "";
  F_building.value = r.building || r.מבנה || "";
  F_floor.value = r.floor || r.קומה || "";
  F_room.value = r.room || r.roomNumber || r.מספר_חדר || "";
  F_packs.value = r.packs || r.packsCount || r.אריזות || "1";
  F_target.value = r.targetRoom || r.target || r.יעד || "";

  MODAL.style.display = "flex";
}

// סגירת מודאל
CLOSE_MODAL.addEventListener("click", ()=>{
  editingIndex = null;
  MODAL.style.display = "none";
});

// שמירת עריכה
SAVE_EDIT.addEventListener("click", async ()=>{
  if(editingIndex === null) return;
  const r = currentRecords[editingIndex] || {};
  r.dept = F_dept.value;
  r.workerName = F_name.value;
  r.phone = F_phone.value;
  r.building = F_building.value;
  r.floor = F_floor.value;
  r.room = F_room.value;
  r.packs = F_packs.value;
  r.targetRoom = F_target.value;
  r.ts = new Date().toISOString();

  currentRecords[editingIndex] = r;

  const ok = await putBin(currentRecords);
  if(ok){
    MODAL.style.display = "none";
    editingIndex = null;
    await fetchBinLatest();
  }
});

/* מחיקה */
async function deleteRecord(idx){
  currentRecords.splice(idx,1);
  const ok = await putBin(currentRecords);
  if(ok){
    await fetchBinLatest();
  }
}

/* הפעלה ראשונית */
(async function init(){
  VER.textContent = "1.0.0";
  debugLog("מאתחל moadata.html גרסה 1.0.0 עם BIN", BIN_ID);
  await fetchBinLatest();
})();
</script>
</body>
</html>
