<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <title>××—×•×œ×œ ×‘×¨ ××¦×•×•×” - ×¡×•×¤×™</title>

  <link href="https://fonts.googleapis.com/css2?family=Frank+Ruhl+Libre:wght@400;500;700;900&family=Rubik:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <style>
    :root { --text-brown:#8B5E3C; }

    html, body{
      margin:0; padding:0;
      width:100%; height:100%;
      overflow:hidden;
      background:#111;
      font-family:'Rubik', sans-serif;
      -webkit-text-size-adjust:100%;
    }

    .app{
      position:fixed;
      inset:0;
      display:grid;
      place-items:center;
      background:#111;
      padding-top: env(safe-area-inset-top);
      padding-right: env(safe-area-inset-right);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
    }

    .stage{
      width:100%;
      height:100%;
      display:grid;
      place-items:center;
      overflow:hidden;
      box-sizing:border-box;
      padding:8px;
      position:relative; /* ×—×©×•×‘ */
    }

    /* --- ××™×–×•×¨ ×”×ª×¦×•×’×” (×”×§×•××¤×•×–×™×¦×™×”) --- */
    .preview-area{
      position:absolute;
      left:50%;
      top:50%;
      background:#fff;
      box-shadow: 0 0 40px rgba(0,0,0,0.55);
      overflow:hidden;
      transform-origin:center center;
      will-change: transform;
      user-select:none;
      touch-action: manipulation;
    }

    /* ×—×©×•×‘: ×ª××™×“ ×œ××œ× ××ª ×”×§×•××¤×•×–×™×¦×™×” */
    #bgImage{
      display:block;
      width:100%;
      height:100%;
      object-fit: contain; /* ×œ× ×—×•×ª×š ×•×œ× ××¢×•×•×ª */
      pointer-events:none;
    }

    /* --- ××œ×× ×˜×™× ××§×•×‘×¢×™× --- */
    .final-element{
      position:absolute;
      transform-origin:center center;
      text-align:center;
      color:var(--text-brown);
      white-space:nowrap;
      filter: blur(0.4px);
      transform: translate(-50%, -50%);
    }

    /* --- ×¢×™×¦×•×‘ ×”×˜×§×¡×˜×™× (××§×•×¨×™) --- */
    .bsd-txt { font-size: 14px; font-weight: 400; font-family: 'Rubik'; }
    .header-txt { font-size: 28px; font-weight: 700; line-height: 1; margin-bottom: 5px; font-family: 'Rubik'; }
    .name-txt { font-family: 'Rubik', sans-serif; font-size: 55px; font-weight: 700; line-height: 1; }
    .intro-txt { font-size: 15px; line-height: 1.3; font-weight: 400; margin-top: 10px; }
    .date-txt { font-family: 'Frank Ruhl Libre', serif; font-size: 40px; font-weight: 700; letter-spacing: 1px; margin-top: 5px; }
    .loc-title-txt { font-size: 26px; font-weight: 700; }
    .address-txt { font-size: 16px; font-weight: 500; }
    .time-txt { font-family: 'Frank Ruhl Libre', serif; font-size: 22px; font-weight: 700; }
    .family-txt { font-size: 18px; font-weight: 500; }

    /* ===== ×›×¤×ª×•×¨ ×¦×£ ×œ×¤×ª×™×—×” ===== */
    .btn-gear{
      position:fixed;
      z-index:2600;
      right: calc(env(safe-area-inset-right) + 12px);
      bottom: calc(env(safe-area-inset-bottom) + 12px);
      width:56px; height:56px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.22);
      background: rgba(30,30,30,0.92);
      color:#fff;
      font-size:22px;
      font-weight:900;
      display:grid;
      place-items:center;
      backdrop-filter: blur(10px);
      cursor:pointer;
    }

    /* ===== ×©×›×‘×ª ×¨×§×¢ ×›×©×”×ª×¤×¨×™×˜ ×¤×ª×•×— ===== */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.55);
      z-index:2400;
      opacity:0;
      pointer-events:none;
      transition: opacity 180ms ease;
    }
    .overlay.open{
      opacity:1;
      pointer-events:auto;
    }

    /* ===== ×ª×¤×¨×™×˜ ×›×¨×˜×™×¡ ×‘×××¦×¢ ×”××¡×š ===== */
    .controls{
      position:fixed;
      z-index:2500;
      left:50%;
      top:50%;
      transform: translate(-50%, -50%) scale(0.98);
      width: min(420px, calc(100vw - 24px));
      max-height: min(72vh, 560px);
      overflow:auto;

      background: rgba(45,45,45,0.96);
      border:1px solid rgba(160,160,160,0.30);
      border-radius:18px;
      padding:14px 14px calc(14px + env(safe-area-inset-bottom));
      box-sizing:border-box;
      color:#fff;
      backdrop-filter: blur(12px);

      opacity:0;
      pointer-events:none;
      transition: opacity 180ms ease, transform 180ms ease;
      -webkit-overflow-scrolling: touch;
    }
    .controls.open{
      opacity:1;
      pointer-events:auto;
      transform: translate(-50%, -50%) scale(1);
    }

    .controls-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      align-items:start;
      justify-items:stretch;
    }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    .input-group{ display:flex; flex-direction:column; gap:6px; }
    label{ font-size:0.9rem; color:#eee; }

    input[type="text"], input[type="date"], input[type="time"]{
      padding:12px 12px;
      border-radius:12px;
      border:none;
      font-family:'Rubik', sans-serif;
      width:100%;
      font-size:1rem;
      outline:none;
      box-sizing:border-box;
    }

    button{
      background:#4CAF50;
      color:#fff;
      border:none;
      padding:13px 16px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      height:48px;
      font-size:1.05rem;
      width:100%;
    }
    .btn-mode{ background:#2d6cdf; }
  </style>
</head>

<body>
  <div class="app">
    <div class="stage">
      <div class="preview-area" id="captureTarget">
        <img id="bgImage" src="bar2.jpg" onerror="alert('×—×¡×¨×” ×ª××•× ×” bar2.jpg')" alt="×¨×§×¢">

        <div class="final-element" style="left: 41.0%; top: 24.3%; transform: translate(-50%, -50%) rotate(-10.0deg);">
          <div class="bsd-txt">×‘×¡"×“</div>
        </div>

        <div class="final-element" style="left: 28.3%; top: 31.4%; transform: translate(-50%, -50%) rotate(-9.5deg);">
          <div class="header-txt" id="headerText">×‘×¨ ×”××¦×•×•×” ×©×œ</div>
        </div>

        <div class="final-element" style="left: 29.5%; top: 36.3%; transform: translate(-50%, -50%) rotate(-10.0deg);">
          <div class="name-txt" id="nameText">×”×¨××œ ×©×§×“</div>
        </div>

        <div class="final-element" style="left: 30.6%; top: 43.6%; transform: translate(-50%, -50%) rotate(-11.0deg);">
          <div class="intro-txt">
            ×× ×• ×©××—×™× ×œ×”×–××™× ×›× ×œ×—×’×•×’ ×¢×™×× ×•<br>
            ××ª ×©××—×ª ×‘×¨ ×”××¦×•×•×” ×©×œ ×‘× × ×• ×”×™×§×¨<br>
            ×©×™×™×¢×¨×š ××™"×” ×‘×™×•× <span id="dayName">×¨×‘×™×¢×™</span>, <span id="hebDate">×‘' ×‘×©×‘×˜ ×ª×©×¤"×“</span>
          </div>
        </div>

        <div class="final-element" style="left: 32.1%; top: 52.3%; transform: translate(-50%, -50%) rotate(-11.5deg);">
          <div class="date-txt" id="dateText">06.02.2024</div>
        </div>

        <div class="final-element" style="left: 32.6%; top: 58.6%; transform: translate(-50%, -50%) rotate(-12.0deg);">
          <div class="loc-title-txt" id="locTitleText">××•×œ××™ ×”××—×•×–×”</div>
        </div>

        <div class="final-element" style="left: 34.3%; top: 62.6%; transform: translate(-50%, -50%) rotate(-11.5deg);">
          <div class="address-txt" id="addressText">×”×ª×¢×©×™×™×” 14, ×”×¨×¦×œ×™×”</div>
        </div>

        <div class="final-element" style="left: 35.5%; top: 66.9%; transform: translate(-50%, -50%) rotate(-10.5deg);">
          <div class="time-txt" id="timeText">19:30</div>
        </div>

        <div class="final-element" style="left: 38.2%; top: 78.0%; transform: translate(-50%, -50%) rotate(-11.5deg);">
          <div class="family-txt" id="familyText">××©×¤×—×ª ×©×§×“</div>
        </div>
      </div>
    </div>

    <button class="btn-gear" id="gearBtn" type="button" aria-label="×¤×ª×—/×¡×’×•×¨ ×©×œ×™×˜×”">âš™ï¸</button>
    <div class="overlay" id="overlay"></div>

    <div class="controls" id="controlsPanel" role="dialog" aria-modal="true" aria-label="×¢×¨×™×›×ª ×¤×¨×˜×™×">
      <div class="controls-grid">

        <button class="btn-mode" type="button" id="modeBtn">××¦×‘: FIT</button>

        <div class="input-group">
          <label>×›×•×ª×¨×ª:</label>
          <input type="text" value="×‘×¨ ×”××¦×•×•×” ×©×œ" oninput="updateText('headerText', this.value)">
        </div>

        <div class="input-group">
          <label>×©× ×”×™×œ×“:</label>
          <input type="text" value="×”×¨××œ ×©×§×“" oninput="updateText('nameText', this.value)">
        </div>

        <div class="row2">
          <div class="input-group">
            <label>×ª××¨×™×š:</label>
            <input type="date" id="dateInput">
          </div>
          <div class="input-group">
            <label>×©×¢×”:</label>
            <input type="time" value="19:30" oninput="updateText('timeText', this.value)">
          </div>
        </div>

        <div class="input-group">
          <label>×©× ×”××•×œ×:</label>
          <input type="text" value="××•×œ××™ ×”××—×•×–×”" oninput="updateText('locTitleText', this.value)">
        </div>

        <div class="input-group">
          <label>×›×ª×•×‘×ª:</label>
          <input type="text" value="×”×ª×¢×©×™×™×” 14, ×”×¨×¦×œ×™×”" oninput="updateText('addressText', this.value)">
        </div>

        <div class="input-group">
          <label>×—×ª×™××”:</label>
          <input type="text" value="××©×¤×—×ª ×©×§×“" oninput="updateText('familyText', this.value)">
        </div>

        <button type="button" onclick="saveImage()">ğŸ“· ×©××•×¨</button>
      </div>
    </div>
  </div>

  <script>
    // ×—×¡×™××ª pinch-to-zoom + double-tap zoom
    document.addEventListener('gesturestart', e => e.preventDefault(), { passive:false });
    document.addEventListener('gesturechange', e => e.preventDefault(), { passive:false });
    document.addEventListener('gestureend', e => e.preventDefault(), { passive:false });

    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (e) {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) e.preventDefault();
      lastTouchEnd = now;
    }, { passive:false });

    // ×¤×ª×™×—×”/×¡×’×™×¨×” ×ª×¤×¨×™×˜
    const controlsPanel = document.getElementById('controlsPanel');
    const overlay = document.getElementById('overlay');
    const gearBtn = document.getElementById('gearBtn');

    function openMenu(){ controlsPanel.classList.add('open'); overlay.classList.add('open'); }
    function closeMenu(){ controlsPanel.classList.remove('open'); overlay.classList.remove('open'); }

    gearBtn.addEventListener('click', () => {
      if (controlsPanel.classList.contains('open')) closeMenu();
      else openMenu();
    });
    overlay.addEventListener('click', closeMenu);

    // ××¦×‘ ×ª×¦×•×’×” FIT / FILL
    let VIEW_MODE = 'FIT';
    const modeBtn = document.getElementById('modeBtn');
    modeBtn.addEventListener('click', () => {
      VIEW_MODE = (VIEW_MODE === 'FIT') ? 'FILL' : 'FIT';
      modeBtn.textContent = `××¦×‘: ${VIEW_MODE}`;
      fitToScreen();
    });

    function fitToScreen(){
      const capture = document.getElementById('captureTarget');
      const img = document.getElementById('bgImage');
      const stage = document.querySelector('.stage');

      const nw = img.naturalWidth || 0;
      const nh = img.naturalHeight || 0;
      if (!nw || !nh) return;

      // ×”×§×•××¤×•×–×™×¦×™×” ×ª××™×“ ×‘×’×•×“×œ ×”××§×•×¨×™
      capture.style.width  = nw + 'px';
      capture.style.height = nh + 'px';

      const vv = window.visualViewport;
      const rect = stage.getBoundingClientRect();
      let availW = rect.width;
      let availH = rect.height;
      if (vv) { availW = Math.min(availW, vv.width); availH = Math.min(availH, vv.height); }

      const pad = 8;
      availW = Math.max(50, availW - pad*2);
      availH = Math.max(50, availH - pad*2);

      const sContain = Math.min(availW / nw, availH / nh);
      const sCover   = Math.max(availW / nw, availH / nh);
      const scale = (VIEW_MODE === 'FILL') ? sCover : sContain;

      capture.style.transform = `translate(-50%, -50%) scale(${scale})`;
    }

    function updateText(elementId, val){
      const el = document.getElementById(elementId);
      if (el) el.innerText = val;
    }

    function toGematria(num){
      const letters = ['', '×', '×‘', '×’', '×“', '×”', '×•', '×–', '×—', '×˜', '×™', '×™×', '×™×‘', '×™×’', '×™×“', '×˜×•', '×˜×–', '×™×–', '×™×—', '×™×˜', '×›', '×›×', '×›×‘', '×›×’', '×›×“', '×›×”', '×›×•', '×›×–', '×›×—', '×›×˜', '×œ', '×œ×'];
      return num > 30 ? num : letters[num];
    }

    document.getElementById('dateInput').addEventListener('change', function(){
      if (!this.value) return;
      const d = new Date(this.value);

      const parts = new Intl.DateTimeFormat('he-IL-u-ca-hebrew', { weekday:'long', month:'long', day:'numeric' }).formatToParts(d);
      let weekday='', month='', dayNum=0;
      parts.forEach(p => {
        if (p.type==='weekday') weekday=p.value;
        if (p.type==='month') month=p.value;
        if (p.type==='day') dayNum=parseInt(p.value,10);
      });

      document.getElementById('dayName').innerText = weekday.replace('×™×•× ', '');
      document.getElementById('hebDate').innerText = `${toGematria(dayNum)} ×‘${month} ×ª×©×¤"×“`;

      const gDate = `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`;
      document.getElementById('dateText').innerText = gDate;
    });

    async function saveImage(){
      const original = document.getElementById('captureTarget');
      const img = document.getElementById('bgImage');

      const nw = img.naturalWidth || 0;
      const nh = img.naturalHeight || 0;
      if (!nw || !nh) { alert('×”×¨×§×¢ ×¢×“×™×™×Ÿ ×œ× × ×˜×¢×Ÿ ×œ×’××¨×™. × ×¡×” ×©×•×‘ ×‘×¢×•×“ ×©× ×™×™×”.'); return; }

      // Clone × ×¡×ª×¨ ××—×•×¥ ×œ××¡×š â€” ×‘×œ×™ ×©×•× overflow ×©×—×•× ×§
      const clone = original.cloneNode(true);
      clone.style.position = 'fixed';
      clone.style.left = '-100000px';
      clone.style.top = '0';
      clone.style.transform = 'none';
      clone.style.width = nw + 'px';
      clone.style.height = nh + 'px';
      clone.style.boxShadow = 'none';
      clone.style.overflow = 'hidden';
      clone.style.background = '#fff';

      // ×œ×× ×•×¢ ×”×ª× ×’×©×•×™×•×ª id ×‘×–××Ÿ ×”×§×œ×•×Ÿ
      clone.querySelectorAll('[id]').forEach(el => el.removeAttribute('id'));

      // ×œ×•×•×“× ×ª××•× ×” ×‘×§×œ×•×Ÿ ×××œ××ª 100%Ã—100%
      const cimg = clone.querySelector('img');
      if (cimg) {
        cimg.style.width = '100%';
        cimg.style.height = '100%';
        cimg.style.objectFit = 'contain';
        cimg.style.display = 'block';
      }

      document.body.appendChild(clone);

      // ×œ×”××ª×™×Ÿ ×œ×ª××•× ×” ×‘×§×œ×•×Ÿ (×‘××•×‘×™×™×œ ×–×” ×§×¨×™×˜×™)
      await new Promise(resolve => {
        if (!cimg) return resolve();
        if (cimg.complete && cimg.naturalWidth) return resolve();
        cimg.onload = () => resolve();
        cimg.onerror = () => resolve();
      });

      try {
        const canvas = await html2canvas(clone, { useCORS:true, scale:2, backgroundColor:null });
        const link = document.createElement('a');
        link.download = "bar_mitzvah_final.jpg";
        link.href = canvas.toDataURL("image/jpeg", 0.92);
        link.click();
      } finally {
        clone.remove();
      }
    }

    // init ×××™×Ÿ ×’× ×× ×”×ª××•× ×” × ×˜×¢× ×” ×œ×¤× ×™ ×©×”×•×¡×¤× ×• listener
    const bg = document.getElementById('bgImage');
    function kickFit() { requestAnimationFrame(fitToScreen); }
    bg.addEventListener('load', kickFit);
    document.addEventListener('DOMContentLoaded', kickFit);

    // ×× × ×˜×¢×Ÿ ××”-cache
    if (bg.complete && bg.naturalWidth) {
      setTimeout(kickFit, 0);
      setTimeout(kickFit, 120);
    }

    window.addEventListener('resize', kickFit);
    window.addEventListener('orientationchange', () => { setTimeout(kickFit,150); setTimeout(kickFit,550); });

    if (window.visualViewport){
      window.visualViewport.addEventListener('resize', kickFit);
      window.visualViewport.addEventListener('scroll', kickFit);
    }
  </script>
</body>
</html>
