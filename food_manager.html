<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Food Manager â€“ × ×™×”×•×œ ×ª×¤×¨×™×˜ ××©×¤×—×ª×™</title>
<style>
:root{
  --bg-page:#fffaf0;
  --panel-bg:#ffffff;
  --border:#e2d7b8;
  --text-main:#333;
  --text-dim:#666;
  --green:#3c7a4c;
  --green-dark:#2e5f3b;
  --gold:#c59d2f;
  --err-bg:#a01919;
  --ok-bg:#2e7d32;
  --radius:16px;
  --shadow:0 8px 24px rgba(0,0,0,0.12);
  --shadow-inner:0 0 10px rgba(0,0,0,0.08) inset;
  --btn-bg:#3c7a4c;
  --btn-text:#fff;

  --block-orders-bg:#eef9f1;
  --block-orders-border:#b8dfc2;
  --block-orders-head:#2e7d32;

  --block-event-bg:#eaf4ff;
  --block-event-border:#b7cceb;
  --block-event-head:#355c9b;

  --block-codes-bg:#fff8e6;
  --block-codes-border:#e9d39a;
  --block-codes-head:#b58900;

  --block-menu-bg:#fff0ef;
  --block-menu-border:#e3b3ad;
  --block-menu-head:#a34a3a;
}

body{
  margin:0;
  background:var(--bg-page);
  font-family:"Heebo",Arial,sans-serif;
  color:var(--text-main);
  display:flex;
  justify-content:center;
  padding:16px;
  text-align:center;
}
.wrap{
  width:100%;
  max-width:1100px;
  background:var(--panel-bg);
  border-radius:var(--radius);
  border:2px solid var(--border);
  box-shadow:var(--shadow);
  padding:20px 16px 32px;
  text-align:initial;
}
h1{
  margin:0;
  font-size:26px;
  font-weight:700;
  color:var(--green);
  text-align:center;
  line-height:1.3;
}

/* ×¤×¡ ×¡×˜×˜×•×¡ */
#statusBox{
  display:none;
  border-radius:var(--radius);
  padding:10px 14px;
  margin-top:12px;
  font-size:16px;
  font-weight:600;
  color:#fff;
  line-height:1.4;
  text-align:center;
}
#statusBox.ok{background:var(--ok-bg);}
#statusBox.err{background:var(--err-bg);}

/* ×›×¤×ª×•×¨×™ ×©×œ×™×˜×” ×¢×œ×™×•× ×™× */
.controlsBar{
  margin-top:16px;
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:flex-start;
  justify-content:space-between;
  text-align:right;
}
.leftControls,
.rightControls{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
}
button.actionBtn{
  background:var(--btn-bg);
  color:var(--btn-text);
  border:0;
  border-radius:var(--radius);
  font-size:16px;
  font-weight:700;
  padding:10px 14px;
  box-shadow:var(--shadow);
  cursor:pointer;
}
button.actionBtn:active{background:var(--green-dark);}
#formToggle.online{
  background:var(--green);
  color:#fff;
}
#formToggle.offline{
  background:#a01919;
  color:#fff;
}
.searchWrap{
  display:flex;
  flex-wrap:nowrap;
  align-items:center;
  gap:8px;
}
.searchWrap input{
  background:#fff;
  border:2px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow-inner);
  padding:10px 12px;
  font-size:16px;
  color:var(--text-main);
  min-width:200px;
  font-family:inherit;
}

/* ××§×•×¨×“×™×•×Ÿ ×‘×œ×•×§×™× */
.blockCard{
  border-radius:var(--radius);
  border-width:2px;
  border-style:solid;
  margin-top:20px;
  overflow:hidden;
  box-shadow:var(--shadow-inner);
}
.blockHeaderBtn{
  width:100%;
  text-align:right;
  border:0;
  padding:16px;
  background:transparent;
  display:flex;
  flex-wrap:nowrap;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
  cursor:pointer;
}
.blockHeaderBtn h2{
  margin:0;
  font-size:20px;
  font-weight:700;
  line-height:1.4;
}
.blockHeaderBtn .arrow{
  font-size:20px;
  line-height:1;
  font-weight:700;
  min-width:24px;
  text-align:left;
  transition:transform .4s ease-in-out;
}
.blockBodyOuter{
  background:#fff;
  padding:0 16px 16px;
  max-height:0;
  overflow:hidden;
  transition:max-height .4s ease-in-out;
  border-top:2px solid transparent;
}
.blockBodyInner{
  padding-top:16px;
}

/* ×¦×‘×¢×™× ×©×•× ×™× ×œ×›×œ ×‘×œ×•×§ */
.blockOrders{
  background:var(--block-orders-bg);
  border-color:var(--block-orders-border);
}
.blockOrders .blockHeaderBtn h2{color:var(--block-orders-head);}
.blockOrders .blockBodyOuter{
  background:var(--block-orders-bg);
  border-top-color:var(--block-orders-border);
}

.blockEvent{
  background:var(--block-event-bg);
  border-color:var(--block-event-border);
}
.blockEvent .blockHeaderBtn h2{color:var(--block-event-head);}
.blockEvent .blockBodyOuter{
  background:var(--block-event-bg);
  border-top-color:var(--block-event-border);
}

.blockCodes{
  background:var(--block-codes-bg);
  border-color:var(--block-codes-border);
}
.blockCodes .blockHeaderBtn h2{color:var(--block-codes-head);}
.blockCodes .blockBodyOuter{
  background:var(--block-codes-bg);
  border-top-color:var(--block-codes-border);
}

.blockMenu{
  background:var(--block-menu-bg);
  border-color:var(--block-menu-border);
}
.blockMenu .blockHeaderBtn h2{color:var(--block-menu-head);}
.blockMenu .blockBodyOuter{
  background:var(--block-menu-bg);
  border-top-color:var(--block-menu-border);
}

/* ×¤×ª×•×— */
.blockCard.open .blockBodyOuter{
  max-height:2000px;
}
.blockCard.open .blockHeaderBtn .arrow{
  transform:rotate(90deg);
}

/* ×˜×‘×œ××•×ª */
.tableWrap{
  background:#fff;
  border:2px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow-inner);
  margin-top:16px;
  overflow-x:auto;
}
table{
  border-collapse:collapse;
  width:100%;
  min-width:900px;
  font-size:14px;
  color:var(--text-main);
  border-radius:var(--radius);
}
thead{
  background:var(--bg-page);
  color:var(--green);
  font-weight:700;
}
th,td{
  text-align:center;
  padding:10px 6px;
  border-bottom:1px solid var(--border);
  white-space:nowrap;
  font-family:inherit;
}
tbody tr:nth-child(even){background:#faf8f0;}
tbody tr:nth-child(odd){background:#ffffff;}
td.actionsCell button,
.smallTable td button,
.whatsappBtn{
  background:#c59d2f;
  color:#000;
  border:0;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  font-size:13px;
  font-weight:700;
  padding:6px 10px;
  cursor:pointer;
}
td.actionsCell button:active,
.smallTable td button:active,
.whatsappBtn:active{
  filter:brightness(0.9);
}

/* ×˜×‘×œ×ª ×§×•×“×™× */
.codeMapTableWrap{overflow-x:auto;}
.smallTable{
  width:100%;
  min-width:480px;
  border-collapse:collapse;
  font-size:14px;
}
.smallTable th{
  background:var(--bg-page);
  color:var(--green);
  font-weight:700;
  text-align:center;
  border-bottom:1px solid var(--border);
  padding:8px;
}
.smallTable td{
  text-align:center;
  border-bottom:1px solid var(--border);
  padding:8px;
}

/* ×©×•×¨×•×ª ×”×•×¡×¤×”/×¢×¨×™×›×” */
.addRow{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:12px;
}
.addRow input{
  flex:1;
  min-width:160px;
  background:#fff;
  border:2px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow-inner);
  padding:8px 10px;
  font-size:14px;
  font-family:inherit;
}
.addRow button{
  background:var(--green);
  color:#fff;
  border:0;
  border-radius:var(--radius);
  padding:10px 14px;
  font-size:14px;
  font-weight:700;
  cursor:pointer;
  box-shadow:var(--shadow);
}
.addRow button:active{background:var(--green-dark);}

/* ×¤×¨×˜×™ ××™×¨×•×¢ */
.eventRow{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  margin-top:12px;
}
.eventGroup{
  display:flex;
  flex-direction:column;
  min-width:180px;
  flex:1;
}
.eventGroup label{
  font-size:14px;
  font-weight:600;
  color:var(--text-main);
  margin-bottom:4px;
}
.eventGroup input{
  background:#fff;
  border:2px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow-inner);
  padding:10px 12px;
  font-size:14px;
  font-family:inherit;
  width:100%;
}

/* × ×™×”×•×œ ×ª×¤×¨×™×˜ */
.menuCatWrap{
  margin-top:16px;
  border:2px solid var(--border);
  border-radius:var(--radius);
  padding:12px;
  background:#fff;
  box-shadow:var(--shadow-inner);
}
.menuCatHeader{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  flex-wrap:wrap;
  gap:8px;
}
.menuCatHeader h3{
  margin:0;
  font-size:16px;
  font-weight:700;
  color:var(--green-dark);
}
.menuList{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  margin-top:12px;
}
.menuItemTag{
  display:flex;
  align-items:center;
  gap:6px;
  background:#faf8f0;
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:6px 10px;
  font-size:14px;
  line-height:1.4;
}
.menuItemTag button{
  background:#a01919;
  color:#fff;
  border:0;
  border-radius:var(--radius);
  padding:4px 8px;
  font-size:12px;
  line-height:1.2;
  cursor:pointer;
}

/* ×¤×•×˜×¨ */
.footerInfo{
  text-align:center;
  font-size:13px;
  color:var(--text-dim);
  margin-top:24px;
}
</style>
</head>
<body>
<div class="wrap">
  <h1>× ×™×”×•×œ ×ª×¤×¨×™×˜ â€“ Food Manager</h1>

  <div id="statusBox"></div>

  <div class="controlsBar">
    <div class="leftControls">
      <button id="formToggle" class="actionBtn online">ONLINE</button>
      <button id="refreshBtn" class="actionBtn">×¨×¢× ×Ÿ</button>
      <button id="csvBtn" class="actionBtn">×™×™×¦×•× CSV</button>
    </div>

    <div class="rightControls">
      <div class="searchWrap">
        <input id="searchInput" type="text" placeholder="×—×¤×©â€¦ ×§×•×“ / ××©×¤×—×” / ×× ×” / ×©×ª×™×™×” / ×§×™× ×•×—">
      </div>
    </div>
  </div>

  <!-- ×‘×œ×•×§ 1: ×‘×—×™×¨×•×ª ×©× ×©×œ×—×• -->
  <div class="blockCard blockOrders" data-block="orders">
    <button class="blockHeaderBtn" type="button">
      <h2>×‘×—×™×¨×•×ª ×©× ×©×œ×—×•</h2>
      <div class="arrow">â–¶</div>
    </button>
    <div class="blockBodyOuter">
      <div class="blockBodyInner">
        <div class="tableWrap">
          <table id="answersTable">
            <thead>
              <tr>
                <th>×§×•×“</th>
                <th>××©×¤×—×”</th>
                <th>×× ×”</th>
                <th>×¤×—××™××”</th>
                <th>×¡×œ×˜ 1</th>
                <th>×¡×œ×˜ 2</th>
                <th>×©×ª×™×™×”</th>
                <th>×§×™× ×•×—</th>
                <th>×ª××¨×™×š/×©×¢×”</th>
                <th>×¤×¢×•×œ×•×ª</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <tr><td colspan="10" style="text-align:center;color:#777;">×˜×•×¢×Ÿâ€¦</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ×‘×œ×•×§ 2: ×¤×¨×˜×™ ××™×¨×•×¢ -->
  <div class="blockCard blockEvent" data-block="event">
    <button class="blockHeaderBtn" type="button">
      <h2>×¤×¨×˜×™ ××™×¨×•×¢ (××™×§×•× + ×ª××¨×™×š)</h2>
      <div class="arrow">â–¶</div>
    </button>
    <div class="blockBodyOuter">
      <div class="blockBodyInner">

        <div class="eventRow">
          <div class="eventGroup">
            <label for="eventLocationInput">××™×§×•×</label>
            <input id="eventLocationInput" type="text" placeholder="×œ×“×•×’××”: ××¦×œ ×¡×‘×ª× ×™×¤×” ×¨×—' ×”×¨×¦×œ 12 × ×”×¨×™×”">
          </div>
          <div class="eventGroup">
            <label for="eventDateInput">×ª××¨×™×š</label>
            <input id="eventDateInput" type="date">
          </div>
        </div>

        <div class="addRow">
          <button id="saveEventBtn" style="background:#c59d2f;color:#000;">×©××•×¨ ×¤×¨×˜×™ ××™×¨×•×¢</button>
        </div>

      </div>
    </div>
  </div>

  <!-- ×‘×œ×•×§ 3: ×§×•×“×™× -->
  <div class="blockCard blockCodes" data-block="codes">
    <button class="blockHeaderBtn" type="button">
      <h2>× ×™×”×•×œ ×§×•×“×™× (×§×™×©×•×¨ â†’ ×©× ××©×¤×—×”)</h2>
      <div class="arrow">â–¶</div>
    </button>
    <div class="blockBodyOuter">
      <div class="blockBodyInner">

        <div class="codeMapTableWrap">
          <table class="smallTable">
            <thead>
              <tr>
                <th>×§×•×“</th>
                <th>×©× ××©×¤×—×” ×œ×”×¦×’×”</th>
                <th>×•×•×¦××¤</th>
                <th>××—×§</th>
              </tr>
            </thead>
            <tbody id="codeMapBody"></tbody>
          </table>
        </div>

        <div class="addRow" style="margin-top:16px;">
          <input id="newCodeInput" type="text" placeholder="×§×•×“ (×œ×“×•×’××”: 3)">
          <input id="newFamilyInput" type="text" placeholder="×©× ×œ×”×¦×’×” (×œ×“×•×’××”: ××©×¤×—×ª ××œ×•×œ)">
          <button id="addCodeBtn">×”×•×¡×£ / ×¢×“×›×Ÿ ×§×•×“</button>
        </div>

        <div class="addRow">
          <button id="saveMapBtn" style="background:#c59d2f;color:#000;">×©××•×¨ ××™×¤×•×™ ×§×•×“×™×</button>
        </div>

      </div>
    </div>
  </div>

  <!-- ×‘×œ×•×§ 4: ×ª×¤×¨×™×˜ -->
  <div class="blockCard blockMenu" data-block="menu">
    <button class="blockHeaderBtn" type="button">
      <h2>× ×™×”×•×œ ×ª×¤×¨×™×˜ (×× ×•×ª ×œ×‘×—×™×¨×”)</h2>
      <div class="arrow">â–¶</div>
    </button>
    <div class="blockBodyOuter">
      <div class="blockBodyInner">

        <div id="menuSections"></div>

        <div class="addRow">
          <button id="saveMenuBtn" style="background:#c59d2f;color:#000;">×©××•×¨ ×ª×¤×¨×™×˜</button>
        </div>

      </div>
    </div>
  </div>

  <div class="footerInfo">×’×¨×¡×” 2.7 Â· food_manager.html</div>
</div>

<script>
// ===== ×”×’×“×¨×•×ª BIN =====
const BIN_ID     = "68ff447a43b1c97be9844c29";
const MASTER_KEY = "$2a$10$4rynniEMuvwqg2nDb5KSEe/lAVYp8a7L3xWzp9GsO6n49OfXc3FCO";
const API        = "https://api.jsonbin.io/v3/b";

// DOM ××œ×× ×˜×™×
const statusBox      = document.getElementById("statusBox");
const tableBody      = document.getElementById("tableBody");
const searchInput    = document.getElementById("searchInput");
const refreshBtn     = document.getElementById("refreshBtn");
const csvBtn         = document.getElementById("csvBtn");
const toggleBtn      = document.getElementById("formToggle");

const codeMapBody    = document.getElementById("codeMapBody");
const newCodeInput   = document.getElementById("newCodeInput");
const newFamilyInput = document.getElementById("newFamilyInput");
const addCodeBtn     = document.getElementById("addCodeBtn");
const saveMapBtn     = document.getElementById("saveMapBtn");

const menuSections   = document.getElementById("menuSections");
const saveMenuBtn    = document.getElementById("saveMenuBtn");

const eventLocationInput = document.getElementById("eventLocationInput");
const eventDateInput     = document.getElementById("eventDateInput");
const saveEventBtn       = document.getElementById("saveEventBtn");

let formOpen        = true;
let allChoices      = [];
let filteredChoices = [];
let codeMap         = {};
let menuOptions     = {};
let eventLocation   = "";
let eventDate       = "";

// ===== ××§×•×¨×“×™×•×Ÿ =====
function setupAccordion(){
  document.querySelectorAll(".blockCard").forEach(block=>{
    const headerBtn = block.querySelector(".blockHeaderBtn");
    const bodyOuter = block.querySelector(".blockBodyOuter");
    const arrowEl   = block.querySelector(".arrow");

    // ×”×ª×—×œ ×¡×’×•×¨
    bodyOuter.style.maxHeight = "0px";
    arrowEl.textContent = "â–¶";

    headerBtn.addEventListener("click", ()=>{
      const isOpen = block.classList.contains("open");
      if(isOpen){
        block.classList.remove("open");
        bodyOuter.style.maxHeight = "0px";
        arrowEl.textContent = "â–¶";
      }else{
        block.classList.add("open");
        bodyOuter.style.maxHeight = bodyOuter.scrollHeight + "px";
        arrowEl.textContent = "â–¼";
      }
    });

    block._recalcHeight = ()=>{
      if(block.classList.contains("open")){
        bodyOuter.style.maxHeight = bodyOuter.scrollHeight + "px";
      }
    };
  });
}
function recalcAccordionHeights(){
  document.querySelectorAll(".blockCard").forEach(block=>{
    if(block._recalcHeight){
      block._recalcHeight();
    }
  });
}

// ===== ×¢×•×–×¨×™ UI =====
function showStatus(msg, ok){
  statusBox.style.display="block";
  statusBox.className = ok ? "ok" : "err";
  statusBox.textContent=msg;
}
function prettyTS(s){
  const d=new Date(s);
  if(isNaN(d)) return "";
  const dd  = String(d.getDate()).padStart(2,"0");
  const mm  = String(d.getMonth()+1).padStart(2,"0");
  const yy  = d.getFullYear();
  const hh  = String(d.getHours()).padStart(2,"0");
  const min = String(d.getMinutes()).padStart(2,"0");
  return `${dd}.${mm}.${yy} ${hh}:${min}`;
}

// ===== ××©×™×›×” ××”×©×¨×ª =====
async function fetchAll(){
  try {
    const res = await fetch(`${API}/${BIN_ID}/latest`, {
      headers: { "X-Master-Key": MASTER_KEY }
    });
    const j = await res.json();

    formOpen      = j.record?.formOpen !== false;
    allChoices    = Array.isArray(j.record?.×‘×—×™×¨×•×ª) ? j.record.×‘×—×™×¨×•×ª : [];
    codeMap       = j.record?.map || {};
    menuOptions   = j.record?.menuOptions || {};
    eventLocation = j.record?.eventLocation || "";
    eventDate     = j.record?.eventDate || "";

    filteredChoices = [...allChoices];

    renderChoicesTable();
    renderToggleButton();
    renderCodeMapTable();
    renderMenuOptionsEditor();

    // ×œ××œ× ××ª ×©×“×•×ª ×”××™×¨×•×¢ ×‘×‘×œ×•×§ 2
    eventLocationInput.value = eventLocation;
    eventDateInput.value     = eventDate;

    showStatus(`× ×˜×¢× ×• ${allChoices.length} ×‘×—×™×¨×•×ª`, true);

    recalcAccordionHeights();
  } catch(err){
    console.error(err);
    showStatus("×©×’×™××” ×‘×˜×¢×™× ×”", false);
  }
}

// ===== ×˜×‘×œ×ª ×‘×—×™×¨×•×ª =====
function buildWhatsAppMsg(rec){
  // ×©× ×××™×ª×™ ×œ×¤×™ ×”×§×•×“
  const famName = codeMap[rec.code] || rec["×©×"] || "";

  const msg =
`×©×œ×•× ${famName}
×–×” ×”×ª×¤×¨×™×˜ ×©××ª× ×‘×—×¨×ª× ×œ××¤×’×© ×”×§×¨×•×‘:
ğŸ— ×× ×”: ${rec["×× ×”"]||""}
ğŸš ×¤×—××™××”: ${rec["×¤×—××™××”"]||""}
ğŸ¥— ×¡×œ×˜ 1: ${rec["×¡×œ×˜1"]||""}
ğŸ¥— ×¡×œ×˜ 2: ${rec["×¡×œ×˜2"]||""}
ğŸ¥¤ ×©×ª×™×™×”: ${rec["×©×ª×™×™×”"]||""}
ğŸ° ×§×™× ×•×—: ${rec["×§×™× ×•×—"]||""}

××–×›×™×¨ ×©× ×¤×’×©×™× ×‘: ${eventLocation || ""}
×‘×ª××¨×™×š: ${eventDate || ""}`;

  return "https://wa.me/?text="+encodeURIComponent(msg);
}

function renderChoicesTable(){
  if(!filteredChoices.length){
    tableBody.innerHTML =
      '<tr><td colspan="10" style="text-align:center;color:#777;">××™×Ÿ × ×ª×•× ×™×</td></tr>';
  } else {
    tableBody.innerHTML = filteredChoices.map((rec,i)=>`
      <tr>
        <td>${rec.code||""}</td>
        <td>${rec["×©×"]||""}</td>
        <td>${rec["×× ×”"]||""}</td>
        <td>${rec["×¤×—××™××”"]||""}</td>
        <td>${rec["×¡×œ×˜1"]||""}</td>
        <td>${rec["×¡×œ×˜2"]||""}</td>
        <td>${rec["×©×ª×™×™×”"]||""}</td>
        <td>${rec["×§×™× ×•×—"]||""}</td>
        <td>${prettyTS(rec.ts)}</td>
        <td class="actionsCell">
          <button class="rowWA" data-i="${i}">×•×•×¦××¤</button>
          <button class="rowDel" data-i="${i}">××—×§</button>
        </td>
      </tr>
    `).join("");
  }
}

// ×œ×—×™×¦×•×ª ×¢×œ "×•×•×¦××¤" / "××—×§" ×‘×˜×‘×œ×ª ×”×‘×—×™×¨×•×ª
tableBody.addEventListener("click", async (e)=>{
  const waBtn = e.target.classList.contains("rowWA");
  const delBtn = e.target.classList.contains("rowDel");

  if(!waBtn && !delBtn) return;

  const idx = e.target.getAttribute("data-i");
  if(idx===null || idx===undefined) return;

  if(waBtn){
    // ×‘×•× ×” ×”×•×“×¢×ª ×•×•×¦××¤ ××•×ª×××ª ×œ×¨×©×•××” ×”×–××ª
    const rec = filteredChoices[idx];
    const waUrl = buildWhatsAppMsg(rec);
    window.open(waUrl, "_blank");
    return;
  }

  if(delBtn){
    // ××•×—×§ ××ª ×”×¨×©×•××”
    allChoices.splice(idx,1);
    await saveAllToServer();
    await fetchAll();
    return;
  }
});

// ===== ×—×™×¤×•×© =====
function applySearch(){
  const q = searchInput.value.trim().toLowerCase();
  if(!q){
    filteredChoices=[...allChoices];
  } else {
    filteredChoices = allChoices.filter(rec=>{
      return JSON.stringify(rec).toLowerCase().includes(q);
    });
  }
  renderChoicesTable();
  recalcAccordionHeights();
}

// ===== CSV =====
function exportCSV(){
  if(!filteredChoices.length) return;
  const BOM="\uFEFF";
  const rows=[["×§×•×“","××©×¤×—×”","×× ×”","×¤×—××™××”","×¡×œ×˜1","×¡×œ×˜2","×©×ª×™×™×”","×§×™× ×•×—","×ª××¨×™×š"]];
  filteredChoices.forEach(rec=>{
    rows.push([
      rec.code||"",
      rec["×©×"]||"",
      rec["×× ×”"]||"",
      rec["×¤×—××™××”"]||"",
      rec["×¡×œ×˜1"]||"",
      rec["×¡×œ×˜2"]||"",
      rec["×©×ª×™×™×”"]||"",
      rec["×§×™× ×•×—"]||"",
      prettyTS(rec.ts)
    ]);
  });
  const blob=new Blob(
    [BOM+rows.map(r=>r.join(",")).join("\n")],
    {type:"text/csv;charset=utf-8;"}
  );
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="food_manager.csv";
  a.click();
  URL.revokeObjectURL(url);
}

// ===== ONLINE / OFFLINE =====
function renderToggleButton(){
  toggleBtn.className = formOpen ? "actionBtn online" : "actionBtn offline";
  toggleBtn.textContent = formOpen ? "ONLINE" : "OFFLINE";
}
async function toggleForm(){
  formOpen = !formOpen;
  renderToggleButton();
  showStatus("×©×•××¨ ××¦×‘ ×˜×•×¤×¡...", true);
  await saveAllToServer();
  showStatus(`×”×˜×•×¤×¡ ×¢×›×©×™×• ${formOpen ? "×¤×ª×•×—" : "×¡×’×•×¨"}`, true);
}

// ===== ×§×•×“×™× =====
function renderCodeMapTable(){
  const keys = Object.keys(codeMap).sort((a,b)=>{
    const na=Number(a), nb=Number(b);
    if(!isNaN(na) && !isNaN(nb)) return na-nb;
    return a.localeCompare(b,"he");
  });

  if(!keys.length){
    codeMapBody.innerHTML =
      '<tr><td colspan="4" style="text-align:center;color:#777;">××™×Ÿ ×§×•×“×™× ××•×’×“×¨×™×</td></tr>';
  } else {
    codeMapBody.innerHTML = keys.map(code=>{
      const famName = codeMap[code];

      const msg =
`×©×œ×•× ${famName}
××¦×•×¨×£ ×§×™×©×•×¨ ×œ×‘×—×™×¨×ª ×ª×¤×¨×™×˜ ×©×‘×•×¢×™
× × ×œ××œ× ××ª ×”× ×ª×•× ×™× ×‘×”×§×“×:
${window.location.origin}/food.html?code=${encodeURIComponent(code)}`;

      const waUrl = "https://wa.me/?text="+encodeURIComponent(msg);

      return `
        <tr>
          <td>${code}</td>
          <td>${famName}</td>
          <td>
            <button class="whatsappBtn" data-wa="${waUrl}">
              ×•×•×¦××¤
            </button>
          </td>
          <td>
            <button class="delCodeBtn" data-code="${code}">
              ××—×§
            </button>
          </td>
        </tr>
      `;
    }).join("");
  }
  recalcAccordionHeights();
}

// ×”×•×¡×¤×”/×¢×“×›×•×Ÿ ×§×•×“
addCodeBtn.addEventListener("click", ()=>{
  const c = newCodeInput.value.trim();
  const f = newFamilyInput.value.trim();
  if(!c || !f){
    showStatus("×—×¡×¨ ×§×•×“ ××• ×©× ××©×¤×—×”", false);
    return;
  }
  codeMap[c]=f;
  newCodeInput.value="";
  newFamilyInput.value="";
  renderCodeMapTable();
  showStatus("×”×§×•×“ ×”×•×¡×£/×¢×•×“×›×Ÿ ×‘×¨×©×™××”. ×¢×“×™×™×Ÿ ×œ× × ×©××¨ ×‘×©×¨×ª.", true);
});

// ×›×¤×ª×•×¨ ×•×•×¦××¤ ×•××—×™×§×” (×œ×˜×‘×œ×ª ×”×§×•×“×™×)
codeMapBody.addEventListener("click",(e)=>{
  if(e.target.classList.contains("whatsappBtn")){
    const wa = e.target.getAttribute("data-wa");
    if(wa){
      window.open(wa,"_blank");
    }
    return;
  }
  if(e.target.classList.contains("delCodeBtn")){
    const c = e.target.getAttribute("data-code");
    if(c && codeMap[c]!==undefined){
      delete codeMap[c];
      renderCodeMapTable();
      showStatus("×”×§×•×“ ×”×•×¡×¨ ××”×¨×©×™××”. ×¢×“×™×™×Ÿ ×œ× × ×©××¨ ×‘×©×¨×ª.", true);
    }
    return;
  }
});

// ===== ×ª×¤×¨×™×˜ =====
function categoryLabel(key){
  switch(key){
    case "meat": return "×× ×” ×‘×©×¨×™×ª";
    case "carb": return "×¤×—××™××”";
    case "salad1": return "×¡×œ×˜ 1";
    case "salad2": return "×¡×œ×˜ 2";
    case "drink": return "×©×ª×™×™×”";
    case "dessert": return "×§×™× ×•×—";
    default: return key;
  }
}
function renderMenuOptionsEditor(){
  menuSections.innerHTML="";
  const cats=["meat","carb","salad1","salad2","drink","dessert"];
  cats.forEach(cat=>{
    if(!Array.isArray(menuOptions[cat])) menuOptions[cat]=[];
    const div=document.createElement("div");
    div.className="menuCatWrap";
    div.setAttribute("data-cat",cat);

    const header=document.createElement("div");
    header.className="menuCatHeader";
    header.innerHTML=`
      <h3>${categoryLabel(cat)}</h3>
      <small style="color:#666;font-size:13px;">
        ×¤×¨×™×˜×™× ×§×™×™××™× (××¤×©×¨ ×œ××—×•×§), ×•××– ×œ×”×•×¡×™×£ ×—×“×© ×œ××˜×”
      </small>
    `;
    div.appendChild(header);

    const listDiv=document.createElement("div");
    listDiv.className="menuList";
    menuOptions[cat].forEach((item,idx)=>{
      const tag=document.createElement("div");
      tag.className="menuItemTag";
      tag.innerHTML=`
        <span>${item}</span>
        <button data-cat="${cat}" data-idx="${idx}">X</button>
      `;
      listDiv.appendChild(tag);
    });
    div.appendChild(listDiv);

    const addRow=document.createElement("div");
    addRow.className="addRow";
    addRow.innerHTML=`
      <input type="text" class="newItemInput" placeholder="×”×•×¡×£ ×× ×” ×—×“×©×” ×œ-${categoryLabel(cat)}">
      <button data-cat="${cat}" class="addItemBtn">×”×•×¡×£</button>
    `;
    div.appendChild(addRow);

    menuSections.appendChild(div);
  });

  recalcAccordionHeights();
}

// ××—×™×§×” ××§×•××™×ª ×©×œ ×¤×¨×™×˜ ××¨×©×™××ª ×ª×¤×¨×™×˜
menuSections.addEventListener("click",(e)=>{
  if(e.target.tagName==="BUTTON"
     && e.target.dataset
     && e.target.dataset.idx!==undefined
     && e.target.dataset.cat){
    const cat=e.target.dataset.cat;
    const idx=Number(e.target.dataset.idx);
    if(Array.isArray(menuOptions[cat]) && menuOptions[cat][idx]!==undefined){
      menuOptions[cat].splice(idx,1);
      renderMenuOptionsEditor();
      showStatus("× ××—×§ ××”×¨×©×™××” ×”××§×•××™×ª. ×¢×“×™×™×Ÿ ×œ× × ×©××¨ ×‘×©×¨×ª.", true);
    }
  }
});

// ×”×•×¡×¤×ª ×¤×¨×™×˜ ×—×“×© ××§×•××™×ª ×œ×ª×¤×¨×™×˜
menuSections.addEventListener("click",(e)=>{
  if(e.target.classList.contains("addItemBtn")){
    const cat=e.target.getAttribute("data-cat");
    const wrap=e.target.closest(".menuCatWrap");
    const input=wrap.querySelector(".newItemInput");
    const val=input.value.trim();
    if(!val){
      showStatus("×œ× ×”×•×›× ×¡ ×¤×¨×™×˜ ×—×“×©", false);
      return;
    }
    if(!menuOptions[cat]) menuOptions[cat]=[];
    if(!menuOptions[cat].includes(val)){
      menuOptions[cat].push(val);
    }
    input.value="";
    renderMenuOptionsEditor();
    showStatus("×”×¤×¨×™×˜ ×”×ª×•×•×¡×£ ×œ×¨×©×™××” ×”××§×•××™×ª. ×¢×“×™×™×Ÿ ×œ× × ×©××¨ ×‘×©×¨×ª.", true);
  }
});

// ===== ×©××™×¨×” ×›×•×œ×œ×ª ×œ×©×¨×ª =====
async function saveAllToServer(){
  const body = {
    "formOpen": formOpen,
    "map": codeMap,
    "menuOptions": menuOptions,
    "×‘×—×™×¨×•×ª": allChoices,
    "eventLocation": eventLocation,
    "eventDate": eventDate
  };
  try{
    const putRes = await fetch(`${API}/${BIN_ID}`,{
      method:"PUT",
      headers:{
        "Content-Type":"application/json",
        "X-Master-Key": MASTER_KEY
      },
      body:JSON.stringify(body)
    });
    if(!putRes.ok){
      showStatus("×©××™×¨×” × ×›×©×œ×” ×‘×©×¨×ª", false);
    }
  }catch(err){
    console.error(err);
    showStatus("×©××™×¨×” × ×›×©×œ×” ×‘×©×¨×ª", false);
  }
}

// ×©××™×¨×ª ××™×¤×•×™ ×§×•×“×™×
saveMapBtn.onclick = async ()=>{
  showStatus("×©×•××¨ ××™×¤×•×™ ×§×•×“×™×...", true);
  await saveAllToServer();
  showStatus("×”××™×¤×•×™ × ×©××¨ ×‘×”×¦×œ×—×” âœ…", true);
};

// ×©××™×¨×ª ×ª×¤×¨×™×˜
saveMenuBtn.onclick = async ()=>{
  showStatus("×©×•××¨ ×ª×¤×¨×™×˜...", true);
  await saveAllToServer();
  showStatus("×”×ª×¤×¨×™×˜ × ×©××¨ ×‘×”×¦×œ×—×” âœ…", true);
};

// ×©××™×¨×ª ×¤×¨×˜×™ ××™×¨×•×¢ (××™×§×•×+×ª××¨×™×š)
saveEventBtn.onclick = async ()=>{
  eventLocation = eventLocationInput.value.trim();
  eventDate     = eventDateInput.value;
  showStatus("×©×•××¨ ×¤×¨×˜×™ ××™×¨×•×¢...", true);
  await saveAllToServer();
  showStatus("×¤×¨×˜×™ ×”××™×¨×•×¢ × ×©××¨×• âœ…", true);
};

// ===== ×××–×™× ×™× ×›×œ×œ×™×™× =====
refreshBtn.onclick = async ()=>{ await fetchAll(); };
toggleBtn.onclick  = toggleForm;
csvBtn.onclick     = exportCSV;
searchInput.oninput= applySearch;

// ===== ×”×¤×¢×œ×” =====
setupAccordion();
fetchAll();
</script>
</body>
</html>
