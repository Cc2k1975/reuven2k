<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>בחירת תפריט משפחתי</title>
<style>
:root {
  --bg-page:#fffaf0;
  --card-bg:#ffffff;
  --border:#e2d7b8;
  --gold:#c59d2f;
  --green:#3c7a4c;
  --green-dark:#2e5f3b;
  --text-main:#333;
  --text-dim:#666;
  --radius:16px;
  --shadow:0 8px 24px rgba(0,0,0,0.12);
  --shadow-inner:0 0 10px rgba(0,0,0,0.08) inset;
  --ok-bg:#2e7d32;
  --err-bg:#a01919;
}

body {
  background:var(--bg-page);
  margin:0;
  font-family:"Heebo",Arial,sans-serif;
  color:var(--text-main);
  display:flex;
  justify-content:center;
  padding:16px;
  text-align:center;
}

.wrap {
  width:100%;
  max-width:600px;
  background:var(--card-bg);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:24px 20px 32px;
  border:2px solid var(--border);
  position:relative;
}

h1 {
  margin:0;
  font-size:28px;
  color:var(--green);
  font-weight:700;
  line-height:1.3;
}

#statusBox {
  display:none;
  margin-top:12px;
  font-size:16px;
  font-weight:600;
  color:#fff;
  border-radius:var(--radius);
  padding:10px 14px;
  line-height:1.4;
  text-align:center;
}
#statusBox.ok  { background:var(--ok-bg); }
#statusBox.err { background:var(--err-bg); }

.sectionHead {
  font-size:20px;
  font-weight:700;
  color:var(--gold);
  border-bottom:2px solid var(--gold);
  display:inline-block;
  margin:28px 0 8px;
  line-height:1.4;
}

select {
  width:100%;
  appearance:none;
  -webkit-appearance:none;
  background:#fff;
  border:2px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow-inner);
  padding:14px;
  font-size:18px;
  font-family:inherit;
  font-weight:500;
  text-align:right;
  color:var(--text-main);
}
select:disabled {
  background:#f3f3f3;
  color:#aaa;
}

button#sendBtn {
  width:100%;
  background:var(--green);
  color:#fff;
  border:0;
  border-radius:var(--radius);
  padding:16px;
  font-size:20px;
  font-weight:700;
  margin-top:28px;
  box-shadow:var(--shadow);
}
button#sendBtn:active { background:var(--green-dark); }
button#sendBtn:disabled {
  background:#999;
  box-shadow:none;
  opacity:0.7;
}

/* popup */
.popup-bg {
  position:fixed;
  top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,0.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.popup {
  background:var(--bg-page);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  border:2px solid var(--border);
  width:90%;
  max-width:400px;
  padding:24px 20px 28px;
  text-align:center;
  animation:pop .3s ease-out;
}
@keyframes pop {
  from {transform:scale(.8);opacity:0;}
  to   {transform:scale(1);opacity:1;}
}
.popup h2 {
  margin:0 0 8px;
  color:var(--green);
  font-size:22px;
}
.popup p {
  margin:6px 0;
  font-size:18px;
  color:var(--text-main);
  line-height:1.4;
  font-weight:500;
}
.popup .emoji {
  font-size:22px;
  margin-left:6px;
}
.closeBtn {
  margin-top:20px;
  background:var(--green);
  color:#fff;
  font-size:18px;
  font-weight:700;
  border:0;
  border-radius:var(--radius);
  padding:12px 20px;
  box-shadow:var(--shadow);
  width:100%;
}

.footerInfo {
  text-align:center;
  font-size:13px;
  color:var(--text-dim);
  margin-top:28px;
}
</style>
</head>
<body>

<div class="wrap">
  <h1 id="welcomeTitle">טוען...</h1>

  <div id="statusBox"></div>

  <form id="foodForm" style="margin-top:20px;">

    <!-- מנה בשרית -->
    <div class="sectionHead">מנה בשרית</div>
    <select id="meat" required>
      <option disabled selected value=""></option>
      <option>עוף מבושל עם בצל</option>
      <option>עוף בתנור</option>
      <option>עוף עם קישואים</option>
      <option>קציצות עוף</option>
      <option>פרגית בתנור</option>
      <option>כנפיים בצילי</option>
      <option>עוף ממולא</option>
      <option>שווארמה בתנור</option>
      <option>עוף ברוטב סויה</option>
      <option>חזה עוף</option>
      <option>שניצלים</option>
      <option>קציצות בקר ברוטב</option>
      <option>פלפל ממולא בשר</option>
      <option>טורטיה עוף</option>
      <option>טורטיה כבד</option>
      <option>בורקס בשר</option>
      <option>קציצות דגים</option>
      <option>דגים מבושלים</option>
      <option>דגים בתנור</option>
      <option>דג מטוגן</option>
      <option>מרק בשרי</option>
      <option>צלי בקר</option>
      <option>מוסקה</option>
      <option>ארטישוט ממולא בשר</option>
      <option>כבד עוף בבצל</option>
      <option>לאזניה</option>
    </select>

    <!-- פחמימה -->
    <div class="sectionHead">פחמימה</div>
    <select id="carb" required>
      <option disabled selected value=""></option>
      <option>אורז לבן</option>
      <option>אורז עם איטריות</option>
      <option>תפוחי אדמה בתנור</option>
      <option>תפוחי אדמה מבושלים</option>
      <option>קוסקוס</option>
      <option>זיתים מבושלים</option>
      <option>פירה</option>
      <option>פשטידה</option>
      <option>ניוקי</option>
      <option>ירקות מבושלים</option>
      <option>ספגטי</option>
      <option>אפונה</option>
      <option>שועית ירוקה</option>
      <option>תירס מבושל</option>
      <option>פולים עם כרפס</option>
      <option>אנטיפאסטי</option>
      <option>ארטישוק</option>
      <option>פטריות</option>
      <option>בורקס</option>
    </select>

    <!-- סלט 1 -->
    <div class="sectionHead">סלט 1</div>
    <select id="salad1" required>
      <option disabled selected value=""></option>
      <option>סלט חי</option>
      <option>חומוס</option>
      <option>טחינה</option>
      <option>סלט מבושל</option>
      <option>טאבולי</option>
      <option>כרוב</option>
      <option>כרוב עם מיונז</option>
      <option>סלט תפוחי אדמה</option>
      <option>סלט עכו</option>
      <option>כרובית מטוגנת  בטחינה</option>
      <option>פלפל מתוק</option>
      <option>פלפל חריף</option>
      <option>בארבה</option>
      <option>חציל מטוגן</option>
      <option>חציל במיונז</option>
      <option>חציל עם אריסה</option>
      <option>חציל בטחינה</option>
      <option>עגבניות שרי וצנובר</option>
      <option>סלט ביצים</option>
      <option>גזר וסחוג</option>
      <option>פטרוזיליה עם רימון</option>
      <option>חמוצים</option>
      <option>אבוקדו</option>
      <option>סלק ירוק</option>
      <option>סלט גזר</option>
      <option>סלט פטריות</option>
      <option>צנון</option>
      <option>כבד קצוץ</option>
      <option>חסה</option>
      <option>קינואה</option>
    </select>

    <!-- סלט 2 -->
    <div class="sectionHead">סלט 2</div>
    <select id="salad2" required>
      <option disabled selected value=""></option>
      <option>סלט חי</option>
      <option>חומוס</option>
      <option>טחינה</option>
      <option>סלט מבושל</option>
      <option>טאבולי</option>
      <option>כרוב</option>
      <option>כרוב עם מיונז</option>
      <option>סלט תפוחי אדמה</option>
      <option>סלט עכו</option>
      <option>כרובית מטוגנת  בטחינה</option>
      <option>פלפל מתוק</option>
      <option>פלפל חריף</option>
      <option>בארבה</option>
      <option>חציל מטוגן</option>
      <option>חציל במיונז</option>
      <option>חציל עם אריסה</option>
      <option>חציל בטחינה</option>
      <option>עגבניות שרי וצנובר</option>
      <option>סלט ביצים</option>
      <option>גזר וסחוג</option>
      <option>פטרוזיליה עם רימון</option>
      <option>חמוצים</option>
      <option>אבוקדו</option>
      <option>סלק ירוק</option>
      <option>סלט גזר</option>
      <option>סלט פטריות</option>
      <option>צנון</option>
      <option>כבד קצוץ</option>
      <option>חסה</option>
      <option>קינואה</option>
    </select>

    <!-- שתייה -->
    <div class="sectionHead">שתייה</div>
    <select id="drink" required>
      <option disabled selected value=""></option>
      <option>קולה</option>
      <option>קולה זירו</option>
      <option>פאנטה</option>
      <option>ענבים</option>
      <option>יין קידוש</option>
      <option>בירה</option>
      <option>יין</option>
      <option>XL</option>
      <option>סודה</option>
    </select>

    <!-- קינוח -->
    <div class="sectionHead">קינוח</div>
    <select id="dessert" required>
      <option disabled selected value=""></option>
      <option>עוגה</option>
      <option>גלידה</option>
    </select>

    <button id="sendBtn" type="submit">שלח תפריט</button>
  </form>

  <div class="footerInfo">גרסה: v1.2-fix · food.html</div>
</div>

<!-- פופאפ סיכום -->
<div class="popup-bg" id="popupBG">
  <div class="popup">
    <h2 id="popupTitle"></h2>
    <div id="popupContent"></div>
    <button class="closeBtn" onclick="closePopup()">סגור</button>
  </div>
</div>

<script>
const BIN_ID      = "68ff447a43b1c97be9844c29";
const MASTER_KEY  = "$2a$10$4rynniEMuvwqg2nDb5KSEe/lAVYp8a7L3xWzp9GsO6n49OfXc3FCO";
const API         = "https://api.jsonbin.io/v3/b";

const welcomeTitle    = document.getElementById("welcomeTitle");
const statusBox       = document.getElementById("statusBox");
const formEl          = document.getElementById("foodForm");
const sendBtn         = document.getElementById("sendBtn");

const meat   = document.getElementById("meat");
const carb   = document.getElementById("carb");
const salad1 = document.getElementById("salad1");
const salad2 = document.getElementById("salad2");
const drink  = document.getElementById("drink");
const dessert= document.getElementById("dessert");

const popupBG        = document.getElementById("popupBG");
const popupTitleEl   = document.getElementById("popupTitle");
const popupContentEl = document.getElementById("popupContent");

// קבלת שם המשתמש מה-URL
const urlParams = new URLSearchParams(window.location.search);
let currentUser = (urlParams.get("user") || "").trim();

// ברכה בהתאם למגדר (אדמו = זכר, כל השאר נקבות)
function setWelcome() {
  if (!currentUser) {
    welcomeTitle.textContent = "אין זיהוי משתמש";
    showStatus("כדי לבחור אתה חייב להיכנס מהקישור האישי שלך.", false);
    sendBtn.disabled = true;
    lockAllSelects(true);
    return;
  }
  const prefix = (currentUser === "אדמו") ? "ברוך הבא " : "ברוכה הבאה ";
  welcomeTitle.textContent = prefix + currentUser + " 🍽️";
}
setWelcome();

// פס סטטוס
function showStatus(msg, ok){
  statusBox.style.display="block";
  statusBox.className = ok ? "ok" : "err";
  statusBox.textContent = msg;
}

// לנעול / לפתוח selectים
function lockAllSelects(lock){
  [meat,carb,salad1,salad2,drink,dessert].forEach(sel=>{
    sel.disabled = lock;
  });
}

// לנעול אפשרויות שכבר נבחרו
function disableUsedOptions(usedList){
  const allSelects=[meat,carb,salad1,salad2,drink,dessert];
  allSelects.forEach(sel=>{
    for(const opt of sel.options){
      if(!opt.value) continue;
      if(usedList.includes(opt.textContent)){
        opt.disabled = true;
        opt.style.color = "#aaa";
      }
    }
  });
}

// מצב גלובלי מהשרת
let formOpen = true;

// טוען formOpen ורשימת הפריטים שכבר נתפסו
async function initData(){
  try {
    const res = await fetch(`${API}/${BIN_ID}/latest`, {
      headers: { "X-Master-Key": MASTER_KEY }
    });
    const j = await res.json();

    formOpen = j.record?.formOpen !== false;

    const choicesArr = Array.isArray(j.record?.בחירות)
      ? j.record.בחירות
      : [];

    const usedItems=[];
    choicesArr.forEach(rec=>{
      if(rec.מנה)    usedItems.push(rec.מנה);
      if(rec.פחמימה) usedItems.push(rec.פחמימה);
      if(rec.סלט1)   usedItems.push(rec.סלט1);
      if(rec.סלט2)   usedItems.push(rec.סלט2);
      if(rec.שתייה)  usedItems.push(rec.שתייה);
      if(rec.קינוח)  usedItems.push(rec.קינוח);
    });
    disableUsedOptions(usedItems);

    if(!formOpen){
      showStatus("הרישום הסתיים. לא ניתן יותר לבחור.", false);
      sendBtn.disabled = true;
      lockAllSelects(true);
    }
  } catch(err){
    console.error(err);
    showStatus("שגיאה בטעינת הנתונים. נסה שוב מאוחר יותר.", false);
  }
}
initData();

// שליחת בחירה
formEl.addEventListener("submit", async (e)=>{
  e.preventDefault();

  if (!currentUser) {
    showStatus("לא זוהה משתמש. אי אפשר לשלוח.", false);
    return;
  }
  if (!formOpen) {
    showStatus("הרישום הסתיים. לא ניתן יותר לבחור.", false);
    return;
  }

  const oneChoice = {
    "שם": currentUser,
    "מנה": meat.value,
    "פחמימה": carb.value,
    "סלט1": salad1.value,
    "סלט2": salad2.value,
    "שתייה": drink.value,
    "קינוח": dessert.value,
    "ts": new Date().toISOString()
  };

  try {
    // משיכה עדכנית
    const res1 = await fetch(`${API}/${BIN_ID}/latest`, {
      headers: { "X-Master-Key": MASTER_KEY }
    });
    const data1 = await res1.json();

    const existingChoices = Array.isArray(data1.record?.בחירות)
      ? data1.record.בחירות
      : [];
    const existingOpen = data1.record?.formOpen !== false;
    if (!existingOpen) {
      showStatus("הרישום הסתיים. לא ניתן יותר לבחור.", false);
      sendBtn.disabled = true;
      lockAllSelects(true);
      return;
    }

    existingChoices.push(oneChoice);

    // שמירה חזרה
    const putRes = await fetch(`${API}/${BIN_ID}`, {
      method:"PUT",
      headers:{
        "Content-Type":"application/json",
        "X-Master-Key": MASTER_KEY
      },
      body:JSON.stringify({
        "formOpen": true,
        "בחירות": existingChoices
      })
    });

    if(!putRes.ok){
      showStatus("שמירה נכשלה. נסה שוב.", false);
      return;
    }

    // הצלחה 🎉
    showStatus("הנתונים נשמרו בהצלחה ✅", true);
    sendBtn.disabled = true;
    lockAllSelects(true);
    showPopup(oneChoice);

  } catch(err){
    console.error(err);
    showStatus("שגיאה בזמן שליחה. נסה שוב.", false);
  }
});

// פופאפ סיכום
function showPopup(choice){
  popupTitleEl.textContent = currentUser + " – הבחירות שלך";
  popupContentEl.innerHTML = `
    <p><span class="emoji">🍗</span> מנה: ${choice.מנה}</p>
    <p><span class="emoji">🍚</span> פחמימה: ${choice.פחמימה}</p>
    <p><span class="emoji">🥗</span> סלט 1: ${choice.סלט1}</p>
    <p><span class="emoji">🥗</span> סלט 2: ${choice.סלט2}</p>
    <p><span class="emoji">🥤</span> שתייה: ${choice.שתייה}</p>
    <p><span class="emoji">🍰</span> קינוח: ${choice.קינוח}</p>
  `;
  popupBG.style.display="flex";
}

function closePopup(){
  popupBG.style.display="none";
}
</script>
</body>
</html>
