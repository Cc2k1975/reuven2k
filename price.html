<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>סורק מחירים</title>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      width: 100%;
      height: 100%;
      background: #101827;
      color: #f9fafb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Heebo", Arial, sans-serif;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 12px;
    }

    .wrapper {
      width: 100%;
      max-width: 480px;
      margin-top: 8px;
    }

    h1 {
      font-size: 20px;
      text-align: center;
      margin-bottom: 10px;
    }

    /* חלון מצלמה – מלבן 2:1 */
    .camera-box {
      position: relative;
      width: 100%;
      max-width: 420px;
      aspect-ratio: 2 / 1;
      background: #020617;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.4);
      margin: 0 auto;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      /* בלי מראה */
    }

    .info {
      font-size: 13px;
      color: #cbd5f5;
      margin-top: 6px;
      text-align: center;
    }

    #status {
      margin-top: 6px;
      font-size: 13px;
      text-align: center;
      min-height: 18px;
      color: #e5e7eb;
    }

    .btn-row {
      margin-top: 10px;
      display: flex;
      justify-content: center;
    }

    button.main-btn {
      padding: 10px 18px;
      font-size: 16px;
      border-radius: 999px;
      border: none;
      background: #22c55e;
      color: #022c22;
      font-weight: 600;
      box-shadow: 0 8px 18px rgba(34, 197, 94, 0.35);
      cursor: pointer;
      min-width: 180px;
    }

    button.main-btn:active {
      transform: translateY(1px);
      box-shadow: 0 4px 10px rgba(34, 197, 94, 0.4);
    }

    .list-box {
      margin-top: 14px;
      background: #020617;
      border-radius: 14px;
      padding: 10px;
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .list-header {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      margin-bottom: 6px;
      color: #e5e7eb;
    }

    ul {
      list-style: none;
      max-height: 220px;
      overflow-y: auto;
    }

    li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      padding: 4px 0;
      border-bottom: 1px solid rgba(51, 65, 85, 0.6);
      font-size: 14px;
    }

    li:last-child {
      border-bottom: none;
    }

    .item-label {
      flex: 1;
    }

    .item-price {
      min-width: 70px;
      text-align: left;
    }

    /* כפתור מחיקה קטן */
    .delete-btn {
      border: none;
      border-radius: 999px;
      padding: 1px 5px;
      font-size: 9px;
      background: #ef4444;
      color: #fef2f2;
      cursor: pointer;
      flex-shrink: 0;
      line-height: 1.1;
    }

    .delete-btn:active {
      transform: translateY(1px);
    }

    .total-row {
      margin-top: 8px;
      padding-top: 6px;
      border-top: 1px solid rgba(148, 163, 184, 0.7);
      display: flex;
      justify-content: space-between;
      font-weight: 700;
      font-size: 16px;
    }

    .total-label {
      color: #e5e7eb;
    }

    .total-value {
      color: #22c55e;
    }

    #captureCanvas {
      display: none;
    }

    /* קופסת אישור מחיר */
    .confirm-box {
      margin-top: 8px;
      background: #020617;
      border-radius: 10px;
      padding: 8px 10px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      font-size: 13px;
      display: none;
    }

    .confirm-top {
      margin-bottom: 6px;
    }

    .confirm-price {
      font-weight: 700;
      color: #22c55e;
    }

    .confirm-buttons {
      display: flex;
      gap: 6px;
      justify-content: center;
    }

    .mini-btn {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
    }

    .mini-btn.yes {
      background: #22c55e;
      color: #022c22;
    }

    .mini-btn.edit {
      background: #4b5563;
      color: #e5e7eb;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <h1>סורק מחירים פשוט</h1>

    <div class="camera-box">
      <video id="video" autoplay playsinline></video>
    </div>

    <div class="info">
      כוון את מדבקת המחיר למרכז המלבן ולחץ על "הוסף מוצר".
    </div>
    <div id="status"></div>

    <div class="btn-row">
      <button id="scanBtn" class="main-btn">הוסף מוצר</button>
    </div>

    <!-- קופסת אישור מחיר -->
    <div id="confirmBox" class="confirm-box">
      <div class="confirm-top">
        זוהה מחיר: <span id="confirmPrice" class="confirm-price"></span> ₪.<br>
        האם זה המחיר הנכון?
      </div>
      <div class="confirm-buttons">
        <button id="confirmYes" class="mini-btn yes">כן, הוסף לסל</button>
        <button id="confirmEdit" class="mini-btn edit">לא, אני אתקן</button>
      </div>
    </div>

    <div class="list-box">
      <div class="list-header">
        <span>מוצר</span>
        <span>מחיר (₪)</span>
      </div>
      <ul id="itemsList"></ul>
      <div class="total-row">
        <span class="total-label">סה״כ:</span>
        <span class="total-value" id="totalPrice">0.00</span>
      </div>
    </div>
  </div>

  <canvas id="captureCanvas"></canvas>

  <script src="https://unpkg.com/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
  <script>
    const video = document.getElementById('video');
    const scanBtn = document.getElementById('scanBtn');
    const statusEl = document.getElementById('status');
    const captureCanvas = document.getElementById('captureCanvas');
    const itemsList = document.getElementById('itemsList');
    const totalPriceEl = document.getElementById('totalPrice');

    const confirmBox = document.getElementById('confirmBox');
    const confirmPriceEl = document.getElementById('confirmPrice');
    const confirmYesBtn = document.getElementById('confirmYes');
    const confirmEditBtn = document.getElementById('confirmEdit');

    const prices = [];
    let pendingPrice = null;

    // הפעלת מצלמה
    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: { ideal: 'environment' },
            width: { ideal: 1280 },
            height: { ideal: 640 },
            aspectRatio: { ideal: 2.0 }
          },
          audio: false
        });
        video.srcObject = stream;
        statusEl.textContent = 'המצלמה פועלת. כוון את התווית למרכז המלבן.';
      } catch (err) {
        statusEl.textContent = 'לא הצלחתי להפעיל מצלמה: ' + err.message;
      }
    }

    // אלגוריתם חילוץ מחיר מטקסט
    function extractPriceFromText(text) {
      if (!text) return null;

      let cleaned = text.replace(/[^0-9.,]/g, ' ');
      const matches = cleaned.match(/\d{1,5}(?:[.,]\d{1,2})?/g);
      if (!matches) return null;

      const candidates = [];

      for (const raw of matches) {
        if (!raw) continue;

        let norm = raw.replace(/,/g, '.');
        const partsDot = norm.split('.');
        if (partsDot.length > 2) {
          norm = partsDot[0] + '.' + partsDot[1];
        }

        const value = parseFloat(norm);
        if (isNaN(value)) continue;
        if (value <= 0) continue;

        candidates.push({ raw: norm, value });
      }

      if (!candidates.length) return null;

      function scoreCandidate(c) {
        const raw = c.raw;
        const value = c.value;

        const parts = raw.split('.');
        const intPart = parts[0] || '';
        const fracPart = parts[1] || '';

        let score = 0;

        score += intPart.length * 2;

        if (fracPart.length === 2) score += 4;
        else if (fracPart.length === 1) score += 2;

        const cents = Math.round((value - Math.floor(value)) * 100);
        const typicalCents = [0, 5, 9, 10, 20, 50, 90, 95, 99];
        if (typicalCents.includes(cents)) score += 3;

        if (value >= 0.5 && value <= 500) score += 3;
        else if (value > 500 && value <= 5000) score += 1;

        if (intPart.length >= 2 && intPart.length <= 4) score += 2;

        return score;
      }

      let best = candidates[0];
      let bestScore = scoreCandidate(best);

      for (let i = 1; i < candidates.length; i++) {
        const s = scoreCandidate(candidates[i]);
        if (s > bestScore) {
          bestScore = s;
          best = candidates[i];
        }
      }

      return best.value;
    }

    // שחור-לבן + קונטרסט
    function applyGrayscaleAndContrast(ctx, width, height) {
      const imageData = ctx.getImageData(0, 0, width, height);
      const data = imageData.data;
      const contrast = 1.4;

      for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];

        let gray = 0.299 * r + 0.587 * g + 0.114 * b;

        gray = (gray - 128) * contrast + 128;
        if (gray < 0) gray = 0;
        if (gray > 255) gray = 255;

        data[i] = data[i + 1] = data[i + 2] = gray;
      }

      ctx.putImageData(imageData, 0, 0);
    }

    // סריקת מחיר מהווידאו → הצגת אישור
    async function scanPriceFromVideo() {
      if (!video.videoWidth || !video.videoHeight) {
        statusEl.textContent = 'מחכה שהמצלמה תעלה... נסה שוב עוד רגע.';
        return;
      }

      statusEl.textContent = 'מזהה מחיר...';
      confirmBox.style.display = 'none';
      pendingPrice = null;

      const fullW = video.videoWidth;
      const fullH = video.videoHeight;

      // מלבן מרכזי 2:1
      let roiW = fullW * 0.8;
      let roiH = roiW / 2;

      if (roiH > fullH * 0.8) {
        roiH = fullH * 0.8;
        roiW = roiH * 2;
      }

      const sx = (fullW - roiW) / 2;
      const sy = (fullH - roiH) / 2;

      const targetW = Math.floor(roiW * 2);
      const targetH = Math.floor(roiH * 2);

      captureCanvas.width = targetW;
      captureCanvas.height = targetH;
      const ctx = captureCanvas.getContext('2d');

      ctx.drawImage(video, sx, sy, roiW, roiH, 0, 0, targetW, targetH);
      applyGrayscaleAndContrast(ctx, targetW, targetH);

      try {
        const result = await Tesseract.recognize(
          captureCanvas,
          'eng',
          {
            logger: () => {},
            tessedit_char_whitelist: '0123456789.,',
            user_defined_dpi: '300'
          }
        );

        const rawText = result.data.text;
        const price = extractPriceFromText(rawText);

        if (price == null) {
          statusEl.textContent =
            'לא מצאתי מחיר ברור. נסה להתקרב, ליישר את התווית או לשפר תאורה.';
          return;
        }

        const rounded = Math.round(price * 100) / 100;
        pendingPrice = rounded;
        confirmPriceEl.textContent = rounded.toFixed(2);
        confirmBox.style.display = 'block';
        statusEl.textContent = '';
      } catch (err) {
        statusEl.textContent = 'שגיאה בזיהוי מחיר: ' + err.message;
      }
    }

    function renderList() {
      itemsList.innerHTML = '';
      let total = 0;

      prices.forEach((price, index) => {
        total += price;

        const li = document.createElement('li');

        const labelSpan = document.createElement('span');
        labelSpan.className = 'item-label';
        labelSpan.textContent = 'מוצר ' + (index + 1);

        const priceSpan = document.createElement('span');
        priceSpan.className = 'item-price';
        priceSpan.textContent = price.toFixed(2);

        const delBtn = document.createElement('button');
        delBtn.className = 'delete-btn';
        delBtn.textContent = 'מחק';
        delBtn.dataset.index = index.toString();

        li.appendChild(labelSpan);
        li.appendChild(priceSpan);
        li.appendChild(delBtn);

        itemsList.appendChild(li);
      });

      totalPriceEl.textContent = total.toFixed(2);
    }

    // מחיקת מוצר בודד
    itemsList.addEventListener('click', (event) => {
      const target = event.target;
      if (target.classList.contains('delete-btn')) {
        const index = parseInt(target.dataset.index, 10);
        if (!isNaN(index)) {
          prices.splice(index, 1);
          renderList();
        }
      }
    });

    // לחיצה על "הוסף מוצר" → סריקה מהווידאו
    scanBtn.addEventListener('click', scanPriceFromVideo);

    // אישור "כן, הוסף לסל"
    confirmYesBtn.addEventListener('click', () => {
      if (pendingPrice != null) {
        prices.push(pendingPrice);
        renderList();
        statusEl.textContent = 'נוסף מוצר: ' + pendingPrice.toFixed(2) + ' ₪';
      }
      pendingPrice = null;
      confirmBox.style.display = 'none';
    });

    // "לא, אני אתקן" → עדכון ידני
    confirmEditBtn.addEventListener('click', () => {
      const current = pendingPrice != null ? pendingPrice.toFixed(2) : '';
      const manualStr = prompt('הכנס את המחיר הנכון (למשל 10.90):', current);
      if (manualStr === null) return;

      const manual = parseFloat(manualStr.replace(',', '.'));
      if (isNaN(manual) || manual <= 0) {
        alert('מחיר לא חוקי. נסה שוב.');
        return;
      }
      const rounded = Math.round(manual * 100) / 100;
      prices.push(rounded);
      renderList();
      statusEl.textContent = 'נוסף מוצר (מעודכן ידנית): ' + rounded.toFixed(2) + ' ₪';
      pendingPrice = null;
      confirmBox.style.display = 'none';
    });

    // הפעלת המצלמה כשנטען
    window.addEventListener('load', startCamera);
  </script>
</body>
</html>
