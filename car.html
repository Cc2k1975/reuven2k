<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>שליפת נתוני רכב לפי מספר רישוי</title>

  <style>
    :root{
      --bg1:#0b1224; --bg2:#071024;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.10);
      --txt:#eaf0ff;
      --muted:rgba(234,240,255,.72);
      --accent:#22c55e;
      --accent2:#16a34a;
      --danger:#ef4444;
      --radius:18px;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--txt);
      background: radial-gradient(1200px 700px at 80% -10%, rgba(34,197,94,.18), transparent 60%),
                  radial-gradient(900px 600px at 10% 10%, rgba(59,130,246,.15), transparent 55%),
                  linear-gradient(180deg,var(--bg1),var(--bg2));
      min-height:100vh;
      padding:16px;
    }
    .wrap{max-width:920px;margin:0 auto}
    .top{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--stroke);
      border-radius:24px;
      padding:16px;
      box-shadow: var(--shadow);
    }
    .title{font-weight:900;font-size:22px;margin:0 0 6px}
    .subtitle{color:var(--muted);margin:0 0 14px;font-weight:700}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--txt);
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .btn:active{transform:scale(.99)}
    .btn.accent{
      background: linear-gradient(180deg, rgba(34,197,94,.95), rgba(22,163,74,.95));
      border-color: rgba(34,197,94,.45);
      color:#052012;
    }
    .btn.ghost{
      background: rgba(255,255,255,.04);
    }
    .input{
      flex:1;
      min-width:220px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      color:var(--txt);
      font-weight:900;
      outline:none;
    }

    .panel{
      margin-top:12px;
      background: rgba(255,255,255,.05);
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:12px;
    }

    /* Live scanner */
    .scanner{
      margin-top:12px;
      display:none;
      background: rgba(0,0,0,.25);
      border:1px solid var(--stroke);
      border-radius:18px;
      overflow:hidden;
      position:relative;
    }
    .scanner.on{display:block}
    video{
      width:100%;
      height:auto;
      display:block;
      background:#000;
    }
    .frame{
      position:absolute;
      /* אזור מסגרת – תחתית הפריים, רוחב גדול, יחס מתאים ללוחית */
      left:6%;
      width:88%;
      bottom:10%;
      height:22%;
      border:3px solid rgba(34,197,94,.95);
      border-radius:18px;
      box-shadow: 0 0 0 9999px rgba(0,0,0,.18) inset;
      pointer-events:none;
    }
    .hud{
      position:absolute;
      top:10px;
      left:10px;
      right:10px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:space-between;
      pointer-events:none;
    }
    .hudBox{
      pointer-events:auto;
      background: rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.16);
      border-radius:16px;
      padding:10px 12px;
      backdrop-filter: blur(8px);
      display:flex;
      align-items:center;
      gap:10px;
      min-width:240px;
    }
    .hudTitle{font-weight:900}
    .hudSub{color:rgba(255,255,255,.75);font-weight:800;font-size:12px}
    .zoomWrap{
      display:flex;
      align-items:center;
      gap:10px;
      width:100%;
    }
    .range{
      width:100%;
      accent-color: var(--accent);
    }
    .status{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      color:var(--muted);
      font-weight:800;
      white-space:pre-wrap;
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      overflow:hidden;
      border-radius:16px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
    }
    th,td{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      font-weight:800;
      vertical-align:top;
    }
    th{color:rgba(255,255,255,.75);width:38%}
    td{color:var(--txt)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  </style>
</head>

<body>
<div class="wrap">

  <div class="top">
    <div class="title">סריקה בלייב – תעמיד את הלוחית בתוך המסגרת</div>
    <div class="subtitle">זיהוי 7/8 ספרות → מכניס לשדה → שולף נתונים אוטומטית</div>

    <div class="row">
      <button class="btn ghost" id="btnClose" style="display:none;">סגור</button>

      <input class="input" id="plateInput" inputmode="numeric" autocomplete="off"
             placeholder="מספר רכב (ללא מקפים)" />

      <button class="btn" id="btnScan">סרוק</button>
      <button class="btn accent" id="btnFetch">שלוף נתונים</button>
      <button class="btn" id="btnWhatsApp" style="display:none;">ווצאפ</button>
    </div>

    <div class="scanner" id="scanner">
      <div class="hud">
        <div class="hudBox">
          <div>
            <div class="hudTitle" id="hudTitle">מכין OCR…</div>
            <div class="hudSub" id="hudSub">תתקרב, בלי השתקפויות, ולוחית גדולה בפריים</div>
          </div>
        </div>

        <div class="hudBox" style="flex:1;min-width:260px;">
          <div style="font-weight:900;">זום</div>
          <div class="zoomWrap">
            <span class="mono" id="zoomVal">×1.0</span>
            <input class="range" id="zoomRange" type="range" min="1" max="1" step="0.1" value="1" />
          </div>
        </div>
      </div>

      <video id="video" playsinline muted></video>
      <div class="frame" id="frame"></div>
    </div>

    <div class="status" id="status">מוכן.</div>

    <div class="panel" id="resultPanel" style="display:none;">
      <div style="font-weight:900;margin-bottom:6px;">נתוני רכב</div>
      <div id="resultMeta" style="color:var(--muted);font-weight:800"></div>
      <table id="resultTable"></table>
    </div>
  </div>

</div>

<script>
(() => {
  // ====== CKAN / data.gov.il ======
  const RESOURCE_ID = "053cea08-09bc-40ec-8f7a-156f0677aff3";

  // שדות שלא מציגים (כמו שביקשת)
  const HIDE_FIELDS = new Set([
    "zmig_kidmi",
    "zmig_ahori",
    "misgeret",
    "mispar_horaa",
    "tozeret_cd",
    "degem_cd",
    "degem_manoa",
    "tzeva_cd",
    "sug_degem",
    "_id",
    "rank"
  ]);

  // תרגום שמות שדות לתצוגה יפה (אפשר להרחיב בלי לשנות לוגיקה)
  const LABELS = {
    "mispar_rechev":"מספר רכב",
    "tozeret_nm":"יצרן / שם תוצר",
    "degem_nm":"דגם",
    "kinuy_mishari":"כינוי מסחרי",
    "ramat_gimur":"רמת גימור",
    "shnat_yitzur":"שנת ייצור",
    "baalut":"בעלות",
    "tokef_dt":"תוקף הרישוי",
    "test_dt":"טסט אחרון",
    "sug_delek_nm":"סוג דלק",
    "kvutzat_zihum":"קבוצת זיהום",
    "ramat_eivzur_betihuti":"רמת אבזור בטיחותי",
    "tzeva_rechev":"צבע"
  };

  // ====== Tesseract local files ======
  const LOCAL_TESS_BASE = "/tess";

  const $ = (id) => document.getElementById(id);

  const plateInput = $("plateInput");
  const btnScan = $("btnScan");
  const btnFetch = $("btnFetch");
  const btnClose = $("btnClose");
  const btnWhatsApp = $("btnWhatsApp");
  const scanner = $("scanner");
  const video = $("video");
  const frame = $("frame");
  const status = $("status");
  const hudTitle = $("hudTitle");
  const hudSub = $("hudSub");
  const zoomRange = $("zoomRange");
  const zoomVal = $("zoomVal");
  const resultPanel = $("resultPanel");
  const resultTable = $("resultTable");
  const resultMeta = $("resultMeta");

  let stream = null;
  let track = null;
  let worker = null;
  let scanning = false;
  let busyOCR = false;
  let lastGoodPlate = "";
  let lastRecord = null;

  function setStatus(msg){
    status.textContent = msg;
  }

  function onlyDigits(s){
    return (s || "").replace(/[^\d]/g,"");
  }

  function extractPlate(text){
    // מוציא רק ספרות גם אם OCR מחזיר נקודות/מקפים/רווחים
    const digits = onlyDigits(text);
    if (digits.length === 7 || digits.length === 8) return digits;

    // נסה למצוא רצף 7-8 ספרות בתוך הטקסט
    const m = text.match(/\d{7,8}/g);
    if (m && m.length){
      // בחר את הראשון עם 7/8
      const cand = m[0];
      if (cand.length === 7 || cand.length === 8) return cand;
    }

    // לפעמים OCR מוסיף ספרה כפולה – ננסה "לגלח" לרצף הכי סביר
    if (digits.length > 8){
      const mm = digits.match(/\d{8}/);
      if (mm) return mm[0];
    }
    return "";
  }

  async function loadScript(src){
    return new Promise((resolve, reject)=>{
      const s = document.createElement("script");
      s.src = src;
      s.async = true;
      s.onload = ()=>resolve(src);
      s.onerror = ()=>reject(new Error("נכשל טעינת סקריפט: " + src));
      document.head.appendChild(s);
    });
  }

  async function ensureTesseractLoaded(){
    if (window.Tesseract) return;
    await loadScript(`${LOCAL_TESS_BASE}/tesseract.min.js`);
    if (!window.Tesseract) throw new Error("Tesseract לא נטען");
  }

  async function ensureWorker(){
    if (worker) return worker;

    await ensureTesseractLoaded();

    hudTitle.textContent = "מכין OCR…";
    setStatus("טוען OCR מקומי…\n" + LOCAL_TESS_BASE);

    worker = await Tesseract.createWorker("eng", 1, {
      workerPath: `${LOCAL_TESS_BASE}/worker.min.js`,
      corePath:   `${LOCAL_TESS_BASE}/tesseract-core.wasm.js`,
      langPath:   "https://tessdata.projectnaptha.com/4.0.0",
      logger: (m)=> {
        // אפשר לפתוח לוג אם תרצה
      }
    });

    await worker.setParameters({
      tessedit_char_whitelist: "0123456789",
      tessedit_pageseg_mode: "7",
      classify_bln_numeric_mode: "1"
    });

    hudTitle.textContent = "Worker OK";
    setStatus("Worker OK.\nמוכן לסריקה בלייב.");
    return worker;
  }

  async function openCamera(){
    if (stream) return;

    hudTitle.textContent = "פותח מצלמה…";
    setStatus("פותח מצלמה…");

    stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { ideal:"environment" },
        width: { ideal: 1280 },
        height:{ ideal: 720 }
      },
      audio:false
    });

    video.srcObject = stream;
    await video.play();

    track = stream.getVideoTracks()[0];

    // Zoom capabilities
    const caps = track.getCapabilities ? track.getCapabilities() : null;
    if (caps && caps.zoom){
      zoomRange.min = caps.zoom.min;
      zoomRange.max = caps.zoom.max;
      zoomRange.step = (caps.zoom.step || 0.1);
      zoomRange.value = (track.getSettings().zoom || caps.zoom.min);
      zoomVal.textContent = "×" + Number(zoomRange.value).toFixed(1);
      zoomRange.disabled = false;
    } else {
      zoomRange.value = 1;
      zoomVal.textContent = "×1.0";
      zoomRange.disabled = true;
    }

    zoomRange.oninput = async () => {
      if (!track || !track.applyConstraints) return;
      const z = Number(zoomRange.value);
      zoomVal.textContent = "×" + z.toFixed(1);
      try{
        await track.applyConstraints({ advanced: [{ zoom: z }] });
      }catch(e){
        // לא כל מכשיר תומך
      }
    };
  }

  function closeCamera(){
    scanning = false;
    busyOCR = false;

    if (stream){
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
      track = null;
    }
    scanner.classList.remove("on");
    btnClose.style.display = "none";
    hudTitle.textContent = "מוכן.";
  }

  function getFrameCropBox(videoW, videoH){
    // התאמה לאחוזים של המסגרת הירוקה (לפי CSS)
    // left 6%, width 88%, bottom 10%, height 22%
    const left = 0.06 * videoW;
    const width = 0.88 * videoW;
    const height = 0.22 * videoH;
    const top = videoH - (0.10 * videoH) - height;

    // "חיתוך פנימי" קטן כדי להוריד שוליים ירוקים/מסגרת/רעש
    const padX = width * 0.03;
    const padY = height * 0.10;

    return {
      x: Math.max(0, left + padX),
      y: Math.max(0, top + padY),
      w: Math.max(1, width - 2*padX),
      h: Math.max(1, height - 2*padY)
    };
  }

  function preprocessToCanvas(srcCanvas, mode){
    const sw = srcCanvas.width, sh = srcCanvas.height;
    const ctx = srcCanvas.getContext("2d", { willReadFrequently:true });
    const img = ctx.getImageData(0,0,sw,sh);
    const d = img.data;

    // Grayscale + contrast + (optional) threshold
    // mode 1: threshold; mode 2: contrast only
    // הגדרות שמכוונות ללוחית צהובה עם ספרות שחורות
    let sum = 0;
    for (let i=0;i<d.length;i+=4){
      const r=d[i], g=d[i+1], b=d[i+2];
      const y = (0.299*r + 0.587*g + 0.114*b);
      sum += y;
    }
    const mean = sum / (d.length/4);

    // קונטרסט
    const contrast = 1.35; // 1.0 = ללא שינוי
    const bias = -20;      // מוריד בהירות מעט

    for (let i=0;i<d.length;i+=4){
      const r=d[i], g=d[i+1], b=d[i+2];
      let y = (0.299*r + 0.587*g + 0.114*b);

      // contrast around mean
      y = (y - mean) * contrast + mean + bias;
      if (y<0) y=0; if (y>255) y=255;

      if (mode === 1){
        // threshold דינמי: מעט מתחת לממוצע
        const th = mean - 10;
        const v = (y < th) ? 0 : 255;
        d[i]=d[i+1]=d[i+2]=v;
      } else {
        d[i]=d[i+1]=d[i+2]=y;
      }
      d[i+3]=255;
    }
    ctx.putImageData(img,0,0);
    return srcCanvas;
  }

  function makeROIFromVideo(){
    const vw = video.videoWidth;
    const vh = video.videoHeight;
    if (!vw || !vh) return null;

    const box = getFrameCropBox(vw, vh);

    // ROI canvas – הגדלה משמעותית לפני OCR
    const scale = 2.6;
    const outW = Math.round(box.w * scale);
    const outH = Math.round(box.h * scale);

    const c = document.createElement("canvas");
    c.width = outW;
    c.height = outH;

    const ctx = c.getContext("2d", { willReadFrequently:true });
    ctx.imageSmoothingEnabled = false;
    ctx.drawImage(video, box.x, box.y, box.w, box.h, 0, 0, outW, outH);

    return c;
  }

  async function scanLoop(){
    if (!scanning) return;
    if (busyOCR) {
      requestAnimationFrame(scanLoop);
      return;
    }

    const t0 = performance.now();
    try{
      const roi = makeROIFromVideo();
      if (!roi){
        requestAnimationFrame(scanLoop);
        return;
      }

      busyOCR = true;

      // ניסיון 1: threshold
      const c1 = roi;
      preprocessToCanvas(c1, 1);
      const r1 = await worker.recognize(c1);
      let plate = extractPlate(r1?.data?.text || "");

      // ניסיון 2: אם לא מצא – contrast בלי threshold
      if (!plate){
        const c2 = makeROIFromVideo();
        preprocessToCanvas(c2, 2);
        const r2 = await worker.recognize(c2);
        plate = extractPlate(r2?.data?.text || "");
      }

      const dt = performance.now() - t0;

      if (plate){
        lastGoodPlate = plate;
        hudTitle.textContent = "זוהה: " + plate;
        hudSub.textContent = "מכניס לשדה ושולף נתונים…";
        setStatus(`זוהה מספר: ${plate}\nפריים: ${dt.toFixed(0)}ms`);

        // פידבק
        try{ navigator.vibrate && navigator.vibrate(90); }catch(e){}

        plateInput.value = plate;
        closeCamera();
        await fetchVehicle();
        return;
      } else {
        hudTitle.textContent = "סורק…";
        hudSub.textContent = "תקרב עוד קצת, תיישר, ותמלא את המסגרת בלוחית";
        setStatus(`סורק…\nפריים: ${dt.toFixed(0)}ms • עדיין לא זוהה`);
      }

    } catch(e){
      setStatus("שגיאה בסריקה:\n" + (e?.message || e));
    } finally {
      busyOCR = false;
      // throttle – לא כל מילישנייה (יותר יציב + פחות תקיעות)
      setTimeout(()=>requestAnimationFrame(scanLoop), 220);
    }
  }

  async function openLiveScanner(){
    try{
      scanner.classList.add("on");
      btnClose.style.display = "inline-block";
      await openCamera();
      await ensureWorker();
      scanning = true;
      scanLoop();
    } catch(e){
      setStatus("openLiveScanner FAILED:\n" + (e?.message || e));
      closeCamera();
    }
  }

  async function fetchVehicle(){
    const plate = onlyDigits(plateInput.value);
    if (!(plate.length === 7 || plate.length === 8)){
      setStatus("מספר רכב חייב להיות 7 או 8 ספרות (ללא מקפים).");
      return;
    }

    setStatus("שולף נתונים…");

    const url = "https://data.gov.il/api/3/action/datastore_search";
    const body = {
      resource_id: RESOURCE_ID,
      filters: { mispar_rechev: Number(plate) },
      limit: 1
    };

    try{
      const res = await fetch(url, {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });

      const json = await res.json();
      const rec = json?.result?.records?.[0];

      if (!rec){
        lastRecord = null;
        resultPanel.style.display = "none";
        btnWhatsApp.style.display = "none";
        setStatus("לא נמצאו תוצאות למספר: " + plate);
        return;
      }

      lastRecord = rec;
      renderRecord(rec);
      setStatus("נמצא רכב – הנתונים מוצגים למטה.");
    } catch(e){
      setStatus("שגיאת שליפה:\n" + (e?.message || e));
    }
  }

  function prettyLabel(k){
    return LABELS[k] || k;
  }

  function renderRecord(rec){
    // בונה טבלה לפי הרשומות (ומסתיר שדות שביקשת)
    const rows = [];

    // תמיד נרצה שמספר רכב יהיה ראשון
    const keys = Object.keys(rec);
    keys.sort((a,b)=>{
      if (a === "mispar_rechev") return -1;
      if (b === "mispar_rechev") return 1;
      return a.localeCompare(b);
    });

    for (const k of keys){
      if (HIDE_FIELDS.has(k)) continue;
      const v = rec[k];
      if (v === null || v === undefined || v === "") continue;

      rows.push(`
        <tr>
          <th>${escapeHtml(prettyLabel(k))}</th>
          <td>${escapeHtml(String(v))}</td>
        </tr>
      `);
    }

    resultTable.innerHTML = rows.join("");
    resultMeta.textContent = `מספר: ${rec.mispar_rechev} • מקור: data.gov.il`;
    resultPanel.style.display = "block";
    btnWhatsApp.style.display = "inline-block";
  }

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, (c)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }

  function buildWhatsAppText(rec){
    const lines = [];
    const plate = rec?.mispar_rechev ? String(rec.mispar_rechev) : "";
    lines.push("נתוני רכב לפי מספר רישוי");
    if (plate) lines.push("מספר רכב: " + plate);

    const keys = Object.keys(rec);
    for (const k of keys){
      if (HIDE_FIELDS.has(k)) continue;
      const v = rec[k];
      if (v === null || v === undefined || v === "") continue;
      const label = prettyLabel(k);
      lines.push(`${label}: ${String(v)}`);
    }

    return lines.join("\n");
  }

  function openWhatsApp(){
    if (!lastRecord){
      setStatus("אין נתונים לשליחה בווצאפ.");
      return;
    }
    const text = buildWhatsAppText(lastRecord);
    const url = "https://wa.me/?text=" + encodeURIComponent(text);
    window.open(url, "_blank");
  }

  // ===== UI events =====
  btnScan.addEventListener("click", openLiveScanner);
  btnClose.addEventListener("click", closeCamera);
  btnFetch.addEventListener("click", fetchVehicle);
  btnWhatsApp.addEventListener("click", openWhatsApp);

  plateInput.addEventListener("input", ()=>{
    // מאפשר למשתמש להקליד עם מקפים/נקודות – נשמור רק ספרות
    const d = onlyDigits(plateInput.value);
    if (plateInput.value !== d) plateInput.value = d;
  });

})();
</script>

</body>
</html>
