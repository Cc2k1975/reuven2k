<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>×¤×Ÿ ××§×¡×¤×¨×¡ â€“ ×§×‘×™×¢×ª ×ª×•×¨</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#e8f4f8;margin:0;padding:0}
  .wrap{max-width:520px;margin:40px auto;padding:24px;background:#fff;border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.08)}
  h1{margin:0 0 6px;font-size:32px;color:#0c5e78;text-align:center}
  h2{margin:0 0 22px;font-size:20px;color:#2a6f83;text-align:center}
  label{display:block;margin:14px 4px 6px;font-weight:600;color:#2d3a40}
  input,select,button{width:100%;padding:12px 14px;border:1px solid #cfe3ea;border-radius:10px;font-size:16px;box-sizing:border-box;background:#f9feff}
  input[type="tel"]{text-align:right;}
  .btn{background:#12acc5;color:#fff;border:0;cursor:pointer;margin-top:18px;font-weight:700}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .error{background:#ffecec;color:#b00020;border:1px solid #f6c; padding:10px;border-radius:10px;margin-top:10px;display:none}
  .success{background:#eafff2;color:#0a7a3f;border:1px solid #a6e7c3; padding:10px;border-radius:10px;margin-top:10px;display:none}
  option.taken{color:#888;background:#f1f1f1}
  .ver{margin-top:14px;font-size:12px;color:#678;text-align:center}

  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{background:#fff;border-radius:14px;max-width:420px;width:92%;padding:18px 18px 12px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
  .modal h3{margin:0 0 8px;font-size:20px;color:#0c5e78}
  .modal p{margin:0 0 14px;color:#334;white-space:pre-line}
  .modal .row{display:flex;gap:10px;justify-content:space-between}
  .modal .row button{flex:1;padding:12px;border-radius:10px;border:0;font-weight:700}
  .modal .cancel{background:#eef3f6;color:#334}
  .modal .ok{background:#12acc5;color:#fff}
</style>
</head>
<body>
  <div class="wrap">
    <h1>×¤×Ÿ ××§×¡×¤×¨×¡</h1>
    <h2>×§×‘×™×¢×ª ×ª×•×¨</h2>

    <div id="msgError" class="error"></div>
    <div id="msgOk" class="success"></div>

    <label for="date">×‘×—×¨ ×ª××¨×™×š:</label>
    <input type="date" id="date" required />

    <label for="time">×©×¢×” ×¤× ×•×™×”:</label>
    <select id="time" required>
      <option value="">×˜×•×¢×Ÿ ×©×¢×•×ªâ€¦</option>
    </select>

    <label for="name">×©× ×”×œ×§×•×—×”:</label>
    <input type="text" id="name" placeholder="×”×›× ×¡ ×©×" required />

    <label for="phone">××¡×¤×¨ ×˜×œ×¤×•×Ÿ:</label>
    <input type="tel" id="phone" placeholder="×”×›× ×¡ ×˜×œ×¤×•×Ÿ" required />

    <button id="save" class="btn">×©××•×¨</button>
    <div class="ver">Version: 1.5.2</div>
  </div>

  <!-- Modal -->
  <div id="icsModal" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h3>×œ×”×•×¡×™×£ ×ª×–×›×•×¨×ª ×œ×™×•××Ÿ?</h3>
      <p id="icsText">× ×™×¦×•×¨ ××™×¨×•×¢ ×œ×™×•××Ÿ ×‘×ª××¨×™×š ___ ×‘×©×¢×” ___ ×›×•×œ×œ ×ª×–×›×•×¨×ª ×©×¢×” ×œ×¤× ×™.
×œ×§×•×—×” ×™×§×¨×”, ××–×›×™×¨×” ×œ×š ×œ×”×’×™×¢ ×—×¤×•×¤×” ×•×‘×–××Ÿ ğŸ’‡â€â™€ï¸
×ª×•×“×” - ×¤×Ÿ ××§×¡×¤×¨×¡</p>
      <div class="row">
        <button type="button" class="cancel" id="btnCancel">×‘×™×˜×•×œ</button>
        <button type="button" class="ok" id="btnOk">××™×©×•×¨</button>
      </div>
    </div>
  </div>

<script>
const BIN_ID = '68f0e7bed0ea881f40a63b29';
const MASTER_KEY = '$2a$10$4rynniEMuvwqg2nDb5KSEe/lAVYp8a7L3xWzp9GsO6n49OfXc3FCO';
const BIN_URL = 'https://api.jsonbin.io/v3/b/' + BIN_ID;

const MAP_URL = 'https://maps.google.com/?q=33.003292,35.108864';
const TIMEZONE = 'Asia/Jerusalem';
const EVENT_TITLE = '×ª×•×¨ ×œ×¤×Ÿ â€“ ×¤×Ÿ ××§×¡×¤×¨×¡';
const ALARM_MINUTES = 60;
const SLOT_MINUTES = 20;

const pad2 = n => (n<10?('0'+n):''+n);
function genTimeSlots(){
  const slots=[]; for(let h=8; h<=20; h++){ for(let m of [0,20,40]){ if(h===20 && m>0) continue; slots.push(`${pad2(h)}:${pad2(m)}`);} }
  return slots;
}
const SLOTS = genTimeSlots();

function todayStr(){ return new Date().toISOString().slice(0,10); }
function addDaysStr(days){ const d=new Date(); d.setDate(d.getDate()+days); return d.toISOString().slice(0,10); }
function setDateLimits(){ elDate.min=todayStr(); elDate.max=addDaysStr(3); if(!elDate.value) elDate.value=todayStr(); }
function fmtDateHeb(s){ const [y,m,d]=s.split('-'); return `${d}.${m}.${y}`; }

const elDate=document.getElementById('date');
const elTime=document.getElementById('time');
const elName=document.getElementById('name');
const elPhone=document.getElementById('phone');
const elSave=document.getElementById('save');
const msgErr=document.getElementById('msgError');
const msgOk=document.getElementById('msgOk');
const icsModal=document.getElementById('icsModal');
const btnOk=document.getElementById('btnOk');
const btnCancel=document.getElementById('btnCancel');
const icsText=document.getElementById('icsText');

function showErr(t){ msgErr.textContent=t; msgErr.style.display='block'; setTimeout(()=>msgErr.style.display='none',4000); }
function showOk(t){ msgOk.textContent=t; msgOk.style.display='block'; setTimeout(()=>msgOk.style.display='none',4000); }

setDateLimits();

async function fetchRecord(){
  const r=await fetch(BIN_URL+'?ts='+Date.now(),{headers:{'X-Master-Key':MASTER_KEY},cache:'no-store'});
  if(!r.ok) throw new Error('fetch failed');
  const j=await r.json();
  return (j.record && Array.isArray(j.record.bookings))? j.record : {bookings:[]};
}
async function putRecord(rec){
  const r=await fetch(BIN_URL+'?ts='+Date.now(),{method:'PUT',headers:{'Content-Type':'application/json','X-Master-Key':MASTER_KEY},body:JSON.stringify(rec),cache:'no-store'});
  if(!r.ok) throw new Error('put failed');
  return r.json().catch(()=> ({}));
}

async function refreshTimes(){
  elTime.innerHTML = `<option value="">×˜×•×¢×Ÿâ€¦</option>`;
  try{
    const {bookings}=await fetchRecord();
    const date=elDate.value;
    const taken=new Set(bookings.filter(b=>b.date===date).map(b=>b.time));
    elTime.innerHTML = `<option value="">×‘×—×¨ ×©×¢×”â€¦</option>` + SLOTS.map(t=>{
      const isTaken=taken.has(t);
      return `<option value="${t}" ${isTaken?'disabled class="taken"':''}>${t}${isTaken?' â€“ ×ª×¤×•×¡':''}</option>`;
    }).join('');
  }catch(e){ showErr('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×'); }
}
elDate.addEventListener('change',refreshTimes);
refreshTimes();

function validPhone(p){ return (p||'').replace(/\D/g,'').length>=8; }
function normalizePhone(p){ return (p||'').replace(/\D/g,''); }

function toICSLocal(dateStr,timeStr){
  const [y,m,d]=dateStr.split('-').map(Number);
  const [hh,mm]=timeStr.split(':').map(Number);
  const dt=new Date(y,m-1,d,hh,mm,0);
  return `${dt.getFullYear()}${pad2(dt.getMonth()+1)}${pad2(dt.getDate())}T${pad2(dt.getHours())}${pad2(dt.getMinutes())}00`;
}
function buildICS({title,location,startLocal,endLocal,tzid}){
  const uid=`${Date.now()}-${Math.random().toString(36).slice(2)}@fenexpress`;
  const dtstamp=new Date().toISOString().replace(/[-:]/g,'').replace(/\.\d{3}Z$/,'Z');
  const details=`×§×™×©×•×¨ ×™×©×™×¨ ×œ×”×’×¢×” ×œ×¤×Ÿ ××§×¡×¤×¨×¡:\n${MAP_URL}`;
  return [
    'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//FenExpress//Booking//HE','CALSCALE:GREGORIAN','METHOD:PUBLISH','BEGIN:VEVENT',
    `UID:${uid}`,`DTSTAMP:${dtstamp}`,`DTSTART;TZID=${tzid}:${startLocal}`,`DTEND;TZID=${tzid}:${endLocal}`,
    `SUMMARY:${title}`,`DESCRIPTION:${details.replace(/\n/g,'\\n')}`,`LOCATION:${location}`,
    'BEGIN:VALARM',`TRIGGER:-PT${ALARM_MINUTES}M`,'ACTION:DISPLAY','DESCRIPTION:Reminder','END:VALARM','END:VEVENT','END:VCALENDAR'
  ].join('\r\n');
}
function downloadICS(filename,content){
  const blob=new Blob([content],{type:'text/calendar;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download=filename;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},1200);
}

function openCalendarForPlatform(dateStr,timeStr){
  const [y,m,d]=dateStr.split('-').map(Number);
  const [hh,mm]=timeStr.split(':').map(Number);
  const start=new Date(y,m-1,d,hh,mm,0);
  const end=new Date(start.getTime()+SLOT_MINUTES*60000);

  const ua = navigator.userAgent || '';
  const isAndroid = /Android/i.test(ua);
  const isIOS = /iPhone|iPad|iPod/i.test(ua);

  if(isAndroid){
    const fmt = (dt)=>`${dt.getFullYear()}${pad2(dt.getMonth()+1)}${pad2(dt.getDate())}T${pad2(dt.getHours())}${pad2(dt.getMinutes())}00`;
    const dates = `${fmt(start)}/${fmt(end)}`;
    const text = encodeURIComponent(EVENT_TITLE);
    const details = encodeURIComponent(`×§×™×©×•×¨ ×™×©×™×¨ ×œ×”×’×¢×” ×œ×¤×Ÿ ××§×¡×¤×¨×¡:\n${MAP_URL}`);
    const loc = encodeURIComponent(MAP_URL);
    const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${dates}&details=${details}&location=${loc}`;
    window.location.href = url;
  }else{
    const startLocal=toICSLocal(dateStr,timeStr);
    const endLocal=`${end.getFullYear()}${pad2(end.getMonth()+1)}${pad2(end.getDate())}T${pad2(end.getHours())}${pad2(end.getMinutes())}00`;
    const ics = buildICS({title:EVENT_TITLE,location:MAP_URL,startLocal,endLocal,tzid:TIMEZONE});
    downloadICS('fen-appointment.ics', ics);
  }
}

let lastSavedPayload=null;
elSave.addEventListener('click',async ()=>{
  const payload={date:elDate.value,time:elTime.value,name:elName.value.trim(),phone:elPhone.value.trim()};
  if(!payload.date||!payload.time||!payload.name||!payload.phone){showErr('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª');return;}
  if(!validPhone(payload.phone)){showErr('××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×ª×§×™×Ÿ');return;}

  elSave.disabled=true;
  try{
    let rec=await fetchRecord();
    const normPhone=normalizePhone(payload.phone);
    const existsSameDayPhone=rec.bookings.some(b=>b.date===payload.date && normalizePhone(b.phone)===normPhone);
    if(existsSameDayPhone){showErr('×§×™×™× ×›×‘×¨ ×ª×•×¨ ×¢×œ ×©××š ×œ××•×ª×• ×™×•×. × × ×œ×‘×—×•×¨ ×ª××¨×™×š ××—×¨.'); elSave.disabled=false; await refreshTimes(); return;}
    if(rec.bookings.some(b=>b.date===payload.date && b.time===payload.time)){showErr('×”×©×¢×” × ×ª×¤×¡×” ×”×¨×’×¢. ×‘×—×¨ ×©×¢×” ××—×¨×ª.'); elSave.disabled=false; await refreshTimes(); return;}

    rec.bookings.push({date:payload.date,time:payload.time,name:payload.name,phone:payload.phone,ts:Date.now()});
    await putRecord(rec);

    lastSavedPayload=payload;
    showOk('×”×ª×•×¨ × ×©××¨ ×‘×”×¦×œ×—×”!');
    icsText.textContent=`× ×•×¦×¨ ××™×¨×•×¢ ×œ×™×•××Ÿ ×‘×ª××¨×™×š ${fmtDateHeb(payload.date)} ×‘×©×¢×” ${payload.time} ×›×•×œ×œ ×ª×–×›×•×¨×ª ×©×¢×” ×œ×¤× ×™.\n×œ×§×•×—×” ×™×§×¨×”, ××–×›×™×¨×” ×œ×š ×œ×”×’×™×¢ ×—×¤×•×¤×” ×•×‘×–××Ÿ ğŸ’‡â€â™€ï¸\n×ª×•×“×” - ×¤×Ÿ ××§×¡×¤×¨×¡`;
    icsModal.style.display='flex';

    await new Promise(r=>setTimeout(r,300));
    await refreshTimes();
    elTime.value=""; elName.value=""; elPhone.value="";
  }catch(e){ showErr('×©×’×™××ª ×¨×©×ª'); }
  finally{ elSave.disabled=false; }
});

btnCancel.addEventListener('click',()=>{ icsModal.style.display='none'; });
btnOk.addEventListener('click',()=>{
  icsModal.style.display='none';
  if(!lastSavedPayload) return;
  openCalendarForPlatform(lastSavedPayload.date,lastSavedPayload.time);
});
</script>
</body>
</html>
