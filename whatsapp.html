<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>WhatsApp Direct - Stable</title>
  <style>
    :root { --wa-green:#25D366; --wa-dark:#075E54; }
    body{
      font-family:system-ui,sans-serif;background:#f0f2f5;
      display:flex;justify-content:center;align-items:center;
      min-height:100vh;margin:0;padding:15px;
      user-select:none;-webkit-user-select:none;touch-action:manipulation;
    }
    .card{background:#fff;padding:25px;border-radius:20px;box-shadow:0 4px 20px rgba(0,0,0,.15);width:100%;max-width:400px;text-align:center;}
    .box{background:#f8f9fa;border:2px solid #eaebec;border-radius:12px;padding:15px;margin-bottom:15px;text-align:right;}
    .label{font-size:12px;color:#666;font-weight:700;}
    .field{font-size:18px;font-weight:700;color:var(--wa-dark);min-height:25px;word-break:break-all;}
    .ptt-btn{
      width:180px;height:180px;border-radius:50%;border:none;
      background:#34b7f1;color:#fff;font-size:20px;font-weight:800;
      cursor:pointer;box-shadow:0 6px 15px rgba(0,0,0,.2);
      margin:20px auto;display:block;transition:transform .1s;
      -webkit-tap-highlight-color:transparent;
    }
    .ptt-btn:active{background:#ff4b2b;transform:scale(.95);}
    .btn-paste{width:100%;padding:14px;background:#6c757d;color:#fff;border:none;border-radius:10px;font-weight:800;cursor:pointer;}
  </style>
</head>
<body>

<div class="card">
  <h2 style="color:var(--wa-dark);margin-top:0;">专 砖</h2>

  <div class="box">
    <div class="label">住驻专 注:</div>
    <div id="phoneField" class="field">---</div>
  </div>

  <div class="box">
    <div class="label">注:</div>
    <div id="msgField" class="field" style="font-weight:normal;">---</div>
  </div>

  <button class="btn-paste" onclick="pasteFromClipboard()"> 拽 住驻专 专</button>

  <button id="pttBtn" class="ptt-btn">抓 拽<br></button>

  <p id="status" style="font-size:14px;color:#888;">专 住驻专  注 砖专专</p>

  <button class="btn-paste" style="background:#eee;color:#333;margin-top:10px;" onclick="location.reload()">拽 </button>
</div>

<script>
  let recognition = null;
  let lockedNumber = "";
  let finalMsg = "";
  let finalTranscript = "";
  let isListening = false;

  function safeInitRecognition(){
    if (recognition) return true;

    const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!Speech){
      alert("驻驻  转  专 砖专 . 住 Chrome.");
      return false;
    }

    recognition = new Speech();
    recognition.lang = "he-IL";
    recognition.continuous = true;
    recognition.interimResults = true;

    recognition.onstart = () => {
      document.getElementById("status").innerText = "拽砖... 砖专专 砖";
    };

    recognition.onerror = (e) => {
      isListening = false;
      document.getElementById("status").innerText = "砖  专: " + (e.error || "");
    };

    recognition.onresult = (event) => {
      let interim = "";

      for (let i = event.resultIndex; i < event.results.length; i++) {
        const t = (event.results[i][0].transcript || "").trim();
        if (!t) continue;

        if (event.results[i].isFinal) {
          finalTranscript += (finalTranscript ? " " : "") + t;
        } else {
          interim += (interim ? " " : "") + t;
        }
      }

      const latestText = (finalTranscript + " " + interim).trim();
      processText(latestText);
    };

    return true;
  }

  // 爪 住驻专 砖专   砖 专/拽驻
  function extractIsraeliPhone(text){
    const matches = text.match(/0[\d\s\-]{7,20}\d/g) || [];
    for (const m of matches){
      const d = m.replace(/\D/g,'');
      if (d.length === 10 && d.startsWith('05')) return d; //  转拽
      if (d.length === 9) return d; // 驻砖专 拽/专
    }
    // fallback  专爪祝 转  住驻专转
    const all = text.replace(/\D/g,'');
    const mm = all.match(/05\d{8}/);
    return mm ? mm[0] : "";
  }

  function processText(text){
    const phoneElem = document.getElementById("phoneField");
    const msgElem = document.getElementById("msgField");

    if (!lockedNumber){
      const found = extractIsraeliPhone(text);
      if (found){
        lockedNumber = found;
        phoneElem.innerText = lockedNumber;
      }
    }

    let msg = text;

    if (lockedNumber){
      // 拽 转 住驻专 拽住   专 注 拽驻/专
      const loose = new RegExp(lockedNumber.split('').join('\\D*'), 'g');
      msg = msg.replace(loose, " ");
    }

    // 住专  住驻专  砖 住 住驻专 注
    msg = msg.replace(/\d/g, " ");
    // 拽 驻 专
    msg = msg.replace(/\s+/g, " ").trim();

    msgElem.innerText = msg || "---";
    finalMsg = msg;
  }

  function startListening(){
    if (!safeInitRecognition()) return;

    lockedNumber = "";
    finalMsg = "";
    finalTranscript = "";
    isListening = true;

    document.getElementById("phoneField").innerText = "---";
    document.getElementById("msgField").innerText = "---";
    document.getElementById("status").innerText = "拽砖... 砖专专 砖";

    try { recognition.start(); } catch(e) { /*  专 专抓 -  拽专住 */ }
  }

  function stopAndSend(){
    if (!recognition || !isListening) return;

    isListening = false;
    try { recognition.stop(); } catch(e) {}

    const num = (lockedNumber || "").replace(/\D/g,'');
    if (num.length >= 9){
      const cleanNum = num.startsWith('0') ? ('972' + num.substring(1)) : num;
      window.location.href = `https://wa.me/${cleanNum}?text=${encodeURIComponent(finalMsg)}`;
    } else {
      document.getElementById("status").innerText = "  住驻专  转拽";
    }
  }

  const btn = document.getElementById("pttBtn");

  // 专: touchstart/touchend  爪
  btn.addEventListener("touchstart", (e)=>{ e.preventDefault(); startListening(); }, {passive:false});
  btn.addEventListener("touchend", (e)=>{ e.preventDefault(); stopAndSend(); }, {passive:false});
  // 住拽驻: mouse
  btn.addEventListener("mousedown", (e)=>{ e.preventDefault(); startListening(); });
  btn.addEventListener("mouseup", (e)=>{ e.preventDefault(); stopAndSend(); });

  async function pasteFromClipboard(){
    try{
      const text = await navigator.clipboard.readText();
      const digits = (text || "").replace(/\D/g,'');
      if (digits.length === 10 && digits.startsWith("05")){
        lockedNumber = digits;
        document.getElementById("phoneField").innerText = lockedNumber;
        document.getElementById("status").innerText = "住驻专 拽. 注砖 抓 拽 专 注.";
      } else {
        alert("  住驻专  转拽 ");
      }
    } catch(e){
      alert("砖专 砖 ");
    }
  }

  window.oncontextmenu = (e)=>{ e.preventDefault(); return false; };
</script>

</body>
</html>
