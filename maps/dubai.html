<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Dubai Smart Finder</title>
    <style>
        body { margin: 0; background: #1a1a1a; font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* שורת חיפוש עליונה */
        .header { 
            position: fixed; top: 0; width: 100%; height: 70px; 
            background: #222; display: flex; align-items: center; 
            padding: 0 10px; gap: 8px; z-index: 1000; box-sizing: border-box;
        }
        input { flex: 1; padding: 12px; border-radius: 8px; border: none; background: #333; color: white; font-size: 16px; outline: none; }
        .search-btn { padding: 10px 18px; background: #ff4757; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .settings-btn { background: none; border: none; font-size: 20px; cursor: pointer; filter: grayscale(1); }

        /* אזור המפה */
        .viewport { margin-top: 70px; flex: 1; overflow: auto; background: white; position: relative; }
        .container { position: relative; display: inline-block; }
        
        /* גודל התמונה ב-1200 פיקסלים כדי שתהיה חדה ונוחה לגלילה */
        #metro-map { display: block; width: 1200px; height: auto; }

        /* הנעץ */
        #pin { 
            position: absolute; width: 38px; height: 38px; 
            background: url('https://cdn-icons-png.flaticon.com/512/684/684908.png') no-repeat center;
            background-size: contain; transform: translate(-50%, -100%);
            display: none; z-index: 50; animation: bounce 0.5s infinite alternate;
            pointer-events: none;
        }
        @keyframes bounce { from { transform: translate(-50%, -100%); } to { transform: translate(-50%, -110%); } }

        /* בועית שם המקום */
        #label {
            position: absolute; background: rgba(255, 71, 87, 0.9); color: white;
            padding: 4px 10px; border-radius: 5px; font-size: 12px; font-weight: bold;
            transform: translate(-50%, -240%); display: none; white-space: nowrap;
        }
    </style>
</head>
<body>

    <div class="header">
        <button class="settings-btn" onclick="toggleCalib()">⚙️</button>
        <input type="text" id="searchInput" placeholder="חפש מסעדה, מלון או אטרקציה...">
        <button class="search-btn" onclick="runSearch()">חפש</button>
    </div>

    <div class="viewport" id="view">
        <div class="container">
            <img src="metro.jpg" id="metro-map">
            <div id="pin"></div>
            <div id="label"></div>
        </div>
    </div>

    <script>
        let isCalib = false;

        // --- מנוע ההמרה (כיול) ---
        // עוגן 1: בורג' חליפה (לפי הנתונים ששלחת)
        const a1 = { lat: 25.1972, lon: 55.2744, x: 45.7, y: 36.3 };
        // עוגן 2: אקספו 2020 (נקודת קצה לחישוב המרחקים)
        const a2 = { lat: 24.9633, lon: 55.1511, x: 28.5, y: 94.3 };

        async function runSearch() {
            const query = document.getElementById('searchInput').value;
            if (!query) return;

            try {
                // משיכת מיקום GPS אמיתי מהאינטרנט
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + " Dubai")}`);
                const data = await res.json();

                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);

                    // תרגום מתמטי מ-GPS לנקודה על המפה שלך
                    const x = a1.x + (lon - a1.lon) * (a1.x - a2.x) / (a1.lon - a2.lon);
                    const y = a1.y + (lat - a1.lat) * (a1.y - a2.y) / (a1.lat - a2.lat);

                    showResult(x, y, data[0].display_name.split(',')[0]);
                } else {
                    alert("המקום לא נמצא. נסה שם אחר.");
                }
            } catch (e) {
                alert("שגיאת חיבור. וודא שאתה מחובר לאינטרנט.");
            }
        }

        function showResult(x, y, name) {
            const pin = document.getElementById('pin');
            const label = document.getElementById('label');
            
            pin.style.left = x + "%"; pin.style.top = y + "%";
            pin.style.display = "block";

            label.innerText = name;
            label.style.left = x + "%"; label.style.top = y + "%";
            label.style.display = "block";

            document.activeElement.blur(); // סגירת מקלדת
            
            // גלילה אוטומטית לנעץ
            setTimeout(() => {
                pin.scrollIntoView({ behavior: "smooth", block: "center", inline: "center" });
            }, 300);
        }

        function toggleCalib() {
            isCalib = !isCalib;
            document.querySelector('.settings-btn').style.filter = isCalib ? "grayscale(0)" : "grayscale(1)";
            alert(isCalib ? "מצב כיול פעיל - לחץ על המפה לקבלת נתונים" : "מצב כיול כבוי");
        }

        document.getElementById('metro-map').onclick = function(e) {
            if (!isCalib) return;
            const rect = this.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;
            alert(`X: ${x.toFixed(1)}, Y: ${y.toFixed(1)}`);
        };
    </script>
</body>
</html>
