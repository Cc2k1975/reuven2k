<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BUYRU – סורק ברקוד ותמונה</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{--bg:#f7f7f7;--card:#fff;--text:#222;--muted:#666;--pri:#1f7aeb;--shadow:0 6px 24px rgba(0,0,0,.12);--radius:12px}
  body{font-family:Heebo,system-ui,Arial;background:var(--bg);margin:0;padding:16px;color:var(--text)}
  .wrap{max-width:760px;margin:0 auto}
  h1{font-size:22px;margin:0 0 12px}
  #viewport{position:relative;width:100%;max-width:720px;border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);background:#000}
  #interactive{position:relative;width:100%}
  canvas.drawing, canvas.drawingBuffer{position:absolute;top:0;left:0}
  .row{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  input[type="text"]{flex:1;min-width:220px;padding:10px;border:1px solid #ccc;border-radius:8px;font-size:16px}
  button{padding:10px 14px;border:0;border-radius:10px;cursor:pointer;font-weight:600}
  .primary{background:var(--pri);color:#fff}
  .ghost{background:#eee}
  .card{margin-top:14px;background:var(--card);border-radius:var(--radius);box-shadow:0 4px 16px rgba(0,0,0,.08);padding:14px}
  .imgbox img{max-width:100%;border-radius:10px}
  .meta{font-size:14px;color:#555;margin-top:8px}
  .links a{display:inline-block;margin:6px 8px 0 0;color:#1f7aeb;text-decoration:none}
  .small{font-size:12px;color:#777;margin-top:6px}
  .banner{background:#fff3cd;border:1px solid #ffe08a;color:#6b5800;border-radius:10px;padding:10px;margin:10px 0}
  .foot{margin-top:20px;text-align:center;color:#888;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>BUYRU – סורק ברקוד ותמונה</h1>

  <div id="httpsWarn" class="banner" style="display:none">
    האתר פתוח ללא HTTPS. גישת מצלמה דורשת <b>https://</b>. פתח דרך:
    <a id="httpsLink" href="#">קישור מאובטח</a>
  </div>

  <!-- אזור הווידאו של Quagga -->
  <div id="viewport">
    <div id="interactive" class="viewport"></div>
  </div>

  <div class="row">
    <button class="primary" id="btnStart">הפעל סריקה</button>
    <button class="ghost" id="btnStop" disabled>עצור</button>
    <button class="ghost" id="btnTorch" disabled>פנס</button>
  </div>

  <div class="row">
    <input id="manual" type="text" placeholder="או הזן ידנית ברקוד (GTIN/UPC/EAN)..." />
    <button class="ghost" id="btnLookup">חפש תמונה</button>
  </div>

  <div class="card" id="status">מוכן לסריקה.</div>

  <div class="card imgbox" id="imgBox" style="display:none">
    <div class="meta" id="codeMeta"></div>
    <img id="imgProduct" alt="תמונת מוצר" />
    <div class="links" id="links"></div>
    <div class="small">מקורות: Open Food/Beauty/Products Facts (ציבוריים) + רמי לוי (POC). ייתכנו חסימות/שינויי URL.</div>
  </div>

  <div class="foot">BUYRU v2.0.0</div>
</div>

<!-- Quagga (ספריית סריקת ברקודים בדפדפן) -->
<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
<script>
  const statusEl = document.getElementById('status');
  const imgBox   = document.getElementById('imgBox');
  const imgEl    = document.getElementById('imgProduct');
  const codeMeta = document.getElementById('codeMeta');
  const linksEl  = document.getElementById('links');
  const btnStart = document.getElementById('btnStart');
  const btnStop  = document.getElementById('btnStop');
  const btnTorch = document.getElementById('btnTorch');
  const btnLookup= document.getElementById('btnLookup');
  const manual   = document.getElementById('manual');
  const httpsWarn= document.getElementById('httpsWarn');
  const httpsLink= document.getElementById('httpsLink');

  let scanning = false;
  let lastCode = '';
  let currentTrack = null;
  let torchOn = false;

  // HTTPS banner
  (function ensureHttps(){
    const isLocalhost = /^(localhost|127\.0\.0\.1)$/.test(location.hostname);
    if (location.protocol !== 'https:' && !isLocalhost) {
      httpsWarn.style.display = 'block';
      httpsLink.href = 'https://' + location.host + location.pathname;
    }
  })();

  function setStatus(msg){ statusEl.textContent = msg; }

  function gtinToPath(code){
    const clean = (code || '').replace(/\D/g,'');
    const parts = [];
    for(let i=0;i<clean.length;i+=3) parts.push(clean.slice(i,i+3));
    return parts.join('/');
  }
  function openFactsCandidates(code){
    const base = [
      'https://images.openfoodfacts.org/images/products/',
      'https://images.openbeautyfacts.org/images/products/',
      'https://images.openproductsfacts.org/images/products/'
    ];
    const path = gtinToPath(code);
    return [
      `${base[0]}${path}/front.400.jpg`,
      `${base[0]}${path}/front.jpg`,
      `${base[1]}${path}/front.400.jpg`,
      `${base[1]}${path}/front.jpg`,
      `${base[2]}${path}/front.400.jpg`,
      `${base[2]}${path}/front.jpg`,
    ];
  }
  function ramiLevyCandidates(code){
    const base = `https://img.rami-levy.co.il/product/${code}`;
    return [
      `${base}/small.jpg`,
      `${base}/large.jpg`,
      `https://www.rami-levy.co.il/_ipx/w_500,f_webp/${base}/small.jpg`,
      `https://www.rami-levy.co.il/_ipx/w_800,f_webp/${base}/large.jpg`,
    ];
  }
  function firstWorkingImage(urls){
    return new Promise((resolve) => {
      let i = 0;
      (function next(){
        if(i >= urls.length) return resolve(null);
        const url = urls[i++];
        const img = new Image();
        img.onload = ()=> resolve(url);
        img.onerror= ()=> next();
        img.src = url + `?t=${Date.now()}`;
      })();
    });
  }
  async function tryLoadImageFor(code){
    const candidates = [...openFactsCandidates(code), ...ramiLevyCandidates(code)];
    return await firstWorkingImage(candidates);
  }

  async function showByCode(code){
    if(!code) return;
    lastCode = code.replace(/\s/g,'');
    setStatus(`מחפש תמונה לברקוד: ${lastCode} ...`);
    imgBox.style.display='none';
    imgEl.src=''; linksEl.innerHTML='';

    const url = await tryLoadImageFor(lastCode);

    if(url){
      codeMeta.textContent = `ברקוד: ${lastCode}`;
      imgEl.src = url;
      imgBox.style.display='block';
      setStatus('נמצאה תמונה.');
    }else{
      codeMeta.textContent = `ברקוד: ${lastCode}`;
      imgEl.removeAttribute('src');
      imgBox.style.display='block';
      setStatus('לא נמצאה תמונה במקורות הנ״ל.');
    }

    linksEl.innerHTML = [
      link('חיפוש בגוגל תמונות', `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(lastCode)}`),
      link('שופרסל – חיפוש', `https://www.shufersal.co.il/online/he/search?text=${encodeURIComponent(lastCode)}`),
      link('רמי לוי – חיפוש', `https://www.rami-levy.co.il/he/Search?search=${encodeURIComponent(lastCode)}`)
    ].join(' ');
  }
  function link(txt, href){ return `<a target="_blank" rel="noopener" href="${href}">${txt}</a>`; }

  // הפעלה/עצירה של Quagga
  async function startScan(){
    try{
      if(scanning) return;
      btnStart.disabled = true;
      btnStop.disabled  = false;
      setStatus('פותח מצלמה...');

      // קונפיגורציה: עדשה אחורית, EAN-13/UPC
      const config = {
        inputStream: {
          type: "LiveStream",
          target: document.querySelector('#interactive'),
          constraints: {
            facingMode: "environment", // אחורית; אם אין – הדפדפן יבחר זמין
            aspectRatio: { min: 1, max: 2 }
          }
        },
        decoder: {
          readers: [
            "ean_reader",        // EAN-13 (הנפוץ בישראל)
            "upc_reader",
            "upc_e_reader",
            "ean_8_reader"
          ]
        },
        locate: true,
        numOfWorkers: navigator.hardwareConcurrency ? Math.max(2, navigator.hardwareConcurrency - 1) : 2
      };

      await new Promise((resolve, reject) => {
        Quagga.init(config, (err) => err ? reject(err) : resolve());
      });

      // פנס (אם נתמך)
      try {
        const stream = Quagga.cameraAccess.getActiveStream();
        currentTrack = stream.getVideoTracks()[0] || null;
        btnTorch.disabled = !(currentTrack && currentTrack.getCapabilities && currentTrack.getCapabilities().torch);
      } catch { btnTorch.disabled = true; currentTrack = null; }

      Quagga.start();
      scanning = true;
      setStatus('סורק... כוון את הברקוד אל המסגרת.');

      Quagga.onDetected(onDetected);
      Quagga.onProcessed(drawBoxes);

    }catch(e){
      setStatus('כשל בהפעלת הסריקה: ' + (e.message || e.toString()));
      btnStart.disabled = false;
      btnStop.disabled  = true;
    }
  }

  function stopScan(){
    try{
      if(!scanning) return;
      Quagga.offDetected(onDetected);
      Quagga.offProcessed(drawBoxes);
      Quagga.stop();
    }catch{}
    scanning = false;
    btnStart.disabled = false;
    btnStop.disabled  = true;
    btnTorch.disabled = true;
    setStatus('הסריקה נעצרה.');
  }

  function onDetected(result){
    const code = (result && result.codeResult && result.codeResult.code) ? result.codeResult.code.trim() : '';
    if(code && code !== lastCode){
      showByCode(code);
    }
  }

  function drawBoxes(result){
    const drawingCtx = Quagga.canvas.ctx.overlay;
    const drawingCanvas = Quagga.canvas.dom.overlay;
    if(!drawingCtx || !drawingCanvas) return;

    drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);

    if(result) {
      if(result.boxes){
        result.boxes.filter(box => box !== result.box).forEach(box => {
          drawingCtx.strokeStyle = 'rgba(0, 255, 0, 0.3)';
          drawingCtx.lineWidth = 2;
          drawingCtx.beginPath();
          box.forEach((p, i) => {
            if (i === 0) drawingCtx.moveTo(p.x, p.y);
            else drawingCtx.lineTo(p.x, p.y);
          });
          drawingCtx.closePath();
          drawingCtx.stroke();
        });
      }
      if(result.box){
        drawingCtx.strokeStyle = '#00e0ff';
        drawingCtx.lineWidth = 3;
        drawingCtx.beginPath();
        result.box.forEach((p, i) => {
          if (i === 0) drawingCtx.moveTo(p.x, p.y);
          else drawingCtx.lineTo(p.x, p.y);
        });
        drawingCtx.closePath();
        drawingCtx.stroke();
      }
    }
  }

  // פנס
  btnTorch.addEventListener('click', async () => {
    if(!currentTrack || !currentTrack.applyConstraints) return;
    try{
      torchOn = !torchOn;
      await currentTrack.applyConstraints({ advanced: [{ torch: torchOn }] });
      btnTorch.textContent = torchOn ? 'כבה פנס' : 'פנס';
    }catch{
      // ייתכן שלא נתמך – לא נורא
    }
  });

  // אירועים
  btnStart.addEventListener('click', startScan);
  btnStop .addEventListener('click', stopScan);
  btnLookup.addEventListener('click', ()=> showByCode(manual.value));
  manual.addEventListener('keydown', (e)=>{ if(e.key==='Enter') showByCode(manual.value); });

  // ניסיון הרשאת מצלמה מראש (לא חובה)
  (async ()=> {
    try{
      const isLocalhost = /^(localhost|127\.0\.0\.1)$/.test(location.hostname);
      if (location.protocol === 'https:' || isLocalhost){
        await navigator.mediaDevices.getUserMedia({video:true});
        setStatus('מוכן – לחץ "הפעל סריקה".');
      } else {
        setStatus('פתח את הדף ב-HTTPS כדי להפעיל מצלמה.');
      }
    }catch{
      /* ההרשאה תתבקש בלחיצה בפועל */
    }
  })();
</script>
</body>
</html>
