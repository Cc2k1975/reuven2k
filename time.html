<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Global Timer</title>

  <!-- מקסימום מסך מלא במובייל -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">

  <style>
    *{margin:0;padding:0;box-sizing:border-box;}

    html, body{
      width:100%;
      height:100%;
      background:#000;
      color:#fff;
      font-family:"Courier New", monospace;
      overscroll-behavior:none;
    }

    body{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
    }

    .wrapper{
      width:100%;
      max-width:900px;
      padding:2vh 3vw;
    }

    #eventTitle{
      font-size:clamp(1.8rem,5vw,2.8rem);
      font-weight:900;
      margin-bottom:1.5rem;
      color:#ffffff;
      word-break:break-word;
    }

    /* שורת הטיימר */
    .timer-row{
      display:flex;
      justify-content:center;
      align-items:flex-end;
      gap:0.2em;
      padding-inline:3vw;
      max-width:100%;
      overflow:hidden;
    }

    .time-block{
      display:flex;
      flex-direction:column;
      align-items:center;
      min-width:0;
    }

    .digits{
      font-weight:900;
      letter-spacing:0.05em;
      direction:ltr;
      color:#00ff55;
      text-shadow:0 0 12px #00ff55,0 0 22px #009933;
      font-size:clamp(2.4rem,10vw,4.5rem);
    }

    .colon{
      color:#00ff55;
      text-shadow:0 0 12px #00ff55,0 0 22px #009933;
      font-weight:900;
      font-size:clamp(2.4rem,10vw,4.5rem);
      padding-inline:0.05em;
    }

    .unit{
      margin-top:0.4rem;
      font-size:clamp(0.9rem,3.3vw,1.2rem);
      font-weight:700;
    }

    .unit-ms{
      font-size:clamp(0.7rem,2.7vw,1rem);
    }

    /* כפתור סודי */
    #secretBtn{
      position:fixed;
      bottom:10px;
      right:10px;
      width:45px;
      height:45px;
      opacity:0;      /* 0.1 לבדיקה אם תרצה לראות */
      z-index:50;
    }

    /* חלון הגדרות */
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.65);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:100;
    }
    .overlay.active{display:flex;}

    .dialog{
      background:#111;
      padding:20px;
      border-radius:12px;
      width:90%;
      max-width:420px;
      color:#fff;
      text-align:right;
      box-shadow:0 20px 40px rgba(0,0,0,0.7);
      font-family:Arial,"Heebo",sans-serif;
    }

    .dialog h2{margin-bottom:15px;font-size:1.2rem;}

    .field{margin-bottom:15px;}
    .field label{display:block;margin-bottom:5px;font-size:0.95rem;}
    .field input{
      width:100%;
      padding:10px;
      border:1px solid #555;
      border-radius:8px;
      background:#000;
      color:#fff;
      font-size:1rem;
    }

    .buttons{display:flex;justify-content:flex-end;gap:12px;margin-top:10px;}
    .btn{
      padding:9px 16px;
      border-radius:20px;
      cursor:pointer;
      border:1px solid #fff;
      font-size:0.9rem;
      font-weight:600;
    }
    .btn.secondary{background:#000;color:#fff;}
    .btn.primary{background:#00ff55;color:#000;}

    .version{
      position:fixed;
      left:8px;
      bottom:6px;
      font-size:0.7rem;
      opacity:0.7;
      font-family:"Courier New",monospace;
    }

    @media (max-width:600px){
      .wrapper{padding:1vh 2vw;}
      .digits{font-size:9.2vw;}
      .colon{font-size:9.2vw;}
      .unit{font-size:3vw;}
    }
  </style>
</head>
<body>

<div class="wrapper">
  <div id="eventTitle">אין אירוע מוגדר</div>

  <div class="timer-row">
    <div class="time-block">
      <div class="digits" id="days">000</div>
      <div class="unit">D</div>
    </div>

    <div class="colon">:</div>

    <div class="time-block">
      <div class="digits" id="hours">00</div>
      <div class="unit">H</div>
    </div>

    <div class="colon">:</div>

    <div class="time-block">
      <div class="digits" id="minutes">00</div>
      <div class="unit">M</div>
    </div>

    <div class="colon">:</div>

    <div class="time-block">
      <div class="digits" id="seconds">00</div>
      <div class="unit">S</div>
    </div>

    <div class="colon">:</div>

    <div class="time-block">
      <div class="digits" id="millis">00</div>
      <div class="unit unit-ms">&nbsp;</div>
    </div>
  </div>
</div>

<button id="secretBtn"></button>

<div class="overlay" id="overlay">
  <div class="dialog">
    <h2>הגדרת אירוע חדש</h2>

    <div class="field">
      <label>שם האירוע</label>
      <input id="eventNameInput" type="text">
    </div>

    <div class="field">
      <label>תאריך ושעה</label>
      <input id="eventTimeInput" type="datetime-local">
    </div>

    <div class="buttons">
      <button class="btn secondary" id="cancelBtn">ביטול</button>
      <button class="btn primary" id="saveBtn">שמור</button>
    </div>
  </div>
</div>

<div class="version">v2025-11-23-FS5</div>

<script type="module">
  /* --------- Firebase --------- */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAeUBBZDPZnDIcAvluwzubNtbs3xjmTqls",
    authDomain: "global-timer-8ebbd.firebaseapp.com",
    projectId: "global-timer-8ebbd",
    storageBucket: "global-timer-8ebbd.firebasestorage.app",
    messagingSenderId: "603403671136",
    appId: "1:603403671136:web:0269c03a847a1fb3d81505",
    measurementId: "G-WW8L0XHPGB"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  // אוסף + דוקומנט גלובליים
  const ref = doc(db, "globalTimer", "event");

  /* --------- אלמנטים --------- */
  const eventTitleEl = document.getElementById("eventTitle");
  const daysEl       = document.getElementById("days");
  const hoursEl      = document.getElementById("hours");
  const minutesEl    = document.getElementById("minutes");
  const secondsEl    = document.getElementById("seconds");
  const millisEl     = document.getElementById("millis");

  const secretBtn      = document.getElementById("secretBtn");
  const overlay        = document.getElementById("overlay");
  const eventNameInput = document.getElementById("eventNameInput");
  const eventTimeInput = document.getElementById("eventTimeInput");
  const cancelBtn      = document.getElementById("cancelBtn");
  const saveBtn        = document.getElementById("saveBtn");

  let targetTime = null;
  let timerId    = null;

  function pad(n, size){
    let s = String(n);
    while (s.length < size) s = "0" + s;
    return s;
  }

  function renderZero(){
    daysEl.textContent    = "000";
    hoursEl.textContent   = "00";
    minutesEl.textContent = "00";
    secondsEl.textContent = "00";
    millisEl.textContent  = "00";
  }

  function updateTimer(){
    if (!targetTime){
      renderZero();
      return;
    }

    const now = Date.now();
    let diff = targetTime - now;
    if (diff < 0) diff = 0;

    const days    = Math.floor(diff / 86400000);
    const hours   = Math.floor((diff / 3600000) % 24);
    const minutes = Math.floor((diff / 60000) % 60);
    const seconds = Math.floor((diff / 1000) % 60);
    const millis  = Math.floor((diff % 1000) / 10); // שתי ספרות

    daysEl.textContent    = pad(days,3);
    hoursEl.textContent   = pad(hours,2);
    minutesEl.textContent = pad(minutes,2);
    secondsEl.textContent = pad(seconds,2);
    millisEl.textContent  = pad(millis,2);
  }

  function startInterval(){
    if (timerId) clearInterval(timerId);
    timerId = setInterval(updateTimer, 10);
  }

  /* --------- מאזין ל-Firestore --------- */
  console.log("Global Timer v1.1.0 – starting…");

  onSnapshot(ref, snap => {
    const data = snap.data();
    console.log("onSnapshot fired");
    console.log("Snapshot data:", data);

    if (!data || !data.timestamp){
      targetTime = null;
      eventTitleEl.textContent = "אין אירוע מוגדר";
      renderZero();
      return;
    }

    targetTime = data.timestamp;
    eventTitleEl.textContent = data.name || "אירוע ללא שם";
    startInterval();
  });

  /* --------- כפתור סודי + שמירה --------- */
  secretBtn.onclick = () => {
    overlay.classList.add("active");
    eventNameInput.focus();
  };

  cancelBtn.onclick = () => {
    overlay.classList.remove("active");
  };

  saveBtn.onclick = async () => {
    const name = eventNameInput.value.trim();
    const d    = eventTimeInput.value;

    if (!d){
      alert("בחר תאריך ושעה");
      return;
    }

    const t = new Date(d);
    if (isNaN(t.getTime())){
      alert("תאריך לא תקין");
      return;
    }

    const payload = {
      name: name || "אירוע ללא שם",
      timestamp: t.getTime()
    };

    console.log("Trying to save to Firestore:", payload);
    await setDoc(ref, payload, { merge:true });
    console.log("Saved successfully.");

    overlay.classList.remove("active");
  };

  overlay.onclick = e => {
    if (e.target === overlay) overlay.classList.remove("active");
  };

  /* --------- פול סקרין אוטומטי בלחיצה ראשונה --------- */

  function requestFullscreenSafe(){
    const el = document.documentElement;
    try{
      if (el.requestFullscreen) return el.requestFullscreen();
      if (el.webkitRequestFullscreen) return el.webkitRequestFullscreen();
      if (el.msRequestFullscreen) return el.msRequestFullscreen();
    }catch(e){
      console.warn("fullscreen error:", e);
    }
  }

  function handleFirstInteraction(){
    const p = requestFullscreenSafe();
    // בחלק מהדפדפנים מחזיר Promise, בחלק לא – נתעלם משגיאות
    if (p && p.catch) p.catch(()=>{});
    document.removeEventListener("click", handleFirstInteraction);
    document.removeEventListener("touchstart", handleFirstInteraction);
  }

  document.addEventListener("click", handleFirstInteraction, { once:true });
  document.addEventListener("touchstart", handleFirstInteraction, { once:true });

</script>

</body>
</html>
